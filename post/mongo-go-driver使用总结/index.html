<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>mongo-go-driver使用总结 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="Forz" /><meta name="description" content="创建main 创建文件main.go并导入bson，mongo和mongo/options包： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main" /><meta name="keywords"
  content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.55.6 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/mongo-go-driver%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="stylesheet" href="http://localhost:1313/css/search.css" />


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="mongo-go-driver使用总结" />
<meta property="og:description" content="创建main 创建文件main.go并导入bson，mongo和mongo/options包： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/mongo-go-driver%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" />
<meta property="article:published_time" content="2019-07-16T16:38:41&#43;00:00"/>
<meta property="article:modified_time" content="2019-07-16T16:38:41&#43;00:00"/>

<meta itemprop="name" content="mongo-go-driver使用总结">
<meta itemprop="description" content="创建main 创建文件main.go并导入bson，mongo和mongo/options包： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main">


<meta itemprop="datePublished" content="2019-07-16T16:38:41&#43;00:00" />
<meta itemprop="dateModified" content="2019-07-16T16:38:41&#43;00:00" />
<meta itemprop="wordCount" content="9066">



<meta itemprop="keywords" content="Go,MongoDB," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="mongo-go-driver使用总结"/>
<meta name="twitter:description" content="创建main 创建文件main.go并导入bson，mongo和mongo/options包： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="clearfix">
  <div class="logo-wrapper">
    <a href="/" class="logo">Forz Blog</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
    </ul>
  </nav>
</div>


<div class="search-container">
  <div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..."
        name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path
            d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>
<script>
    var client = algoliasearch("IAR2EF5L65", "b4b9da2eba53aa6dabe4b8ac9e8676e1");
    var index = client.initIndex('forz.forzvina.com');
    autocomplete('#aa-search-input',
        { hint: false }, {
        source: autocomplete.sources.hits(index, { hitsPerPage: 8 }),
        displayKey: 'name',
        templates: {
            suggestion: function (suggestion) {
                console.log(suggestion, '<a href="http://' + document.domain + suggestion.uri + '">', "http:\/\/localhost:1313");
                setTimeout(() => {
                    console.log(document.getElementsByClassName('aa-dropdown-menu')[0].innerHTML)
                }, 3000);
                return '<span class="search-item">' + '<a href="http:\/\/localhost:1313' + suggestion.uri + '">' +
                    suggestion._highlightResult.title.value + '</a></span>';
            }
        }
    });
</script>
</div>


    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">mongo-go-driver使用总结</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-07-16 </span>
        <div class="post-category">
            <a href="/categories/Go/"> Go </a>
            </div>
          <span class="more-meta"> 约 9066 字 </span>
          <span class="more-meta"> 预计阅读 19 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#创建main">创建main</a></li>
<li><a href="#go类型与bson的映射">Go类型与bson的映射</a></li>
<li><a href="#使用go驱动程序连接到mongodb">使用Go驱动程序连接到MongoDB</a></li>
<li><a href="#在go中使用bson对象">在Go中使用BSON对象</a>
<ul>
<li><a href="#d系列">D系列</a>
<ul>
<li><a href="#d">D</a></li>
<li><a href="#e">E</a></li>
<li><a href="#m">M</a></li>
<li><a href="#a">A</a></li>
</ul></li>
<li><a href="#raw类型">Raw类型</a></li>
<li><a href="#结构体替代bson">结构体替代bson</a></li>
<li><a href="#bson转结构体">bson转结构体</a></li>
<li><a href="#mongo-shell-转bson">mongo Shell 转bson</a>
<ul>
<li><a href="#shell语句-转-bson">shell语句 转 bson</a></li>
<li><a href="#shell语句组-转-bson">shell语句组 转 []bson</a></li>
</ul></li>
</ul></li>
<li><a href="#crud操作">CRUD操作</a>
<ul>
<li><a href="#插入文件">插入文件</a>
<ul>
<li><a href="#insertone">InsertOne</a></li>
<li><a href="#insertmany">InsertMany</a></li>
</ul></li>
<li><a href="#更新文件">更新文件</a>
<ul>
<li><a href="#update">update</a>
<ul>
<li><a href="#updateone">UpdateOne</a></li>
<li><a href="#updatemany">UpdateMany</a></li>
<li><a href="#upsert">upsert</a></li>
</ul></li>
<li><a href="#replace">replace</a>
<ul>
<li><a href="#replaceone">replaceone</a></li>
<li><a href="#resert">resert</a></li>
</ul></li>
<li><a href="#查询与删改换结合">查询与删改换结合</a></li>
</ul></li>
<li><a href="#查找文件">查找文件</a>
<ul>
<li><a href="#findone">FindOne</a></li>
<li><a href="#find">Find</a></li>
<li><a href="#有序find">有序find</a></li>
<li><a href="#distinct">distinct</a></li>
<li><a href="#根据-id查找文件">根据_id查找文件</a></li>
</ul></li>
<li><a href="#删除文件">删除文件</a>
<ul>
<li><a href="#deleteone">DeleteOne</a></li>
<li><a href="#deletemany">DeleteMany</a></li>
</ul></li>
</ul></li>
<li><a href="#bulkwrite">bulkWrite</a></li>
<li><a href="#聚合查询">聚合查询</a>
<ul>
<li><a href="#count">count</a></li>
<li><a href="#estimateddocumentcount">EstimatedDocumentCount</a></li>
<li><a href="#aggregate">aggregate</a></li>
</ul></li>
<li><a href="#事务机制">事务机制</a>
<ul>
<li><a href="#withsession">WithSession</a></li>
<li><a href="#usesession">UseSession</a></li>
</ul></li>
<li><a href="#runcommand">RunCommand</a></li>
<li><a href="#gridfs">gridfs</a></li>
<li><a href="#change-stream">change stream</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="创建main">创建main</h1>

<p>创建文件main.go并导入bson，mongo和mongo/options包：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;log&#34;</span>

    <span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
    <span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
    <span class="s">&#34;go.mongodb.org/mongo-driver/mongo/options&#34;</span>
<span class="p">)</span>

<span class="c1">// You will be using this Trainer type later in the program
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Trainer</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">Age</span>  <span class="kt">int</span>
    <span class="nx">City</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Rest of the code will go here
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>此代码还导入一些标准库并定义Trainer类型。您将在本教程的后面部分使用它们。</p>

<h1 id="go类型与bson的映射">Go类型与bson的映射</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Post</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>        <span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span> <span class="s">`&#34;_id&#34;`</span>
    <span class="nx">Title</span>     <span class="kt">string</span>             <span class="s">`bson:&#34;title&#34;`</span>
    <span class="nx">Body</span>      <span class="kt">string</span>             
    <span class="nx">Tags</span>      <span class="p">[]</span><span class="kt">string</span>           <span class="s">`bson:&#34;tags&#34;json:&#34;tags&#34;`</span>
    <span class="nx">Comments</span>  <span class="kt">uint64</span>             <span class="s">`bson:&#34;comments,omitempty&#34;`</span>
    <span class="nx">CreatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>          <span class="s">`bson:&#34;created_at&#34;`</span>
    <span class="nx">UpdatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>          <span class="s">`bson:&#34;updated_at&#34;`</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>有三种规则：</p>

<ol>
<li>什么都不写，就像上面的body一样，这种的话就默认属性名全小写作为key。</li>
<li>第二种就是像ID一样简写bson映射。</li>
<li>第三种是像Tags一样完整的写出来，这样的话可以同时做bson和json的映射。</li>
</ol>

<p>Key规则：</p>

<p>必须作为第一个参数，但是可以不写。如果这个字段不想映射到bson的话，可以这样<code>bson:&quot;-&quot;</code></p>

<p>其它参数：</p>

<ul>
<li>omitempty —— 允许值为空，比如说在ID中使用后，MongoDB会自动为_id生成ObjectId</li>
<li>minsize —— 如果在保留数值的情况下可行，将MongoDB大于32位的整数值解析为int32。</li>
<li>truncate —— 如果在损失精度的情况下，将MongoDB的double解析为float32。</li>
<li>inline —— 可以让内联struct和外联效果一样</li>
</ul>

<p>鉴于我们Post之前定义的结构，让我们创建另一个文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Post</span><span class="p">{</span>
    <span class="nx">ID</span><span class="p">:</span>        <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span>
    <span class="nx">Title</span><span class="p">:</span>     <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="nx">tags</span><span class="p">:</span> 
<span class="o">-</span>    <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
    <span class="nx">Body</span><span class="p">:</span>      <span class="s">`blog post`</span><span class="p">,</span>
    <span class="nx">CreatedAt</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>我们得到以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="err">ObjectId(</span><span class="s2">&#34;5c71f03ccfee587e4212ad90&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;post&#34;</span><span class="p">,</span>
    <span class="nt">&#34;body&#34;</span> <span class="p">:</span> <span class="s2">&#34;blog post&#34;</span><span class="p">,</span>
    <span class="nt">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s2">&#34;mongodb&#34;</span>
    <span class="p">],</span>
    <span class="nt">&#34;comments&#34;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">0</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;created_at&#34;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&#34;2019-02-24T01:15:40.329Z&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;updated_at&#34;</span> <span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如您所见，驱动程序将创建一个文档，其中包含结构中定义的所有字段，甚至是我们未传递任何值的字段。请记住，您必须使用该primitive.NewObjectID()函数来创建新的ObjectID。它还将保留结构中定义的属性的顺序。</p>

<h1 id="使用go驱动程序连接到mongodb">使用Go驱动程序连接到MongoDB</h1>

<p>导入MongoDB Go驱动程序后，您可以使用该mongo.Connect()功能连接到MongoDB部署。您必须将上下文和options.ClientOptions对象传递给mongo.Connect()。客户端选项用于设置连接字符串。它还可用于配置驱动程序设置，如写入问题，套接字超时等。选项包文档提供了有关可用客户机选项的更多信息。</p>

<p>在main函数中添加以下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Set client options
</span><span class="c1"></span><span class="nx">clientOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">ApplyURI</span><span class="p">(</span><span class="s">&#34;mongodb://localhost:27017&#34;</span><span class="p">)</span>

<span class="c1">// Connect to MongoDB
</span><span class="c1"></span><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">clientOptions</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Check the connection
</span><span class="c1"></span><span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="kc">nil</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connected to MongoDB!&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>连接方式还有一种</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">MongoClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">{</span>
	<span class="nx">Auth</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">Credential</span><span class="p">{</span>
		<span class="nx">AuthSource</span><span class="p">:</span> <span class="nx">Authsource</span><span class="p">,</span>
		<span class="nx">Username</span><span class="p">:</span>   <span class="nx">Username</span><span class="p">,</span>
		<span class="nx">Password</span><span class="p">:</span>   <span class="nx">Password</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="nx">Hosts</span><span class="p">:</span> <span class="nx">Hosts</span><span class="p">,</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;MongoDB初始化失败&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">MongoClient</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>连接后，您现在可以通过在main函数末尾添加以下代码行来trainers获取test数据库中集合的句柄：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">collection</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="s">&#34;trainers&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>以下代码将使用此集合句柄来查询trainers集合。</p>

<p>最佳做法是保持连接到MongoDB的客户端，以便应用程序可以使用连接池 - 您不希望为每个查询打开和关闭连接。但是，如果您的应用程序不再需要连接，则可以使用如下方式关闭连接client.Disconnect()：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connection to MongoDB closed.&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>mongodb的连接也可以进行设置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">opt</span><span class="p">.</span><span class="nf">SetLocalThreshold</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>     <span class="c1">//只使用与mongo操作耗时小于3秒的
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetMaxConnIdleTime</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>    <span class="c1">//指定连接可以保持空闲的最大毫秒数
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetMaxPoolSize</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>                    <span class="c1">//使用最大的连接数
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetReadPreference</span><span class="p">(</span><span class="nx">want</span><span class="p">)</span>                <span class="c1">//表示只使用辅助节点
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetReadConcern</span><span class="p">(</span><span class="nx">readconcern</span><span class="p">.</span><span class="nf">Majority</span><span class="p">())</span> <span class="c1">//指定查询应返回实例的最新数据确认为，已入副本集中的大多数成员
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetWriteConcern</span><span class="p">(</span><span class="nx">wc</span><span class="p">)</span>                    <span class="o">//</span><span class="nx">请求确认写操作传播到大多数mongod实例</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="在go中使用bson对象">在Go中使用BSON对象</h1>

<p>在我们开始向数据库发送查询之前，了解Go Driver如何与BSON对象一起工作非常重要。MongoDB中的JSON文档存储在名为BSON（二进制编码的JSON）的二进制表示中。与将JSON数据存储为简单字符串和数字的其他数据库不同，BSON编码扩展了JSON表示以包括其他类型，如int，long，date，floating point和decimal128。这使应用程序更容易可靠地处理，排序和比较数据。</p>

<p>Go Driver有两类用于表示BSON数据的类型:D类型和Raw类型。</p>

<h2 id="d系列">D系列</h2>

<p>D系列类型用于使用本地Go类型简洁地构建BSON对象。 这对于构造传递给MongoDB的命令特别有用。</p>

<p>D系列包括四种类型：</p>

<h3 id="d">D</h3>

<p>D表示BSON文档。此类型可用于以简洁和可读的方式表示BSON</p>

<p>D通常应在序列化为BSON时使用。对于反序列化，应该使用Raw或D类型。</p>

<p>用法示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
    <span class="p">{</span><span class="s">&#34;title&#34;</span><span class="p">,</span> <span class="s">&#34;post 2&#34;</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">}},</span>
    <span class="p">{</span><span class="s">&#34;body&#34;</span><span class="p">,</span> <span class="s">`blog post 2`</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;created_at&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()},</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>此操作将创建具有有序元素的文档，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
    <span class="s">&#34;_id&#34;</span> <span class="p">:</span> <span class="nf">ObjectId</span><span class="p">(</span><span class="s">&#34;5c71f03ccfee587e4212ad8f&#34;</span><span class="p">),</span>
    <span class="s">&#34;title&#34;</span> <span class="p">:</span> <span class="s">&#34;post 2&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s">&#34;mongodb&#34;</span>
    <span class="p">],</span>
    <span class="s">&#34;body&#34;</span> <span class="p">:</span> <span class="s">&#34;blog post 2&#34;</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span> <span class="p">:</span> <span class="nf">ISODate</span><span class="p">(</span><span class="s">&#34;2019-02-24T01:15:40.328Z&#34;</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>此类型应在顺序重要的情况下使用，例如MongoDB命令。如果顺序并不重要，map更舒适，更简洁</p>

<h3 id="e">E</h3>

<p>E代表D的BSON元素。它通常用在D中。</p>

<h3 id="m">M</h3>

<p>M是BSON文档的无序，简洁表示。它通常应该用于当BSON文档的元素顺序无关紧要时序列化BSON。如果元素的顺序重要，请改用D代替。</p>

<p>用法示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
    <span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
    <span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">`blog post`</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>上面的操作将创建一个包含无序元素的文档，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
    <span class="s">&#34;_id&#34;</span> <span class="p">:</span> <span class="nf">ObjectId</span><span class="p">(</span><span class="s">&#34;5c71f03ccfee587e4212ad8e&#34;</span><span class="p">),</span>
    <span class="s">&#34;body&#34;</span> <span class="p">:</span> <span class="s">&#34;blog post&#34;</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span> <span class="p">:</span> <span class="nf">ISODate</span><span class="p">(</span><span class="s">&#34;2019-02-24T01:15:40.326Z&#34;</span><span class="p">),</span>
    <span class="s">&#34;title&#34;</span> <span class="p">:</span> <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s">&#34;mongodb&#34;</span>
    <span class="p">]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>请注意，元素的顺序与提供的顺序不同bson.M。</p>

<p>此类型在编码器中作为常规<code>map[string]interface{}</code>处理。元素将是以未定义的随机顺序序列化，每次顺序都不同。</p>

<h3 id="a">A</h3>

<p>A表示BSON数组。这种类型可以用来简洁地表示BSON数组.A通常应在序列化为BSON时使用。对于反序列化，应该使用RawArray或Array类型。</p>

<p>用法示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">bson</span><span class="p">.</span><span class="nx">A</span> <span class="p">{</span><span class="err">“</span><span class="nx">bar</span><span class="err">”，“</span><span class="nx">world</span><span class="err">”，</span><span class="mf">3.14159</span><span class="err">，</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span> <span class="p">{{</span><span class="err">“</span><span class="nx">qux</span><span class="err">”，</span><span class="mi">12345</span><span class="p">}}}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="raw类型">Raw类型</h2>

<p>Raw类型用于byte切片。您还可以使用欧路词典从Raw类型中取回单独的元素。如果您不希望花费频繁将BSON解码为另一种类型的开销，这将非常有用。本教程仅使用D系列类型。</p>

<h2 id="结构体替代bson">结构体替代bson</h2>

<p>除了传入bson,还可以传入带tag的结构体作为bson</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">BeforeCond</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Before</span> <span class="kt">int64</span> <span class="s">`bson:&#34;$lt&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">DeleteCond</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">BeforeCond</span> <span class="nx">BeforeCond</span> <span class="s">`bson:&#34;timePoint.startTime&#34;`</span>
<span class="p">}</span>

<span class="nx">delCond</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">DeleteCond</span><span class="p">{</span>
	<span class="nx">BeforeCond</span><span class="p">:</span> <span class="nx">BeforeCond</span><span class="p">{</span>
		<span class="nx">Before</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">}</span>


<span class="kd">type</span> <span class="nx">FindByJobName</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">JobName</span> <span class="kt">string</span> <span class="s">`bson:&#34;jobName&#34;`</span>
<span class="p">}</span>

<span class="nx">cond</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">FindByJobName</span><span class="p">{</span>
	<span class="nx">JobName</span><span class="p">:</span> <span class="s">&#34;hello&#34;</span><span class="p">,</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="bson转结构体">bson转结构体</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//bson转结构体,需要结构体打上bson标签
</span><span class="c1">//a:=bson.M{}
</span><span class="c1">//x:=A{}
</span><span class="c1">//Bson2Odj(a,&amp;x)
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Bson2Odj</span><span class="p">(</span><span class="nx">val</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">//bson转[]byte
</span><span class="c1"></span>	<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="c1">//[]byte转结构体
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="mongo-shell-转bson">mongo Shell 转bson</h2>

<h3 id="shell语句-转-bson">shell语句 转 bson</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">a</span><span class="o">:=</span><span class="s">`$and : [{&#34;id&#34; : &#34;asdfzcv&#34;}, {&#34;num&#34; : 6}]`</span>
	<span class="c1">//bb:=bson.M{&#34;id&#34;: &#34;asdfzcv&#34;, &#34;num&#34;: 6}
</span><span class="c1"></span>	<span class="nx">bb</span><span class="o">:=</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{}</span>
	<span class="nx">_</span><span class="p">=</span><span class="nx">bson</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span><span class="o">&amp;</span><span class="nx">bb</span><span class="p">)</span>
	<span class="o">//</span><span class="nx">bb</span><span class="p">=</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">:</span> <span class="s">&#34;asdfzcv&#34;</span><span class="p">,</span> <span class="s">&#34;num&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">update</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{ &#34;$set&#34;: {&#34;year&#34;: 1998}}`</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">update</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="shell语句组-转-bson">shell语句组 转 []bson</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="nx">toConvert</span> <span class="o">:=</span> <span class="s">`[
</span><span class="s">        {
</span><span class="s">            &#34;$project&#34;: {
</span><span class="s">                &#34;_id&#34;: 0,
</span><span class="s">                &#34;A&#34;: &#34;$$ROOT&#34;
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$lookup&#34;: {
</span><span class="s">                &#34;localField&#34;: &#34;A.TypeId&#34;,
</span><span class="s">                &#34;from&#34;: &#34;RoleType&#34;,
</span><span class="s">                &#34;foreignField&#34;: &#34;_id&#34;,
</span><span class="s">                &#34;as&#34;: &#34;B&#34;
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$unwind&#34;: {
</span><span class="s">                &#34;path&#34;: &#34;$B&#34;,
</span><span class="s">                &#34;preserveNullAndEmptyArrays&#34;: true
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$project&#34;: {
</span><span class="s">                &#34;A.RoleId&#34;: &#34;$A.RoleId&#34;,
</span><span class="s">                &#34;A.RoleName&#34;: &#34;$A.RoleName&#34;,
</span><span class="s">                &#34;A.Valid&#34;: &#34;$A.Valid&#34;,
</span><span class="s">                &#34;B.TypeName&#34;: &#34;$B.TypeName&#34;
</span><span class="s">            }
</span><span class="s">        }
</span><span class="s">    ]`</span>
<span class="nx">pipeLine</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">UnmarshalExtJSON</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">toConvert</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pipeLine</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="crud操作">CRUD操作</h1>

<p>连接到数据库后，就可以开始添加和操作某些数据了。该Collection类型有几种方法，允许您向数据库发送查询。</p>

<h2 id="插入文件">插入文件</h2>

<h3 id="insertone">InsertOne</h3>

<p>要插入单个文档，请使用以下collection.InsertOne()方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create a new context with a 10 second timeout
</span><span class="c1"></span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>

<span class="c1">// insert one document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="s">&#34;title&#34;</span><span class="p">:</span> <span class="s">&#34;Go mongodb driver cookbook&#34;</span><span class="p">,</span>
	<span class="s">&#34;tags&#34;</span><span class="p">:</span>  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;golang&#34;</span><span class="p">,</span> <span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
	<span class="s">&#34;body&#34;</span><span class="p">:</span> <span class="s">`this is a long post
</span><span class="s">    that goes on and on
</span><span class="s">    and have many lines`</span><span class="p">,</span>
	<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">1</span><span class="p">,</span>
	<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
	<span class="s">&#34;new post created with id: %s&#34;</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">InsertedID</span><span class="p">.(</span><span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span><span class="p">).</span><span class="nf">Hex</span><span class="p">(),</span>
<span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">new</span> <span class="nx">post</span> <span class="nx">created</span> <span class="nx">with</span> <span class="nx">id</span><span class="p">:</span> <span class="mi">5</span><span class="nx">c71caf32a346553363177ce</span></code></pre></td></tr></table>
</div>
</div>
<p>也可以不使用bson.M{}来传递参数,而是使用包含bson标签例如`bson:&rdquo;_id&rdquo;`的结构体,比如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ID</span>    <span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span> 	<span class="s">`bson:&#34;_id,omitempty&#34;`</span>
	<span class="nx">Name</span>  <span class="kt">string</span>      			<span class="s">`bson:&#34;dbname&#34;,json:&#34;jsonname&#34;`</span>
	<span class="nx">Phone</span> <span class="kt">string</span>
	<span class="nx">ASD</span>   <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// Insert one
</span><span class="c1"></span><span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span><span class="s">&#34;1234567890&#34;</span><span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">InsertedID</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Insert many
</span><span class="c1"></span><span class="p">{</span>
	<span class="nx">users</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}{</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_0&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;123&#34;</span><span class="p">},</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_1&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;456&#34;</span><span class="p">},</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_2&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">InsertMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">users</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="insertmany">InsertMany</h3>

<p>要一次插入多个文档，该collection.InsertMany()方法将采用一些对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}{</span>
	<span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;Post one&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;golang&#34;</span><span class="p">},</span>
		<span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">&#34;post one body&#34;</span><span class="p">,</span>
		<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">14</span><span class="p">,</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">January</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">UTC</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;Post two&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;nodejs&#34;</span><span class="p">},</span>
		<span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">&#34;post two body&#34;</span><span class="p">,</span>
		<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">2</span><span class="p">,</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;inserted ids: %v\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">InsertedIDs</span><span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">inserted</span> <span class="nx">ids</span><span class="p">:</span> <span class="p">[</span><span class="nf">ObjectID</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93be&#34;</span><span class="p">)</span> <span class="nf">ObjectID</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93bf&#34;</span><span class="p">)]</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="更新文件">更新文件</h2>

<h3 id="update">update</h3>

<h4 id="updateone">UpdateOne</h4>

<p>该collection.UpdateOne()方法允许您更新单个文档。它需要一个过滤器文档来匹配数据库中的文档和一个更新文档来描述更新操作。update需要传入bson命令</p>

<p>您可以使用以下bson.D类型构建这些：</p>

<p>这里我们还从其十六进制字符串表示中创建一个新的ObjectID：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create ObjectID from string
</span><span class="c1"></span><span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93be&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// set filters and updates
</span><span class="c1"></span><span class="nx">filter</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">}</span>
<span class="nx">update</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;title&#34;</span><span class="p">:</span> <span class="s">&#34;post 2 (two)&#34;</span><span class="p">}}</span>

<span class="c1">// update document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;modified count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">modified</span> <span class="nx">count</span><span class="p">:</span> <span class="mi">1</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="updatemany">UpdateMany</h4>

<p>要更新多个文档（相当于{multi: true}），请使用collection.UpdateMany()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// set filters and updates
</span><span class="c1"></span><span class="nx">filter</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$elemMatch&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$eq&#34;</span><span class="p">:</span> <span class="s">&#34;golang&#34;</span><span class="p">}}}</span>
<span class="nx">update</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;comments&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;updated_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}}</span>

<span class="c1">// update documents
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;modified count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">modified</span> <span class="nx">count</span><span class="p">:</span> <span class="mi">17</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="upsert">upsert</h4>

<p>对于两者而言UpdateOne，UpdateMany您可以通过将适当的选项传递给函数来使其成为upsert操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Update</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span>

<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateMany</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Update</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="replace">replace</h3>

<h4 id="replaceone">replaceone</h4>

<p>Update是用来直接修改数据库的，ReplaceOne则是整个替换。 可以用bson传入要替换的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">}</span>
<span class="kd">var</span> <span class="nx">result</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">UpdateResult</span>
<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionExamples</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">doc</span><span class="p">[</span><span class="s">&#34;year&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1998</span>
<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s">&#34;_id&#34;</span><span class="p">]},</span> <span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>replacement也可以直接传入结构体进行更新</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Replace one
</span><span class="c1"></span><span class="p">{</span>
	<span class="nx">user</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_2_replaced&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">}</span>
	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;phone&#34;</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">},</span> <span class="nx">user</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="resert">resert</h4>

<p>也可以通过将适当的选项传递给函数来使replace其成为upsert操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Replace</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span>

<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">ReplaceMany</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Replace</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="nx">v</span>
<span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="查询与删改换结合">查询与删改换结合</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//查询单条数据后删除该数据
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndDelete</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_3&#34;</span><span class="p">}}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;FindOneAndDelete查询到的数据:%v\n&#34;</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>
<span class="c1">//查询单条数据后修改该数据
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndUpdate</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_4&#34;</span><span class="p">}},</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;这条数据我需要修改了&#34;</span><span class="p">}}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;FindOneAndUpdate查询到的数据:%v\n&#34;</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>

<span class="c1">//查询单条数据后替换该数据(以前的数据全部清空)
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndReplace</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_5&#34;</span><span class="p">}}</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;hero&#34;</span><span class="p">:</span> <span class="s">&#34;这条数据我替换了&#34;</span><span class="p">}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="查找文件">查找文件</h2>

<h3 id="findone">FindOne</h3>

<p>要查找文档，您需要一个过滤器文档以及一个指向可以解码结果的值的指针。要查找单个文档，请使用collection.FindOne()。此方法返回单个结果，可将其解码为值。您将使用filter在更新查询中使用的相同变量来匹配名称为Ash的文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create a value into which the result can be decoded
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">result</span> <span class="nx">Trainer</span>

<span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">filter</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Found a single document: %+v\n&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>Decode()函数也可以传参bson</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">table</span><span class="p">.</span><span class="nf">FindOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="find">Find</h3>

<p>要查找多个文档，请使用collection.Find()。这个方法返回一个Cursor。A Cursor提供了一个文档流，您可以通过它们一次迭代和解码一个文档。一旦Cursor用尽，你应该关闭Cursor。在这里，您还将使用options包设置一些操作选项。具体来说，您将设置限制，因此只返回2个文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Pass these options to the Find method
</span><span class="c1"></span><span class="nx">findOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">()</span>
<span class="nx">findOptions</span><span class="p">.</span><span class="nf">SetLimit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1">// Here&#39;s an array in which you can store the decoded documents
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">results</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Trainer</span>

<span class="c1">// Passing bson.D{{}} as the filter matches all documents in the collection
</span><span class="c1"></span><span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{}},</span> <span class="nx">findOptions</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Finding multiple documents returns a cursor
</span><span class="c1">// Iterating through the cursor allows us to decode documents one at a time
</span><span class="c1"></span><span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span> <span class="p">{</span>
    
    <span class="c1">// create a value into which the single document can be decoded
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">elem</span> <span class="nx">Trainer</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">results</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Close the cursor once finished
</span><span class="c1"></span><span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Found multiple documents (array of pointers): %+v\n&#34;</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>Find也可以返回bson,如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">MongoUtils</span><span class="p">)</span> <span class="nf">FindMore</span><span class="p">(</span><span class="nx">col</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">filter</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">([]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">,</span> <span class="kt">error</span><span class="p">){</span>
	<span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Con</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;没有初始化连接和数据库信息！&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">table</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">col</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">,</span><span class="nx">_</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="nx">cur</span><span class="p">,</span> <span class="nx">err2</span> <span class="o">:=</span> <span class="nx">table</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err2</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">err2</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err2</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">resultArr</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
		<span class="nx">err3</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err3</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err3</span>
		<span class="p">}</span>
		<span class="nx">resultArr</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">resultArr</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">resultArr</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="有序find">有序find</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//一次查询多条数据
</span><span class="c1">// 查询createtime&gt;=3
</span><span class="c1">// 限制取2条
</span><span class="c1">// createtime从大到小排序的数据
</span><span class="c1"></span><span class="k">if</span> <span class="nx">cursor</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.{</span><span class="s">&#34;$gte&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}},</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">().</span><span class="nf">SetLimit</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">().</span><span class="nf">SetSort</span><span class="p">(</span><span class="nx">bson</span><span class="p">.{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}));</span> <span class="nx">err</span><span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//多个options.Find()可以用链式表达,比如:
</span><span class="c1">//findOptions := options.Find().SetSort(SORT).SetLimit(Limit).SetSkip(Skip)
</span><span class="c1">//按选项查询集合 Skip 跳过 Limit 读取数量 sort 
</span><span class="c1"></span>
<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
<span class="k">for</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">howieArrayEmpty</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">howieArrayEmpty</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">howieArrayEmpty</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Find查询到的数据ObejectId值%s 值:%v\n&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">HowieId</span><span class="p">.</span><span class="nf">Hex</span><span class="p">(),</span> <span class="nx">v</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="distinct">distinct</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//返回满足filter条件下的所有fieldName值,[]interface{}类型
</span><span class="c1">//res, err := mymongo.Distinct(&#34;test&#34;, &#34;id&#34;, bson.M{})
</span><span class="c1"></span>	<span class="nx">collection</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">fieldName</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="根据-id查找文件">根据_id查找文件</h3>

<p>mongodb里面&rdquo;_id&rdquo;不是字符串,只是方便显示,在可视化界面中展示为字符串,如&rdquo;5d36fc03d3a200b7aeecaeac&rdquo;</p>

<p>如果要在golang中通过_id查找文件,需要先将字符串转化为primitive.ObjectID,然后再查找</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">ID</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="nx">stringID</span><span class="p">)</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">ID</span><span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="删除文件">删除文件</h2>

<h3 id="deleteone">DeleteOne</h3>

<p>要删除文档，请使用collection.DeleteOne()：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create ObjectID from string
</span><span class="c1"></span><span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93be&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// delete document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">DeleteOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;deleted count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="deletemany">DeleteMany</h3>

<p>最后，您可以使用collection.DeleteOne()或删除文档collection.DeleteMany()。在这里，您将传递bson.D{{}}过滤器参数，该参数将匹配集合中的所有文档。您还可以使用collection.Drop()删除整个集合。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">deleteResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">DeleteMany</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{}})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Deleted %v documents in the trainers collection\n&#34;</span><span class="p">,</span> <span class="nx">deleteResult</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="bulkwrite">bulkWrite</h1>

<p>有时您想要执行许多操作，例如一次插入，更新和删除所有操作。在这种情况下，MongoDB提供了非常有用的批量写入API，它采用一系列写入操作并执行每个操作。默认情况下，操作按顺序执行。这是一个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// list of inserts
</span><span class="c1"></span><span class="nx">inserts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post five&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;postgresql&#34;</span><span class="p">},</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post six&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;graphql&#34;</span><span class="p">},</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">}</span>

<span class="c1">// list of updates
</span><span class="c1"></span><span class="nx">updates</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">filter</span>  <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">updates</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
<span class="p">}{</span>
	<span class="p">{</span>
		<span class="nx">filter</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
			<span class="s">&#34;tags&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$elemMatch&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$eq&#34;</span><span class="p">:</span> <span class="s">&#34;golang&#34;</span><span class="p">}},</span>
		<span class="p">},</span>
		<span class="nx">updates</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;updated_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}},</span>
	<span class="p">},</span>
<span class="p">}</span>

<span class="c1">// list of deletes
</span><span class="c1"></span><span class="nx">deletes</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id3</span><span class="p">},</span>
<span class="p">}</span>

<span class="c1">// create the slice of write models
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">writes</span> <span class="p">[]</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">WriteModel</span>

<span class="c1">// range over each list of operations and create the write model
</span><span class="c1"></span><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ins</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">inserts</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewInsertOneModel</span><span class="p">().</span><span class="nf">SetDocument</span><span class="p">(</span><span class="nx">ins</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">upd</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">updates</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewUpdateManyModel</span><span class="p">().</span>
		<span class="nf">SetFilter</span><span class="p">(</span><span class="nx">upd</span><span class="p">.</span><span class="nx">filter</span><span class="p">).</span><span class="nf">SetUpdate</span><span class="p">(</span><span class="nx">upd</span><span class="p">.</span><span class="nx">updates</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">del</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">deletes</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewDeleteManyModel</span><span class="p">().</span><span class="nf">SetFilter</span><span class="p">(</span><span class="nx">del</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// run bulk write
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">BulkWrite</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">writes</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
	<span class="s">&#34;insert: %d, updated: %d, deleted: %d&#34;</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">InsertedCount</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">,</span>
<span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">insert</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">updated</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">:</span> <span class="mi">3</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="聚合查询">聚合查询</h1>

<h2 id="count">count</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//查询集合里面有多少数据
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">CountDocuments</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Count里面有多少条数据:%d\n&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>

	<span class="c1">//查询集合里面有多少数据(查询createtime&gt;=3的数据)
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">CountDocuments</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$gte&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Count里面有多少条数据:%d\n&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">ErrNoDocuments</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;没有查到数据&#34;</span><span class="p">)</span>
			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="estimateddocumentcount">EstimatedDocumentCount</h2>

<p>估计集合内有多少数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">num</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">EstimatedDocumentCount</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="aggregate">aggregate</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">TestAggregateJSON</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>

	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>

	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="s">`[
</span><span class="s">		{&#34;$match&#34;: { &#34;color&#34;: &#34;Red&#34; }},
</span><span class="s">		{&#34;$group&#34;: { &#34;_id&#34;: &#34;$brand&#34;, &#34;count&#34;: { &#34;$sum&#34;: 1 } }},
</span><span class="s">		{&#34;$project&#34;: { &#34;brand&#34;: &#34;$_id&#34;, &#34;_id&#34;: 0, &#34;count&#34;: 1 }}
</span><span class="s">	]`</span>

	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">brands</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">brands</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAllowDiskUse</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetBatchSize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
	<span class="nx">pipeLine</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">UnmarshalExtJSON</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pipeLine</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeLine</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">total</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">),</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestAggregatePipeline</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>

	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>

	<span class="c1">// this cause warning from go vet
</span><span class="c1"></span>	<span class="c1">// pipeline := mongo.Pipeline{
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$match&#34;, bson.D{{&#34;color&#34;, &#34;Red&#34;}}}},
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$group&#34;, bson.D{{&#34;_id&#34;, &#34;$brand&#34;}, {&#34;count&#34;, bson.D{{&#34;$sum&#34;, 1}}}}}},
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$project&#34;, bson.D{{&#34;brand&#34;, &#34;$_id&#34;}, {&#34;_id&#34;, 0}, {&#34;count&#34;, 1}}}},
</span><span class="c1"></span>	<span class="c1">// }
</span><span class="c1"></span>	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$match&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}}}},</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$group&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;_id&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;$brand&#34;</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;count&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$sum&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}}}},</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$project&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;$_id&#34;</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;_id&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;count&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}},</span>
	<span class="p">}</span>
	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">brands</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">brands</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAllowDiskUse</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetBatchSize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">total</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">),</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestAggregateBSOND</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="nx">size</span> <span class="o">:=</span> <span class="mi">10</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>
	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;$sample&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;size&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">}}}}}</span>
	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected &#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="事务机制">事务机制</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// WithSession允许用户自己启动会话并进行管理
</span><span class="c1">//它的一生为CRUD方法提供会话的唯一方法是
</span><span class="c1">//使用mongo.SessionContext调用该CRUD方法
</span><span class="c1">//关闭mongo.SessionContext可以用作常规上下文，
</span><span class="c1">//所以像context.WithDeadline和context.WithTimeout这样的方法是
</span><span class="c1">// 支持的。
</span><span class="c1">//
</span><span class="c1">//如果context.Context已经附加了mongo.Session，那就是
</span><span class="c1">// mongo.Session将替换为提供的。
</span><span class="c1">//
</span><span class="c1">//从闭包中返回的错误是透明地返回的
</span><span class="c1">//这个功能
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">WithSession</span><span class="err">（</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="err">，</span><span class="nx">sess</span> <span class="nx">Session</span><span class="err">，</span><span class="nx">fn</span> <span class="kd">func</span><span class="err">（</span><span class="nx">SessionContext</span><span class="err">）</span><span class="kt">error</span><span class="err">）</span><span class="kt">error</span> <span class="p">{</span>
<span class="k">return</span> <span class="nx">fn</span><span class="err">（</span><span class="nx">contextWithSession</span><span class="err">（</span><span class="nx">ctx</span><span class="err">，</span><span class="nx">sess</span><span class="err">））</span>
<span class="p">}</span>

<span class="c1">// UseSession创建一个默认会话，该会话仅对
</span><span class="c1">//关闭的生命周期关闭会话之外没有清理
</span><span class="c1">//在退出封闭时完成。这意味着一个出色的
</span><span class="c1">//即使闭包返回错误，也会中止事务。
</span><span class="c1">//
</span><span class="c1">//如果ctx已经包含mongo.Session，那mongo.Session将是
</span><span class="c1">//替换为新创建的mongo.Session。
</span><span class="c1">//
</span><span class="c1">//从闭包中返回的错误是透明地返回的
</span><span class="c1">//这个方法
</span><span class="c1"></span><span class="kd">func</span><span class="err">（</span><span class="nx">c</span> <span class="o">*</span> <span class="nx">Client</span><span class="err">）</span><span class="nx">UseSession</span><span class="err">（</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="err">，</span><span class="nx">fn</span> <span class="kd">func</span><span class="err">（</span><span class="nx">SessionContext</span><span class="err">）</span><span class="kt">error</span><span class="err">）</span><span class="kt">error</span> <span class="p">{</span>
<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">UseSessionWithOptions</span><span class="err">（</span><span class="nx">ctx</span><span class="err">，</span><span class="nx">options</span><span class="p">.</span><span class="nx">Session</span><span class="err">（），</span><span class="nx">fn</span><span class="err">）</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="withsession">WithSession</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">id</span> <span class="p">=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">,</span> <span class="s">&#34;year&#34;</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">1998</span><span class="p">)}</span>
	<span class="kd">var</span> <span class="nx">result</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">UpdateResult</span>
	<span class="kd">var</span> <span class="nx">session</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Session</span>
	<span class="kd">var</span> <span class="nx">update</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$set&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;year&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">2000</span><span class="p">)}}}}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">StartSession</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">WithSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sc</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">sc</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">},</span> <span class="nx">update</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">MatchedCount</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">result</span><span class="p">.</span><span class="nx">ModifiedCount</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;replace failed, expected 1 but got&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">MatchedCount</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="c1">//提交
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="c1">//放弃
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">session</span><span class="p">.</span><span class="nf">EndSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="usesession">UseSession</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;github.com/mongodb/mongo-go-driver/mongo&#34;</span>
    <span class="s">&#34;net/url&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="nx">connectString</span> <span class="o">:=</span> <span class="s">&#34;mongodb://127.0.0.1/test&#34;</span>
    <span class="nx">dbUrl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">connectString</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

    <span class="c1">//认证参数设置，否则连不上
</span><span class="c1"></span>	<span class="nx">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">{}</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAuth</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">Credential</span><span class="p">{</span>
			<span class="nx">AuthMechanism</span><span class="p">:</span><span class="s">&#34;SCRAM-SHA-1&#34;</span><span class="p">,</span>
			<span class="nx">AuthSource</span><span class="p">:</span><span class="s">&#34;test&#34;</span><span class="p">,</span>
			<span class="nx">Username</span><span class="p">:</span><span class="s">&#34;test&#34;</span><span class="p">,</span>
			<span class="nx">Password</span><span class="p">:</span><span class="s">&#34;123456&#34;</span><span class="p">})</span>
			
    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">connectString</span><span class="err">，</span><span class="nx">opts</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

    <span class="nx">db</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbUrl</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    
    <span class="nx">col</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">)</span>
    
    <span class="c1">//先在事务外写一条id为“111”的记录
</span><span class="c1"></span>    <span class="nx">_</span><span class="p">,</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;111&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    
    <span class="c1">//第一个事务：成功执行
</span><span class="c1"></span>    <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">UseSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sessionContext</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//在事务内写一条id为“222”的记录
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;222&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//在事务内写一条id为“333”的记录
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;333&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">})</span>
	
    <span class="c1">//第二个事务：执行失败，事务没提交，因最后插入了一条重复id &#34;111&#34;,
</span><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">UseSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sessionContext</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//在事务内写一条id为“222”的记录
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;444&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

		<span class="c1">//写重复id
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;111&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">})</span>
<span class="p">}</span> 

<span class="o">//</span><span class="nx">最终数据只有</span> <span class="s">&#34;111&#34;</span><span class="p">,</span><span class="s">&#34;222&#34;</span><span class="p">,</span><span class="s">&#34;333&#34;</span> <span class="nx">三条</span><span class="err">，</span><span class="nx">事务测试成功</span><span class="err">。</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="runcommand">RunCommand</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="nx">command</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;isMaster&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="s">&#34;admin&#34;</span><span class="p">).</span><span class="nf">RunCommand</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">command</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="gridfs">gridfs</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">bucket</span> <span class="o">*</span><span class="nx">gridfs</span><span class="p">.</span><span class="nx">Bucket</span>
	<span class="kd">var</span> <span class="nx">ustream</span> <span class="o">*</span><span class="nx">gridfs</span><span class="p">.</span><span class="nx">UploadStream</span>
	<span class="nx">str</span> <span class="o">:=</span> <span class="s">&#34;This is a test file&#34;</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>

	<span class="k">if</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">gridfs</span><span class="p">.</span><span class="nf">NewBucket</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nf">GridFSBucket</span><span class="p">().</span><span class="nf">SetName</span><span class="p">(</span><span class="s">&#34;myFiles&#34;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">GridFSUpload</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetMetadata</span><span class="p">(</span><span class="nx">bsonx</span><span class="p">.</span><span class="nx">Doc</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;content-type&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bsonx</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;application/json&#34;</span><span class="p">)}})</span>
	<span class="k">if</span> <span class="nx">ustream</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nf">OpenUploadStream</span><span class="p">(</span><span class="s">&#34;test.txt&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ustream</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">fileID</span> <span class="o">:=</span> <span class="nx">ustream</span><span class="p">.</span><span class="nx">FileID</span>
	<span class="nx">ustream</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">b</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
	<span class="nx">w</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nf">DownloadToStream</span><span class="p">(</span><span class="nx">fileID</span><span class="p">,</span> <span class="nx">w</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ustream</span><span class="p">.</span><span class="nx">FileID</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">str</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nx">str</span><span class="p">,</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
	<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="change-stream">change stream</h1>

<p>change_stream.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Copyright 2018 Kuei-chun Chen. All rights reserved.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">examples</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>

	<span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo/options&#34;</span>
<span class="p">)</span>

<span class="c1">// ChangeStream defines what to watch? client, database or collection
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ChangeStream</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">collection</span> <span class="kt">string</span>
	<span class="nx">database</span>   <span class="kt">string</span>
	<span class="nx">pipeline</span>   <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">callback</span> <span class="kd">func</span><span class="p">(</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span>

<span class="c1">// SetCollection sets collection
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span> <span class="p">=</span> <span class="nx">collection</span>
<span class="p">}</span>

<span class="c1">// SetDatabase sets database
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">database</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="p">=</span> <span class="nx">database</span>
<span class="p">}</span>

<span class="c1">// SetPipeline sets pipeline
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">pipeline</span>
<span class="p">}</span>

<span class="c1">// NewChangeStream gets a new ChangeStream
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewChangeStream</span><span class="p">()</span> <span class="o">*</span><span class="nx">ChangeStream</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ChangeStream</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// Watch prints oplogs in JSON format
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">cb</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">ChangeStream</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pipeline&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">ChangeStream</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetFullDocument</span><span class="p">(</span><span class="s">&#34;updateLookup&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="o">+</span><span class="s">&#34;.&#34;</span><span class="o">+</span><span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">coll</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">db</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching all&#34;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">doc</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nf">cb</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>change_stream_test.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Copyright 2018 Kuei-chun Chen. All rights reserved.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">examples</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;testing&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;github.com/simagix/keyhole/mdb&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/bson/primitive&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/x/network/connstring&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">collection</span> <span class="p">=</span> <span class="s">&#34;oplogs&#34;</span>

<span class="c1">// example: argos &#34;mongodb://localhost:27017/argos?replicaSet=replset&#34; students &#39;[{&#34;$match&#34;: {&#34;operationType&#34;: &#34;update&#34;}}]&#39;
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">silent</span><span class="p">(</span><span class="nx">doc</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamClient</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
		<span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="c1">// stream.Watch(client)
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamDatabase</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
		<span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Drop</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamCollection</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamCollectionWithPipeline</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mdb</span><span class="p">.</span><span class="nf">MongoPipeline</span><span class="p">(</span><span class="s">`[{&#34;$match&#34;: {&#34;operationType&#34;: {&#34;$in&#34;: [&#34;update&#34;, &#34;delete&#34;] } }}]`</span><span class="p">)</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// wait for change stream to init
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">doc</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">update</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{ &#34;$set&#34;: {&#34;year&#34;: 1998}}`</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">update</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s">&#34;_id&#34;</span><span class="p">]},</span> <span class="nx">update</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">DeleteMany</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// wait for CS to print messages
</span><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nf">Drop</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>参考:<br />
<a href="https://blog.csdn.net/sdghchj/article/details/85249392">https://blog.csdn.net/sdghchj/article/details/85249392</a><br />
<a href="https://blog.fudenglong.site/2018/11/17/MongoDB-Go%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%A6%E4%B9%A0/">https://blog.fudenglong.site/2018/11/17/MongoDB-Go%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%A6%E4%B9%A0/</a><br />
<a href="https://blog.csdn.net/henreash/article/details/86745584">https://blog.csdn.net/henreash/article/details/86745584</a>
<a href="https://github.com/simagix/mongo-go-examples/tree/master/examples">https://github.com/simagix/mongo-go-examples/tree/master/examples</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-07-16
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/Go/">Go</a>
          <a href="/tags/MongoDB/">MongoDB</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/OLTP%E4%B8%8EOLAP%E7%9A%84%E4%BB%8B%E7%BB%8D/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">OLTP与OLAP的介绍</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/types-from-different-packages-%E9%97%AE%E9%A2%98%E6%B5%85%E6%9E%90/">
            <span class="next-text nav-default">types from different packages 问题浅析</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Forz</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
