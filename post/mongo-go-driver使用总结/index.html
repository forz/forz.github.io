<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>mongo-go-driverä½¿ç”¨æ€»ç»“ - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="Forz" /><meta name="description" content="åˆ›å»ºmain åˆ›å»ºæ–‡ä»¶main.goå¹¶å¯¼å…¥bsonï¼Œmongoå’Œmongo/optionsåŒ…ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main" /><meta name="keywords"
  content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.55.6 with theme even" />


<link rel="canonical" href="http://localhost:1313/post/mongo-go-driver%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="stylesheet" href="http://localhost:1313/css/search.css" />


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="mongo-go-driverä½¿ç”¨æ€»ç»“" />
<meta property="og:description" content="åˆ›å»ºmain åˆ›å»ºæ–‡ä»¶main.goå¹¶å¯¼å…¥bsonï¼Œmongoå’Œmongo/optionsåŒ…ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/post/mongo-go-driver%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" />
<meta property="article:published_time" content="2019-07-16T16:38:41&#43;00:00"/>
<meta property="article:modified_time" content="2019-07-16T16:38:41&#43;00:00"/>

<meta itemprop="name" content="mongo-go-driverä½¿ç”¨æ€»ç»“">
<meta itemprop="description" content="åˆ›å»ºmain åˆ›å»ºæ–‡ä»¶main.goå¹¶å¯¼å…¥bsonï¼Œmongoå’Œmongo/optionsåŒ…ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main">


<meta itemprop="datePublished" content="2019-07-16T16:38:41&#43;00:00" />
<meta itemprop="dateModified" content="2019-07-16T16:38:41&#43;00:00" />
<meta itemprop="wordCount" content="9066">



<meta itemprop="keywords" content="Go,MongoDB," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="mongo-go-driverä½¿ç”¨æ€»ç»“"/>
<meta name="twitter:description" content="åˆ›å»ºmain åˆ›å»ºæ–‡ä»¶main.goå¹¶å¯¼å…¥bsonï¼Œmongoå’Œmongo/optionsåŒ…ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="clearfix">
  <div class="logo-wrapper">
    <a href="/" class="logo">Forz Blog</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
    </ul>
  </nav>
</div>


<div class="search-container">
  <div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..."
        name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path
            d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>
<script>
    var client = algoliasearch("IAR2EF5L65", "b4b9da2eba53aa6dabe4b8ac9e8676e1");
    var index = client.initIndex('forz.forzvina.com');
    autocomplete('#aa-search-input',
        { hint: false }, {
        source: autocomplete.sources.hits(index, { hitsPerPage: 8 }),
        displayKey: 'name',
        templates: {
            suggestion: function (suggestion) {
                console.log(suggestion, '<a href="http://' + document.domain + suggestion.uri + '">', "http:\/\/localhost:1313");
                setTimeout(() => {
                    console.log(document.getElementsByClassName('aa-dropdown-menu')[0].innerHTML)
                }, 3000);
                return '<span class="search-item">' + '<a href="http:\/\/localhost:1313' + suggestion.uri + '">' +
                    suggestion._highlightResult.title.value + '</a></span>';
            }
        }
    });
</script>
</div>


    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">mongo-go-driverä½¿ç”¨æ€»ç»“</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-07-16 </span>
        <div class="post-category">
            <a href="/categories/Go/"> Go </a>
            </div>
          <span class="more-meta"> çº¦ 9066 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 19 åˆ†é’Ÿ </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#åˆ›å»ºmain">åˆ›å»ºmain</a></li>
<li><a href="#goç±»å‹ä¸bsonçš„æ˜ å°„">Goç±»å‹ä¸bsonçš„æ˜ å°„</a></li>
<li><a href="#ä½¿ç”¨goé©±åŠ¨ç¨‹åºè¿æ¥åˆ°mongodb">ä½¿ç”¨Goé©±åŠ¨ç¨‹åºè¿æ¥åˆ°MongoDB</a></li>
<li><a href="#åœ¨goä¸­ä½¿ç”¨bsonå¯¹è±¡">åœ¨Goä¸­ä½¿ç”¨BSONå¯¹è±¡</a>
<ul>
<li><a href="#dç³»åˆ—">Dç³»åˆ—</a>
<ul>
<li><a href="#d">D</a></li>
<li><a href="#e">E</a></li>
<li><a href="#m">M</a></li>
<li><a href="#a">A</a></li>
</ul></li>
<li><a href="#rawç±»å‹">Rawç±»å‹</a></li>
<li><a href="#ç»“æ„ä½“æ›¿ä»£bson">ç»“æ„ä½“æ›¿ä»£bson</a></li>
<li><a href="#bsonè½¬ç»“æ„ä½“">bsonè½¬ç»“æ„ä½“</a></li>
<li><a href="#mongo-shell-è½¬bson">mongo Shell è½¬bson</a>
<ul>
<li><a href="#shellè¯­å¥-è½¬-bson">shellè¯­å¥ è½¬ bson</a></li>
<li><a href="#shellè¯­å¥ç»„-è½¬-bson">shellè¯­å¥ç»„ è½¬ []bson</a></li>
</ul></li>
</ul></li>
<li><a href="#crudæ“ä½œ">CRUDæ“ä½œ</a>
<ul>
<li><a href="#æ’å…¥æ–‡ä»¶">æ’å…¥æ–‡ä»¶</a>
<ul>
<li><a href="#insertone">InsertOne</a></li>
<li><a href="#insertmany">InsertMany</a></li>
</ul></li>
<li><a href="#æ›´æ–°æ–‡ä»¶">æ›´æ–°æ–‡ä»¶</a>
<ul>
<li><a href="#update">update</a>
<ul>
<li><a href="#updateone">UpdateOne</a></li>
<li><a href="#updatemany">UpdateMany</a></li>
<li><a href="#upsert">upsert</a></li>
</ul></li>
<li><a href="#replace">replace</a>
<ul>
<li><a href="#replaceone">replaceone</a></li>
<li><a href="#resert">resert</a></li>
</ul></li>
<li><a href="#æŸ¥è¯¢ä¸åˆ æ”¹æ¢ç»“åˆ">æŸ¥è¯¢ä¸åˆ æ”¹æ¢ç»“åˆ</a></li>
</ul></li>
<li><a href="#æŸ¥æ‰¾æ–‡ä»¶">æŸ¥æ‰¾æ–‡ä»¶</a>
<ul>
<li><a href="#findone">FindOne</a></li>
<li><a href="#find">Find</a></li>
<li><a href="#æœ‰åºfind">æœ‰åºfind</a></li>
<li><a href="#distinct">distinct</a></li>
<li><a href="#æ ¹æ®-idæŸ¥æ‰¾æ–‡ä»¶">æ ¹æ®_idæŸ¥æ‰¾æ–‡ä»¶</a></li>
</ul></li>
<li><a href="#åˆ é™¤æ–‡ä»¶">åˆ é™¤æ–‡ä»¶</a>
<ul>
<li><a href="#deleteone">DeleteOne</a></li>
<li><a href="#deletemany">DeleteMany</a></li>
</ul></li>
</ul></li>
<li><a href="#bulkwrite">bulkWrite</a></li>
<li><a href="#èšåˆæŸ¥è¯¢">èšåˆæŸ¥è¯¢</a>
<ul>
<li><a href="#count">count</a></li>
<li><a href="#estimateddocumentcount">EstimatedDocumentCount</a></li>
<li><a href="#aggregate">aggregate</a></li>
</ul></li>
<li><a href="#äº‹åŠ¡æœºåˆ¶">äº‹åŠ¡æœºåˆ¶</a>
<ul>
<li><a href="#withsession">WithSession</a></li>
<li><a href="#usesession">UseSession</a></li>
</ul></li>
<li><a href="#runcommand">RunCommand</a></li>
<li><a href="#gridfs">gridfs</a></li>
<li><a href="#change-stream">change stream</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="åˆ›å»ºmain">åˆ›å»ºmain</h1>

<p>åˆ›å»ºæ–‡ä»¶main.goå¹¶å¯¼å…¥bsonï¼Œmongoå’Œmongo/optionsåŒ…ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;log&#34;</span>

    <span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
    <span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
    <span class="s">&#34;go.mongodb.org/mongo-driver/mongo/options&#34;</span>
<span class="p">)</span>

<span class="c1">// You will be using this Trainer type later in the program
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Trainer</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">Age</span>  <span class="kt">int</span>
    <span class="nx">City</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Rest of the code will go here
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>æ­¤ä»£ç è¿˜å¯¼å…¥ä¸€äº›æ ‡å‡†åº“å¹¶å®šä¹‰Trainerç±»å‹ã€‚æ‚¨å°†åœ¨æœ¬æ•™ç¨‹çš„åé¢éƒ¨åˆ†ä½¿ç”¨å®ƒä»¬ã€‚</p>

<h1 id="goç±»å‹ä¸bsonçš„æ˜ å°„">Goç±»å‹ä¸bsonçš„æ˜ å°„</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Post</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>        <span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span> <span class="s">`&#34;_id&#34;`</span>
    <span class="nx">Title</span>     <span class="kt">string</span>             <span class="s">`bson:&#34;title&#34;`</span>
    <span class="nx">Body</span>      <span class="kt">string</span>             
    <span class="nx">Tags</span>      <span class="p">[]</span><span class="kt">string</span>           <span class="s">`bson:&#34;tags&#34;json:&#34;tags&#34;`</span>
    <span class="nx">Comments</span>  <span class="kt">uint64</span>             <span class="s">`bson:&#34;comments,omitempty&#34;`</span>
    <span class="nx">CreatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>          <span class="s">`bson:&#34;created_at&#34;`</span>
    <span class="nx">UpdatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>          <span class="s">`bson:&#34;updated_at&#34;`</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>æœ‰ä¸‰ç§è§„åˆ™ï¼š</p>

<ol>
<li>ä»€ä¹ˆéƒ½ä¸å†™ï¼Œå°±åƒä¸Šé¢çš„bodyä¸€æ ·ï¼Œè¿™ç§çš„è¯å°±é»˜è®¤å±æ€§åå…¨å°å†™ä½œä¸ºkeyã€‚</li>
<li>ç¬¬äºŒç§å°±æ˜¯åƒIDä¸€æ ·ç®€å†™bsonæ˜ å°„ã€‚</li>
<li>ç¬¬ä¸‰ç§æ˜¯åƒTagsä¸€æ ·å®Œæ•´çš„å†™å‡ºæ¥ï¼Œè¿™æ ·çš„è¯å¯ä»¥åŒæ—¶åšbsonå’Œjsonçš„æ˜ å°„ã€‚</li>
</ol>

<p>Keyè§„åˆ™ï¼š</p>

<p>å¿…é¡»ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä½†æ˜¯å¯ä»¥ä¸å†™ã€‚å¦‚æœè¿™ä¸ªå­—æ®µä¸æƒ³æ˜ å°„åˆ°bsonçš„è¯ï¼Œå¯ä»¥è¿™æ ·<code>bson:&quot;-&quot;</code></p>

<p>å…¶å®ƒå‚æ•°ï¼š</p>

<ul>
<li>omitempty â€”â€” å…è®¸å€¼ä¸ºç©ºï¼Œæ¯”å¦‚è¯´åœ¨IDä¸­ä½¿ç”¨åï¼ŒMongoDBä¼šè‡ªåŠ¨ä¸º_idç”ŸæˆObjectId</li>
<li>minsize â€”â€” å¦‚æœåœ¨ä¿ç•™æ•°å€¼çš„æƒ…å†µä¸‹å¯è¡Œï¼Œå°†MongoDBå¤§äº32ä½çš„æ•´æ•°å€¼è§£æä¸ºint32ã€‚</li>
<li>truncate â€”â€” å¦‚æœåœ¨æŸå¤±ç²¾åº¦çš„æƒ…å†µä¸‹ï¼Œå°†MongoDBçš„doubleè§£æä¸ºfloat32ã€‚</li>
<li>inline â€”â€” å¯ä»¥è®©å†…è”structå’Œå¤–è”æ•ˆæœä¸€æ ·</li>
</ul>

<p>é‰´äºæˆ‘ä»¬Postä¹‹å‰å®šä¹‰çš„ç»“æ„ï¼Œè®©æˆ‘ä»¬åˆ›å»ºå¦ä¸€ä¸ªæ–‡æ¡£ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Post</span><span class="p">{</span>
    <span class="nx">ID</span><span class="p">:</span>        <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span>
    <span class="nx">Title</span><span class="p">:</span>     <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="nx">tags</span><span class="p">:</span> 
<span class="o">-</span>    <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
    <span class="nx">Body</span><span class="p">:</span>      <span class="s">`blog post`</span><span class="p">,</span>
    <span class="nx">CreatedAt</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>æˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="err">ObjectId(</span><span class="s2">&#34;5c71f03ccfee587e4212ad90&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;post&#34;</span><span class="p">,</span>
    <span class="nt">&#34;body&#34;</span> <span class="p">:</span> <span class="s2">&#34;blog post&#34;</span><span class="p">,</span>
    <span class="nt">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s2">&#34;mongodb&#34;</span>
    <span class="p">],</span>
    <span class="nt">&#34;comments&#34;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">0</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;created_at&#34;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&#34;2019-02-24T01:15:40.329Z&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;updated_at&#34;</span> <span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>å¦‚æ‚¨æ‰€è§ï¼Œé©±åŠ¨ç¨‹åºå°†åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ï¼Œå…¶ä¸­åŒ…å«ç»“æ„ä¸­å®šä¹‰çš„æ‰€æœ‰å­—æ®µï¼Œç”šè‡³æ˜¯æˆ‘ä»¬æœªä¼ é€’ä»»ä½•å€¼çš„å­—æ®µã€‚è¯·è®°ä½ï¼Œæ‚¨å¿…é¡»ä½¿ç”¨è¯¥primitive.NewObjectID()å‡½æ•°æ¥åˆ›å»ºæ–°çš„ObjectIDã€‚å®ƒè¿˜å°†ä¿ç•™ç»“æ„ä¸­å®šä¹‰çš„å±æ€§çš„é¡ºåºã€‚</p>

<h1 id="ä½¿ç”¨goé©±åŠ¨ç¨‹åºè¿æ¥åˆ°mongodb">ä½¿ç”¨Goé©±åŠ¨ç¨‹åºè¿æ¥åˆ°MongoDB</h1>

<p>å¯¼å…¥MongoDB Goé©±åŠ¨ç¨‹åºåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¯¥mongo.Connect()åŠŸèƒ½è¿æ¥åˆ°MongoDBéƒ¨ç½²ã€‚æ‚¨å¿…é¡»å°†ä¸Šä¸‹æ–‡å’Œoptions.ClientOptionså¯¹è±¡ä¼ é€’ç»™mongo.Connect()ã€‚å®¢æˆ·ç«¯é€‰é¡¹ç”¨äºè®¾ç½®è¿æ¥å­—ç¬¦ä¸²ã€‚å®ƒè¿˜å¯ç”¨äºé…ç½®é©±åŠ¨ç¨‹åºè®¾ç½®ï¼Œå¦‚å†™å…¥é—®é¢˜ï¼Œå¥—æ¥å­—è¶…æ—¶ç­‰ã€‚é€‰é¡¹åŒ…æ–‡æ¡£æä¾›äº†æœ‰å…³å¯ç”¨å®¢æˆ·æœºé€‰é¡¹çš„æ›´å¤šä¿¡æ¯ã€‚</p>

<p>åœ¨mainå‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Set client options
</span><span class="c1"></span><span class="nx">clientOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">ApplyURI</span><span class="p">(</span><span class="s">&#34;mongodb://localhost:27017&#34;</span><span class="p">)</span>

<span class="c1">// Connect to MongoDB
</span><span class="c1"></span><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">clientOptions</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Check the connection
</span><span class="c1"></span><span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="kc">nil</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connected to MongoDB!&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>è¿æ¥æ–¹å¼è¿˜æœ‰ä¸€ç§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">MongoClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">{</span>
	<span class="nx">Auth</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">Credential</span><span class="p">{</span>
		<span class="nx">AuthSource</span><span class="p">:</span> <span class="nx">Authsource</span><span class="p">,</span>
		<span class="nx">Username</span><span class="p">:</span>   <span class="nx">Username</span><span class="p">,</span>
		<span class="nx">Password</span><span class="p">:</span>   <span class="nx">Password</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="nx">Hosts</span><span class="p">:</span> <span class="nx">Hosts</span><span class="p">,</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;MongoDBåˆå§‹åŒ–å¤±è´¥&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">MongoClient</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>è¿æ¥åï¼Œæ‚¨ç°åœ¨å¯ä»¥é€šè¿‡åœ¨mainå‡½æ•°æœ«å°¾æ·»åŠ ä»¥ä¸‹ä»£ç è¡Œæ¥trainersè·å–testæ•°æ®åº“ä¸­é›†åˆçš„å¥æŸ„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">collection</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="s">&#34;trainers&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>ä»¥ä¸‹ä»£ç å°†ä½¿ç”¨æ­¤é›†åˆå¥æŸ„æ¥æŸ¥è¯¢trainersé›†åˆã€‚</p>

<p>æœ€ä½³åšæ³•æ˜¯ä¿æŒè¿æ¥åˆ°MongoDBçš„å®¢æˆ·ç«¯ï¼Œä»¥ä¾¿åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨è¿æ¥æ±  - æ‚¨ä¸å¸Œæœ›ä¸ºæ¯ä¸ªæŸ¥è¯¢æ‰“å¼€å’Œå…³é—­è¿æ¥ã€‚ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºä¸å†éœ€è¦è¿æ¥ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å…³é—­è¿æ¥client.Disconnect()ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connection to MongoDB closed.&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>mongodbçš„è¿æ¥ä¹Ÿå¯ä»¥è¿›è¡Œè®¾ç½®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">opt</span><span class="p">.</span><span class="nf">SetLocalThreshold</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>     <span class="c1">//åªä½¿ç”¨ä¸mongoæ“ä½œè€—æ—¶å°äº3ç§’çš„
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetMaxConnIdleTime</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>    <span class="c1">//æŒ‡å®šè¿æ¥å¯ä»¥ä¿æŒç©ºé—²çš„æœ€å¤§æ¯«ç§’æ•°
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetMaxPoolSize</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>                    <span class="c1">//ä½¿ç”¨æœ€å¤§çš„è¿æ¥æ•°
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetReadPreference</span><span class="p">(</span><span class="nx">want</span><span class="p">)</span>                <span class="c1">//è¡¨ç¤ºåªä½¿ç”¨è¾…åŠ©èŠ‚ç‚¹
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetReadConcern</span><span class="p">(</span><span class="nx">readconcern</span><span class="p">.</span><span class="nf">Majority</span><span class="p">())</span> <span class="c1">//æŒ‡å®šæŸ¥è¯¢åº”è¿”å›å®ä¾‹çš„æœ€æ–°æ•°æ®ç¡®è®¤ä¸ºï¼Œå·²å…¥å‰¯æœ¬é›†ä¸­çš„å¤§å¤šæ•°æˆå‘˜
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetWriteConcern</span><span class="p">(</span><span class="nx">wc</span><span class="p">)</span>                    <span class="o">//</span><span class="nx">è¯·æ±‚ç¡®è®¤å†™æ“ä½œä¼ æ’­åˆ°å¤§å¤šæ•°mongodå®ä¾‹</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="åœ¨goä¸­ä½¿ç”¨bsonå¯¹è±¡">åœ¨Goä¸­ä½¿ç”¨BSONå¯¹è±¡</h1>

<p>åœ¨æˆ‘ä»¬å¼€å§‹å‘æ•°æ®åº“å‘é€æŸ¥è¯¢ä¹‹å‰ï¼Œäº†è§£Go Driverå¦‚ä½•ä¸BSONå¯¹è±¡ä¸€èµ·å·¥ä½œéå¸¸é‡è¦ã€‚MongoDBä¸­çš„JSONæ–‡æ¡£å­˜å‚¨åœ¨åä¸ºBSONï¼ˆäºŒè¿›åˆ¶ç¼–ç çš„JSONï¼‰çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ã€‚ä¸å°†JSONæ•°æ®å­˜å‚¨ä¸ºç®€å•å­—ç¬¦ä¸²å’Œæ•°å­—çš„å…¶ä»–æ•°æ®åº“ä¸åŒï¼ŒBSONç¼–ç æ‰©å±•äº†JSONè¡¨ç¤ºä»¥åŒ…æ‹¬å…¶ä»–ç±»å‹ï¼Œå¦‚intï¼Œlongï¼Œdateï¼Œfloating pointå’Œdecimal128ã€‚è¿™ä½¿åº”ç”¨ç¨‹åºæ›´å®¹æ˜“å¯é åœ°å¤„ç†ï¼Œæ’åºå’Œæ¯”è¾ƒæ•°æ®ã€‚</p>

<p>Go Driveræœ‰ä¸¤ç±»ç”¨äºè¡¨ç¤ºBSONæ•°æ®çš„ç±»å‹:Dç±»å‹å’ŒRawç±»å‹ã€‚</p>

<h2 id="dç³»åˆ—">Dç³»åˆ—</h2>

<p>Dç³»åˆ—ç±»å‹ç”¨äºä½¿ç”¨æœ¬åœ°Goç±»å‹ç®€æ´åœ°æ„å»ºBSONå¯¹è±¡ã€‚ è¿™å¯¹äºæ„é€ ä¼ é€’ç»™MongoDBçš„å‘½ä»¤ç‰¹åˆ«æœ‰ç”¨ã€‚</p>

<p>Dç³»åˆ—åŒ…æ‹¬å››ç§ç±»å‹ï¼š</p>

<h3 id="d">D</h3>

<p>Dè¡¨ç¤ºBSONæ–‡æ¡£ã€‚æ­¤ç±»å‹å¯ç”¨äºä»¥ç®€æ´å’Œå¯è¯»çš„æ–¹å¼è¡¨ç¤ºBSON</p>

<p>Dé€šå¸¸åº”åœ¨åºåˆ—åŒ–ä¸ºBSONæ—¶ä½¿ç”¨ã€‚å¯¹äºååºåˆ—åŒ–ï¼Œåº”è¯¥ä½¿ç”¨Rawæˆ–Dç±»å‹ã€‚</p>

<p>ç”¨æ³•ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
    <span class="p">{</span><span class="s">&#34;title&#34;</span><span class="p">,</span> <span class="s">&#34;post 2&#34;</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">}},</span>
    <span class="p">{</span><span class="s">&#34;body&#34;</span><span class="p">,</span> <span class="s">`blog post 2`</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;created_at&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()},</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>æ­¤æ“ä½œå°†åˆ›å»ºå…·æœ‰æœ‰åºå…ƒç´ çš„æ–‡æ¡£ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
    <span class="s">&#34;_id&#34;</span> <span class="p">:</span> <span class="nf">ObjectId</span><span class="p">(</span><span class="s">&#34;5c71f03ccfee587e4212ad8f&#34;</span><span class="p">),</span>
    <span class="s">&#34;title&#34;</span> <span class="p">:</span> <span class="s">&#34;post 2&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s">&#34;mongodb&#34;</span>
    <span class="p">],</span>
    <span class="s">&#34;body&#34;</span> <span class="p">:</span> <span class="s">&#34;blog post 2&#34;</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span> <span class="p">:</span> <span class="nf">ISODate</span><span class="p">(</span><span class="s">&#34;2019-02-24T01:15:40.328Z&#34;</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>æ­¤ç±»å‹åº”åœ¨é¡ºåºé‡è¦çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä¾‹å¦‚MongoDBå‘½ä»¤ã€‚å¦‚æœé¡ºåºå¹¶ä¸é‡è¦ï¼Œmapæ›´èˆ’é€‚ï¼Œæ›´ç®€æ´</p>

<h3 id="e">E</h3>

<p>Eä»£è¡¨Dçš„BSONå…ƒç´ ã€‚å®ƒé€šå¸¸ç”¨åœ¨Dä¸­ã€‚</p>

<h3 id="m">M</h3>

<p>Mæ˜¯BSONæ–‡æ¡£çš„æ— åºï¼Œç®€æ´è¡¨ç¤ºã€‚å®ƒé€šå¸¸åº”è¯¥ç”¨äºå½“BSONæ–‡æ¡£çš„å…ƒç´ é¡ºåºæ— å…³ç´§è¦æ—¶åºåˆ—åŒ–BSONã€‚å¦‚æœå…ƒç´ çš„é¡ºåºé‡è¦ï¼Œè¯·æ”¹ç”¨Dä»£æ›¿ã€‚</p>

<p>ç”¨æ³•ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
    <span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
    <span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">`blog post`</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<p>ä¸Šé¢çš„æ“ä½œå°†åˆ›å»ºä¸€ä¸ªåŒ…å«æ— åºå…ƒç´ çš„æ–‡æ¡£ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
    <span class="s">&#34;_id&#34;</span> <span class="p">:</span> <span class="nf">ObjectId</span><span class="p">(</span><span class="s">&#34;5c71f03ccfee587e4212ad8e&#34;</span><span class="p">),</span>
    <span class="s">&#34;body&#34;</span> <span class="p">:</span> <span class="s">&#34;blog post&#34;</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span> <span class="p">:</span> <span class="nf">ISODate</span><span class="p">(</span><span class="s">&#34;2019-02-24T01:15:40.326Z&#34;</span><span class="p">),</span>
    <span class="s">&#34;title&#34;</span> <span class="p">:</span> <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s">&#34;mongodb&#34;</span>
    <span class="p">]</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>è¯·æ³¨æ„ï¼Œå…ƒç´ çš„é¡ºåºä¸æä¾›çš„é¡ºåºä¸åŒbson.Mã€‚</p>

<p>æ­¤ç±»å‹åœ¨ç¼–ç å™¨ä¸­ä½œä¸ºå¸¸è§„<code>map[string]interface{}</code>å¤„ç†ã€‚å…ƒç´ å°†æ˜¯ä»¥æœªå®šä¹‰çš„éšæœºé¡ºåºåºåˆ—åŒ–ï¼Œæ¯æ¬¡é¡ºåºéƒ½ä¸åŒã€‚</p>

<h3 id="a">A</h3>

<p>Aè¡¨ç¤ºBSONæ•°ç»„ã€‚è¿™ç§ç±»å‹å¯ä»¥ç”¨æ¥ç®€æ´åœ°è¡¨ç¤ºBSONæ•°ç»„.Aé€šå¸¸åº”åœ¨åºåˆ—åŒ–ä¸ºBSONæ—¶ä½¿ç”¨ã€‚å¯¹äºååºåˆ—åŒ–ï¼Œåº”è¯¥ä½¿ç”¨RawArrayæˆ–Arrayç±»å‹ã€‚</p>

<p>ç”¨æ³•ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">bson</span><span class="p">.</span><span class="nx">A</span> <span class="p">{</span><span class="err">â€œ</span><span class="nx">bar</span><span class="err">â€ï¼Œâ€œ</span><span class="nx">world</span><span class="err">â€ï¼Œ</span><span class="mf">3.14159</span><span class="err">ï¼Œ</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span> <span class="p">{{</span><span class="err">â€œ</span><span class="nx">qux</span><span class="err">â€ï¼Œ</span><span class="mi">12345</span><span class="p">}}}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="rawç±»å‹">Rawç±»å‹</h2>

<p>Rawç±»å‹ç”¨äºbyteåˆ‡ç‰‡ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ¬§è·¯è¯å…¸ä»Rawç±»å‹ä¸­å–å›å•ç‹¬çš„å…ƒç´ ã€‚å¦‚æœæ‚¨ä¸å¸Œæœ›èŠ±è´¹é¢‘ç¹å°†BSONè§£ç ä¸ºå¦ä¸€ç§ç±»å‹çš„å¼€é”€ï¼Œè¿™å°†éå¸¸æœ‰ç”¨ã€‚æœ¬æ•™ç¨‹ä»…ä½¿ç”¨Dç³»åˆ—ç±»å‹ã€‚</p>

<h2 id="ç»“æ„ä½“æ›¿ä»£bson">ç»“æ„ä½“æ›¿ä»£bson</h2>

<p>é™¤äº†ä¼ å…¥bson,è¿˜å¯ä»¥ä¼ å…¥å¸¦tagçš„ç»“æ„ä½“ä½œä¸ºbson</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">BeforeCond</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Before</span> <span class="kt">int64</span> <span class="s">`bson:&#34;$lt&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">DeleteCond</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">BeforeCond</span> <span class="nx">BeforeCond</span> <span class="s">`bson:&#34;timePoint.startTime&#34;`</span>
<span class="p">}</span>

<span class="nx">delCond</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">DeleteCond</span><span class="p">{</span>
	<span class="nx">BeforeCond</span><span class="p">:</span> <span class="nx">BeforeCond</span><span class="p">{</span>
		<span class="nx">Before</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">}</span>


<span class="kd">type</span> <span class="nx">FindByJobName</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">JobName</span> <span class="kt">string</span> <span class="s">`bson:&#34;jobName&#34;`</span>
<span class="p">}</span>

<span class="nx">cond</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">FindByJobName</span><span class="p">{</span>
	<span class="nx">JobName</span><span class="p">:</span> <span class="s">&#34;hello&#34;</span><span class="p">,</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="bsonè½¬ç»“æ„ä½“">bsonè½¬ç»“æ„ä½“</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//bsonè½¬ç»“æ„ä½“,éœ€è¦ç»“æ„ä½“æ‰“ä¸Šbsonæ ‡ç­¾
</span><span class="c1">//a:=bson.M{}
</span><span class="c1">//x:=A{}
</span><span class="c1">//Bson2Odj(a,&amp;x)
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Bson2Odj</span><span class="p">(</span><span class="nx">val</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">//bsonè½¬[]byte
</span><span class="c1"></span>	<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="c1">//[]byteè½¬ç»“æ„ä½“
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="mongo-shell-è½¬bson">mongo Shell è½¬bson</h2>

<h3 id="shellè¯­å¥-è½¬-bson">shellè¯­å¥ è½¬ bson</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">a</span><span class="o">:=</span><span class="s">`$and : [{&#34;id&#34; : &#34;asdfzcv&#34;}, {&#34;num&#34; : 6}]`</span>
	<span class="c1">//bb:=bson.M{&#34;id&#34;: &#34;asdfzcv&#34;, &#34;num&#34;: 6}
</span><span class="c1"></span>	<span class="nx">bb</span><span class="o">:=</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{}</span>
	<span class="nx">_</span><span class="p">=</span><span class="nx">bson</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span><span class="o">&amp;</span><span class="nx">bb</span><span class="p">)</span>
	<span class="o">//</span><span class="nx">bb</span><span class="p">=</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">:</span> <span class="s">&#34;asdfzcv&#34;</span><span class="p">,</span> <span class="s">&#34;num&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">update</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{ &#34;$set&#34;: {&#34;year&#34;: 1998}}`</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">update</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="shellè¯­å¥ç»„-è½¬-bson">shellè¯­å¥ç»„ è½¬ []bson</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="nx">toConvert</span> <span class="o">:=</span> <span class="s">`[
</span><span class="s">        {
</span><span class="s">            &#34;$project&#34;: {
</span><span class="s">                &#34;_id&#34;: 0,
</span><span class="s">                &#34;A&#34;: &#34;$$ROOT&#34;
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$lookup&#34;: {
</span><span class="s">                &#34;localField&#34;: &#34;A.TypeId&#34;,
</span><span class="s">                &#34;from&#34;: &#34;RoleType&#34;,
</span><span class="s">                &#34;foreignField&#34;: &#34;_id&#34;,
</span><span class="s">                &#34;as&#34;: &#34;B&#34;
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$unwind&#34;: {
</span><span class="s">                &#34;path&#34;: &#34;$B&#34;,
</span><span class="s">                &#34;preserveNullAndEmptyArrays&#34;: true
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$project&#34;: {
</span><span class="s">                &#34;A.RoleId&#34;: &#34;$A.RoleId&#34;,
</span><span class="s">                &#34;A.RoleName&#34;: &#34;$A.RoleName&#34;,
</span><span class="s">                &#34;A.Valid&#34;: &#34;$A.Valid&#34;,
</span><span class="s">                &#34;B.TypeName&#34;: &#34;$B.TypeName&#34;
</span><span class="s">            }
</span><span class="s">        }
</span><span class="s">    ]`</span>
<span class="nx">pipeLine</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">UnmarshalExtJSON</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">toConvert</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pipeLine</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="crudæ“ä½œ">CRUDæ“ä½œ</h1>

<p>è¿æ¥åˆ°æ•°æ®åº“åï¼Œå°±å¯ä»¥å¼€å§‹æ·»åŠ å’Œæ“ä½œæŸäº›æ•°æ®äº†ã€‚è¯¥Collectionç±»å‹æœ‰å‡ ç§æ–¹æ³•ï¼Œå…è®¸æ‚¨å‘æ•°æ®åº“å‘é€æŸ¥è¯¢ã€‚</p>

<h2 id="æ’å…¥æ–‡ä»¶">æ’å…¥æ–‡ä»¶</h2>

<h3 id="insertone">InsertOne</h3>

<p>è¦æ’å…¥å•ä¸ªæ–‡æ¡£ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹collection.InsertOne()æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create a new context with a 10 second timeout
</span><span class="c1"></span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>

<span class="c1">// insert one document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="s">&#34;title&#34;</span><span class="p">:</span> <span class="s">&#34;Go mongodb driver cookbook&#34;</span><span class="p">,</span>
	<span class="s">&#34;tags&#34;</span><span class="p">:</span>  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;golang&#34;</span><span class="p">,</span> <span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
	<span class="s">&#34;body&#34;</span><span class="p">:</span> <span class="s">`this is a long post
</span><span class="s">    that goes on and on
</span><span class="s">    and have many lines`</span><span class="p">,</span>
	<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">1</span><span class="p">,</span>
	<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
	<span class="s">&#34;new post created with id: %s&#34;</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">InsertedID</span><span class="p">.(</span><span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span><span class="p">).</span><span class="nf">Hex</span><span class="p">(),</span>
<span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">new</span> <span class="nx">post</span> <span class="nx">created</span> <span class="nx">with</span> <span class="nx">id</span><span class="p">:</span> <span class="mi">5</span><span class="nx">c71caf32a346553363177ce</span></code></pre></td></tr></table>
</div>
</div>
<p>ä¹Ÿå¯ä»¥ä¸ä½¿ç”¨bson.M{}æ¥ä¼ é€’å‚æ•°,è€Œæ˜¯ä½¿ç”¨åŒ…å«bsonæ ‡ç­¾ä¾‹å¦‚`bson:&rdquo;_id&rdquo;`çš„ç»“æ„ä½“,æ¯”å¦‚:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ID</span>    <span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span> 	<span class="s">`bson:&#34;_id,omitempty&#34;`</span>
	<span class="nx">Name</span>  <span class="kt">string</span>      			<span class="s">`bson:&#34;dbname&#34;,json:&#34;jsonname&#34;`</span>
	<span class="nx">Phone</span> <span class="kt">string</span>
	<span class="nx">ASD</span>   <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// Insert one
</span><span class="c1"></span><span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span><span class="s">&#34;1234567890&#34;</span><span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">InsertedID</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Insert many
</span><span class="c1"></span><span class="p">{</span>
	<span class="nx">users</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}{</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_0&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;123&#34;</span><span class="p">},</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_1&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;456&#34;</span><span class="p">},</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_2&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">InsertMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">users</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="insertmany">InsertMany</h3>

<p>è¦ä¸€æ¬¡æ’å…¥å¤šä¸ªæ–‡æ¡£ï¼Œè¯¥collection.InsertMany()æ–¹æ³•å°†é‡‡ç”¨ä¸€äº›å¯¹è±¡ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}{</span>
	<span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;Post one&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;golang&#34;</span><span class="p">},</span>
		<span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">&#34;post one body&#34;</span><span class="p">,</span>
		<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">14</span><span class="p">,</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">January</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">UTC</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;Post two&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;nodejs&#34;</span><span class="p">},</span>
		<span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">&#34;post two body&#34;</span><span class="p">,</span>
		<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">2</span><span class="p">,</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;inserted ids: %v\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">InsertedIDs</span><span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">inserted</span> <span class="nx">ids</span><span class="p">:</span> <span class="p">[</span><span class="nf">ObjectID</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93be&#34;</span><span class="p">)</span> <span class="nf">ObjectID</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93bf&#34;</span><span class="p">)]</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="æ›´æ–°æ–‡ä»¶">æ›´æ–°æ–‡ä»¶</h2>

<h3 id="update">update</h3>

<h4 id="updateone">UpdateOne</h4>

<p>è¯¥collection.UpdateOne()æ–¹æ³•å…è®¸æ‚¨æ›´æ–°å•ä¸ªæ–‡æ¡£ã€‚å®ƒéœ€è¦ä¸€ä¸ªè¿‡æ»¤å™¨æ–‡æ¡£æ¥åŒ¹é…æ•°æ®åº“ä¸­çš„æ–‡æ¡£å’Œä¸€ä¸ªæ›´æ–°æ–‡æ¡£æ¥æè¿°æ›´æ–°æ“ä½œã€‚updateéœ€è¦ä¼ å…¥bsonå‘½ä»¤</p>

<p>æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹bson.Dç±»å‹æ„å»ºè¿™äº›ï¼š</p>

<p>è¿™é‡Œæˆ‘ä»¬è¿˜ä»å…¶åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ObjectIDï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create ObjectID from string
</span><span class="c1"></span><span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93be&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// set filters and updates
</span><span class="c1"></span><span class="nx">filter</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">}</span>
<span class="nx">update</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;title&#34;</span><span class="p">:</span> <span class="s">&#34;post 2 (two)&#34;</span><span class="p">}}</span>

<span class="c1">// update document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;modified count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">modified</span> <span class="nx">count</span><span class="p">:</span> <span class="mi">1</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="updatemany">UpdateMany</h4>

<p>è¦æ›´æ–°å¤šä¸ªæ–‡æ¡£ï¼ˆç›¸å½“äº{multi: true}ï¼‰ï¼Œè¯·ä½¿ç”¨collection.UpdateMany()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// set filters and updates
</span><span class="c1"></span><span class="nx">filter</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$elemMatch&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$eq&#34;</span><span class="p">:</span> <span class="s">&#34;golang&#34;</span><span class="p">}}}</span>
<span class="nx">update</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;comments&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;updated_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}}</span>

<span class="c1">// update documents
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;modified count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">modified</span> <span class="nx">count</span><span class="p">:</span> <span class="mi">17</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="upsert">upsert</h4>

<p>å¯¹äºä¸¤è€…è€Œè¨€UpdateOneï¼ŒUpdateManyæ‚¨å¯ä»¥é€šè¿‡å°†é€‚å½“çš„é€‰é¡¹ä¼ é€’ç»™å‡½æ•°æ¥ä½¿å…¶æˆä¸ºupsertæ“ä½œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Update</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span>

<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateMany</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Update</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="replace">replace</h3>

<h4 id="replaceone">replaceone</h4>

<p>Updateæ˜¯ç”¨æ¥ç›´æ¥ä¿®æ”¹æ•°æ®åº“çš„ï¼ŒReplaceOneåˆ™æ˜¯æ•´ä¸ªæ›¿æ¢ã€‚ å¯ä»¥ç”¨bsonä¼ å…¥è¦æ›¿æ¢çš„å€¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">}</span>
<span class="kd">var</span> <span class="nx">result</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">UpdateResult</span>
<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionExamples</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">doc</span><span class="p">[</span><span class="s">&#34;year&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1998</span>
<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s">&#34;_id&#34;</span><span class="p">]},</span> <span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>replacementä¹Ÿå¯ä»¥ç›´æ¥ä¼ å…¥ç»“æ„ä½“è¿›è¡Œæ›´æ–°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Replace one
</span><span class="c1"></span><span class="p">{</span>
	<span class="nx">user</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_2_replaced&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">}</span>
	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;phone&#34;</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">},</span> <span class="nx">user</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="resert">resert</h4>

<p>ä¹Ÿå¯ä»¥é€šè¿‡å°†é€‚å½“çš„é€‰é¡¹ä¼ é€’ç»™å‡½æ•°æ¥ä½¿replaceå…¶æˆä¸ºupsertæ“ä½œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Replace</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span>

<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">ReplaceMany</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Replace</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="nx">v</span>
<span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="æŸ¥è¯¢ä¸åˆ æ”¹æ¢ç»“åˆ">æŸ¥è¯¢ä¸åˆ æ”¹æ¢ç»“åˆ</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//æŸ¥è¯¢å•æ¡æ•°æ®ååˆ é™¤è¯¥æ•°æ®
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndDelete</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_3&#34;</span><span class="p">}}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;FindOneAndDeleteæŸ¥è¯¢åˆ°çš„æ•°æ®:%v\n&#34;</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>
<span class="c1">//æŸ¥è¯¢å•æ¡æ•°æ®åä¿®æ”¹è¯¥æ•°æ®
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndUpdate</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_4&#34;</span><span class="p">}},</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;è¿™æ¡æ•°æ®æˆ‘éœ€è¦ä¿®æ”¹äº†&#34;</span><span class="p">}}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;FindOneAndUpdateæŸ¥è¯¢åˆ°çš„æ•°æ®:%v\n&#34;</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>

<span class="c1">//æŸ¥è¯¢å•æ¡æ•°æ®åæ›¿æ¢è¯¥æ•°æ®(ä»¥å‰çš„æ•°æ®å…¨éƒ¨æ¸…ç©º)
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndReplace</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_5&#34;</span><span class="p">}}</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;hero&#34;</span><span class="p">:</span> <span class="s">&#34;è¿™æ¡æ•°æ®æˆ‘æ›¿æ¢äº†&#34;</span><span class="p">}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="æŸ¥æ‰¾æ–‡ä»¶">æŸ¥æ‰¾æ–‡ä»¶</h2>

<h3 id="findone">FindOne</h3>

<p>è¦æŸ¥æ‰¾æ–‡æ¡£ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªè¿‡æ»¤å™¨æ–‡æ¡£ä»¥åŠä¸€ä¸ªæŒ‡å‘å¯ä»¥è§£ç ç»“æœçš„å€¼çš„æŒ‡é’ˆã€‚è¦æŸ¥æ‰¾å•ä¸ªæ–‡æ¡£ï¼Œè¯·ä½¿ç”¨collection.FindOne()ã€‚æ­¤æ–¹æ³•è¿”å›å•ä¸ªç»“æœï¼Œå¯å°†å…¶è§£ç ä¸ºå€¼ã€‚æ‚¨å°†ä½¿ç”¨filteråœ¨æ›´æ–°æŸ¥è¯¢ä¸­ä½¿ç”¨çš„ç›¸åŒå˜é‡æ¥åŒ¹é…åç§°ä¸ºAshçš„æ–‡æ¡£ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create a value into which the result can be decoded
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">result</span> <span class="nx">Trainer</span>

<span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">filter</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Found a single document: %+v\n&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>Decode()å‡½æ•°ä¹Ÿå¯ä»¥ä¼ å‚bson</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">table</span><span class="p">.</span><span class="nf">FindOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="find">Find</h3>

<p>è¦æŸ¥æ‰¾å¤šä¸ªæ–‡æ¡£ï¼Œè¯·ä½¿ç”¨collection.Find()ã€‚è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªCursorã€‚A Cursoræä¾›äº†ä¸€ä¸ªæ–‡æ¡£æµï¼Œæ‚¨å¯ä»¥é€šè¿‡å®ƒä»¬ä¸€æ¬¡è¿­ä»£å’Œè§£ç ä¸€ä¸ªæ–‡æ¡£ã€‚ä¸€æ—¦Cursorç”¨å°½ï¼Œä½ åº”è¯¥å…³é—­Cursorã€‚åœ¨è¿™é‡Œï¼Œæ‚¨è¿˜å°†ä½¿ç”¨optionsåŒ…è®¾ç½®ä¸€äº›æ“ä½œé€‰é¡¹ã€‚å…·ä½“æ¥è¯´ï¼Œæ‚¨å°†è®¾ç½®é™åˆ¶ï¼Œå› æ­¤åªè¿”å›2ä¸ªæ–‡æ¡£ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Pass these options to the Find method
</span><span class="c1"></span><span class="nx">findOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">()</span>
<span class="nx">findOptions</span><span class="p">.</span><span class="nf">SetLimit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1">// Here&#39;s an array in which you can store the decoded documents
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">results</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Trainer</span>

<span class="c1">// Passing bson.D{{}} as the filter matches all documents in the collection
</span><span class="c1"></span><span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{}},</span> <span class="nx">findOptions</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Finding multiple documents returns a cursor
</span><span class="c1">// Iterating through the cursor allows us to decode documents one at a time
</span><span class="c1"></span><span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span> <span class="p">{</span>
    
    <span class="c1">// create a value into which the single document can be decoded
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">elem</span> <span class="nx">Trainer</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">results</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Close the cursor once finished
</span><span class="c1"></span><span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Found multiple documents (array of pointers): %+v\n&#34;</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>Findä¹Ÿå¯ä»¥è¿”å›bson,å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">MongoUtils</span><span class="p">)</span> <span class="nf">FindMore</span><span class="p">(</span><span class="nx">col</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">filter</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">([]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">,</span> <span class="kt">error</span><span class="p">){</span>
	<span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Con</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;æ²¡æœ‰åˆå§‹åŒ–è¿æ¥å’Œæ•°æ®åº“ä¿¡æ¯ï¼&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">table</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">col</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">,</span><span class="nx">_</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="nx">cur</span><span class="p">,</span> <span class="nx">err2</span> <span class="o">:=</span> <span class="nx">table</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err2</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">err2</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err2</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">resultArr</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
		<span class="nx">err3</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err3</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err3</span>
		<span class="p">}</span>
		<span class="nx">resultArr</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">resultArr</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">resultArr</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="æœ‰åºfind">æœ‰åºfind</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//ä¸€æ¬¡æŸ¥è¯¢å¤šæ¡æ•°æ®
</span><span class="c1">// æŸ¥è¯¢createtime&gt;=3
</span><span class="c1">// é™åˆ¶å–2æ¡
</span><span class="c1">// createtimeä»å¤§åˆ°å°æ’åºçš„æ•°æ®
</span><span class="c1"></span><span class="k">if</span> <span class="nx">cursor</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.{</span><span class="s">&#34;$gte&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}},</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">().</span><span class="nf">SetLimit</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">().</span><span class="nf">SetSort</span><span class="p">(</span><span class="nx">bson</span><span class="p">.{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}));</span> <span class="nx">err</span><span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//å¤šä¸ªoptions.Find()å¯ä»¥ç”¨é“¾å¼è¡¨è¾¾,æ¯”å¦‚:
</span><span class="c1">//findOptions := options.Find().SetSort(SORT).SetLimit(Limit).SetSkip(Skip)
</span><span class="c1">//æŒ‰é€‰é¡¹æŸ¥è¯¢é›†åˆ Skip è·³è¿‡ Limit è¯»å–æ•°é‡ sort 
</span><span class="c1"></span>
<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
<span class="k">for</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">howieArrayEmpty</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">howieArrayEmpty</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">howieArrayEmpty</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;FindæŸ¥è¯¢åˆ°çš„æ•°æ®ObejectIdå€¼%s å€¼:%v\n&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">HowieId</span><span class="p">.</span><span class="nf">Hex</span><span class="p">(),</span> <span class="nx">v</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="distinct">distinct</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//è¿”å›æ»¡è¶³filteræ¡ä»¶ä¸‹çš„æ‰€æœ‰fieldNameå€¼,[]interface{}ç±»å‹
</span><span class="c1">//res, err := mymongo.Distinct(&#34;test&#34;, &#34;id&#34;, bson.M{})
</span><span class="c1"></span>	<span class="nx">collection</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">fieldName</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="æ ¹æ®-idæŸ¥æ‰¾æ–‡ä»¶">æ ¹æ®_idæŸ¥æ‰¾æ–‡ä»¶</h3>

<p>mongodbé‡Œé¢&rdquo;_id&rdquo;ä¸æ˜¯å­—ç¬¦ä¸²,åªæ˜¯æ–¹ä¾¿æ˜¾ç¤º,åœ¨å¯è§†åŒ–ç•Œé¢ä¸­å±•ç¤ºä¸ºå­—ç¬¦ä¸²,å¦‚&rdquo;5d36fc03d3a200b7aeecaeac&rdquo;</p>

<p>å¦‚æœè¦åœ¨golangä¸­é€šè¿‡_idæŸ¥æ‰¾æ–‡ä»¶,éœ€è¦å…ˆå°†å­—ç¬¦ä¸²è½¬åŒ–ä¸ºprimitive.ObjectID,ç„¶åå†æŸ¥æ‰¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">ID</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="nx">stringID</span><span class="p">)</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">ID</span><span class="p">})</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="åˆ é™¤æ–‡ä»¶">åˆ é™¤æ–‡ä»¶</h2>

<h3 id="deleteone">DeleteOne</h3>

<p>è¦åˆ é™¤æ–‡æ¡£ï¼Œè¯·ä½¿ç”¨collection.DeleteOne()ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create ObjectID from string
</span><span class="c1"></span><span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93be&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// delete document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">DeleteOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;deleted count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="deletemany">DeleteMany</h3>

<p>æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨collection.DeleteOne()æˆ–åˆ é™¤æ–‡æ¡£collection.DeleteMany()ã€‚åœ¨è¿™é‡Œï¼Œæ‚¨å°†ä¼ é€’bson.D{{}}è¿‡æ»¤å™¨å‚æ•°ï¼Œè¯¥å‚æ•°å°†åŒ¹é…é›†åˆä¸­çš„æ‰€æœ‰æ–‡æ¡£ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨collection.Drop()åˆ é™¤æ•´ä¸ªé›†åˆã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">deleteResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">DeleteMany</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{}})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Deleted %v documents in the trainers collection\n&#34;</span><span class="p">,</span> <span class="nx">deleteResult</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="bulkwrite">bulkWrite</h1>

<p>æœ‰æ—¶æ‚¨æƒ³è¦æ‰§è¡Œè®¸å¤šæ“ä½œï¼Œä¾‹å¦‚ä¸€æ¬¡æ’å…¥ï¼Œæ›´æ–°å’Œåˆ é™¤æ‰€æœ‰æ“ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒMongoDBæä¾›äº†éå¸¸æœ‰ç”¨çš„æ‰¹é‡å†™å…¥APIï¼Œå®ƒé‡‡ç”¨ä¸€ç³»åˆ—å†™å…¥æ“ä½œå¹¶æ‰§è¡Œæ¯ä¸ªæ“ä½œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ“ä½œæŒ‰é¡ºåºæ‰§è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// list of inserts
</span><span class="c1"></span><span class="nx">inserts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post five&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;postgresql&#34;</span><span class="p">},</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post six&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;graphql&#34;</span><span class="p">},</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">}</span>

<span class="c1">// list of updates
</span><span class="c1"></span><span class="nx">updates</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">filter</span>  <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">updates</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
<span class="p">}{</span>
	<span class="p">{</span>
		<span class="nx">filter</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
			<span class="s">&#34;tags&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$elemMatch&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$eq&#34;</span><span class="p">:</span> <span class="s">&#34;golang&#34;</span><span class="p">}},</span>
		<span class="p">},</span>
		<span class="nx">updates</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;updated_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}},</span>
	<span class="p">},</span>
<span class="p">}</span>

<span class="c1">// list of deletes
</span><span class="c1"></span><span class="nx">deletes</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id3</span><span class="p">},</span>
<span class="p">}</span>

<span class="c1">// create the slice of write models
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">writes</span> <span class="p">[]</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">WriteModel</span>

<span class="c1">// range over each list of operations and create the write model
</span><span class="c1"></span><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ins</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">inserts</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewInsertOneModel</span><span class="p">().</span><span class="nf">SetDocument</span><span class="p">(</span><span class="nx">ins</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">upd</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">updates</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewUpdateManyModel</span><span class="p">().</span>
		<span class="nf">SetFilter</span><span class="p">(</span><span class="nx">upd</span><span class="p">.</span><span class="nx">filter</span><span class="p">).</span><span class="nf">SetUpdate</span><span class="p">(</span><span class="nx">upd</span><span class="p">.</span><span class="nx">updates</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">del</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">deletes</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewDeleteManyModel</span><span class="p">().</span><span class="nf">SetFilter</span><span class="p">(</span><span class="nx">del</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// run bulk write
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">BulkWrite</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">writes</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
	<span class="s">&#34;insert: %d, updated: %d, deleted: %d&#34;</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">InsertedCount</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">,</span>
<span class="p">)</span>
<span class="o">//</span> <span class="p">=&gt;</span> <span class="nx">insert</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">updated</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">deleted</span><span class="p">:</span> <span class="mi">3</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="èšåˆæŸ¥è¯¢">èšåˆæŸ¥è¯¢</h1>

<h2 id="count">count</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//æŸ¥è¯¢é›†åˆé‡Œé¢æœ‰å¤šå°‘æ•°æ®
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">CountDocuments</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Counté‡Œé¢æœ‰å¤šå°‘æ¡æ•°æ®:%d\n&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>

	<span class="c1">//æŸ¥è¯¢é›†åˆé‡Œé¢æœ‰å¤šå°‘æ•°æ®(æŸ¥è¯¢createtime&gt;=3çš„æ•°æ®)
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">CountDocuments</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$gte&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Counté‡Œé¢æœ‰å¤šå°‘æ¡æ•°æ®:%d\n&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">ErrNoDocuments</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;æ²¡æœ‰æŸ¥åˆ°æ•°æ®&#34;</span><span class="p">)</span>
			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="estimateddocumentcount">EstimatedDocumentCount</h2>

<p>ä¼°è®¡é›†åˆå†…æœ‰å¤šå°‘æ•°æ®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">num</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">EstimatedDocumentCount</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="aggregate">aggregate</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">TestAggregateJSON</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>

	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>

	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="s">`[
</span><span class="s">		{&#34;$match&#34;: { &#34;color&#34;: &#34;Red&#34; }},
</span><span class="s">		{&#34;$group&#34;: { &#34;_id&#34;: &#34;$brand&#34;, &#34;count&#34;: { &#34;$sum&#34;: 1 } }},
</span><span class="s">		{&#34;$project&#34;: { &#34;brand&#34;: &#34;$_id&#34;, &#34;_id&#34;: 0, &#34;count&#34;: 1 }}
</span><span class="s">	]`</span>

	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">brands</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">brands</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAllowDiskUse</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetBatchSize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
	<span class="nx">pipeLine</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">UnmarshalExtJSON</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pipeLine</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeLine</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">total</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">),</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestAggregatePipeline</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>

	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>

	<span class="c1">// this cause warning from go vet
</span><span class="c1"></span>	<span class="c1">// pipeline := mongo.Pipeline{
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$match&#34;, bson.D{{&#34;color&#34;, &#34;Red&#34;}}}},
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$group&#34;, bson.D{{&#34;_id&#34;, &#34;$brand&#34;}, {&#34;count&#34;, bson.D{{&#34;$sum&#34;, 1}}}}}},
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$project&#34;, bson.D{{&#34;brand&#34;, &#34;$_id&#34;}, {&#34;_id&#34;, 0}, {&#34;count&#34;, 1}}}},
</span><span class="c1"></span>	<span class="c1">// }
</span><span class="c1"></span>	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$match&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}}}},</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$group&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;_id&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;$brand&#34;</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;count&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$sum&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}}}},</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$project&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;$_id&#34;</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;_id&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;count&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}},</span>
	<span class="p">}</span>
	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">brands</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">brands</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAllowDiskUse</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetBatchSize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">total</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">),</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestAggregateBSOND</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="nx">size</span> <span class="o">:=</span> <span class="mi">10</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>
	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;$sample&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;size&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">}}}}}</span>
	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected &#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="äº‹åŠ¡æœºåˆ¶">äº‹åŠ¡æœºåˆ¶</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// WithSessionå…è®¸ç”¨æˆ·è‡ªå·±å¯åŠ¨ä¼šè¯å¹¶è¿›è¡Œç®¡ç†
</span><span class="c1">//å®ƒçš„ä¸€ç”Ÿä¸ºCRUDæ–¹æ³•æä¾›ä¼šè¯çš„å”¯ä¸€æ–¹æ³•æ˜¯
</span><span class="c1">//ä½¿ç”¨mongo.SessionContextè°ƒç”¨è¯¥CRUDæ–¹æ³•
</span><span class="c1">//å…³é—­mongo.SessionContextå¯ä»¥ç”¨ä½œå¸¸è§„ä¸Šä¸‹æ–‡ï¼Œ
</span><span class="c1">//æ‰€ä»¥åƒcontext.WithDeadlineå’Œcontext.WithTimeoutè¿™æ ·çš„æ–¹æ³•æ˜¯
</span><span class="c1">// æ”¯æŒçš„ã€‚
</span><span class="c1">//
</span><span class="c1">//å¦‚æœcontext.Contextå·²ç»é™„åŠ äº†mongo.Sessionï¼Œé‚£å°±æ˜¯
</span><span class="c1">// mongo.Sessionå°†æ›¿æ¢ä¸ºæä¾›çš„ã€‚
</span><span class="c1">//
</span><span class="c1">//ä»é—­åŒ…ä¸­è¿”å›çš„é”™è¯¯æ˜¯é€æ˜åœ°è¿”å›çš„
</span><span class="c1">//è¿™ä¸ªåŠŸèƒ½
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">WithSession</span><span class="err">ï¼ˆ</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="err">ï¼Œ</span><span class="nx">sess</span> <span class="nx">Session</span><span class="err">ï¼Œ</span><span class="nx">fn</span> <span class="kd">func</span><span class="err">ï¼ˆ</span><span class="nx">SessionContext</span><span class="err">ï¼‰</span><span class="kt">error</span><span class="err">ï¼‰</span><span class="kt">error</span> <span class="p">{</span>
<span class="k">return</span> <span class="nx">fn</span><span class="err">ï¼ˆ</span><span class="nx">contextWithSession</span><span class="err">ï¼ˆ</span><span class="nx">ctx</span><span class="err">ï¼Œ</span><span class="nx">sess</span><span class="err">ï¼‰ï¼‰</span>
<span class="p">}</span>

<span class="c1">// UseSessionåˆ›å»ºä¸€ä¸ªé»˜è®¤ä¼šè¯ï¼Œè¯¥ä¼šè¯ä»…å¯¹
</span><span class="c1">//å…³é—­çš„ç”Ÿå‘½å‘¨æœŸå…³é—­ä¼šè¯ä¹‹å¤–æ²¡æœ‰æ¸…ç†
</span><span class="c1">//åœ¨é€€å‡ºå°é—­æ—¶å®Œæˆã€‚è¿™æ„å‘³ç€ä¸€ä¸ªå‡ºè‰²çš„
</span><span class="c1">//å³ä½¿é—­åŒ…è¿”å›é”™è¯¯ï¼Œä¹Ÿä¼šä¸­æ­¢äº‹åŠ¡ã€‚
</span><span class="c1">//
</span><span class="c1">//å¦‚æœctxå·²ç»åŒ…å«mongo.Sessionï¼Œé‚£mongo.Sessionå°†æ˜¯
</span><span class="c1">//æ›¿æ¢ä¸ºæ–°åˆ›å»ºçš„mongo.Sessionã€‚
</span><span class="c1">//
</span><span class="c1">//ä»é—­åŒ…ä¸­è¿”å›çš„é”™è¯¯æ˜¯é€æ˜åœ°è¿”å›çš„
</span><span class="c1">//è¿™ä¸ªæ–¹æ³•
</span><span class="c1"></span><span class="kd">func</span><span class="err">ï¼ˆ</span><span class="nx">c</span> <span class="o">*</span> <span class="nx">Client</span><span class="err">ï¼‰</span><span class="nx">UseSession</span><span class="err">ï¼ˆ</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="err">ï¼Œ</span><span class="nx">fn</span> <span class="kd">func</span><span class="err">ï¼ˆ</span><span class="nx">SessionContext</span><span class="err">ï¼‰</span><span class="kt">error</span><span class="err">ï¼‰</span><span class="kt">error</span> <span class="p">{</span>
<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">UseSessionWithOptions</span><span class="err">ï¼ˆ</span><span class="nx">ctx</span><span class="err">ï¼Œ</span><span class="nx">options</span><span class="p">.</span><span class="nx">Session</span><span class="err">ï¼ˆï¼‰ï¼Œ</span><span class="nx">fn</span><span class="err">ï¼‰</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="withsession">WithSession</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">id</span> <span class="p">=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">,</span> <span class="s">&#34;year&#34;</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">1998</span><span class="p">)}</span>
	<span class="kd">var</span> <span class="nx">result</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">UpdateResult</span>
	<span class="kd">var</span> <span class="nx">session</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Session</span>
	<span class="kd">var</span> <span class="nx">update</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$set&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;year&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">2000</span><span class="p">)}}}}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">StartSession</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">WithSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sc</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">sc</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">},</span> <span class="nx">update</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">MatchedCount</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">result</span><span class="p">.</span><span class="nx">ModifiedCount</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;replace failed, expected 1 but got&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">MatchedCount</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="c1">//æäº¤
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="c1">//æ”¾å¼ƒ
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">session</span><span class="p">.</span><span class="nf">EndSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="usesession">UseSession</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;github.com/mongodb/mongo-go-driver/mongo&#34;</span>
    <span class="s">&#34;net/url&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="nx">connectString</span> <span class="o">:=</span> <span class="s">&#34;mongodb://127.0.0.1/test&#34;</span>
    <span class="nx">dbUrl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">connectString</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

    <span class="c1">//è®¤è¯å‚æ•°è®¾ç½®ï¼Œå¦åˆ™è¿ä¸ä¸Š
</span><span class="c1"></span>	<span class="nx">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">{}</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAuth</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">Credential</span><span class="p">{</span>
			<span class="nx">AuthMechanism</span><span class="p">:</span><span class="s">&#34;SCRAM-SHA-1&#34;</span><span class="p">,</span>
			<span class="nx">AuthSource</span><span class="p">:</span><span class="s">&#34;test&#34;</span><span class="p">,</span>
			<span class="nx">Username</span><span class="p">:</span><span class="s">&#34;test&#34;</span><span class="p">,</span>
			<span class="nx">Password</span><span class="p">:</span><span class="s">&#34;123456&#34;</span><span class="p">})</span>
			
    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">connectString</span><span class="err">ï¼Œ</span><span class="nx">opts</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

    <span class="nx">db</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbUrl</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    
    <span class="nx">col</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">)</span>
    
    <span class="c1">//å…ˆåœ¨äº‹åŠ¡å¤–å†™ä¸€æ¡idä¸ºâ€œ111â€çš„è®°å½•
</span><span class="c1"></span>    <span class="nx">_</span><span class="p">,</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;111&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    
    <span class="c1">//ç¬¬ä¸€ä¸ªäº‹åŠ¡ï¼šæˆåŠŸæ‰§è¡Œ
</span><span class="c1"></span>    <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">UseSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sessionContext</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//åœ¨äº‹åŠ¡å†…å†™ä¸€æ¡idä¸ºâ€œ222â€çš„è®°å½•
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;222&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//åœ¨äº‹åŠ¡å†…å†™ä¸€æ¡idä¸ºâ€œ333â€çš„è®°å½•
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;333&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">})</span>
	
    <span class="c1">//ç¬¬äºŒä¸ªäº‹åŠ¡ï¼šæ‰§è¡Œå¤±è´¥ï¼Œäº‹åŠ¡æ²¡æäº¤ï¼Œå› æœ€åæ’å…¥äº†ä¸€æ¡é‡å¤id &#34;111&#34;,
</span><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">UseSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sessionContext</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//åœ¨äº‹åŠ¡å†…å†™ä¸€æ¡idä¸ºâ€œ222â€çš„è®°å½•
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;444&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

		<span class="c1">//å†™é‡å¤id
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;111&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">})</span>
<span class="p">}</span> 

<span class="o">//</span><span class="nx">æœ€ç»ˆæ•°æ®åªæœ‰</span> <span class="s">&#34;111&#34;</span><span class="p">,</span><span class="s">&#34;222&#34;</span><span class="p">,</span><span class="s">&#34;333&#34;</span> <span class="nx">ä¸‰æ¡</span><span class="err">ï¼Œ</span><span class="nx">äº‹åŠ¡æµ‹è¯•æˆåŠŸ</span><span class="err">ã€‚</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="runcommand">RunCommand</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="nx">command</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;isMaster&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="s">&#34;admin&#34;</span><span class="p">).</span><span class="nf">RunCommand</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">command</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="gridfs">gridfs</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">bucket</span> <span class="o">*</span><span class="nx">gridfs</span><span class="p">.</span><span class="nx">Bucket</span>
	<span class="kd">var</span> <span class="nx">ustream</span> <span class="o">*</span><span class="nx">gridfs</span><span class="p">.</span><span class="nx">UploadStream</span>
	<span class="nx">str</span> <span class="o">:=</span> <span class="s">&#34;This is a test file&#34;</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>

	<span class="k">if</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">gridfs</span><span class="p">.</span><span class="nf">NewBucket</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nf">GridFSBucket</span><span class="p">().</span><span class="nf">SetName</span><span class="p">(</span><span class="s">&#34;myFiles&#34;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">GridFSUpload</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetMetadata</span><span class="p">(</span><span class="nx">bsonx</span><span class="p">.</span><span class="nx">Doc</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;content-type&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bsonx</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;application/json&#34;</span><span class="p">)}})</span>
	<span class="k">if</span> <span class="nx">ustream</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nf">OpenUploadStream</span><span class="p">(</span><span class="s">&#34;test.txt&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ustream</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">fileID</span> <span class="o">:=</span> <span class="nx">ustream</span><span class="p">.</span><span class="nx">FileID</span>
	<span class="nx">ustream</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">b</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
	<span class="nx">w</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nf">DownloadToStream</span><span class="p">(</span><span class="nx">fileID</span><span class="p">,</span> <span class="nx">w</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ustream</span><span class="p">.</span><span class="nx">FileID</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">str</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nx">str</span><span class="p">,</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
	<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="change-stream">change stream</h1>

<p>change_stream.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Copyright 2018 Kuei-chun Chen. All rights reserved.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">examples</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>

	<span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo/options&#34;</span>
<span class="p">)</span>

<span class="c1">// ChangeStream defines what to watch? client, database or collection
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ChangeStream</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">collection</span> <span class="kt">string</span>
	<span class="nx">database</span>   <span class="kt">string</span>
	<span class="nx">pipeline</span>   <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">callback</span> <span class="kd">func</span><span class="p">(</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span>

<span class="c1">// SetCollection sets collection
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span> <span class="p">=</span> <span class="nx">collection</span>
<span class="p">}</span>

<span class="c1">// SetDatabase sets database
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">database</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="p">=</span> <span class="nx">database</span>
<span class="p">}</span>

<span class="c1">// SetPipeline sets pipeline
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">pipeline</span>
<span class="p">}</span>

<span class="c1">// NewChangeStream gets a new ChangeStream
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewChangeStream</span><span class="p">()</span> <span class="o">*</span><span class="nx">ChangeStream</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ChangeStream</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// Watch prints oplogs in JSON format
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">cb</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">ChangeStream</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pipeline&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">ChangeStream</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetFullDocument</span><span class="p">(</span><span class="s">&#34;updateLookup&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="o">+</span><span class="s">&#34;.&#34;</span><span class="o">+</span><span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">coll</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">db</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching all&#34;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">doc</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nf">cb</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>change_stream_test.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Copyright 2018 Kuei-chun Chen. All rights reserved.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">examples</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;testing&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;github.com/simagix/keyhole/mdb&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/bson/primitive&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/x/network/connstring&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">collection</span> <span class="p">=</span> <span class="s">&#34;oplogs&#34;</span>

<span class="c1">// example: argos &#34;mongodb://localhost:27017/argos?replicaSet=replset&#34; students &#39;[{&#34;$match&#34;: {&#34;operationType&#34;: &#34;update&#34;}}]&#39;
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">silent</span><span class="p">(</span><span class="nx">doc</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamClient</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
		<span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="c1">// stream.Watch(client)
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamDatabase</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
		<span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Drop</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamCollection</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamCollectionWithPipeline</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mdb</span><span class="p">.</span><span class="nf">MongoPipeline</span><span class="p">(</span><span class="s">`[{&#34;$match&#34;: {&#34;operationType&#34;: {&#34;$in&#34;: [&#34;update&#34;, &#34;delete&#34;] } }}]`</span><span class="p">)</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// wait for change stream to init
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">doc</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">update</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{ &#34;$set&#34;: {&#34;year&#34;: 1998}}`</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">update</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s">&#34;_id&#34;</span><span class="p">]},</span> <span class="nx">update</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">DeleteMany</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// wait for CS to print messages
</span><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nf">Drop</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>å‚è€ƒ:<br />
<a href="https://blog.csdn.net/sdghchj/article/details/85249392">https://blog.csdn.net/sdghchj/article/details/85249392</a><br />
<a href="https://blog.fudenglong.site/2018/11/17/MongoDB-Go%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%A6%E4%B9%A0/">https://blog.fudenglong.site/2018/11/17/MongoDB-Go%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%A6%E4%B9%A0/</a><br />
<a href="https://blog.csdn.net/henreash/article/details/86745584">https://blog.csdn.net/henreash/article/details/86745584</a>
<a href="https://github.com/simagix/mongo-go-examples/tree/master/examples">https://github.com/simagix/mongo-go-examples/tree/master/examples</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">æ–‡ç« ä½œè€…</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">ä¸Šæ¬¡æ›´æ–°</span>
    <span class="item-content">
        2019-07-16
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/Go/">Go</a>
          <a href="/tags/MongoDB/">MongoDB</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/OLTP%E4%B8%8EOLAP%E7%9A%84%E4%BB%8B%E7%BB%8D/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">OLTPä¸OLAPçš„ä»‹ç»</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/post/types-from-different-packages-%E9%97%AE%E9%A2%98%E6%B5%85%E6%9E%90/">
            <span class="next-text nav-default">types from different packages é—®é¢˜æµ…æ</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="http://localhost:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    ç”± <a class="hexo-link" href="https://gohugo.io">Hugo</a> å¼ºåŠ›é©±åŠ¨
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    ä¸»é¢˜ - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Forz</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
