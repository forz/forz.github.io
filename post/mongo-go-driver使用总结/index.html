<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>mongo-go-driver使用总结 | Forz Blog</title>
<meta name="keywords" content="Go, MongoDB" />
<meta name="description" content="创建main 创建文件main.go并导入bson，mongo和mongo/options包： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main">
<meta name="author" content="">
<link rel="canonical" href="/post/mongo-go-driver%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="mongo-go-driver使用总结" />
<meta property="og:description" content="创建main 创建文件main.go并导入bson，mongo和mongo/options包： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/mongo-go-driver%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-07-16T16:38:41&#43;00:00" />
<meta property="article:modified_time" content="2019-07-16T16:38:41&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="mongo-go-driver使用总结"/>
<meta name="twitter:description" content="创建main 创建文件main.go并导入bson，mongo和mongo/options包： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "mongo-go-driver使用总结",
      "item": "/post/mongo-go-driver%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "mongo-go-driver使用总结",
  "name": "mongo-go-driver使用总结",
  "description": "创建main 创建文件main.go并导入bson，mongo和mongo/options包： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package main",
  "keywords": [
    "Go", "MongoDB"
  ],
  "articleBody": "创建main 创建文件main.go并导入bson，mongo和mongo/options包：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  package main import ( \"context\" \"fmt\" \"log\" \"go.mongodb.org/mongo-driver/bson\" \"go.mongodb.org/mongo-driver/mongo\" \"go.mongodb.org/mongo-driver/mongo/options\" ) // You will be using this Trainer type later in the program type Trainer struct { Name string Age int City string } func main() { // Rest of the code will go here }   此代码还导入一些标准库并定义Trainer类型。您将在本教程的后面部分使用它们。\nGo类型与bson的映射 1 2 3 4 5 6 7 8 9  type Post struct { ID primitive.ObjectID `\"_id\"` Title string `bson:\"title\"` Body string Tags []string `bson:\"tags\"json:\"tags\"` Comments uint64 `bson:\"comments,omitempty\"` CreatedAt time.Time `bson:\"created_at\"` UpdatedAt time.Time `bson:\"updated_at\"` }   有三种规则：\n 什么都不写，就像上面的body一样，这种的话就默认属性名全小写作为key\u0008。 第二种就是像ID一样简写bson映射\u001b。 第三种是像Tags一样完整的写出来，这样的话可以同时做bson和json的映射。  Key规则：\n必须作为第一个参数，但是可以不写。\u0008如果\u001b这个字段不想映射到bson的话，可以这样bson:\"-\"\n其它参数：\n omitempty —— 允许\u001b\u001b值\u001b为空，比如说在ID中使用后，MongoDB会自动为_id生成ObjectId minsize —— 如果在保留数值的情况下可行，将MongoDB大于32位的整数值解析为int32。 truncate —— 如果在损失精度的情况下，将MongoDB的double解析为float32。 inline —— \u0008可以让内联struct和外联效果一样  鉴于我们Post之前定义的结构，让我们创建另一个文档：\n1 2 3 4 5 6 7 8  _, err := col.InsertOne(ctx, \u0026Post{ ID: primitive.NewObjectID(), Title: \"post\", tags: - []string{\"mongodb\"}, Body: `blog post`, CreatedAt: time.Now(), })   我们得到以下内容：\n1 2 3 4 5 6 7 8 9 10 11  { \"_id\" : ObjectId(\"5c71f03ccfee587e4212ad90\"), \"title\" : \"post\", \"body\" : \"blog post\", \"tags\" : [ \"mongodb\" ], \"comments\" : NumberLong(0), \"created_at\" : ISODate(\"2019-02-24T01:15:40.329Z\"), \"updated_at\" : null }   如您所见，驱动程序将创建一个文档，其中包含结构中定义的所有字段，甚至是我们未传递任何值的字段。请记住，您必须使用该primitive.NewObjectID()函数来创建新的ObjectID。它还将保留结构中定义的属性的顺序。\n使用Go驱动程序连接到MongoDB 导入MongoDB Go驱动程序后，您可以使用该mongo.Connect()功能连接到MongoDB部署。您必须将上下文和options.ClientOptions对象传递给mongo.Connect()。客户端选项用于设置连接字符串。它还可用于配置驱动程序设置，如写入问题，套接字超时等。选项包文档提供了有关可用客户机选项的更多信息。\n在main函数中添加以下代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // Set client options clientOptions := options.Client().ApplyURI(\"mongodb://localhost:27017\") // Connect to MongoDB client, err := mongo.Connect(context.TODO(), clientOptions) if err != nil { log.Fatal(err) } // Check the connection err = client.Ping(context.TODO(), nil) if err != nil { log.Fatal(err) } fmt.Println(\"Connected to MongoDB!\")   连接方式还有一种\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  MongoClient, err := mongo.NewClient(\u0026options.ClientOptions{ Auth: \u0026options.Credential{ AuthSource: Authsource, Username: Username, Password: Password, }, Hosts: Hosts, }) if err != nil { log.Fatal(\"MongoDB初始化失败\", err) return } err = MongoClient.Connect(context.TODO()) if err != nil { log.Fatal(err) return }   连接后，您现在可以通过在main函数末尾添加以下代码行来trainers获取test数据库中集合的句柄：\n1  collection := client.Database(\"test\").Collection(\"trainers\")   以下代码将使用此集合句柄来查询trainers集合。\n最佳做法是保持连接到MongoDB的客户端，以便应用程序可以使用连接池 - 您不希望为每个查询打开和关闭连接。但是，如果您的应用程序不再需要连接，则可以使用如下方式关闭连接client.Disconnect()：\n1 2 3 4 5 6  err = client.Disconnect(context.TODO()) if err != nil { log.Fatal(err) } fmt.Println(\"Connection to MongoDB closed.\")   mongodb的连接也可以进行设置\n1 2 3 4 5 6  opt.SetLocalThreshold(3 * time.Second) //只使用与mongo操作耗时小于3秒的 opt.SetMaxConnIdleTime(5 * time.Second) //指定连接可以保持空闲的最大毫秒数 opt.SetMaxPoolSize(200) //使用最大的连接数 opt.SetReadPreference(want) //表示只使用辅助节点 opt.SetReadConcern(readconcern.Majority()) //指定查询应返回实例的最新数据确认为，已入副本集中的大多数成员 opt.SetWriteConcern(wc) //请求确认写操作传播到大多数mongod实例   在Go中使用BSON对象 在我们开始向数据库发送查询之前，了解Go Driver如何与BSON对象一起工作非常重要。MongoDB中的JSON文档存储在名为BSON（二进制编码的JSON）的二进制表示中。与将JSON数据存储为简单字符串和数字的其他数据库不同，BSON编码扩展了JSON表示以包括其他类型，如int，long，date，floating point和decimal128。这使应用程序更容易可靠地处理，排序和比较数据。\nGo Driver有两类用于表示BSON数据的类型:D类型和Raw类型。\nD系列 D系列类型用于使用本地Go类型简洁地构建BSON对象。 这对于构造传递给MongoDB的命令特别有用。\nD系列包括四种类型：\nD D表示BSON文档。此类型可用于以简洁和可读的方式表示BSON\nD通常应在序列化为BSON时使用。对于反序列化，应该使用Raw或D类型。\n用法示例：\n1 2 3 4 5 6  _, err := col.InsertOne(ctx, bson.D{ {\"title\", \"post 2\"}, {\"tags\", []string{\"mongodb\"}}, {\"body\", `blog post 2`}, {\"created_at\", time.Now()}, })   此操作将创建具有有序元素的文档，例如：\n1 2 3 4 5 6 7 8 9  { \"_id\" : ObjectId(\"5c71f03ccfee587e4212ad8f\"), \"title\" : \"post 2\", \"tags\" : [ \"mongodb\" ], \"body\" : \"blog post 2\", \"created_at\" : ISODate(\"2019-02-24T01:15:40.328Z\") }   此类型应在顺序重要的情况下使用，例如MongoDB命令。如果顺序并不重要，map更舒适，更简洁\nE E代表D的BSON元素。它通常用在D中。\nM M是BSON文档的无序，简洁表示。它通常应该用于当BSON文档的元素顺序无关紧要时序列化BSON。如果元素的顺序重要，请改用D代替。\n用法示例：\n1 2 3 4 5 6  _, err := col.InsertOne(ctx, bson.M{ \"title\": \"post\", \"tags\": []string{\"mongodb\"}, \"body\": `blog post`, \"created_at\": time.Now(), })   上面的操作将创建一个包含无序元素的文档，例如：\n1 2 3 4 5 6 7 8 9  { \"_id\" : ObjectId(\"5c71f03ccfee587e4212ad8e\"), \"body\" : \"blog post\", \"created_at\" : ISODate(\"2019-02-24T01:15:40.326Z\"), \"title\" : \"post\", \"tags\" : [ \"mongodb\" ] }   请注意，元素的顺序与提供的顺序不同bson.M。\n此类型在编码器中作为常规map[string]interface{}处理。元素将是以未定义的随机顺序序列化，每次顺序都不同。\nA A表示BSON数组。这种类型可以用来简洁地表示BSON数组.A通常应在序列化为BSON时使用。对于反序列化，应该使用RawArray或Array类型。\n用法示例：\n1  bson.A{\"bar\", \"world\", 3.14159, primitive.D{{\"qux\", 12345}}}   Raw类型 Raw类型用于byte切片。您还可以使用欧路词典从Raw类型中取回单独的元素。如果您不希望花费频繁将BSON解码为另一种类型的开销，这将非常有用。本教程仅使用D系列类型。\n结构体替代bson 除了传入bson,还可以传入带tag的结构体作为bson\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  type BeforeCond struct { Before int64 `bson:\"$lt\"` } type DeleteCond struct { BeforeCond BeforeCond `bson:\"timePoint.startTime\"` } delCond = \u0026DeleteCond{ BeforeCond: BeforeCond{ Before: time.Now().Unix(), }, } type FindByJobName struct { JobName string `bson:\"jobName\"` } cond = \u0026FindByJobName{ JobName: \"hello\", }   bson转结构体 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  //bson转结构体,需要结构体打上bson标签 //a:=bson.M{} //x:=A{} //Bson2Odj(a,\u0026x) func Bson2Odj(val interface{}, obj interface{}) error { //bson转[]byte \tdata, err := bson.Marshal(val) if err != nil { return err } //[]byte转结构体 \terr = bson.Unmarshal(data, obj) if err != nil { return err } return nil }   mongo Shell 转bson shell语句 转 bson 1 2 3 4 5  a:=`$and : [{\"id\" : \"asdfzcv\"}, {\"num\" : 6}]` //bb:=bson.M{\"id\": \"asdfzcv\", \"num\": 6} \tbb:=bson.M{} _=bson.Unmarshal([]byte(a),\u0026bb) //bb=bson.M{\"id\": \"asdfzcv\", \"num\": 6}   1 2  var update bson.M json.Unmarshal([]byte(`{ \"$set\": {\"year\": 1998}}`), \u0026update)   shell语句组 转 []bson 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  toConvert := `[ { \"$project\": { \"_id\": 0, \"A\": \"$$ROOT\" } }, { \"$lookup\": { \"localField\": \"A.TypeId\", \"from\": \"RoleType\", \"foreignField\": \"_id\", \"as\": \"B\" } }, { \"$unwind\": { \"path\": \"$B\", \"preserveNullAndEmptyArrays\": true } }, { \"$project\": { \"A.RoleId\": \"$A.RoleId\", \"A.RoleName\": \"$A.RoleName\", \"A.Valid\": \"$A.Valid\", \"B.TypeName\": \"$B.TypeName\" } } ]` pipeLine := mongo.Pipeline{} err := bson.UnmarshalExtJSON([]byte(toConvert), true, \u0026pipeLine)   CRUD操作 连接到数据库后，就可以开始添加和操作某些数据了。该Collection类型有几种方法，允许您向数据库发送查询。\n插入文件 InsertOne 要插入单个文档，请使用以下collection.InsertOne()方法：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  // create a new context with a 10 second timeout ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second) defer cancel() // insert one document res, err := col.InsertOne(ctx, bson.M{ \"title\": \"Go mongodb driver cookbook\", \"tags\": []string{\"golang\", \"mongodb\"}, \"body\": `this is a long post that goes on and on and have many lines`, \"comments\": 1, \"created_at\": time.Now(), }) if err != nil { log.Fatal(err) } fmt.Printf( \"new post created with id: %s\", res.InsertedID.(primitive.ObjectID).Hex(), ) // = new post created with id: 5c71caf32a346553363177ce   也可以不使用bson.M{}来传递参数,而是使用包含bson标签例如`bson:\"_id\"`的结构体,比如:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  type User struct { ID primitive.ObjectID `bson:\"_id,omitempty\"` Name string `bson:\"dbname\",json:\"jsonname\"` Phone string ASD string } // Insert one result, err := userColl.InsertOne(ctx, User{Name: \"UserName\", Phone:\"1234567890\"}) if err == nil { log.Println(result.InsertedID) } else { log.Fatal(err) } // Insert many { users := []interface{}{ User{Name: \"UserName_0\", Phone: \"123\"}, User{Name: \"UserName_1\", Phone: \"456\"}, User{Name: \"UserName_2\", Phone: \"789\"}, } if result, err := userColl.InsertMany(ctx, users); err == nil { log.Println(result) } else { log.Fatal(err) } }   InsertMany 要一次插入多个文档，该collection.InsertMany()方法将采用一些对象：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  res, err := col.InsertMany(ctx, []interface{}{ bson.M{ \"title\": \"Post one\", \"tags\": []string{\"golang\"}, \"body\": \"post one body\", \"comments\": 14, \"created_at\": time.Date(2019, time.January, 10, 15, 30, 0, 0, time.UTC), }, bson.M{ \"title\": \"Post two\", \"tags\": []string{\"nodejs\"}, \"body\": \"post two body\", \"comments\": 2, \"created_at\": time.Now(), }, }) if err != nil { log.Fatal(err) } fmt.Printf(\"inserted ids: %v\\n\", res.InsertedIDs) // = inserted ids: [ObjectID(\"5c71ce5c6e6d43eb6e2e93be\") ObjectID(\"5c71ce5c6e6d43eb6e2e93bf\")]   更新文件 update UpdateOne 该collection.UpdateOne()方法允许您更新单个文档。它需要一个过滤器文档来匹配数据库中的文档和一个更新文档来描述更新操作。update需要传入bson命令\n您可以使用以下bson.D类型构建这些：\n这里我们还从其十六进制字符串表示中创建一个新的ObjectID：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  // create ObjectID from string id, err := primitive.ObjectIDFromHex(\"5c71ce5c6e6d43eb6e2e93be\") if err != nil { log.Fatal(err) } // set filters and updates filter := bson.M{\"_id\": id} update := bson.M{\"$set\": bson.M{\"title\": \"post 2 (two)\"}} // update document res, err := col.UpdateOne(ctx, filter, update) if err != nil { log.Fatal(err) } fmt.Printf(\"modified count: %d\\n\", res.ModifiedCount) // = modified count: 1   UpdateMany 要更新多个文档（相当于{multi: true}），请使用collection.UpdateMany()\n1 2 3 4 5 6 7 8 9 10 11  // set filters and updates filter := bson.M{\"tags\": bson.M{\"$elemMatch\": bson.M{\"$eq\": \"golang\"}}} update := bson.M{\"$set\": bson.M{\"comments\": 0, \"updated_at\": time.Now()}} // update documents res, err := col.UpdateMany(ctx, filter, update) if err != nil { log.Fatal(err) } fmt.Printf(\"modified count: %d\\n\", res.ModifiedCount) // = modified count: 17   upsert 对于两者而言UpdateOne，UpdateMany您可以通过将适当的选项传递给函数来使其成为upsert操作：\n1 2 3 4 5 6 7  res, err := col.UpdateOne( ctx, filter, update, options.Update().SetUpsert(true) ) res, err := col.UpdateMany( ctx, filter, update, options.Update().SetUpsert(true) )   replace replaceone Update是用来直接修改数据库的，ReplaceOne则是整个替换。 可以用bson传入要替换的值\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  var err error var client *mongo.Client var collection *mongo.Collection var ctx = context.Background() var doc = bson.M{\"_id\": primitive.NewObjectID(), \"hometown\": \"Atlanta\"} var result *mongo.UpdateResult client = getMongoClient() defer client.Disconnect(ctx) collection = client.Database(dbName).Collection(collectionExamples) if _, err = collection.InsertOne(ctx, doc); err != nil { t.Fatal(err) } doc[\"year\"] = 1998 if result, err = collection.ReplaceOne(ctx, bson.M{\"_id\": doc[\"_id\"]}, doc); err != nil { t.Fatal(err) }   replacement也可以直接传入结构体进行更新\n1 2 3 4 5 6 7 8 9  // Replace one { user := User{Name: \"UserName_2_replaced\", Phone: \"789\"} if result, err := userColl.ReplaceOne(ctx, bson.M{\"phone\": \"789\"}, user); err == nil { log.Println(result) } else { log.Fatal(err) } }   resert 也可以通过将适当的选项传递给函数来使replace其成为upsert操作：\n1 2 3 4 5 6 7  res, err := col.ReplaceOne( ctx, filter, update, options.Replace().SetUpsert(true) ) res, err := col.ReplaceMany( ctx, filter, update, options.Replace().SetUpsert(true)v )   查询与删改换结合 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  //查询单条数据后删除该数据 if err = collection.FindOneAndDelete(getContext(), bson.D{{\"name\", \"howie_3\"}}).Decode(\u0026howie); err != nil { checkErr(err) } fmt.Printf(\"FindOneAndDelete查询到的数据:%v\\n\", howie) //查询单条数据后修改该数据 if err = collection.FindOneAndUpdate(getContext(), bson.D{{\"name\", \"howie_4\"}},bson.M{\"$set\": bson.M{\"name\": \"这条数据我需要修改了\"}}).Decode(\u0026howie); err != nil{ checkErr(err) } fmt.Printf(\"FindOneAndUpdate查询到的数据:%v\\n\", howie) //查询单条数据后替换该数据(以前的数据全部清空) if err = collection.FindOneAndReplace(getContext(), bson.D{{\"name\", \"howie_5\"}} bson.M{\"hero\": \"这条数据我替换了\"}).Decode(\u0026howie); err != nil { checkErr(err) }   查找文件 FindOne 要查找文档，您需要一个过滤器文档以及一个指向可以解码结果的值的指针。要查找单个文档，请使用collection.FindOne()。此方法返回单个结果，可将其解码为值。您将使用filter在更新查询中使用的相同变量来匹配名称为Ash的文档。\n1 2 3 4 5 6 7 8 9  // create a value into which the result can be decoded var result Trainer err = collection.FindOne(context.TODO(), filter).Decode(\u0026result) if err != nil { log.Fatal(err) } fmt.Printf(\"Found a single document: %+v\\n\", result)   Decode()函数也可以传参bson\n1 2 3  var result bson.M err := table.FindOne(ctx, filter).Decode(\u0026result)   Find 要查找多个文档，请使用collection.Find()。这个方法返回一个Cursor。A Cursor提供了一个文档流，您可以通过它们一次迭代和解码一个文档。一旦Cursor用尽，你应该关闭Cursor。在这里，您还将使用options包设置一些操作选项。具体来说，您将设置限制，因此只返回2个文档。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  // Pass these options to the Find method findOptions := options.Find() findOptions.SetLimit(2) // Here's an array in which you can store the decoded documents var results []*Trainer // Passing bson.D{{}} as the filter matches all documents in the collection cur, err := collection.Find(context.TODO(), bson.D{{}}, findOptions) if err != nil { log.Fatal(err) } // Finding multiple documents returns a cursor // Iterating through the cursor allows us to decode documents one at a time for cur.Next(context.TODO()) { // create a value into which the single document can be decoded  var elem Trainer err := cur.Decode(\u0026elem) if err != nil { log.Fatal(err) } results = append(results, \u0026elem) } if err := cur.Err(); err != nil { log.Fatal(err) } // Close the cursor once finished cur.Close(context.TODO()) fmt.Printf(\"Found multiple documents (array of pointers): %+v\\n\", results)   Find也可以返回bson,如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  func (o *MongoUtils) FindMore(col string, filter bson.M) ([]bson.M, error){ if o.Db == nil || o.Con == nil{ return nil, fmt.Errorf(\"没有初始化连接和数据库信息！\") } table := o.Db.Collection(col) ctx,_ := context.WithTimeout(context.Background(), 5*time.Second) ctx, _ = context.WithTimeout(context.Background(), 5*time.Second) cur, err2 := table.Find(ctx, filter) if err2 != nil { fmt.Print(err2) return nil, err2 } defer cur.Close(ctx) var resultArr []bson.M for cur.Next(ctx){ var result bson.M err3 := cur.Decode(\u0026result) if err3 != nil { return nil, err3 } resultArr = append(resultArr, result) } return resultArr, nil }   有序find 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  //一次查询多条数据 // 查询createtime=3 // 限制取2条 // createtime从大到小排序的数据 if cursor, err = collection.Find(getContext(), bson.M{\"createtime\": bson.M{\"$gte\": 2}}, options.Find().SetLimit(2), options.Find().SetSort(bson.M{\"createtime\": -1})); err!= nil { checkErr(err) } //多个options.Find()可以用链式表达,比如: //findOptions := options.Find().SetSort(SORT).SetLimit(Limit).SetSkip(Skip) //按选项查询集合 Skip 跳过 Limit 读取数量 sort  if err = cursor.Err(); err != nil { checkErr(err) } defer cursor.Close(context.Background()) for cursor.Next(context.Background()) { if err = cursor.Decode(\u0026howie); err != nil { checkErr(err) } howieArrayEmpty = append(howieArrayEmpty, howie) } for _, v := range howieArrayEmpty { fmt.Printf(\"Find查询到的数据ObejectId值%s 值:%v\\n\", v.HowieId.Hex(), v) }   distinct 1 2 3 4 5 6 7  //返回满足filter条件下的所有fieldName值,[]interface{}类型 //res, err := mymongo.Distinct(\"test\", \"id\", bson.M{}) \tcollection := db.Collection(collectionName) res, err = collection.Distinct(getContext(), fieldName, filter, opts...) return }   根据_id查找文件 mongodb里面\"_id\"不是字符串,只是方便显示,在可视化界面中展示为字符串,如\"5d36fc03d3a200b7aeecaeac\"\n如果要在golang中通过_id查找文件,需要先将字符串转化为primitive.ObjectID,然后再查找\n1 2  ID, _ := primitive.ObjectIDFromHex(stringID) err := collection.Find(getContext(),bson.M{\"_id\": ID})   删除文件 DeleteOne 要删除文档，请使用collection.DeleteOne()：\n1 2 3 4 5 6 7 8 9 10 11 12  // create ObjectID from string id, err := primitive.ObjectIDFromHex(\"5c71ce5c6e6d43eb6e2e93be\") if err != nil { log.Fatal(err) } // delete document res, err := col.DeleteOne(ctx, bson.M{\"_id\": id}) if err != nil { log.Fatal(err) } fmt.Printf(\"deleted count: %d\\n\", res.DeletedCount)   DeleteMany 最后，您可以使用collection.DeleteOne()或删除文档collection.DeleteMany()。在这里，您将传递bson.D{{}}过滤器参数，该参数将匹配集合中的所有文档。您还可以使用collection.Drop()删除整个集合。\n1 2 3 4 5  deleteResult, err := collection.DeleteMany(context.TODO(), bson.D{{}}) if err != nil { log.Fatal(err) } fmt.Printf(\"Deleted %v documents in the trainers collection\\n\", deleteResult.DeletedCount)   bulkWrite 有时您想要执行许多操作，例如一次插入，更新和删除所有操作。在这种情况下，MongoDB提供了非常有用的批量写入API，它采用一系列写入操作并执行每个操作。默认情况下，操作按顺序执行。这是一个例子：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64  // list of inserts inserts := []bson.M{ { \"title\": \"post five\", \"tags\": []string{\"postgresql\"}, \"created_at\": time.Now(), }, { \"title\": \"post six\", \"tags\": []string{\"graphql\"}, \"created_at\": time.Now(), }, } // list of updates updates := []struct { filter bson.M updates bson.M }{ { filter: bson.M{ \"tags\": bson.M{\"$elemMatch\": bson.M{\"$eq\": \"golang\"}}, }, updates: bson.M{\"$set\": bson.M{\"updated_at\": time.Now()}}, }, } // list of deletes deletes := []bson.M{ {\"_id\": id1}, {\"_id\": id2}, {\"_id\": id3}, } // create the slice of write models var writes []mongo.WriteModel // range over each list of operations and create the write model for _, ins := range inserts { model := mongo.NewInsertOneModel().SetDocument(ins) writes = append(writes, model) } for _, upd := range updates { model := mongo.NewUpdateManyModel(). SetFilter(upd.filter).SetUpdate(upd.updates) writes = append(writes, model) } for _, del := range deletes { model := mongo.NewDeleteManyModel().SetFilter(del) writes = append(writes, model) } // run bulk write res, err := col.BulkWrite(ctx, writes) if err != nil { log.Fatal(err) } fmt.Printf( \"insert: %d, updated: %d, deleted: %d\", res.InsertedCount, res.ModifiedCount, res.DeletedCount, ) // = insert: 2, updated: 10, deleted: 3   聚合查询 count 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  //查询集合里面有多少数据 \tif size, err = collection.CountDocuments(getContext(), bson.D{}); err != nil { checkErr(err) } fmt.Printf(\"Count里面有多少条数据:%d\\n\", size) //查询集合里面有多少数据(查询createtime=3的数据) \tif size, err = collection.CountDocuments(getContext(), bson.M{\"createtime\": bson.M{\"$gte\": 3}}); err != nil { checkErr(err) } fmt.Printf(\"Count里面有多少条数据:%d\\n\", size) func checkErr(err error) { if err != nil { if err == mongo.ErrNoDocuments { fmt.Println(\"没有查到数据\") os.Exit(0) } else { fmt.Println(err) os.Exit(0) } } }   EstimatedDocumentCount 估计集合内有多少数据\n1  num, err := collection.EstimatedDocumentCount(getContext(), opts...)   aggregate 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106  func TestAggregateJSON(t *testing.T) { var err error var client *mongo.Client var collection *mongo.Collection var cur *mongo.Cursor var ctx = context.Background() client = getMongoClient() defer client.Disconnect(ctx) seedCarsData(client, dbName) pipeline := `[ {\"$match\": { \"color\": \"Red\" }}, {\"$group\": { \"_id\": \"$brand\", \"count\": { \"$sum\": 1 } }}, {\"$project\": { \"brand\": \"$_id\", \"_id\": 0, \"count\": 1 }} ]` collection = client.Database(dbName).Collection(collectionName) var brands []interface{} if brands, err = collection.Distinct(ctx, \"brand\", bson.D{{Key: \"color\", Value: \"Red\"}}); err != nil { t.Fatal(err) } opts := options.Aggregate() opts.SetAllowDiskUse(true) opts.SetBatchSize(5) pipeLine := mongo.Pipeline{} err := bson.UnmarshalExtJSON([]byte(pipeline), true, \u0026pipeLine) if cur, err = collection.Aggregate(ctx, pipeLine, opts); err != nil { t.Fatal(err) } defer cur.Close(ctx) total := 0 for cur.Next(ctx) { total++ } if total == 0 || total != len(brands) { t.Fatal(\"expected\", len(brands), \"but got\", total) } } func TestAggregatePipeline(t *testing.T) { var err error var client *mongo.Client var collection *mongo.Collection var cur *mongo.Cursor var ctx = context.Background() client = getMongoClient() seedCarsData(client, dbName) // this cause warning from go vet \t// pipeline := mongo.Pipeline{ \t// {{\"$match\", bson.D{{\"color\", \"Red\"}}}}, \t// {{\"$group\", bson.D{{\"_id\", \"$brand\"}, {\"count\", bson.D{{\"$sum\", 1}}}}}}, \t// {{\"$project\", bson.D{{\"brand\", \"$_id\"}, {\"_id\", 0}, {\"count\", 1}}}}, \t// } \tpipeline := mongo.Pipeline{ {{Key: \"$match\", Value: bson.D{{Key: \"color\", Value: \"Red\"}}}}, {{Key: \"$group\", Value: bson.D{{Key: \"_id\", Value: \"$brand\"}, {Key: \"count\", Value: bson.D{{Key: \"$sum\", Value: 1}}}}}}, {{Key: \"$project\", Value: bson.D{{Key: \"brand\", Value: \"$_id\"}, {Key: \"_id\", Value: 0}, {Key: \"count\", Value: 1}}}}, } collection = client.Database(dbName).Collection(collectionName) var brands []interface{} if brands, err = collection.Distinct(ctx, \"brand\", bson.D{{Key: \"color\", Value: \"Red\"}}); err != nil { t.Fatal(err) } opts := options.Aggregate() opts.SetAllowDiskUse(true) opts.SetBatchSize(5) if cur, err = collection.Aggregate(ctx, pipeline, opts); err != nil { t.Fatal(err) } defer cur.Close(ctx) total := 0 for cur.Next(ctx) { total++ } if total == 0 || total != len(brands) { t.Fatal(\"expected\", len(brands), \"but got\", total) } } func TestAggregateBSOND(t *testing.T) { var err error var client *mongo.Client var collection *mongo.Collection var cur *mongo.Cursor var ctx = context.Background() size := 10 client = getMongoClient() seedCarsData(client, dbName) pipeline := []bson.D{bson.D{{\"$sample\", bson.D{{\"size\", size}}}}} collection = client.Database(dbName).Collection(collectionName) opts := options.Aggregate() if cur, err = collection.Aggregate(ctx, pipeline, opts); err != nil { t.Fatal(err) } defer cur.Close(ctx) total := 0 for cur.Next(ctx) { total++ } if total == 0 { t.Fatal(\"expected \", size, \"but got\", total) } }   事务机制 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  // WithSession允许用户自己启动会话并进行管理 //它的一生为CRUD方法提供会话的唯一方法是 //使用mongo.SessionContext调用该CRUD方法 //关闭mongo.SessionContext可以用作常规上下文， //所以像context.WithDeadline和context.WithTimeout这样的方法是 // 支持的。 // //如果context.Context已经附加了mongo.Session，那就是 // mongo.Session将替换为提供的。 // //从闭包中返回的错误是透明地返回的 //这个功能 func WithSession（ctx context.Context，sess Session，fn func（SessionContext）error）error { return fn（contextWithSession（ctx，sess）） } // UseSession创建一个默认会话，该会话仅对 //关闭的生命周期关闭会话之外没有清理 //在退出封闭时完成。这意味着一个出色的 //即使闭包返回错误，也会中止事务。 // //如果ctx已经包含mongo.Session，那mongo.Session将是 //替换为新创建的mongo.Session。 // //从闭包中返回的错误是透明地返回的 //这个方法 func（c * Client）UseSession（ctx context.Context，fn func（SessionContext）error）error { return c.UseSessionWithOptions（ctx，options.Session（），fn） }   WithSession 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40  { var err error var client *mongo.Client var collection *mongo.Collection var ctx = context.Background() var id = primitive.NewObjectID() var doc = bson.M{\"_id\": id, \"hometown\": \"Atlanta\", \"year\": int32(1998)} var result *mongo.UpdateResult var session mongo.Session var update = bson.D{{Key: \"$set\", Value: bson.D{{Key: \"year\", Value: int32(2000)}}}} client = getMongoClient() defer client.Disconnect(ctx) if session, err = client.StartSession(); err != nil { t.Fatal(err) } if err = session.StartTransaction(); err != nil { t.Fatal(err) } if err = mongo.WithSession(ctx, session, func(sc mongo.SessionContext) error { if result, err = collection.UpdateOne(sc, bson.M{\"_id\": id}, update); err != nil { t.Fatal(err) } if result.MatchedCount != 1 || result.ModifiedCount != 1 { t.Fatal(\"replace failed, expected 1 but got\", result.MatchedCount) } //提交 \tif err = session.CommitTransaction(sc); err != nil { t.Fatal(err) } //放弃 \tif err = session.AbortTransaction(sc); err != nil { t.Fatal(err) } return nil }); err != nil { t.Fatal(err) } session.EndSession(ctx) }   UseSession 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95  import ( \"context\" \"github.com/mongodb/mongo-go-driver/mongo\" \"net/url\" \"fmt\" ) func main(){ connectString := \"mongodb://127.0.0.1/test\" dbUrl, err := url.Parse(connectString) if err != nil { panic(err) } //认证参数设置，否则连不上 \topts := \u0026options.ClientOptions{} opts.SetAuth(options.Credential{ AuthMechanism:\"SCRAM-SHA-1\", AuthSource:\"test\", Username:\"test\", Password:\"123456\"}) client, err = mongo.Connect(context.Background(), connectString，opts) if err != nil { panic(err) } db := client.Database(dbUrl.Path[1:]) ctx := context.Background() defer db.Client().Disconnect(ctx) col := db.Collection(\"test\") //先在事务外写一条id为“111”的记录  _,err = col.InsertOne(ctx, bson.M{\"_id\": \"111\", \"name\": \"ddd\", \"age\": 50}) if(err != nil){ fmt.Println(err) return } //第一个事务：成功执行  db.Client().UseSession(ctx, func(sessionContext mongo.SessionContext) error { err = sessionContext.StartTransaction() if(err != nil){ fmt.Println(err) return err } //在事务内写一条id为“222”的记录  _, err = col.InsertOne(sessionContext, bson.M{\"_id\": \"222\", \"name\": \"ddd\", \"age\": 50}) if(err != nil){ fmt.Println(err) return err } //在事务内写一条id为“333”的记录  _, err = col.InsertOne(sessionContext, bson.M{\"_id\": \"333\", \"name\": \"ddd\", \"age\": 50}) if err != nil { sessionContext.AbortTransaction(sessionContext) return err }else { sessionContext.CommitTransaction(sessionContext) } return nil }) //第二个事务：执行失败，事务没提交，因最后插入了一条重复id \"111\",  err = db.Client().UseSession(ctx, func(sessionContext mongo.SessionContext) error { err := sessionContext.StartTransaction() if(err != nil){ fmt.Println(err) return err } //在事务内写一条id为“222”的记录  _, err = col.InsertOne(sessionContext, bson.M{\"_id\": \"444\", \"name\": \"ddd\", \"age\": 50}) if(err != nil){ fmt.Println(err) return err } //写重复id  _, err = col.InsertOne(sessionContext, bson.M{\"_id\": \"111\", \"name\": \"ddd\", \"age\": 50}) if err != nil { sessionContext.AbortTransaction(sessionContext) return err }else { sessionContext.CommitTransaction(sessionContext) } return nil }) } //最终数据只有 \"111\",\"222\",\"333\" 三条，事务测试成功。   RunCommand 1 2 3 4 5 6 7 8 9 10 11  { var err error var client *mongo.Client var result bson.M client = getMongoClient() defer client.Disconnect(context.Background()) command := bson.D{{Key: \"isMaster\", Value: 1}} if err = client.Database(\"admin\").RunCommand(context.Background(), command).Decode(\u0026result); err != nil { t.Fatal(err) } }   gridfs 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  var err error var client *mongo.Client var bucket *gridfs.Bucket var ustream *gridfs.UploadStream str := \"This is a test file\" client = getMongoClient() defer client.Disconnect(context.Background()) if bucket, err = gridfs.NewBucket(client.Database(dbName), options.GridFSBucket().SetName(\"myFiles\")); err != nil { t.Fatal(err) } opts := options.GridFSUpload() opts.SetMetadata(bsonx.Doc{{Key: \"content-type\", Value: bsonx.String(\"application/json\")}}) if ustream, err = bucket.OpenUploadStream(\"test.txt\", opts); err != nil { t.Fatal(err) } if _, err = ustream.Write([]byte(str)); err != nil { t.Fatal(err) } fileID := ustream.FileID ustream.Close() var b bytes.Buffer w := bufio.NewWriter(\u0026b) if _, err = bucket.DownloadToStream(fileID, w); err != nil { t.Fatal(err, ustream.FileID) } if b.String() != str { t.Fatal(\"expected\", str, \"but got\", b.String()) }   change stream change_stream.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83  // Copyright 2018 Kuei-chun Chen. All rights reserved.  package examples import ( \"context\" \"fmt\" \"log\" \"go.mongodb.org/mongo-driver/bson\" \"go.mongodb.org/mongo-driver/mongo\" \"go.mongodb.org/mongo-driver/mongo/options\" ) // ChangeStream defines what to watch? client, database or collection type ChangeStream struct { collection string database string pipeline []bson.D } type callback func(bson.M) // SetCollection sets collection func (cs *ChangeStream) SetCollection(collection string) { cs.collection = collection } // SetDatabase sets database func (cs *ChangeStream) SetDatabase(database string) { cs.database = database } // SetPipeline sets pipeline func (cs *ChangeStream) SetPipeline(pipeline []bson.D) { cs.pipeline = pipeline } // NewChangeStream gets a new ChangeStream func NewChangeStream() *ChangeStream { return \u0026ChangeStream{} } // Watch prints oplogs in JSON format func (cs *ChangeStream) Watch(client *mongo.Client, cb callback) { var err error var ctx = context.Background() var cur *mongo.ChangeStream fmt.Println(\"pipeline\", cs.pipeline) opts := options.ChangeStream() opts.SetFullDocument(\"updateLookup\") if cs.collection != \"\" \u0026\u0026 cs.database != \"\" { fmt.Println(\"Watching\", cs.database+\".\"+cs.collection) var coll = client.Database(cs.database).Collection(cs.collection) if cur, err = coll.Watch(ctx, cs.pipeline, opts); err != nil { panic(err) } } else if cs.database != \"\" { fmt.Println(\"Watching\", cs.database) var db = client.Database(cs.database) if cur, err = db.Watch(ctx, cs.pipeline, opts); err != nil { panic(err) } } else { fmt.Println(\"Watching all\") if cur, err = client.Watch(ctx, cs.pipeline, opts); err != nil { panic(err) } } defer cur.Close(ctx) var doc bson.M for cur.Next(ctx) { if err = cur.Decode(\u0026doc); err != nil { log.Fatal(err) } cb(doc) } if err = cur.Err(); err != nil { log.Fatal(err) } }   change_stream_test.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151  // Copyright 2018 Kuei-chun Chen. All rights reserved.  package examples import ( \"context\" \"encoding/json\" \"os\" \"testing\" \"time\" \"github.com/simagix/keyhole/mdb\" \"go.mongodb.org/mongo-driver/bson\" \"go.mongodb.org/mongo-driver/bson/primitive\" \"go.mongodb.org/mongo-driver/mongo\" \"go.mongodb.org/mongo-driver/x/network/connstring\" ) var collection = \"oplogs\" // example: argos \"mongodb://localhost:27017/argos?replicaSet=replset\" students '[{\"$match\": {\"operationType\": \"update\"}}]' func silent(doc bson.M) { } func TestChangeStreamClient(t *testing.T) { var err error var client *mongo.Client var cs connstring.ConnString var ctx = context.Background() var uri = \"mongodb://localhost:27017/argos?replicaSet=replset\" if os.Getenv(\"DATABASE_URL\") != \"\" { uri = os.Getenv(\"DATABASE_URL\") } if cs, err = connstring.Parse(uri); err != nil { t.Fatal(err) } client = getMongoClient() defer client.Disconnect(ctx) var pipeline []bson.D pipeline = mongo.Pipeline{} c := client.Database(cs.Database).Collection(collection) c.InsertOne(ctx, bson.M{\"city\": \"Atlanta\"}) go func(c *mongo.Collection) { execute(c) client.Disconnect(context.Background()) }(c) stream := NewChangeStream() stream.SetPipeline(pipeline) // stream.Watch(client) } func TestChangeStreamDatabase(t *testing.T) { var err error var client *mongo.Client var cs connstring.ConnString var ctx = context.Background() var uri = \"mongodb://localhost:27017/argos?replicaSet=replset\" if os.Getenv(\"DATABASE_URL\") != \"\" { uri = os.Getenv(\"DATABASE_URL\") } if cs, err = connstring.Parse(uri); err != nil { t.Fatal(err) } client = getMongoClient() var pipeline []bson.D pipeline = mongo.Pipeline{} c := client.Database(cs.Database).Collection(collection) c.InsertOne(ctx, bson.M{\"city\": \"Atlanta\"}) go func(c *mongo.Collection) { execute(c) client.Database(cs.Database).Drop(context.Background()) }(c) stream := NewChangeStream() stream.SetDatabase(cs.Database) stream.SetPipeline(pipeline) stream.Watch(client, silent) } func TestChangeStreamCollection(t *testing.T) { var err error var client *mongo.Client var cs connstring.ConnString var ctx = context.Background() var uri = \"mongodb://localhost:27017/argos?replicaSet=replset\" if os.Getenv(\"DATABASE_URL\") != \"\" { uri = os.Getenv(\"DATABASE_URL\") } if cs, err = connstring.Parse(uri); err != nil { t.Fatal(err) } client = getMongoClient() var pipeline []bson.D pipeline = mongo.Pipeline{} c := client.Database(cs.Database).Collection(collection) c.InsertOne(ctx, bson.M{\"city\": \"Atlanta\"}) go func(c *mongo.Collection) { execute(c) }(c) stream := NewChangeStream() stream.SetCollection(collection) stream.SetDatabase(cs.Database) stream.SetPipeline(pipeline) stream.Watch(client, silent) } func TestChangeStreamCollectionWithPipeline(t *testing.T) { var err error var client *mongo.Client var cs connstring.ConnString var ctx = context.Background() var uri = \"mongodb://localhost:27017/argos?replicaSet=replset\" if os.Getenv(\"DATABASE_URL\") != \"\" { uri = os.Getenv(\"DATABASE_URL\") } if cs, err = connstring.Parse(uri); err != nil { t.Fatal(err) } client = getMongoClient() var pipeline = mdb.MongoPipeline(`[{\"$match\": {\"operationType\": {\"$in\": [\"update\", \"delete\"] } }}]`) c := client.Database(cs.Database).Collection(collection) c.InsertOne(ctx, bson.M{\"city\": \"Atlanta\"}) go func(c *mongo.Collection) { execute(c) }(c) stream := NewChangeStream() stream.SetCollection(collection) stream.SetDatabase(cs.Database) stream.SetPipeline(pipeline) stream.Watch(client, silent) } func execute(c *mongo.Collection) { time.Sleep(2 * time.Second) // wait for change stream to init \tvar doc = bson.M{\"_id\": primitive.NewObjectID(), \"hometown\": \"Atlanta\"} c.InsertOne(context.Background(), doc) var update bson.M json.Unmarshal([]byte(`{ \"$set\": {\"year\": 1998}}`), \u0026update) c.UpdateOne(context.Background(), bson.M{\"_id\": doc[\"_id\"]}, update) c.DeleteMany(context.Background(), bson.M{\"hometown\": \"Atlanta\"}) time.Sleep(1 * time.Second) // wait for CS to print messages \tc.Drop(context.Background()) }   参考:\nhttps://blog.csdn.net/sdghchj/article/details/85249392\nhttps://blog.fudenglong.site/2018/11/17/MongoDB-Go%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%A6%E4%B9%A0/\nhttps://blog.csdn.net/henreash/article/details/86745584 https://github.com/simagix/mongo-go-examples/tree/master/examples\n",
  "wordCount" : "9028",
  "inLanguage": "zh-cn",
  "datePublished": "2019-07-16T16:38:41Z",
  "dateModified": "2019-07-16T16:38:41Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/mongo-go-driver%E4%BD%BF%E7%94%A8%E6%80%BB%E7%BB%93/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      mongo-go-driver使用总结
    </h1>
    <div class="post-meta">July 16, 2019
</div>
  </header> 
  <div class="post-content"><h1 id="创建main">创建main<a hidden class="anchor" aria-hidden="true" href="#创建main">#</a></h1>
<p>创建文件main.go并导入bson，mongo和mongo/options包：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;log&#34;</span>

    <span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
    <span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
    <span class="s">&#34;go.mongodb.org/mongo-driver/mongo/options&#34;</span>
<span class="p">)</span>

<span class="c1">// You will be using this Trainer type later in the program
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Trainer</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span>
    <span class="nx">Age</span>  <span class="kt">int</span>
    <span class="nx">City</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Rest of the code will go here
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>此代码还导入一些标准库并定义Trainer类型。您将在本教程的后面部分使用它们。</p>
<h1 id="go类型与bson的映射">Go类型与bson的映射<a hidden class="anchor" aria-hidden="true" href="#go类型与bson的映射">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Post</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span>        <span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span> <span class="s">`&#34;_id&#34;`</span>
    <span class="nx">Title</span>     <span class="kt">string</span>             <span class="s">`bson:&#34;title&#34;`</span>
    <span class="nx">Body</span>      <span class="kt">string</span>             
    <span class="nx">Tags</span>      <span class="p">[]</span><span class="kt">string</span>           <span class="s">`bson:&#34;tags&#34;json:&#34;tags&#34;`</span>
    <span class="nx">Comments</span>  <span class="kt">uint64</span>             <span class="s">`bson:&#34;comments,omitempty&#34;`</span>
    <span class="nx">CreatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>          <span class="s">`bson:&#34;created_at&#34;`</span>
    <span class="nx">UpdatedAt</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>          <span class="s">`bson:&#34;updated_at&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>有三种规则：</p>
<ol>
<li>什么都不写，就像上面的body一样，这种的话就默认属性名全小写作为key。</li>
<li>第二种就是像ID一样简写bson映射。</li>
<li>第三种是像Tags一样完整的写出来，这样的话可以同时做bson和json的映射。</li>
</ol>
<p>Key规则：</p>
<p>必须作为第一个参数，但是可以不写。如果这个字段不想映射到bson的话，可以这样<code>bson:&quot;-&quot;</code></p>
<p>其它参数：</p>
<ul>
<li>omitempty —— 允许值为空，比如说在ID中使用后，MongoDB会自动为_id生成ObjectId</li>
<li>minsize —— 如果在保留数值的情况下可行，将MongoDB大于32位的整数值解析为int32。</li>
<li>truncate —— 如果在损失精度的情况下，将MongoDB的double解析为float32。</li>
<li>inline —— 可以让内联struct和外联效果一样</li>
</ul>
<p>鉴于我们Post之前定义的结构，让我们创建另一个文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Post</span><span class="p">{</span>
    <span class="nx">ID</span><span class="p">:</span>        <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span>
    <span class="nx">Title</span><span class="p">:</span>     <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="nx">tags</span><span class="p">:</span> 
<span class="o">-</span>    <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
    <span class="nx">Body</span><span class="p">:</span>      <span class="s">`blog post`</span><span class="p">,</span>
    <span class="nx">CreatedAt</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>我们得到以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="err">ObjectId(</span><span class="s2">&#34;5c71f03ccfee587e4212ad90&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;title&#34;</span> <span class="p">:</span> <span class="s2">&#34;post&#34;</span><span class="p">,</span>
    <span class="nt">&#34;body&#34;</span> <span class="p">:</span> <span class="s2">&#34;blog post&#34;</span><span class="p">,</span>
    <span class="nt">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s2">&#34;mongodb&#34;</span>
    <span class="p">],</span>
    <span class="nt">&#34;comments&#34;</span> <span class="p">:</span> <span class="err">NumberLong(</span><span class="mi">0</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;created_at&#34;</span> <span class="p">:</span> <span class="err">ISODate(</span><span class="s2">&#34;2019-02-24T01:15:40.329Z&#34;</span><span class="err">)</span><span class="p">,</span>
    <span class="nt">&#34;updated_at&#34;</span> <span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如您所见，驱动程序将创建一个文档，其中包含结构中定义的所有字段，甚至是我们未传递任何值的字段。请记住，您必须使用该primitive.NewObjectID()函数来创建新的ObjectID。它还将保留结构中定义的属性的顺序。</p>
<h1 id="使用go驱动程序连接到mongodb">使用Go驱动程序连接到MongoDB<a hidden class="anchor" aria-hidden="true" href="#使用go驱动程序连接到mongodb">#</a></h1>
<p>导入MongoDB Go驱动程序后，您可以使用该mongo.Connect()功能连接到MongoDB部署。您必须将上下文和options.ClientOptions对象传递给mongo.Connect()。客户端选项用于设置连接字符串。它还可用于配置驱动程序设置，如写入问题，套接字超时等。选项包文档提供了有关可用客户机选项的更多信息。</p>
<p>在main函数中添加以下代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Set client options
</span><span class="c1"></span><span class="nx">clientOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">ApplyURI</span><span class="p">(</span><span class="s">&#34;mongodb://localhost:27017&#34;</span><span class="p">)</span>

<span class="c1">// Connect to MongoDB
</span><span class="c1"></span><span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">clientOptions</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Check the connection
</span><span class="c1"></span><span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Ping</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="kc">nil</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connected to MongoDB!&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>连接方式还有一种</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">MongoClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">{</span>
	<span class="nx">Auth</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">Credential</span><span class="p">{</span>
		<span class="nx">AuthSource</span><span class="p">:</span> <span class="nx">Authsource</span><span class="p">,</span>
		<span class="nx">Username</span><span class="p">:</span>   <span class="nx">Username</span><span class="p">,</span>
		<span class="nx">Password</span><span class="p">:</span>   <span class="nx">Password</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="nx">Hosts</span><span class="p">:</span> <span class="nx">Hosts</span><span class="p">,</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;MongoDB初始化失败&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">MongoClient</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>连接后，您现在可以通过在main函数末尾添加以下代码行来trainers获取test数据库中集合的句柄：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">collection</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="s">&#34;trainers&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>以下代码将使用此集合句柄来查询trainers集合。</p>
<p>最佳做法是保持连接到MongoDB的客户端，以便应用程序可以使用连接池 - 您不希望为每个查询打开和关闭连接。但是，如果您的应用程序不再需要连接，则可以使用如下方式关闭连接client.Disconnect()：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Connection to MongoDB closed.&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>mongodb的连接也可以进行设置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">opt</span><span class="p">.</span><span class="nf">SetLocalThreshold</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>     <span class="c1">//只使用与mongo操作耗时小于3秒的
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetMaxConnIdleTime</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>    <span class="c1">//指定连接可以保持空闲的最大毫秒数
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetMaxPoolSize</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>                    <span class="c1">//使用最大的连接数
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetReadPreference</span><span class="p">(</span><span class="nx">want</span><span class="p">)</span>                <span class="c1">//表示只使用辅助节点
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetReadConcern</span><span class="p">(</span><span class="nx">readconcern</span><span class="p">.</span><span class="nf">Majority</span><span class="p">())</span> <span class="c1">//指定查询应返回实例的最新数据确认为，已入副本集中的大多数成员
</span><span class="c1"></span><span class="nx">opt</span><span class="p">.</span><span class="nf">SetWriteConcern</span><span class="p">(</span><span class="nx">wc</span><span class="p">)</span>                    <span class="c1">//请求确认写操作传播到大多数mongod实例
</span></code></pre></td></tr></table>
</div>
</div><h1 id="在go中使用bson对象">在Go中使用BSON对象<a hidden class="anchor" aria-hidden="true" href="#在go中使用bson对象">#</a></h1>
<p>在我们开始向数据库发送查询之前，了解Go Driver如何与BSON对象一起工作非常重要。MongoDB中的JSON文档存储在名为BSON（二进制编码的JSON）的二进制表示中。与将JSON数据存储为简单字符串和数字的其他数据库不同，BSON编码扩展了JSON表示以包括其他类型，如int，long，date，floating point和decimal128。这使应用程序更容易可靠地处理，排序和比较数据。</p>
<p>Go Driver有两类用于表示BSON数据的类型:D类型和Raw类型。</p>
<h2 id="d系列">D系列<a hidden class="anchor" aria-hidden="true" href="#d系列">#</a></h2>
<p>D系列类型用于使用本地Go类型简洁地构建BSON对象。 这对于构造传递给MongoDB的命令特别有用。</p>
<p>D系列包括四种类型：</p>
<h3 id="d">D<a hidden class="anchor" aria-hidden="true" href="#d">#</a></h3>
<p>D表示BSON文档。此类型可用于以简洁和可读的方式表示BSON</p>
<p>D通常应在序列化为BSON时使用。对于反序列化，应该使用Raw或D类型。</p>
<p>用法示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
    <span class="p">{</span><span class="s">&#34;title&#34;</span><span class="p">,</span> <span class="s">&#34;post 2&#34;</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">}},</span>
    <span class="p">{</span><span class="s">&#34;body&#34;</span><span class="p">,</span> <span class="s">`blog post 2`</span><span class="p">},</span>
    <span class="p">{</span><span class="s">&#34;created_at&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()},</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>此操作将创建具有有序元素的文档，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
    <span class="s">&#34;_id&#34;</span> <span class="p">:</span> <span class="nf">ObjectId</span><span class="p">(</span><span class="s">&#34;5c71f03ccfee587e4212ad8f&#34;</span><span class="p">),</span>
    <span class="s">&#34;title&#34;</span> <span class="p">:</span> <span class="s">&#34;post 2&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s">&#34;mongodb&#34;</span>
    <span class="p">],</span>
    <span class="s">&#34;body&#34;</span> <span class="p">:</span> <span class="s">&#34;blog post 2&#34;</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span> <span class="p">:</span> <span class="nf">ISODate</span><span class="p">(</span><span class="s">&#34;2019-02-24T01:15:40.328Z&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>此类型应在顺序重要的情况下使用，例如MongoDB命令。如果顺序并不重要，map更舒适，更简洁</p>
<h3 id="e">E<a hidden class="anchor" aria-hidden="true" href="#e">#</a></h3>
<p>E代表D的BSON元素。它通常用在D中。</p>
<h3 id="m">M<a hidden class="anchor" aria-hidden="true" href="#m">#</a></h3>
<p>M是BSON文档的无序，简洁表示。它通常应该用于当BSON文档的元素顺序无关紧要时序列化BSON。如果元素的顺序重要，请改用D代替。</p>
<p>用法示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
    <span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
    <span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">`blog post`</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的操作将创建一个包含无序元素的文档，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
    <span class="s">&#34;_id&#34;</span> <span class="p">:</span> <span class="nf">ObjectId</span><span class="p">(</span><span class="s">&#34;5c71f03ccfee587e4212ad8e&#34;</span><span class="p">),</span>
    <span class="s">&#34;body&#34;</span> <span class="p">:</span> <span class="s">&#34;blog post&#34;</span><span class="p">,</span>
    <span class="s">&#34;created_at&#34;</span> <span class="p">:</span> <span class="nf">ISODate</span><span class="p">(</span><span class="s">&#34;2019-02-24T01:15:40.326Z&#34;</span><span class="p">),</span>
    <span class="s">&#34;title&#34;</span> <span class="p">:</span> <span class="s">&#34;post&#34;</span><span class="p">,</span>
    <span class="s">&#34;tags&#34;</span> <span class="p">:</span> <span class="p">[</span> 
        <span class="s">&#34;mongodb&#34;</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>请注意，元素的顺序与提供的顺序不同bson.M。</p>
<p>此类型在编码器中作为常规<code>map[string]interface{}</code>处理。元素将是以未定义的随机顺序序列化，每次顺序都不同。</p>
<h3 id="a">A<a hidden class="anchor" aria-hidden="true" href="#a">#</a></h3>
<p>A表示BSON数组。这种类型可以用来简洁地表示BSON数组.A通常应在序列化为BSON时使用。对于反序列化，应该使用RawArray或Array类型。</p>
<p>用法示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">bson</span><span class="p">.</span><span class="nx">A</span><span class="p">{</span><span class="s">&#34;bar&#34;</span><span class="p">,</span> <span class="s">&#34;world&#34;</span><span class="p">,</span> <span class="mf">3.14159</span><span class="p">,</span> <span class="nx">primitive</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;qux&#34;</span><span class="p">,</span> <span class="mi">12345</span><span class="p">}}}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="raw类型">Raw类型<a hidden class="anchor" aria-hidden="true" href="#raw类型">#</a></h2>
<p>Raw类型用于byte切片。您还可以使用欧路词典从Raw类型中取回单独的元素。如果您不希望花费频繁将BSON解码为另一种类型的开销，这将非常有用。本教程仅使用D系列类型。</p>
<h2 id="结构体替代bson">结构体替代bson<a hidden class="anchor" aria-hidden="true" href="#结构体替代bson">#</a></h2>
<p>除了传入bson,还可以传入带tag的结构体作为bson</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">
<span class="kd">type</span> <span class="nx">BeforeCond</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Before</span> <span class="kt">int64</span> <span class="s">`bson:&#34;$lt&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">DeleteCond</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">BeforeCond</span> <span class="nx">BeforeCond</span> <span class="s">`bson:&#34;timePoint.startTime&#34;`</span>
<span class="p">}</span>

<span class="nx">delCond</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">DeleteCond</span><span class="p">{</span>
	<span class="nx">BeforeCond</span><span class="p">:</span> <span class="nx">BeforeCond</span><span class="p">{</span>
		<span class="nx">Before</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">}</span>


<span class="kd">type</span> <span class="nx">FindByJobName</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">JobName</span> <span class="kt">string</span> <span class="s">`bson:&#34;jobName&#34;`</span>
<span class="p">}</span>

<span class="nx">cond</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">FindByJobName</span><span class="p">{</span>
	<span class="nx">JobName</span><span class="p">:</span> <span class="s">&#34;hello&#34;</span><span class="p">,</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="bson转结构体">bson转结构体<a hidden class="anchor" aria-hidden="true" href="#bson转结构体">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//bson转结构体,需要结构体打上bson标签
</span><span class="c1">//a:=bson.M{}
</span><span class="c1">//x:=A{}
</span><span class="c1">//Bson2Odj(a,&amp;x)
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Bson2Odj</span><span class="p">(</span><span class="nx">val</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">obj</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">//bson转[]byte
</span><span class="c1"></span>	<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="c1">//[]byte转结构体
</span><span class="c1"></span>	<span class="nx">err</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="mongo-shell-转bson">mongo Shell 转bson<a hidden class="anchor" aria-hidden="true" href="#mongo-shell-转bson">#</a></h2>
<h3 id="shell语句-转-bson">shell语句 转 bson<a hidden class="anchor" aria-hidden="true" href="#shell语句-转-bson">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">a</span><span class="o">:=</span><span class="s">`$and : [{&#34;id&#34; : &#34;asdfzcv&#34;}, {&#34;num&#34; : 6}]`</span>
	<span class="c1">//bb:=bson.M{&#34;id&#34;: &#34;asdfzcv&#34;, &#34;num&#34;: 6}
</span><span class="c1"></span>	<span class="nx">bb</span><span class="o">:=</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{}</span>
	<span class="nx">_</span><span class="p">=</span><span class="nx">bson</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span><span class="o">&amp;</span><span class="nx">bb</span><span class="p">)</span>
	<span class="c1">//bb=bson.M{&#34;id&#34;: &#34;asdfzcv&#34;, &#34;num&#34;: 6}
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">update</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{ &#34;$set&#34;: {&#34;year&#34;: 1998}}`</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">update</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="shell语句组-转-bson">shell语句组 转 []bson<a hidden class="anchor" aria-hidden="true" href="#shell语句组-转-bson">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">	<span class="nx">toConvert</span> <span class="o">:=</span> <span class="s">`[
</span><span class="s">        {
</span><span class="s">            &#34;$project&#34;: {
</span><span class="s">                &#34;_id&#34;: 0,
</span><span class="s">                &#34;A&#34;: &#34;$$ROOT&#34;
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$lookup&#34;: {
</span><span class="s">                &#34;localField&#34;: &#34;A.TypeId&#34;,
</span><span class="s">                &#34;from&#34;: &#34;RoleType&#34;,
</span><span class="s">                &#34;foreignField&#34;: &#34;_id&#34;,
</span><span class="s">                &#34;as&#34;: &#34;B&#34;
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$unwind&#34;: {
</span><span class="s">                &#34;path&#34;: &#34;$B&#34;,
</span><span class="s">                &#34;preserveNullAndEmptyArrays&#34;: true
</span><span class="s">            }
</span><span class="s">        }, 
</span><span class="s">        {
</span><span class="s">            &#34;$project&#34;: {
</span><span class="s">                &#34;A.RoleId&#34;: &#34;$A.RoleId&#34;,
</span><span class="s">                &#34;A.RoleName&#34;: &#34;$A.RoleName&#34;,
</span><span class="s">                &#34;A.Valid&#34;: &#34;$A.Valid&#34;,
</span><span class="s">                &#34;B.TypeName&#34;: &#34;$B.TypeName&#34;
</span><span class="s">            }
</span><span class="s">        }
</span><span class="s">    ]`</span>
<span class="nx">pipeLine</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">UnmarshalExtJSON</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">toConvert</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pipeLine</span><span class="p">)</span>

</code></pre></td></tr></table>
</div>
</div><h1 id="crud操作">CRUD操作<a hidden class="anchor" aria-hidden="true" href="#crud操作">#</a></h1>
<p>连接到数据库后，就可以开始添加和操作某些数据了。该Collection类型有几种方法，允许您向数据库发送查询。</p>
<h2 id="插入文件">插入文件<a hidden class="anchor" aria-hidden="true" href="#插入文件">#</a></h2>
<h3 id="insertone">InsertOne<a hidden class="anchor" aria-hidden="true" href="#insertone">#</a></h3>
<p>要插入单个文档，请使用以下collection.InsertOne()方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create a new context with a 10 second timeout
</span><span class="c1"></span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span>

<span class="c1">// insert one document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="s">&#34;title&#34;</span><span class="p">:</span> <span class="s">&#34;Go mongodb driver cookbook&#34;</span><span class="p">,</span>
	<span class="s">&#34;tags&#34;</span><span class="p">:</span>  <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;golang&#34;</span><span class="p">,</span> <span class="s">&#34;mongodb&#34;</span><span class="p">},</span>
	<span class="s">&#34;body&#34;</span><span class="p">:</span> <span class="s">`this is a long post
</span><span class="s">    that goes on and on
</span><span class="s">    and have many lines`</span><span class="p">,</span>
	<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">1</span><span class="p">,</span>
	<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
	<span class="s">&#34;new post created with id: %s&#34;</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">InsertedID</span><span class="p">.(</span><span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span><span class="p">).</span><span class="nf">Hex</span><span class="p">(),</span>
<span class="p">)</span>
<span class="c1">// =&gt; new post created with id: 5c71caf32a346553363177ce
</span></code></pre></td></tr></table>
</div>
</div><p>也可以不使用bson.M{}来传递参数,而是使用包含bson标签例如`bson:&quot;_id&quot;`的结构体,比如:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">ID</span>    <span class="nx">primitive</span><span class="p">.</span><span class="nx">ObjectID</span> 	<span class="s">`bson:&#34;_id,omitempty&#34;`</span>
	<span class="nx">Name</span>  <span class="kt">string</span>      			<span class="s">`bson:&#34;dbname&#34;,json:&#34;jsonname&#34;`</span>
	<span class="nx">Phone</span> <span class="kt">string</span>
	<span class="nx">ASD</span>   <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// Insert one
</span><span class="c1"></span><span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span><span class="s">&#34;1234567890&#34;</span><span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">InsertedID</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Insert many
</span><span class="c1"></span><span class="p">{</span>
	<span class="nx">users</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}{</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_0&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;123&#34;</span><span class="p">},</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_1&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;456&#34;</span><span class="p">},</span>
		<span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_2&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">InsertMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">users</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="insertmany">InsertMany<a hidden class="anchor" aria-hidden="true" href="#insertmany">#</a></h3>
<p>要一次插入多个文档，该collection.InsertMany()方法将采用一些对象：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}{</span>
	<span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;Post one&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;golang&#34;</span><span class="p">},</span>
		<span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">&#34;post one body&#34;</span><span class="p">,</span>
		<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">14</span><span class="p">,</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Date</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">January</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">UTC</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;Post two&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;nodejs&#34;</span><span class="p">},</span>
		<span class="s">&#34;body&#34;</span><span class="p">:</span>       <span class="s">&#34;post two body&#34;</span><span class="p">,</span>
		<span class="s">&#34;comments&#34;</span><span class="p">:</span>   <span class="mi">2</span><span class="p">,</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;inserted ids: %v\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">InsertedIDs</span><span class="p">)</span>
<span class="c1">// =&gt; inserted ids: [ObjectID(&#34;5c71ce5c6e6d43eb6e2e93be&#34;) ObjectID(&#34;5c71ce5c6e6d43eb6e2e93bf&#34;)]
</span></code></pre></td></tr></table>
</div>
</div><h2 id="更新文件">更新文件<a hidden class="anchor" aria-hidden="true" href="#更新文件">#</a></h2>
<h3 id="update">update<a hidden class="anchor" aria-hidden="true" href="#update">#</a></h3>
<h4 id="updateone">UpdateOne<a hidden class="anchor" aria-hidden="true" href="#updateone">#</a></h4>
<p>该collection.UpdateOne()方法允许您更新单个文档。它需要一个过滤器文档来匹配数据库中的文档和一个更新文档来描述更新操作。update需要传入bson命令</p>
<p>您可以使用以下bson.D类型构建这些：</p>
<p>这里我们还从其十六进制字符串表示中创建一个新的ObjectID：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create ObjectID from string
</span><span class="c1"></span><span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93be&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// set filters and updates
</span><span class="c1"></span><span class="nx">filter</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">}</span>
<span class="nx">update</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;title&#34;</span><span class="p">:</span> <span class="s">&#34;post 2 (two)&#34;</span><span class="p">}}</span>

<span class="c1">// update document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;modified count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">)</span>
<span class="c1">// =&gt; modified count: 1
</span></code></pre></td></tr></table>
</div>
</div><h4 id="updatemany">UpdateMany<a hidden class="anchor" aria-hidden="true" href="#updatemany">#</a></h4>
<p>要更新多个文档（相当于{multi: true}），请使用collection.UpdateMany()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// set filters and updates
</span><span class="c1"></span><span class="nx">filter</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$elemMatch&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$eq&#34;</span><span class="p">:</span> <span class="s">&#34;golang&#34;</span><span class="p">}}}</span>
<span class="nx">update</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;comments&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;updated_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}}</span>

<span class="c1">// update documents
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateMany</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;modified count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">)</span>
<span class="c1">// =&gt; modified count: 17
</span></code></pre></td></tr></table>
</div>
</div><h4 id="upsert">upsert<a hidden class="anchor" aria-hidden="true" href="#upsert">#</a></h4>
<p>对于两者而言UpdateOne，UpdateMany您可以通过将适当的选项传递给函数来使其成为upsert操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Update</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span>

<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">UpdateMany</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Update</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="replace">replace<a hidden class="anchor" aria-hidden="true" href="#replace">#</a></h3>
<h4 id="replaceone">replaceone<a hidden class="anchor" aria-hidden="true" href="#replaceone">#</a></h4>
<p>Update是用来直接修改数据库的，ReplaceOne则是整个替换。 可以用bson传入要替换的值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">}</span>
<span class="kd">var</span> <span class="nx">result</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">UpdateResult</span>
<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionExamples</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">doc</span><span class="p">[</span><span class="s">&#34;year&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1998</span>
<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s">&#34;_id&#34;</span><span class="p">]},</span> <span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>replacement也可以直接传入结构体进行更新</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Replace one
</span><span class="c1"></span><span class="p">{</span>
	<span class="nx">user</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;UserName_2_replaced&#34;</span><span class="p">,</span> <span class="nx">Phone</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">}</span>
	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userColl</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;phone&#34;</span><span class="p">:</span> <span class="s">&#34;789&#34;</span><span class="p">},</span> <span class="nx">user</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="resert">resert<a hidden class="anchor" aria-hidden="true" href="#resert">#</a></h4>
<p>也可以通过将适当的选项传递给函数来使replace其成为upsert操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">ReplaceOne</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Replace</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="p">)</span>

<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">ReplaceMany</span><span class="p">(</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Replace</span><span class="p">().</span><span class="nf">SetUpsert</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="nx">v</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="查询与删改换结合">查询与删改换结合<a hidden class="anchor" aria-hidden="true" href="#查询与删改换结合">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//查询单条数据后删除该数据
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndDelete</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_3&#34;</span><span class="p">}}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;FindOneAndDelete查询到的数据:%v\n&#34;</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>
<span class="c1">//查询单条数据后修改该数据
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndUpdate</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_4&#34;</span><span class="p">}},</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;这条数据我需要修改了&#34;</span><span class="p">}}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;FindOneAndUpdate查询到的数据:%v\n&#34;</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>

<span class="c1">//查询单条数据后替换该数据(以前的数据全部清空)
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOneAndReplace</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;name&#34;</span><span class="p">,</span> <span class="s">&#34;howie_5&#34;</span><span class="p">}}</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;hero&#34;</span><span class="p">:</span> <span class="s">&#34;这条数据我替换了&#34;</span><span class="p">}).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="查找文件">查找文件<a hidden class="anchor" aria-hidden="true" href="#查找文件">#</a></h2>
<h3 id="findone">FindOne<a hidden class="anchor" aria-hidden="true" href="#findone">#</a></h3>
<p>要查找文档，您需要一个过滤器文档以及一个指向可以解码结果的值的指针。要查找单个文档，请使用collection.FindOne()。此方法返回单个结果，可将其解码为值。您将使用filter在更新查询中使用的相同变量来匹配名称为Ash的文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create a value into which the result can be decoded
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">result</span> <span class="nx">Trainer</span>

<span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">FindOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">filter</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Found a single document: %+v\n&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Decode()函数也可以传参bson</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">table</span><span class="p">.</span><span class="nf">FindOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="find">Find<a hidden class="anchor" aria-hidden="true" href="#find">#</a></h3>
<p>要查找多个文档，请使用collection.Find()。这个方法返回一个Cursor。A Cursor提供了一个文档流，您可以通过它们一次迭代和解码一个文档。一旦Cursor用尽，你应该关闭Cursor。在这里，您还将使用options包设置一些操作选项。具体来说，您将设置限制，因此只返回2个文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Pass these options to the Find method
</span><span class="c1"></span><span class="nx">findOptions</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">()</span>
<span class="nx">findOptions</span><span class="p">.</span><span class="nf">SetLimit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1">// Here&#39;s an array in which you can store the decoded documents
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">results</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Trainer</span>

<span class="c1">// Passing bson.D{{}} as the filter matches all documents in the collection
</span><span class="c1"></span><span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{}},</span> <span class="nx">findOptions</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Finding multiple documents returns a cursor
</span><span class="c1">// Iterating through the cursor allows us to decode documents one at a time
</span><span class="c1"></span><span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span> <span class="p">{</span>
    
    <span class="c1">// create a value into which the single document can be decoded
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">elem</span> <span class="nx">Trainer</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">results</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">elem</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Close the cursor once finished
</span><span class="c1"></span><span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">())</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Found multiple documents (array of pointers): %+v\n&#34;</span><span class="p">,</span> <span class="nx">results</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Find也可以返回bson,如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">MongoUtils</span><span class="p">)</span> <span class="nf">FindMore</span><span class="p">(</span><span class="nx">col</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">filter</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">([]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">,</span> <span class="kt">error</span><span class="p">){</span>
	<span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Db</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Con</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;没有初始化连接和数据库信息！&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">table</span> <span class="o">:=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">col</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">,</span><span class="nx">_</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="nx">cur</span><span class="p">,</span> <span class="nx">err2</span> <span class="o">:=</span> <span class="nx">table</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">filter</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err2</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="nx">err2</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err2</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">resultArr</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">){</span>
		<span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
		<span class="nx">err3</span> <span class="o">:=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err3</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err3</span>
		<span class="p">}</span>
		<span class="nx">resultArr</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">resultArr</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">resultArr</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="有序find">有序find<a hidden class="anchor" aria-hidden="true" href="#有序find">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//一次查询多条数据
</span><span class="c1">// 查询createtime&gt;=3
</span><span class="c1">// 限制取2条
</span><span class="c1">// createtime从大到小排序的数据
</span><span class="c1"></span><span class="k">if</span> <span class="nx">cursor</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$gte&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}},</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">().</span><span class="nf">SetLimit</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Find</span><span class="p">().</span><span class="nf">SetSort</span><span class="p">(</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}));</span> <span class="nx">err</span><span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">//多个options.Find()可以用链式表达,比如:
</span><span class="c1">//findOptions := options.Find().SetSort(SORT).SetLimit(Limit).SetSkip(Skip)
</span><span class="c1">//按选项查询集合 Skip 跳过 Limit 读取数量 sort 
</span><span class="c1"></span>
<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
<span class="k">for</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cursor</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">howie</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">howieArrayEmpty</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">howieArrayEmpty</span><span class="p">,</span> <span class="nx">howie</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">howieArrayEmpty</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Find查询到的数据ObejectId值%s 值:%v\n&#34;</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">HowieId</span><span class="p">.</span><span class="nf">Hex</span><span class="p">(),</span> <span class="nx">v</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="distinct">distinct<a hidden class="anchor" aria-hidden="true" href="#distinct">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//返回满足filter条件下的所有fieldName值,[]interface{}类型
</span><span class="c1">//res, err := mymongo.Distinct(&#34;test&#34;, &#34;id&#34;, bson.M{})
</span><span class="c1"></span>	<span class="nx">collection</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">fieldName</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
	<span class="k">return</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="根据_id查找文件">根据_id查找文件<a hidden class="anchor" aria-hidden="true" href="#根据_id查找文件">#</a></h3>
<p>mongodb里面&quot;_id&quot;不是字符串,只是方便显示,在可视化界面中展示为字符串,如&quot;5d36fc03d3a200b7aeecaeac&quot;</p>
<p>如果要在golang中通过_id查找文件,需要先将字符串转化为primitive.ObjectID,然后再查找</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ID</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="nx">stringID</span><span class="p">)</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">ID</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="删除文件">删除文件<a hidden class="anchor" aria-hidden="true" href="#删除文件">#</a></h2>
<h3 id="deleteone">DeleteOne<a hidden class="anchor" aria-hidden="true" href="#deleteone">#</a></h3>
<p>要删除文档，请使用collection.DeleteOne()：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// create ObjectID from string
</span><span class="c1"></span><span class="nx">id</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">ObjectIDFromHex</span><span class="p">(</span><span class="s">&#34;5c71ce5c6e6d43eb6e2e93be&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// delete document
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">DeleteOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;deleted count: %d\n&#34;</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="deletemany">DeleteMany<a hidden class="anchor" aria-hidden="true" href="#deletemany">#</a></h3>
<p>最后，您可以使用collection.DeleteOne()或删除文档collection.DeleteMany()。在这里，您将传递bson.D{{}}过滤器参数，该参数将匹配集合中的所有文档。您还可以使用collection.Drop()删除整个集合。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">deleteResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">DeleteMany</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{}})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Deleted %v documents in the trainers collection\n&#34;</span><span class="p">,</span> <span class="nx">deleteResult</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="bulkwrite">bulkWrite<a hidden class="anchor" aria-hidden="true" href="#bulkwrite">#</a></h1>
<p>有时您想要执行许多操作，例如一次插入，更新和删除所有操作。在这种情况下，MongoDB提供了非常有用的批量写入API，它采用一系列写入操作并执行每个操作。默认情况下，操作按顺序执行。这是一个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// list of inserts
</span><span class="c1"></span><span class="nx">inserts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post five&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;postgresql&#34;</span><span class="p">},</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="s">&#34;title&#34;</span><span class="p">:</span>      <span class="s">&#34;post six&#34;</span><span class="p">,</span>
		<span class="s">&#34;tags&#34;</span><span class="p">:</span>       <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;graphql&#34;</span><span class="p">},</span>
		<span class="s">&#34;created_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">}</span>

<span class="c1">// list of updates
</span><span class="c1"></span><span class="nx">updates</span> <span class="o">:=</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">filter</span>  <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">updates</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
<span class="p">}{</span>
	<span class="p">{</span>
		<span class="nx">filter</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
			<span class="s">&#34;tags&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$elemMatch&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$eq&#34;</span><span class="p">:</span> <span class="s">&#34;golang&#34;</span><span class="p">}},</span>
		<span class="p">},</span>
		<span class="nx">updates</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$set&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;updated_at&#34;</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()}},</span>
	<span class="p">},</span>
<span class="p">}</span>

<span class="c1">// list of deletes
</span><span class="c1"></span><span class="nx">deletes</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id2</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id3</span><span class="p">},</span>
<span class="p">}</span>

<span class="c1">// create the slice of write models
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">writes</span> <span class="p">[]</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">WriteModel</span>

<span class="c1">// range over each list of operations and create the write model
</span><span class="c1"></span><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ins</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">inserts</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewInsertOneModel</span><span class="p">().</span><span class="nf">SetDocument</span><span class="p">(</span><span class="nx">ins</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">upd</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">updates</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewUpdateManyModel</span><span class="p">().</span>
		<span class="nf">SetFilter</span><span class="p">(</span><span class="nx">upd</span><span class="p">.</span><span class="nx">filter</span><span class="p">).</span><span class="nf">SetUpdate</span><span class="p">(</span><span class="nx">upd</span><span class="p">.</span><span class="nx">updates</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">del</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">deletes</span> <span class="p">{</span>
	<span class="nx">model</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">NewDeleteManyModel</span><span class="p">().</span><span class="nf">SetFilter</span><span class="p">(</span><span class="nx">del</span><span class="p">)</span>
	<span class="nx">writes</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">writes</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// run bulk write
</span><span class="c1"></span><span class="nx">res</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">BulkWrite</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">writes</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
	<span class="s">&#34;insert: %d, updated: %d, deleted: %d&#34;</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">InsertedCount</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">ModifiedCount</span><span class="p">,</span>
	<span class="nx">res</span><span class="p">.</span><span class="nx">DeletedCount</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">// =&gt; insert: 2, updated: 10, deleted: 3
</span></code></pre></td></tr></table>
</div>
</div><h1 id="聚合查询">聚合查询<a hidden class="anchor" aria-hidden="true" href="#聚合查询">#</a></h1>
<h2 id="count">count<a hidden class="anchor" aria-hidden="true" href="#count">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//查询集合里面有多少数据
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">CountDocuments</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Count里面有多少条数据:%d\n&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>

	<span class="c1">//查询集合里面有多少数据(查询createtime&gt;=3的数据)
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">size</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">CountDocuments</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;createtime&#34;</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;$gte&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Count里面有多少条数据:%d\n&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">checkErr</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">ErrNoDocuments</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;没有查到数据&#34;</span><span class="p">)</span>
			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="estimateddocumentcount">EstimatedDocumentCount<a hidden class="anchor" aria-hidden="true" href="#estimateddocumentcount">#</a></h2>
<p>估计集合内有多少数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">num</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">EstimatedDocumentCount</span><span class="p">(</span><span class="nf">getContext</span><span class="p">(),</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="aggregate">aggregate<a hidden class="anchor" aria-hidden="true" href="#aggregate">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">TestAggregateJSON</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>

	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>

	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="s">`[
</span><span class="s">		{&#34;$match&#34;: { &#34;color&#34;: &#34;Red&#34; }},
</span><span class="s">		{&#34;$group&#34;: { &#34;_id&#34;: &#34;$brand&#34;, &#34;count&#34;: { &#34;$sum&#34;: 1 } }},
</span><span class="s">		{&#34;$project&#34;: { &#34;brand&#34;: &#34;$_id&#34;, &#34;_id&#34;: 0, &#34;count&#34;: 1 }}
</span><span class="s">	]`</span>

	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">brands</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">brands</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAllowDiskUse</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetBatchSize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
	<span class="nx">pipeLine</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nf">UnmarshalExtJSON</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">),</span> <span class="kc">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">pipeLine</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeLine</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">total</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">),</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestAggregatePipeline</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>

	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>

	<span class="c1">// this cause warning from go vet
</span><span class="c1"></span>	<span class="c1">// pipeline := mongo.Pipeline{
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$match&#34;, bson.D{{&#34;color&#34;, &#34;Red&#34;}}}},
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$group&#34;, bson.D{{&#34;_id&#34;, &#34;$brand&#34;}, {&#34;count&#34;, bson.D{{&#34;$sum&#34;, 1}}}}}},
</span><span class="c1"></span>	<span class="c1">// 	{{&#34;$project&#34;, bson.D{{&#34;brand&#34;, &#34;$_id&#34;}, {&#34;_id&#34;, 0}, {&#34;count&#34;, 1}}}},
</span><span class="c1"></span>	<span class="c1">// }
</span><span class="c1"></span>	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$match&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}}}},</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$group&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;_id&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;$brand&#34;</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;count&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$sum&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}}}},</span>
		<span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$project&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;$_id&#34;</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;_id&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;count&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}}},</span>
	<span class="p">}</span>
	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">brands</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="k">if</span> <span class="nx">brands</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Distinct</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;brand&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;color&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Red&#34;</span><span class="p">}});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAllowDiskUse</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetBatchSize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">total</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">brands</span><span class="p">),</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestAggregateBSOND</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Cursor</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="nx">size</span> <span class="o">:=</span> <span class="mi">10</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="nf">seedCarsData</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">dbName</span><span class="p">)</span>
	<span class="nx">pipeline</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;$sample&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="s">&#34;size&#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">}}}}}</span>
	<span class="nx">collection</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collectionName</span><span class="p">)</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">Aggregate</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="nx">total</span> <span class="o">:=</span> <span class="mi">0</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">total</span><span class="o">++</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">total</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected &#34;</span><span class="p">,</span> <span class="nx">size</span><span class="p">,</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">total</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="事务机制">事务机制<a hidden class="anchor" aria-hidden="true" href="#事务机制">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// WithSession允许用户自己启动会话并进行管理
</span><span class="c1">//它的一生为CRUD方法提供会话的唯一方法是
</span><span class="c1">//使用mongo.SessionContext调用该CRUD方法
</span><span class="c1">//关闭mongo.SessionContext可以用作常规上下文，
</span><span class="c1">//所以像context.WithDeadline和context.WithTimeout这样的方法是
</span><span class="c1">// 支持的。
</span><span class="c1">//
</span><span class="c1">//如果context.Context已经附加了mongo.Session，那就是
</span><span class="c1">// mongo.Session将替换为提供的。
</span><span class="c1">//
</span><span class="c1">//从闭包中返回的错误是透明地返回的
</span><span class="c1">//这个功能
</span><span class="c1"></span><span class="kd">func</span> <span class="nx">WithSession</span><span class="err">（</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="err">，</span><span class="nx">sess</span> <span class="nx">Session</span><span class="err">，</span><span class="nx">fn</span> <span class="kd">func</span><span class="err">（</span><span class="nx">SessionContext</span><span class="err">）</span><span class="kt">error</span><span class="err">）</span><span class="kt">error</span> <span class="p">{</span>
<span class="k">return</span> <span class="nx">fn</span><span class="err">（</span><span class="nx">contextWithSession</span><span class="err">（</span><span class="nx">ctx</span><span class="err">，</span><span class="nx">sess</span><span class="err">））</span>
<span class="p">}</span>

<span class="c1">// UseSession创建一个默认会话，该会话仅对
</span><span class="c1">//关闭的生命周期关闭会话之外没有清理
</span><span class="c1">//在退出封闭时完成。这意味着一个出色的
</span><span class="c1">//即使闭包返回错误，也会中止事务。
</span><span class="c1">//
</span><span class="c1">//如果ctx已经包含mongo.Session，那mongo.Session将是
</span><span class="c1">//替换为新创建的mongo.Session。
</span><span class="c1">//
</span><span class="c1">//从闭包中返回的错误是透明地返回的
</span><span class="c1">//这个方法
</span><span class="c1"></span><span class="kd">func</span><span class="err">（</span><span class="nx">c</span> <span class="o">*</span> <span class="nx">Client</span><span class="err">）</span><span class="nx">UseSession</span><span class="err">（</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="err">，</span><span class="nx">fn</span> <span class="kd">func</span><span class="err">（</span><span class="nx">SessionContext</span><span class="err">）</span><span class="kt">error</span><span class="err">）</span><span class="kt">error</span> <span class="p">{</span>
<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">UseSessionWithOptions</span><span class="err">（</span><span class="nx">ctx</span><span class="err">，</span><span class="nx">options</span><span class="p">.</span><span class="nx">Session</span><span class="err">（），</span><span class="nx">fn</span><span class="err">）</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="withsession">WithSession<a hidden class="anchor" aria-hidden="true" href="#withsession">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">collection</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">id</span> <span class="p">=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">,</span> <span class="s">&#34;year&#34;</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">1998</span><span class="p">)}</span>
	<span class="kd">var</span> <span class="nx">result</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">UpdateResult</span>
	<span class="kd">var</span> <span class="nx">session</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Session</span>
	<span class="kd">var</span> <span class="nx">update</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;$set&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;year&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">2000</span><span class="p">)}}}}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">StartSession</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">WithSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sc</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">sc</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">id</span><span class="p">},</span> <span class="nx">update</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">result</span><span class="p">.</span><span class="nx">MatchedCount</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">result</span><span class="p">.</span><span class="nx">ModifiedCount</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;replace failed, expected 1 but got&#34;</span><span class="p">,</span> <span class="nx">result</span><span class="p">.</span><span class="nx">MatchedCount</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="c1">//提交
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="c1">//放弃
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">session</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">session</span><span class="p">.</span><span class="nf">EndSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="usesession">UseSession<a hidden class="anchor" aria-hidden="true" href="#usesession">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;github.com/mongodb/mongo-go-driver/mongo&#34;</span>
    <span class="s">&#34;net/url&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="nx">connectString</span> <span class="o">:=</span> <span class="s">&#34;mongodb://127.0.0.1/test&#34;</span>
    <span class="nx">dbUrl</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">connectString</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

    <span class="c1">//认证参数设置，否则连不上
</span><span class="c1"></span>	<span class="nx">opts</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">{}</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetAuth</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">Credential</span><span class="p">{</span>
			<span class="nx">AuthMechanism</span><span class="p">:</span><span class="s">&#34;SCRAM-SHA-1&#34;</span><span class="p">,</span>
			<span class="nx">AuthSource</span><span class="p">:</span><span class="s">&#34;test&#34;</span><span class="p">,</span>
			<span class="nx">Username</span><span class="p">:</span><span class="s">&#34;test&#34;</span><span class="p">,</span>
			<span class="nx">Password</span><span class="p">:</span><span class="s">&#34;123456&#34;</span><span class="p">})</span>
			
    <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">connectString</span><span class="err">，</span><span class="nx">opts</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

    <span class="nx">db</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbUrl</span><span class="p">.</span><span class="nx">Path</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    
    <span class="nx">col</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Collection</span><span class="p">(</span><span class="s">&#34;test&#34;</span><span class="p">)</span>
    
    <span class="c1">//先在事务外写一条id为“111”的记录
</span><span class="c1"></span>    <span class="nx">_</span><span class="p">,</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;111&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    
    <span class="c1">//第一个事务：成功执行
</span><span class="c1"></span>    <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">UseSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sessionContext</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="p">=</span> <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//在事务内写一条id为“222”的记录
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;222&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//在事务内写一条id为“333”的记录
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;333&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">})</span>
	
    <span class="c1">//第二个事务：执行失败，事务没提交，因最后插入了一条重复id &#34;111&#34;,
</span><span class="c1"></span>    <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Client</span><span class="p">().</span><span class="nf">UseSession</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">sessionContext</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">SessionContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">StartTransaction</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

        <span class="c1">//在事务内写一条id为“222”的记录
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;444&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">){</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span>

		<span class="c1">//写重复id
</span><span class="c1"></span>        <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">col</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="s">&#34;111&#34;</span><span class="p">,</span> <span class="s">&#34;name&#34;</span><span class="p">:</span> <span class="s">&#34;ddd&#34;</span><span class="p">,</span> <span class="s">&#34;age&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">AbortTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
            <span class="k">return</span> <span class="nx">err</span>
        <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
            <span class="nx">sessionContext</span><span class="p">.</span><span class="nf">CommitTransaction</span><span class="p">(</span><span class="nx">sessionContext</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">})</span>
<span class="p">}</span> 

<span class="c1">//最终数据只有 &#34;111&#34;,&#34;222&#34;,&#34;333&#34; 三条，事务测试成功。
</span></code></pre></td></tr></table>
</div>
</div><h1 id="runcommand">RunCommand<a hidden class="anchor" aria-hidden="true" href="#runcommand">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">result</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="nx">command</span> <span class="o">:=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;isMaster&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">}}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="s">&#34;admin&#34;</span><span class="p">).</span><span class="nf">RunCommand</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">command</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">result</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="gridfs">gridfs<a hidden class="anchor" aria-hidden="true" href="#gridfs">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">bucket</span> <span class="o">*</span><span class="nx">gridfs</span><span class="p">.</span><span class="nx">Bucket</span>
	<span class="kd">var</span> <span class="nx">ustream</span> <span class="o">*</span><span class="nx">gridfs</span><span class="p">.</span><span class="nx">UploadStream</span>
	<span class="nx">str</span> <span class="o">:=</span> <span class="s">&#34;This is a test file&#34;</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>

	<span class="k">if</span> <span class="nx">bucket</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">gridfs</span><span class="p">.</span><span class="nf">NewBucket</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">dbName</span><span class="p">),</span> <span class="nx">options</span><span class="p">.</span><span class="nf">GridFSBucket</span><span class="p">().</span><span class="nf">SetName</span><span class="p">(</span><span class="s">&#34;myFiles&#34;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">GridFSUpload</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetMetadata</span><span class="p">(</span><span class="nx">bsonx</span><span class="p">.</span><span class="nx">Doc</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;content-type&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">bsonx</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;application/json&#34;</span><span class="p">)}})</span>
	<span class="k">if</span> <span class="nx">ustream</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nf">OpenUploadStream</span><span class="p">(</span><span class="s">&#34;test.txt&#34;</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ustream</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">str</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">fileID</span> <span class="o">:=</span> <span class="nx">ustream</span><span class="p">.</span><span class="nx">FileID</span>
	<span class="nx">ustream</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">b</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
	<span class="nx">w</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">bucket</span><span class="p">.</span><span class="nf">DownloadToStream</span><span class="p">(</span><span class="nx">fileID</span><span class="p">,</span> <span class="nx">w</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">ustream</span><span class="p">.</span><span class="nx">FileID</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">str</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;expected&#34;</span><span class="p">,</span> <span class="nx">str</span><span class="p">,</span> <span class="s">&#34;but got&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
	<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="change-stream">change stream<a hidden class="anchor" aria-hidden="true" href="#change-stream">#</a></h1>
<p>change_stream.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Copyright 2018 Kuei-chun Chen. All rights reserved.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">examples</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>

	<span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo/options&#34;</span>
<span class="p">)</span>

<span class="c1">// ChangeStream defines what to watch? client, database or collection
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ChangeStream</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">collection</span> <span class="kt">string</span>
	<span class="nx">database</span>   <span class="kt">string</span>
	<span class="nx">pipeline</span>   <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">callback</span> <span class="kd">func</span><span class="p">(</span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span>

<span class="c1">// SetCollection sets collection
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span> <span class="p">=</span> <span class="nx">collection</span>
<span class="p">}</span>

<span class="c1">// SetDatabase sets database
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">database</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="p">=</span> <span class="nx">database</span>
<span class="p">}</span>

<span class="c1">// SetPipeline sets pipeline
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">pipeline</span>
<span class="p">}</span>

<span class="c1">// NewChangeStream gets a new ChangeStream
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewChangeStream</span><span class="p">()</span> <span class="o">*</span><span class="nx">ChangeStream</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ChangeStream</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// Watch prints oplogs in JSON format
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cs</span> <span class="o">*</span><span class="nx">ChangeStream</span><span class="p">)</span> <span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">cb</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">cur</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">ChangeStream</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;pipeline&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">options</span><span class="p">.</span><span class="nf">ChangeStream</span><span class="p">()</span>
	<span class="nx">opts</span><span class="p">.</span><span class="nf">SetFullDocument</span><span class="p">(</span><span class="s">&#34;updateLookup&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="o">+</span><span class="s">&#34;.&#34;</span><span class="o">+</span><span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">coll</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">collection</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">coll</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching&#34;</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">db</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">database</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Watching all&#34;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cs</span><span class="p">.</span><span class="nx">pipeline</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">defer</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">doc</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="k">for</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">doc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nf">cb</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cur</span><span class="p">.</span><span class="nf">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>change_stream_test.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Copyright 2018 Kuei-chun Chen. All rights reserved.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">examples</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;testing&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;github.com/simagix/keyhole/mdb&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/bson&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/bson/primitive&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/mongo&#34;</span>
	<span class="s">&#34;go.mongodb.org/mongo-driver/x/network/connstring&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">collection</span> <span class="p">=</span> <span class="s">&#34;oplogs&#34;</span>

<span class="c1">// example: argos &#34;mongodb://localhost:27017/argos?replicaSet=replset&#34; students &#39;[{&#34;$match&#34;: {&#34;operationType&#34;: &#34;update&#34;}}]&#39;
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">silent</span><span class="p">(</span><span class="nx">doc</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamClient</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
		<span class="nx">client</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="c1">// stream.Watch(client)
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamDatabase</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
		<span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Drop</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamCollection</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">[]</span><span class="nx">bson</span><span class="p">.</span><span class="nx">D</span>
	<span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Pipeline</span><span class="p">{}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestChangeStreamCollectionWithPipeline</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="kd">var</span> <span class="nx">client</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
	<span class="kd">var</span> <span class="nx">cs</span> <span class="nx">connstring</span><span class="p">.</span><span class="nx">ConnString</span>
	<span class="kd">var</span> <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">uri</span> <span class="p">=</span> <span class="s">&#34;mongodb://localhost:27017/argos?replicaSet=replset&#34;</span>
	<span class="k">if</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">uri</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DATABASE_URL&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cs</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">connstring</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="p">=</span> <span class="nf">getMongoClient</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">pipeline</span> <span class="p">=</span> <span class="nx">mdb</span><span class="p">.</span><span class="nf">MongoPipeline</span><span class="p">(</span><span class="s">`[{&#34;$match&#34;: {&#34;operationType&#34;: {&#34;$in&#34;: [&#34;update&#34;, &#34;delete&#34;] } }}]`</span><span class="p">)</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Database</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">).</span><span class="nf">Collection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;city&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">execute</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
	<span class="p">}(</span><span class="nx">c</span><span class="p">)</span>

	<span class="nx">stream</span> <span class="o">:=</span> <span class="nf">NewChangeStream</span><span class="p">()</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetCollection</span><span class="p">(</span><span class="nx">collection</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetDatabase</span><span class="p">(</span><span class="nx">cs</span><span class="p">.</span><span class="nx">Database</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">SetPipeline</span><span class="p">(</span><span class="nx">pipeline</span><span class="p">)</span>
	<span class="nx">stream</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">silent</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Collection</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// wait for change stream to init
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">doc</span> <span class="p">=</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">NewObjectID</span><span class="p">(),</span> <span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">InsertOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">doc</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">update</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span>
	<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{ &#34;$set&#34;: {&#34;year&#34;: 1998}}`</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">update</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">UpdateOne</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;_id&#34;</span><span class="p">:</span> <span class="nx">doc</span><span class="p">[</span><span class="s">&#34;_id&#34;</span><span class="p">]},</span> <span class="nx">update</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">DeleteMany</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&#34;hometown&#34;</span><span class="p">:</span> <span class="s">&#34;Atlanta&#34;</span><span class="p">})</span>
	<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span> <span class="c1">// wait for CS to print messages
</span><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nf">Drop</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>参考:<br>
<a href="https://blog.csdn.net/sdghchj/article/details/85249392">https://blog.csdn.net/sdghchj/article/details/85249392</a><br>
<a href="https://blog.fudenglong.site/2018/11/17/MongoDB-Go%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%A6%E4%B9%A0/">https://blog.fudenglong.site/2018/11/17/MongoDB-Go%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AD%A6%E4%B9%A0/</a><br>
<a href="https://blog.csdn.net/henreash/article/details/86745584">https://blog.csdn.net/henreash/article/details/86745584</a>
<a href="https://github.com/simagix/mongo-go-examples/tree/master/examples">https://github.com/simagix/mongo-go-examples/tree/master/examples</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
      <li><a href="/tags/mongodb/">MongoDB</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
