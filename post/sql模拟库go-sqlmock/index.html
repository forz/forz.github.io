<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Sql模拟库:go-sqlmock | Forz Blog</title>
<meta name="keywords" content="Go, go-sqlmock" />
<meta name="description" content="简介 sqlmock是一个实现sql/driver的模拟库。它有一个唯一的目的:在测试中模拟任何sql驱动程序行为，而无需真正的数据库连接。它">
<meta name="author" content="">
<link rel="canonical" href="/post/sql%E6%A8%A1%E6%8B%9F%E5%BA%93go-sqlmock/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Sql模拟库:go-sqlmock" />
<meta property="og:description" content="简介 sqlmock是一个实现sql/driver的模拟库。它有一个唯一的目的:在测试中模拟任何sql驱动程序行为，而无需真正的数据库连接。它" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/sql%E6%A8%A1%E6%8B%9F%E5%BA%93go-sqlmock/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-01-27T16:26:17&#43;00:00" />
<meta property="article:modified_time" content="2020-01-27T16:26:17&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Sql模拟库:go-sqlmock"/>
<meta name="twitter:description" content="简介 sqlmock是一个实现sql/driver的模拟库。它有一个唯一的目的:在测试中模拟任何sql驱动程序行为，而无需真正的数据库连接。它"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Sql模拟库:go-sqlmock",
      "item": "/post/sql%E6%A8%A1%E6%8B%9F%E5%BA%93go-sqlmock/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Sql模拟库:go-sqlmock",
  "name": "Sql模拟库:go-sqlmock",
  "description": "简介 sqlmock是一个实现sql/driver的模拟库。它有一个唯一的目的:在测试中模拟任何sql驱动程序行为，而无需真正的数据库连接。它",
  "keywords": [
    "Go", "go-sqlmock"
  ],
  "articleBody": "简介 sqlmock是一个实现sql/driver的模拟库。它有一个唯一的目的:在测试中模拟任何sql驱动程序行为，而无需真正的数据库连接。它有助于维护正确的TDD工作流程。\n 该库现在是完整且稳定的。（由于这个原因，您可能找不到新的更改） 支持并发和多个连接。 支持go1.8上下文相关的功能模拟和命名sql参数。 不需要对源代码进行任何修改。 该驱动程序允许模拟任何sql驱动程序方法行为。 默认情况下具有严格的期望顺序匹配。 没有第三方依赖性。  注意：在v1.2.0中， sqlmock.Rows已从接口更改为struct，如果您使用对该接口的任何类型引用，则需要将其切换为指针struct类型。另外，sqlmock.Rows用于实现driver.Rows 接口，该接口对于模拟不是必需的或有用的，因此已被删除。希望它不会引起问题。\nAPI Variables 1 2 3 4 5 6 7  var CSVColumnParser = func(s string) []byte { switch { case strings.ToLower(s) == \"null\": return nil } return []byte(s) }   CSVColumnParser是将修饰后的csv列字符串转换为[] byte表示形式的函数。当前将NULL转换为nil\n1  var ErrCancelled = errors.New(\"canceling query due to user request\")   ErrCancelled定义了一个错误值，在这种取消错误的情况下可以预期。\nfunc MonitorPingsOption 1  func MonitorPingsOption(monitorPings bool) func(*sqlmock) error   MonitorPingsOption确定是否应观察和模拟对驱动程序上Ping的调用。\n如果通过true，我们将检查这些调用是否正常。可以使用模拟中的ExpectPing（）方法来注册期望。\n如果传递了false或忽略了此选项，则在确定期望时将不考虑对Ping的调用，而对ExpectPing的调用则无效。\nfunc NewErrorResult 1  func NewErrorResult(err error) driver.Result   NewErrorResult创建一个新的sql驱动程序Result，该结果返回两个接口方法都给出的错误\n例\nCode:\n1 2 3 4 5 6  db, mock, _ := New() result := NewErrorResult(fmt.Errorf(\"some error\")) mock.ExpectExec(\"^INSERT (.+)\").WillReturnResult(result) res, _ := db.Exec(\"INSERT something\") _, err := res.LastInsertId() fmt.Println(err)   Output:\n1  some error   func NewResult 1  func NewResult(lastInsertID int64, rowsAffected int64) driver.Result   NewResult为基于Exec的查询模拟创建新的SQL驱动程序Result。\n例:\nCode:\n1 2 3 4  var lastInsertID, affected int64 result := NewResult(lastInsertID, affected) mock.ExpectExec(\"^INSERT (.+)\").WillReturnResult(result) fmt.Println(mock.ExpectationsWereMet())   Output:\n1 2 3 4 5 6  there is a remaining expectation which was not matched: ExpectedExec = expecting Exec or ExecContext which: - matches sql: '^INSERT (.+)' - is without arguments - should return Result having: LastInsertId: 0 RowsAffected: 0   func QueryMatcherOption 1  func QueryMatcherOption(queryMatcher QueryMatcher) func(*sqlmock) error   QueryMatcherOption允许自定义SQL查询匹配器，并以更复杂的方式匹配SQL查询字符串。默认的QueryMatcher是QueryMatcherRegexp。\nfunc ValueConverterOption 1  func ValueConverterOption(converter driver.ValueConverter) func(*sqlmock) error   ValueConverterOption允许使用自定义ValueConverter创建sqlmock连接，以支持具有特殊数据类型的驱动程序。\ntype Argument 1 2 3  type Argument interface { Match(driver.Value) bool }   当与ExpectedQuery和ExpectedExec期望一起使用时，Argument接口允许以特定方式匹配任何参数。\nfunc AnyArg 1  func AnyArg() Argument   AnyArg将返回一个可以匹配任何类型参数的Argument。\n对时间有用。时间或类似类型的参数。\ntype ExpectedBegin 1 2 3  type ExpectedBegin struct { // contains filtered or unexported fields }   ExpectedBegin用于管理* Sqlmock.ExpectBegin返回的* sql.DB.Begin期望。\nfunc (*ExpectedBegin) String 1  func (e *ExpectedBegin) String() string   字符串返回字符串表示形式\nfunc（* ExpectedBegin）WillDelayFor 1  func (e *ExpectedBegin) WillDelayFor(duration time.Duration) *ExpectedBegin   WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用\nfunc（* ExpectedBegin）WillReturnError 1  func (e *ExpectedBegin) WillReturnError(err error) *ExpectedBegin   WillReturnError允许为* sql.DB.Begin操作设置错误\ntype ExpectedClose 1 2 3  type ExpectedClose struct { // contains filtered or unexported fields }   ExpectedClose用于管理* Sqlmock.ExpectClose返回的* sql.DB.Close期望。\nfunc (*ExpectedClose) String 1  func (e *ExpectedClose) String() string   字符串返回字符串表示形式\nfunc（* ExpectedClose）WillReturnError 1  func (e *ExpectedClose) WillReturnError(err error) *ExpectedClose   WillReturnError允许为* sql.DB.Close操作设置错误\ntype ExpectedCommit 1 2 3  type ExpectedCommit struct { // contains filtered or unexported fields }   ExpectedCommit用于管理* Sqlmock.ExpectCommit返回的* sql.Tx.Commit期望。\nfunc (*ExpectedCommit) String 1  func (e *ExpectedCommit) String() string   字符串返回字符串表示形式\nfunc (*ExpectedCommit) WillReturnError 1  func (e *ExpectedCommit) WillReturnError(err error) *ExpectedCommit   WillReturnError允许为* sql.Tx.Close操作设置错误\ntype ExpectedExec 1 2 3  type ExpectedExec struct { // contains filtered or unexported fields }   ExpectedExec用于管理* sql.DB.Exec，* sql.Tx.Exec或* sql.Stmt.Exec期望。由* Sqlmock.ExpectExec返回。\n例\nCode:\n1 2 3 4 5 6  db, mock, _ := New() result := NewErrorResult(fmt.Errorf(\"some error\")) mock.ExpectExec(\"^INSERT (.+)\").WillReturnResult(result) res, _ := db.Exec(\"INSERT something\") _, err := res.LastInsertId() fmt.Println(err)   Output:\nsome error\nfunc (*ExpectedExec) String 1  func (e *ExpectedExec) String() string   字符串返回字符串表示形式\nfunc（* ExpectedExec）WillDelayFor 1  func (e *ExpectedExec) WillDelayFor(duration time.Duration) *ExpectedExec   WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用\nfunc (*ExpectedExec) WillReturnError 1  func (e *ExpectedExec) WillReturnError(err error) *ExpectedExec   WillReturnError允许为预期的数据库执行动作设置错误\nfunc（* ExpectedExec）WillReturnResult 1  func (e *ExpectedExec) WillReturnResult(result driver.Result) *ExpectedExec   WillReturnResult安排预期的Exec（）返回特定结果，存在sqlmock.NewResult（lastInsertID int64，受影响的行int64）方法来构建相应的结果。或者，如果需要针对错误sqlmock.NewErrorResult（err error）测试操作以返回给定的错误。\nfunc（* ExpectedExec）WithArgs 1  func (e *ExpectedExec) WithArgs(args ...driver.Value) *ExpectedExec   WithArgs将匹配给定的预期args与实际的数据库exec操作参数。如果至少一个参数不匹配，则将返回错误。对于特定的参数，可以使用sqlmock.Argument接口来匹配参数。\ntype ExpectedPing 1 2 3  type ExpectedPing struct { // contains filtered or unexported fields }   ExpectedPing用于管理* sql.DB.Ping期望。由* Sqlmock.ExpectPing返回。\nfunc (*ExpectedPing) String 1  func (e *ExpectedPing) String() string   字符串返回字符串表示形式\nfunc (*ExpectedPing) WillDelayFor 1  func (e *ExpectedPing) WillDelayFor(duration time.Duration) *ExpectedPing   WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用。\nfunc（* ExpectedPing）WillReturnError 1  func（e * ExpectedPing）WillReturnError（err error）* ExpectedPing   WillReturnError允许为预期的数据库ping设置错误\ntype ExpectedPrepare 1 2 3  type ExpectedPrepare struct { // contains filtered or unexported fields }   ExpectedPrepare用于管理* sql.DB.Prepare或* sql.Tx.Prepare期望。由* Sqlmock.ExpectPrepare返回。\nfunc（* ExpectedPrepare）ExpectExec 1  func（e * ExpectedPrepare）ExpectExec（）* ExpectedExec   ExpectExec允许在此准备好的语句上使用Exec（）。为了避免重复的sql查询字符串匹配，此方法很方便。\nfunc（* ExpectedPrepare）ExpectQuery 1  func（e * ExpectedPrepare）ExpectQuery（）* ExpectedQuery   ExpectQuery允许在此准备好的语句上使用Query（）或QueryRow（）。为了避免重复的sql查询字符串匹配，此方法很方便。\nfunc (*ExpectedPrepare) String 1  func (e *ExpectedPrepare) String() string   字符串返回字符串表示形式\nfunc（* ExpectedPrepare）WillBeClosed 1  func（e * ExpectedPrepare）WillBeClosed（）* ExpectedPrepare   WillBeClosed期望此准备好的语句将被关闭。\nfunc（* ExpectedPrepare）WillDelayFor 1  func (e *ExpectedPrepare) WillDelayFor(duration time.Duration) *ExpectedPrepare   WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用\nfunc（* ExpectedPrepare）WillReturnCloseError func（e * ExpectedPrepare）WillReturnCloseError（错误错误）* ExpectedPrepare WillReturnCloseError允许为此准备好的语句设置错误Close操作\nfunc（* ExpectedPrepare）WillReturnError 1  func (e *ExpectedPrepare) WillReturnError(err error) *ExpectedPrepare   WillReturnError允许为预期的* sql.DB.Prepare或* sql.Tx.Prepare操作设置错误。\ntype ExpectedQuery 1 2 3  type ExpectedQuery struct { // contains filtered or unexported fields }   ExpectedQuery用于管理* sql.DB.Query，* dql.DB.QueryRow，* sql.Tx.Query，* sql.Tx.QueryRow，* sql.Stmt.Query或* sql.Stmt.QueryRow期望。由* Sqlmock.ExpectQuery返回。\nfunc（* ExpectedQuery）RowsWillBeClosed 1  func（e * ExpectedQuery）RowsWillBeClosed（）* ExpectedQuery   RowsWillBeClosed期望此查询行被关闭。\nfunc (*ExpectedQuery) String 1  func (e *ExpectedQuery) String() string   字符串返回字符串表示形式\nfunc（* ExpectedQuery）WillDelayFor 1  func (e *ExpectedQuery) WillDelayFor(duration time.Duration) *ExpectedQuery   WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用\nfunc（* ExpectedQuery）WillReturnError 1  func (e *ExpectedQuery) WillReturnError(err error) *ExpectedQuery   WillReturnError允许为预期的数据库查询设置错误\nfunc（* ExpectedQuery）WillReturnRows 1  func（e * ExpectedQuery）WillReturnRows（rows ... * Rows）* ExpectedQuery   WillReturnRows指定将由触发的查询返回的结果行集\nfunc（* ExpectedQuery）WithArgs 1  func (e *ExpectedQuery) WithArgs(args ...driver.Value) *ExpectedQuery   WithArgs将匹配给定的预期args与实际的数据库查询参数。如果至少一个参数不匹配，则将返回错误。对于特定的参数，可以使用sqlmock.Argument接口来匹配参数。\ntype ExpectedRollback 1 2 3  type ExpectedRollback struct { // contains filtered or unexported fields }   ExpectedRollback用于管理* Sqlmock.ExpectRollback返回的* sql.Tx.Rollback期望。\nfunc (*ExpectedRollback) String 1  func (e *ExpectedRollback) String() string   字符串返回字符串表示形式\nfunc（* ExpectedRollback）WillReturnError 1  func (e *ExpectedRollback) WillReturnError(err error) *ExpectedRollback   WillReturnError允许为* sql.Tx.Rollback操作设置错误\ntype QueryMatcher 1 2 3 4 5 6  type QueryMatcher interface { // Match expected SQL query string without whitespace to  // actual SQL.  Match(expectedSQL, actualSQL string) error }   QueryMatcher是一个SQL查询字符串匹配器接口，可用于自定义SQL查询字符串的验证。例如，外部库可用于构建和验证所选的SQL ast列。\n可以自定义sqlmock以实现通过调用sqlmock.New或sqlmock.NewWithDSN时通过选项配置的其他QueryMatcher，默认QueryMatcher为QueryMatcherRegexp。\n1 2 3 4 5 6 7 8  var QueryMatcherEqual QueryMatcher = QueryMatcherFunc(func(expectedSQL, actualSQL string) error { expect := stripQuery(expectedSQL) actual := stripQuery(actualSQL) if actual != expect { return fmt.Errorf(`actual sql: \"%s\" does not equal to expected \"%s\"`, actual, expect) } return nil })   QueryMatcherEqual是SQL查询匹配器，它仅尝试对预期和实际的SQL字符串进行区分大小写的匹配，而无需空格。\n1 2 3 4 5 6 7 8 9 10 11 12  var QueryMatcherRegexp QueryMatcher = QueryMatcherFunc(func(expectedSQL, actualSQL string) error { expect := stripQuery(expectedSQL) actual := stripQuery(actualSQL) re, err := regexp.Compile(expect) if err != nil { return err } if !re.MatchString(actual) { return fmt.Errorf(`could not match actual sql: \"%s\" with expected regexp \"%s\"`, actual, re.String()) } return nil })   QueryMatcherRegexp是sqlmock使用的默认SQL查询匹配器。它将ExpectedSQL解析为一个正则表达式，并尝试匹配ActualSQL。\n例\nCode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  // configure to use case sensitive SQL query matcher // instead of default regular expression matcher db, mock, err := New(QueryMatcherOption(QueryMatcherEqual)) if err != nil { fmt.Println(\"failed to open sqlmock database:\", err) } defer db.Close() rows := NewRows([]string{\"id\", \"title\"}). AddRow(1, \"one\"). AddRow(2, \"two\") mock.ExpectQuery(\"SELECT * FROM users\").WillReturnRows(rows) rs, err := db.Query(\"SELECT * FROM users\") if err != nil { fmt.Println(\"failed to match expected query\") return } defer rs.Close() for rs.Next() { var id int var title string rs.Scan(\u0026id, \u0026title) fmt.Println(\"scanned id:\", id, \"and title:\", title) } if rs.Err() != nil { fmt.Println(\"got rows error:\", rs.Err()) }   Output:\n1 2  scanned id: 1 and title: one scanned id: 2 and title: two   type QueryMatcherFunc 1  type QueryMatcherFunc func(expectedSQL, actualSQL string) error   QueryMatcherFunc类型是一个适配器，允许将普通功能用作QueryMatcher。如果f是具有适当签名的函数，则QueryMatcherFunc（f）是调用f的QueryMatcher。\nunc (QueryMatcherFunc) Match 1  func (f QueryMatcherFunc) Match(expectedSQL, actualSQL string) error   Match实现QueryMatcher\ntype Rows 1 2 3  type Rows struct { // contains filtered or unexported fields }   行是要返回查询结果的行的模拟集合\n例\nCode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  db, mock, err := New() if err != nil { fmt.Println(\"failed to open sqlmock database:\", err) } defer db.Close() rows := NewRows([]string{\"id\", \"title\"}). AddRow(1, \"one\"). AddRow(2, \"two\") mock.ExpectQuery(\"SELECT\").WillReturnRows(rows) rs, _ := db.Query(\"SELECT\") defer rs.Close() for rs.Next() { var id int var title string rs.Scan(\u0026id, \u0026title) fmt.Println(\"scanned id:\", id, \"and title:\", title) } if rs.Err() != nil { fmt.Println(\"got rows error:\", rs.Err()) }   Output:\n1 2  scanned id: 1 and title: one scanned id: 2 and title: two   Example (CloseError)\nCode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  db, mock, err := New() if err != nil { fmt.Println(\"failed to open sqlmock database:\", err) } defer db.Close() rows := NewRows([]string{\"id\", \"title\"}).CloseError(fmt.Errorf(\"close error\")) mock.ExpectQuery(\"SELECT\").WillReturnRows(rows) rs, _ := db.Query(\"SELECT\") // Note: that close will return error only before rows EOF // that is a default sql package behavior. If you run rs.Next() // it will handle the error internally and return nil bellow if err := rs.Close(); err != nil { fmt.Println(\"got error:\", err) }   Output:\n1  got error: close error   Example (CustomDriverValue)\nCode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  db, mock, err := New() if err != nil { fmt.Println(\"failed to open sqlmock database:\", err) } defer db.Close() rows := NewRows([]string{\"id\", \"null_int\"}). AddRow(1, 7). AddRow(5, sql.NullInt64{Int64: 5, Valid: true}). AddRow(2, sql.NullInt64{}) mock.ExpectQuery(\"SELECT\").WillReturnRows(rows) rs, _ := db.Query(\"SELECT\") defer rs.Close() for rs.Next() { var id int var num sql.NullInt64 rs.Scan(\u0026id, \u0026num) fmt.Println(\"scanned id:\", id, \"and null int64:\", num) } if rs.Err() != nil { fmt.Println(\"got rows error:\", rs.Err()) }   Output:\n1 2 3  scanned id: 1 and null int64: {7 true} scanned id: 5 and null int64: {5 true} scanned id: 2 and null int64: {0 false}   Example (ExpectToBeClosed)\nCode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  db, mock, err := New() if err != nil { fmt.Println(\"failed to open sqlmock database:\", err) } defer db.Close() rows := NewRows([]string{\"id\", \"title\"}).AddRow(1, \"john\") mock.ExpectQuery(\"SELECT\").WillReturnRows(rows).RowsWillBeClosed() db.Query(\"SELECT\") if err := mock.ExpectationsWereMet(); err != nil { fmt.Println(\"got error:\", err) }   Output:\n1 2 3 4 5  got error: expected query rows to be closed, but it was not: ExpectedQuery = expecting Query, QueryContext or QueryRow which: - matches sql: 'SELECT' - is without arguments - should return rows: row 0 - [1 john]   Example (RawBytes)\nCode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  db, mock, err := New() if err != nil { fmt.Println(\"failed to open sqlmock database:\", err) } defer db.Close() rows := NewRows([]string{\"id\", \"binary\"}). AddRow(1, []byte(`one binary value with some text!`)). AddRow(2, []byte(`two binary value with even more text than the first one`)) mock.ExpectQuery(\"SELECT\").WillReturnRows(rows) rs, _ := db.Query(\"SELECT\") defer rs.Close() type scanned struct { id int raw sql.RawBytes } fmt.Println(\"initial read...\") var ss []scanned for rs.Next() { var s scanned rs.Scan(\u0026s.id, \u0026s.raw) ss = append(ss, s) fmt.Println(\"scanned id:\", s.id, \"and raw:\", string(s.raw)) } if rs.Err() != nil { fmt.Println(\"got rows error:\", rs.Err()) } fmt.Println(\"after reading all...\") for _, s := range ss { fmt.Println(\"scanned id:\", s.id, \"and raw:\", string(s.raw)) }   Output:\n1 2 3 4 5 6  initial read... scanned id: 1 and raw: one binary value with some text! scanned id: 2 and raw: two binary value with even more text than the first one after reading all... scanned id: 1 and raw: ☠☠☠ MEMORY OVERWRITTEN ☠ scanned id: 2 and raw: ☠☠☠ MEMORY OVERWRITTEN ☠☠☠ ☠☠☠ MEMORY   Example (RowError)\nCode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  db, mock, err := New() if err != nil { fmt.Println(\"failed to open sqlmock database:\", err) } defer db.Close() rows := NewRows([]string{\"id\", \"title\"}). AddRow(0, \"one\"). AddRow(1, \"two\"). RowError(1, fmt.Errorf(\"row error\")) mock.ExpectQuery(\"SELECT\").WillReturnRows(rows) rs, _ := db.Query(\"SELECT\") defer rs.Close() for rs.Next() { var id int var title string rs.Scan(\u0026id, \u0026title) fmt.Println(\"scanned id:\", id, \"and title:\", title) } if rs.Err() != nil { fmt.Println(\"got rows error:\", rs.Err()) }   Output:\n1 2  scanned id: 0 and title: one got rows error: row error   func NewRows 1  func NewRows(columns []string) *Rows   NewRows允许从sql driver.Value切片或CSV字符串创建行，并用作sql driver.Rows。如果使用自定义转换器，请改用Sqlmock.NewRows\nfunc（* Rows）AddRow 1  func (r *Rows) AddRow(values ...driver.Value) *Rows   由数据库driver.Value切片组成的AddRow返回相同的实例以执行后续操作。请注意，值的数量必须与列数匹配\nfunc (*Rows) CloseError 1  func (r *Rows) CloseError(err error) *Rows   CloseError允许设置将由rows.Close函数返回的错误。\n仅当还没有达到rows.Next（）EOF时才触发关闭错误，这是默认的sql库行为\nfunc (*Rows) FromCSVString 1  func (r *Rows) FromCSVString(s string) *Rows   FromCSVString从csv字符串构建行。返回相同的实例以执行后续操作。请注意，值的数量必须与列数匹配\nfunc（* Rows）RowError 1  func (r *Rows) RowError(row int, err error) *Rows   RowError允许设置一个错误，当读取给定的行号时将返回此错误\ntype Sqlmock 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  type Sqlmock interface { // ExpectClose queues an expectation for this database  // action to be triggered. the *ExpectedClose allows  // to mock database response  ExpectClose() *ExpectedClose // ExpectationsWereMet checks whether all queued expectations  // were met in order. If any of them was not met - an error is returned.  ExpectationsWereMet() error // ExpectPrepare expects Prepare() to be called with expectedSQL query.  // the *ExpectedPrepare allows to mock database response.  // Note that you may expect Query() or Exec() on the *ExpectedPrepare  // statement to prevent repeating expectedSQL  ExpectPrepare(expectedSQL string) *ExpectedPrepare // ExpectQuery expects Query() or QueryRow() to be called with expectedSQL query.  // the *ExpectedQuery allows to mock database response.  ExpectQuery(expectedSQL string) *ExpectedQuery // ExpectExec expects Exec() to be called with expectedSQL query.  // the *ExpectedExec allows to mock database response  ExpectExec(expectedSQL string) *ExpectedExec // ExpectBegin expects *sql.DB.Begin to be called.  // the *ExpectedBegin allows to mock database response  ExpectBegin() *ExpectedBegin // ExpectCommit expects *sql.Tx.Commit to be called.  // the *ExpectedCommit allows to mock database response  ExpectCommit() *ExpectedCommit // ExpectRollback expects *sql.Tx.Rollback to be called.  // the *ExpectedRollback allows to mock database response  ExpectRollback() *ExpectedRollback // ExpectPing expected *sql.DB.Ping to be called.  // the *ExpectedPing allows to mock database response  //  // Ping support only exists in the SQL library in Go 1.8 and above.  // ExpectPing in Go  // any expectations.  //  // You must enable pings using MonitorPingsOption for this to register  // any expectations.  ExpectPing() *ExpectedPing // MatchExpectationsInOrder gives an option whether to match all  // expectations in the order they were set or not.  //  // By default it is set to - true. But if you use goroutines  // to parallelize your query executation, that option may  // be handy.  //  // This option may be turned on anytime during tests. As soon  // as it is switched to false, expectations will be matched  // in any order. Or otherwise if switched to true, any unmatched  // expectations will be expected in order  MatchExpectationsInOrder(bool) // NewRows allows Rows to be created from a  // sql driver.Value slice or from the CSV string and  // to be used as sql driver.Rows.  NewRows(columns []string) *Rows }   Sqlmock接口用于为任何类型的数据库操作创建期望，以便模拟和测试实际的数据库行为。\n示例（Goroutines）\nCode:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  db, mock, err := New() if err != nil { fmt.Println(\"failed to open sqlmock database:\", err) } defer db.Close() // note this line is important for unordered expectation matching mock.MatchExpectationsInOrder(false) result := NewResult(1, 1) mock.ExpectExec(\"^UPDATE one\").WithArgs(\"one\").WillReturnResult(result) mock.ExpectExec(\"^UPDATE two\").WithArgs(\"one\", \"two\").WillReturnResult(result) mock.ExpectExec(\"^UPDATE three\").WithArgs(\"one\", \"two\", \"three\").WillReturnResult(result) var wg sync.WaitGroup queries := map[string][]interface{}{ \"one\": {\"one\"}, \"two\": {\"one\", \"two\"}, \"three\": {\"one\", \"two\", \"three\"}, } wg.Add(len(queries)) for table, args := range queries { go func(tbl string, a []interface{}) { if _, err := db.Exec(\"UPDATE \"+tbl, a...); err != nil { fmt.Println(\"error was not expected:\", err) } wg.Done() }(table, args) } wg.Wait() if err := mock.ExpectationsWereMet(); err != nil { fmt.Println(\"there were unfulfilled expectations:\", err) }   func New 1  func New(options ...func(*sqlmock) error) (*sql.DB, Sqlmock, error)   New创建sqlmock数据库连接和一个模拟来管理期望。接受诸如ValueConverterOption之类的选项，以使用特定驱动程序中的ValueConverter。Pings db，以便可以肯定所有期望。\n例\n1 2 3 4 5 6 7 8  db, mock, err := New() if err != nil { fmt.Println(\"expected no error, but got:\", err) return } defer db.Close() // now we can expect operations performed on db mock.ExpectBegin().WillReturnError(fmt.Errorf(\"an error will occur on db.Begin() call\"))   func NewWithDSN 1  func NewWithDSN(dsn string, options ...func(*sqlmock) error) (*sql.DB, Sqlmock, error)   NewWithDSN创建具有特定DSN的sqlmock数据库连接以及用于管理期望的模拟。接受诸如ValueConverterOption之类的选项，以使用特定驱动程序中的ValueConverter。Pings db，以便可以肯定所有期望。\n由于sql抽象库而引入了此方法，该库没有提供使用sql.DB实例进行初始化的方法。例如GORM库。\n注意，如果尝试使用已经使用过的dsn进行创建，则会出错\n不建议使用此方法，除非您确实需要它并且没有其他方法可以使用。\n举例 假设您使用go-mysql-driver，可以尝试一下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  package main import ( \"database/sql\" _ \"github.com/go-sql-driver/mysql\" ) func recordStats(db *sql.DB, userID, productID int64) (err error) { tx, err := db.Begin() if err != nil { return } defer func() { switch err { case nil: err = tx.Commit() default: tx.Rollback() } }() if _, err = tx.Exec(\"UPDATE products SET views = views + 1\"); err != nil { return } if _, err = tx.Exec(\"INSERT INTO product_viewers (user_id, product_id) VALUES (?, ?)\", userID, productID); err != nil { return } return } func main() { // @NOTE: the real connection is not required for tests \tdb, err := sql.Open(\"mysql\", \"root@/blog\") if err != nil { panic(err) } defer db.Close() if err = recordStats(db, 1 /*some user id*/, 5 /*some product id*/); err != nil { panic(err) } }   用sqlmock测试:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  package main import ( \"fmt\" \"testing\" \"github.com/DATA-DOG/go-sqlmock\" ) // a successful case func TestShouldUpdateStats(t *testing.T) { db, mock, err := sqlmock.New() if err != nil { t.Fatalf(\"an error '%s' was not expected when opening a stub database connection\", err) } defer db.Close() mock.ExpectBegin() mock.ExpectExec(\"UPDATE products\").WillReturnResult(sqlmock.NewResult(1, 1)) mock.ExpectExec(\"INSERT INTO product_viewers\").WithArgs(2, 3).WillReturnResult(sqlmock.NewResult(1, 1)) mock.ExpectCommit() // now we execute our method \tif err = recordStats(db, 2, 3); err != nil { t.Errorf(\"error was not expected while updating stats: %s\", err) } // we make sure that all expectations were met \tif err := mock.ExpectationsWereMet(); err != nil { t.Errorf(\"there were unfulfilled expectations: %s\", err) } } // a failing test case func TestShouldRollbackStatUpdatesOnFailure(t *testing.T) { db, mock, err := sqlmock.New() if err != nil { t.Fatalf(\"an error '%s' was not expected when opening a stub database connection\", err) } defer db.Close() mock.ExpectBegin() mock.ExpectExec(\"UPDATE products\").WillReturnResult(sqlmock.NewResult(1, 1)) mock.ExpectExec(\"INSERT INTO product_viewers\"). WithArgs(2, 3). WillReturnError(fmt.Errorf(\"some error\")) mock.ExpectRollback() // now we execute our method \tif err = recordStats(db, 2, 3); err == nil { t.Errorf(\"was expecting an error, but there was none\") } // we make sure that all expectations were met \tif err := mock.ExpectationsWereMet(); err != nil { t.Errorf(\"there were unfulfilled expectations: %s\", err) } }   自定义SQL查询匹配 用户提出了许多有关SQL查询字符串验证或不同匹配选项的请求。现在QueryMatcher，我们已经实现了接口，可以在调用sqlmock.New或sqlmock.NewWithDSN时通过选项传递该接口 。\n现在，这允许包括一些库，该库将允许例如解析和验证mysqlSQL AST。并创建一个自定义QueryMatcher以便以复杂的方式验证SQL。\n默认情况下，sqlmock保留向后兼容性，默认查询匹配器sqlmock.QueryMatcherRegexp 使用期望的SQL字符串作为正则表达式来匹配传入的查询字符串。有一个相等匹配器： QueryMatcherEqual它将进行完全区分大小写的匹配。\n为了自定义QueryMatcher，请使用以下命令：\n1  db, mock, err := sqlmock.New(sqlmock.QueryMatcherOption(sqlmock.QueryMatcherEqual))   可以根据用户需求完全定制查询匹配器。sqlmock将不提供标准的sql解析匹配器，因为各种驱动程序可能不遵循相同的SQL标准。\n示例解析如下图：\n看看实际情况中需要注意的点：\n  初始化sqlmock后，需要将sqlmock的db实例赋值给实际调用的数据库，如下图所示：\n稍微仔细思考下也能够理解，官网给的示例初始化sqlmock后都没有指定要mock哪个db，显然会抛异常。\n  如何mock返回错误？\n使用WillReturnError方法构造返回错误，如下图所示：\n  匹配参数如time.Time 可能存在某些struct类型的参数，无法通过值轻易地将其进行比较time.Time。在这种情况下， sqlmock提供了一个Argument接口，可以在更复杂的匹配中使用它。这是时间参数匹配的一个简单示例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  type AnyTime struct{} // Match satisfies sqlmock.Argument interface func (a AnyTime) Match(v driver.Value) bool { _, ok := v.(time.Time) return ok } func TestAnyTimeArgument(t *testing.T) { t.Parallel() db, mock, err := New() if err != nil { t.Errorf(\"an error '%s' was not expected when opening a stub database connection\", err) } defer db.Close() mock.ExpectExec(\"INSERT INTO users\"). WithArgs(\"john\", AnyTime{}). WillReturnResult(NewResult(1, 1)) _, err = db.Exec(\"INSERT INTO users(name, created_at) VALUES (?, ?)\", \"john\", time.Now()) if err != nil { t.Errorf(\"error '%s' was not expected, while inserting a row\", err) } if err := mock.ExpectationsWereMet(); err != nil { t.Errorf(\"there were unfulfilled expectations: %s\", err) } }   它仅断言该参数是time.Time类型。\ngomonkey与sqlmock gomonkey的ApplyMethod方法能不能替代sqlmock？不能！\n如下图：被测方法为detailDb.Query（），如果使用gomonkey进行mock，则需要重新query方法：\nQuery方法的入参和出参如下图：出参包含Rows参数\n再来看看Rows结构体，会发现里面的结构十分复杂，根本无法手工构造想要的数据。\n综上，在示例特定场景下，无法使用gomonkey来替代sqlmock\n场景覆盖 sqlmock是否能覆盖所有sql场景？\n目前发现开发底层都使用\"github.com/go-sql-driver/mysql\"数据库，都能够使用sqlmock库进行mock\n参考:\nhttps://kknews.cc/code/jl83xne.html\n",
  "wordCount" : "8759",
  "inLanguage": "zh-cn",
  "datePublished": "2020-01-27T16:26:17Z",
  "dateModified": "2020-01-27T16:26:17Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/sql%E6%A8%A1%E6%8B%9F%E5%BA%93go-sqlmock/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Sql模拟库:go-sqlmock
    </h1>
    <div class="post-meta">January 27, 2020
</div>
  </header> 
  <div class="post-content"><h1 id="简介">简介<a hidden class="anchor" aria-hidden="true" href="#简介">#</a></h1>
<p>sqlmock是一个实现<a href="https://godoc.org/database/sql/driver">sql/driver</a>的模拟库。它有一个唯一的目的:在测试中模拟任何sql驱动程序行为，而无需真正的数据库连接。它有助于维护正确的TDD工作流程。</p>
<ul>
<li>该库现在是完整且稳定的。（由于这个原因，您可能找不到新的更改）</li>
<li>支持并发和多个连接。</li>
<li>支持go1.8上下文相关的功能模拟和命名sql参数。</li>
<li>不需要对源代码进行任何修改。</li>
<li>该驱动程序允许模拟任何sql驱动程序方法行为。</li>
<li>默认情况下具有严格的期望顺序匹配。</li>
<li>没有第三方依赖性。</li>
</ul>
<p>注意：在v1.2.0中， <code>sqlmock.Rows</code>已从接口更改为<code>struct</code>，如果您使用对该接口的任何类型引用，则需要将其切换为指针<code>struct</code>类型。另外，<code>sqlmock.Rows</code>用于实现driver.Rows 接口，该接口对于模拟不是必需的或有用的，因此已被删除。希望它不会引起问题。</p>
<h1 id="api">API<a hidden class="anchor" aria-hidden="true" href="#api">#</a></h1>
<h2 id="variables">Variables<a hidden class="anchor" aria-hidden="true" href="#variables">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">CSVColumnParser</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;null&#34;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>CSVColumnParser是将修饰后的csv列字符串转换为[] byte表示形式的函数。当前将NULL转换为nil</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">ErrCancelled</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;canceling query due to user request&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>ErrCancelled定义了一个错误值，在这种取消错误的情况下可以预期。</p>
<h1 id="func-monitorpingsoption">func MonitorPingsOption<a hidden class="anchor" aria-hidden="true" href="#func-monitorpingsoption">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">MonitorPingsOption</span><span class="p">(</span><span class="nx">monitorPings</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">sqlmock</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></td></tr></table>
</div>
</div><p>MonitorPingsOption确定是否应观察和模拟对驱动程序上Ping的调用。</p>
<p>如果通过true，我们将检查这些调用是否正常。可以使用模拟中的ExpectPing（）方法来注册期望。</p>
<p>如果传递了false或忽略了此选项，则在确定期望时将不考虑对Ping的调用，而对ExpectPing的调用则无效。</p>
<h1 id="func-newerrorresult">func NewErrorResult<a hidden class="anchor" aria-hidden="true" href="#func-newerrorresult">#</a></h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewErrorResult</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">Result</span>
</code></pre></td></tr></table>
</div>
</div><p>NewErrorResult创建一个新的sql驱动程序Result，该结果返回两个接口方法都给出的错误</p>
<p>例</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="nx">result</span> <span class="o">:=</span> <span class="nf">NewErrorResult</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;some error&#34;</span><span class="p">))</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^INSERT (.+)&#34;</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;INSERT something&#34;</span><span class="p">)</span>
<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">res</span><span class="p">.</span><span class="nf">LastInsertId</span><span class="p">()</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">some</span> <span class="kt">error</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="func-newresult">func NewResult<a hidden class="anchor" aria-hidden="true" href="#func-newresult">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewResult</span><span class="p">(</span><span class="nx">lastInsertID</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">rowsAffected</span> <span class="kt">int64</span><span class="p">)</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">Result</span>
</code></pre></td></tr></table>
</div>
</div><p>NewResult为基于Exec的查询模拟创建新的SQL驱动程序Result。</p>
<p>例:</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">lastInsertID</span><span class="p">,</span> <span class="nx">affected</span> <span class="kt">int64</span>
<span class="nx">result</span> <span class="o">:=</span> <span class="nf">NewResult</span><span class="p">(</span><span class="nx">lastInsertID</span><span class="p">,</span> <span class="nx">affected</span><span class="p">)</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^INSERT (.+)&#34;</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectationsWereMet</span><span class="p">())</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">there</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">remaining</span> <span class="nx">expectation</span> <span class="nx">which</span> <span class="nx">was</span> <span class="nx">not</span> <span class="nx">matched</span><span class="p">:</span> <span class="nx">ExpectedExec</span> <span class="p">=&gt;</span> <span class="nx">expecting</span> <span class="nx">Exec</span> <span class="nx">or</span> <span class="nx">ExecContext</span> <span class="nx">which</span><span class="p">:</span>
  <span class="o">-</span> <span class="nx">matches</span> <span class="nx">sql</span><span class="p">:</span> <span class="err">&#39;</span><span class="p">^</span><span class="nf">INSERT</span> <span class="p">(.</span><span class="o">+</span><span class="p">)</span><span class="err">&#39;</span>
  <span class="o">-</span> <span class="nx">is</span> <span class="nx">without</span> <span class="nx">arguments</span>
  <span class="o">-</span> <span class="nx">should</span> <span class="k">return</span> <span class="nx">Result</span> <span class="nx">having</span><span class="p">:</span>
      <span class="nx">LastInsertId</span><span class="p">:</span> <span class="mi">0</span>
      <span class="nx">RowsAffected</span><span class="p">:</span> <span class="mi">0</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="func-querymatcheroption">func QueryMatcherOption<a hidden class="anchor" aria-hidden="true" href="#func-querymatcheroption">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">QueryMatcherOption</span><span class="p">(</span><span class="nx">queryMatcher</span> <span class="nx">QueryMatcher</span><span class="p">)</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">sqlmock</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></td></tr></table>
</div>
</div><p>QueryMatcherOption允许自定义SQL查询匹配器，并以更复杂的方式匹配SQL查询字符串。默认的QueryMatcher是QueryMatcherRegexp。</p>
<h2 id="func-valueconverteroption">func ValueConverterOption<a hidden class="anchor" aria-hidden="true" href="#func-valueconverteroption">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">ValueConverterOption</span><span class="p">(</span><span class="nx">converter</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">ValueConverter</span><span class="p">)</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">sqlmock</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></td></tr></table>
</div>
</div><p>ValueConverterOption允许使用自定义ValueConverter创建sqlmock连接，以支持具有特殊数据类型的驱动程序。</p>
<h2 id="type-argument">type Argument<a hidden class="anchor" aria-hidden="true" href="#type-argument">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Argument</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Match</span><span class="p">(</span><span class="nx">driver</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="kt">bool</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>当与ExpectedQuery和ExpectedExec期望一起使用时，Argument接口允许以特定方式匹配任何参数。</p>
<h3 id="func-anyarg">func AnyArg<a hidden class="anchor" aria-hidden="true" href="#func-anyarg">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">AnyArg</span><span class="p">()</span> <span class="nx">Argument</span>
</code></pre></td></tr></table>
</div>
</div><p>AnyArg将返回一个可以匹配任何类型参数的Argument。</p>
<p>对时间有用。时间或类似类型的参数。</p>
<h2 id="type-expectedbegin">type ExpectedBegin<a hidden class="anchor" aria-hidden="true" href="#type-expectedbegin">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ExpectedBegin</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectedBegin用于管理* Sqlmock.ExpectBegin返回的* sql.DB.Begin期望。</p>
<h3 id="func-expectedbegin-string">func (*ExpectedBegin) String<a hidden class="anchor" aria-hidden="true" href="#func-expectedbegin-string">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedBegin</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>字符串返回字符串表示形式</p>
<h3 id="func-expectedbeginwilldelayfor">func（* ExpectedBegin）WillDelayFor<a hidden class="anchor" aria-hidden="true" href="#func-expectedbeginwilldelayfor">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedBegin</span><span class="p">)</span> <span class="nf">WillDelayFor</span><span class="p">(</span><span class="nx">duration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedBegin</span>
</code></pre></td></tr></table>
</div>
</div><p>WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用</p>
<h3 id="func-expectedbeginwillreturnerror">func（* ExpectedBegin）WillReturnError<a hidden class="anchor" aria-hidden="true" href="#func-expectedbeginwillreturnerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedBegin</span><span class="p">)</span> <span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedBegin</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnError允许为* sql.DB.Begin操作设置错误</p>
<h2 id="type-expectedclose">type ExpectedClose<a hidden class="anchor" aria-hidden="true" href="#type-expectedclose">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ExpectedClose</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectedClose用于管理* Sqlmock.ExpectClose返回的* sql.DB.Close期望。</p>
<h3 id="func-expectedclose-string">func (*ExpectedClose) String<a hidden class="anchor" aria-hidden="true" href="#func-expectedclose-string">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedClose</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>字符串返回字符串表示形式</p>
<h3 id="func-expectedclosewillreturnerror">func（* ExpectedClose）WillReturnError<a hidden class="anchor" aria-hidden="true" href="#func-expectedclosewillreturnerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedClose</span><span class="p">)</span> <span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedClose</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnError允许为* sql.DB.Close操作设置错误</p>
<h2 id="type-expectedcommit">type ExpectedCommit<a hidden class="anchor" aria-hidden="true" href="#type-expectedcommit">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ExpectedCommit</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectedCommit用于管理* Sqlmock.ExpectCommit返回的* sql.Tx.Commit期望。</p>
<h3 id="func-expectedcommit-string">func (*ExpectedCommit) String<a hidden class="anchor" aria-hidden="true" href="#func-expectedcommit-string">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedCommit</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>字符串返回字符串表示形式</p>
<h3 id="func-expectedcommit-willreturnerror">func (*ExpectedCommit) WillReturnError<a hidden class="anchor" aria-hidden="true" href="#func-expectedcommit-willreturnerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedCommit</span><span class="p">)</span> <span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedCommit</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnError允许为* sql.Tx.Close操作设置错误</p>
<h2 id="type-expectedexec">type ExpectedExec<a hidden class="anchor" aria-hidden="true" href="#type-expectedexec">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ExpectedExec</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectedExec用于管理* sql.DB.Exec，* sql.Tx.Exec或* sql.Stmt.Exec期望。由* Sqlmock.ExpectExec返回。</p>
<p>例</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="nx">result</span> <span class="o">:=</span> <span class="nf">NewErrorResult</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;some error&#34;</span><span class="p">))</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^INSERT (.+)&#34;</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;INSERT something&#34;</span><span class="p">)</span>
<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">res</span><span class="p">.</span><span class="nf">LastInsertId</span><span class="p">()</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<p>some error</p>
<h3 id="func-expectedexec-string">func (*ExpectedExec) String<a hidden class="anchor" aria-hidden="true" href="#func-expectedexec-string">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedExec</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>字符串返回字符串表示形式</p>
<h3 id="func-expectedexecwilldelayfor">func（* ExpectedExec）WillDelayFor<a hidden class="anchor" aria-hidden="true" href="#func-expectedexecwilldelayfor">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedExec</span><span class="p">)</span> <span class="nf">WillDelayFor</span><span class="p">(</span><span class="nx">duration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedExec</span>
</code></pre></td></tr></table>
</div>
</div><p>WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用</p>
<h3 id="func-expectedexec-willreturnerror">func (*ExpectedExec) WillReturnError<a hidden class="anchor" aria-hidden="true" href="#func-expectedexec-willreturnerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedExec</span><span class="p">)</span> <span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedExec</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnError允许为预期的数据库执行动作设置错误</p>
<h3 id="func-expectedexecwillreturnresult">func（* ExpectedExec）WillReturnResult<a hidden class="anchor" aria-hidden="true" href="#func-expectedexecwillreturnresult">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedExec</span><span class="p">)</span> <span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">result</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">Result</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedExec</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnResult安排预期的Exec（）返回特定结果，存在sqlmock.NewResult（lastInsertID int64，受影响的行int64）方法来构建相应的结果。或者，如果需要针对错误sqlmock.NewErrorResult（err error）测试操作以返回给定的错误。</p>
<h3 id="func-expectedexecwithargs">func（* ExpectedExec）WithArgs<a hidden class="anchor" aria-hidden="true" href="#func-expectedexecwithargs">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedExec</span><span class="p">)</span> <span class="nf">WithArgs</span><span class="p">(</span><span class="nx">args</span> <span class="o">...</span><span class="nx">driver</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedExec</span>
</code></pre></td></tr></table>
</div>
</div><p>WithArgs将匹配给定的预期args与实际的数据库exec操作参数。如果至少一个参数不匹配，则将返回错误。对于特定的参数，可以使用sqlmock.Argument接口来匹配参数。</p>
<h2 id="type-expectedping">type ExpectedPing<a hidden class="anchor" aria-hidden="true" href="#type-expectedping">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ExpectedPing</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectedPing用于管理* sql.DB.Ping期望。由* Sqlmock.ExpectPing返回。</p>
<h3 id="func-expectedping-string">func (*ExpectedPing) String<a hidden class="anchor" aria-hidden="true" href="#func-expectedping-string">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedPing</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>字符串返回字符串表示形式</p>
<h3 id="func-expectedping-willdelayfor">func (*ExpectedPing) WillDelayFor<a hidden class="anchor" aria-hidden="true" href="#func-expectedping-willdelayfor">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedPing</span><span class="p">)</span> <span class="nf">WillDelayFor</span><span class="p">(</span><span class="nx">duration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedPing</span>
</code></pre></td></tr></table>
</div>
</div><p>WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用。</p>
<h3 id="func-expectedpingwillreturnerror">func（* ExpectedPing）WillReturnError<a hidden class="anchor" aria-hidden="true" href="#func-expectedpingwillreturnerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span><span class="err">（</span><span class="nx">e</span> <span class="o">*</span> <span class="nx">ExpectedPing</span><span class="err">）</span><span class="nx">WillReturnError</span><span class="err">（</span><span class="nx">err</span> <span class="kt">error</span><span class="err">）</span><span class="o">*</span> <span class="nx">ExpectedPing</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnError允许为预期的数据库ping设置错误</p>
<h2 id="type-expectedprepare">type ExpectedPrepare<a hidden class="anchor" aria-hidden="true" href="#type-expectedprepare">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ExpectedPrepare</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectedPrepare用于管理* sql.DB.Prepare或* sql.Tx.Prepare期望。由* Sqlmock.ExpectPrepare返回。</p>
<h3 id="func-expectedprepareexpectexec">func（* ExpectedPrepare）ExpectExec<a hidden class="anchor" aria-hidden="true" href="#func-expectedprepareexpectexec">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span><span class="err">（</span><span class="nx">e</span> <span class="o">*</span> <span class="nx">ExpectedPrepare</span><span class="err">）</span><span class="nx">ExpectExec</span><span class="err">（）</span><span class="o">*</span> <span class="nx">ExpectedExec</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectExec允许在此准备好的语句上使用Exec（）。为了避免重复的sql查询字符串匹配，此方法很方便。</p>
<h3 id="func-expectedprepareexpectquery">func（* ExpectedPrepare）ExpectQuery<a hidden class="anchor" aria-hidden="true" href="#func-expectedprepareexpectquery">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span><span class="err">（</span><span class="nx">e</span> <span class="o">*</span> <span class="nx">ExpectedPrepare</span><span class="err">）</span><span class="nx">ExpectQuery</span><span class="err">（）</span><span class="o">*</span> <span class="nx">ExpectedQuery</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectQuery允许在此准备好的语句上使用Query（）或QueryRow（）。为了避免重复的sql查询字符串匹配，此方法很方便。</p>
<h3 id="func-expectedprepare-string">func (*ExpectedPrepare) String<a hidden class="anchor" aria-hidden="true" href="#func-expectedprepare-string">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedPrepare</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>字符串返回字符串表示形式</p>
<h3 id="func-expectedpreparewillbeclosed">func（* ExpectedPrepare）WillBeClosed<a hidden class="anchor" aria-hidden="true" href="#func-expectedpreparewillbeclosed">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span><span class="err">（</span><span class="nx">e</span> <span class="o">*</span> <span class="nx">ExpectedPrepare</span><span class="err">）</span><span class="nx">WillBeClosed</span><span class="err">（）</span><span class="o">*</span> <span class="nx">ExpectedPrepare</span>
</code></pre></td></tr></table>
</div>
</div><p>WillBeClosed期望此准备好的语句将被关闭。</p>
<h3 id="func-expectedpreparewilldelayfor">func（* ExpectedPrepare）WillDelayFor<a hidden class="anchor" aria-hidden="true" href="#func-expectedpreparewilldelayfor">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedPrepare</span><span class="p">)</span> <span class="nf">WillDelayFor</span><span class="p">(</span><span class="nx">duration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedPrepare</span>
</code></pre></td></tr></table>
</div>
</div><p>WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用</p>
<h3 id="func-expectedpreparewillreturncloseerror">func（* ExpectedPrepare）WillReturnCloseError<a hidden class="anchor" aria-hidden="true" href="#func-expectedpreparewillreturncloseerror">#</a></h3>
<p>func（e * ExpectedPrepare）WillReturnCloseError（错误错误）* ExpectedPrepare
WillReturnCloseError允许为此准备好的语句设置错误Close操作</p>
<h3 id="func-expectedpreparewillreturnerror">func（* ExpectedPrepare）WillReturnError<a hidden class="anchor" aria-hidden="true" href="#func-expectedpreparewillreturnerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedPrepare</span><span class="p">)</span> <span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedPrepare</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnError允许为预期的* sql.DB.Prepare或* sql.Tx.Prepare操作设置错误。</p>
<h2 id="type-expectedquery">type ExpectedQuery<a hidden class="anchor" aria-hidden="true" href="#type-expectedquery">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ExpectedQuery</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectedQuery用于管理* sql.DB.Query，* dql.DB.QueryRow，* sql.Tx.Query，* sql.Tx.QueryRow，* sql.Stmt.Query或* sql.Stmt.QueryRow期望。由* Sqlmock.ExpectQuery返回。</p>
<h3 id="func-expectedqueryrowswillbeclosed">func（* ExpectedQuery）RowsWillBeClosed<a hidden class="anchor" aria-hidden="true" href="#func-expectedqueryrowswillbeclosed">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span><span class="err">（</span><span class="nx">e</span> <span class="o">*</span> <span class="nx">ExpectedQuery</span><span class="err">）</span><span class="nx">RowsWillBeClosed</span><span class="err">（）</span><span class="o">*</span> <span class="nx">ExpectedQuery</span>
</code></pre></td></tr></table>
</div>
</div><p>RowsWillBeClosed期望此查询行被关闭。</p>
<h3 id="func-expectedquery-string">func (*ExpectedQuery) String<a hidden class="anchor" aria-hidden="true" href="#func-expectedquery-string">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedQuery</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>字符串返回字符串表示形式</p>
<h3 id="func-expectedquerywilldelayfor">func（* ExpectedQuery）WillDelayFor<a hidden class="anchor" aria-hidden="true" href="#func-expectedquerywilldelayfor">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedQuery</span><span class="p">)</span> <span class="nf">WillDelayFor</span><span class="p">(</span><span class="nx">duration</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedQuery</span>
</code></pre></td></tr></table>
</div>
</div><p>WillDelayFor允许指定延迟结果的持续时间。可以与context一起使用</p>
<h3 id="func-expectedquerywillreturnerror">func（* ExpectedQuery）WillReturnError<a hidden class="anchor" aria-hidden="true" href="#func-expectedquerywillreturnerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedQuery</span><span class="p">)</span> <span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedQuery</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnError允许为预期的数据库查询设置错误</p>
<h3 id="func-expectedquerywillreturnrows">func（* ExpectedQuery）WillReturnRows<a hidden class="anchor" aria-hidden="true" href="#func-expectedquerywillreturnrows">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span><span class="err">（</span><span class="nx">e</span> <span class="o">*</span> <span class="nx">ExpectedQuery</span><span class="err">）</span><span class="nx">WillReturnRows</span><span class="err">（</span><span class="nx">rows</span> <span class="o">...</span> <span class="o">*</span> <span class="nx">Rows</span><span class="err">）</span><span class="o">*</span> <span class="nx">ExpectedQuery</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnRows指定将由触发的查询返回的结果行集</p>
<h3 id="func-expectedquerywithargs">func（* ExpectedQuery）WithArgs<a hidden class="anchor" aria-hidden="true" href="#func-expectedquerywithargs">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedQuery</span><span class="p">)</span> <span class="nf">WithArgs</span><span class="p">(</span><span class="nx">args</span> <span class="o">...</span><span class="nx">driver</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedQuery</span>
</code></pre></td></tr></table>
</div>
</div><p>WithArgs将匹配给定的预期args与实际的数据库查询参数。如果至少一个参数不匹配，则将返回错误。对于特定的参数，可以使用sqlmock.Argument接口来匹配参数。</p>
<h2 id="type-expectedrollback">type ExpectedRollback<a hidden class="anchor" aria-hidden="true" href="#type-expectedrollback">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">ExpectedRollback</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ExpectedRollback用于管理* Sqlmock.ExpectRollback返回的* sql.Tx.Rollback期望。</p>
<h3 id="func-expectedrollback-string">func (*ExpectedRollback) String<a hidden class="anchor" aria-hidden="true" href="#func-expectedrollback-string">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedRollback</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>字符串返回字符串表示形式</p>
<h3 id="func-expectedrollbackwillreturnerror">func（* ExpectedRollback）WillReturnError<a hidden class="anchor" aria-hidden="true" href="#func-expectedrollbackwillreturnerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExpectedRollback</span><span class="p">)</span> <span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedRollback</span>
</code></pre></td></tr></table>
</div>
</div><p>WillReturnError允许为* sql.Tx.Rollback操作设置错误</p>
<h2 id="type-querymatcher">type QueryMatcher<a hidden class="anchor" aria-hidden="true" href="#type-querymatcher">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">QueryMatcher</span> <span class="kd">interface</span> <span class="p">{</span>

    <span class="c1">// Match expected SQL query string without whitespace to
</span><span class="c1"></span>    <span class="c1">// actual SQL.
</span><span class="c1"></span>    <span class="nf">Match</span><span class="p">(</span><span class="nx">expectedSQL</span><span class="p">,</span> <span class="nx">actualSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>QueryMatcher是一个SQL查询字符串匹配器接口，可用于自定义SQL查询字符串的验证。例如，外部库可用于构建和验证所选的SQL ast列。</p>
<p>可以自定义sqlmock以实现通过调用sqlmock.New或sqlmock.NewWithDSN时通过选项配置的其他QueryMatcher，默认QueryMatcher为QueryMatcherRegexp。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">QueryMatcherEqual</span> <span class="nx">QueryMatcher</span> <span class="p">=</span> <span class="nf">QueryMatcherFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">expectedSQL</span><span class="p">,</span> <span class="nx">actualSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">expect</span> <span class="o">:=</span> <span class="nf">stripQuery</span><span class="p">(</span><span class="nx">expectedSQL</span><span class="p">)</span>
    <span class="nx">actual</span> <span class="o">:=</span> <span class="nf">stripQuery</span><span class="p">(</span><span class="nx">actualSQL</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">actual</span> <span class="o">!=</span> <span class="nx">expect</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">`actual sql: &#34;%s&#34; does not equal to expected &#34;%s&#34;`</span><span class="p">,</span> <span class="nx">actual</span><span class="p">,</span> <span class="nx">expect</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>QueryMatcherEqual是SQL查询匹配器，它仅尝试对预期和实际的SQL字符串进行区分大小写的匹配，而无需空格。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">QueryMatcherRegexp</span> <span class="nx">QueryMatcher</span> <span class="p">=</span> <span class="nf">QueryMatcherFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">expectedSQL</span><span class="p">,</span> <span class="nx">actualSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">expect</span> <span class="o">:=</span> <span class="nf">stripQuery</span><span class="p">(</span><span class="nx">expectedSQL</span><span class="p">)</span>
    <span class="nx">actual</span> <span class="o">:=</span> <span class="nf">stripQuery</span><span class="p">(</span><span class="nx">actualSQL</span><span class="p">)</span>
    <span class="nx">re</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nf">Compile</span><span class="p">(</span><span class="nx">expect</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">re</span><span class="p">.</span><span class="nf">MatchString</span><span class="p">(</span><span class="nx">actual</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">`could not match actual sql: &#34;%s&#34; with expected regexp &#34;%s&#34;`</span><span class="p">,</span> <span class="nx">actual</span><span class="p">,</span> <span class="nx">re</span><span class="p">.</span><span class="nf">String</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>QueryMatcherRegexp是sqlmock使用的默认SQL查询匹配器。它将ExpectedSQL解析为一个正则表达式，并尝试匹配ActualSQL。</p>
<p>例</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// configure to use case sensitive SQL query matcher
</span><span class="c1">// instead of default regular expression matcher
</span><span class="c1"></span><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">(</span><span class="nf">QueryMatcherOption</span><span class="p">(</span><span class="nx">QueryMatcherEqual</span><span class="p">))</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to open sqlmock database:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">rows</span> <span class="o">:=</span> <span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">}).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;one&#34;</span><span class="p">).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;two&#34;</span><span class="p">)</span>

<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;SELECT * FROM users&#34;</span><span class="p">).</span><span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>

<span class="nx">rs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT * FROM users&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to match expected query&#34;</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="k">for</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="kt">int</span>
    <span class="kd">var</span> <span class="nx">title</span> <span class="kt">string</span>
    <span class="nx">rs</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">title</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;scanned id:&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;and title:&#34;</span><span class="p">,</span> <span class="nx">title</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;got rows error:&#34;</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">scanned id: 1 and title: one
scanned id: 2 and title: two
</code></pre></td></tr></table>
</div>
</div><h2 id="type-querymatcherfunc">type QueryMatcherFunc<a hidden class="anchor" aria-hidden="true" href="#type-querymatcherfunc">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">QueryMatcherFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">expectedSQL</span><span class="p">,</span> <span class="nx">actualSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></td></tr></table>
</div>
</div><p>QueryMatcherFunc类型是一个适配器，允许将普通功能用作QueryMatcher。如果f是具有适当签名的函数，则QueryMatcherFunc（f）是调用f的QueryMatcher。</p>
<h3 id="unc-querymatcherfunc-match">unc (QueryMatcherFunc) Match<a hidden class="anchor" aria-hidden="true" href="#unc-querymatcherfunc-match">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">QueryMatcherFunc</span><span class="p">)</span> <span class="nf">Match</span><span class="p">(</span><span class="nx">expectedSQL</span><span class="p">,</span> <span class="nx">actualSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></td></tr></table>
</div>
</div><p>Match实现QueryMatcher</p>
<h2 id="type-rows">type Rows<a hidden class="anchor" aria-hidden="true" href="#type-rows">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Rows</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// contains filtered or unexported fields
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>行是要返回查询结果的行的模拟集合</p>
<p>例</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to open sqlmock database:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">rows</span> <span class="o">:=</span> <span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">}).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;one&#34;</span><span class="p">).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&#34;two&#34;</span><span class="p">)</span>

<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">).</span><span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>

<span class="nx">rs</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="k">for</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="kt">int</span>
    <span class="kd">var</span> <span class="nx">title</span> <span class="kt">string</span>
    <span class="nx">rs</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">title</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;scanned id:&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;and title:&#34;</span><span class="p">,</span> <span class="nx">title</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;got rows error:&#34;</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">scanned id: 1 and title: one
scanned id: 2 and title: two
</code></pre></td></tr></table>
</div>
</div><p>Example (CloseError)</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to open sqlmock database:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">rows</span> <span class="o">:=</span> <span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">}).</span><span class="nf">CloseError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;close error&#34;</span><span class="p">))</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">).</span><span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>

<span class="nx">rs</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">)</span>

<span class="c1">// Note: that close will return error only before rows EOF
</span><span class="c1">// that is a default sql package behavior. If you run rs.Next()
</span><span class="c1">// it will handle the error internally and return nil bellow
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;got error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">got error: close error
</code></pre></td></tr></table>
</div>
</div><p>Example (CustomDriverValue)</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to open sqlmock database:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">rows</span> <span class="o">:=</span> <span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;null_int&#34;</span><span class="p">}).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">NullInt64</span><span class="p">{</span><span class="nx">Int64</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">Valid</span><span class="p">:</span> <span class="kc">true</span><span class="p">}).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">NullInt64</span><span class="p">{})</span>

<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">).</span><span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>

<span class="nx">rs</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="k">for</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="kt">int</span>
    <span class="kd">var</span> <span class="nx">num</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">NullInt64</span>
    <span class="nx">rs</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">num</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;scanned id:&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;and null int64:&#34;</span><span class="p">,</span> <span class="nx">num</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;got rows error:&#34;</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">scanned id: 1 and null int64: {7 true}
scanned id: 5 and null int64: {5 true}
scanned id: 2 and null int64: {0 false}
</code></pre></td></tr></table>
</div>
</div><p>Example (ExpectToBeClosed)</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to open sqlmock database:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">rows</span> <span class="o">:=</span> <span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">}).</span><span class="nf">AddRow</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;john&#34;</span><span class="p">)</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">).</span><span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">rows</span><span class="p">).</span><span class="nf">RowsWillBeClosed</span><span class="p">()</span>

<span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">)</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectationsWereMet</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;got error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">got error: expected query rows to be closed, but it was not: ExpectedQuery =&gt; expecting Query, QueryContext or QueryRow which:
  - matches sql: &#39;SELECT&#39;
  - is without arguments
  - should return rows:
    row 0 - [1 john]
</code></pre></td></tr></table>
</div>
</div><p>Example (RawBytes)</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to open sqlmock database:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">rows</span> <span class="o">:=</span> <span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;binary&#34;</span><span class="p">}).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`one binary value with some text!`</span><span class="p">)).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`two binary value with even more text than the first one`</span><span class="p">))</span>

<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">).</span><span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>

<span class="nx">rs</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="kd">type</span> <span class="nx">scanned</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">id</span>  <span class="kt">int</span>
    <span class="nx">raw</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">RawBytes</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;initial read...&#34;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">ss</span> <span class="p">[]</span><span class="nx">scanned</span>
<span class="k">for</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="nx">scanned</span>
    <span class="nx">rs</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">s</span><span class="p">.</span><span class="nx">raw</span><span class="p">)</span>
    <span class="nx">ss</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ss</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;scanned id:&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34;and raw:&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">raw</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;got rows error:&#34;</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">())</span>
<span class="p">}</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;after reading all...&#34;</span><span class="p">)</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">ss</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;scanned id:&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s">&#34;and raw:&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">raw</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">initial read...
scanned id: 1 and raw: one binary value with some text!
scanned id: 2 and raw: two binary value with even more text than the first one
after reading all...
scanned id: 1 and raw: ☠☠☠ MEMORY OVERWRITTEN ☠
scanned id: 2 and raw: ☠☠☠ MEMORY OVERWRITTEN ☠☠☠ ☠☠☠ MEMORY
</code></pre></td></tr></table>
</div>
</div><p>Example (RowError)</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to open sqlmock database:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">rows</span> <span class="o">:=</span> <span class="nf">NewRows</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">,</span> <span class="s">&#34;title&#34;</span><span class="p">}).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#34;one&#34;</span><span class="p">).</span>
    <span class="nf">AddRow</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;two&#34;</span><span class="p">).</span>
    <span class="nf">RowError</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;row error&#34;</span><span class="p">))</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectQuery</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">).</span><span class="nf">WillReturnRows</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span>

<span class="nx">rs</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;SELECT&#34;</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="k">for</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="kt">int</span>
    <span class="kd">var</span> <span class="nx">title</span> <span class="kt">string</span>
    <span class="nx">rs</span><span class="p">.</span><span class="nf">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">title</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;scanned id:&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;and title:&#34;</span><span class="p">,</span> <span class="nx">title</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;got rows error:&#34;</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nf">Err</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Output:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">scanned id: 0 and title: one
got rows error: row error
</code></pre></td></tr></table>
</div>
</div><h3 id="func-newrows">func NewRows<a hidden class="anchor" aria-hidden="true" href="#func-newrows">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewRows</span><span class="p">(</span><span class="nx">columns</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Rows</span>
</code></pre></td></tr></table>
</div>
</div><p>NewRows允许从sql driver.Value切片或CSV字符串创建行，并用作sql driver.Rows。如果使用自定义转换器，请改用Sqlmock.NewRows</p>
<h3 id="func-rowsaddrow">func（* Rows）AddRow<a hidden class="anchor" aria-hidden="true" href="#func-rowsaddrow">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rows</span><span class="p">)</span> <span class="nf">AddRow</span><span class="p">(</span><span class="nx">values</span> <span class="o">...</span><span class="nx">driver</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="o">*</span><span class="nx">Rows</span>
</code></pre></td></tr></table>
</div>
</div><p>由数据库driver.Value切片组成的AddRow返回相同的实例以执行后续操作。请注意，值的数量必须与列数匹配</p>
<h3 id="func-rows-closeerror">func (*Rows) CloseError<a hidden class="anchor" aria-hidden="true" href="#func-rows-closeerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rows</span><span class="p">)</span> <span class="nf">CloseError</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">Rows</span>
</code></pre></td></tr></table>
</div>
</div><p>CloseError允许设置将由rows.Close函数返回的错误。</p>
<p>仅当还没有达到rows.Next（）EOF时才触发关闭错误，这是默认的sql库行为</p>
<h3 id="func-rows-fromcsvstring">func (*Rows) FromCSVString<a hidden class="anchor" aria-hidden="true" href="#func-rows-fromcsvstring">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rows</span><span class="p">)</span> <span class="nf">FromCSVString</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Rows</span>
</code></pre></td></tr></table>
</div>
</div><p>FromCSVString从csv字符串构建行。返回相同的实例以执行后续操作。请注意，值的数量必须与列数匹配</p>
<h3 id="func-rowsrowerror">func（* Rows）RowError<a hidden class="anchor" aria-hidden="true" href="#func-rowsrowerror">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rows</span><span class="p">)</span> <span class="nf">RowError</span><span class="p">(</span><span class="nx">row</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="o">*</span><span class="nx">Rows</span>
</code></pre></td></tr></table>
</div>
</div><p>RowError允许设置一个错误，当读取给定的行号时将返回此错误</p>
<h2 id="type-sqlmock">type Sqlmock<a hidden class="anchor" aria-hidden="true" href="#type-sqlmock">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Sqlmock</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// ExpectClose queues an expectation for this database
</span><span class="c1"></span>    <span class="c1">// action to be triggered. the *ExpectedClose allows
</span><span class="c1"></span>    <span class="c1">// to mock database response
</span><span class="c1"></span>    <span class="nf">ExpectClose</span><span class="p">()</span> <span class="o">*</span><span class="nx">ExpectedClose</span>

    <span class="c1">// ExpectationsWereMet checks whether all queued expectations
</span><span class="c1"></span>    <span class="c1">// were met in order. If any of them was not met - an error is returned.
</span><span class="c1"></span>    <span class="nf">ExpectationsWereMet</span><span class="p">()</span> <span class="kt">error</span>

    <span class="c1">// ExpectPrepare expects Prepare() to be called with expectedSQL query.
</span><span class="c1"></span>    <span class="c1">// the *ExpectedPrepare allows to mock database response.
</span><span class="c1"></span>    <span class="c1">// Note that you may expect Query() or Exec() on the *ExpectedPrepare
</span><span class="c1"></span>    <span class="c1">// statement to prevent repeating expectedSQL
</span><span class="c1"></span>    <span class="nf">ExpectPrepare</span><span class="p">(</span><span class="nx">expectedSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedPrepare</span>

    <span class="c1">// ExpectQuery expects Query() or QueryRow() to be called with expectedSQL query.
</span><span class="c1"></span>    <span class="c1">// the *ExpectedQuery allows to mock database response.
</span><span class="c1"></span>    <span class="nf">ExpectQuery</span><span class="p">(</span><span class="nx">expectedSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedQuery</span>

    <span class="c1">// ExpectExec expects Exec() to be called with expectedSQL query.
</span><span class="c1"></span>    <span class="c1">// the *ExpectedExec allows to mock database response
</span><span class="c1"></span>    <span class="nf">ExpectExec</span><span class="p">(</span><span class="nx">expectedSQL</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExpectedExec</span>

    <span class="c1">// ExpectBegin expects *sql.DB.Begin to be called.
</span><span class="c1"></span>    <span class="c1">// the *ExpectedBegin allows to mock database response
</span><span class="c1"></span>    <span class="nf">ExpectBegin</span><span class="p">()</span> <span class="o">*</span><span class="nx">ExpectedBegin</span>

    <span class="c1">// ExpectCommit expects *sql.Tx.Commit to be called.
</span><span class="c1"></span>    <span class="c1">// the *ExpectedCommit allows to mock database response
</span><span class="c1"></span>    <span class="nf">ExpectCommit</span><span class="p">()</span> <span class="o">*</span><span class="nx">ExpectedCommit</span>

    <span class="c1">// ExpectRollback expects *sql.Tx.Rollback to be called.
</span><span class="c1"></span>    <span class="c1">// the *ExpectedRollback allows to mock database response
</span><span class="c1"></span>    <span class="nf">ExpectRollback</span><span class="p">()</span> <span class="o">*</span><span class="nx">ExpectedRollback</span>

    <span class="c1">// ExpectPing expected *sql.DB.Ping to be called.
</span><span class="c1"></span>    <span class="c1">// the *ExpectedPing allows to mock database response
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// Ping support only exists in the SQL library in Go 1.8 and above.
</span><span class="c1"></span>    <span class="c1">// ExpectPing in Go &lt;=1.7 will return an ExpectedPing but not register
</span><span class="c1"></span>    <span class="c1">// any expectations.
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// You must enable pings using MonitorPingsOption for this to register
</span><span class="c1"></span>    <span class="c1">// any expectations.
</span><span class="c1"></span>    <span class="nf">ExpectPing</span><span class="p">()</span> <span class="o">*</span><span class="nx">ExpectedPing</span>

    <span class="c1">// MatchExpectationsInOrder gives an option whether to match all
</span><span class="c1"></span>    <span class="c1">// expectations in the order they were set or not.
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// By default it is set to - true. But if you use goroutines
</span><span class="c1"></span>    <span class="c1">// to parallelize your query executation, that option may
</span><span class="c1"></span>    <span class="c1">// be handy.
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// This option may be turned on anytime during tests. As soon
</span><span class="c1"></span>    <span class="c1">// as it is switched to false, expectations will be matched
</span><span class="c1"></span>    <span class="c1">// in any order. Or otherwise if switched to true, any unmatched
</span><span class="c1"></span>    <span class="c1">// expectations will be expected in order
</span><span class="c1"></span>    <span class="nf">MatchExpectationsInOrder</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span>

    <span class="c1">// NewRows allows Rows to be created from a
</span><span class="c1"></span>    <span class="c1">// sql driver.Value slice or from the CSV string and
</span><span class="c1"></span>    <span class="c1">// to be used as sql driver.Rows.
</span><span class="c1"></span>    <span class="nf">NewRows</span><span class="p">(</span><span class="nx">columns</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Rows</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Sqlmock接口用于为任何类型的数据库操作创建期望，以便模拟和测试实际的数据库行为。</p>
<p>示例（Goroutines）</p>
<p>Code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;failed to open sqlmock database:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="c1">// note this line is important for unordered expectation matching
</span><span class="c1"></span><span class="nx">mock</span><span class="p">.</span><span class="nf">MatchExpectationsInOrder</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>

<span class="nx">result</span> <span class="o">:=</span> <span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^UPDATE one&#34;</span><span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span><span class="s">&#34;one&#34;</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^UPDATE two&#34;</span><span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span><span class="s">&#34;one&#34;</span><span class="p">,</span> <span class="s">&#34;two&#34;</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;^UPDATE three&#34;</span><span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span><span class="s">&#34;one&#34;</span><span class="p">,</span> <span class="s">&#34;two&#34;</span><span class="p">,</span> <span class="s">&#34;three&#34;</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>

<span class="kd">var</span> <span class="nx">wg</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="nx">queries</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kd">interface</span><span class="p">{}{</span>
    <span class="s">&#34;one&#34;</span><span class="p">:</span>   <span class="p">{</span><span class="s">&#34;one&#34;</span><span class="p">},</span>
    <span class="s">&#34;two&#34;</span><span class="p">:</span>   <span class="p">{</span><span class="s">&#34;one&#34;</span><span class="p">,</span> <span class="s">&#34;two&#34;</span><span class="p">},</span>
    <span class="s">&#34;three&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#34;one&#34;</span><span class="p">,</span> <span class="s">&#34;two&#34;</span><span class="p">,</span> <span class="s">&#34;three&#34;</span><span class="p">},</span>
<span class="p">}</span>

<span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">queries</span><span class="p">))</span>
<span class="k">for</span> <span class="nx">table</span><span class="p">,</span> <span class="nx">args</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">queries</span> <span class="p">{</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">tbl</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">a</span> <span class="p">[]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;UPDATE &#34;</span><span class="o">+</span><span class="nx">tbl</span><span class="p">,</span> <span class="nx">a</span><span class="o">...</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;error was not expected:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
    <span class="p">}(</span><span class="nx">table</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">wg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>

<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectationsWereMet</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;there were unfulfilled expectations:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="func-new">func New<a hidden class="anchor" aria-hidden="true" href="#func-new">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">options</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">sqlmock</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">Sqlmock</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>New创建sqlmock数据库连接和一个模拟来管理期望。接受诸如ValueConverterOption之类的选项，以使用特定驱动程序中的ValueConverter。Pings db，以便可以肯定所有期望。</p>
<p>例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;expected no error, but got:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="c1">// now we can expect operations performed on db
</span><span class="c1"></span><span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectBegin</span><span class="p">().</span><span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;an error will occur on db.Begin() call&#34;</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="func-newwithdsn">func NewWithDSN<a hidden class="anchor" aria-hidden="true" href="#func-newwithdsn">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewWithDSN</span><span class="p">(</span><span class="nx">dsn</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">sqlmock</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">Sqlmock</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>NewWithDSN创建具有特定DSN的sqlmock数据库连接以及用于管理期望的模拟。接受诸如ValueConverterOption之类的选项，以使用特定驱动程序中的ValueConverter。Pings db，以便可以肯定所有期望。</p>
<p>由于sql抽象库而引入了此方法，该库没有提供使用sql.DB实例进行初始化的方法。例如GORM库。</p>
<p>注意，如果尝试使用已经使用过的dsn进行创建，则会出错</p>
<p>不建议使用此方法，除非您确实需要它并且没有其他方法可以使用。</p>
<h1 id="举例">举例<a hidden class="anchor" aria-hidden="true" href="#举例">#</a></h1>
<p>假设您使用go-mysql-driver，可以尝试一下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;database/sql&#34;</span>

	<span class="nx">_</span> <span class="s">&#34;github.com/go-sql-driver/mysql&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">recordStats</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">userID</span><span class="p">,</span> <span class="nx">productID</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">tx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Begin</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="nx">err</span> <span class="p">{</span>
		<span class="k">case</span> <span class="kc">nil</span><span class="p">:</span>
			<span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Commit</span><span class="p">()</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="nx">tx</span><span class="p">.</span><span class="nf">Rollback</span><span class="p">()</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;UPDATE products SET views = views + 1&#34;</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tx</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;INSERT INTO product_viewers (user_id, product_id) VALUES (?, ?)&#34;</span><span class="p">,</span> <span class="nx">userID</span><span class="p">,</span> <span class="nx">productID</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="k">return</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// @NOTE: the real connection is not required for tests
</span><span class="c1"></span>	<span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;mysql&#34;</span><span class="p">,</span> <span class="s">&#34;root@/blog&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">recordStats</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/*some user id*/</span><span class="p">,</span> <span class="mi">5</span> <span class="cm">/*some product id*/</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>用sqlmock测试:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;testing&#34;</span>

	<span class="s">&#34;github.com/DATA-DOG/go-sqlmock&#34;</span>
<span class="p">)</span>

<span class="c1">// a successful case
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestShouldUpdateStats</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;an error &#39;%s&#39; was not expected when opening a stub database connection&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectBegin</span><span class="p">()</span>
	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;UPDATE products&#34;</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;INSERT INTO product_viewers&#34;</span><span class="p">).</span><span class="nf">WithArgs</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectCommit</span><span class="p">()</span>

	<span class="c1">// now we execute our method
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">recordStats</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error was not expected while updating stats: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// we make sure that all expectations were met
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectationsWereMet</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;there were unfulfilled expectations: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// a failing test case
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestShouldRollbackStatUpdatesOnFailure</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;an error &#39;%s&#39; was not expected when opening a stub database connection&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectBegin</span><span class="p">()</span>
	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;UPDATE products&#34;</span><span class="p">).</span><span class="nf">WillReturnResult</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;INSERT INTO product_viewers&#34;</span><span class="p">).</span>
		<span class="nf">WithArgs</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">).</span>
		<span class="nf">WillReturnError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;some error&#34;</span><span class="p">))</span>
	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectRollback</span><span class="p">()</span>

	<span class="c1">// now we execute our method
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">recordStats</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;was expecting an error, but there was none&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// we make sure that all expectations were met
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectationsWereMet</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;there were unfulfilled expectations: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="自定义sql查询匹配">自定义SQL查询匹配<a hidden class="anchor" aria-hidden="true" href="#自定义sql查询匹配">#</a></h1>
<p>用户提出了许多有关SQL查询字符串验证或不同匹配选项的请求。现在QueryMatcher，我们已经实现了接口，可以在调用<code>sqlmock.New</code>或<code>sqlmock.NewWithDSN</code>时通过选项传递该接口 。</p>
<p>现在，这允许包括一些库，该库将允许例如解析和验证mysqlSQL AST。并创建一个自定义QueryMatcher以便以复杂的方式验证SQL。</p>
<p>默认情况下，sqlmock保留向后兼容性，默认查询匹配器<code>sqlmock.QueryMatcherRegexp</code> 使用期望的SQL字符串作为正则表达式来匹配传入的查询字符串。有一个相等匹配器： <code>QueryMatcherEqual</code>它将进行完全区分大小写的匹配。</p>
<p>为了自定义QueryMatcher，请使用以下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlmock</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nf">QueryMatcherOption</span><span class="p">(</span><span class="nx">sqlmock</span><span class="p">.</span><span class="nx">QueryMatcherEqual</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>可以根据用户需求完全定制查询匹配器。sqlmock将不提供标准的sql解析匹配器，因为各种驱动程序可能不遵循相同的SQL标准。</p>
<p>示例解析如下图：</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200128151253.png" alt=""  />
</p>
<p>看看实际情况中需要注意的点：</p>
<ol>
<li>
<p>初始化sqlmock后，需要将sqlmock的db实例赋值给实际调用的数据库，如下图所示：</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200128151505.png" alt=""  />
</p>
<p>稍微仔细思考下也能够理解，官网给的示例初始化sqlmock后都没有指定要mock哪个db，显然会抛异常。</p>
</li>
<li>
<p>如何mock返回错误？</p>
<p>使用WillReturnError方法构造返回错误，如下图所示：</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200128151610.png" alt=""  />
</p>
</li>
</ol>
<h1 id="匹配参数如timetime">匹配参数如time.Time<a hidden class="anchor" aria-hidden="true" href="#匹配参数如timetime">#</a></h1>
<p>可能存在某些struct类型的参数，无法通过值轻易地将其进行比较time.Time。在这种情况下， sqlmock提供了一个Argument接口，可以在更复杂的匹配中使用它。这是时间参数匹配的一个简单示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">AnyTime</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// Match satisfies sqlmock.Argument interface
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="nx">AnyTime</span><span class="p">)</span> <span class="nf">Match</span><span class="p">(</span><span class="nx">v</span> <span class="nx">driver</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">ok</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">TestAnyTimeArgument</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">.</span><span class="nf">Parallel</span><span class="p">()</span>
	<span class="nx">db</span><span class="p">,</span> <span class="nx">mock</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">New</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;an error &#39;%s&#39; was not expected when opening a stub database connection&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectExec</span><span class="p">(</span><span class="s">&#34;INSERT INTO users&#34;</span><span class="p">).</span>
		<span class="nf">WithArgs</span><span class="p">(</span><span class="s">&#34;john&#34;</span><span class="p">,</span> <span class="nx">AnyTime</span><span class="p">{}).</span>
		<span class="nf">WillReturnResult</span><span class="p">(</span><span class="nf">NewResult</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">Exec</span><span class="p">(</span><span class="s">&#34;INSERT INTO users(name, created_at) VALUES (?, ?)&#34;</span><span class="p">,</span> <span class="s">&#34;john&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">())</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error &#39;%s&#39; was not expected, while inserting a row&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">mock</span><span class="p">.</span><span class="nf">ExpectationsWereMet</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;there were unfulfilled expectations: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>它仅断言该参数是time.Time类型。</p>
<h1 id="gomonkey与sqlmock">gomonkey与sqlmock<a hidden class="anchor" aria-hidden="true" href="#gomonkey与sqlmock">#</a></h1>
<p>gomonkey的ApplyMethod方法能不能替代sqlmock？不能！</p>
<p>如下图：被测方法为detailDb.Query（），如果使用gomonkey进行mock，则需要重新query方法：</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200128152132.png" alt=""  />
</p>
<p>Query方法的入参和出参如下图：出参包含Rows参数</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200128152152.png" alt=""  />
</p>
<p>再来看看Rows结构体，会发现里面的结构十分复杂，根本无法手工构造想要的数据。</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200128152213.png" alt=""  />
</p>
<p>综上，在示例特定场景下，无法使用gomonkey来替代sqlmock</p>
<h1 id="场景覆盖">场景覆盖<a hidden class="anchor" aria-hidden="true" href="#场景覆盖">#</a></h1>
<p>sqlmock是否能覆盖所有sql场景？</p>
<p>目前发现开发底层都使用&quot;github.com/go-sql-driver/mysql&quot;数据库，都能够使用sqlmock库进行mock</p>
<p>参考:<br>
<a href="https://kknews.cc/code/jl83xne.html">https://kknews.cc/code/jl83xne.html</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
      <li><a href="/tags/go-sqlmock/">go-sqlmock</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
