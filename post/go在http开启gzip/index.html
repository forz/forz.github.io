<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go在http开启gzip | Forz Blog</title>
<meta name="keywords" content="gzip, Go" />
<meta name="description" content="前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到">
<meta name="author" content="">
<link rel="canonical" href="/post/go%E5%9C%A8http%E5%BC%80%E5%90%AFgzip/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Go在http开启gzip" />
<meta property="og:description" content="前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/go%E5%9C%A8http%E5%BC%80%E5%90%AFgzip/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-04-29T19:35:47&#43;00:00" />
<meta property="article:modified_time" content="2021-04-29T19:35:47&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go在http开启gzip"/>
<meta name="twitter:description" content="前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Go在http开启gzip",
      "item": "/post/go%E5%9C%A8http%E5%BC%80%E5%90%AFgzip/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go在http开启gzip",
  "name": "Go在http开启gzip",
  "description": "前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到",
  "keywords": [
    "gzip", "Go"
  ],
  "articleBody": "前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到减少体积，加快网络传输的效能。 但是 gzip 压缩只用于 response 的响应数据，一般来说针对 pc 端的站点来说，足够了。\n但是有时候针对手机 app 来说，光是 response 用 gzip 压缩还不够， 因为 request 请求的时候，如果有时候 body 体带上很多数据的话，还是会导致体积很大，从而消耗流量。 手机的流量可比 pc 的流量贵多了。 因此对于有些比较注重流量消耗的 app 来说，最好也要做到 request 请求的时候，也用上 gzip 来压缩数据，然后服务端在 nginx 或者程序的网关那边，再根据请求头 Content-Encoding 是否为 gzip 来判断是否要对请求的数据进行 gzip 解压缩。\n实操 接下来我将通过用 golang 语言来模拟客户端的请求和服务端的响应是否要带上 gzip 头部，来模拟这一过程，代码很简单，而且已经极简了，客户端代码就是 client.go, 服务端代码就是 server.go， 不需要用到第三方库。 (我的 golang 环境是 1.13.8)\n客户端 client.go:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74  package main import ( \"bytes\" \"compress/gzip\" \"fmt\" \"io/ioutil\" \"net/http\" \"flag\" ) func main() { var requestUseGzip = flag.String(\"req_use_gzip\", \"1\", \"has request body use gzip\") var responseUseGzip = flag.String(\"resp_use_gzip\", \"1\", \"has response body use gzip\") flag.Parse() var requestBodyStr = `{\"name\":\"zach ke\",\"des\":\"woooooo boy\", \"response_use_gzip\": \"%s\"}` data := []byte(fmt.Sprintf(requestBodyStr, *responseUseGzip)) var httpRequest*http.Request var err error if *requestUseGzip == \"1\"{ fmt.Println(\"request with gzip\") var zBuf bytes.Buffer zw := gzip.NewWriter(\u0026zBuf) if _, err := zw.Write(data); err != nil { fmt.Println(\"gzip is faild,err:\", err) } zw.Close() httpRequest, err = http.NewRequest(\"POST\", \"http://localhost:9905/request\", \u0026zBuf) if err != nil { fmt.Println(\"http request is failed, err: \", err) } httpRequest.Header.Set(\"Content-Encoding\", \"gzip\") } else { fmt.Println(\"request without gzip\") reader := bytes.NewReader(data) httpRequest, err = http.NewRequest(\"POST\", \"http://localhost:9905/request\", reader) if err != nil { fmt.Println(\"http request is failed, err: \", err) } } // 通过参数判断是否返回值要用 gzip 压缩 if*responseUseGzip == \"1\" { httpRequest.Header.Set(\"Accept-Encoding\", \"gzip\") }else{ // 这个也要指定，不然 response 那边获取 content-length 头部会取不到值 \thttpRequest.Header.Set(\"Accept-Encoding\", \"deflate\") } client := \u0026http.Client{} httpResponse, err := client.Do(httpRequest) if err != nil { fmt.Println(\"httpResponse is failed, err: \", err) } defer httpResponse.Body.Close() fmt.Println(\"respone content length=\", httpResponse.ContentLength) if httpResponse.StatusCode == 200 { var respBody string switch httpResponse.Header.Get(\"Content-Encoding\") { case \"gzip\": fmt.Println(\"response with gzip\") reader, err := gzip.NewReader(httpResponse.Body) if err != nil { fmt.Println(\"gzip get reader err \", err) } data, err = ioutil.ReadAll(reader) respBody = string(data) default: fmt.Println(\"response without gzip\") bodyByte, _ := ioutil.ReadAll(httpResponse.Body) respBody = string(bodyByte) } fmt.Println(\"resp data=\", respBody) } }   可以看到，我这边通过 flag 来控制本次请求中， request 是否要 gzip 压缩，要求 response 是否也要 gzip 压缩返回。 所以总共有以下四种可能:\n request gzip 压缩， response gzip 压缩 request gzip 压缩， response 不 压缩 request 不 压缩， response gzip 压缩 request 不 压缩， response 不 压缩  服务端 server.go:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  package main import ( \"compress/gzip\" \"fmt\" \"io/ioutil\" \"net/http\" \"bytes\" ) func handler(resp http.ResponseWriter, req *http.Request) { var bodyDataStr string // 是否需要解 gzip 压缩 \tfmt.Println(\"resquest content length=\", req.ContentLength) if req.Header.Get(\"Content-Encoding\") == \"gzip\" { fmt.Println(\"request with gzip\") body, err := gzip.NewReader(req.Body) if err != nil { fmt.Println(\"unzip is failed, err:\", err) } defer body.Close() data, err := ioutil.ReadAll(body) if err != nil { fmt.Println(\"read all is failed.err:\", err) } bodyDataStr = string(data) } else { fmt.Println(\"request without gzip\") data, err := ioutil.ReadAll(req.Body) defer req.Body.Close() if err != nil { fmt.Println(\"read resp is failed, err: \", err) } bodyDataStr = string(data) } fmt.Println(\"request json string=\", bodyDataStr) respJson := []byte(`{code: \"1\",msg: \"success\"}`) // 通过头部的 Accept-Encoding 判断返回值是否要用 gzip 压缩 \tif req.Header.Get(\"Accept-Encoding\") == \"gzip\" { fmt.Println(\"response with gzip\") // 添加 gzip 头部 \tresp.Header().Set(\"Content-Encoding\", \"gzip\") var zBuf bytes.Buffer zw := gzip.NewWriter(\u0026zBuf) if _, err := zw.Write(respJson); err != nil { zw.Close() fmt.Println(\"gzip is faild,err:\", err) } zw.Close() //fmt.Println(\"gzip content:\", string(zBuf.Bytes())) \tresp.Write(zBuf.Bytes()) }else{ fmt.Println(\"response without gzip\") // 正常不压缩 返回 \tresp.Write(respJson) } } func main() { fmt.Println(\"http://localhost:9905/request\") http.HandleFunc(\"/request\", handler) http.ListenAndServe(\":9905\", nil) }   运行起来 首先先运行服务端:\n1  go run server.go   接下来针对以上 4 种情况，分别运行 客户端 程序，然后查看一下服务端的输出\n1. 都压缩 客户端指令:\n1 2 3 4 5  ~ go run client.go request with gzip respone content length= 50 response with gzip resp data= {code: \"1\",msg: \"success\"}   服务端输出:\n1 2 3 4  resquest content length= 85 request with gzip request json string= {\"name\":\"zach ke\",\"des\":\"woooooo boy\", \"response_use_gzip\": \"1\"} response with gzip   2. request 压缩， response 不压缩 客户端指令:\n1 2 3 4 5  ~ go run client.go -resp_use_gzip=0 -req_use_gzip=1 request with gzip respone content length= 26 response without gzip resp data= {code: \"1\",msg: \"success\"}   服务端输出:\n1 2 3 4  resquest content length= 85 request with gzip request json string= {\"name\":\"zach ke\",\"des\":\"woooooo boy\", \"response_use_gzip\": \"0\"} response without gzip   3. request 不压缩， response 压缩 客户端指令:\n1 2 3 4 5  ~ go run client.go -resp_use_gzip=1 -req_use_gzip=0 request without gzip respone content length= 50 response with gzip resp data= {code: \"1\",msg: \"success\"}   服务端输出:\n1 2 3 4  resquest content length= 64 request without gzip request json string= {\"name\":\"zach ke\",\"des\":\"woooooo boy\", \"response_use_gzip\": \"1\"} response with gzip   4. 都不压缩 客户端指令:\n1 2 3 4 5  ~ go run client.go -resp_use_gzip=0 -req_use_gzip=0 request without gzip respone content length= 26 response without gzip resp data= {code: \"1\",msg: \"success\"}   服务端输出:\n1 2 3 4  resquest content length= 64 request without gzip request json string= {\"name\":\"zach ke\",\"des\":\"woooooo boy\", \"response_use_gzip\": \"0\"} response without gzip   判断是否压缩 其实判断是否要用 gzip 压缩很简单，通过 request 或者 response 的头部设置即可:\n 如果自身设置 Content-Encoding 为 gzip, 说明你的数据是 gzip 压缩过的， 对方要进行 gzip 解压才行 如果你希望对方给你的数据是 gzip 压缩过的，那么就设置头部 Accept-Encoding 为 gzip  gzip 压缩后体积更大的情况 不知道以上有一种情况，你们有没有发现过，就是无论是 request 还是 response 的数据， gzip 压缩过后的字节体积比原先更多了，反而是不压缩的字节体积更小，为了更直观，我列个表格:\n   - 请求 body 字节 响应 body 字节     都压缩 85 50   只压缩 request 85 26   只压缩 response 64 50   都不压缩 64 26   其实这样子是对的，事实上 gzip 压缩的时候，在原数据比较小的时候，反而压缩后的体积会更大， 这也是为啥 nginx 要有一个 gzip_min_length 参数来控制压缩的最小字节数，一般我们是设置为 1k (默认值是 20)， 具体可以看 gzip 配置 gzip_min_length 来判断 response 是否要 gzip 压缩      接下来我们将 请求的 body 和 响应的 body 都调大一点\n1  respJson := []byte(`{code: \"1\",msg: \"success\", des: \"12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr\"}`)   1  var requestBodyStr = `{\"name\":\"zach ke\",\"des\":\"woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy\", \"response_use_gzip\": \"%s\"}`   可以看到 都压缩后的体积是:\n1 2 3 4 5  request with gzip respone content length= 111 response with gzip resp data= {code: \"1\",msg: \"success\", des: \"12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhh hhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr\"}   1 2 3 4 5  resquest content length= 89 request with gzip request json string= {\"name\":\"zach ke\",\"des\":\"woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy\", \"response_use_gzip\": \"1\"} response with gzip   分别是请求体积是 89， 响应体积 111。\n而如果是没有压缩的，那么就是：\n1 2 3 4 5 6  request without gzip respone content length= 343 response without gzip resp data= {code: \"1\",msg: \"success\", des: \"12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhh hhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr\"} resquest content length= 383   1 2 3 4  request without gzip request json string= {\"name\":\"zach ke\",\"des\":\"woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy\", \"response_use_gzip\": \"0\"} response without gzip   分别是请求体积是 383， 响应体积 343。 可以看到这个压缩率就不错了。\n总结 基本上数据量越多的话， 用 gzip 能省的流量越多，而且还能够加快网络传输，何乐而不为。 (事实上，还可以设置压缩比例和压缩算法，我这边为了演示，只使用默认的配置)\n不过request 请求的话，如果用 gzip 的话，会影响性能的，数据量越大的话， 压缩和解压所消耗的时间也会越长，所以一般 pc 端的站点也不需要， 只有一些对流量消耗比较敏感的 app 可以考虑用这种方式。\n转载 http 请求的时候使用 gzip 压缩来减少流量消耗\n",
  "wordCount" : "2209",
  "inLanguage": "zh-cn",
  "datePublished": "2021-04-29T19:35:47Z",
  "dateModified": "2021-04-29T19:35:47Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/go%E5%9C%A8http%E5%BC%80%E5%90%AFgzip/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Go在http开启gzip
    </h1>
    <div class="post-meta">April 29, 2021
</div>
  </header> 
  <div class="post-content"><h2 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h2>
<p>我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到减少体积，加快网络传输的效能。 但是 gzip 压缩只用于 response 的响应数据，一般来说针对 pc 端的站点来说，足够了。</p>
<p>但是有时候针对手机 app 来说，光是 response 用 gzip 压缩还不够， 因为 request 请求的时候，如果有时候 body 体带上很多数据的话，还是会导致体积很大，从而消耗流量。 手机的流量可比 pc 的流量贵多了。 因此对于有些比较注重流量消耗的 app 来说，最好也要做到 request 请求的时候，也用上 gzip 来压缩数据，然后服务端在 nginx 或者程序的网关那边，再根据请求头 Content-Encoding 是否为 gzip 来判断是否要对请求的数据进行 gzip 解压缩。</p>
<h2 id="实操">实操<a hidden class="anchor" aria-hidden="true" href="#实操">#</a></h2>
<p>接下来我将通过用 golang 语言来模拟客户端的请求和服务端的响应是否要带上 gzip 头部，来模拟这一过程，代码很简单，而且已经极简了，客户端代码就是 client.go, 服务端代码就是 server.go， 不需要用到第三方库。 (我的 golang 环境是 1.13.8)</p>
<h3 id="客户端">客户端<a hidden class="anchor" aria-hidden="true" href="#客户端">#</a></h3>
<p>client.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;bytes&#34;</span>
	<span class="s">&#34;compress/gzip&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io/ioutil&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;flag&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">requestUseGzip</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;req_use_gzip&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="s">&#34;has request body use gzip&#34;</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">responseUseGzip</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;resp_use_gzip&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="s">&#34;has response body use gzip&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">requestBodyStr</span> <span class="p">=</span> <span class="s">`{&#34;name&#34;:&#34;zach ke&#34;,&#34;des&#34;:&#34;woooooo boy&#34;, &#34;response_use_gzip&#34;: &#34;%s&#34;}`</span>
	<span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">requestBodyStr</span><span class="p">,</span> <span class="o">*</span><span class="nx">responseUseGzip</span><span class="p">))</span>
<span class="kd">var</span> <span class="nx">httpRequest</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="k">if</span> <span class="o">*</span><span class="nx">requestUseGzip</span> <span class="o">==</span> <span class="s">&#34;1&#34;</span><span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request with gzip&#34;</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">zBuf</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
		<span class="nx">zw</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zBuf</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">zw</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;gzip is faild,err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">zw</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
		<span class="nx">httpRequest</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="s">&#34;http://localhost:9905/request&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">zBuf</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;http request is failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">httpRequest</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request without gzip&#34;</span><span class="p">)</span>
		<span class="nx">reader</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
		<span class="nx">httpRequest</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="s">&#34;http://localhost:9905/request&#34;</span><span class="p">,</span> <span class="nx">reader</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;http request is failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="c1">// 通过参数判断是否返回值要用 gzip 压缩
</span><span class="c1"></span><span class="k">if</span><span class="o">*</span><span class="nx">responseUseGzip</span> <span class="o">==</span> <span class="s">&#34;1&#34;</span> <span class="p">{</span>
		<span class="nx">httpRequest</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="c1">// 这个也要指定，不然 response 那边获取 content-length 头部会取不到值
</span><span class="c1"></span>		<span class="nx">httpRequest</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;deflate&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{}</span>
	<span class="nx">httpResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">httpRequest</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;httpResponse is failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;respone content length=&#34;</span><span class="p">,</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">ContentLength</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">==</span> <span class="mi">200</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">respBody</span> <span class="kt">string</span>
		<span class="k">switch</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="s">&#34;gzip&#34;</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;response with gzip&#34;</span><span class="p">)</span>
			<span class="nx">reader</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">httpResponse</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;gzip get reader err &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">reader</span><span class="p">)</span>
			<span class="nx">respBody</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;response without gzip&#34;</span><span class="p">)</span>
			<span class="nx">bodyByte</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">httpResponse</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
			<span class="nx">respBody</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">bodyByte</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;resp data=&#34;</span><span class="p">,</span> <span class="nx">respBody</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，我这边通过 flag 来控制本次请求中， request 是否要 gzip 压缩，要求 response 是否也要 gzip 压缩返回。 所以总共有以下四种可能:</p>
<ol>
<li>request gzip 压缩， response gzip 压缩</li>
<li>request gzip 压缩， response 不 压缩</li>
<li>request 不 压缩， response gzip 压缩</li>
<li>request 不 压缩， response 不 压缩</li>
</ol>
<h3 id="服务端">服务端<a hidden class="anchor" aria-hidden="true" href="#服务端">#</a></h3>
<p>server.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;compress/gzip&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io/ioutil&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;bytes&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">handler</span><span class="p">(</span><span class="nx">resp</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">bodyDataStr</span> <span class="kt">string</span>
	<span class="c1">// 是否需要解 gzip 压缩
</span><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;resquest content length=&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ContentLength</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;gzip&#34;</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request with gzip&#34;</span><span class="p">)</span>
		<span class="nx">body</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;unzip is failed, err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">defer</span> <span class="nx">body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
		<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;read all is failed.err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">bodyDataStr</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request without gzip&#34;</span><span class="p">)</span>
		<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
		<span class="k">defer</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;read resp is failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">bodyDataStr</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request json string=&#34;</span><span class="p">,</span> <span class="nx">bodyDataStr</span><span class="p">)</span>

	<span class="nx">respJson</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{code: &#34;1&#34;,msg: &#34;success&#34;}`</span><span class="p">)</span>

	<span class="c1">// 通过头部的 Accept-Encoding 判断返回值是否要用 gzip 压缩
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;gzip&#34;</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;response with gzip&#34;</span><span class="p">)</span>
		<span class="c1">// 添加 gzip 头部
</span><span class="c1"></span>		<span class="nx">resp</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
		<span class="kd">var</span> <span class="nx">zBuf</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
		<span class="nx">zw</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zBuf</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">zw</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">respJson</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">zw</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;gzip is faild,err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">zw</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
		<span class="c1">//fmt.Println(&#34;gzip content:&#34;, string(zBuf.Bytes()))
</span><span class="c1"></span>		<span class="nx">resp</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">zBuf</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">())</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;response without gzip&#34;</span><span class="p">)</span>
		<span class="c1">// 正常不压缩 返回
</span><span class="c1"></span>		<span class="nx">resp</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">respJson</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;http://localhost:9905/request&#34;</span><span class="p">)</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/request&#34;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:9905&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="运行起来">运行起来<a hidden class="anchor" aria-hidden="true" href="#运行起来">#</a></h3>
<p>首先先运行服务端:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">go</span> <span class="n">run</span> <span class="n">server.go</span>
</code></pre></td></tr></table>
</div>
</div><p>接下来针对以上 4 种情况，分别运行 客户端 程序，然后查看一下服务端的输出</p>
<h4 id="1-都压缩">1. 都压缩<a hidden class="anchor" aria-hidden="true" href="#1-都压缩">#</a></h4>
<p>客户端指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">~</span> <span class="o">&gt;</span><span class="n">go</span> <span class="n">run</span> <span class="n">client.go</span>
<span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">50</span>
<span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>服务端输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">85</span>
<span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">}</span>
<span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="2-request-压缩-response-不压缩">2. request 压缩， response 不压缩<a hidden class="anchor" aria-hidden="true" href="#2-request-压缩-response-不压缩">#</a></h4>
<p>客户端指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">~</span> <span class="o">&gt;</span><span class="n">go</span> <span class="n">run</span> <span class="n">client.go</span> <span class="o">-</span><span class="n">resp_use_gzip</span><span class="o">=</span><span class="m">0</span> <span class="o">-</span><span class="n">req_use_gzip</span><span class="o">=</span><span class="m">1</span>
<span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">26</span>
<span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>服务端输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">85</span>
<span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">}</span>
<span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="3-request-不压缩-response-压缩">3. request 不压缩， response 压缩<a hidden class="anchor" aria-hidden="true" href="#3-request-不压缩-response-压缩">#</a></h4>
<p>客户端指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">~</span> <span class="o">&gt;</span><span class="n">go</span> <span class="n">run</span> <span class="n">client.go</span> <span class="o">-</span><span class="n">resp_use_gzip</span><span class="o">=</span><span class="m">1</span> <span class="o">-</span><span class="n">req_use_gzip</span><span class="o">=</span><span class="m">0</span>
<span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">50</span>
<span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>服务端输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">64</span>
<span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">}</span>
<span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="4-都不压缩">4. 都不压缩<a hidden class="anchor" aria-hidden="true" href="#4-都不压缩">#</a></h4>
<p>客户端指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">~</span> <span class="o">&gt;</span><span class="n">go</span> <span class="n">run</span> <span class="n">client.go</span> <span class="o">-</span><span class="n">resp_use_gzip</span><span class="o">=</span><span class="m">0</span> <span class="o">-</span><span class="n">req_use_gzip</span><span class="o">=</span><span class="m">0</span>
<span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">26</span>
<span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>服务端输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">64</span>
<span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">}</span>
<span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="判断是否压缩">判断是否压缩<a hidden class="anchor" aria-hidden="true" href="#判断是否压缩">#</a></h2>
<p>其实判断是否要用 gzip 压缩很简单，通过 request 或者 response 的头部设置即可:</p>
<ol>
<li>如果自身设置 Content-Encoding 为 gzip, 说明你的数据是 gzip 压缩过的， 对方要进行 gzip 解压才行</li>
<li>如果你希望对方给你的数据是 gzip 压缩过的，那么就设置头部 Accept-Encoding 为 gzip</li>
</ol>
<h3 id="gzip-压缩后体积更大的情况">gzip 压缩后体积更大的情况<a hidden class="anchor" aria-hidden="true" href="#gzip-压缩后体积更大的情况">#</a></h3>
<p>不知道以上有一种情况，你们有没有发现过，就是无论是 request 还是 response 的数据， gzip 压缩过后的字节体积比原先更多了，反而是不压缩的字节体积更小，为了更直观，我列个表格:</p>
<table>
<thead>
<tr>
<th>-</th>
<th>请求 body 字节</th>
<th>响应 body 字节</th>
</tr>
</thead>
<tbody>
<tr>
<td>都压缩</td>
<td>85</td>
<td>50</td>
</tr>
<tr>
<td>只压缩 request</td>
<td>85</td>
<td>26</td>
</tr>
<tr>
<td>只压缩 response</td>
<td>64</td>
<td>50</td>
</tr>
<tr>
<td>都不压缩</td>
<td>64</td>
<td>26</td>
</tr>
<tr>
<td>其实这样子是对的，事实上 gzip 压缩的时候，在原数据比较小的时候，反而压缩后的体积会更大， 这也是为啥 nginx 要有一个 gzip_min_length 参数来控制压缩的最小字节数，一般我们是设置为 1k (默认值是 20)， 具体可以看 gzip 配置 gzip_min_length 来判断 response 是否要 gzip 压缩</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>接下来我们将 请求的 body 和 响应的 body 都调大一点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">respJson</span> <span class="o">:=</span> <span class="n">[</span><span class="nf">]byte</span><span class="p">(</span><span class="n">`{code: &#34;1&#34;,msg: &#34;success&#34;, des: &#34;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&#34;}`</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">var</span> <span class="n">requestBodyStr</span> <span class="o">=</span> <span class="n">`{&#34;name&#34;:&#34;zach ke&#34;,&#34;des&#34;:&#34;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&#34;, &#34;response_use_gzip&#34;: &#34;%s&#34;}`</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到 都压缩后的体积是:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">111</span>
<span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">,</span> <span class="n">des</span><span class="o">:</span> <span class="s">&#34;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhh
</span><span class="s">hhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&#34;</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">89</span>
<span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
<span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo
</span><span class="s"> boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">}</span>
<span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</code></pre></td></tr></table>
</div>
</div><p>分别是请求体积是 89， 响应体积 111。</p>
<p>而如果是没有压缩的，那么就是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">343</span>
<span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">,</span> <span class="n">des</span><span class="o">:</span> <span class="s">&#34;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhh
</span><span class="s">hhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&#34;</span><span class="p">}</span>
<span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">383</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
<span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo
</span><span class="s"> boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">}</span>
<span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</code></pre></td></tr></table>
</div>
</div><p>分别是请求体积是 383， 响应体积 343。 可以看到这个压缩率就不错了。</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>基本上数据量越多的话， 用 gzip 能省的流量越多，而且还能够加快网络传输，何乐而不为。 (事实上，还可以设置压缩比例和压缩算法，我这边为了演示，只使用默认的配置)</p>
<p>不过request 请求的话，如果用 gzip 的话，会影响性能的，数据量越大的话， 压缩和解压所消耗的时间也会越长，所以一般 pc 端的站点也不需要， 只有一些对流量消耗比较敏感的 app 可以考虑用这种方式。</p>
<h2 id="转载">转载<a hidden class="anchor" aria-hidden="true" href="#转载">#</a></h2>
<p><a href="https://kebingzao.com/2021/02/03/request-use-gzip/">http 请求的时候使用 gzip 压缩来减少流量消耗</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/gzip/">gzip</a></li>
      <li><a href="/tags/go/">Go</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
