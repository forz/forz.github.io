<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go在http开启gzip - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Forz" /><meta name="description" content="前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="/post/go%E5%9C%A8http%E5%BC%80%E5%90%AFgzip/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.98f8e47918247c097fa26317cbb567fe9f05503485bf08d8547f5579543303b1.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Go在http开启gzip" />
<meta property="og:description" content="前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/go%E5%9C%A8http%E5%BC%80%E5%90%AFgzip/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-04-29T19:35:47+00:00" />
<meta property="article:modified_time" content="2021-04-29T19:35:47+00:00" />

<meta itemprop="name" content="Go在http开启gzip">
<meta itemprop="description" content="前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到"><meta itemprop="datePublished" content="2021-04-29T19:35:47+00:00" />
<meta itemprop="dateModified" content="2021-04-29T19:35:47+00:00" />
<meta itemprop="wordCount" content="2209">
<meta itemprop="keywords" content="gzip,Go," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go在http开启gzip"/>
<meta name="twitter:description" content="前言 我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Forz Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
      <a class="menu-item-link" href="/">Home</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/post/">Archives</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/categories/">Categories</a>
    </li>
  </ul>
</nav><div class="docsearch-input__container">
  <input type="search" class="docsearch-input" placeholder="Search" />
</div>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go在http开启gzip</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-04-29 </span>
        <div class="post-category">
            <a href="/categories/go/"> Go </a>
            </div>
          <span class="more-meta"> 约 2209 字 </span>
          <span class="more-meta"> 预计阅读 5 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#实操">实操</a>
      <ul>
        <li><a href="#客户端">客户端</a></li>
        <li><a href="#服务端">服务端</a></li>
        <li><a href="#运行起来">运行起来</a></li>
      </ul>
    </li>
    <li><a href="#判断是否压缩">判断是否压缩</a>
      <ul>
        <li><a href="#gzip-压缩后体积更大的情况">gzip 压缩后体积更大的情况</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a></li>
    <li><a href="#转载">转载</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="前言">前言</h2>
<p>我们知道一般无论是 CDN 还是 服务端的接口(nginx 配置gzip以优化站点资源加载速度)，在响应返回的时候，都会配置 gzip 来压缩响应数据，以达到减少体积，加快网络传输的效能。 但是 gzip 压缩只用于 response 的响应数据，一般来说针对 pc 端的站点来说，足够了。</p>
<p>但是有时候针对手机 app 来说，光是 response 用 gzip 压缩还不够， 因为 request 请求的时候，如果有时候 body 体带上很多数据的话，还是会导致体积很大，从而消耗流量。 手机的流量可比 pc 的流量贵多了。 因此对于有些比较注重流量消耗的 app 来说，最好也要做到 request 请求的时候，也用上 gzip 来压缩数据，然后服务端在 nginx 或者程序的网关那边，再根据请求头 Content-Encoding 是否为 gzip 来判断是否要对请求的数据进行 gzip 解压缩。</p>
<h2 id="实操">实操</h2>
<p>接下来我将通过用 golang 语言来模拟客户端的请求和服务端的响应是否要带上 gzip 头部，来模拟这一过程，代码很简单，而且已经极简了，客户端代码就是 client.go, 服务端代码就是 server.go， 不需要用到第三方库。 (我的 golang 环境是 1.13.8)</p>
<h3 id="客户端">客户端</h3>
<p>client.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;bytes&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;compress/gzip&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;io/ioutil&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">requestUseGzip</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;req_use_gzip&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="s">&#34;has request body use gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">responseUseGzip</span> <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;resp_use_gzip&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">,</span> <span class="s">&#34;has response body use gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">requestBodyStr</span> <span class="p">=</span> <span class="s">`{&#34;name&#34;:&#34;zach ke&#34;,&#34;des&#34;:&#34;woooooo boy&#34;, &#34;response_use_gzip&#34;: &#34;%s&#34;}`</span>
</span></span><span class="line"><span class="cl">	<span class="nx">data</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="nx">requestBodyStr</span><span class="p">,</span> <span class="o">*</span><span class="nx">responseUseGzip</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">httpRequest</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="o">*</span><span class="nx">requestUseGzip</span> <span class="o">==</span> <span class="s">&#34;1&#34;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request with gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">zBuf</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
</span></span><span class="line"><span class="cl">		<span class="nx">zw</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zBuf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">zw</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;gzip is faild,err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">zw</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">httpRequest</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="s">&#34;http://localhost:9905/request&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">zBuf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;http request is failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">httpRequest</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request without gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">reader</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">httpRequest</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">,</span> <span class="s">&#34;http://localhost:9905/request&#34;</span><span class="p">,</span> <span class="nx">reader</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;http request is failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过参数判断是否返回值要用 gzip 压缩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span><span class="o">*</span><span class="nx">responseUseGzip</span> <span class="o">==</span> <span class="s">&#34;1&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">httpRequest</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 这个也要指定，不然 response 那边获取 content-length 头部会取不到值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">httpRequest</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;deflate&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">httpResponse</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">httpRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;httpResponse is failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;respone content length=&#34;</span><span class="p">,</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">ContentLength</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">==</span> <span class="mi">200</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">respBody</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">		<span class="k">switch</span> <span class="nx">httpResponse</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="s">&#34;gzip&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;response with gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">reader</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">httpResponse</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;gzip get reader err &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">reader</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">respBody</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;response without gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">bodyByte</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">httpResponse</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">respBody</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">bodyByte</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;resp data=&#34;</span><span class="p">,</span> <span class="nx">respBody</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到，我这边通过 flag 来控制本次请求中， request 是否要 gzip 压缩，要求 response 是否也要 gzip 压缩返回。 所以总共有以下四种可能:</p>
<ol>
<li>request gzip 压缩， response gzip 压缩</li>
<li>request gzip 压缩， response 不 压缩</li>
<li>request 不 压缩， response gzip 压缩</li>
<li>request 不 压缩， response 不 压缩</li>
</ol>
<h3 id="服务端">服务端</h3>
<p>server.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;compress/gzip&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;io/ioutil&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;bytes&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">handler</span><span class="p">(</span><span class="nx">resp</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">bodyDataStr</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 是否需要解 gzip 压缩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;resquest content length=&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ContentLength</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;gzip&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request with gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">body</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;unzip is failed, err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;read all is failed.err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">bodyDataStr</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request without gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;read resp is failed, err: &#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">bodyDataStr</span> <span class="p">=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;request json string=&#34;</span><span class="p">,</span> <span class="nx">bodyDataStr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">respJson</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{code: &#34;1&#34;,msg: &#34;success&#34;}`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// 通过头部的 Accept-Encoding 判断返回值是否要用 gzip 压缩
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;gzip&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;response with gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 添加 gzip 头部
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">resp</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">zBuf</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
</span></span><span class="line"><span class="cl">		<span class="nx">zw</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zBuf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">zw</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">respJson</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">zw</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;gzip is faild,err:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">zw</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//fmt.Println(&#34;gzip content:&#34;, string(zBuf.Bytes()))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">resp</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">zBuf</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;response without gzip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 正常不压缩 返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">resp</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">respJson</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;http://localhost:9905/request&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/request&#34;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:9905&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="运行起来">运行起来</h3>
<p>首先先运行服务端:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">go</span> <span class="n">run</span> <span class="n">server.go</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>接下来针对以上 4 种情况，分别运行 客户端 程序，然后查看一下服务端的输出</p>
<h4 id="1-都压缩">1. 都压缩</h4>
<p>客户端指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="o">~</span> <span class="o">&gt;</span><span class="n">go</span> <span class="n">run</span> <span class="n">client.go</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">50</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">85</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2-request-压缩-response-不压缩">2. request 压缩， response 不压缩</h4>
<p>客户端指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="o">~</span> <span class="o">&gt;</span><span class="n">go</span> <span class="n">run</span> <span class="n">client.go</span> <span class="o">-</span><span class="n">resp_use_gzip</span><span class="o">=</span><span class="m">0</span> <span class="o">-</span><span class="n">req_use_gzip</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">26</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">85</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3-request-不压缩-response-压缩">3. request 不压缩， response 压缩</h4>
<p>客户端指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="o">~</span> <span class="o">&gt;</span><span class="n">go</span> <span class="n">run</span> <span class="n">client.go</span> <span class="o">-</span><span class="n">resp_use_gzip</span><span class="o">=</span><span class="m">1</span> <span class="o">-</span><span class="n">req_use_gzip</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">50</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">64</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4-都不压缩">4. 都不压缩</h4>
<p>客户端指令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="o">~</span> <span class="o">&gt;</span><span class="n">go</span> <span class="n">run</span> <span class="n">client.go</span> <span class="o">-</span><span class="n">resp_use_gzip</span><span class="o">=</span><span class="m">0</span> <span class="o">-</span><span class="n">req_use_gzip</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">26</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">64</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="判断是否压缩">判断是否压缩</h2>
<p>其实判断是否要用 gzip 压缩很简单，通过 request 或者 response 的头部设置即可:</p>
<ol>
<li>如果自身设置 Content-Encoding 为 gzip, 说明你的数据是 gzip 压缩过的， 对方要进行 gzip 解压才行</li>
<li>如果你希望对方给你的数据是 gzip 压缩过的，那么就设置头部 Accept-Encoding 为 gzip</li>
</ol>
<h3 id="gzip-压缩后体积更大的情况">gzip 压缩后体积更大的情况</h3>
<p>不知道以上有一种情况，你们有没有发现过，就是无论是 request 还是 response 的数据， gzip 压缩过后的字节体积比原先更多了，反而是不压缩的字节体积更小，为了更直观，我列个表格:</p>
<table>
<thead>
<tr>
<th>-</th>
<th>请求 body 字节</th>
<th>响应 body 字节</th>
</tr>
</thead>
<tbody>
<tr>
<td>都压缩</td>
<td>85</td>
<td>50</td>
</tr>
<tr>
<td>只压缩 request</td>
<td>85</td>
<td>26</td>
</tr>
<tr>
<td>只压缩 response</td>
<td>64</td>
<td>50</td>
</tr>
<tr>
<td>都不压缩</td>
<td>64</td>
<td>26</td>
</tr>
<tr>
<td>其实这样子是对的，事实上 gzip 压缩的时候，在原数据比较小的时候，反而压缩后的体积会更大， 这也是为啥 nginx 要有一个 gzip_min_length 参数来控制压缩的最小字节数，一般我们是设置为 1k (默认值是 20)， 具体可以看 gzip 配置 gzip_min_length 来判断 response 是否要 gzip 压缩</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>接下来我们将 请求的 body 和 响应的 body 都调大一点</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">respJson</span> <span class="o">:=</span> <span class="n">[</span><span class="nf">]byte</span><span class="p">(</span><span class="n">`{code: &#34;1&#34;,msg: &#34;success&#34;, des: &#34;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&#34;}`</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">var</span> <span class="n">requestBodyStr</span> <span class="o">=</span> <span class="n">`{&#34;name&#34;:&#34;zach ke&#34;,&#34;des&#34;:&#34;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&#34;, &#34;response_use_gzip&#34;: &#34;%s&#34;}`</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到 都压缩后的体积是:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">111</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">,</span> <span class="n">des</span><span class="o">:</span> <span class="s">&#34;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhh
</span></span></span><span class="line"><span class="cl"><span class="s">hhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&#34;</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">89</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo
</span></span></span><span class="line"><span class="cl"><span class="s"> boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">with</span> <span class="n">gzip</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分别是请求体积是 89， 响应体积 111。</p>
<p>而如果是没有压缩的，那么就是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">respone</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">343</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">resp</span> <span class="n">data</span><span class="o">=</span> <span class="p">{</span><span class="n">code</span><span class="o">:</span> <span class="s">&#34;1&#34;</span><span class="p">,</span><span class="n">msg</span><span class="o">:</span> <span class="s">&#34;success&#34;</span><span class="p">,</span> <span class="n">des</span><span class="o">:</span> <span class="s">&#34;12asdfsafsafsagaegewgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhhhhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrwgsdfsdfsdfsdfgghhhhhhhh
</span></span></span><span class="line"><span class="cl"><span class="s">hhsfgegrfsdffffffffffadffwefwefefwafrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrr&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">resquest</span> <span class="n">content</span> <span class="n">length</span><span class="o">=</span> <span class="m">383</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">request</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span><span class="line"><span class="cl"><span class="n">request</span> <span class="n">json</span> <span class="n">string</span><span class="o">=</span> <span class="p">{</span><span class="s">&#34;name&#34;</span><span class="o">:</span><span class="s">&#34;zach ke&#34;</span><span class="p">,</span><span class="s">&#34;des&#34;</span><span class="o">:</span><span class="s">&#34;woooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo
</span></span></span><span class="line"><span class="cl"><span class="s"> boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boywoooooo boy&#34;</span><span class="p">,</span> <span class="s">&#34;response_use_gzip&#34;</span><span class="o">:</span> <span class="s">&#34;0&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">response</span> <span class="n">without</span> <span class="n">gzip</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>分别是请求体积是 383， 响应体积 343。 可以看到这个压缩率就不错了。</p>
<h2 id="总结">总结</h2>
<p>基本上数据量越多的话， 用 gzip 能省的流量越多，而且还能够加快网络传输，何乐而不为。 (事实上，还可以设置压缩比例和压缩算法，我这边为了演示，只使用默认的配置)</p>
<p>不过request 请求的话，如果用 gzip 的话，会影响性能的，数据量越大的话， 压缩和解压所消耗的时间也会越长，所以一般 pc 端的站点也不需要， 只有一些对流量消耗比较敏感的 app 可以考虑用这种方式。</p>
<h2 id="转载">转载</h2>
<p><a href="https://kebingzao.com/2021/02/03/request-use-gzip/">http 请求的时候使用 gzip 压缩来减少流量消耗</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-04-29
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/gzip/">gzip</a>
          <a href="/tags/go/">Go</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/gin%E7%9A%84gzip%E4%B8%AD%E9%97%B4%E4%BB%B6nanmu42-gzip/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Gin的gzip中间件nanmu42-gzip</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/http%E5%8D%8F%E8%AE%AE%E4%B8%AD%E7%9A%84content-encoding/">
            <span class="next-text nav-default">HTTP协议中的Content-Encoding</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>Forz</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>






<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
docsearch({
    apiKey: "b4b9da2eba53aa6dabe4b8ac9e8676e1",
    indexName: "forz.forzvina.com",
    appId: "IAR2EF5L65",
    inputSelector: '.docsearch-input',
    debug: false,
});
</script>
</body>
</html>
