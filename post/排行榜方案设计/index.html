<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>排行榜方案设计 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Forz" /><meta name="description" content="业务分类 排行榜业务变化多样，从不同的角度思考，是不同的排行榜需求，但总结起来，主要分为以下几类： 实效性 从排行榜的实效性上划分，主要分为： 实时" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.93.2 with theme even" />


<link rel="canonical" href="/post/%E6%8E%92%E8%A1%8C%E6%A6%9C%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.98f8e47918247c097fa26317cbb567fe9f05503485bf08d8547f5579543303b1.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="排行榜方案设计" />
<meta property="og:description" content="业务分类 排行榜业务变化多样，从不同的角度思考，是不同的排行榜需求，但总结起来，主要分为以下几类： 实效性 从排行榜的实效性上划分，主要分为： 实时" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/%E6%8E%92%E8%A1%8C%E6%A6%9C%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-01-14T13:58:53+00:00" />
<meta property="article:modified_time" content="2022-01-14T13:58:53+00:00" />

<meta itemprop="name" content="排行榜方案设计">
<meta itemprop="description" content="业务分类 排行榜业务变化多样，从不同的角度思考，是不同的排行榜需求，但总结起来，主要分为以下几类： 实效性 从排行榜的实效性上划分，主要分为： 实时"><meta itemprop="datePublished" content="2022-01-14T13:58:53+00:00" />
<meta itemprop="dateModified" content="2022-01-14T13:58:53+00:00" />
<meta itemprop="wordCount" content="8129">
<meta itemprop="keywords" content="架构," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="排行榜方案设计"/>
<meta name="twitter:description" content="业务分类 排行榜业务变化多样，从不同的角度思考，是不同的排行榜需求，但总结起来，主要分为以下几类： 实效性 从排行榜的实效性上划分，主要分为： 实时"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Forz Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
      <a class="menu-item-link" href="/">Home</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/post/">Archives</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/tags/">Tags</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/categories/">Categories</a>
    </li>
  </ul>
</nav><div class="docsearch-input__container">
  <input type="search" class="docsearch-input" placeholder="Search" />
</div>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">排行榜方案设计</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-01-14 </span>
        <div class="post-category">
            <a href="/categories/%E6%9E%B6%E6%9E%84/"> 架构 </a>
            </div>
          <span class="more-meta"> 约 8129 字 </span>
          <span class="more-meta"> 预计阅读 17 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#业务分类">业务分类</a>
      <ul>
        <li><a href="#实效性">实效性</a></li>
        <li><a href="#业务数据类型">业务数据类型</a></li>
        <li><a href="#展示唯度">展示唯度</a></li>
        <li><a href="#展示数据量">展示数据量</a></li>
      </ul>
    </li>
    <li><a href="#基于mysql">基于MySQL</a>
      <ul>
        <li><a href="#亿级数据获取topn">亿级数据获取TopN</a></li>
      </ul>
    </li>
    <li><a href="#基于redis">基于Redis</a>
      <ul>
        <li><a href="#好友排行榜">好友排行榜</a></li>
        <li><a href="#七天排行榜">七天排行榜</a></li>
        <li><a href="#多维度排序">多维度排序</a></li>
        <li><a href="#亿级数据排行榜">亿级数据排行榜</a></li>
      </ul>
    </li>
    <li><a href="#定时刷新">定时刷新</a></li>
    <li><a href="#缓存击穿">缓存击穿</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="业务分类">业务分类</h2>
<p>排行榜业务变化多样，从不同的角度思考，是不同的排行榜需求，但总结起来，主要分为以下几类：</p>
<h3 id="实效性">实效性</h3>
<p>从排行榜的实效性上划分，主要分为：</p>
<ul>
<li>实时榜：基于当前一段时间内数据的实时更新，进行排行。例如：当前一小时内游戏热度实时榜，当前一小时内明星送花实时榜等</li>
<li>历史榜：基于历史一段周期内的数据，进行排行。例如：日榜（今天看昨天的），周榜（上一周的），月榜（上个月的），年榜（上一年的)</li>
</ul>
<h3 id="业务数据类型">业务数据类型</h3>
<p>从需要排行的数据类型上划分，主要分为：</p>
<ul>
<li>单类型数据排行榜：是指需要排行的主体不需要区分类型，例如，所有用户积分排行，所有公贡献值排行，所有游戏热度排行等</li>
<li>多类型（复合类型）数据排行榜：是指需要排行的主体在排行中要求有类型上的区分，例如：竞技类游戏热度排行、体育类游戏热度排行、MOBA类游戏操作性排行、角色/回合/卡牌三类游戏热度排行等</li>
</ul>
<h3 id="展示唯度">展示唯度</h3>
<p>从榜单的最终展示唯度上划分，主要分为：</p>
<ul>
<li>单唯度：是指选择展示的排行榜就是基于一个唯度下的排行，例如前面提到的MOBA类游戏操作性排行榜，就仅展示所有MOBA类游戏按操作性的评分排行</li>
<li>多唯度：是指选择展示的排行榜还有多种唯度供用户选择，仍然以前面的MOBA类游戏为例，唯度除了操作性，还有音效评分排行，难易度评分排行，画面评分排行等。</li>
</ul>
<h3 id="展示数据量">展示数据量</h3>
<p>从需要展示的数据量上划分，主要分为：</p>
<ul>
<li>topN数据：只要求展示topN条排行纪录，例如：最火MOBA游戏top20</li>
<li>全量数据：要求展示所有数据的排行，例如：所有用户的积分排行</li>
</ul>
<p>在以上几种榜单中，往往还会有需要加入，当前用户自身的一些数据在排行榜中的位置。</p>
<h2 id="基于mysql">基于MySQL</h2>
<p>先看下数据库的结构，总共有 2 个表：用户表 和 用户积分表。</p>
<p>用户表存储了用户信息，以及用户的总积分（实时更新），也就是说总积分榜需要的数据可以直接从这里取到，不需要再去计算。</p>
<p>用户表内容：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/202201141654600.png" alt=""></p>
<p>如果要取前 10 名，只需要把所有用户的信息先取出来，再排个序就好啦，写 SQL 语句查询的话就是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="k">user</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">score</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后如果要取自己的总排名,先用 SQL 语句查出用户的分数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="cm">/*只取需要的列*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">myScore</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="k">user</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;用户 id&#34;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>然后再用 SQL 语句统计分数大于该用户分数的数量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="k">user</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w"> </span><span class="n">score</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">myScore</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>最后只需要将该查询结果加 1，就是自己的排名啦~</p>
<h3 id="亿级数据获取topn">亿级数据获取TopN</h3>
<p>下面让我们加大难度，假如用户数再多一点点呢，比如说一亿个，怎么实时获取前 10 名呢？</p>
<p>其实 Top N 问题的核心在于保证空间和时间复杂度，先要考虑数据能存入内存运算，在怎样算得更快。</p>
<p>通常 Top N 问题有下列几种解决方案。</p>
<p>全部排序</p>
<p>直接对所有数据进行排序（快排等），缺点是需要将数据一次性加载到内存中。</p>
<p>局部淘汰</p>
<p>内存中维护一个大小为 N 的容器，再让剩余的数一个个进入容器，并淘汰容器内的最小值。最终容器内剩下的数就是前 N 名。优点是能节省内存，缺点是太慢了。</p>
<p>分治</p>
<p>把数据分为多个小组，小组内先分别选出前 N 名小组长，最后再让这些小组长同台竞技，选出最终的前 N 名。</p>
<p>哈希预处理</p>
<p>假如数据重复度很高，可以通过 hash 的方式，去掉很多重复数据。比如 1 亿个数据里，一半是 0，一半是 1，那么取前 10 名时，可以直接淘汰掉另一半为 0 的数据。</p>
<p>但是预处理本身也需要时间和空间，这就需要我们对数据的重复度有一个清晰的判断，否则自作聪明、适得其反。</p>
<p>小根堆</p>
<p>面试算法中的高频考点 —— 堆排序，可以先取前 N 个数组成小根堆，堆顶始终是最小值。 然后遍历后续数字，大于堆顶就替换掉堆顶并调整最小堆结构。该算法时间复杂度和空间复杂度（为 N，常数）都不错，所以必须要掌握。</p>
<p>但是具体选择哪种方案呢？还是要结合我们实际的项目和业务场景来分析。</p>
<p>实际解决</p>
<p>使用MySQL排名的主要当查询单表用户范围大于10w就不适合做排名，对相应的的score字段创建索引可以加速排序。如上文的分桶排名策略，首先统计规划合理的得分范围，比如将1000w用户记录平均依据得分直方图拆分到均匀的100张得分表中:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">leaderboard_bucke_$id</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">uid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;用户id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">score</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">conmment</span><span class="w"> </span><span class="s1">&#39;得分&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">created_time</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;创建时间&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;uid`),
</span></span></span><span class="line"><span class="cl"><span class="s1">      KEY`score_idx`(`score`)
</span></span></span><span class="line"><span class="cl"><span class="s1">) ENGINE=InnoDB COMMENT=&#39;</span><span class="err">排名分表</span><span class="s1">&#39;;
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">leaderboard</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">uid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;用户id&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">score</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="n">conmment</span><span class="w"> </span><span class="s1">&#39;得分&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">created_time</span><span class="w"> </span><span class="nb">date</span><span class="w"> </span><span class="k">comment</span><span class="w"> </span><span class="s1">&#39;创建时间&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;uid`),
</span></span></span><span class="line"><span class="cl"><span class="s1">     KEY`score_idx`(`score`)
</span></span></span><span class="line"><span class="cl"><span class="s1">) ENGINE=InnoDB COMMENT=&#39;</span><span class="err">排名总表</span><span class="s1">&#39;;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>更新用户时，依据uid查询leaderboard表，查找用户得分，与当前得分进行比较更新<code>leaderboard_bucke_$id</code>表中记录，使用redis维护一个分桶用户数缓存比如每一分钟失效。</p>
<p>查询单用户排名时，使用 <code>select count(uid) from leaderboard_bucke_$id where score&gt;= $score and uid&gt;= $uid order by score</code> 即可查询得到相关用户的得分排名，累加相应比当前分桶高的分桶表用户数即得到用户排名。</p>
<p>MySQL的分表做不到Redis那么的迅速，但是保证用户分表用数户均匀恰当能够觉得可以满足你的排名需要。当前大多数数据库都支持分布式，所以其他数据库如MongoDB，PostgreSQL都是可以考虑作为排名存储用的数据库。</p>
<h2 id="基于redis">基于Redis</h2>
<p>这个场景其实就是在考察你对于 Redis 的 sorted set 数据结构的掌握。</p>
<p>sorted set，见名知意，就是有序集合的意思。</p>
<p>在 Redis 中它大概是长这样的：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/202201141704501.png" alt=""></p>
<p>另一个需要注意的点是，虽然我的示意图中没有体现出来，但是在有序集合中，元素即 member 是不可以重复的，但是 score 是可以重复的。当多个元素具有相同的分数时，它们按照 lexicographically 进行排序。当分数一样的时候，按照字典序排序，所以上面的示意图 jay 在 why 之前。</p>
<p>我这里只讲几个需要用到的操作：</p>
<ul>
<li>添加 member 命令格式：zadd key score member [score member &hellip;]</li>
<li>增加 member 的 score 命令格式：zincrby key increment member</li>
<li>获取 member 排名命令格式：zrank/zrevrank key member</li>
<li>返回指定排名范围内的 member 命令格式：zrange/zrevrange key start end [withscores]</li>
</ul>
<p>比如我们把示意图中的数据添加到到有序集合里面去，语法是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">key</span> <span class="n">score</span> <span class="n">member</span> <span class="n">[score</span> <span class="n">member</span> <span class="kc">...</span><span class="n">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>意思是可以一次添加一对或者多对 score-member，比如下面这两个命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="m">20210227</span> <span class="m">10026</span> <span class="n">why</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个时候其实我们想要存储的是 User 对象，对象里面有这几个字段：昵称、头像图片链接、点赞数、步数。</p>
<p>你说，这个用 Redis 的啥数据结构来存？</p>
<p>可不就得用 Hash 结构了吗。</p>
<p>Hash 结构同样涉及到 key 和 value，那么它们分别是什么呢？</p>
<p>key 就是我们的有序集合的 key 后面再加上昵称，比如这样的：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/202201141809073.png" alt=""></p>
<p>对应的命令是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">hmset</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210227</span><span class="o">:</span><span class="n">jay</span> <span class="n">nickName</span> <span class="n">jay</span> <span class="n">headPhoto</span> <span class="n">xxx</span> <span class="n">likeNum</span> <span class="m">520</span> <span class="n">walkNum</span> <span class="m">66079</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行完成之后，在 RDM 里面看起来是这样的：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/202201141810473.png" alt=""></p>
<p>当后续有更多的赞的时候，需要调用更新命令更新 likeNum：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">hincrby</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210227</span><span class="o">:</span><span class="n">jay</span> <span class="n">likeNum</span> <span class="m">500</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行完成之后点赞数就会变成 1020：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/202201141810380.png" alt=""></p>
<p>这样，排行榜上的所有字段我们都能获取到了，微信排行榜就说完了。</p>
<h3 id="好友排行榜">好友排行榜</h3>
<p>微信步数排行榜有个问题，每个人看见的数据排行数据来源自己的微信好友，而微信好友各不相同，所以看到的排行榜也各不相同。</p>
<p>我们上面的场景更加类似于游戏排行榜，所有的人看到的全服排行榜都是一样的。</p>
<p>那么怎么保证我们每个人看到的各不相同呢？</p>
<p>如果每个用户都有在redis有一个自己的排行榜，一个用户的分数更新的时候就需要对所有好友的zset更新，这多大的代价啊，对吧？</p>
<p>当以用户为纬度做排行榜的时候，就会出现排行榜巨多的情况，导致维护成本升高。</p>
<p>每个用户看到的排行榜不一样，我们其实不用时时刻刻帮用户维护好排行榜。维护好了，用户还不一定来看，出力不讨好的节奏。所以还不如延迟到用户请求的阶段。</p>
<p>当用户请求查看排行榜的时候，再去根据用户的好友关系，循环获取好友的步数，生成排行榜。</p>
<h3 id="七天排行榜">七天排行榜</h3>
<p>我们提供一个最近七天、上一周、上一月、上个季度、这一年排行榜啥的，又该怎么搞呢？</p>
<p>其实这还是在考察你对于 Redis 有序集合 API 的掌握程度。</p>
<ul>
<li>zinterstore/zunionstore其实就是交集/并集</li>
<li>destination 将交集/并集的结果保存到这个键中</li>
<li>numkeys 需要做交集/并集的集合的个数</li>
<li>key [key &hellip;] 具体参与交集/并集的集合</li>
<li>weights weight [weight &hellip;] 每个参与计算的集合的权重。在做交集/并集计算时，每个集合中的 member 会把自己的 score 乘以这个权重，默认为 1。</li>
<li>aggregate sum|min|max 对于各个集合中的相同元素是 sum(求和)、min(取最小值)还是max(取最大值)，默认为 sum。</li>
</ul>
<p>拿最近七天举例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210222</span> <span class="m">43243</span> <span class="n">why</span> <span class="m">2341</span> <span class="n">mx</span> <span class="m">8764</span> <span class="n">les</span> <span class="m">42321</span> <span class="n">skr</span>
</span></span><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210223</span> <span class="m">57632</span> <span class="n">why</span> <span class="m">24354</span> <span class="n">mx</span> <span class="m">4231</span> <span class="n">les</span> <span class="m">43512</span> <span class="n">skr</span> <span class="m">5341</span> <span class="n">jay</span>
</span></span><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210224</span> <span class="m">10026</span> <span class="n">why</span> <span class="m">12344</span> <span class="n">mx</span> <span class="m">54312</span> <span class="n">les</span> <span class="m">34531</span> <span class="n">skr</span> <span class="m">43512</span> <span class="n">jay</span>
</span></span><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210225</span> <span class="m">54312</span> <span class="n">why</span> <span class="m">32451</span> <span class="n">mx</span> <span class="m">23412</span> <span class="n">les</span> <span class="m">21341</span> <span class="n">skr</span> <span class="m">56321</span> <span class="n">jay</span>
</span></span><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210226</span> <span class="m">3212</span> <span class="n">why</span> <span class="m">63421</span> <span class="n">mx</span> <span class="m">53652</span> <span class="n">les</span> <span class="m">45621</span> <span class="n">skr</span> <span class="m">5723</span> <span class="n">jay</span>
</span></span><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210227</span> <span class="m">5462</span> <span class="n">why</span> <span class="m">10158</span> <span class="n">mx</span> <span class="m">30169</span> <span class="n">les</span> <span class="m">48858</span> <span class="n">skr</span> <span class="m">66079</span> <span class="n">jay</span>
</span></span><span class="line"><span class="cl"><span class="n">zadd</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210228</span> <span class="m">43553</span> <span class="n">why</span> <span class="m">4451</span> <span class="n">mx</span> <span class="m">7431</span> <span class="n">les</span> <span class="m">9563</span> <span class="n">skr</span> <span class="m">8232</span> <span class="n">jay</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到我们一共有 7 天的数据：</p>
<p>而且需要注意的是 20210222 这一天是没有 jay 的数据的。</p>
<p>现在我们要求出最近 7 天的排行榜，就用下面这行命令，命令有点复杂，但是对着命令格式看，还是很清晰的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">zunionstore</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="n">last_seven_day</span> <span class="m">7</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210222</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210223</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210224</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210225</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210226</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210227</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210228</span> <span class="n">weights</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="n">aggregate</span> <span class="n">sum</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这条命令后面的 weights 和 aggregate 都是可以不用写的，有默认值，我这里为了不隐藏数据，都写了出来。</p>
<p>执行完成后，可以看到多了一个 key，里面放的就是最近 7 天的数据汇总：</p>
<p>上面用的是并集，如果我们的要求是对最近 7 天，每天都上传运动数据的人进行排序，就用交集来算。</p>
<p>命令和上面的一致，只是把 zunionstore 修改为 zinterstore 即可。</p>
<p>另外为了有对比，合并之后的队列名称也修改一下，命令如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">zinterstore</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="n">last_seven_day_zinterstore</span> <span class="m">7</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210222</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210223</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210224</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210225</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210226</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210227</span> <span class="n">sport</span><span class="o">:</span><span class="n">ranking</span><span class="o">:</span><span class="n">why</span><span class="o">:</span><span class="m">20210228</span> <span class="n">weights</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="n">aggregate</span> <span class="n">sum</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>从执行结果可以看出来，由于 jay 同学在 20210222 这一天没有上传运动数据，所以取交集的时候没有他了：</p>
<p>知道最近 7 天的做法了，我们又有每一天数据，上一周、上一月、上个季度、这一年排行榜啥的不都是这个套路吗？</p>
<h3 id="多维度排序">多维度排序</h3>
<p>一些需求中经常要我们实现一个排行榜，数据量少的话可以使用 RDB 数据库排序，数据量大可以自己实现算法或者使用 NoSQL 数据库排序，NoSQL 数据库中最方便的可能就是利用 Redis 的 zset 来实现了。 例如要实现一个玩家成就点数的排行榜：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">100</span> <span class="n">A</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">200</span> <span class="n">B</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">200</span> <span class="n">C</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">300</span> <span class="n">D</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zrange</span> <span class="n">r</span> <span class="m">0</span> <span class="m">-1</span> <span class="n">withscores</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span><span class="p">)</span> <span class="s">&#34;A&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span><span class="p">)</span> <span class="s">&#34;100&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span><span class="p">)</span> <span class="s">&#34;B&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span><span class="p">)</span> <span class="s">&#34;200&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span><span class="p">)</span> <span class="s">&#34;C&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">6</span><span class="p">)</span> <span class="s">&#34;200&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">7</span><span class="p">)</span> <span class="s">&#34;D&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">8</span><span class="p">)</span> <span class="s">&#34;300&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中 B 和 C 的分数是一样的，这时我们可能想让先达到对应分数的人排在前面，相当于增加了一个排序维度。这时直接用 score 就不能实现了，需要做一些转换，这里分享几个我会用到的方法。</p>
<p>假设我们需要一个三个维度的排序，第一维度是具体的数值，第二个维度是一个是否标志位，第三个维度是时间戳。其中氪金的（0否1是）和时间早的排序靠前。
以下是原始数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl">玩家  成就  是否氪金  时间戳
</span></span><span class="line"><span class="cl"><span class="n">A</span>    <span class="m">100</span>  <span class="m">1</span>        <span class="m">1571819021259</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span>    <span class="m">200</span>  <span class="m">0</span>        <span class="m">1571819021259</span>
</span></span><span class="line"><span class="cl"><span class="n">C</span>    <span class="m">200</span>  <span class="m">1</span>        <span class="m">1571819021259</span>
</span></span><span class="line"><span class="cl"><span class="n">D</span>    <span class="m">400</span>  <span class="m">0</span>        <span class="m">1571819021259</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span>    <span class="m">200</span>  <span class="m">1</span>        <span class="m">1571810001259</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="利用-key-排序">利用 key 排序</h4>
<p>如果后两个维度初始化后就不再变化的话，可以利用 Redis 的排序特性，将不变的维度写到 key 里，这样 score 相同时会用 key 来进行排序。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="c1"># 这里反转时间戳(9999999999999 - 1571810001259)，让时间早的排在前面</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">100</span> <span class="n">A</span><span class="m">-1-8428180978740</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">200</span> <span class="n">B</span><span class="m">-0-8428180978740</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">200</span> <span class="n">C</span><span class="m">-1-8428180978740</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">400</span> <span class="n">D</span><span class="m">-0-8428180978740</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zadd</span> <span class="n">r</span> <span class="m">200</span> <span class="n">E</span><span class="m">-1-8428189998740</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span><span class="n">zrange</span> <span class="n">r</span> <span class="m">0</span> <span class="m">-1</span> <span class="n">withscores</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="m">1</span><span class="p">)</span> <span class="s">&#34;A-1-8428180978740&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">2</span><span class="p">)</span> <span class="s">&#34;100&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">3</span><span class="p">)</span> <span class="s">&#34;B-0-8428180978740&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">4</span><span class="p">)</span> <span class="s">&#34;200&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">5</span><span class="p">)</span> <span class="s">&#34;C-1-8428180978740&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">6</span><span class="p">)</span> <span class="s">&#34;200&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">7</span><span class="p">)</span> <span class="s">&#34;E-1-8428189998740&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">8</span><span class="p">)</span> <span class="s">&#34;200&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">9</span><span class="p">)</span> <span class="s">&#34;D-0-8428180978740&#34;</span>
</span></span><span class="line"><span class="cl"> <span class="m">10</span><span class="p">)</span> <span class="s">&#34;400&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>以上就是第一种方法了，实现起来非常简单。</p>
<h4 id="score-存储格式">score 存储格式</h4>
<p>在介绍下两种方法前先来看看 zset 的 score 是怎么存储的，能保留多少精度，直接看跳表 node 的结构。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 跳跃表节点
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">zskiplistNode</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 成员对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">robj</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 分值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">double</span> <span class="n">score</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 后退指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="nc">zskiplistNode</span> <span class="o">*</span><span class="n">backward</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 层
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">struct</span> <span class="nc">zskiplistLevel</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 前进指针
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">struct</span> <span class="nc">zskiplistNode</span> <span class="o">*</span><span class="n">forward</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// 跨度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">span</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">level</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">zskiplistNode</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们可以看到 score 是用 double 存储的，它是一个 IEEE 754 标准的 double 浮点数。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/202201141814433.png" alt=""></p>
<p>一个 64 位浮点数存储时分为3段</p>
<ul>
<li>S:符号位，第一段，占1位，0表示正数，1表示负数。</li>
<li>Exp:指数字，第二段，占11位，移码方式表示正负数，排除全0和全1表示零和无穷大的特殊情况，指数部分是−1022～+1023加上1023，指数值的大小从1～2046</li>
<li>Fraction:有效数字，占52位，定点数，小数点放在尾数最前面</li>
</ul>
<p>实际数字 = <code>(-1)^S *Fraction* 2^Exp</code>  (二进制计算)</p>
<p>double 存储的有效数据是第三段的52位，超出会损失精度，由于标准规定小数点是在有效数字最前面，所以实际可以存储 53 位数字。比如有个数字是 111___(53个1)，有效数字位存储的是 .11___(52个1)，计算时会在个位补1，得到1.11___(53个1)，最大值为 2^53 = 9007199254740991，大概 log(2^53) = 15.95 位。</p>
<p>redis的zset中的score值为double类型，精度只有16位，事实上在存储9999999999999999 16位整数的时候，会变为17位的10000000000000000，超过17位会变为科学计数法1e+17。</p>
<p>可以看到只要保证有效数字小于等于9007199254740991就不会损失精度。</p>
<p>好了，现在有了理论基础，接下来看看我们可以怎么实现。</p>
<h5 id="十进制分段">十进制分段</h5>
<p>可以直接拆分十进制数，为了方便，还可以用小数划分维度，比如将分数放在整数位，标志位和时间戳放在小数位。不过浮点数的存储会有误差,通常不建议这样存储.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">A</span> <span class="m">100.1290072179</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="m">200.0290072179</span>
</span></span><span class="line"><span class="cl"><span class="n">C</span> <span class="m">200.1290072179</span>
</span></span><span class="line"><span class="cl"><span class="n">D</span> <span class="m">400.0290072179</span>
</span></span><span class="line"><span class="cl"><span class="n">E</span> <span class="m">200.1290081199</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>需求</p>
<p>等级排行，大家都是30级，谁先到30级谁第一。需要设计一个 【分数 = 等级 + 时间】 ，谁分数大谁第一，最后再根据分数能解析出来等级即可。</p>
<p>设计</p>
<ul>
<li>分数 = 等级 + 时间 （当前系统时间戳）</li>
<li>分数是 64位的长整型 Long (有符号)</li>
</ul>
<p>设计方式一</p>
<ul>
<li>long 分数，二进制用高 32位存 等级，低32位存时间（秒精度），那么数据看起是这样</li>
<li>A 玩家， 10 + 1111111111（时间戳）</li>
<li>后来 B 玩家也到 10 级， 10 + 2222222222（时间戳）</li>
<li>这样排序，最终还是 B 玩家 会排到第一名，不能达到目的。</li>
</ul>
<p>设计方式二</p>
<ul>
<li>long 整数长度总共有 19位，923XXX&hellip;&hellip;.，时间戳 毫秒精度 是 13位，所以只需 14 ~ 19 位存 等级，其他13位存时间。接下来看怎么存。</li>
<li>等级偏移： Math.power(10, 14) = 10000000000000000（14位）</li>
<li>这里有一个最大时间 MAX_TIME = 9999999999999 （13位）</li>
<li>A 玩家，（10 * 等级偏移） + MAX_TIME - 11111111111111（ 时间戳），最终分数 10888888888888888</li>
<li>B 玩家，（10 * 等级偏移） + MAX_TIME - 22222222222222（ 时间戳），最终分数 10777777777777777</li>
<li>最终排序，A 玩家依然是第一。通过分数可以解析出真实 【等级 = 分数 / 等级偏移，取整】</li>
</ul>
<p>劣势</p>
<ol>
<li>如果有三个，四个排序条件怎么办，这种情况还是推荐使用数据库，就别考虑 Redis了 。Redis 优势在于可以做到实时排行</li>
</ol>
<p>方式二 14 ~ 19位，那么等级最大数据就只能是 919999，超过这个数就会溢出。可以把时间戳降低到秒级别，可以支持更大数字</p>
<p>最大时间的取值:</p>
<ul>
<li>如果排行榜是临时的(超过某个时间就不存在或不保证数据的准确性), 那最大时间直接取排行榜的截止有效时间就可,这种方式时间信息占用的位数较少. (推荐)</li>
<li>如果排行榜一直存在就取一个固定值, 2050年? 这种时间占用位数较多, 但是可以降低时间精度缓解一点压力, 精确到秒? 或者占用几位小数(最好自己测一下精度有没有影响)</li>
</ul>
<h5 id="二进制分段">二进制分段</h5>
<p>第二种方法，可以利用二进制 64 位 long 分段存储各个维度。</p>
<p>首先时间戳如果全存储就太长了，可以通过一些计算缩小一些，先忽略毫秒，然后和一个大数计算差值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="line"><span class="cl"><span class="n">int</span> <span class="n">MAX_SECOND</span> <span class="o">=</span> <span class="m">1861891200</span><span class="p">;</span> <span class="o">//</span> <span class="m">2029.1.1</span> <span class="m">0</span><span class="o">:</span><span class="m">0</span><span class="o">:</span><span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="n">int</span> <span class="n">sts</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_SECOND</span> <span class="o">-</span> <span class="p">(</span><span class="n">int</span><span class="p">)(</span><span class="n">ts</span> <span class="o">/</span> <span class="m">1000</span><span class="p">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这样时间就缩小到了300000000以内。</p>
<p>接下来进行划分，首位标志位不用，剩下63位，然后我划分高33位存分数，1位存标志位，最后29位存时间戳，存储结构是这样的：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/202201141825983.png" alt=""></p>
<p>如果要不损失精度，第一段可存储位数 = 53 - 1 - 29 = 23。</p>
<p>第一段最大值 = 2^33 = 8589934591，不损失精度 = 2^23 = 8388607。
第三段最大值 = 2^29 = 536870911。</p>
<p>使用时可以适当缩短第三段时间戳的长度，或者不追求时间戳一定精确的话，第一段分数可以超出不损失精度的长度，也只会损失一点时间戳的精度而已。</p>
<p>然后就可以用下面的方法计算 score 了，因为是二进制，可以全用位运算。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">size1</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">size2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">size3</span> <span class="o">=</span> <span class="mi">29</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">d1Max</span> <span class="o">=</span> <span class="n">maxBySize</span><span class="p">(</span><span class="n">size1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">d2Max</span> <span class="o">=</span> <span class="n">maxBySize</span><span class="p">(</span><span class="n">size2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">long</span> <span class="n">d3Max</span> <span class="o">=</span> <span class="n">maxBySize</span><span class="p">(</span><span class="n">size3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 计算 score
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">public</span> <span class="kt">long</span> <span class="nf">genScore</span><span class="p">(</span><span class="kt">long</span> <span class="n">d1</span><span class="p">,</span> <span class="kt">long</span> <span class="n">d2</span><span class="p">,</span> <span class="kt">long</span> <span class="n">d3</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">d1</span> <span class="o">&amp;</span> <span class="n">d1Max</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">size2</span> <span class="o">+</span> <span class="n">size3</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">d2</span> <span class="o">&amp;</span> <span class="n">d2Max</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">size3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">d3</span> <span class="o">&amp;</span> <span class="n">d3Max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 计算增加 value 值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">public</span> <span class="kt">void</span> <span class="nf">incValue</span><span class="p">(</span><span class="kt">long</span> <span class="n">d1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">((</span><span class="n">d1</span> <span class="o">&amp;</span> <span class="n">d1Max</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">size2</span> <span class="o">+</span> <span class="n">size3</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="mi">0</span> <span class="o">&amp;</span> <span class="n">d2Max</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">size3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&amp;</span> <span class="n">d3Max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 根据二进制长度计算最大值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">private</span> <span class="kt">long</span> <span class="nf">maxBySize</span><span class="p">(</span><span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="p">((</span><span class="n">r</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>增加高位分数的话直接把低维度设为0，计算出分数后调用 ZINCRBY 就行了。</p>
<p>改变低位维度值的话就不能调用 ZINCRBY 了，需要调用ZADD，我们用自旋加 CAS 更新，防止覆盖掉新更新的值。</p>
<h3 id="亿级数据排行榜">亿级数据排行榜</h3>
<p>当用户足够多时，我们需要对排行榜的score依据你的系统用户已有的排名得分数据进行直方图统计，统计出每个score用户数量，然后对score进行合理范围拆分，比如score在0~100万范围，根据直方图统计后 0~10w， 10w~25w， 25w~30w，&hellip; ,50w~100w ,10个区间能将一千万用户拆成100w用户一个分桶范围，将对应得分用户分别储存在响应范围的分桶sorted set中。排名时简单缓存每个分桶sorted set的用户总数。对于查询top 排名时，只要查看最高分区桶sorted set排名即可， 对于查询个体用户的排名，需要外加一份用户得分记录存储于MySQL等数据库中，用于查询到单用户的得分，然后依据得分查找到得分存储在相应redis sorted set分桶排名，然后把高于当前分桶范围的分桶用户相加得到相关用户的排名。</p>
<p>更新用户得分时，首先需要查询到原有得分，然后如果用户的现在的得分比较如果得分分布的sorted set分桶已经不是原来的分桶，这是需要删除原桶用户记录，然后在新桶sorted set入录得分记录。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/202201141756674.png" alt=""></p>
<p>这种方案就能轻松应对亿级用户的游戏排行榜了，我这里是以积分排行榜来设计的，其它的类似。这里每个桶按照承载百万用户，然后分了100个桶，如果积分分布均匀的话，那就可以轻松应对了。当然你可能会说，有很多新手比如玩了几次这个游戏就没玩了，在[0,1000)区间这个桶内有很多用户。是的，这里我们实行之前，会有个预估。大一点的公司会有数据分析工程师来对游戏用户做个合理的预估，通过一系列高数、概率论的知识把这个分桶区间预估的尽可能准。</p>
<p>对于查询top排名时，只要查看最高分区桶sorted set排名即可。</p>
<p>对于查询个体用户的排名，根据用户的积分判断看在哪个桶里，计算本桶该用户的排名与高于当前分桶范围的分桶用户相加得到相关用户的排名。</p>
<h2 id="定时刷新">定时刷新</h2>
<p>虽然我们将排行榜数据存入zset中了, 但这个只是提高了我们的访问效率, 并不能完全保证数据的准确性. 可能会因为各种原因(并发, 网络异常)导致缓存数据不准确, 因此需要定时刷新缓存数据.</p>
<p>然后缓存刷新策略大概有一下几种:</p>
<ul>
<li>全量刷新: 把所有缓存数据都重新计算一遍, 比如每天刷一遍</li>
<li>增量刷新: 把一定时间内变化的缓存数据刷新, 每个小时刷一次</li>
<li>根据数据变化频率动态刷新: 类似redis持久化策略. 一定时间内变化的频率到达一个阈值就刷新.</li>
</ul>
<p>具体采取哪种策略也是看具体的需求, 对数据的准确性实时性需求、性能需求等. 可以同时结合多种策略. 以及时间间隔也取决于产品需求和刷新耗时.</p>
<p>大概就是使用一个定时任务, 查询数据库最近一段时间内积分变化的用户, 对这些用户的积分进行重算, 刷新缓存.</p>
<p>还有就是到了缓存过期的时候, 就别再刷了. 除非打算这个排行榜一直存在缓存中.</p>
<h2 id="缓存击穿">缓存击穿</h2>
<p>缓存肯定是要设置过期时间的, 过期时间肯定是在缓存数据不经常访问的时候. 那如果缓存过期后用户访问排行榜, 这个时候就需要从数据库中查询相关数据, 重新计算排行榜前n位(没必要全部重算), 显然重算排行榜是一个比较费事费力的操作.</p>
<p>但是假如这个时候是大量用户并发访问, 然后查询排行榜缓存, 发现没有数据, 于是都去查询数据库重算. 这个时候数据库压力就会很大, 很容易挂掉. 即缓存击穿.</p>
<p>然后解决方式大概有几种</p>
<ul>
<li>不设置过期时间, 不过期就不会失效.</li>
<li>加锁, 重新加载缓存的时候加锁, 防止所有的请求都去数据库查询重算.</li>
</ul>
<p>然后结合具体场景, 这里加载缓存时不一定时缓存过期了, 可能还没构建缓存, 就有大量用户访问该排行榜. 并且该排行榜缓存没有必要一直存在, 浪费空间.</p>
<h2 id="参考">参考</h2>
<p><a href="https://cloud.tencent.com/developer/article/1839898">带老弟做个实时排行榜</a></p>
<p><a href="https://segmentfault.com/a/1190000039320528">凉了呀，面试官叫我设计一个排行榜。</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/50770947">千万用户排名设计</a></p>
<p><a href="https://segmentfault.com/a/1190000039216771">亿级用户游戏排行榜设计方案</a></p>
<p><a href="https://juejin.cn/post/6844903977234989063">让 Redis zset 支持多条件排序</a></p>
<p><a href="https://www.codeleading.com/article/58885280615/">Redis-ZSet排序，分数相同的时候按照时间排序</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2022-01-14
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E6%9E%B6%E6%9E%84/">架构</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/%E7%BA%A2%E5%8C%85%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">红包方案设计</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/go%E5%AE%9E%E7%8E%B0%E5%8D%81%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2%E4%BB%BB%E6%84%8F%E8%BF%9B%E5%88%B6/">
            <span class="next-text nav-default">Go实现十进制转换任意进制</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>Forz</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>






<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
docsearch({
    apiKey: "b4b9da2eba53aa6dabe4b8ac9e8676e1",
    indexName: "forz.forzvina.com",
    appId: "IAR2EF5L65",
    inputSelector: '.docsearch-input',
    debug: false,
});
</script>
</body>
</html>
