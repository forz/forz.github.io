<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>GoKit源码:服务注册与发现 | Forz Blog</title>
<meta name="keywords" content="GoKit, etcd" />
<meta name="description" content="etcdv3目录结构 1 2 3 4 5 6 7 8 ├── client.go 客户端 ├── doc.go ├── example_test.go ├── instancer.go 服务实例 ├── instancer_test.go ├── integration_test.go ├── registrar.go 注册器 └── registrar_test.go 目录中主要的是这三个">
<meta name="author" content="">
<link rel="canonical" href="/post/gokit%E6%BA%90%E7%A0%81%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="GoKit源码:服务注册与发现" />
<meta property="og:description" content="etcdv3目录结构 1 2 3 4 5 6 7 8 ├── client.go 客户端 ├── doc.go ├── example_test.go ├── instancer.go 服务实例 ├── instancer_test.go ├── integration_test.go ├── registrar.go 注册器 └── registrar_test.go 目录中主要的是这三个" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/gokit%E6%BA%90%E7%A0%81%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-09-02T17:43:22&#43;00:00" />
<meta property="article:modified_time" content="2019-09-02T17:43:22&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GoKit源码:服务注册与发现"/>
<meta name="twitter:description" content="etcdv3目录结构 1 2 3 4 5 6 7 8 ├── client.go 客户端 ├── doc.go ├── example_test.go ├── instancer.go 服务实例 ├── instancer_test.go ├── integration_test.go ├── registrar.go 注册器 └── registrar_test.go 目录中主要的是这三个"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "GoKit源码:服务注册与发现",
      "item": "/post/gokit%E6%BA%90%E7%A0%81%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "GoKit源码:服务注册与发现",
  "name": "GoKit源码:服务注册与发现",
  "description": "etcdv3目录结构 1 2 3 4 5 6 7 8 ├── client.go 客户端 ├── doc.go ├── example_test.go ├── instancer.go 服务实例 ├── instancer_test.go ├── integration_test.go ├── registrar.go 注册器 └── registrar_test.go 目录中主要的是这三个",
  "keywords": [
    "GoKit", "etcd"
  ],
  "articleBody": "etcdv3目录结构 1 2 3 4 5 6 7 8  ├── client.go 客户端 ├── doc.go ├── example_test.go ├── instancer.go 服务实例 ├── instancer_test.go ├── integration_test.go ├── registrar.go 注册器 └── registrar_test.go   目录中主要的是这三个文件，client.go instancer.go registrar.go\nclient.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  type Client interface { //获取一组value通过key前缀  GetEntries(prefix string) ([]string, error) //watch指定前缀的key  WatchPrefix(prefix string, ch chan struct{}) //注册服务  Register(s Service) error //注销服务  Deregister(s Service) error //etcd  LeaseID() int64 } type client struct { //etcd客户端使用v3版本api  cli *clientv3.Client ctx context.Context //etcd key/value 操作实例  kv clientv3.KV // etcd watcher 操作实例  watcher clientv3.Watcher // watcher context  wctx context.Context // watcher cancel func  wcf context.CancelFunc // leaseID will be 0 (clientv3.NoLease) if a lease was not created  leaseID clientv3.LeaseID //etcdKeepAlive实现心跳检测  hbch chan *clientv3.LeaseKeepAliveResponse // etcd Lease 操作实例  leaser clientv3.Lease } func NewClient(ctx context.Context, machines []string, options ClientOptions) (Client, error) func (c *client) GetEntries(key string) ([]string, error) func (c *client) WatchPrefix(prefix string, ch chan struct{}) func (c *client) Register(s Service) error func (c *client) Deregister(s Service) error   主要包含以下6个函数\n NewClient 创建etcd客户端，赋值给 client.cli GetEntries 通过 client.kv 获取value WatchPrefix 通过 client.watcher 监听key Deregister 通过 client.cli 服务绑定的key LeaseID return client.leaseID Register  初始化 client.leaser 初始化 client.watcher 初始化 client.kv 通过 client.kv 操作写入etcd，服务注册的key和value 创建 client.leaseID，默认心跳3秒，lease TTL9秒 client.leaser调用KeepAlive    registrar.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  type Registrar struct { //etcd客户端  client Client //注册的服务  service Service logger log.Logger //服务Deregister并发锁  quitmtx sync.Mutex //服务退出通道  quit chan struct{} } //服务的key和地址 type Service struct { Key string // unique key, e.g. \"/service/foobar/1.2.3.4:8080\"  Value string // returned to subscribers, e.g. \"http://1.2.3.4:8080\"  TTL *TTLOption } //服务心跳检测 type TTLOption struct { heartbeat time.Duration // e.g. time.Second * 3  ttl time.Duration // e.g. time.Second * 10 } func NewTTLOption(heartbeat, ttl time.Duration) *TTLOption func NewRegistrar(client Client, service Service, logger log.Logger) *Registrar func (r *Registrar) Register() func (r *Registrar) Deregister()   主要包含以下4个函数\n NewTTLOption 心跳检测参数 NewRegistrar 创建 Registrar Register 调用 client.go中 Register 方法 Deregister 调用 client.go中 Deregister 方法  instancer.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  type Instancer struct { //实例缓存  cache *instance.Cache //etcd客户端  client Client //实例前缀  prefix string logger log.Logger //Instancer 主动退出 通道  quitc chan struct{} } func NewInstancer(c Client, prefix string, logger log.Logger) (*Instancer, error) func (s *Instancer) loop() func (s *Instancer) Stop() func (s *Instancer) Register(ch chan sd.Event) func (s *Instancer) Deregister(ch chan sd.Event)   主要包含以下5个函数\n NewInstancer  调用 client.go GetEntries函数，获取对应的一组服务地址 查询到的服务地址写入缓存 Instancer.cache   loop 监听服务对应的key Stop 关闭服务监听 Register Deregister  参考:\nhttp://tongzhao.red/15612106758500.html\n",
  "wordCount" : "874",
  "inLanguage": "zh-cn",
  "datePublished": "2019-09-02T17:43:22Z",
  "dateModified": "2019-09-02T17:43:22Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/gokit%E6%BA%90%E7%A0%81%E6%B3%A8%E5%86%8C%E5%8F%91%E7%8E%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      GoKit源码:服务注册与发现
    </h1>
    <div class="post-meta">September 2, 2019
</div>
  </header> 
  <div class="post-content"><h2 id="etcdv3目录结构">etcdv3目录结构<a hidden class="anchor" aria-hidden="true" href="#etcdv3目录结构">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">├── client.go 客户端
├── doc.go
├── example_test.go
├── instancer.go 服务实例
├── instancer_test.go
├── integration_test.go
├── registrar.go 注册器
└── registrar_test.go
</code></pre></td></tr></table>
</div>
</div><p>目录中主要的是这三个文件，client.go instancer.go registrar.go</p>
<h2 id="clientgo">client.go<a hidden class="anchor" aria-hidden="true" href="#clientgo">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Client</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">//获取一组value通过key前缀
</span><span class="c1"></span>    <span class="nf">GetEntries</span><span class="p">(</span><span class="nx">prefix</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="c1">//watch指定前缀的key
</span><span class="c1"></span>    <span class="nf">WatchPrefix</span><span class="p">(</span><span class="nx">prefix</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ch</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>
    <span class="c1">//注册服务
</span><span class="c1"></span>    <span class="nf">Register</span><span class="p">(</span><span class="nx">s</span> <span class="nx">Service</span><span class="p">)</span> <span class="kt">error</span>
    <span class="c1">//注销服务
</span><span class="c1"></span>    <span class="nf">Deregister</span><span class="p">(</span><span class="nx">s</span> <span class="nx">Service</span><span class="p">)</span> <span class="kt">error</span>
    <span class="c1">//etcd 
</span><span class="c1"></span>    <span class="nf">LeaseID</span><span class="p">()</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">client</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">//etcd客户端使用v3版本api
</span><span class="c1"></span>    <span class="nx">cli</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>
    <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
    <span class="c1">//etcd key/value 操作实例
</span><span class="c1"></span>    <span class="nx">kv</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">KV</span>
    <span class="c1">// etcd watcher 操作实例
</span><span class="c1"></span>    <span class="nx">watcher</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">Watcher</span>
    <span class="c1">// watcher context
</span><span class="c1"></span>    <span class="nx">wctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
    <span class="c1">// watcher cancel func
</span><span class="c1"></span>    <span class="nx">wcf</span> <span class="nx">context</span><span class="p">.</span><span class="nx">CancelFunc</span>
    <span class="c1">// leaseID will be 0 (clientv3.NoLease) if a lease was not created
</span><span class="c1"></span>    <span class="nx">leaseID</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseID</span>

    <span class="c1">//etcdKeepAlive实现心跳检测
</span><span class="c1"></span>    <span class="nx">hbch</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">LeaseKeepAliveResponse</span>
    <span class="c1">// etcd Lease 操作实例
</span><span class="c1"></span>    <span class="nx">leaser</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">Lease</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">NewClient</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">machines</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="nx">ClientOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">Client</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">GetEntries</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">WatchPrefix</span><span class="p">(</span><span class="nx">prefix</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ch</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> 
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">s</span> <span class="nx">Service</span><span class="p">)</span> <span class="kt">error</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">client</span><span class="p">)</span> <span class="nf">Deregister</span><span class="p">(</span><span class="nx">s</span> <span class="nx">Service</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></td></tr></table>
</div>
</div><p>主要包含以下6个函数</p>
<ul>
<li>NewClient 创建etcd客户端，赋值给 client.cli</li>
<li>GetEntries 通过 client.kv 获取value</li>
<li>WatchPrefix 通过 client.watcher 监听key</li>
<li>Deregister 通过 client.cli 服务绑定的key</li>
<li>LeaseID return client.leaseID</li>
<li>Register
<ul>
<li>初始化 client.leaser</li>
<li>初始化 client.watcher</li>
<li>初始化 client.kv</li>
<li>通过 client.kv 操作写入etcd，服务注册的key和value</li>
<li>创建 client.leaseID，默认心跳3秒，lease TTL9秒</li>
<li>client.leaser调用KeepAlive</li>
</ul>
</li>
</ul>
<h2 id="registrargo">registrar.go<a hidden class="anchor" aria-hidden="true" href="#registrargo">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Registrar</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">//etcd客户端
</span><span class="c1"></span>    <span class="nx">client</span>  <span class="nx">Client</span>
    <span class="c1">//注册的服务
</span><span class="c1"></span>    <span class="nx">service</span> <span class="nx">Service</span>
    <span class="nx">logger</span>  <span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>

    <span class="c1">//服务Deregister并发锁
</span><span class="c1"></span>    <span class="nx">quitmtx</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="c1">//服务退出通道
</span><span class="c1"></span>    <span class="nx">quit</span>    <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">//服务的key和地址
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Service</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Key</span>   <span class="kt">string</span> <span class="c1">// unique key, e.g. &#34;/service/foobar/1.2.3.4:8080&#34;
</span><span class="c1"></span>    <span class="nx">Value</span> <span class="kt">string</span> <span class="c1">// returned to subscribers, e.g. &#34;http://1.2.3.4:8080&#34;
</span><span class="c1"></span>    <span class="nx">TTL</span>   <span class="o">*</span><span class="nx">TTLOption</span>
<span class="p">}</span>

<span class="c1">//服务心跳检测
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">TTLOption</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">heartbeat</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="c1">// e.g. time.Second * 3
</span><span class="c1"></span>    <span class="nx">ttl</span>       <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="c1">// e.g. time.Second * 10
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewTTLOption</span><span class="p">(</span><span class="nx">heartbeat</span><span class="p">,</span> <span class="nx">ttl</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="o">*</span><span class="nx">TTLOption</span> 
<span class="kd">func</span> <span class="nf">NewRegistrar</span><span class="p">(</span><span class="nx">client</span> <span class="nx">Client</span><span class="p">,</span> <span class="nx">service</span> <span class="nx">Service</span><span class="p">,</span> <span class="nx">logger</span> <span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="o">*</span><span class="nx">Registrar</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Registrar</span><span class="p">)</span> <span class="nf">Register</span><span class="p">()</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Registrar</span><span class="p">)</span> <span class="nf">Deregister</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>主要包含以下4个函数</p>
<ul>
<li>NewTTLOption 心跳检测参数</li>
<li>NewRegistrar 创建 Registrar</li>
<li>Register 调用 client.go中 Register 方法</li>
<li>Deregister 调用 client.go中 Deregister 方法</li>
</ul>
<h2 id="instancergo">instancer.go<a hidden class="anchor" aria-hidden="true" href="#instancergo">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Instancer</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">//实例缓存
</span><span class="c1"></span>    <span class="nx">cache</span>  <span class="o">*</span><span class="nx">instance</span><span class="p">.</span><span class="nx">Cache</span>
    <span class="c1">//etcd客户端
</span><span class="c1"></span>    <span class="nx">client</span> <span class="nx">Client</span>
    <span class="c1">//实例前缀
</span><span class="c1"></span>    <span class="nx">prefix</span> <span class="kt">string</span>
    <span class="nx">logger</span> <span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="c1">//Instancer 主动退出 通道
</span><span class="c1"></span>    <span class="nx">quitc</span>  <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewInstancer</span><span class="p">(</span><span class="nx">c</span> <span class="nx">Client</span><span class="p">,</span> <span class="nx">prefix</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">logger</span> <span class="nx">log</span><span class="p">.</span><span class="nx">Logger</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Instancer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> 
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Instancer</span><span class="p">)</span> <span class="nf">loop</span><span class="p">()</span> 
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Instancer</span><span class="p">)</span> <span class="nf">Stop</span><span class="p">()</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Instancer</span><span class="p">)</span> <span class="nf">Register</span><span class="p">(</span><span class="nx">ch</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span> 
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Instancer</span><span class="p">)</span> <span class="nf">Deregister</span><span class="p">(</span><span class="nx">ch</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>主要包含以下5个函数</p>
<ul>
<li>NewInstancer
<ul>
<li>调用 client.go GetEntries函数，获取对应的一组服务地址</li>
<li>查询到的服务地址写入缓存 Instancer.cache</li>
</ul>
</li>
<li>loop 监听服务对应的key</li>
<li>Stop 关闭服务监听</li>
<li>Register</li>
<li>Deregister</li>
</ul>
<p>参考:<br>
<a href="http://tongzhao.red/15612106758500.html">http://tongzhao.red/15612106758500.html</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/gokit/">Gokit</a></li>
      <li><a href="/tags/etcd/">etcd</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
