<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>腾讯Go安全指南 | Forz Blog</title>
<meta name="keywords" content="Go" />
<meta name="description" content="1 通用类 I. 代码实现 1.1 内存管理 1.2 文件操作 1.3 系统接口 1.4 通信安全 1.5 敏感数据保护 1.6 加密解密 1.7 正则表达式 2 后台类 I. 代码实现 1.1 输入校验 1.2 SQL操作 1.3 网络">
<meta name="author" content="">
<link rel="canonical" href="/post/%E8%85%BE%E8%AE%AFgo%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="腾讯Go安全指南" />
<meta property="og:description" content="1 通用类 I. 代码实现 1.1 内存管理 1.2 文件操作 1.3 系统接口 1.4 通信安全 1.5 敏感数据保护 1.6 加密解密 1.7 正则表达式 2 后台类 I. 代码实现 1.1 输入校验 1.2 SQL操作 1.3 网络" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/%E8%85%BE%E8%AE%AFgo%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-26T18:53:08&#43;00:00" />
<meta property="article:modified_time" content="2021-05-26T18:53:08&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="腾讯Go安全指南"/>
<meta name="twitter:description" content="1 通用类 I. 代码实现 1.1 内存管理 1.2 文件操作 1.3 系统接口 1.4 通信安全 1.5 敏感数据保护 1.6 加密解密 1.7 正则表达式 2 后台类 I. 代码实现 1.1 输入校验 1.2 SQL操作 1.3 网络"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "腾讯Go安全指南",
      "item": "/post/%E8%85%BE%E8%AE%AFgo%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "腾讯Go安全指南",
  "name": "腾讯Go安全指南",
  "description": "1 通用类 I. 代码实现 1.1 内存管理 1.2 文件操作 1.3 系统接口 1.4 通信安全 1.5 敏感数据保护 1.6 加密解密 1.7 正则表达式 2 后台类 I. 代码实现 1.1 输入校验 1.2 SQL操作 1.3 网络",
  "keywords": [
    "Go"
  ],
  "articleBody": "  1 通用类\n I. 代码实现  1.1 内存管理 1.2 文件操作 1.3 系统接口 1.4 通信安全 1.5 敏感数据保护 1.6 加密解密 1.7 正则表达式      2 后台类\n I. 代码实现  1.1 输入校验 1.2 SQL操作 1.3 网络请求 1.4 服务器端渲染 1.5 Web跨域 1.6 响应输出 1.7 会话管理 1.8 访问控制 1.9 并发保护      通用类 1. 代码实现类 1.1 内存管理 1.1.1【必须】切片长度校验  在对slice进行操作时，必须判断长度是否合法，防止程序panic  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // bad: 未判断data的长度，可导致 index out of range func decode(data [] byte) bool { if data[0] == 'F' \u0026\u0026 data[1] == 'U' \u0026\u0026 data[2] == 'Z' \u0026\u0026 data[3] == 'Z' \u0026\u0026 data[4] == 'E' \u0026\u0026 data[5] == 'R' { fmt.Println(\"Bad\") return true } return false } // bad: slice bounds out of range func foo() { var slice = []int{0, 1, 2, 3, 4, 5, 6} fmt.Println(slice[:10]) } // good: 使用data前应判断长度是否合法 func decode(data [] byte) bool { if len(data) == 6 { if data[0] == 'F' \u0026\u0026 data[1] == 'U' \u0026\u0026 data[2] == 'Z' \u0026\u0026 data[3] == 'Z' \u0026\u0026 data[4] == 'E' \u0026\u0026 data[5] == 'R' { fmt.Println(\"Good\") return true } } return false }   1.1.2【必须】nil指针判断  进行指针操作时，必须判断该指针是否为nil，防止程序panic，尤其在进行结构体Unmarshal时  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  type Packet struct { PackeyType uint8 PackeyVersion uint8 Data *Data } type Data struct { Stat uint8 Len uint8 Buf [8]byte } func (p *Packet) UnmarshalBinary(b []byte) error { if len(b)  2 { return io.EOF } p.PackeyType = b[0] p.PackeyVersion = b[1] // 若长度等于2，那么不会new Data  if len(b)  2 { p.Data = new(Data) // Unmarshal(b[i:], p.Data)  } return nil } // bad: 未判断指针是否为nil func main() { packet := new(Packet) data := make([]byte, 2) if err := packet.UnmarshalBinary(data); err != nil { fmt.Println(\"Failed to unmarshal packet\") return } fmt.Printf(\"Stat: %v\\n\", packet.Data.Stat) } // good: 判断Data指针是否未nil func main() { packet := new(Packet) data := make([]byte, 2) if err := packet.UnmarshalBinary(data); err != nil { fmt.Println(\"Failed to unmarshal packet\") return } if packet.Data == nil { return } fmt.Printf(\"Stat: %v\\n\", packet.Data.Stat) }   1.1.3【必须】整数安全   在进行数字运算操作时，需要做好长度限制，防止外部输入运算导致异常：\n 确保无符号整数运算时不会反转 确保有符号整数运算时不会出现溢出 确保整型转换时不会出现截断错误 确保整型转换时不会出现符号错误    以下场景必须严格进行长度限制：\n 作为数组索引 作为对象的长度或者大小 作为数组的边界（如作为循环计数器）    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // bad: 未限制长度，导致整数溢出 func overflow(numControlByUser int32) { var numInt int32 = 0 numInt = numControlByUser + 1 //对长度限制不当，导致整数溢出  fmt.Printf(\"%d\\n\", numInt) //使用numInt，可能导致其他错误 } func main() { overflow(2147483647) } // good: func overflow(numControlByUser int32) { var numInt int32 = 0 numInt = numControlByUser + 1 if numInt  0 { fmt.Println(\"integer overflow\") return; } fmt.Println(\"integer ok\") } func main() { overflow(2147483647) }   1.1.4【必须】make分配长度验证  在进行make分配内存时，需要对外部可控的长度进行校验，防止程序panic。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // bad func parse(lenControlByUser int, data[] byte) { size := lenControlByUser //对外部传入的size，进行长度判断以免导致panic  buffer := make([]byte, size) copy(buffer, data) } // good func parse(lenControlByUser int, data[] byte) ([]byte, error){ size := lenControlByUser //限制外部可控的长度大小范围  if size  64*1024*1024 { return nil, errors.New(\"value too large\") } buffer := make([]byte, size) copy(buffer, data) return buffer, nil }   1.1.5【必须】禁止SetFinalizer和指针循环引用同时使用  当一个对象从被GC选中到移除内存之前，runtime.SetFinalizer()都不会执行，即使程序正常结束或者发生错误。由指针构成的“循环引用”虽然能被GC正确处理，但由于无法确定Finalizer依赖顺序，从而无法调用runtime.SetFinalizer()，导致目标对象无法变成可达状态，从而造成内存无法被回收。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  // bad func foo() { var a, b Data a.o = \u0026b b.o = \u0026a //指针循环引用，SetFinalizer()无法正常调用  runtime.SetFinalizer(\u0026a, func(d *Data) { fmt.Printf(\"a %p final.\\n\", d) }) runtime.SetFinalizer(\u0026b, func(d *Data) { fmt.Printf(\"b %p final.\\n\", d) }) } func main() { for { foo() time.Sleep(time.Millisecond) } }   1.1.6【必须】禁止重复释放channel  重复释放一般存在于异常流程判断中，如果恶意攻击者构造出异常条件使程序重复释放channel，则会触发运行时恐慌，从而造成DoS攻击。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  // bad func foo(c chan int) { defer close(c) err := processBusiness() if err != nil { c  0 close(c) // 重复释放channel  return } c  1 } // good func foo(c chan int) { defer close(c) // 使用defer延迟关闭channel  err := processBusiness() if err != nil { c  0 return } c  1 }   1.1.7【必须】确保每个协程都能退出  启动一个协程就会做一个入栈操作，在系统不退出的情况下，协程也没有设置退出条件，则相当于协程失去了控制，它占用的资源无法回收，可能会导致内存泄露。  1 2 3 4 5 6 7  // bad: 协程没有设置退出条件 func doWaiter(name string, second int) { for { time.Sleep(time.Duration(second) * time.Second) fmt.Println(name, \" is ready!\") } }   1.1.8【推荐】不使用unsafe包  由于unsafe包绕过了 Golang 的内存安全原则，一般来说使用该库是不安全的，可导致内存破坏，尽量避免使用该包。若必须要使用unsafe操作指针，必须做好安全校验。  1 2 3 4 5 6 7 8  // bad: 通过unsafe操作原始指针 func unsafePointer() { b := make([]byte, 1) foo := (*int)(unsafe.Pointer(uintptr(unsafe.Pointer(\u0026b[0])) + uintptr(0xfffffffe))) fmt.Print(*foo + 1) } // [signal SIGSEGV: segmentation violation code=0x1 addr=0xc100068f55 pc=0x49142b]   1.1.9【推荐】不使用slice作为函数入参  slice是引用类型，在作为函数入参时采用的是地址传递，对slice的修改也会影响原始数据  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  // bad  // slice作为函数入参时是地址传递  func modify(array []int) { array[0] = 10 // 对入参slice的元素修改会影响原始数据  } func main() { array := []int{1, 2, 3, 4, 5} modify(array) fmt.Println(array) // output：[10 2 3 4 5]  } // good  // 数组作为函数入参时，而不是slice  func modify(array [5]int) { array[0] = 10 } func main() { // 传入数组，注意数组与slice的区别  array := [5]int{1, 2, 3, 4, 5} modify(array) fmt.Println(array) }   1.2 文件操作 1.2.1【必须】 路径穿越检查  在进行文件操作时，如果对外部传入的文件名未做限制，可能导致任意文件读取或者任意文件写入，严重可能导致代码执行。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  // bad: 任意文件读取 func handler(w http.ResponseWriter, r *http.Request) { path := r.URL.Query()[\"path\"][0] // 未过滤文件路径，可能导致任意文件读取 \tdata, _ := ioutil.ReadFile(path) w.Write(data) // 对外部传入的文件名变量，还需要验证是否存在../等路径穿越的文件名 \tdata, _ = ioutil.ReadFile(filepath.Join(\"/home/user/\", path)) w.Write(data) } // bad: 任意文件写入 func unzip(f string) { r, _ := zip.OpenReader(f) for _, f := range r.File { p, _ := filepath.Abs(f.Name) // 未验证压缩文件名，可能导致../等路径穿越，任意文件路径写入 \tioutil.WriteFile(p, []byte(\"present\"), 0640) } } // good: 检查压缩的文件名是否包含..路径穿越特征字符，防止任意写入 func unzipGood(f string) bool { r, err := zip.OpenReader(f) if err != nil { fmt.Println(\"read zip file fail\") return false } for _, f := range r.File { p, _ := filepath.Abs(f.Name) if !strings.Contains(p, \"..\") { ioutil.WriteFile(p, []byte(\"present\"), 0640) } } return true }   1.2.2【必须】 文件访问权限  根据创建文件的敏感性设置不同级别的访问权限，以防止敏感数据被任意权限用户读取。例如，设置文件权限为：-rw-r-----  1  ioutil.WriteFile(p, []byte(\"present\"), 0640)   1.3 系统接口 1.3.1【必须】命令执行检查\n 使用exec.Command、exec.CommandContext、syscall.StartProcess、os.StartProcess等函数时，第一个参数（path）直接取外部输入值时，应使用白名单限定可执行的命令范围，不允许传入bash、cmd、sh等命令； 使用exec.Command、exec.CommandContext等函数时，通过bash、cmd、sh等创建shell，-c后的参数（arg）拼接外部输入，应过滤\\n $ \u0026 ; | ' \" ( ) `等潜在恶意字符；  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39  // bad func foo() { userInputedVal := \"\u0026\u0026 echo 'hello'\" // 假设外部传入该变量值 \tcmdName := \"ping \" + userInputedVal //未判断外部输入是否存在命令注入字符，结合sh可造成命令注入 \tcmd := exec.Command(\"sh\", \"-c\", cmdName) output, _ := cmd.CombinedOutput() fmt.Println(string(output)) cmdName := \"ls\" //未判断外部输入是否是预期命令 \tcmd := exec.Command(cmdName) output, _ := cmd.CombinedOutput() fmt.Println(string(output)) } // good func checkIllegal(cmdName string) bool { if strings.Contains(cmdName, \"\u0026\") || strings.Contains(cmdName, \"|\") || strings.Contains(cmdName, \";\") || strings.Contains(cmdName, \"$\") || strings.Contains(cmdName, \"'\") || strings.Contains(cmdName, \"`\") || strings.Contains(cmdName, \"(\") || strings.Contains(cmdName, \")\") || strings.Contains(cmdName, \"\\\"\") { return true } return false } func main() { userInputedVal := \"\u0026\u0026 echo 'hello'\" cmdName := \"ping \" + userInputedVal if checkIllegal(cmdName) { // 检查传给sh的命令是否有特殊字符 \treturn // 存在特殊字符直接return \t} cmd := exec.Command(\"sh\", \"-c\", cmdName) output, _ := cmd.CombinedOutput() fmt.Println(string(output)) }   1.4 通信安全 1.4.1【必须】网络通信采用TLS方式  明文传输的通信协议目前已被验证存在较大安全风险，被中间人劫持后可能导致许多安全风险，因此必须采用至少TLS的安全通信方式保证通信安全，例如gRPC/Websocket都使用TLS1.3。  1 2 3 4 5 6 7 8 9 10  // good func main() { http.HandleFunc(\"/\", func (w http.ResponseWriter, req *http.Request) { w.Header().Add(\"Strict-Transport-Security\", \"max-age=63072000; includeSubDomains\") w.Write([]byte(\"This is an example server.\\n\")) }) //服务器配置证书与私钥  log.Fatal(http.ListenAndServeTLS(\":443\", \"yourCert.pem\", \"yourKey.pem\", nil)) }   1.4.2【推荐】TLS启用证书验证  TLS证书应当是有效的、未过期的，且配置正确的域名，生产环境的服务端应启用证书验证。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  // bad import ( \"crypto/tls\" \"net/http\" ) func doAuthReq(authReq *http.Request) *http.Response { tr := \u0026http.Transport{ TLSClientConfig: \u0026tls.Config{InsecureSkipVerify: true}, } client := \u0026http.Client{Transport: tr} res, _ := client.Do(authReq) return res } // good import ( \"crypto/tls\" \"net/http\" ) func doAuthReq(authReq *http.Request) *http.Response { tr := \u0026http.Transport{ TLSClientConfig: \u0026tls.Config{InsecureSkipVerify: false}, } client := \u0026http.Client{Transport: tr} res, _ := client.Do(authReq) return res }   1.5 敏感数据保护 1.5.1【必须】敏感信息访问  禁止将敏感信息硬编码在程序中，既可能会将敏感信息暴露给攻击者，也会增加代码管理和维护的难度 使用配置中心系统统一托管密钥等敏感信息  1.5.2【必须】敏感数据输出  只输出必要的最小数据集，避免多余字段暴露引起敏感信息泄露 不能在日志保存密码（包括明文密码和密文密码）、密钥和其它敏感信息 对于必须输出的敏感信息，必须进行合理脱敏展示  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  // bad func serve() { http.HandleFunc(\"/register\", func(w http.ResponseWriter, r *http.Request) { r.ParseForm() user := r.Form.Get(\"user\") pw := r.Form.Get(\"password\") log.Printf(\"Registering new user %s with password %s.\\n\", user, pw) }) http.ListenAndServe(\":80\", nil) } // good func serve1() { http.HandleFunc(\"/register\", func(w http.ResponseWriter, r *http.Request) { r.ParseForm() user := r.Form.Get(\"user\") pw := r.Form.Get(\"password\") log.Printf(\"Registering new user %s.\\n\", user) // ... \tuse(pw) }) http.ListenAndServe(\":80\", nil) }    避免通过GET方法、代码注释、自动填充、缓存等方式泄露敏感信息  1.5.3【必须】敏感数据存储  敏感数据应使用SHA2、RSA等算法进行加密存储 敏感数据应使用独立的存储层，并在访问层开启访问控制 包含敏感信息的临时文件或缓存一旦不再需要应立刻删除  1.5.4【必须】异常处理和日志记录  应合理使用panic、recover、defer处理系统异常，避免出错信息输出到前端  1 2 3 4 5  defer func () { if r := recover(); r != nil { fmt.Println(\"Recovered in start()\") } }()    对外环境禁止开启debug模式，或将程序运行日志输出到前端  错误例子：\n1  dlv --listen=:2345 --headless=true --api-version=2 debug test.go   正确例子：\n1  dlv debug test.go   1.6 加密解密 1.6.1【必须】不得硬编码密码/密钥  在进行用户登陆，加解密算法等操作时，不得在代码里硬编码密钥或密码，可通过变换算法或者配置等方式设置密码或者密钥。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  // bad const ( user = \"dbuser\" password = \"s3cretp4ssword\" ) func connect() *sql.DB { connStr := fmt.Sprintf(\"postgres://%s:%s@localhost/pqgotest\", user, password) db, err := sql.Open(\"postgres\", connStr) if err != nil { return nil } return db } // bad var ( commonkey = []byte(\"0123456789abcdef\") ) func AesEncrypt(plaintext string) (string, error) { block, err := aes.NewCipher(commonkey) if err != nil { return \"\", err } }   1.6.2【必须】密钥存储安全  在使用对称密码算法时，需要保护好加密密钥。当算法涉及敏感、业务数据时，可通过非对称算法协商加密密钥。其他较为不敏感的数据加密，可以通过变换算法等方式保护密钥。  1.6.3【推荐】不使用弱密码算法  在使用加密算法时，不建议使用加密强度较弱的算法。  错误例子：\n1  crypto/des，crypto/md5，crypto/sha1，crypto/rc4等。   1.7 正则表达式 1.7.1【推荐】使用regexp进行正则表达式匹配  正则表达式编写不恰当可被用于DoS攻击，造成服务不可用，推荐使用regexp包进行正则表达式匹配。regexp保证了线性时间性能和优雅的失败：对解析器、编译器和执行引擎都进行了内存限制。但regexp不支持以下正则表达式特性，如业务依赖这些特性，则regexp不适合使用。  回溯引用Backreferences和查看Lookaround    1 2 3 4  // good matched, err := regexp.MatchString(`a.b`, \"aaxbb\") fmt.Println(matched) // true fmt.Println(err) // nil (regexp is valid)   后台类 1 代码实现类 1.1 输入校验 1.1.1【必须】按类型进行数据校验  所有外部输入的参数，应使用validator进行白名单校验，校验内容包括但不限于数据长度、数据范围、数据类型与格式，校验不通过的应当拒绝  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // good import ( \"fmt\" \"github.com/go-playground/validator/v10\" ) var validate *validator.Validate validate = validator.New() func validateVariable() { myEmail := \"abc@tencent.com\" errs := validate.Var(myEmail, \"required,email\") if errs != nil { fmt.Println(errs) return //停止执行 \t} // 验证通过，继续执行  ... }    无法通过白名单校验的应使用html.EscapeString、text/template或bluemonday对, \u0026, ',\"等字符进行过滤或编码  1 2 3 4 5 6 7 8 9  import( \"text/template\" ) // TestHTMLEscapeString HTML特殊字符转义  func main(inputValue string) string{ escapedResult := template.HTMLEscapeString(inputValue) return escapedResult }   1.2 SQL操作 1.2.1【必须】SQL语句默认使用预编译并绑定变量  使用database/sql的prepare、Query或使用GORM等ORM执行SQL操作  1 2 3 4 5 6 7 8 9 10 11 12 13  import ( \"github.com/jinzhu/gorm\" _ \"github.com/jinzhu/gorm/dialects/sqlite\" ) type Product struct { gorm.Model Code string Price uint } ... var product Product db.First(\u0026product, 1)    使用参数化查询，禁止拼接SQL语句，另外对于传入参数用于order by或表名的需要通过校验  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // bad  import ( \"database/sql\" \"fmt\" \"net/http\" ) func handler(db *sql.DB, req *http.Request) { q := fmt.Sprintf(\"SELECT ITEM,PRICE FROM PRODUCT WHERE ITEM_CATEGORY='%s' ORDER BY PRICE\", req.URL.Query()[\"category\"]) db.Query(q) } // good func handlerGood(db *sql.DB, req *http.Request) { //使用?占位符  q := \"SELECT ITEM,PRICE FROM PRODUCT WHERE ITEM_CATEGORY='?' ORDER BY PRICE\" db.Query(q, req.URL.Query()[\"category\"]) }   1.3 网络请求 1.3.1【必须】资源请求过滤验证   使用\"net/http\"下的方法http.Get(url)、http.Post(url, contentType, body)、http.Head(url )、http.PostForm(url, data)、http.Do(req)时，如变量值外部可控（指从参数中动态获取），应对请求目标进行严格的安全校验。\n  如请求资源域名归属固定的范围，如只允许a.qq.com和b.qq.com，应做白名单限制。如不适用白名单，则推荐的校验逻辑步骤是：\n  第 1 步、只允许HTTP或HTTPS协议\n  第 2 步、解析目标URL，获取其HOST\n  第 3 步、解析HOST，获取HOST指向的IP地址转换成Long型\n  第 4 步、检查IP地址是否为内网IP，网段有：\n1 2 3 4 5  // 以RFC定义的专有网络为例，如有自定义私有网段亦应加入禁止访问列表。 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.0/8     第 5 步、请求URL\n  第 6 步、如有跳转，跳转后执行1，否则绑定经校验的ip和域名，对URL发起请求\n    官方库encoding/xml不支持外部实体引用，使用该库可避免xxe漏洞\n  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  import ( \"encoding/xml\" \"fmt\" \"os\" ) func main() { type Person struct { XMLName xml.Name `xml:\"person\"` Id int `xml:\"id,attr\"` UserName string `xml:\"namefirst\"` Comment string `xml:\",comment\"` } v := \u0026Person{Id: 13, UserName: \"John\"} v.Comment = \" Need more details. \" enc := xml.NewEncoder(os.Stdout) enc.Indent(\" \", \" \") if err := enc.Encode(v); err != nil { fmt.Printf(\"error: %v\\n\", err) } }   1.4 服务器端渲染 1.4.1【必须】模板渲染过滤验证  使用text/template或者html/template渲染模板时禁止将外部输入参数引入模板，或仅允许引入白名单内字符。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52  // bad  func handler(w http.ResponseWriter, r *http.Request) { r.ParseForm() x := r.Form.Get(\"name\") var tmpl = ` First name:\n` + x + ` ` t := template.New(\"main\") t, _ = t.Parse(tmpl) t.Execute(w, \"Hello\") } // good  import ( \"fmt\" \"github.com/go-playground/validator/v10\" ) var validate *validator.Validate validate = validator.New() func validateVariable(val) { errs := validate.Var(val, \"gte=1,lte=100\")//限制必须是1-100的正整数  if errs != nil { fmt.Println(errs) return False } return True } func handler(w http.ResponseWriter, r *http.Request) { r.ParseForm() x := r.Form.Get(\"name\") if validateVariable(x): var tmpl = ` First name:\n` + x + ` ` t := template.New(\"main\") t, _ = t.Parse(tmpl) t.Execute(w, \"Hello\") else: ... }   1.5 Web跨域 1.5.1【必须】跨域资源共享CORS限制请求来源  CORS请求保护不当可导致敏感信息泄漏，因此应当严格设置Access-Control-Allow-Origin使用同源策略进行保护。  1 2 3 4 5 6 7 8 9  // good  c := cors.New(cors.Options{ AllowedOrigins: []string{\"http://qq.com\", \"https://qq.com\"}, AllowCredentials: true, Debug: false, }) //引入中间件  handler = c.Handler(handler)   1.6 响应输出 1.6.1 【必须】设置正确的HTTP响应包类型  响应头Content-Type与实际响应内容，应保持一致。如：API响应数据类型是json，则响应头使用application/json；若为xml，则设置为text/xml。  1.6.2 【必须】添加安全响应头  所有接口、页面，添加响应头 X-Content-Type-Options: nosniff。 所有接口、页面，添加响应头X-Frame-Options。按需合理设置其允许范围，包括：DENY、SAMEORIGIN、ALLOW-FROM origin。用法参考：MDN文档  1.6.3【必须】外部输入拼接到HTTP响应头中需进行过滤  应尽量避免外部可控参数拼接到HTTP响应头中，如业务需要则需要过滤掉\\r、\\n等换行符，或者拒绝携带换行符号的外部输入。  1.6.4【必须】外部输入拼接到response页面前进行编码处理  直出html页面或使用模板生成html页面的，推荐使用text/template自动编码，或者使用html.EscapeString或text/template对, \u0026, ',\"等字符进行编码。  1 2 3 4 5 6 7 8 9 10  import( \"html/template\" ) func outtemplate(w http.ResponseWriter,r *http.Request) { param1 := r.URL.Query().Get(\"param1\") tmpl := template.New(\"hello\") tmpl, _ = tmpl.Parse(`{{define\"T\"}}{{.}}{{end}}`) tmpl.ExecuteTemplate(w, \"T\", param1) }   1.7 会话管理 1.7.1【必须】安全维护session信息  用户登录时应重新生成session，退出登录后应清理session。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  import ( \"net/http\" \"github.com/gorilla/mux\" \"github.com/gorilla/handlers\" ) //创建cookie func setToken(res http.ResponseWriter, req *http.Request) { expireToken := time.Now().Add(time.Minute * 30).Unix() expireCookie := time.Now().Add(time.Minute * 30) ... cookie := http.Cookie{ Name: \"Auth\", Value: signedToken, Expires: expireCookie, // 过期失效  HttpOnly: true, Path: \"/\", Domain: \"127.0.0.1\", Secure: true } http.SetCookie(res, \u0026cookie) http.Redirect(res, req, \"/profile\", 307) } // 删除cookie func logout(res http.ResponseWriter, req *http.Request) { deleteCookie := http.Cookie{ Name: \"Auth\", Value: \"none\", Expires: time.Now() } http.SetCookie(res, \u0026deleteCookie) return }   1.7.2【必须】CSRF防护  涉及系统敏感操作或可读取敏感信息的接口应校验Referer或添加csrf_token。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  // good import ( \"net/http\" \"github.com/gorilla/csrf\" \"github.com/gorilla/mux\" ) func main() { r := mux.NewRouter() r.HandleFunc(\"/signup\", ShowSignupForm) r.HandleFunc(\"/signup/post\", SubmitSignupForm) //使用csrf_token验证  http.ListenAndServe(\":8000\", csrf.Protect([]byte(\"32-byte-long-auth-key\"))(r)) }   1.8 访问控制 1.8.1【必须】默认鉴权   除非资源完全可对外开放，否则系统默认进行身份认证，使用白名单的方式放开不需要认证的接口或页面。\n  根据资源的机密程度和用户角色，以最小权限原则，设置不同级别的权限，如完全公开、登录可读、登录可写、特定用户可读、特定用户可写等\n  涉及用户自身相关的数据的读写必须验证登录态用户身份及其权限，避免越权操作\n1 2  -- 伪代码 selectidfromtablewhereid=:idanduserid=session.userid    没有独立账号体系的外网服务使用QQ或微信登录，内网服务使用统一登录服务登录，其他使用账号密码登录的服务需要增加验证码等二次验证\n  1.9 并发保护 1.9.1【必须】禁止在闭包中直接调用循环变量  在循环中启动协程，当协程中使用到了循环的索引值，由于多个协程同时使用同一个变量会产生数据竞争，造成执行结果异常。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  // bad func main() { runtime.GOMAXPROCS(runtime.NumCPU()) var group sync.WaitGroup for i := 0; i  5; i++ { group.Add(1) go func() { defer group.Done() fmt.Printf(\"%-2d\", i) //这里打印的i不是所期望的  }() } group.Wait() } // good func main() { runtime.GOMAXPROCS(runtime.NumCPU()) var group sync.WaitGroup for i := 0; i  5; i++ { group.Add(1) go func(j int) { defer func() { if r := recover(); r != nil { fmt.Println(\"Recovered in start()\") } group.Done() }() fmt.Printf(\"%-2d\", j) // 闭包内部使用局部变量  }(i) // 把循环变量显式地传给协程  } group.Wait() }   1.9.2【必须】禁止并发写map  并发写map容易造成程序崩溃并异常退出，建议加锁保护  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // bad func main() { m := make(map[int]int) //并发读写 \tgo func() { for { _ = m[1] } }() go func() { for { m[2] = 1 } }() select {} }   1.9.3【必须】确保并发安全 敏感操作如果未作并发安全限制，可导致数据读写异常，造成业务逻辑限制被绕过。可通过同步锁或者原子操作进行防护。\n通过同步锁共享内存\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  // good var count int func Count(lock *sync.Mutex) { lock.Lock()// 加写锁  count++ fmt.Println(count) lock.Unlock()// 解写锁，任何一个Lock()或RLock()均需要保证对应有Unlock()或RUnlock() } func main() { lock := \u0026sync.Mutex{} for i := 0; i  10; i++ { go Count(lock) //传递指针是为了防止函数内的锁和调用锁不一致  } for { lock.Lock() c := count lock.Unlock() runtime.Gosched()//交出时间片给协程  if c  10 { break } } }    使用sync/atomic执行原子操作  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  // good import ( \"sync\" \"sync/atomic\" ) func main() { type Map map[string]string var m atomic.Value m.Store(make(Map)) var mu sync.Mutex // used only by writers \tread := func(key string) (val string) { m1 := m.Load().(Map) return m1[key] } insert := func(key, val string) { mu.Lock() // 与潜在写入同步 \tdefer mu.Unlock() m1 := m.Load().(Map) // 导入struct当前数据 \tm2 := make(Map) // 创建新值 \tfor k, v := range m1 { m2[k] = v } m2[key] = val m.Store(m2) // 用新的替代当前对象 \t} _, _ = read, insert }   ",
  "wordCount" : "7634",
  "inLanguage": "zh-cn",
  "datePublished": "2021-05-26T18:53:08Z",
  "dateModified": "2021-05-26T18:53:08Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/%E8%85%BE%E8%AE%AFgo%E5%AE%89%E5%85%A8%E6%8C%87%E5%8D%97/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      腾讯Go安全指南
    </h1>
    <div class="post-meta">May 26, 2021
</div>
  </header> 
  <div class="post-content"><!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<ul>
<li>
<p><a href="#1">1 通用类</a></p>
<ul>
<li><a href="#1.1">I. 代码实现</a>
<ul>
<li><a href="#1.1.1">1.1 内存管理</a></li>
<li><a href="#1.1.2">1.2 文件操作</a></li>
<li><a href="#1.1.3">1.3 系统接口</a></li>
<li><a href="#1.1.4">1.4 通信安全</a></li>
<li><a href="#1.1.5">1.5 敏感数据保护</a></li>
<li><a href="#1.1.6">1.6 加密解密</a></li>
<li><a href="#1.1.7">1.7 正则表达式</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><a href="#2">2 后台类</a></p>
<ul>
<li><a href="#2.1">I. 代码实现</a>
<ul>
<li><a href="#2.1.1">1.1 输入校验</a></li>
<li><a href="#2.1.2">1.2 SQL操作</a></li>
<li><a href="#2.1.3">1.3 网络请求</a></li>
<li><a href="#2.1.4">1.4 服务器端渲染</a></li>
<li><a href="#2.1.5">1.5 Web跨域</a></li>
<li><a href="#2.1.6">1.6 响应输出</a></li>
<li><a href="#2.1.7">1.7 会话管理</a></li>
<li><a href="#2.1.8">1.8 访问控制</a></li>
<li><a href="#2.1.9">1.9 并发保护</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="通用类">通用类<a hidden class="anchor" aria-hidden="true" href="#通用类">#</a></h1>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="1-代码实现类">1. 代码实现类<a hidden class="anchor" aria-hidden="true" href="#1-代码实现类">#</a></h2>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="11-内存管理">1.1 内存管理<a hidden class="anchor" aria-hidden="true" href="#11-内存管理">#</a></h3>
<h4 id="111必须切片长度校验">1.1.1【必须】切片长度校验<a hidden class="anchor" aria-hidden="true" href="#111必须切片长度校验">#</a></h4>
<ul>
<li>在对slice进行操作时，必须判断长度是否合法，防止程序panic</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad: 未判断data的长度，可导致 index out of range
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">decode</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span> <span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;F&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;U&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;Z&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;Z&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;E&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Bad&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="c1">// bad: slice bounds out of range
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">slice</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">slice</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="p">}</span>

<span class="c1">// good: 使用data前应判断长度是否合法
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">decode</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span> <span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;F&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;U&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;Z&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;Z&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;E&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;R&#39;</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Good&#34;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="112必须nil指针判断">1.1.2【必须】nil指针判断<a hidden class="anchor" aria-hidden="true" href="#112必须nil指针判断">#</a></h4>
<ul>
<li>进行指针操作时，必须判断该指针是否为nil，防止程序panic，尤其在进行结构体Unmarshal时</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Packet</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">PackeyType</span>        <span class="kt">uint8</span>
    <span class="nx">PackeyVersion</span>     <span class="kt">uint8</span>
    <span class="nx">Data</span>              <span class="o">*</span><span class="nx">Data</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Data</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Stat</span>    <span class="kt">uint8</span>
    <span class="nx">Len</span> 	<span class="kt">uint8</span>
    <span class="nx">Buf</span> 	<span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Packet</span><span class="p">)</span> <span class="nf">UnmarshalBinary</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span>
       <span class="k">return</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
    <span class="p">}</span>

    <span class="nx">p</span><span class="p">.</span><span class="nx">PackeyType</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">PackeyVersion</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">// 若长度等于2，那么不会new Data
</span><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">2</span> <span class="p">{</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">Data</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Data</span><span class="p">)</span>
        <span class="c1">// Unmarshal(b[i:], p.Data)
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// bad: 未判断指针是否为nil
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">packet</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Packet</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">packet</span><span class="p">.</span><span class="nf">UnmarshalBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Failed to unmarshal packet&#34;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Stat: %v\n&#34;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Stat</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// good: 判断Data指针是否未nil
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">packet</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Packet</span><span class="p">)</span>
    <span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">packet</span><span class="p">.</span><span class="nf">UnmarshalBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Failed to unmarshal packet&#34;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">Data</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Stat: %v\n&#34;</span><span class="p">,</span> <span class="nx">packet</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Stat</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="113必须整数安全">1.1.3【必须】整数安全<a hidden class="anchor" aria-hidden="true" href="#113必须整数安全">#</a></h4>
<ul>
<li>
<p>在进行数字运算操作时，需要做好长度限制，防止外部输入运算导致异常：</p>
<ul>
<li>确保无符号整数运算时不会反转</li>
<li>确保有符号整数运算时不会出现溢出</li>
<li>确保整型转换时不会出现截断错误</li>
<li>确保整型转换时不会出现符号错误</li>
</ul>
</li>
<li>
<p>以下场景必须严格进行长度限制：</p>
<ul>
<li>作为数组索引</li>
<li>作为对象的长度或者大小</li>
<li>作为数组的边界（如作为循环计数器）</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad: 未限制长度，导致整数溢出
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">overflow</span><span class="p">(</span><span class="nx">numControlByUser</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">numInt</span> <span class="kt">int32</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">numInt</span> <span class="p">=</span> <span class="nx">numControlByUser</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1">//对长度限制不当，导致整数溢出
</span><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%d\n&#34;</span><span class="p">,</span> <span class="nx">numInt</span><span class="p">)</span>
    <span class="c1">//使用numInt，可能导致其他错误
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">overflow</span><span class="p">(</span><span class="mi">2147483647</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// good:
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">overflow</span><span class="p">(</span><span class="nx">numControlByUser</span> <span class="kt">int32</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">numInt</span> <span class="kt">int32</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="nx">numInt</span> <span class="p">=</span> <span class="nx">numControlByUser</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nx">numInt</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;integer overflow&#34;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;integer ok&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nf">overflow</span><span class="p">(</span><span class="mi">2147483647</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="114必须make分配长度验证">1.1.4【必须】make分配长度验证<a hidden class="anchor" aria-hidden="true" href="#114必须make分配长度验证">#</a></h4>
<ul>
<li>在进行make分配内存时，需要对外部可控的长度进行校验，防止程序panic。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">lenControlByUser</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">data</span><span class="p">[]</span> <span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">size</span> <span class="o">:=</span> <span class="nx">lenControlByUser</span>
    <span class="c1">//对外部传入的size，进行长度判断以免导致panic
</span><span class="c1"></span>    <span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
    <span class="nb">copy</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// good
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">lenControlByUser</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">data</span><span class="p">[]</span> <span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">){</span>
    <span class="nx">size</span> <span class="o">:=</span> <span class="nx">lenControlByUser</span>
    <span class="c1">//限制外部可控的长度大小范围
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">size</span> <span class="p">&gt;</span> <span class="mi">64</span><span class="o">*</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;value too large&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">buffer</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span>
    <span class="nb">copy</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">buffer</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="115必须禁止setfinalizer和指针循环引用同时使用">1.1.5【必须】禁止SetFinalizer和指针循环引用同时使用<a hidden class="anchor" aria-hidden="true" href="#115必须禁止setfinalizer和指针循环引用同时使用">#</a></h4>
<ul>
<li>当一个对象从被GC选中到移除内存之前，runtime.SetFinalizer()都不会执行，即使程序正常结束或者发生错误。由指针构成的“循环引用”虽然能被GC正确处理，但由于无法确定Finalizer依赖顺序，从而无法调用runtime.SetFinalizer()，导致目标对象无法变成可达状态，从而造成内存无法被回收。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="nx">Data</span>
    <span class="nx">a</span><span class="p">.</span><span class="nx">o</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">b</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">o</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">a</span>

    <span class="c1">//指针循环引用，SetFinalizer()无法正常调用
</span><span class="c1"></span>    <span class="nx">runtime</span><span class="p">.</span><span class="nf">SetFinalizer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;a %p final.\n&#34;</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
    <span class="p">})</span>
    <span class="nx">runtime</span><span class="p">.</span><span class="nf">SetFinalizer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;b %p final.\n&#34;</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nf">foo</span><span class="p">()</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="116必须禁止重复释放channel">1.1.6【必须】禁止重复释放channel<a hidden class="anchor" aria-hidden="true" href="#116必须禁止重复释放channel">#</a></h4>
<ul>
<li>重复释放一般存在于异常流程判断中，如果恶意攻击者构造出异常条件使程序重复释放channel，则会触发运行时恐慌，从而造成DoS攻击。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">foo</span><span class="p">(</span><span class="nx">c</span> <span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nf">processBusiness</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">c</span> <span class="o">&lt;-</span> <span class="mi">0</span>
        <span class="nb">close</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="c1">// 重复释放channel
</span><span class="c1"></span>        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">c</span> <span class="o">&lt;-</span> <span class="mi">1</span>
<span class="p">}</span>

<span class="c1">// good
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">foo</span><span class="p">(</span><span class="nx">c</span> <span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="c1">// 使用defer延迟关闭channel
</span><span class="c1"></span>    <span class="nx">err</span> <span class="o">:=</span> <span class="nf">processBusiness</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">c</span> <span class="o">&lt;-</span> <span class="mi">0</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">c</span> <span class="o">&lt;-</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="117必须确保每个协程都能退出">1.1.7【必须】确保每个协程都能退出<a hidden class="anchor" aria-hidden="true" href="#117必须确保每个协程都能退出">#</a></h4>
<ul>
<li>启动一个协程就会做一个入栈操作，在系统不退出的情况下，协程也没有设置退出条件，则相当于协程失去了控制，它占用的资源无法回收，可能会导致内存泄露。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad: 协程没有设置退出条件
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">doWaiter</span><span class="p">(</span><span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">second</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">second</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="s">&#34; is ready!&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="118推荐不使用unsafe包">1.1.8【推荐】不使用unsafe包<a hidden class="anchor" aria-hidden="true" href="#118推荐不使用unsafe包">#</a></h4>
<ul>
<li>由于unsafe包绕过了 Golang 的内存安全原则，一般来说使用该库是不安全的，可导致内存破坏，尽量避免使用该包。若必须要使用unsafe操作指针，必须做好安全校验。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad: 通过unsafe操作原始指针
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">unsafePointer</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">foo</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="kt">int</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span> <span class="nb">uintptr</span><span class="p">(</span><span class="mh">0xfffffffe</span><span class="p">)))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="o">*</span><span class="nx">foo</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// [signal SIGSEGV: segmentation violation code=0x1 addr=0xc100068f55 pc=0x49142b]
</span></code></pre></td></tr></table>
</div>
</div><h4 id="119推荐不使用slice作为函数入参">1.1.9【推荐】不使用slice作为函数入参<a hidden class="anchor" aria-hidden="true" href="#119推荐不使用slice作为函数入参">#</a></h4>
<ul>
<li>slice是引用类型，在作为函数入参时采用的是地址传递，对slice的修改也会影响原始数据</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// bad
</span><span class="c1"></span>  <span class="c1">// slice作为函数入参时是地址传递
</span><span class="c1"></span>  <span class="kd">func</span> <span class="nf">modify</span><span class="p">(</span><span class="nx">array</span> <span class="p">[]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="mi">10</span> <span class="c1">// 对入参slice的元素修改会影响原始数据
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">array</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">}</span>

      <span class="nf">modify</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="c1">// output：[10 2 3 4 5]
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="c1">// good
</span><span class="c1"></span>  <span class="c1">// 数组作为函数入参时，而不是slice
</span><span class="c1"></span>  <span class="kd">func</span> <span class="nf">modify</span><span class="p">(</span><span class="nx">array</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">=</span> <span class="mi">10</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// 传入数组，注意数组与slice的区别
</span><span class="c1"></span>      <span class="nx">array</span> <span class="o">:=</span> <span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="kt">int</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">}</span>

      <span class="nf">modify</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="12-文件操作">1.2 文件操作<a hidden class="anchor" aria-hidden="true" href="#12-文件操作">#</a></h3>
<h4 id="121必须-路径穿越检查">1.2.1【必须】 路径穿越检查<a hidden class="anchor" aria-hidden="true" href="#121必须-路径穿越检查">#</a></h4>
<ul>
<li>在进行文件操作时，如果对外部传入的文件名未做限制，可能导致任意文件读取或者任意文件写入，严重可能导致代码执行。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad: 任意文件读取
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">handler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()[</span><span class="s">&#34;path&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

	<span class="c1">// 未过滤文件路径，可能导致任意文件读取
</span><span class="c1"></span>	<span class="nx">data</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>

	<span class="c1">// 对外部传入的文件名变量，还需要验证是否存在../等路径穿越的文件名
</span><span class="c1"></span>	<span class="nx">data</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">&#34;/home/user/&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">))</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// bad: 任意文件写入
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">unzip</span><span class="p">(</span><span class="nx">f</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">r</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">zip</span><span class="p">.</span><span class="nf">OpenReader</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">File</span> <span class="p">{</span>
		<span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="c1">// 未验证压缩文件名，可能导致../等路径穿越，任意文件路径写入
</span><span class="c1"></span>		<span class="nx">ioutil</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;present&#34;</span><span class="p">),</span> <span class="mo">0640</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// good: 检查压缩的文件名是否包含..路径穿越特征字符，防止任意写入
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">unzipGood</span><span class="p">(</span><span class="nx">f</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">r</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">zip</span><span class="p">.</span><span class="nf">OpenReader</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;read zip file fail&#34;</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">File</span> <span class="p">{</span>
		<span class="nx">p</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="s">&#34;..&#34;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">ioutil</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;present&#34;</span><span class="p">),</span> <span class="mo">0640</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="122必须-文件访问权限">1.2.2【必须】 文件访问权限<a hidden class="anchor" aria-hidden="true" href="#122必须-文件访问权限">#</a></h4>
<ul>
<li>根据创建文件的敏感性设置不同级别的访问权限，以防止敏感数据被任意权限用户读取。例如，设置文件权限为：<code>-rw-r-----</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ioutil</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;present&#34;</span><span class="p">),</span> <span class="mo">0640</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="13-系统接口">1.3 系统接口<a hidden class="anchor" aria-hidden="true" href="#13-系统接口">#</a></h3>
<p><strong>1.3.1【必须】命令执行检查</strong></p>
<ul>
<li>使用<code>exec.Command</code>、<code>exec.CommandContext</code>、<code>syscall.StartProcess</code>、<code>os.StartProcess</code>等函数时，第一个参数（path）直接取外部输入值时，应使用白名单限定可执行的命令范围，不允许传入<code>bash</code>、<code>cmd</code>、<code>sh</code>等命令；</li>
<li>使用<code>exec.Command</code>、<code>exec.CommandContext</code>等函数时，通过<code>bash</code>、<code>cmd</code>、<code>sh</code>等创建shell，-c后的参数（arg）拼接外部输入，应过滤\n  $  &amp;  ;  |  '  &quot;  ( )  `等潜在恶意字符；</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">userInputedVal</span> <span class="o">:=</span> <span class="s">&#34;&amp;&amp; echo &#39;hello&#39;&#34;</span> <span class="c1">// 假设外部传入该变量值
</span><span class="c1"></span>	<span class="nx">cmdName</span> <span class="o">:=</span> <span class="s">&#34;ping &#34;</span> <span class="o">+</span> <span class="nx">userInputedVal</span>

	<span class="c1">//未判断外部输入是否存在命令注入字符，结合sh可造成命令注入
</span><span class="c1"></span>	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="s">&#34;sh&#34;</span><span class="p">,</span> <span class="s">&#34;-c&#34;</span><span class="p">,</span> <span class="nx">cmdName</span><span class="p">)</span>
	<span class="nx">output</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">CombinedOutput</span><span class="p">()</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">output</span><span class="p">))</span>

	<span class="nx">cmdName</span> <span class="o">:=</span> <span class="s">&#34;ls&#34;</span>
	<span class="c1">//未判断外部输入是否是预期命令
</span><span class="c1"></span>	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">)</span>
	<span class="nx">output</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">CombinedOutput</span><span class="p">()</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">output</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// good
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">checkIllegal</span><span class="p">(</span><span class="nx">cmdName</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;&amp;&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;|&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;;&#34;</span><span class="p">)</span> <span class="o">||</span>
		<span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;$&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;&#39;&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;`&#34;</span><span class="p">)</span> <span class="o">||</span>
		<span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;(&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;)&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">,</span> <span class="s">&#34;\&#34;&#34;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">userInputedVal</span> <span class="o">:=</span> <span class="s">&#34;&amp;&amp; echo &#39;hello&#39;&#34;</span>
	<span class="nx">cmdName</span> <span class="o">:=</span> <span class="s">&#34;ping &#34;</span> <span class="o">+</span> <span class="nx">userInputedVal</span>

	<span class="k">if</span> <span class="nf">checkIllegal</span><span class="p">(</span><span class="nx">cmdName</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 检查传给sh的命令是否有特殊字符
</span><span class="c1"></span>		<span class="k">return</span> <span class="c1">// 存在特殊字符直接return
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">exec</span><span class="p">.</span><span class="nf">Command</span><span class="p">(</span><span class="s">&#34;sh&#34;</span><span class="p">,</span> <span class="s">&#34;-c&#34;</span><span class="p">,</span> <span class="nx">cmdName</span><span class="p">)</span>
	<span class="nx">output</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">cmd</span><span class="p">.</span><span class="nf">CombinedOutput</span><span class="p">()</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">output</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="14-通信安全">1.4 通信安全<a hidden class="anchor" aria-hidden="true" href="#14-通信安全">#</a></h3>
<h4 id="141必须网络通信采用tls方式">1.4.1【必须】网络通信采用TLS方式<a hidden class="anchor" aria-hidden="true" href="#141必须网络通信采用tls方式">#</a></h4>
<ul>
<li>明文传输的通信协议目前已被验证存在较大安全风险，被中间人劫持后可能导致许多安全风险，因此必须采用至少TLS的安全通信方式保证通信安全，例如gRPC/Websocket都使用TLS1.3。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// good
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Strict-Transport-Security&#34;</span><span class="p">,</span> <span class="s">&#34;max-age=63072000; includeSubDomains&#34;</span><span class="p">)</span>
    <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;This is an example server.\n&#34;</span><span class="p">))</span>
  <span class="p">})</span>

  <span class="c1">//服务器配置证书与私钥
</span><span class="c1"></span>  <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServeTLS</span><span class="p">(</span><span class="s">&#34;:443&#34;</span><span class="p">,</span> <span class="s">&#34;yourCert.pem&#34;</span><span class="p">,</span> <span class="s">&#34;yourKey.pem&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="142推荐tls启用证书验证">1.4.2【推荐】TLS启用证书验证<a hidden class="anchor" aria-hidden="true" href="#142推荐tls启用证书验证">#</a></h4>
<ul>
<li>TLS证书应当是有效的、未过期的，且配置正确的域名，生产环境的服务端应启用证书验证。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;crypto/tls&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">doAuthReq</span><span class="p">(</span><span class="nx">authReq</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span>
	<span class="nx">tr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
		<span class="nx">TLSClientConfig</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">InsecureSkipVerify</span><span class="p">:</span> <span class="kc">true</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Transport</span><span class="p">:</span> <span class="nx">tr</span><span class="p">}</span>
	<span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">authReq</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">res</span>
<span class="p">}</span>

<span class="c1">// good
</span><span class="c1"></span><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;crypto/tls&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">doAuthReq</span><span class="p">(</span><span class="nx">authReq</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span> <span class="p">{</span>
	<span class="nx">tr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
		<span class="nx">TLSClientConfig</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">InsecureSkipVerify</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span><span class="nx">Transport</span><span class="p">:</span> <span class="nx">tr</span><span class="p">}</span>
	<span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">authReq</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">res</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="15-敏感数据保护">1.5 敏感数据保护<a hidden class="anchor" aria-hidden="true" href="#15-敏感数据保护">#</a></h3>
<h4 id="151必须敏感信息访问">1.5.1【必须】敏感信息访问<a hidden class="anchor" aria-hidden="true" href="#151必须敏感信息访问">#</a></h4>
<ul>
<li>禁止将敏感信息硬编码在程序中，既可能会将敏感信息暴露给攻击者，也会增加代码管理和维护的难度</li>
<li>使用配置中心系统统一托管密钥等敏感信息</li>
</ul>
<h4 id="152必须敏感数据输出">1.5.2【必须】敏感数据输出<a hidden class="anchor" aria-hidden="true" href="#152必须敏感数据输出">#</a></h4>
<ul>
<li>只输出必要的最小数据集，避免多余字段暴露引起敏感信息泄露</li>
<li>不能在日志保存密码（包括明文密码和密文密码）、密钥和其它敏感信息</li>
<li>对于必须输出的敏感信息，必须进行合理脱敏展示</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">serve</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/register&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">r</span><span class="p">.</span><span class="nf">ParseForm</span><span class="p">()</span>
		<span class="nx">user</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Form</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">)</span>
		<span class="nx">pw</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Form</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;password&#34;</span><span class="p">)</span>

		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Registering new user %s with password %s.\n&#34;</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">pw</span><span class="p">)</span>
	<span class="p">})</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:80&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// good
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">serve1</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/register&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">r</span><span class="p">.</span><span class="nf">ParseForm</span><span class="p">()</span>
		<span class="nx">user</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Form</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;user&#34;</span><span class="p">)</span>
		<span class="nx">pw</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Form</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;password&#34;</span><span class="p">)</span>

		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Registering new user %s.\n&#34;</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span>

		<span class="c1">// ...
</span><span class="c1"></span>		<span class="nf">use</span><span class="p">(</span><span class="nx">pw</span><span class="p">)</span>
	<span class="p">})</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:80&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>避免通过GET方法、代码注释、自动填充、缓存等方式泄露敏感信息</li>
</ul>
<h4 id="153必须敏感数据存储">1.5.3【必须】敏感数据存储<a hidden class="anchor" aria-hidden="true" href="#153必须敏感数据存储">#</a></h4>
<ul>
<li>敏感数据应使用SHA2、RSA等算法进行加密存储</li>
<li>敏感数据应使用独立的存储层，并在访问层开启访问控制</li>
<li>包含敏感信息的临时文件或缓存一旦不再需要应立刻删除</li>
</ul>
<h4 id="154必须异常处理和日志记录">1.5.4【必须】异常处理和日志记录<a hidden class="anchor" aria-hidden="true" href="#154必须异常处理和日志记录">#</a></h4>
<ul>
<li>应合理使用panic、recover、defer处理系统异常，避免出错信息输出到前端</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">defer</span> <span class="kd">func</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">r</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Recovered in start()&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>对外环境禁止开启debug模式，或将程序运行日志输出到前端</li>
</ul>
<p>错误例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">dlv --listen<span class="o">=</span>:2345 --headless<span class="o">=</span><span class="nb">true</span> --api-version<span class="o">=</span><span class="m">2</span> debug test.go
</code></pre></td></tr></table>
</div>
</div><p>正确例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">dlv debug test.go
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="16-加密解密">1.6 加密解密<a hidden class="anchor" aria-hidden="true" href="#16-加密解密">#</a></h3>
<h4 id="161必须不得硬编码密码密钥">1.6.1【必须】不得硬编码密码/密钥<a hidden class="anchor" aria-hidden="true" href="#161必须不得硬编码密码密钥">#</a></h4>
<ul>
<li>在进行用户登陆，加解密算法等操作时，不得在代码里硬编码密钥或密码，可通过变换算法或者配置等方式设置密码或者密钥。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
	<span class="nx">user</span>     <span class="p">=</span> <span class="s">&#34;dbuser&#34;</span>
	<span class="nx">password</span> <span class="p">=</span> <span class="s">&#34;s3cretp4ssword&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">connect</span><span class="p">()</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span> <span class="p">{</span>
	<span class="nx">connStr</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;postgres://%s:%s@localhost/pqgotest&#34;</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
	<span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sql</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;postgres&#34;</span><span class="p">,</span> <span class="nx">connStr</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">db</span>
<span class="p">}</span>

<span class="c1">// bad
</span><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
	<span class="nx">commonkey</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;0123456789abcdef&#34;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">AesEncrypt</span><span class="p">(</span><span class="nx">plaintext</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">block</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">aes</span><span class="p">.</span><span class="nf">NewCipher</span><span class="p">(</span><span class="nx">commonkey</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="162必须密钥存储安全">1.6.2【必须】密钥存储安全<a hidden class="anchor" aria-hidden="true" href="#162必须密钥存储安全">#</a></h4>
<ul>
<li>在使用对称密码算法时，需要保护好加密密钥。当算法涉及敏感、业务数据时，可通过非对称算法协商加密密钥。其他较为不敏感的数据加密，可以通过变换算法等方式保护密钥。</li>
</ul>
<h4 id="163推荐不使用弱密码算法">1.6.3【推荐】不使用弱密码算法<a hidden class="anchor" aria-hidden="true" href="#163推荐不使用弱密码算法">#</a></h4>
<ul>
<li>在使用加密算法时，不建议使用加密强度较弱的算法。</li>
</ul>
<p>错误例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">crypto/des，crypto/md5，crypto/sha1，crypto/rc4等。
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="17-正则表达式">1.7 正则表达式<a hidden class="anchor" aria-hidden="true" href="#17-正则表达式">#</a></h3>
<h4 id="171推荐使用regexp进行正则表达式匹配">1.7.1【推荐】使用regexp进行正则表达式匹配<a hidden class="anchor" aria-hidden="true" href="#171推荐使用regexp进行正则表达式匹配">#</a></h4>
<ul>
<li>正则表达式编写不恰当可被用于DoS攻击，造成服务不可用，推荐使用regexp包进行正则表达式匹配。regexp保证了线性时间性能和优雅的失败：对解析器、编译器和执行引擎都进行了内存限制。但regexp不支持以下正则表达式特性，如业务依赖这些特性，则regexp不适合使用。
<ul>
<li>回溯引用<a href="https://www.regular-expressions.info/backref.html">Backreferences</a>和查看<a href="https://www.regular-expressions.info/lookaround.html">Lookaround</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// good
</span><span class="c1"></span><span class="nx">matched</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nf">MatchString</span><span class="p">(</span><span class="s">`a.b`</span><span class="p">,</span> <span class="s">&#34;aaxbb&#34;</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">matched</span><span class="p">)</span> <span class="c1">// true
</span><span class="c1"></span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>     <span class="c1">// nil (regexp is valid)
</span></code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="后台类">后台类<a hidden class="anchor" aria-hidden="true" href="#后台类">#</a></h1>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="1-代码实现类-1">1 代码实现类<a hidden class="anchor" aria-hidden="true" href="#1-代码实现类-1">#</a></h2>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="11-输入校验">1.1 输入校验<a hidden class="anchor" aria-hidden="true" href="#11-输入校验">#</a></h3>
<h4 id="111必须按类型进行数据校验">1.1.1【必须】按类型进行数据校验<a hidden class="anchor" aria-hidden="true" href="#111必须按类型进行数据校验">#</a></h4>
<ul>
<li>所有外部输入的参数，应使用<code>validator</code>进行白名单校验，校验内容包括但不限于数据长度、数据范围、数据类型与格式，校验不通过的应当拒绝</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// good
</span><span class="c1"></span><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;github.com/go-playground/validator/v10&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">validate</span> <span class="o">*</span><span class="nx">validator</span><span class="p">.</span><span class="nx">Validate</span>
<span class="nx">validate</span> <span class="p">=</span> <span class="nx">validator</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
<span class="kd">func</span> <span class="nf">validateVariable</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">myEmail</span> <span class="o">:=</span> <span class="s">&#34;abc@tencent.com&#34;</span>
	<span class="nx">errs</span> <span class="o">:=</span> <span class="nx">validate</span><span class="p">.</span><span class="nf">Var</span><span class="p">(</span><span class="nx">myEmail</span><span class="p">,</span> <span class="s">&#34;required,email&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">errs</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">errs</span><span class="p">)</span>
		<span class="k">return</span>
        <span class="c1">//停止执行
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="c1">// 验证通过，继续执行
</span><span class="c1"></span>    <span class="o">...</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>无法通过白名单校验的应使用<code>html.EscapeString</code>、<code>text/template</code>或<code>bluemonday</code>对<code>&lt;, &gt;, &amp;, ',&quot;</code>等字符进行过滤或编码</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kn">import</span><span class="p">(</span>
  	<span class="s">&#34;text/template&#34;</span>
  <span class="p">)</span>

  <span class="c1">// TestHTMLEscapeString HTML特殊字符转义
</span><span class="c1"></span>  <span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="nx">inputValue</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span><span class="p">{</span>
  	<span class="nx">escapedResult</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nf">HTMLEscapeString</span><span class="p">(</span><span class="nx">inputValue</span><span class="p">)</span>
  	<span class="k">return</span> <span class="nx">escapedResult</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="12-sql操作">1.2 SQL操作<a hidden class="anchor" aria-hidden="true" href="#12-sql操作">#</a></h3>
<h4 id="121必须sql语句默认使用预编译并绑定变量">1.2.1【必须】SQL语句默认使用预编译并绑定变量<a hidden class="anchor" aria-hidden="true" href="#121必须sql语句默认使用预编译并绑定变量">#</a></h4>
<ul>
<li>使用<code>database/sql</code>的prepare、Query或使用GORM等ORM执行SQL操作</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/jinzhu/gorm&#34;</span>
    <span class="nx">_</span> <span class="s">&#34;github.com/jinzhu/gorm/dialects/sqlite&#34;</span>
  <span class="p">)</span>

  <span class="kd">type</span> <span class="nx">Product</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">gorm</span><span class="p">.</span><span class="nx">Model</span>
    <span class="nx">Code</span> <span class="kt">string</span>
    <span class="nx">Price</span> <span class="kt">uint</span>
  <span class="p">}</span>
  <span class="o">...</span>
  <span class="kd">var</span> <span class="nx">product</span> <span class="nx">Product</span>
  <span class="nx">db</span><span class="p">.</span><span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">product</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>使用参数化查询，禁止拼接SQL语句，另外对于传入参数用于order by或表名的需要通过校验</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span>  <span class="kn">import</span> <span class="p">(</span>
  	<span class="s">&#34;database/sql&#34;</span>
  	<span class="s">&#34;fmt&#34;</span>
  	<span class="s">&#34;net/http&#34;</span>
  <span class="p">)</span>

  <span class="kd">func</span> <span class="nf">handler</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
  	<span class="nx">q</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;SELECT ITEM,PRICE FROM PRODUCT WHERE ITEM_CATEGORY=&#39;%s&#39; ORDER BY PRICE&#34;</span><span class="p">,</span>
  		<span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()[</span><span class="s">&#34;category&#34;</span><span class="p">])</span>
  	<span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nx">q</span><span class="p">)</span>
  <span class="p">}</span>

<span class="c1">// good
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">handlerGood</span><span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//使用?占位符
</span><span class="c1"></span>  	<span class="nx">q</span> <span class="o">:=</span> <span class="s">&#34;SELECT ITEM,PRICE FROM PRODUCT WHERE ITEM_CATEGORY=&#39;?&#39; ORDER BY PRICE&#34;</span>
  	<span class="nx">db</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nx">q</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()[</span><span class="s">&#34;category&#34;</span><span class="p">])</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="13-网络请求">1.3 网络请求<a hidden class="anchor" aria-hidden="true" href="#13-网络请求">#</a></h3>
<h4 id="131必须资源请求过滤验证">1.3.1【必须】资源请求过滤验证<a hidden class="anchor" aria-hidden="true" href="#131必须资源请求过滤验证">#</a></h4>
<ul>
<li>
<p>使用<code>&quot;net/http&quot;</code>下的方法<code>http.Get(url)</code>、<code>http.Post(url, contentType, body)</code>、<code>http.Head(url )</code>、<code>http.PostForm(url, data)</code>、<code>http.Do(req)</code>时，如变量值外部可控（指从参数中动态获取），应对请求目标进行严格的安全校验。</p>
</li>
<li>
<p>如请求资源域名归属固定的范围，如只允许<code>a.qq.com</code>和<code>b.qq.com</code>，应做白名单限制。如不适用白名单，则推荐的校验逻辑步骤是：</p>
<ul>
<li>
<p>第 1 步、只允许HTTP或HTTPS协议</p>
</li>
<li>
<p>第 2 步、解析目标URL，获取其HOST</p>
</li>
<li>
<p>第 3 步、解析HOST，获取HOST指向的IP地址转换成Long型</p>
</li>
<li>
<p>第 4 步、检查IP地址是否为内网IP，网段有：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">// 以RFC定义的专有网络为例，如有自定义私有网段亦应加入禁止访问列表。
10.0.0.0/8
172.16.0.0/12
192.168.0.0/16
127.0.0.0/8
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>第 5 步、请求URL</p>
</li>
<li>
<p>第 6 步、如有跳转，跳转后执行1，否则绑定经校验的ip和域名，对URL发起请求</p>
</li>
</ul>
</li>
<li>
<p>官方库<code>encoding/xml</code>不支持外部实体引用，使用该库可避免xxe漏洞</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kn">import</span> <span class="p">(</span>
  	<span class="s">&#34;encoding/xml&#34;</span>
  	<span class="s">&#34;fmt&#34;</span>
      <span class="s">&#34;os&#34;</span>
  <span class="p">)</span>

  <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  	<span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
  		<span class="nx">XMLName</span>   <span class="nx">xml</span><span class="p">.</span><span class="nx">Name</span> <span class="s">`xml:&#34;person&#34;`</span>
  		<span class="nx">Id</span>        <span class="kt">int</span>      <span class="s">`xml:&#34;id,attr&#34;`</span>
  		<span class="nx">UserName</span> <span class="kt">string</span>   <span class="s">`xml:&#34;name&gt;first&#34;`</span>
  		<span class="nx">Comment</span> <span class="kt">string</span> <span class="s">`xml:&#34;,comment&#34;`</span>
  	<span class="p">}</span>

  	<span class="nx">v</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Person</span><span class="p">{</span><span class="nx">Id</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="nx">UserName</span><span class="p">:</span> <span class="s">&#34;John&#34;</span><span class="p">}</span>
  	<span class="nx">v</span><span class="p">.</span><span class="nx">Comment</span> <span class="p">=</span> <span class="s">&#34; Need more details. &#34;</span>

  	<span class="nx">enc</span> <span class="o">:=</span> <span class="nx">xml</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">)</span>
  	<span class="nx">enc</span><span class="p">.</span><span class="nf">Indent</span><span class="p">(</span><span class="s">&#34;  &#34;</span><span class="p">,</span> <span class="s">&#34;    &#34;</span><span class="p">)</span>
  	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">enc</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;error: %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
  	<span class="p">}</span>

  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="14-服务器端渲染">1.4 服务器端渲染<a hidden class="anchor" aria-hidden="true" href="#14-服务器端渲染">#</a></h3>
<h4 id="141必须模板渲染过滤验证">1.4.1【必须】模板渲染过滤验证<a hidden class="anchor" aria-hidden="true" href="#141必须模板渲染过滤验证">#</a></h4>
<ul>
<li>使用<code>text/template</code>或者<code>html/template</code>渲染模板时禁止将外部输入参数引入模板，或仅允许引入白名单内字符。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">   <span class="c1">// bad
</span><span class="c1"></span>    <span class="kd">func</span> <span class="nf">handler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span><span class="p">.</span><span class="nf">ParseForm</span><span class="p">()</span>
      <span class="nx">x</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Form</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">)</span>

      <span class="kd">var</span> <span class="nx">tmpl</span> <span class="p">=</span> <span class="s">`&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;
</span><span class="s">    &lt;form action=&#34;/&#34; method=&#34;post&#34;&gt;
</span><span class="s">        First name:&lt;br&gt;
</span><span class="s">    &lt;input type=&#34;text&#34; name=&#34;name&#34; value=&#34;&#34;&gt;
</span><span class="s">    &lt;input type=&#34;submit&#34; value=&#34;Submit&#34;&gt;
</span><span class="s">    &lt;/form&gt;&lt;p&gt;`</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s">` &lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span>

      <span class="nx">t</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">)</span>
      <span class="nx">t</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">)</span>
      <span class="nx">t</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1">// good
</span><span class="c1"></span>    <span class="kn">import</span> <span class="p">(</span>
    	<span class="s">&#34;fmt&#34;</span>
    	<span class="s">&#34;github.com/go-playground/validator/v10&#34;</span>
    <span class="p">)</span>

    <span class="kd">var</span> <span class="nx">validate</span> <span class="o">*</span><span class="nx">validator</span><span class="p">.</span><span class="nx">Validate</span>
    <span class="nx">validate</span> <span class="p">=</span> <span class="nx">validator</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">validateVariable</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
    	<span class="nx">errs</span> <span class="o">:=</span> <span class="nx">validate</span><span class="p">.</span><span class="nf">Var</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="s">&#34;gte=1,lte=100&#34;</span><span class="p">)</span><span class="c1">//限制必须是1-100的正整数
</span><span class="c1"></span>    	<span class="k">if</span> <span class="nx">errs</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">errs</span><span class="p">)</span>
    		<span class="k">return</span> <span class="nx">False</span>
    	<span class="p">}</span>
        <span class="k">return</span> <span class="nx">True</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">handler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">.</span><span class="nf">ParseForm</span><span class="p">()</span>
        <span class="nx">x</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Form</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;name&#34;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nf">validateVariable</span><span class="p">(</span><span class="nx">x</span><span class="p">):</span>
            <span class="kd">var</span> <span class="nx">tmpl</span> <span class="p">=</span> <span class="s">`&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;
</span><span class="s">            &lt;form action=&#34;/&#34; method=&#34;post&#34;&gt;
</span><span class="s">            First name:&lt;br&gt;
</span><span class="s">            &lt;input type=&#34;text&#34; name=&#34;name&#34; value=&#34;&#34;&gt;
</span><span class="s">            &lt;input type=&#34;submit&#34; value=&#34;Submit&#34;&gt;
</span><span class="s">            &lt;/form&gt;&lt;p&gt;`</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span> <span class="s">` &lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span>
            <span class="nx">t</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;main&#34;</span><span class="p">)</span>
            <span class="nx">t</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">tmpl</span><span class="p">)</span>
            <span class="nx">t</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Hello&#34;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="o">...</span>
    <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="15-web跨域">1.5 Web跨域<a hidden class="anchor" aria-hidden="true" href="#15-web跨域">#</a></h3>
<h4 id="151必须跨域资源共享cors限制请求来源">1.5.1【必须】跨域资源共享CORS限制请求来源<a hidden class="anchor" aria-hidden="true" href="#151必须跨域资源共享cors限制请求来源">#</a></h4>
<ul>
<li>CORS请求保护不当可导致敏感信息泄漏，因此应当严格设置Access-Control-Allow-Origin使用同源策略进行保护。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"> <span class="c1">// good
</span><span class="c1"></span>  <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">cors</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
      <span class="nx">AllowedOrigins</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;http://qq.com&#34;</span><span class="p">,</span> <span class="s">&#34;https://qq.com&#34;</span><span class="p">},</span>
      <span class="nx">AllowCredentials</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">Debug</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="p">})</span>

  <span class="c1">//引入中间件
</span><span class="c1"></span>  <span class="nx">handler</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="16-响应输出">1.6 响应输出<a hidden class="anchor" aria-hidden="true" href="#16-响应输出">#</a></h3>
<h4 id="161-必须设置正确的http响应包类型">1.6.1 【必须】设置正确的HTTP响应包类型<a hidden class="anchor" aria-hidden="true" href="#161-必须设置正确的http响应包类型">#</a></h4>
<ul>
<li>响应头Content-Type与实际响应内容，应保持一致。如：API响应数据类型是json，则响应头使用<code>application/json</code>；若为xml，则设置为<code>text/xml</code>。</li>
</ul>
<h4 id="162-必须添加安全响应头">1.6.2 【必须】添加安全响应头<a hidden class="anchor" aria-hidden="true" href="#162-必须添加安全响应头">#</a></h4>
<ul>
<li>所有接口、页面，添加响应头 <code>X-Content-Type-Options: nosniff</code>。</li>
<li>所有接口、页面，添加响应头<code>X-Frame-Options</code>。按需合理设置其允许范围，包括：<code>DENY</code>、<code>SAMEORIGIN</code>、<code>ALLOW-FROM origin</code>。用法参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/X-Frame-Options">MDN文档</a></li>
</ul>
<h4 id="163必须外部输入拼接到http响应头中需进行过滤">1.6.3【必须】外部输入拼接到HTTP响应头中需进行过滤<a hidden class="anchor" aria-hidden="true" href="#163必须外部输入拼接到http响应头中需进行过滤">#</a></h4>
<ul>
<li>应尽量避免外部可控参数拼接到HTTP响应头中，如业务需要则需要过滤掉<code>\r</code>、<code>\n</code>等换行符，或者拒绝携带换行符号的外部输入。</li>
</ul>
<h4 id="164必须外部输入拼接到response页面前进行编码处理">1.6.4【必须】外部输入拼接到response页面前进行编码处理<a hidden class="anchor" aria-hidden="true" href="#164必须外部输入拼接到response页面前进行编码处理">#</a></h4>
<ul>
<li>直出html页面或使用模板生成html页面的，推荐使用<code>text/template</code>自动编码，或者使用<code>html.EscapeString</code>或<code>text/template</code>对<code>&lt;, &gt;, &amp;, ',&quot;</code>等字符进行编码。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span><span class="p">(</span>
	<span class="s">&#34;html/template&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">outtemplate</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span><span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">param1</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;param1&#34;</span><span class="p">)</span>
    <span class="nx">tmpl</span> <span class="o">:=</span> <span class="nx">template</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;hello&#34;</span><span class="p">)</span>
    <span class="nx">tmpl</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">tmpl</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="s">`</span><span class="cp">{{</span><span class="nx">define</span><span class="w"> </span><span class="s">&#34;T&#34;</span><span class="cp">}}{{</span><span class="na">.</span><span class="cp">}}{{</span><span class="k">end</span><span class="cp">}}</span><span class="s">`</span><span class="p">)</span>
    <span class="nx">tmpl</span><span class="p">.</span><span class="nf">ExecuteTemplate</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;T&#34;</span><span class="p">,</span> <span class="nx">param1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="17-会话管理">1.7 会话管理<a hidden class="anchor" aria-hidden="true" href="#17-会话管理">#</a></h3>
<h4 id="171必须安全维护session信息">1.7.1【必须】安全维护session信息<a hidden class="anchor" aria-hidden="true" href="#171必须安全维护session信息">#</a></h4>
<ul>
<li>用户登录时应重新生成session，退出登录后应清理session。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;github.com/gorilla/mux&#34;</span>
	<span class="s">&#34;github.com/gorilla/handlers&#34;</span>
<span class="p">)</span>

<span class="c1">//创建cookie
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">setToken</span><span class="p">(</span><span class="nx">res</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">expireToken</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="o">*</span> <span class="mi">30</span><span class="p">).</span><span class="nf">Unix</span><span class="p">()</span>
    <span class="nx">expireCookie</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="nx">cookie</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">{</span>
        <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Auth&#34;</span><span class="p">,</span>
        <span class="nx">Value</span><span class="p">:</span> <span class="nx">signedToken</span><span class="p">,</span>
        <span class="nx">Expires</span><span class="p">:</span> <span class="nx">expireCookie</span><span class="p">,</span> <span class="c1">// 过期失效
</span><span class="c1"></span>        <span class="nx">HttpOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">Path</span><span class="p">:</span> <span class="s">&#34;/&#34;</span><span class="p">,</span>
        <span class="nx">Domain</span><span class="p">:</span> <span class="s">&#34;127.0.0.1&#34;</span><span class="p">,</span>
        <span class="nx">Secure</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}</span>

    <span class="nx">http</span><span class="p">.</span><span class="nf">SetCookie</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">cookie</span><span class="p">)</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">Redirect</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="s">&#34;/profile&#34;</span><span class="p">,</span> <span class="mi">307</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// 删除cookie
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">logout</span><span class="p">(</span><span class="nx">res</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">deleteCookie</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Cookie</span><span class="p">{</span>
        <span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Auth&#34;</span><span class="p">,</span>
        <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;none&#34;</span><span class="p">,</span>
        <span class="nx">Expires</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">SetCookie</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">deleteCookie</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="172必须csrf防护">1.7.2【必须】CSRF防护<a hidden class="anchor" aria-hidden="true" href="#172必须csrf防护">#</a></h4>
<ul>
<li>涉及系统敏感操作或可读取敏感信息的接口应校验<code>Referer</code>或添加<code>csrf_token</code>。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// good
</span><span class="c1"></span><span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;net/http&#34;</span>
    <span class="s">&#34;github.com/gorilla/csrf&#34;</span>
    <span class="s">&#34;github.com/gorilla/mux&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">()</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/signup&#34;</span><span class="p">,</span> <span class="nx">ShowSignupForm</span><span class="p">)</span>
    <span class="nx">r</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/signup/post&#34;</span><span class="p">,</span> <span class="nx">SubmitSignupForm</span><span class="p">)</span>
    <span class="c1">//使用csrf_token验证
</span><span class="c1"></span>    <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:8000&#34;</span><span class="p">,</span>
        <span class="nx">csrf</span><span class="p">.</span><span class="nf">Protect</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;32-byte-long-auth-key&#34;</span><span class="p">))(</span><span class="nx">r</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="18-访问控制">1.8 访问控制<a hidden class="anchor" aria-hidden="true" href="#18-访问控制">#</a></h3>
<h4 id="181必须默认鉴权">1.8.1【必须】默认鉴权<a hidden class="anchor" aria-hidden="true" href="#181必须默认鉴权">#</a></h4>
<ul>
<li>
<p>除非资源完全可对外开放，否则系统默认进行身份认证，使用白名单的方式放开不需要认证的接口或页面。</p>
</li>
<li>
<p>根据资源的机密程度和用户角色，以最小权限原则，设置不同级别的权限，如完全公开、登录可读、登录可写、特定用户可读、特定用户可写等</p>
</li>
<li>
<p>涉及用户自身相关的数据的读写必须验证登录态用户身份及其权限，避免越权操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="c1">-- 伪代码
</span><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="p">:</span><span class="n">id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">userid</span><span class="o">=</span><span class="k">session</span><span class="p">.</span><span class="n">userid</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>没有独立账号体系的外网服务使用<code>QQ</code>或<code>微信</code>登录，内网服务使用<code>统一登录服务</code>登录，其他使用账号密码登录的服务需要增加验证码等二次验证</p>
</li>
</ul>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="19-并发保护">1.9 并发保护<a hidden class="anchor" aria-hidden="true" href="#19-并发保护">#</a></h3>
<h4 id="191必须禁止在闭包中直接调用循环变量">1.9.1【必须】禁止在闭包中直接调用循环变量<a hidden class="anchor" aria-hidden="true" href="#191必须禁止在闭包中直接调用循环变量">#</a></h4>
<ul>
<li>在循环中启动协程，当协程中使用到了循环的索引值，由于多个协程同时使用同一个变量会产生数据竞争，造成执行结果异常。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">runtime</span><span class="p">.</span><span class="nf">GOMAXPROCS</span><span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nf">NumCPU</span><span class="p">())</span>
    <span class="kd">var</span> <span class="nx">group</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">group</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="nx">group</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%-2d&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="c1">//这里打印的i不是所期望的
</span><span class="c1"></span>        <span class="p">}()</span>
    <span class="p">}</span>
    <span class="nx">group</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// good
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">runtime</span><span class="p">.</span><span class="nf">GOMAXPROCS</span><span class="p">(</span><span class="nx">runtime</span><span class="p">.</span><span class="nf">NumCPU</span><span class="p">())</span>
    <span class="kd">var</span> <span class="nx">group</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">group</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">j</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">r</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Recovered in start()&#34;</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="nx">group</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
            <span class="p">}()</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%-2d&#34;</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="c1">// 闭包内部使用局部变量
</span><span class="c1"></span>        <span class="p">}(</span><span class="nx">i</span><span class="p">)</span>  <span class="c1">// 把循环变量显式地传给协程
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="nx">group</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="192必须禁止并发写map">1.9.2【必须】禁止并发写map<a hidden class="anchor" aria-hidden="true" href="#192必须禁止并发写map">#</a></h4>
<ul>
<li>并发写map容易造成程序崩溃并异常退出，建议加锁保护</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// bad
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
	<span class="c1">//并发读写
</span><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="nx">_</span> <span class="p">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
		<span class="p">}</span>
	<span class="p">}()</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="nx">m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="mi">1</span>
		<span class="p">}</span>
	<span class="p">}()</span>
	<span class="k">select</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="193必须确保并发安全">1.9.3【必须】确保并发安全<a hidden class="anchor" aria-hidden="true" href="#193必须确保并发安全">#</a></h4>
<p>敏感操作如果未作并发安全限制，可导致数据读写异常，造成业务逻辑限制被绕过。可通过同步锁或者原子操作进行防护。</p>
<p>通过同步锁共享内存</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// good
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">count</span> <span class="kt">int</span>
<span class="kd">func</span> <span class="nf">Count</span><span class="p">(</span><span class="nx">lock</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span><span class="c1">// 加写锁
</span><span class="c1"></span>    <span class="nx">count</span><span class="o">++</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span>
    <span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span><span class="c1">// 解写锁，任何一个Lock()或RLock()均需要保证对应有Unlock()或RUnlock()
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">lock</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">{}</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="nf">Count</span><span class="p">(</span><span class="nx">lock</span><span class="p">)</span> <span class="c1">//传递指针是为了防止函数内的锁和调用锁不一致
</span><span class="c1"></span>    <span class="p">}</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
        <span class="nx">c</span> <span class="o">:=</span> <span class="nx">count</span>
        <span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
        <span class="nx">runtime</span><span class="p">.</span><span class="nf">Gosched</span><span class="p">()</span><span class="c1">//交出时间片给协程
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">c</span> <span class="p">&gt;</span> <span class="mi">10</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>使用<code>sync/atomic</code>执行原子操作</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// good
</span><span class="c1"></span><span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;sync&#34;</span>
	<span class="s">&#34;sync/atomic&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">type</span> <span class="nx">Map</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
	<span class="kd">var</span> <span class="nx">m</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">Value</span>
	<span class="nx">m</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nb">make</span><span class="p">(</span><span class="nx">Map</span><span class="p">))</span>
	<span class="kd">var</span> <span class="nx">mu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// used only by writers
</span><span class="c1"></span>	<span class="nx">read</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">val</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">m1</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Load</span><span class="p">().(</span><span class="nx">Map</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">m1</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
	<span class="p">}</span>
	<span class="nx">insert</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span> <span class="c1">// 与潜在写入同步
</span><span class="c1"></span>		<span class="k">defer</span> <span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
		<span class="nx">m1</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">.</span><span class="nf">Load</span><span class="p">().(</span><span class="nx">Map</span><span class="p">)</span> <span class="c1">// 导入struct当前数据
</span><span class="c1"></span>		<span class="nx">m2</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Map</span><span class="p">)</span>      <span class="c1">// 创建新值
</span><span class="c1"></span>		<span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m1</span> <span class="p">{</span>
			<span class="nx">m2</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span>
		<span class="p">}</span>
		<span class="nx">m2</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">=</span> <span class="nx">val</span>
		<span class="nx">m</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">m2</span><span class="p">)</span>   <span class="c1">// 用新的替代当前对象
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">read</span><span class="p">,</span> <span class="nx">insert</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
