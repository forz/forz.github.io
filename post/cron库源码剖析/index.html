<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>cron库源码剖析 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="Forz" /><meta name="description" content="Cron表达式 基本cron格式: 1 2 3 4 5 6 7 8 # cron格式說明 # ┌──分鐘（0 - 59） # │ ┌──小時（0 - 23） # | │ ┌──日（1 - 31" /><meta name="keywords"
  content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.55.6 with theme even" />


<link rel="canonical" href="/post/cron%E5%BA%93%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="stylesheet" href="/css/search.css" />


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="cron库源码剖析" />
<meta property="og:description" content="Cron表达式 基本cron格式: 1 2 3 4 5 6 7 8 # cron格式說明 # ┌──分鐘（0 - 59） # │ ┌──小時（0 - 23） # | │ ┌──日（1 - 31" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/cron%E5%BA%93%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90/" />
<meta property="article:published_time" content="2019-10-15T11:19:03&#43;00:00"/>
<meta property="article:modified_time" content="2019-10-15T11:19:03&#43;00:00"/>

<meta itemprop="name" content="cron库源码剖析">
<meta itemprop="description" content="Cron表达式 基本cron格式: 1 2 3 4 5 6 7 8 # cron格式說明 # ┌──分鐘（0 - 59） # │ ┌──小時（0 - 23） # | │ ┌──日（1 - 31">


<meta itemprop="datePublished" content="2019-10-15T11:19:03&#43;00:00" />
<meta itemprop="dateModified" content="2019-10-15T11:19:03&#43;00:00" />
<meta itemprop="wordCount" content="5526">



<meta itemprop="keywords" content="cron," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="cron库源码剖析"/>
<meta name="twitter:description" content="Cron表达式 基本cron格式: 1 2 3 4 5 6 7 8 # cron格式說明 # ┌──分鐘（0 - 59） # │ ┌──小時（0 - 23） # | │ ┌──日（1 - 31"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="clearfix">
  <div class="logo-wrapper">
    <a href="/" class="logo">Forz Blog</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
    </ul>
  </nav>
</div>


<div class="search-container">
  <div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..."
        name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path
            d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>
<script>
    var client = algoliasearch("IAR2EF5L65", "b4b9da2eba53aa6dabe4b8ac9e8676e1");
    var index = client.initIndex('forz.forzvina.com');
    autocomplete('#aa-search-input',
        { hint: false }, {
        source: autocomplete.sources.hits(index, { hitsPerPage: 8 }),
        displayKey: 'name',
        templates: {
            suggestion: function (suggestion) {
                var reg = /([A-Z]+)/ig
                var title = suggestion.uri.replace(reg, function (m) {
                    return m.toLowerCase()
                })
                return '<span class="search-item">' + '<a href="\/' + title + '">' +
                    suggestion._highlightResult.title.value + '</a></span>';
            }
        }
    });
</script>
</div>


    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">cron库源码剖析</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-10-15 </span>
        <div class="post-category">
            <a href="/categories/cron/"> cron </a>
            </div>
          <span class="more-meta"> 约 5526 字 </span>
          <span class="more-meta"> 预计阅读 12 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#cron表达式">Cron表达式</a></li>
<li><a href="#代码使用">代码使用</a></li>
<li><a href="#设计思路">设计思路</a>
<ul>
<li><a href="#类型和接口">类型和接口</a>
<ul>
<li><a href="#cron">cron</a></li>
<li><a href="#entry">Entry</a></li>
<li><a href="#job">job</a></li>
<li><a href="#schedule">schedule</a></li>
</ul></li>
<li><a href="#cron-1">Cron</a>
<ul>
<li><a href="#实例化">实例化</a></li>
<li><a href="#解析">解析</a></li>
<li><a href="#成员方法">成员方法</a>
<ul>
<li><a href="#addfunc">AddFunc</a></li>
</ul></li>
</ul></li>
<li><a href="#调度分析">调度分析</a>
<ul>
<li><a href="#任务添加">任务添加</a></li>
<li><a href="#调度">调度</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="cron表达式">Cron表达式</h1>

<p>基本cron格式:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></pre></td>
<td class="lntd">
<pre class="chroma"># cron格式說明
# ┌──分鐘（0 - 59）
# │ ┌──小時（0 - 23）
# | │ ┌──日（1 - 31）
# | | | ┌─月（1 - 12）
# | | | | ┌─星期（0 - 7，星期日=0或7）
# | | | | |
# * * * * * 被執行的命令</pre></td></tr></table>
</div>
</div>
<p>注：</p>

<ol>
<li>在“星期域”（第五个域），0和7都被视为星期日。</li>
<li>不很直观的用法：如果日期和星期同时被设置，那么其中的一个条件被满足时，指令便会被运行。</li>
<li>前5个域称之分时日月周，可方便个人记忆。</li>
</ol>

<p>从第六个域起，指明要运行的命令。</p>

<p>特殊符号说明:</p>

<ul>
<li><p>星号(*)
表示 cron 表达式能匹配该字段的所有值。如在第5个字段使用星号(month)，表示每个月</p></li>

<li><p>斜线(/)
表示增长间隔，如第1个字段(minutes) 值是 3-59/15，表示每小时的第3分钟开始执行一次，之后每隔 15 分钟执行一次（即 3、18、33、48 这些时间点执行），这里也可以表示为：3/15</p></li>

<li><p>逗号(,)
用于枚举值，如第6个字段值是 MON,WED,FRI，表示 星期一、三、五 执行</p></li>

<li><p>连字号(-)
表示一个范围，如第3个字段的值为 9-17 表示 9am 到 5pm 直接每个小时（包括9和17）</p></li>

<li><p>问号(?)
只用于 日(Day of month) 和 星期(Day of week)，表示不指定值，可以用于代替 *</p></li>
</ul>

<p>总结:</p>

<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20191015162749.png" alt="" /></p>

<p>预定义模式:</p>

<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20191015163251.jpg" alt="" /></p>

<p>举例:</p>

<p>每分钟执行一次命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">* * * * * yourCommand</pre></td></tr></table>
</div>
</div>
<p>每小时的第2和第10分钟执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">2,10 * * * * yourCommand</pre></td></tr></table>
</div>
</div>
<p>每天上午9点到12点的第2和第10分钟执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">2,10 9-12 * * * yourCommand</pre></td></tr></table>
</div>
</div>
<p>每隔两天的上午9点到12点的第2和第10分钟执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">2,10 9-12 */2 * * yourCommand</pre></td></tr></table>
</div>
</div>
<p>每周一上午9点到12点的第2和第10分钟执行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">2,10 9-12 * * 1 yourCommand</pre></td></tr></table>
</div>
</div>
<h1 id="代码使用">代码使用</h1>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;time&#34;</span>
    <span class="s">&#34;log&#34;</span>

    <span class="s">&#34;github.com/robfig/cron&#34;</span>

    <span class="s">&#34;github.com/EDDYCJY/go-gin-example/models&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Starting...&#34;</span><span class="p">)</span>

    <span class="nx">c</span> <span class="o">:=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;* * * * * *&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Run models.CleanAllTag...&#34;</span><span class="p">)</span>
        <span class="nx">models</span><span class="p">.</span><span class="nf">CleanAllTag</span><span class="p">()</span>
    <span class="p">})</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">AddFunc</span><span class="p">(</span><span class="s">&#34;* * * * * *&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Run models.CleanAllArticle...&#34;</span><span class="p">)</span>
        <span class="nx">models</span><span class="p">.</span><span class="nf">CleanAllArticle</span><span class="p">()</span>
    <span class="p">})</span>

    <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>

    <span class="nx">t1</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">t1</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
            <span class="nx">t1</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>在这段程序中，我们做了如下的事情</p>

<ol>
<li><p>cron.New()
会根据本地时间创建一个新（空白）的 Cron job runner</p></li>

<li><p>c.AddFunc()</p>

<p>AddFunc 会向 Cron job runner 添加一个 func ，以按给定的时间表运行.首先解析时间表，如果填写有问题会直接 err，无误则将 func 添加到 Schedule 队列中等待执行</p></li>

<li><p>c.Start()</p>

<p>在当前执行的程序中启动 Cron 调度程序。其实这里的主体是 goroutine + for + select + timer 的调度控制</p></li>
</ol>

<h1 id="设计思路">设计思路</h1>

<h2 id="类型和接口">类型和接口</h2>

<h3 id="cron">cron</h3>

<p>cron:包含一系列要执行的实体；支持暂停【stop】；添加实体等</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Cron keeps track of any number of entries, invoking the associated func as
</span><span class="c1">// specified by the schedule. It may be started, stopped, and the entries may
</span><span class="c1">// be inspected while running.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Cron</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">entries</span>   <span class="p">[]</span><span class="o">*</span><span class="nx">Entry</span>
	<span class="nx">chain</span>     <span class="nx">Chain</span>
	<span class="nx">stop</span>      <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span><span class="c1">// 控制 Cron 实例暂停
</span><span class="c1"></span>	<span class="nx">add</span>       <span class="kd">chan</span> <span class="o">*</span><span class="nx">Entry</span> <span class="c1">// 当 Cron 已经运行了，增加新的 Entity 是通过 add 这个 channel 实现的
</span><span class="c1"></span>	<span class="nx">remove</span>    <span class="kd">chan</span> <span class="nx">EntryID</span>
	<span class="nx">snapshot</span>  <span class="kd">chan</span> <span class="kd">chan</span> <span class="p">[]</span><span class="nx">Entry</span> <span class="c1">// 获取当前所有 entity 的快照
</span><span class="c1"></span>	<span class="nx">running</span>   <span class="kt">bool</span><span class="c1">// 当已经运行时为true；否则为false
</span><span class="c1"></span>	<span class="nx">logger</span>    <span class="nx">Logger</span>
	<span class="nx">runningMu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
	<span class="nx">location</span>  <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Location</span>
	<span class="nx">parser</span>    <span class="nx">Parser</span>
	<span class="nx">nextID</span>    <span class="nx">EntryID</span>
	<span class="nx">jobWaiter</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>注意:</p>

<ol>
<li>Cron 结构没有导出任何成员。</li>
<li>有一个成员 stop，类型是 struct{}，即空结构体。</li>
</ol>

<h3 id="entry">Entry</h3>

<p>Entry：调度实体</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Entry</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// The schedule on which this job should be run.
</span><span class="c1"></span>    <span class="c1">// 负责调度当前 Entity 中的 Job 执行
</span><span class="c1"></span>    <span class="nx">Schedule</span> <span class="nx">Schedule</span>
 
    <span class="c1">// The next time the job will run. This is the zero time if Cron has not been
</span><span class="c1"></span>    <span class="c1">// started or this entry&#39;s schedule is unsatisfiable
</span><span class="c1"></span>    <span class="c1">// Job 下一次执行的时间
</span><span class="c1"></span>    <span class="nx">Next</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
 
    <span class="c1">// The last time this job was run. This is the zero time if the job has never
</span><span class="c1"></span>    <span class="c1">// been run.
</span><span class="c1"></span>    <span class="c1">// 上一次执行时间
</span><span class="c1"></span>    <span class="nx">Prev</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
 
    <span class="c1">// The Job to run.
</span><span class="c1"></span>    <span class="c1">// 要执行的 Job
</span><span class="c1"></span>    <span class="nx">Job</span> <span class="nx">Job</span>
<span class="p">}</span>

<span class="c1">// Entry consists of a schedule and the func to execute on that schedule.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Entry</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// ID is the cron-assigned ID of this entry, which may be used to look up a
</span><span class="c1"></span>	<span class="c1">// snapshot or remove it.
</span><span class="c1"></span>	<span class="nx">ID</span> <span class="nx">EntryID</span>
    <span class="c1">//负责调度当前 Entity 中的 Job 执行
</span><span class="c1"></span>	<span class="c1">// Schedule on which this job should be run.
</span><span class="c1"></span>	<span class="nx">Schedule</span> <span class="nx">Schedule</span>
    <span class="c1">// Job 下一次执行的时间
</span><span class="c1"></span>	<span class="c1">// Next time the job will run, or the zero time if Cron has not been
</span><span class="c1"></span>	<span class="c1">// started or this entry&#39;s schedule is unsatisfiable
</span><span class="c1"></span>	<span class="nx">Next</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
    <span class="c1">// 上一次执行时间
</span><span class="c1"></span>	<span class="c1">// Prev is the last time this job was run, or the zero time if never.
</span><span class="c1"></span>	<span class="nx">Prev</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>

	<span class="c1">// WrappedJob is the thing to run when the Schedule is activated.
</span><span class="c1"></span>	<span class="nx">WrappedJob</span> <span class="nx">Job</span>
    <span class="c1">// 要执行的 Job
</span><span class="c1"></span>	<span class="c1">// Job is the thing that was submitted to cron.
</span><span class="c1"></span>	<span class="c1">// It is kept around so that user code that needs to get at the job later,
</span><span class="c1"></span>	<span class="c1">// e.g. via Entries() can do so.
</span><span class="c1"></span>	<span class="nx">Job</span> <span class="nx">Job</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="job">job</h3>

<p>Job：每一个实体包含一个需要运行的Job</p>

<p>这是一个接口，只有一个方法：run</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Job</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Run</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>由于 Entity 中需要 Job 类型，因此，我们希望定期运行的任务，就需要实现 Job 接口。同时，由于
Job接口只有一个无参数无返回值的方法，为了使用方便，作者提供了一个类型：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// A wrapper that turns a func() into a cron.Job
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">FuncJob</span> <span class="kd">func</span><span class="p">()</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">FuncJob</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span> <span class="nf">f</span><span class="p">()</span> <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>它通过简单的实现 Run() 方法来实现 Job 接口,这样，任何无参数无返回值的函数，通过强制类型转换为 FuncJob，就可以当作 Job 来使用了，AddFunc 方法 就是这么做的。所以需要修改带参数功能的job时从此处下手</p>

<h3 id="schedule">schedule</h3>

<p>Schedule：每个实体包含一个调度器（Schedule）</p>

<p>负责调度 Job 的执行。它也是一个接口。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// The Schedule describes a job&#39;s duty cycle.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Schedule</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Return the next activation time, later than the given time.
</span><span class="c1"></span>    <span class="c1">// Next is invoked initially, and then each time the job is run.
</span><span class="c1"></span>    <span class="c1">// 返回同一 Entity 中的 Job 下一次执行的时间
</span><span class="c1"></span>	<span class="nf">Next</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Schedule 的具体实现通过解析 Cron 表达式得到。</p>

<p>库中提供了 Schedule 的两个具体实现，分别是 SpecSchedule 和 ConstantDelaySchedule。</p>

<p>SpecSchedule</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SpecSchedule specifies a duty cycle (to the second granularity), based on a
</span><span class="c1">// traditional crontab specification. It is computed initially and stored as bit sets.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SpecSchedule</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Second</span><span class="p">,</span> <span class="nx">Minute</span><span class="p">,</span> <span class="nx">Hour</span><span class="p">,</span> <span class="nx">Dom</span><span class="p">,</span> <span class="nx">Month</span><span class="p">,</span> <span class="nx">Dow</span> <span class="kt">uint64</span>

	<span class="c1">// Override location for this schedule.
</span><span class="c1"></span>	<span class="nx">Location</span> <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Location</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>从开始介绍的 Cron 表达式可以容易得知各个字段的意思，同时，对各种表达式的解析也会最终得到一个 SpecSchedule 的实例。库中的 Parse 返回的其实就是 SpecSchedule 的实例（当然也就实现了 Schedule 接口）。</p>

<p>ConstantDelaySchedule</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ConstantDelaySchedule represents a simple recurring duty cycle, e.g. &#34;Every 5 minutes&#34;.
</span><span class="c1">// It does not support jobs more frequent than once a second.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ConstantDelaySchedule</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Delay</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这是一个简单的循环调度器，如：每 5 分钟。注意，最小单位是秒，不能比秒还小，比如 毫秒。
通过 Every 函数可以获取该类型的实例，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">constDelaySchedule</span> <span class="o">:=</span> <span class="nf">Every</span><span class="p">(</span><span class="mf">5e9</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>得到的是一个每 5 秒执行一次的调度器。</p>

<h2 id="cron-1">Cron</h2>

<h3 id="实例化">实例化</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">opts</span> <span class="o">...</span><span class="nx">Option</span><span class="p">)</span> <span class="o">*</span><span class="nx">Cron</span> <span class="p">{</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Cron</span><span class="p">{</span>
		<span class="nx">entries</span><span class="p">:</span>   <span class="kc">nil</span><span class="p">,</span>
		<span class="nx">chain</span><span class="p">:</span>     <span class="nf">NewChain</span><span class="p">(),</span>
		<span class="nx">add</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="o">*</span><span class="nx">Entry</span><span class="p">),</span>
		<span class="nx">stop</span><span class="p">:</span>      <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
		<span class="nx">snapshot</span><span class="p">:</span>  <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">chan</span> <span class="p">[]</span><span class="nx">Entry</span><span class="p">),</span>
		<span class="nx">remove</span><span class="p">:</span>    <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">EntryID</span><span class="p">),</span>
		<span class="nx">running</span><span class="p">:</span>   <span class="kc">false</span><span class="p">,</span>
		<span class="nx">runningMu</span><span class="p">:</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span><span class="p">{},</span>
		<span class="nx">logger</span><span class="p">:</span>    <span class="nx">DefaultLogger</span><span class="p">,</span>
		<span class="nx">location</span><span class="p">:</span>  <span class="nx">time</span><span class="p">.</span><span class="nx">Local</span><span class="p">,</span>
		<span class="nx">parser</span><span class="p">:</span>    <span class="nx">standardParser</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">opt</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
		<span class="nf">opt</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span>

<span class="c1">// Option represents a modification to the default behavior of a Cron.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Option</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Cron</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>可见实例化时，成员使用的基本是默认值；</p>

<h3 id="解析">解析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Parse</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">_</span> <span class="nx">Schedule</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>spec 可以是:
* Full crontab specs, e.g. “* * * * * ?”
* Descriptors, e.g. “@midnight”, “@every 1h30m”</p>

<h3 id="成员方法">成员方法</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 将 job 加入 Cron 中
</span><span class="c1">// 如上所述，该方法只是简单的通过 FuncJob 类型强制转换 cmd，然后调用 AddJob 方法
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">AddFunc</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cmd</span> <span class="kd">func</span><span class="p">())</span> <span class="kt">error</span>
 
<span class="c1">// 将 job 加入 Cron 中
</span><span class="c1">// 通过 Parse 函数解析 cron 表达式 spec 的到调度器实例(Schedule)，之后调用 c.Schedule 方法
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cmd</span> <span class="nx">Job</span><span class="p">)</span> <span class="kt">error</span>
 
<span class="c1">// 获取当前 Cron 总所有 Entities 的快照
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">Entries</span><span class="p">()</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Entry</span>
 
<span class="c1">// 通过两个参数实例化一个 Entity，然后加入当前 Cron 中
</span><span class="c1">// 注意：如果当前 Cron 未运行，则直接将该 entity 加入 Cron 中；
</span><span class="c1">// 否则，通过 add 这个成员 channel 将 entity 加入正在运行的 Cron 中
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">Schedule</span><span class="p">(</span><span class="nx">schedule</span> <span class="nx">Schedule</span><span class="p">,</span> <span class="nx">cmd</span> <span class="nx">Job</span><span class="p">)</span>
 
<span class="c1">// 新启动一个 goroutine 运行当前 Cron
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span>
 
<span class="c1">// 通过给 stop 成员发送一个 struct{}{} 来停止当前 Cron，同时将 running 置为 false
</span><span class="c1">// 从这里知道，stop 只是通知 Cron 停止，因此往 channel 发一个值即可，而不关心值是多少
</span><span class="c1">// 所以，成员 stop 定义为空 struct
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">Stop</span><span class="p">()</span></code></pre></td></tr></table>
</div>
</div>
<h4 id="addfunc">AddFunc</h4>

<p>从AddFunc函数说起带参数任务的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// AddFunc adds a func to the Cron to be run on the given schedule.
</span><span class="c1">// The spec is parsed using the time zone of this Cron instance as the default.
</span><span class="c1">// An opaque ID is returned that can be used to later remove it.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">AddFunc</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cmd</span> <span class="kd">func</span><span class="p">())</span> <span class="p">(</span><span class="nx">EntryID</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nf">FuncJob</span><span class="p">(</span><span class="nx">cmd</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// AddJob adds a Job to the Cron to be run on the given schedule.
</span><span class="c1">// The spec is parsed using the time zone of this Cron instance as the default.
</span><span class="c1">// An opaque ID is returned that can be used to later remove it.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cmd</span> <span class="nx">Job</span><span class="p">)</span> <span class="p">(</span><span class="nx">EntryID</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">schedule</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">parser</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Schedule</span><span class="p">(</span><span class="nx">schedule</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>AddFunc 含有两个参数，第一个是 cron表达式，这个不解释，第二个是func()类型参数cmd 即无参数无返回类型函数，下一步中直接将此参数强制转换为FuncJob类型，并调用AddJob函数</p>

<p>FuncJob类型:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// FuncJob is a wrapper that turns a func() into a cron.Job
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">FuncJob</span> <span class="kd">func</span><span class="p">()</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">FuncJob</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span> <span class="nf">f</span><span class="p">()</span> <span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>由上述代码可知FuncJob为自定义类型，真实类型为 func()，此类型实现了一个Run()方法</p>

<p>AddJob 函数:</p>

<p>首先 AddJob 函数的传入参数为一个string类型的cron表达式和一个Job类型的cmd参数，但在AddFunc函数中，我们传入的第二个参数为FuncJob类型，所以Job类型应该是一个接口，在解析了cron表达式无错误以后，调用Schedule方法将cmd添加进了调度器</p>

<p>Job 类型:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Job is an interface for submitted cron jobs.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Job</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="nf">Run</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>由此可知，Job是带有一个Run方法的接口类型，经过代码分析可以指定，cron定时调度时间到达时，将调用此方法，也就是意味着，任何实现了Run方法的实例，都可以作为AddJob函数的cmd参数，而Run方法所实现的内容就是你定时调度所需执行的任务(AddFunc函数只能添加无参数无返回的任务，太鸡肋了)，接下来我们就来实现一个带参数的任务添加</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//定义一个类型 包含一个int类型参数和函数体
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">funcIntJob</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">num</span>   <span class="kt">int</span>
    <span class="nx">function</span> <span class="kd">func</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
<span class="p">}</span>
 
<span class="c1">//实现这个类型的Run()方法 使得可以传入Job接口
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">this</span> <span class="o">*</span><span class="nx">funcIntJob</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="kc">nil</span> <span class="o">!=</span> <span class="nx">this</span><span class="p">.</span><span class="nx">function</span> <span class="p">{</span>
        <span class="nx">this</span><span class="p">.</span><span class="nf">function</span><span class="p">(</span><span class="nx">this</span><span class="p">.</span><span class="nx">num</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1">//非必须  返回一个urlServeJob指针
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">newfuncIntJob</span><span class="p">(</span><span class="nx">num</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">function</span> <span class="nx">funcInt</span><span class="p">)</span> <span class="o">*</span><span class="nx">urlServeJob</span> <span class="p">{</span>
    <span class="nx">instance</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">funcIntJob</span><span class="p">{</span>
        <span class="nx">num</span><span class="p">:</span>   <span class="nx">num</span><span class="p">,</span>
        <span class="nx">function</span><span class="p">:</span> <span class="nx">function</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">instance</span>
<span class="p">}</span>
 
<span class="c1">//示例任务
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">shownum</span><span class="p">(</span><span class="nx">num</span> <span class="kt">int</span><span class="p">){</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span>
<span class="p">}</span>
 
<span class="kd">func</span> <span class="nf">main</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="p">=</span> <span class="nx">cron</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
  <span class="nx">job</span> <span class="o">:=</span> <span class="nf">newfuncIntJob</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nx">shownum</span><span class="p">)</span>
  <span class="nx">spec</span> <span class="o">:=</span> <span class="s">&#34;*/5 * * * * ?&#34;</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">job</span><span class="p">)</span>
  <span class="nx">c</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
  <span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
  <span class="k">select</span><span class="p">{}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="调度分析">调度分析</h2>

<p>我们就以AddFunc函数的之后开始分析cron的调度</p>

<h3 id="任务添加">任务添加</h3>

<p>前面说到，AddFunc函数调用了AddJob函数，这里再看一次AddJob函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// AddJob adds a Job to the Cron to be run on the given schedule.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">AddJob</span><span class="p">(</span><span class="nx">spec</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">cmd</span> <span class="nx">Job</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">schedule</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Parse</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">Schedule</span><span class="p">(</span><span class="nx">schedule</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这里有两点值得注意，cron表达式解析后的schedule变量，以及Cron的Schedule方法
前面有说到Schedule类型也是一个接口，再看一眼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Schedule</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// Return the next activation time, later than the given time.
</span><span class="c1"></span>    <span class="c1">// Next is invoked initially, and then each time the job is run.
</span><span class="c1"></span>    <span class="nf">Next</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>接口只有一个方法Next，参数返回都是Time，应该是传入时间返回下次执行时间的一个方法.</p>

<p>总之，Parse函数在经过一系列复杂的解析之后，返回了一个SpecSchedule类型变量，就是长这样的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SpecSchedule specifies a duty cycle (to the second granularity), based on a
</span><span class="c1">// traditional crontab specification. It is computed initially and stored as bit sets.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SpecSchedule</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Second</span><span class="p">,</span> <span class="nx">Minute</span><span class="p">,</span> <span class="nx">Hour</span><span class="p">,</span> <span class="nx">Dom</span><span class="p">,</span> <span class="nx">Month</span><span class="p">,</span> <span class="nx">Dow</span> <span class="kt">uint64</span>

	<span class="c1">// Override location for this schedule.
</span><span class="c1"></span>	<span class="nx">Location</span> <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Location</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>接下来看Cron类型的Schedule方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Schedule adds a Job to the Cron to be run on the given schedule.
</span><span class="c1">// The job is wrapped with the configured Chain.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">Schedule</span><span class="p">(</span><span class="nx">schedule</span> <span class="nx">Schedule</span><span class="p">,</span> <span class="nx">cmd</span> <span class="nx">Job</span><span class="p">)</span> <span class="nx">EntryID</span> <span class="p">{</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">runningMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">runningMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">nextID</span><span class="o">++</span>
	<span class="nx">entry</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Entry</span><span class="p">{</span>
		<span class="nx">ID</span><span class="p">:</span>         <span class="nx">c</span><span class="p">.</span><span class="nx">nextID</span><span class="p">,</span>
		<span class="nx">Schedule</span><span class="p">:</span>   <span class="nx">schedule</span><span class="p">,</span>
		<span class="nx">WrappedJob</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">chain</span><span class="p">.</span><span class="nf">Then</span><span class="p">(</span><span class="nx">cmd</span><span class="p">),</span>
		<span class="nx">Job</span><span class="p">:</span>        <span class="nx">cmd</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">running</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">entries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">entries</span><span class="p">,</span> <span class="nx">entry</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">add</span> <span class="o">&lt;-</span> <span class="nx">entry</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">ID</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>这个比较好理解，根据schedule和cmd参数构建了一个Entry变量，并且将这个变量添加进Cron的entries中</p>

<p>只不过在没有运行的时候直接添加，运行的时候通过chan添加.</p>

<h3 id="调度">调度</h3>

<p>调度的开始实施是从Cron.Start()函数开始的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Start the cron scheduler in its own go-routine, or no-op if already started.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">runningMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">runningMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">running</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">running</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>东西很少，就是开了一个routine执行任务，这里cron还提供了一个使用当前routine执行的方法Run(),</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Run the cron scheduler, or no-op if already running.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">Run</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">runningMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">running</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">runningMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">running</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">runningMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">run</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>先不管这些，接下来重点到run()方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Run the scheduler. this is private just due to the need to synchronize
</span><span class="c1">// access to the &#39;running&#39; state variable.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cron</span><span class="p">)</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Figure out the next activation times for each entry.
</span><span class="c1"></span>    <span class="nx">now</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>  <span class="c1">//以当前时区的方式获取当前时间
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">entry</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">entries</span> <span class="p">{</span>  
        <span class="nx">entry</span><span class="p">.</span><span class="nx">Next</span> <span class="p">=</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Schedule</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span> <span class="c1">//得到entries中的每一个entry更新下一次执行时间
</span><span class="c1"></span>    <span class="p">}</span>
 
    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">// Determine the next entry to run.
</span><span class="c1"></span>        <span class="nx">sort</span><span class="p">.</span><span class="nf">Sort</span><span class="p">(</span><span class="nf">byTime</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">entries</span><span class="p">))</span>  <span class="c1">//排序  得到最先要执行的entry
</span><span class="c1"></span> 
        <span class="kd">var</span> <span class="nx">timer</span> <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Timer</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">entries</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">c</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Next</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
            <span class="c1">// If there are no entries yet, just sleep - it still handles new entries
</span><span class="c1"></span>            <span class="c1">// and stop requests.
</span><span class="c1"></span>            <span class="nx">timer</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="mi">100000</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">timer</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Next</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">now</span><span class="p">))</span>  <span class="c1">//时间最近要执行Entry到现在的时间差 下面唤醒select
</span><span class="c1"></span>        <span class="p">}</span>
 
        <span class="k">for</span> <span class="p">{</span>   <span class="c1">//这个for有什么用？？？
</span><span class="c1"></span>            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">now</span> <span class="p">=</span> <span class="o">&lt;-</span><span class="nx">timer</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>      <span class="c1">//时间到  执行任务
</span><span class="c1"></span>                <span class="nx">now</span> <span class="p">=</span> <span class="nx">now</span><span class="p">.</span><span class="nf">In</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">location</span><span class="p">)</span>   <span class="c1">//更新时间
</span><span class="c1"></span>                <span class="c1">// Run every entry whose next time was less than now
</span><span class="c1"></span>                <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">entries</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span><span class="p">.</span><span class="nf">IsZero</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">break</span>
                    <span class="p">}</span>
                    <span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">runWithRecovery</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">Job</span><span class="p">)</span>  <span class="c1">//执行任务
</span><span class="c1"></span>                    <span class="nx">e</span><span class="p">.</span><span class="nx">Prev</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span>
                    <span class="nx">e</span><span class="p">.</span><span class="nx">Next</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Schedule</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span>  <span class="c1">//下一个要执行的时间
</span><span class="c1"></span>                <span class="p">}</span>
 
            <span class="k">case</span> <span class="nx">newEntry</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">add</span><span class="p">:</span>    <span class="c1">//运行中添加Entry
</span><span class="c1"></span>                <span class="nx">timer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
                <span class="nx">now</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span>
                <span class="nx">newEntry</span><span class="p">.</span><span class="nx">Next</span> <span class="p">=</span> <span class="nx">newEntry</span><span class="p">.</span><span class="nx">Schedule</span><span class="p">.</span><span class="nf">Next</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span>
                <span class="nx">c</span><span class="p">.</span><span class="nx">entries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">entries</span><span class="p">,</span> <span class="nx">newEntry</span><span class="p">)</span>
 
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">snapshot</span><span class="p">:</span>   <span class="c1">// 快照
</span><span class="c1"></span>                <span class="nx">c</span><span class="p">.</span><span class="nx">snapshot</span> <span class="o">&lt;-</span> <span class="nx">c</span><span class="p">.</span><span class="nf">entrySnapshot</span><span class="p">()</span>
                <span class="k">continue</span>
 
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">stop</span><span class="p">:</span>   <span class="c1">//停止信号
</span><span class="c1"></span>                <span class="nx">timer</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="p">}</span>
 
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>entry.Schedule.Next(now)
这个函数主要调用了Schedule的Next方法，Schedule是一个接口，在前面我们知道，实际上在解析spec的时
候返回的变量是SpecSchedule类型，所以此处应该调用SpecSchedule的Next方法，这个方法就是上面说的
那个复杂不贴代码的方法,在网上找了个带注释的版本,反正就是得到这个entry下次执行的时间吧</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
func (s *SpecSchedule) Next(t time.Time) time.Time {
    // 秒级别的取整
    t = t.Add(1*time.Second - time.Duration(t.Nanosecond())*time.Nanosecond)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">// 判断一个字段是否被累加，如果是， 那么它的下一级别的字段需要归 0 。
added := false

//到未来的探寻不超过5年
yearLimit := t.Year() + 5
// 下一级别的字段累加到重置，需要重新累加上一级别的字段的时候的goto点
// 比如要找每个月的31号的时候， 4月是符合月份字段的规定的，但是4月的没有31号。 遍历尽4月的每一天后，只能请求重新累加月份。</pre></td></tr></table>
</div>
</div>
<p>WRAP:
    if t.Year() &gt; yearLimit {
        return time.Time{}
    }
    // 月
    for 1&lt;&lt;uint(t.Month())&amp;s.Month == 0 {
        // If we have to add a month, reset the other parts to 0.
        if !added {
            added = true
            // Otherwise, set the date at the beginning (since the current time is irrelevant).
            t = time.Date(t.Year(), t.Month(), 1, 0, 0, 0, 0, t.Location())
        }
        t = t.AddDate(0, 1, 0)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></pre></td>
<td class="lntd">
<pre class="chroma">    // Wrapped around.
    if t.Month() == time.January {
        goto WRAP
    }
}

// 天 ， 一次处理 天/月 和 天/周
for !dayMatches(s, t) {
    if !added {
        added = true
        t = time.Date(t.Year(), t.Month(), t.Day(), 0, 0, 0, 0, t.Location())
    }
    t = t.AddDate(0, 0, 1)

    if t.Day() == 1 {
        goto WRAP
    }
}
// 时
for 1&lt;&lt;uint(t.Hour())&amp;s.Hour == 0 {
    if !added {
        added = true
        t = t.Truncate(time.Hour)
    }
    t = t.Add(1 * time.Hour)

    if t.Hour() == 0 {
        goto WRAP
    }
}
// 分
for 1&lt;&lt;uint(t.Minute())&amp;s.Minute == 0 {
    if !added {
        added = true
        t = t.Truncate(time.Minute)
    }
    t = t.Add(1 * time.Minute)

    if t.Minute() == 0 {
        goto WRAP
    }
}
// 秒
for 1&lt;&lt;uint(t.Second())&amp;s.Second == 0 {
    if !added {
        added = true
        t = t.Truncate(time.Second)
    }
    t = t.Add(1 * time.Second)

    if t.Second() == 0 {
        goto WRAP
    }
}

return t</pre></td></tr></table>
</div>
</div>
<p>}
//一次处理 天/月 和 天/周 。 如果两者中有任意， 那么必须同时符合另一个才算是匹配
func dayMatches(s *SpecSchedule, t time.Time) bool {
    var (
        domMatch bool = 1&lt;<uint(t.Day())&s.Dom > 0
        dowMatch bool = 1&lt;<uint(t.Weekday())&s.Dow > 0
    )</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">if s.Dom&amp;starBit &gt; 0 || s.Dow&amp;starBit &gt; 0 {
    return domMatch &amp;&amp; dowMatch
}
return domMatch || dowMatch</pre></td></tr></table>
</div>
</div>
<p>}</p>

<p>初学者的摸爬滚打，对标准库还是太不了解了，如有错误，敬请指正</p>

<p>参考:<a href="https://segmentfault.com/a/1190000014666453">https://segmentfault.com/a/1190000014666453</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-10-15
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/cron/">cron</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/groupcache%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/">
            <span class="next-text nav-default">Groupcache的一致性哈希算法</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Forz</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
