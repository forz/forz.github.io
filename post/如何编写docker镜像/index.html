<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>如何编写Docker镜像 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="Forz" /><meta name="description" content="优化基础镜像 优化基础镜像的方法就是选用合适的更小的基础镜像，常用的 Linux 系统镜像一般有 Ubuntu、CentOs、Alpine，其中Alpine" /><meta name="keywords"
  content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.84.1 with theme even" />


<link rel="canonical" href="/post/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99docker%E9%95%9C%E5%83%8F/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="stylesheet" href="/css/search.css" />


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="如何编写Docker镜像" />
<meta property="og:description" content="优化基础镜像 优化基础镜像的方法就是选用合适的更小的基础镜像，常用的 Linux 系统镜像一般有 Ubuntu、CentOs、Alpine，其中Alpine" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99docker%E9%95%9C%E5%83%8F/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-03-13T21:59:49&#43;00:00" />
<meta property="article:modified_time" content="2021-03-13T21:59:49&#43;00:00" />

<meta itemprop="name" content="如何编写Docker镜像">
<meta itemprop="description" content="优化基础镜像 优化基础镜像的方法就是选用合适的更小的基础镜像，常用的 Linux 系统镜像一般有 Ubuntu、CentOs、Alpine，其中Alpine"><meta itemprop="datePublished" content="2021-03-13T21:59:49&#43;00:00" />
<meta itemprop="dateModified" content="2021-03-13T21:59:49&#43;00:00" />
<meta itemprop="wordCount" content="6191">
<meta itemprop="keywords" content="Docker," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何编写Docker镜像"/>
<meta name="twitter:description" content="优化基础镜像 优化基础镜像的方法就是选用合适的更小的基础镜像，常用的 Linux 系统镜像一般有 Ubuntu、CentOs、Alpine，其中Alpine"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="clearfix">
  <div class="logo-wrapper">
    <a href="/" class="logo">Forz Blog</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
    </ul>
  </nav>
</div>


<div class="search-container">
  <div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..."
        name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path
            d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>
<script>
    var client = algoliasearch("IAR2EF5L65", "b4b9da2eba53aa6dabe4b8ac9e8676e1");
    var index = client.initIndex('forz.forzvina.com');
    autocomplete('#aa-search-input',
        { hint: false }, {
        source: autocomplete.sources.hits(index, { hitsPerPage: 8 }),
        displayKey: 'name',
        templates: {
            suggestion: function (suggestion) {
                var reg = /([A-Z]+)/ig
                var title = suggestion.uri.replace(reg, function (m) {
                    return m.toLowerCase()
                })
                return '<span class="search-item">' + '<a href="\/' + title + '">' +
                    suggestion._highlightResult.title.value + '</a></span>';
            }
        }
    });
</script>
</div>


    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">如何编写Docker镜像</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-03-13 </span>
        <div class="post-category">
            <a href="/categories/docker/"> Docker </a>
            </div>
          <span class="more-meta"> 约 6191 字 </span>
          <span class="more-meta"> 预计阅读 13 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#优化基础镜像">优化基础镜像</a>
      <ul>
        <li><a href="#scratch镜像">scratch镜像</a></li>
        <li><a href="#busybox镜像">busybox镜像</a></li>
      </ul>
    </li>
    <li><a href="#串联-dockerfile-指令">串联 Dockerfile 指令</a></li>
    <li><a href="#使用多阶段构建">使用多阶段构建</a></li>
    <li><a href="#构建业务服务镜像技巧">构建业务服务镜像技巧</a></li>
    <li><a href="#其他优化办法">其他优化办法</a>
      <ul>
        <li><a href="#1-run命令中执行aptapk或者yum类工具技巧">1. RUN命令中执行apt、apk或者yum类工具技巧</a></li>
        <li><a href="#2-压缩镜像">2. 压缩镜像</a></li>
      </ul>
    </li>
    <li><a href="#利用分层机制减小镜像传输大小">利用分层机制，减小镜像传输大小</a></li>
    <li><a href="#避免使用进程管理程序保证应用健康运行">避免使用进程管理程序，保证应用健康运行</a></li>
    <li><a href="#减少构建时间">减少构建时间</a>
      <ul>
        <li><a href="#构建顺序影响缓存的利用率">构建顺序影响缓存的利用率</a></li>
        <li><a href="#只拷贝需要的文件防止缓存溢出">只拷贝需要的文件，防止缓存溢出</a></li>
        <li><a href="#最小化可缓存的执行层">最小化可缓存的执行层</a></li>
      </ul>
    </li>
    <li><a href="#减小镜像体积">减小镜像体积</a>
      <ul>
        <li><a href="#删除不必要依赖">删除不必要依赖</a></li>
        <li><a href="#删除包管理工具的缓存">删除包管理工具的缓存</a></li>
      </ul>
    </li>
    <li><a href="#可维护性">可维护性</a>
      <ul>
        <li><a href="#尽量使用官方镜像">尽量使用官方镜像</a></li>
        <li><a href="#使用更具体的标签">使用更具体的标签</a></li>
        <li><a href="#使用体积最小的基础镜像">使用体积最小的基础镜像</a></li>
      </ul>
    </li>
    <li><a href="#重复利用">重复利用</a>
      <ul>
        <li><a href="#在一致的环境中从源代码构建">在一致的环境中从源代码构建</a></li>
        <li><a href="#在单独的步骤中获取依赖项">在单独的步骤中获取依赖项</a></li>
        <li><a href="#使用多阶段构建来删除构建时的依赖项">使用多阶段构建来删除构建时的依赖项</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="优化基础镜像">优化基础镜像</h2>
<p>优化基础镜像的方法就是选用合适的更小的基础镜像，常用的 Linux 系统镜像一般有 Ubuntu、CentOs、Alpine，其中Alpine更推荐使用。大小对比如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">lynzabo</span><span class="o">@</span><span class="n">ubuntu</span> <span class="o">~/</span><span class="n">s</span><span class="o">&gt;</span> <span class="n">docker</span> <span class="n">images</span>
<span class="n">REPOSITORY</span>         <span class="n">TAG</span>             <span class="n">IMAGE</span> <span class="n">ID</span>            <span class="n">CREATED</span>             <span class="n">SIZE</span>
<span class="n">ubuntu</span>             <span class="n">latest</span>        <span class="m">74</span><span class="n">f8760a2a8b</span>        <span class="m">8</span> <span class="n">days</span> <span class="n">ago</span>          <span class="m">82.4</span><span class="n">MB</span>
<span class="n">alpine</span>             <span class="n">latest</span>        <span class="m">11</span><span class="n">cd0b38bc3c</span>        <span class="m">2</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="m">4.41</span><span class="n">MB</span>
<span class="n">centos</span>               <span class="m">7</span>           <span class="m">49</span><span class="n">f7960eb7e4</span>        <span class="m">7</span> <span class="n">weeks</span> <span class="n">ago</span>         <span class="m">200</span><span class="n">MB</span>
<span class="n">debian</span>             <span class="n">latest</span>        <span class="m">3</span><span class="n">bbb526d2608</span>        <span class="m">8</span> <span class="n">days</span> <span class="n">ago</span>          <span class="m">101</span><span class="n">MB</span>
<span class="n">lynzabo</span><span class="o">@</span><span class="n">ubuntu</span> <span class="o">~/</span><span class="n">s</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>Alpine是一个高度精简又包含了基本工具的轻量级Linux发行版，基础镜像只有4.41M，各开发语言和框架都有基于Alpine制作的基础镜像，强烈推荐使用它。</p>
<p>查看上面的镜像尺寸对比结果，你会发现最小的镜像也有4.41M，那么有办法构建更小的镜像吗？答案是肯定的，例如 gcr.io/google_containers/pause-amd64:3.1 镜像仅有742KB。为什么这个镜像能这么小？在为大家解密之前，再推荐两个基础镜像：</p>
<h3 id="scratch镜像">scratch镜像</h3>
<p>scratch是一个空镜像，只能用于构建其他镜像，比如你要运行一个包含所有依赖的二进制文件，如Golang程序，可以直接使用scratch作为基础镜像。现在给大家展示一下上文提到的Google pause镜像Dockerfile：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">FROM</span> <span class="n">scratch</span>
<span class="n">ARG</span> <span class="n">ARCH</span>
<span class="n">ADD</span> <span class="n">bin</span><span class="o">/</span><span class="n">pause</span><span class="o">-$</span><span class="p">{</span><span class="n">ARCH</span><span class="p">}</span> <span class="o">/</span><span class="n">pause</span>
<span class="n">ENTRYPOINT</span> <span class="n">[</span><span class="s">&#34;/pause&#34;</span><span class="n">]</span>
</code></pre></td></tr></table>
</div>
</div><p>Google pause镜像使用了scratch作为基础镜像，这个镜像本身是不占空间的，使用它构建的镜像大小几乎和二进制文件本身一样大，所以镜像非常小。当然在我们的Golang程序中也会使用。对于一些Golang/C程序，可能会依赖一些动态库，你可以使用自动提取动态库工具，比如ldd、linuxdeployqt等提取所有动态库，然后将二进制文件和依赖动态库一起打包到镜像中。</p>
<h3 id="busybox镜像">busybox镜像</h3>
<p>scratch是个空镜像，如果希望镜像里可以包含一些常用的Linux工具，busybox镜像是个不错选择，镜像本身只有1.16M，非常便于构建小镜像。</p>
<h2 id="串联-dockerfile-指令">串联 Dockerfile 指令</h2>
<p>大家在定义Dockerfile时，如果太多的使用RUN指令，经常会导致镜像有特别多的层，镜像很臃肿，而且甚至会碰到超出最大层数（127层）限制的问题，遵循 Dockerfile 最佳实践，我们应该把多个命令串联合并为一个 RUN（通过运算符&amp;&amp;和/ 来实现），每一个 RUN 要精心设计，确保安装构建最后进行清理，这样才可以降低镜像体积，以及最大化的利用构建缓存。</p>
<p>下面是一个优化前Dockerfile：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">FROM</span> <span class="n">ubuntu</span>

<span class="n">ENV</span> <span class="n">VER</span>     <span class="m">3.0.0</span>
<span class="n">ENV</span> <span class="n">TARBALL</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="n">download.redis.io</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">redis</span><span class="o">-$</span><span class="n">VER.tar.gz</span><span class="o">&gt;</span>

<span class="c1"># ==&gt; Install curl and helper tools</span>

<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span>  <span class="n">curl</span> <span class="n">make</span> <span class="n">gcc</span>

<span class="c1"># ==&gt; Download, compile, and install</span>

<span class="n">RUN</span> <span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="o">$</span><span class="n">TARBALL</span> <span class="o">|</span> <span class="n">tar</span> <span class="n">zxv</span>
<span class="n">WORKDIR</span>  <span class="n">redis</span><span class="o">-$</span><span class="n">VER</span>
<span class="n">RUN</span> <span class="n">make</span>
<span class="n">RUN</span> <span class="n">make</span> <span class="n">install</span>

<span class="c1">#</span>

<span class="c1"># ==&gt; Clean up</span>

<span class="n">WORKDIR</span> <span class="o">/</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">auto</span><span class="o">-</span><span class="n">remove</span> <span class="n">curl</span> <span class="n">make</span> <span class="n">gcc</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">clean</span>
<span class="n">RUN</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span><span class="o">/*</span>  <span class="o">/</span><span class="n">redis</span><span class="o">-$</span><span class="n">VER</span>

<span class="c1">#</span>

<span class="n">CMD</span> <span class="n">[</span><span class="s">&#34;redis-server&#34;</span><span class="n">]</span>
</code></pre></td></tr></table>
</div>
</div><p>构建镜像，名称叫 test/test:0.1。</p>
<p>我们对Dockerfile做优化，优化后Dockerfile：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">FROM</span> <span class="n">ubuntu</span>

<span class="n">ENV</span> <span class="n">VER</span>     <span class="m">3.0.0</span>
<span class="n">ENV</span> <span class="n">TARBALL</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="n">download.redis.io</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">redis</span><span class="o">-$</span><span class="n">VER.tar.gz</span><span class="o">&gt;</span>

<span class="n">RUN</span> <span class="n">echo</span> <span class="s">&#34;==&gt; Install curl and helper tools...&#34;</span>  <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>                      <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span>  <span class="n">curl</span> <span class="n">make</span> <span class="n">gcc</span>   <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">echo</span> <span class="s">&#34;==&gt; Download, compile, and install...&#34;</span>  <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="o">$</span><span class="n">TARBALL</span> <span class="o">|</span> <span class="n">tar</span> <span class="n">zxv</span>  <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">cd</span> <span class="n">redis</span><span class="o">-$</span><span class="n">VER</span>               <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">make</span>                        <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">make</span> <span class="n">install</span>                <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">echo</span> <span class="s">&#34;==&gt; Clean up...&#34;</span>  <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">remove</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">auto</span><span class="o">-</span><span class="n">remove</span> <span class="n">curl</span> <span class="n">make</span> <span class="n">gcc</span>  <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">clean</span>                                  <span class="o">&amp;&amp;</span> <span class="n">\</span>
    <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span><span class="o">/*</span>  <span class="o">/</span><span class="n">redis</span><span class="o">-$</span><span class="n">VER</span>

<span class="c1">#</span>

<span class="n">CMD</span> <span class="n">[</span><span class="s">&#34;redis-server&#34;</span><span class="n">]</span>
</code></pre></td></tr></table>
</div>
</div><p>构建镜像，名称叫 test/test:0.2。</p>
<p>对比两个镜像大小：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">root</span><span class="o">@</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span><span class="o">:/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iops</span><span class="c1"># docker images</span>
<span class="n">REPOSITORY</span>       <span class="n">TAG</span>           <span class="n">IMAGE</span> <span class="n">ID</span>            <span class="n">CREATED</span>             <span class="n">SIZE</span>
<span class="n">test</span><span class="o">/</span><span class="n">test</span>        <span class="m">0.2</span>         <span class="m">58468</span><span class="n">c0222ed</span>        <span class="m">2</span> <span class="n">minutes</span> <span class="n">ago</span>       <span class="m">98.1</span><span class="n">MB</span>
<span class="n">test</span><span class="o">/</span><span class="n">test</span>        <span class="m">0.1</span>         <span class="n">e496cf7243f2</span>        <span class="m">6</span> <span class="n">minutes</span> <span class="n">ago</span>       <span class="m">307</span><span class="n">MB</span>
<span class="n">root</span><span class="o">@</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span><span class="o">:/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iops</span><span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div><p>可以看到，将多条RUN命令串联起来构建的镜像大小是每条命令分别RUN的三分之一。</p>
<p>提示：为了应对镜像中存在太多镜像层，Docker 1.13版本以后，提供了一个压扁镜像功能，即将 Dockerfile 中所有的操作压缩为一层。这个特性还处于实验阶段，Docker默认没有开启，如果要开启，需要在启动Docker时添加-experimental 选项，并在Docker build 构建镜像时候添加 &ndash;squash 。我们不推荐使用这个办法，请在撰写 Dockerfile 时遵循最佳实践编写，不要试图用这种办法去压缩镜像。</p>
<h2 id="使用多阶段构建">使用多阶段构建</h2>
<p>Dockerfile中每条指令都会为镜像增加一个镜像层，并且你需要在移动到下一个镜像层之前清理不需要的组件。实际上，有一个Dockerfile用于开发（其中包含构建应用程序所需的所有内容）以及一个用于生产的瘦客户端，它只包含你的应用程序以及运行它所需的内容。这被称为“建造者模式”。Docker 17.05.0-ce版本以后支持多阶段构建。使用多阶段构建，你可以在Dockerfile中使用多个FROM语句，每条FROM指令可以使用不同的基础镜像，这样您可以选择性地将服务组件从一个阶段COPY到另一个阶段，在最终镜像中只保留需要的内容。</p>
<p>下面是一个使用COPY &ndash;from 和 FROM &hellip; AS &hellip; 的Dockerfile：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="c1"># Compile</span>

<span class="n">FROM</span> <span class="n">golang</span><span class="o">:</span><span class="m">1.9.0</span> <span class="n">AS</span> <span class="n">builder</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">v9.git...com</span><span class="o">/</span><span class="kc">...</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">monitor</span>
<span class="n">COPY</span> <span class="n">. .</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">v9.git...com</span><span class="o">/</span><span class="kc">...</span><span class="o">/</span><span class="n">k8s</span><span class="o">-</span><span class="n">monitor</span>
<span class="n">RUN</span> <span class="n">make</span> <span class="n">build</span>
<span class="n">RUN</span> <span class="n">mv</span> <span class="n">k8s</span><span class="o">-</span><span class="n">monitor</span> <span class="o">/</span><span class="n">root</span>

<span class="c1"># Package</span>

<span class="c1"># Use scratch image</span>

<span class="n">FROM</span> <span class="n">scratch</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span>
<span class="n">COPY</span> <span class="o">--</span><span class="n">from</span><span class="o">=</span><span class="n">builder</span> <span class="o">/</span><span class="n">root</span> <span class="n">.
</span><span class="n">EXPOSE</span> <span class="m">8080</span>
<span class="n">CMD</span> <span class="n">[</span><span class="s">&#34;/root/k8s-monitor&#34;</span><span class="n">]</span>
</code></pre></td></tr></table>
</div>
</div><p>构建镜像，你会发现生成的镜像只有上面COPY 指令指定的内容，镜像大小只有2M。这样在以前使用两个Dockerfile（一个Dockerfile用于开发和一个用于生产的瘦客户端），现在使用多阶段构建就可以搞定。</p>
<h2 id="构建业务服务镜像技巧">构建业务服务镜像技巧</h2>
<p>Docker在build镜像的时候，如果某个命令相关的内容没有变化，会使用上一次缓存（cache）的文件层，在构建业务镜像的时候可以注意下面两点：</p>
<p>1、不变或者变化很少的体积较大的依赖库和经常修改的自有代码分开；</p>
<p>2、因为cache缓存在运行Docker build命令的本地机器上，建议固定使用某台机器来进行Docker build，以便利用cache。</p>
<p>下面是构建Spring Boot应用镜像的例子，用来说明如何分层。其他类型的应用，比如Java WAR包，Nodejs的npm 模块等，可以采取类似的方式。</p>
<p>1、在Dockerfile所在目录，解压缩maven生成的jar包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">unzip</span> <span class="o">&lt;</span><span class="n">path</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">jar</span><span class="o">&gt;</span><span class="n">.jar</span> <span class="o">-</span><span class="n">d</span> <span class="n">app</span>
</code></pre></td></tr></table>
</div>
</div><p>2、Dockerfile 我们把应用的内容分成4个部分COPY到镜像里面：其中前面3个基本不变，第4个是经常变化的自有代码。最后一行是解压缩后，启动spring boot应用的方式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">FROM</span> <span class="n">openjdk</span><span class="o">:</span><span class="m">8</span><span class="o">-</span><span class="n">jre</span><span class="o">-</span><span class="n">alpine</span>

<span class="n">LABEL</span> <span class="n">maintainer</span> <span class="s">&#34;opl-xws@xiaomi.com&#34;</span>
<span class="n">COPY</span> <span class="n">app</span><span class="o">/</span><span class="n">BOOT</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">BOOT</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span>
<span class="n">COPY</span> <span class="n">app</span><span class="o">/</span><span class="n">org</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">org</span>
<span class="n">COPY</span> <span class="n">app</span><span class="o">/</span><span class="n">META</span><span class="o">-</span><span class="n">INF</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">META</span><span class="o">-</span><span class="n">INF</span>
<span class="n">COPY</span> <span class="n">app</span><span class="o">/</span><span class="n">BOOT</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">classes</span> <span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">BOOT</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">classes</span>
<span class="n">EXPOSE</span> <span class="m">8080</span>
<span class="n">CMD</span> <span class="n">[</span><span class="s">&#34;/usr/bin/java&#34;</span><span class="p">,</span> <span class="s">&#34;-cp&#34;</span><span class="p">,</span> <span class="s">&#34;/app&#34;</span><span class="p">,</span> <span class="s">&#34;org.springframework.boot.loader.JarLauncher&#34;</span><span class="n">]</span>
</code></pre></td></tr></table>
</div>
</div><p>这样在构建镜像时候可大大提高构建速度。</p>
<h2 id="其他优化办法">其他优化办法</h2>
<p>当然，除了以上4类办法外，还有其他优化办法可以精简镜像；</p>
<h3 id="1-run命令中执行aptapk或者yum类工具技巧">1. RUN命令中执行apt、apk或者yum类工具技巧</h3>
<p>如果在RUN命令中执行apt、apk或者yum类工具，可以借助这些工具提供的一些小技巧来减少镜像层数量及镜像大小。举几个例子：</p>
<p>（1）在执行apt-get install -y 时增加选项— no-install-recommends ，可以不用安装建议性（非必须）的依赖，也可以在执行apk add 时添加选项&ndash;no-cache 达到同样效果；</p>
<p>（2）执行yum install -y 时候， 可以同时安装多个工具，比如yum install -y gcc gcc-c++ make &hellip;。将所有yum install 任务放在一条RUN命令上执行，从而减少镜像层的数量；</p>
<p>（3）组件的安装和清理要串联在一条指令里面，如 apk &ndash;update add php7 &amp;&amp; rm -rf /var/cache/apk/<em>，因为Dockerfile的每条指令都会产生一个文件层，如果将apk add &hellip;和 rm -rf &hellip; 命令分开，清理无法减小apk命令产生的文件层的大小。Ubuntu或Debian可以使用 rm -rf /<strong>var</strong>/lib/apt/lists/</em> 清理镜像中缓存文件；CentOS等系统使用yum clean all 命令清理。</p>
<h3 id="2-压缩镜像">2. 压缩镜像</h3>
<p>Docker 自带的一些命令还能协助压缩镜像，比如 export 和 import</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="n">test</span><span class="o">/</span><span class="n">test</span><span class="o">:</span><span class="m">0.2</span>
<span class="n">docker</span> <span class="n">export</span> <span class="m">747</span><span class="n">dc0e72d13</span> <span class="o">|</span> <span class="n">docker</span> <span class="n">import</span> <span class="o">-</span> <span class="n">test</span><span class="o">/</span><span class="n">test</span><span class="o">:</span><span class="m">0.3</span>
</code></pre></td></tr></table>
</div>
</div><p>使用这种方式需要先将容器运行起来，而且这个过程中会丢失镜像原有的一些信息，比如：导出端口，环境变量，默认指令。</p>
<p>查看这两个镜像history信息，如下，可以看到test/test:0.3 丢失了所有的镜像层信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">root</span><span class="o">@</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span><span class="o">:/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iops</span><span class="c1"># docker history test/test:0.3</span>
<span class="n">IMAGE</span>               <span class="n">CREATED</span>             <span class="n">CREATED</span> <span class="n">BY</span>          <span class="n">SIZE</span>                <span class="n">COMMENT</span>
<span class="m">6</span><span class="n">fb3f00b7a72</span>        <span class="m">15</span> <span class="n">seconds</span> <span class="n">ago</span>                          <span class="m">84.7</span><span class="n">MB</span>              <span class="n">Imported</span> <span class="n">from</span> <span class="o">-</span>
<span class="n">root</span><span class="o">@</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span><span class="o">:/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iops</span><span class="c1"># docker history test/test:0.2</span>
<span class="n">IMAGE</span>               <span class="n">CREATED</span>             <span class="n">CREATED</span> <span class="n">BY</span>                                      <span class="n">SIZE</span>                <span class="n">COMMENT</span>
<span class="m">58468</span><span class="n">c0222ed</span>        <span class="m">2</span> <span class="n">hours</span> <span class="n">ago</span>         <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="c1">#(nop)  CMD [&#34;redis-server&#34;]         0B</span>
<span class="m">1</span><span class="n">af7ffe3d163</span>        <span class="m">2</span> <span class="n">hours</span> <span class="n">ago</span>         <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="n">echo</span> <span class="s">&#34;==&gt; Install curl and helper…   15.7MB
</span><span class="s">8bac6e733d54        2 hours ago         /bin/sh -c #(nop)  ENV TARBALL=&lt;http://downlo&gt;…   0B
</span><span class="s">793282f3ef7a        2 hours ago         /bin/sh -c #(nop)  ENV VER=3.0.0                0B
</span><span class="s">74f8760a2a8b        8 days ago          /bin/sh -c #(nop)  CMD [&#34;</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="s">&#34;</span><span class="err">]            0B</span>
<span class="o">&lt;</span><span class="n">missing</span><span class="o">&gt;</span>           <span class="m">8</span> <span class="n">days</span> <span class="n">ago</span>          <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">systemd</span> <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="s">&#39;do…   7B
</span><span class="s">&lt;missing&gt;           8 days ago          /bin/sh -c sed -i &#39;</span><span class="n">s</span><span class="o">/</span><span class="n">^</span><span class="c1">#\s*\(deb.*universe\)$…   2.76kB</span>
<span class="o">&lt;</span><span class="n">missing</span><span class="o">&gt;</span>           <span class="m">8</span> <span class="n">days</span> <span class="n">ago</span>          <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span><span class="o">/*</span>          <span class="m">0</span><span class="n">B</span>
<span class="o">&lt;</span><span class="n">missing</span><span class="o">&gt;</span>           <span class="m">8</span> <span class="n">days</span> <span class="n">ago</span>          <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="n">set</span> <span class="o">-</span><span class="n">xe</span>   <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="s">&#39;#!/bin/sh&#39;</span> <span class="o">&gt;</span> <span class="o">/</span>…   <span class="m">745</span><span class="n">B</span>
<span class="o">&lt;</span><span class="n">missing</span><span class="o">&gt;</span>           <span class="m">8</span> <span class="n">days</span> <span class="n">ago</span>          <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="c1">#(nop) ADD file:5fabb77ea8d61e02d…   82.4MB</span>
<span class="n">root</span><span class="o">@</span><span class="n">k8s</span><span class="o">-</span><span class="n">master</span><span class="o">:/</span><span class="n">tmp</span><span class="o">/</span><span class="n">iops</span><span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div><p>社区里还有很多压缩工具，比如Docker-squash ，用起来更简单方便，并且不会丢失原有镜像的自带信息，大家有兴趣可以试试。</p>
<h2 id="利用分层机制减小镜像传输大小">利用分层机制，减小镜像传输大小</h2>
<p>利用分层机制，可以减小镜像传输大小，加快镜像的推送和拉取速度
Docker在build镜像的时候，如果某个命令相关的内容没有变化，会使用上一次缓存（cache）的文件层，在上传到镜像仓库时，这一层也就不需要上传了。
利用这一点，在添加应用的时候可以分层添加，具体操作如下：
（1）将不变或者变化很少的体积较大的依赖库和经常修改的自有代码分开
（2）因为cache缓存在运行Dockerbuild命令的本地机器上，建议固定使用某台机器来进行Docker build，以便利用cache（更多相关信息，可以参考 <a href="https://runnable.com/blog/distributing-docker-cache-across-hosts">https://runnable.com/blog/distributing-docker-cache-across-hosts</a> ）</p>
<p>举个例子：</p>
<p>在构建Spring Boot应用镜像，我们可以通过以下操作来进行分层。</p>
<p>Step1：在Dockerfile所在目录，解压缩maven生成的jar包</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-s" data-lang="s"><span class="n">unzip</span> <span class="o">&lt;</span><span class="n">path</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">app</span><span class="o">-</span><span class="n">jar</span><span class="o">&gt;</span><span class="n">.jar</span> <span class="o">-</span><span class="n">d</span> <span class="n">app</span>
</code></pre></td></tr></table>
</div>
</div><p>Step2: Dockerfile 我们把应用的内容分成4个部分COPY到镜像里面：其中前面3个基本不变，第4个是经常变化的自有代码。最后一行是解压缩后，启动spring boot应用的方式。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313222718.png" alt=""></p>
<p>其他类型的应用，比如Java WAR包，Nodejs的npm模块等，可以采取类似的方式。</p>
<h2 id="避免使用进程管理程序保证应用健康运行">避免使用进程管理程序，保证应用健康运行</h2>
<p>在应用的某个实例崩溃或者非正常退出时，很多进程管理程序并不退出，导致平台无法检测到应用已经不可用，进而无法重启应用。所以要避免使用这类进程管理程序来启动镜像。</p>
<h2 id="减少构建时间">减少构建时间</h2>
<p>一个开发周期包括构建 Docker 镜像，更改代码，然后重新构建 Docker 镜像。在构建镜像的过程中，如果能够利用缓存，可以减少不必要的重复构建步骤。</p>
<h3 id="构建顺序影响缓存的利用率">构建顺序影响缓存的利用率</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313222918.png" alt=""></p>
<p>镜像的构建顺序很重要，当你向 Dockerfile 中添加文件，或者修改其中的某一行时，那一部分的缓存就会失效，该缓存的后续步骤都会中断，需要重新构建。所以优化缓存的最佳方法是把不需要经常更改的行放到最前面，更改最频繁的行放到最后面。</p>
<h3 id="只拷贝需要的文件防止缓存溢出">只拷贝需要的文件，防止缓存溢出</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313223047.png" alt=""></p>
<p>当拷贝文件到镜像中时，尽量只拷贝需要的文件，切忌使用 COPY . 指令拷贝整个目录。如果被拷贝的文件内容发生了更改，缓存就会被破坏。在上面的示例中，镜像中只需要构建好的 jar 包，因此只需要拷贝这个文件就行了，这样即使其他不相关的文件发生了更改也不会影响缓存。</p>
<h3 id="最小化可缓存的执行层">最小化可缓存的执行层</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313223502.png" alt=""></p>
<p>每一个 RUN 指令都会被看作是可缓存的执行单元。太多的 RUN 指令会增加镜像的层数，增大镜像体积，而将所有的命令都放到同一个 RUN 指令中又会破坏缓存，从而延缓开发周期。当使用包管理器安装软件时，一般都会先更新软件索引信息，然后再安装软件。推荐将更新索引和安装软件放在同一个 RUN 指令中，这样可以形成一个可缓存的执行单元，否则你可能会安装旧的软件包。</p>
<h2 id="减小镜像体积">减小镜像体积</h2>
<p>镜像的体积很重要，因为镜像越小，部署的速度更快，攻击范围越小。</p>
<p>下面是精简Docker镜像尺寸的好处：</p>
<p>1、减少构建时间</p>
<p>2、减少磁盘使用量</p>
<p>3、减少下载时间</p>
<p>4、因为包含文件少，攻击面减小，提高了安全性</p>
<p>5、提高部署速度</p>
<h3 id="删除不必要依赖">删除不必要依赖</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313223647.png" alt=""></p>
<p>删除不必要的依赖，不要安装调试工具。如果实在需要调试工具，可以在容器运行之后再安装。某些包管理工具（如 apt）除了安装用户指定的包之外，还会安装推荐的包，这会无缘无故增加镜像的体积。apt 可以通过添加参数 -–no-install-recommends 来确保不会安装不需要的依赖项。如果确实需要某些依赖项，请在后面手动添加。</p>
<h3 id="删除包管理工具的缓存">删除包管理工具的缓存</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313223651.png" alt=""></p>
<p>包管理工具会维护自己的缓存，这些缓存会保留在镜像文件中，推荐的处理方法是在每一个 RUN 指令的末尾删除缓存。如果你在下一条指令中删除缓存，不会减小镜像的体积。</p>
<p>当然了，还有其他更高级的方法可以用来减小镜像体积，如下文将会介绍的多阶段构建。接下来我们将探讨如何优化 Dockerfile 的可维护性、安全性和可重复性。</p>
<h2 id="可维护性">可维护性</h2>
<h3 id="尽量使用官方镜像">尽量使用官方镜像</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313224130.png" alt=""></p>
<p>使用官方镜像可以节省大量的维护时间，因为官方镜像的所有安装步骤都使用了最佳实践。如果你有多个项目，可以共享这些镜像层，因为他们都可以使用相同的基础镜像。</p>
<h3 id="使用更具体的标签">使用更具体的标签</h3>
<p>为了让版本管理起来更方便，应用部署速度更快，在创建镜像的过程中，建议工程师们明确指定包含版本或者其他辅助信息的tag。</p>
<p>如果不指定镜像tag，默认会使用latest。每次启动应用实例时，都需要去镜像仓库检查镜像是否更新。这种方式不利于版本管理，对应用启动速度也有一定影响。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313224141.png" alt=""></p>
<p>基础镜像尽量不要使用 latest 标签。虽然这很方便，但随着时间的推移，latest 镜像可能会发生重大变化。因此在 Dockerfile 中最好指定基础镜像的具体标签。我们使用 openjdk 作为示例，指定标签为 8。其他更多标签请查看官方仓库。</p>
<h3 id="使用体积最小的基础镜像">使用体积最小的基础镜像</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313224237.png" alt=""></p>
<p>基础镜像的标签风格不同，镜像体积就会不同。slim 风格的镜像是基于 Debian 发行版制作的，而 alpine 风格的镜像是基于体积更小的 Alpine Linux 发行版制作的。其中一个明显的区别是：Debian 使用的是 GNU 项目所实现的 C 语言标准库，而 Alpine 使用的是 Musl C 标准库，它被设计用来替代 GNU C 标准库（glibc）的替代品，用于嵌入式操作系统和移动设备。因此使用 Alpine 在某些情况下会遇到兼容性问题。 以 openjdk 为例，jre 风格的镜像只包含 Java 运行时，不包含 SDK，这么做也可以大大减少镜像体积。</p>
<h2 id="重复利用">重复利用</h2>
<p>到目前为止，我们一直都在假设你的 jar 包是在主机上构建的，这还不是理想方案，因为没有充分利用容器提供的一致性环境。例如，如果你的 Java 应用依赖于某一个特定的操作系统的库，就可能会出现问题，因为环境不一致（具体取决于构建 jar 包的机器）。</p>
<h3 id="在一致的环境中从源代码构建">在一致的环境中从源代码构建</h3>
<p>源代码是你构建 Docker 镜像的最终来源，Dockerfile 里面只提供了构建步骤。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313224538.png" alt=""></p>
<p>首先应该确定构建应用所需的所有依赖，本文的示例 Java 应用很简单，只需要 Maven 和 JDK，所以基础镜像应该选择官方的体积最小的 maven 镜像，该镜像也包含了 JDK。如果你需要安装更多依赖，可以在 RUN 指令中添加。pom.xml 文件和 src 文件夹需要被复制到镜像中，因为最后执行 mvn package 命令（-e 参数用来显示错误，-B 参数表示以非交互式的“批处理”模式运行）打包的时候会用到这些依赖文件。</p>
<p>虽然现在我们解决了环境不一致的问题，但还有另外一个问题 :**每次代码更改之后，都要重新获取一遍 pom.xml 中描述的所有依赖项。**下面我们来解决这个问题。</p>
<h3 id="在单独的步骤中获取依赖项">在单独的步骤中获取依赖项</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313224642.png" alt=""></p>
<p>结合前面提到的缓存机制，我们可以让获取依赖项这一步变成可缓存单元，只要 pom.xml 文件的内容没有变化，无论代码如何更改，都不会破坏这一层的缓存。上图中两个 COPY 指令中间的 RUN 指令用来告诉 Maven 只获取依赖项。</p>
<p>现在又遇到了一个新问题：跟之前直接拷贝 jar 包相比，镜像体积变得更大了，因为它包含了很多运行应用时不需要的构建依赖项。</p>
<h3 id="使用多阶段构建来删除构建时的依赖项">使用多阶段构建来删除构建时的依赖项</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313224722.png" alt=""></p>
<p>多阶段构建可以由多个 FROM 指令识别，每一个 FROM 语句表示一个新的构建阶段，阶段名称可以用 AS 参数指定。本例中指定第一阶段的名称为 builder，它可以被第二阶段直接引用。两个阶段环境一致，并且第一阶段包含所有构建依赖项。</p>
<p>第二阶段是构建最终镜像的最后阶段，它将包括应用运行时的所有必要条件，本例是基于 Alpine 的最小 JRE 镜像。上一个构建阶段虽然会有大量的缓存，但不会出现在第二阶段中。为了将构建好的 jar 包添加到最终的镜像中，可以使用 COPY &ndash;from=STAGE_NAME 指令，其中 STAGE_NAME 是上一构建阶段的名称。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210313224733.png" alt=""></p>
<p>多阶段构建是删除构建依赖的首选方案。</p>
<h2 id="参考">参考</h2>
<p><a href="https://mp.weixin.qq.com/s/S1Ib08SpQbf1SCbCutUoqQ">Docker最佳实践：5个方法精简镜像</a>
<a href="https://mp.weixin.qq.com/s/bRX7AA1t6hGIeLkvHiirEw">优化Docker镜像，加速应用部署，教你6个小窍门</a>
<a href="https://fuckcloudnative.io/posts/intro-guide-to-dockerfile-best-practices/">你确定你会写 Dockerfile 吗？</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-03-13
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/docker/">Docker</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/google-sre%E5%BC%B9%E6%80%A7%E7%86%94%E6%96%AD%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Google SRE弹性熔断算法实现</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BAgo%E7%9A%84%E9%95%9C%E5%83%8F/">
            <span class="next-text nav-default">如何构建Go的镜像</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Forz</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
