<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MongoDB的评估查询运算符 | Forz Blog</title>
<meta name="keywords" content="MongoDB" />
<meta name="description" content="$expr 允许在查询语言中使用聚合表达式。 $expr 具有以下语法： 1 { $expr: { &lt;expression&gt; } } 参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。 特性 $expr可">
<meta name="author" content="">
<link rel="canonical" href="/post/mongodb%E7%9A%84%E8%AF%84%E4%BC%B0%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="MongoDB的评估查询运算符" />
<meta property="og:description" content="$expr 允许在查询语言中使用聚合表达式。 $expr 具有以下语法： 1 { $expr: { &lt;expression&gt; } } 参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。 特性 $expr可" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/mongodb%E7%9A%84%E8%AF%84%E4%BC%B0%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-13T15:45:30&#43;00:00" />
<meta property="article:modified_time" content="2020-05-13T15:45:30&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MongoDB的评估查询运算符"/>
<meta name="twitter:description" content="$expr 允许在查询语言中使用聚合表达式。 $expr 具有以下语法： 1 { $expr: { &lt;expression&gt; } } 参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。 特性 $expr可"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "MongoDB的评估查询运算符",
      "item": "/post/mongodb%E7%9A%84%E8%AF%84%E4%BC%B0%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MongoDB的评估查询运算符",
  "name": "MongoDB的评估查询运算符",
  "description": "$expr 允许在查询语言中使用聚合表达式。 $expr 具有以下语法： 1 { $expr: { \u0026lt;expression\u0026gt; } } 参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。 特性 $expr可",
  "keywords": [
    "MongoDB"
  ],
  "articleBody": "$expr 允许在查询语言中使用聚合表达式。\n$expr 具有以下语法：\n1  { $expr: { expression } }   参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。\n特性 $expr可以构建查询表达式，以比较$match阶段中同一文档中的字段。\n如果$match阶段是阶段的一部分$lookup，则 $expr可以使用let变量比较字段。有关示例，请参见 使用$lookup指定多个联接条件。\n$expr不支持多键索引。\n例子 比较单个文档中的两个字段 考虑包含monthlyBudget以下文档的集合：\n1 2 3 4 5  { \"_id\" : 1, \"category\" : \"food\", \"budget\": 400, \"spent\": 450 } { \"_id\" : 2, \"category\" : \"drinks\", \"budget\": 100, \"spent\": 150 } { \"_id\" : 3, \"category\" : \"clothes\", \"budget\": 100, \"spent\": 50 } { \"_id\" : 4, \"category\" : \"misc\", \"budget\": 500, \"spent\": 300 } { \"_id\" : 5, \"category\" : \"travel\", \"budget\": 200, \"spent\": 650 }   以下操作用于$expr查找spent超过budget的文档：\n1  db.monthlyBudget.find( { $expr: { $gt: [ \"$spent\" , \"$budget\" ] } } )   该操作返回以下结果：\n1 2 3  { \"_id\" : 1, \"category\" : \"food\", \"budget\" : 400, \"spent\" : 450 } { \"_id\" : 2, \"category\" : \"drinks\", \"budget\" : 100, \"spent\" : 150 } { \"_id\" : 5, \"category\" : \"travel\", \"budget\" : 200, \"spent\" : 650 }   $expr与条件语句一起使用 某些查询要求在定义查询过滤器时能够执行条件逻辑。聚合框架为$cond运算符提供了 表达条件语句的方法。通过$expr与$cond运算符一起使用 ，可以为查询语句指定条件过滤器。\nsupplies使用以下文档创建样本集合：\n1 2 3 4 5 6 7  db.supplies.insertMany([ { \"_id\" : 1, \"item\" : \"binder\", \"qty\" : NumberInt(\"100\"), \"price\" : NumberDecimal(\"12\") }, { \"_id\" : 2, \"item\" : \"notebook\", \"qty\" : NumberInt(\"200\"), \"price\" : NumberDecimal(\"8\") }, { \"_id\" : 3, \"item\" : \"pencil\", \"qty\" : NumberInt(\"50\"), \"price\" : NumberDecimal(\"6\") }, { \"_id\" : 4, \"item\" : \"eraser\", \"qty\" : NumberInt(\"150\"), \"price\" : NumberDecimal(\"3\") }, { \"_id\" : 5, \"item\" : \"legal pad\", \"qty\" : NumberInt(\"42\"), \"price\" : NumberDecimal(\"10\") } ])   假设要在下个月进行的销售，您需要对价格进行折价，使得：\n 如果qty大于或等于100，则折扣价price为0.5。 如果qty小于100，则折价price为的0.75。  在应用折扣之前，您想知道supplies集合中的哪些项目的折扣价小于5。\n以下示例使用$expr和$cond来基于qty和$lt计算折扣价，并返回其折扣价小于NumberDecimal(“5”)的文档：\n1 2 3 4 5 6 7 8 9 10 11 12 13  // Aggregation expression to calculate discounted price let discountedPrice = { $cond: { if: { $gte: [\"$qty\", 100] }, then: { $multiply: [\"$price\", NumberDecimal(\"0.50\")] }, else: { $multiply: [\"$price\", NumberDecimal(\"0.75\")] } } }; // Query the supplies collection using the aggregation expression db.supplies.find( { $expr: { $lt:[ discountedPrice, NumberDecimal(\"5\") ] } });   下表显示了每个文档的折扣价以及折扣价是否小于NumberDecimal(“5”)（即，文档是否满足查询条件）。\n即使$cond计算出有效的折价，该价格也不会反映在返回的数据中。而是返回的文档以其原始状态表示匹配的文档。查找操作未返回legal,binder文件，因为它们的折扣价大于5。\n$jsonSchema $jsonSchema匹配满足指定JSON Schema文档。\nhttps://docs.mongodb.com/manual/reference/operator/query/jsonSchema/\n$mod 选择filed除以除数的字段的值具有指定余数的文档（即执行模运算以选择文档）。要指定$mod表达式，请使用以下语法：\n1  { field: { $mod: [ divisor, remainder ] } }   $mod当传递的元素少于或多于两个的数组时，运算符会出错。\n例子 使用$mod来选择文件 考虑inventory包含以下文档的集合：\n1 2 3  { \"_id\" : 1, \"item\" : \"abc123\", \"qty\" : 0 } { \"_id\" : 2, \"item\" : \"xyz123\", \"qty\" : 5 } { \"_id\" : 3, \"item\" : \"ijk123\", \"qty\" : 12 }   然后，以下查询选择inventory集合中qty模 取值4等于的那些文档 0：\n1  db.inventory.find( { qty: { $mod: [ 4, 0 ] } } )   该查询返回以下文档：\n1 2  { \"_id\" : 1, \"item\" : \"abc123\", \"qty\" : 0 } { \"_id\" : 3, \"item\" : \"ijk123\", \"qty\" : 12 }   没有足够的元素错误 $mod传递少于两个元素的数组时，运算符会出错。\n单元素数组 以下操作错误地向$mod运算符传递了包含单个元素的数组：\n1  db.inventory.find( { qty: { $mod: [ 4 ] } } )   该语句导致以下错误：\n1 2 3 4  error: { \"$err\" : \"bad query: BadValue malformed mod, not enough elements\", \"code\" : 16810 }   空数组 以下操作错误地向$mod运算符传递了一个空数组：\n1  db.inventory.find( { qty: { $mod: [ ] } } )   该语句导致以下错误：\n1 2 3 4  error: { \"$err\" : \"bad query: BadValue malformed mod, not enough elements\", \"code\" : 16810 }   元素过多错误 $mod传递具有两个以上元素的数组时，运算符会出错。\n例如，以下操作尝试将$mod 运算符与包含四个元素的数组一起使用：\n1 2 3 4  error: { \"$err\" : \"bad query: BadValue malformed mod, too many elements\", \"code\" : 16810 }   $regex 为查询中的模式匹配字符串提供正则表达式功能 。MongoDB使用具有UTF-8支持的Perl兼容正则表达式（即“PCRE”）版本8.42。\n要使用$regex，请使用以下语法之一：\n1 2 3  { : { $regex: /pattern/, $options: '' } } { : { $regex: 'pattern', $options: '' } } { : { $regex: /pattern/ } }   在MongoDB中，您还可以使用正则表达式对象（即 /pattern/）来指定正则表达式：\n1  { : /pattern/ }   $options 以下内容可用于正则表达式。\n   选项 描述 语法限制     i 不区分大小写，以匹配大小写。    m 对于包含锚点的模式（即^开始， $结束），请在每行的开头或结尾匹配具有多行值的字符串。如果没有此选项，这些锚点将在字符串的开头或结尾匹配。如果模式不包含锚点，或者字符串值不包含换行符（例如\\n），则该m选项无效。    x “扩展”功能可以忽略模式中的所有空白字符，$regex除非转义或包含在字符类中。此外，它会忽略中间的字符，包括未转义的井号/磅（#）字符和下一个新行，因此您可以在复杂模式中添加注释。这仅适用于数据字符；空格字符永远不会出现在图案的特殊字符序列中。该x选项不影响VT字符（即代码11）的处理。 需要$regex与$options语法   s 允许点字符（即.）匹配所有字符，包括换行符。 需要$regex与$options语法    特性 $ regex vs /pattern/ $in表达式 要在$in查询表达式中包含正则表达式，您只能使用JavaScript正则对象（即/pattern/ ）。例如：\n1  { name: { $in: [ /^acme/i, /^ack/ ] } }   您不能在中使用$regex运算符表达式$in。\n隐AND条件字段 要将正则表达式包含在该字段的查询条件的逗号分隔列表中，请使用$regex运算符。例如：\n1 2 3  { name: { $regex: /acme.*corp/i, $nin: [ 'acmeblahcorp' ] } } { name: { $regex: /acme.*corp/, $options: 'i', $nin: [ 'acmeblahcorp' ] } } { name: { $regex: 'acme.*corp', $options: 'i', $nin: [ 'acmeblahcorp' ] } }   x和s选项 要使用任一x选项或s选项，则必须使用 $regex与该$options。例如，要指定i和s选项，必须同时使用$options：\n1 2  { name: { $regex: /acme.*corp/, $options: \"si\" } } { name: { $regex: 'acme.*corp', $options: \"si\" } }   PCRE VS JavaScript 要在regex模式中使用JavaScript不支持的PCRE支持的功能，必须将$regex运算符表达式与模式一起用作字符串。例如，要在模式中使用(?i) 来为剩余的模式打开不区分大小写并为剩余的模式(?-i)打开区分大小写，您必须$regex将该模式的运算符用作字符串：\n1  { name: { $regex: '(?i)a(?-i)cme' } }   $regex和$not 从4.0.7版开始，$not可以对以下两种方式执行NOT逻辑操作：\n正则表达式对象（即/pattern/）\n例如：\n1  db.inventory.find( { item: { $not: /^p.*/ } } )   $regex 运算符表达式（从MongoDB 4.0.7开始）:\n例如：\n1 2  db.inventory.find( { item: { $not: { $regex: \"^p.*\" } } } ) db.inventory.find( { item: { $not: { $regex: /^p.*/ } } } )   在4.0.6及更低版本中，您可以将$not运算符与正则表达式对象（即/pattern/）一起使用，但不能与$regex运算符表达式一起使用。\n索引使用 对于区分大小写的正则表达式查询，如果该字段存在索引，则MongoDB会将正则表达式与索引中的值进行匹配，这可能比集合扫描更快。如果正则表达式是“前缀表达式”，则可能会发生进一步的优化，这意味着所有潜在的匹配都以相同的字符串开头。这允许MongoDB从该前缀构造一个“范围”，并且仅与该范围内的索引值匹配。\n如果正则表达式以尖号（^）或左锚（\\A）开头，后跟一串简单符号，则为“前缀表达式” 。例如，/^abc.*/将仅通过匹配索引中以开头的值来优化正则表达式abc。\n此外，虽然/^a/，/^a.*/和/^a.*$/匹配等效的字符串，但它们具有不同的性能特征。如果存在适当的索引，则所有这些表达式都使用索引；但是，/^a.*/和/^a.*$/较慢。/^a/匹配前缀后可以停止扫描。\n不区分大小写的正则表达式查询通常不能有效地使用索引。该$regex实现不支持排序规则，并且无法使用不区分大小写的索引。\n例子 以下示例将集合products与以下文档结合使用：\n1 2 3 4  { \"_id\" : 100, \"sku\" : \"abc123\", \"description\" : \"Single line description.\" } { \"_id\" : 101, \"sku\" : \"abc789\", \"description\" : \"First line\\nSecond line\" } { \"_id\" : 102, \"sku\" : \"xyz456\", \"description\" : \"Many spaces before line\" } { \"_id\" : 103, \"sku\" : \"xyz789\", \"description\" : \"Multiple\\nline description\" }   执行LIKE匹配 以下示例匹配sku字段类似的所有文档\"%789\"：\n1  db.products.find( { sku: { $regex: /789$/ } } )   该示例类似于以下SQL LIKE语句：\n1 2  SELECT*FROMproductsWHEREskulike\"%789\";  执行不区分大小写的正则表达式匹配 以下示例使用i选项对sku值以开头的文档执行 不区分大小写的匹配ABC。\n1  db.products.find( { sku: { $regex: /^ABC/i } } )   该查询与以下文档匹配：\n1 2  { \"_id\" : 100, \"sku\" : \"abc123\", \"description\" : \"Single line description.\" } { \"_id\" : 101, \"sku\" : \"abc789\", \"description\" : \"First line\\nSecond line\" }   从指定模式开始的行的多行匹配 以下示例使用该m选项来匹配S多行字符串以字母开头的行：\n1  db.products.find( { description: { $regex: /^S/, $options: 'm' } } )   该查询与以下文档匹配：\n1 2  { \"_id\" : 100, \"sku\" : \"abc123\", \"description\" : \"Single line description.\" } { \"_id\" : 101, \"sku\" : \"abc789\", \"description\" : \"First line\\nSecond line\" }   如果没有该m选项，则查询将仅匹配以下文档：\n1  { \"_id\" : 100, \"sku\" : \"abc123\", \"description\" : \"Single line description.\" }   如果该$regex模式不包含锚，则该模式将与整个字符串匹配，如以下示例所示：\n1  db.products.find( { description: { $regex: /S/ } } )   然后，$regex将匹配两个文档：\n1 2  { \"_id\" : 100, \"sku\" : \"abc123\", \"description\" : \"Single line description.\" } { \"_id\" : 101, \"sku\" : \"abc789\", \"description\" : \"First line\\nSecond line\" }   使用.点字符来匹配 以下示例使用允许点字符（即.）匹配所有字符（包括换行符）的s选项以及执行不区分大小写的匹配的i选项：\n1  db.products.find( { description: { $regex: /m.*line/, $options: 'si' } } )   该查询与以下文档匹配：\n1 2  { \"_id\" : 102, \"sku\" : \"xyz456\", \"description\" : \"Many spaces before line\" } { \"_id\" : 103, \"sku\" : \"xyz789\", \"description\" : \"Multiple\\nline description\" }   如果没有该s选项，则查询将仅与以下文档匹配：\n1  { \"_id\" : 102, \"sku\" : \"xyz456\", \"description\" : \"Many spaces before line\" }   忽略Pattern中的空格 以下示例使用x选项“忽略空白”和注释，在匹配模式中以#表示并以\\n结尾：\n1 2  var pattern = \"abc #category code\\n123 #item number\" db.products.find( { sku: { $regex: pattern, $options: \"x\" } } )   该查询与以下文档匹配：\n1  { \"_id\" : 100, \"sku\" : \"abc123\", \"description\" : \"Single line description.\" }   $text $text对用文本索引索引的字段的内容进行文本搜索。\nhttps://docs.mongodb.com/manual/reference/operator/query/text/\n$where 使用$where运算符将包含JavaScript表达式的字符串或完整的JavaScript函数传递给查询系统。在$where提供了更大的灵活性，但无法利用索引。因此，当您使用标准MongoDB运算符（例如$gt，$in）来表达查询时，查询性能将会提高。\n重要\n在版本3.6中更改：$expr运算符允许在查询语言中使用聚合表达式。 $expr比$where快，因为它不执行JavaScript，因此应尽可能首选。\n",
  "wordCount" : "4049",
  "inLanguage": "zh-cn",
  "datePublished": "2020-05-13T15:45:30Z",
  "dateModified": "2020-05-13T15:45:30Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/mongodb%E7%9A%84%E8%AF%84%E4%BC%B0%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      MongoDB的评估查询运算符
    </h1>
    <div class="post-meta">May 13, 2020
</div>
  </header> 
  <div class="post-content"><h1 id="expr">$expr<a hidden class="anchor" aria-hidden="true" href="#expr">#</a></h1>
<p>允许在查询语言中使用<a href="https://docs.mongodb.com/manual/meta/aggregation-quick-reference/#aggregation-expressions">聚合表达式</a>。</p>
<p>$expr 具有以下语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">expr</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">expression</span><span class="o">&gt;</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>参数可以是任何有效的聚合表达式。有关更多信息，请参见<a href="https://docs.mongodb.com/manual/meta/aggregation-quick-reference/#aggregation-expressions">表达式</a>。</p>
<h2 id="特性">特性<a hidden class="anchor" aria-hidden="true" href="#特性">#</a></h2>
<p><code>$expr</code>可以构建查询表达式，以比较<code>$match</code>阶段中同一文档中的字段。</p>
<p>如果<code>$match</code>阶段是阶段的一部分<code>$lookup</code>，则 <code>$expr</code>可以使用let变量比较字段。有关示例，请参见 使用<code>$lookup</code>指定多个联接条件。</p>
<p><code>$expr</code>不支持多键索引。</p>
<h2 id="例子">例子<a hidden class="anchor" aria-hidden="true" href="#例子">#</a></h2>
<h3 id="比较单个文档中的两个字段">比较单个文档中的两个字段<a hidden class="anchor" aria-hidden="true" href="#比较单个文档中的两个字段">#</a></h3>
<p>考虑包含monthlyBudget以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;food&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">450</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;drinks&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">150</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;clothes&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;misc&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">300</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;travel&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">650</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作用于$expr查找spent超过budget的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.monthlyBudget.find</span><span class="p">(</span> <span class="p">{</span> <span class="o">$</span><span class="n">expr</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gt</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;$spent&#34;</span> <span class="p">,</span> <span class="s">&#34;$budget&#34;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作返回以下结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;food&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span> <span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span> <span class="p">:</span> <span class="mi">450</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;drinks&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span> <span class="p">:</span> <span class="mi">150</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;travel&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span> <span class="p">:</span> <span class="mi">650</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="expr与条件语句一起使用">$expr与条件语句一起使用<a hidden class="anchor" aria-hidden="true" href="#expr与条件语句一起使用">#</a></h3>
<p>某些查询要求在定义查询过滤器时能够执行条件逻辑。聚合框架为<code>$cond</code>运算符提供了 表达条件语句的方法。通过<code>$expr</code>与<code>$cond</code>运算符一起使用 ，可以为查询语句指定条件过滤器。</p>
<p>supplies使用以下文档创建样本集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.supplies.insertMany</span><span class="p">(</span><span class="n">[</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;binder&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;100&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;12&#34;</span><span class="p">)</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;notebook&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;200&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;8&#34;</span><span class="p">)</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">3</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;pencil&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;50&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;6&#34;</span><span class="p">)</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">4</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;eraser&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;150&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;3&#34;</span><span class="p">)</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">5</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;legal pad&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;42&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;10&#34;</span><span class="p">)</span> <span class="p">}</span>
<span class="n">]</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>假设要在下个月进行的销售，您需要对价格进行折价，使得：</p>
<ul>
<li>如果qty大于或等于100，则折扣价price为0.5。</li>
<li>如果qty小于100，则折价price为的0.75。</li>
</ul>
<p>在应用折扣之前，您想知道supplies集合中的哪些项目的折扣价小于5。</p>
<p>以下示例使用<code>$expr</code>和<code>$cond</code>来基于qty和$lt计算折扣价，并返回其折扣价小于NumberDecimal(&ldquo;5&rdquo;)的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">//</span> <span class="n">Aggregation</span> <span class="n">expression</span> <span class="n">to</span> <span class="n">calculate</span> <span class="n">discounted</span> <span class="n">price</span>

<span class="n">let</span> <span class="n">discountedPrice</span> <span class="o">=</span> <span class="p">{</span>
   <span class="o">$</span><span class="n">cond</span><span class="o">:</span> <span class="p">{</span>
      <span class="n">if</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="n">[</span><span class="s">&#34;$qty&#34;</span><span class="p">,</span> <span class="m">100</span><span class="n">]</span> <span class="p">},</span>
      <span class="n">then</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">multiply</span><span class="o">:</span> <span class="n">[</span><span class="s">&#34;$price&#34;</span><span class="p">,</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;0.50&#34;</span><span class="p">)</span><span class="n">]</span> <span class="p">},</span>
      <span class="n">else</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">multiply</span><span class="o">:</span> <span class="n">[</span><span class="s">&#34;$price&#34;</span><span class="p">,</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;0.75&#34;</span><span class="p">)</span><span class="n">]</span> <span class="p">}</span>
   <span class="p">}</span>
<span class="p">};</span>

<span class="o">//</span> <span class="n">Query</span> <span class="n">the</span> <span class="n">supplies</span> <span class="n">collection</span> <span class="n">using</span> <span class="n">the</span> <span class="n">aggregation</span> <span class="n">expression</span>

<span class="nf">db.supplies.find</span><span class="p">(</span> <span class="p">{</span> <span class="o">$</span><span class="n">expr</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">lt</span><span class="o">:</span><span class="n">[</span> <span class="n">discountedPrice</span><span class="p">,</span>  <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;5&#34;</span><span class="p">)</span> <span class="n">]</span> <span class="p">}</span> <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>下表显示了每个文档的折扣价以及折扣价是否小于NumberDecimal(&ldquo;5&rdquo;)（即，文档是否满足查询条件）。</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200513200449.png" alt=""  />
</p>
<p>即使$cond计算出有效的折价，该价格也不会反映在返回的数据中。而是返回的文档以其原始状态表示匹配的文档。查找操作未返回legal,binder文件，因为它们的折扣价大于5。</p>
<h1 id="jsonschema">$jsonSchema<a hidden class="anchor" aria-hidden="true" href="#jsonschema">#</a></h1>
<p><code>$jsonSchema</code>匹配满足指定JSON Schema文档。</p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/">https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/</a></p>
<h1 id="mod">$mod<a hidden class="anchor" aria-hidden="true" href="#mod">#</a></h1>
<p>选择filed除以除数的字段的值具有指定余数的文档（即执行模运算以选择文档）。要指定<code>$mod</code>表达式，请使用以下语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">field</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">mod</span><span class="o">:</span> <span class="n">[</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">remainder</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>$mod</code>当传递的元素少于或多于两个的数组时，运算符会出错。</p>
<h2 id="例子-1">例子<a hidden class="anchor" aria-hidden="true" href="#例子-1">#</a></h2>
<h3 id="使用mod来选择文件">使用$mod来选择文件<a hidden class="anchor" aria-hidden="true" href="#使用mod来选择文件">#</a></h3>
<p>考虑inventory包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;xyz123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;ijk123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">12</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，以下查询选择inventory集合中qty模 取值4等于的那些文档 0：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">qty</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">mod</span><span class="o">:</span> <span class="n">[</span> <span class="m">4</span><span class="p">,</span> <span class="m">0</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询返回以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;ijk123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">12</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="没有足够的元素错误">没有足够的元素错误<a hidden class="anchor" aria-hidden="true" href="#没有足够的元素错误">#</a></h3>
<p>$mod传递少于两个元素的数组时，运算符会出错。</p>
<h4 id="单元素数组">单元素数组<a hidden class="anchor" aria-hidden="true" href="#单元素数组">#</a></h4>
<p>以下操作错误地向$mod运算符传递了包含单个元素的数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">qty</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">mod</span><span class="o">:</span> <span class="n">[</span> <span class="m">4</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该语句导致以下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">error:</span> <span class="p">{</span>
     <span class="nt">&#34;$err&#34;</span> <span class="p">:</span> <span class="s2">&#34;bad query: BadValue malformed mod, not enough elements&#34;</span><span class="p">,</span>
     <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">16810</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="空数组">空数组<a hidden class="anchor" aria-hidden="true" href="#空数组">#</a></h4>
<p>以下操作错误地向$mod运算符传递了一个空数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">qty</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">mod</span><span class="o">:</span> <span class="n">[</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该语句导致以下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">error:</span> <span class="p">{</span>
     <span class="nt">&#34;$err&#34;</span> <span class="p">:</span> <span class="s2">&#34;bad query: BadValue malformed mod, not enough elements&#34;</span><span class="p">,</span>
     <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">16810</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="元素过多错误">元素过多错误<a hidden class="anchor" aria-hidden="true" href="#元素过多错误">#</a></h4>
<p>$mod传递具有两个以上元素的数组时，运算符会出错。</p>
<p>例如，以下操作尝试将$mod 运算符与包含四个元素的数组一起使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">error:</span> <span class="p">{</span>
     <span class="nt">&#34;$err&#34;</span> <span class="p">:</span> <span class="s2">&#34;bad query: BadValue malformed mod, too many elements&#34;</span><span class="p">,</span>
     <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">16810</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="regex">$regex<a hidden class="anchor" aria-hidden="true" href="#regex">#</a></h1>
<p>为查询中的模式匹配字符串提供正则表达式功能 。MongoDB使用具有UTF-8支持的Perl兼容正则表达式（即“PCRE”）版本8.42。</p>
<p>要使用$regex，请使用以下语法之一：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="err">&lt;field&gt;:</span> <span class="err">{</span> <span class="err">$regex:</span> <span class="err">/pattern/,</span> <span class="err">$options:</span> <span class="err">&#39;&lt;options&gt;&#39;</span> <span class="p">}</span> <span class="err">}</span>
<span class="p">{</span> <span class="err">&lt;field&gt;:</span> <span class="err">{</span> <span class="err">$regex:</span> <span class="err">&#39;pattern&#39;,</span> <span class="err">$options:</span> <span class="err">&#39;&lt;options&gt;&#39;</span> <span class="p">}</span> <span class="err">}</span>
<span class="p">{</span> <span class="err">&lt;field&gt;:</span> <span class="err">{</span> <span class="err">$regex:</span> <span class="err">/pattern/&lt;options&gt;</span> <span class="p">}</span> <span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在MongoDB中，您还可以使用正则表达式对象（即 /pattern/）来指定正则表达式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="err">&lt;field&gt;:</span> <span class="err">/pattern/&lt;options&gt;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="options">$options<a hidden class="anchor" aria-hidden="true" href="#options">#</a></h2>
<p>以下内容<code>&lt;options&gt;</code>可用于正则表达式。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
<th>语法限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>i</td>
<td>不区分大小写，以匹配大小写。</td>
<td></td>
</tr>
<tr>
<td>m</td>
<td>对于包含锚点的模式（即^开始， $结束），请在每行的开头或结尾匹配具有多行值的字符串。如果没有此选项，这些锚点将在字符串的开头或结尾匹配。如果模式不包含锚点，或者字符串值不包含换行符（例如\n），则该m选项无效。</td>
<td></td>
</tr>
<tr>
<td>x</td>
<td>“扩展”功能可以忽略模式中的所有空白字符，$regex除非转义或包含在字符类中。此外，它会忽略中间的字符，包括未转义的井号/磅（#）字符和下一个新行，因此您可以在复杂模式中添加注释。这仅适用于数据字符；空格字符永远不会出现在图案的特殊字符序列中。该x选项不影响VT字符（即代码11）的处理。</td>
<td>需要<code>$regex</code>与<code>$options</code>语法</td>
</tr>
<tr>
<td>s</td>
<td>允许点字符（即.）匹配所有字符，包括换行符。</td>
<td>需要<code>$regex</code>与<code>$options</code>语法</td>
</tr>
</tbody>
</table>
<h2 id="特性-1">特性<a hidden class="anchor" aria-hidden="true" href="#特性-1">#</a></h2>
<h3 id="-regex-vs-pattern">$ regex vs /pattern/<a hidden class="anchor" aria-hidden="true" href="#-regex-vs-pattern">#</a></h3>
<h4 id="in表达式">$in表达式<a hidden class="anchor" aria-hidden="true" href="#in表达式">#</a></h4>
<p>要在<code>$in</code>查询表达式中包含正则表达式，您只能使用JavaScript正则对象（即/pattern/ ）。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">in</span><span class="o">:</span> <span class="n">[</span> <span class="o">/</span><span class="n">^acme</span><span class="o">/</span><span class="n">i</span><span class="p">,</span> <span class="o">/</span><span class="n">^ack</span><span class="o">/</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>您不能在中使用$regex运算符表达式$in。</p>
<h4 id="隐and条件字段">隐AND条件字段<a hidden class="anchor" aria-hidden="true" href="#隐and条件字段">#</a></h4>
<p>要将正则表达式包含在该字段的查询条件的逗号分隔列表中，请使用$regex运算符。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">acme.</span><span class="o">*</span><span class="n">corp</span><span class="o">/</span><span class="n">i</span><span class="p">,</span> <span class="o">$</span><span class="n">nin</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#39;acmeblahcorp&#39;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">acme.</span><span class="o">*</span><span class="n">corp</span><span class="o">/</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="o">$</span><span class="n">nin</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#39;acmeblahcorp&#39;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="s">&#39;acme.*corp&#39;</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="o">$</span><span class="n">nin</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#39;acmeblahcorp&#39;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="x和s选项">x和s选项<a hidden class="anchor" aria-hidden="true" href="#x和s选项">#</a></h4>
<p>要使用任一x选项或s选项，则必须使用 <code>$regex</code>与该<code>$options</code>。例如，要指定i和s选项，必须同时使用$options：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">acme.</span><span class="o">*</span><span class="n">corp</span><span class="o">/</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#34;si&#34;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="s">&#39;acme.*corp&#39;</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#34;si&#34;</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="pcre-vs-javascript">PCRE VS JavaScript<a hidden class="anchor" aria-hidden="true" href="#pcre-vs-javascript">#</a></h3>
<p>要在regex模式中使用JavaScript不支持的PCRE支持的功能，必须将<code>$regex</code>运算符表达式与模式一起用作字符串。例如，要在模式中使用(?i) 来为剩余的模式打开不区分大小写并为剩余的模式(?-i)打开区分大小写，您必须$regex将该模式的运算符用作字符串：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="s">&#39;(?i)a(?-i)cme&#39;</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="regex和not">$regex和$not<a hidden class="anchor" aria-hidden="true" href="#regex和not">#</a></h3>
<p>从4.0.7版开始，$not可以对以下两种方式执行NOT逻辑操作：</p>
<p>正则表达式对象（即/pattern/）</p>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">item</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">not</span><span class="o">:</span> <span class="o">/</span><span class="n">^p.</span><span class="o">*/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>$regex 运算符表达式（从MongoDB 4.0.7开始）:</p>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">item</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">not</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="s">&#34;^p.*&#34;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
<span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">item</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">not</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">^p.</span><span class="o">*/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>在4.0.6及更低版本中，您可以将<code>$not</code>运算符与正则表达式对象（即/pattern/）一起使用，但不能与<code>$regex</code>运算符表达式一起使用。</p>
<h3 id="索引使用">索引使用<a hidden class="anchor" aria-hidden="true" href="#索引使用">#</a></h3>
<p>对于区分大小写的正则表达式查询，如果该字段存在索引，则MongoDB会将正则表达式与索引中的值进行匹配，这可能比集合扫描更快。如果正则表达式是“前缀表达式”，则可能会发生进一步的优化，这意味着所有潜在的匹配都以相同的字符串开头。这允许MongoDB从该前缀构造一个“范围”，并且仅与该范围内的索引值匹配。</p>
<p>如果正则表达式以尖号（^）或左锚（\A）开头，后跟一串简单符号，则为“前缀表达式” 。例如，<code>/^abc.*/</code>将仅通过匹配索引中以开头的值来优化正则表达式abc。</p>
<p>此外，虽然<code>/^a/</code>，<code>/^a.*/</code>和<code>/^a.*$</code>/匹配等效的字符串，但它们具有不同的性能特征。如果存在适当的索引，则所有这些表达式都使用索引；但是，<code>/^a.*/</code>和<code>/^a.*$/</code>较慢。<code>/^a/</code>匹配前缀后可以停止扫描。</p>
<p>不区分大小写的正则表达式查询通常不能有效地使用索引。该<code>$regex</code>实现不支持排序规则，并且无法使用不区分大小写的索引。</p>
<h2 id="例子-2">例子<a hidden class="anchor" aria-hidden="true" href="#例子-2">#</a></h2>
<p>以下示例将集合products与以下文档结合使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">{ &#34;_id&#34; : 100, &#34;sku&#34; : &#34;abc123&#34;, &#34;description&#34; : &#34;Single line description.&#34; }
{ &#34;_id&#34; : 101, &#34;sku&#34; : &#34;abc789&#34;, &#34;description&#34; : &#34;First line\nSecond line&#34; }
{ &#34;_id&#34; : 102, &#34;sku&#34; : &#34;xyz456&#34;, &#34;description&#34; : &#34;Many spaces before     line&#34; }
{ &#34;_id&#34; : 103, &#34;sku&#34; : &#34;xyz789&#34;, &#34;description&#34; : &#34;Multiple\nline description&#34; }
</code></pre></td></tr></table>
</div>
</div><h3 id="执行like匹配">执行LIKE匹配<a hidden class="anchor" aria-hidden="true" href="#执行like匹配">#</a></h3>
<p>以下示例匹配sku字段类似的所有文档&quot;%789&quot;：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">sku</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="m">789</span><span class="o">$/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该示例类似于以下SQL LIKE语句：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">sku</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s2">&#34;%789&#34;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="执行不区分大小写的正则表达式匹配">执行不区分大小写的正则表达式匹配<a hidden class="anchor" aria-hidden="true" href="#执行不区分大小写的正则表达式匹配">#</a></h3>
<p>以下示例使用i选项对sku值以开头的文档执行 不区分大小写的匹配ABC。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">sku</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">^ABC</span><span class="o">/</span><span class="n">i</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Single line description.&#34;</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc789&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;First line\nSecond line&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="从指定模式开始的行的多行匹配">从指定模式开始的行的多行匹配<a hidden class="anchor" aria-hidden="true" href="#从指定模式开始的行的多行匹配">#</a></h3>
<p>以下示例使用该m选项来匹配S多行字符串以字母开头的行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">description</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">^S</span><span class="o">/</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#39;m&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Single line description.&#34;</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc789&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;First line\nSecond line&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果没有该m选项，则查询将仅匹配以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Single line description.&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果该$regex模式不包含锚，则该模式将与整个字符串匹配，如以下示例所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">description</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">S</span><span class="o">/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，$regex将匹配两个文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Single line description.&#34;</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc789&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;First line\nSecond line&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="使用点字符来匹配">使用.点字符来匹配<a hidden class="anchor" aria-hidden="true" href="#使用点字符来匹配">#</a></h3>
<p>以下示例使用允许点字符（即.）匹配所有字符（包括换行符）的s选项以及执行不区分大小写的匹配的i选项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">description</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">m.</span><span class="o">*</span><span class="n">line</span><span class="o">/</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#39;si&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;xyz456&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Many spaces before     line&#34;</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;xyz789&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Multiple\nline description&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果没有该s选项，则查询将仅与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;xyz456&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Many spaces before     line&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="忽略pattern中的空格">忽略Pattern中的空格<a hidden class="anchor" aria-hidden="true" href="#忽略pattern中的空格">#</a></h3>
<p>以下示例使用x选项“忽略空白”和注释，在匹配模式中以#表示并以\n结尾：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">var</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#34;abc #category code\n123 #item number&#34;</span>
<span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">sku</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="n">pattern</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#34;x&#34;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">100</span><span class="p">,</span> <span class="s">&#34;sku&#34;</span> <span class="o">:</span> <span class="s">&#34;abc123&#34;</span><span class="p">,</span> <span class="s">&#34;description&#34;</span> <span class="o">:</span> <span class="s">&#34;Single line description.&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="text">$text<a hidden class="anchor" aria-hidden="true" href="#text">#</a></h1>
<p><code>$text</code>对用文本索引索引的字段的内容进行文本搜索。</p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/query/text/">https://docs.mongodb.com/manual/reference/operator/query/text/</a></p>
<h1 id="where">$where<a hidden class="anchor" aria-hidden="true" href="#where">#</a></h1>
<p>使用<code>$where</code>运算符将包含JavaScript表达式的字符串或完整的JavaScript函数传递给查询系统。在<code>$where</code>提供了更大的灵活性，但无法利用索引。因此，当您使用标准MongoDB运算符（例如<code>$gt</code>，<code>$in</code>）来表达查询时，查询性能将会提高。</p>
<p>重要</p>
<p>在版本3.6中更改：<code>$expr</code>运算符允许在查询语言中使用聚合表达式。 <code>$expr</code>比<code>$where</code>快，因为它不执行JavaScript，因此应尽可能首选。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/mongodb/">MongoDB</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
