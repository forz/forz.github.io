<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>MongoDB的评估查询运算符 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Forz" /><meta name="description" content="$expr 允许在查询语言中使用聚合表达式。 $expr 具有以下语法： 1 { $expr: { &amp;lt;expression&amp;gt; } } 参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。 特性 $expr可" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.87.0 with theme even" />


<link rel="canonical" href="/post/mongodb%E7%9A%84%E8%AF%84%E4%BC%B0%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="MongoDB的评估查询运算符" />
<meta property="og:description" content="$expr 允许在查询语言中使用聚合表达式。 $expr 具有以下语法： 1 { $expr: { &lt;expression&gt; } } 参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。 特性 $expr可" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/mongodb%E7%9A%84%E8%AF%84%E4%BC%B0%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-13T15:45:30+00:00" />
<meta property="article:modified_time" content="2020-05-13T15:45:30+00:00" />

<meta itemprop="name" content="MongoDB的评估查询运算符">
<meta itemprop="description" content="$expr 允许在查询语言中使用聚合表达式。 $expr 具有以下语法： 1 { $expr: { &lt;expression&gt; } } 参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。 特性 $expr可"><meta itemprop="datePublished" content="2020-05-13T15:45:30+00:00" />
<meta itemprop="dateModified" content="2020-05-13T15:45:30+00:00" />
<meta itemprop="wordCount" content="4049">
<meta itemprop="keywords" content="MongoDB," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MongoDB的评估查询运算符"/>
<meta name="twitter:description" content="$expr 允许在查询语言中使用聚合表达式。 $expr 具有以下语法： 1 { $expr: { &lt;expression&gt; } } 参数可以是任何有效的聚合表达式。有关更多信息，请参见表达式。 特性 $expr可"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Forz Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav><li style="display:inline-block;margin-right:10px;">
  <input type="search" class="docsearch-input" placeholder="Search" />
</li>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">MongoDB的评估查询运算符</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-05-13 </span>
        <div class="post-category">
            <a href="/categories/mongodb/"> MongoDB </a>
            </div>
          <span class="more-meta"> 约 4049 字 </span>
          <span class="more-meta"> 预计阅读 9 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#特性">特性</a></li>
    <li><a href="#例子">例子</a>
      <ul>
        <li><a href="#比较单个文档中的两个字段">比较单个文档中的两个字段</a></li>
        <li><a href="#expr与条件语句一起使用">$expr与条件语句一起使用</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#例子-1">例子</a>
      <ul>
        <li><a href="#使用mod来选择文件">使用$mod来选择文件</a></li>
        <li><a href="#没有足够的元素错误">没有足够的元素错误</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#options">$options</a></li>
    <li><a href="#特性-1">特性</a>
      <ul>
        <li><a href="#-regex-vs-pattern">$ regex vs /pattern/</a></li>
        <li><a href="#pcre-vs-javascript">PCRE VS JavaScript</a></li>
        <li><a href="#regex和not">$regex和$not</a></li>
        <li><a href="#索引使用">索引使用</a></li>
      </ul>
    </li>
    <li><a href="#例子-2">例子</a>
      <ul>
        <li><a href="#执行like匹配">执行LIKE匹配</a></li>
        <li><a href="#执行不区分大小写的正则表达式匹配">执行不区分大小写的正则表达式匹配</a></li>
        <li><a href="#从指定模式开始的行的多行匹配">从指定模式开始的行的多行匹配</a></li>
        <li><a href="#使用点字符来匹配">使用.点字符来匹配</a></li>
        <li><a href="#忽略pattern中的空格">忽略Pattern中的空格</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="expr">$expr</h1>
<p>允许在查询语言中使用<a href="https://docs.mongodb.com/manual/meta/aggregation-quick-reference/#aggregation-expressions">聚合表达式</a>。</p>
<p>$expr 具有以下语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">expr</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">expression</span><span class="o">&gt;</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>参数可以是任何有效的聚合表达式。有关更多信息，请参见<a href="https://docs.mongodb.com/manual/meta/aggregation-quick-reference/#aggregation-expressions">表达式</a>。</p>
<h2 id="特性">特性</h2>
<p><code>$expr</code>可以构建查询表达式，以比较<code>$match</code>阶段中同一文档中的字段。</p>
<p>如果<code>$match</code>阶段是阶段的一部分<code>$lookup</code>，则 <code>$expr</code>可以使用let变量比较字段。有关示例，请参见 使用<code>$lookup</code>指定多个联接条件。</p>
<p><code>$expr</code>不支持多键索引。</p>
<h2 id="例子">例子</h2>
<h3 id="比较单个文档中的两个字段">比较单个文档中的两个字段</h3>
<p>考虑包含monthlyBudget以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;food&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">450</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;drinks&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">150</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;clothes&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">50</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;misc&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">300</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;travel&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span><span class="p">:</span> <span class="mi">650</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作用于$expr查找spent超过budget的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.monthlyBudget.find</span><span class="p">(</span> <span class="p">{</span> <span class="o">$</span><span class="n">expr</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gt</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;$spent&#34;</span> <span class="p">,</span> <span class="s">&#34;$budget&#34;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作返回以下结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;food&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span> <span class="p">:</span> <span class="mi">400</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span> <span class="p">:</span> <span class="mi">450</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;drinks&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span> <span class="p">:</span> <span class="mi">150</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&#34;category&#34;</span> <span class="p">:</span> <span class="s2">&#34;travel&#34;</span><span class="p">,</span> <span class="nt">&#34;budget&#34;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="nt">&#34;spent&#34;</span> <span class="p">:</span> <span class="mi">650</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="expr与条件语句一起使用">$expr与条件语句一起使用</h3>
<p>某些查询要求在定义查询过滤器时能够执行条件逻辑。聚合框架为<code>$cond</code>运算符提供了 表达条件语句的方法。通过<code>$expr</code>与<code>$cond</code>运算符一起使用 ，可以为查询语句指定条件过滤器。</p>
<p>supplies使用以下文档创建样本集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.supplies.insertMany</span><span class="p">(</span><span class="n">[</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;binder&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;100&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;12&#34;</span><span class="p">)</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;notebook&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;200&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;8&#34;</span><span class="p">)</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">3</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;pencil&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;50&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;6&#34;</span><span class="p">)</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">4</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;eraser&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;150&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;3&#34;</span><span class="p">)</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">5</span><span class="p">,</span> <span class="s">&#34;item&#34;</span> <span class="o">:</span> <span class="s">&#34;legal pad&#34;</span><span class="p">,</span> <span class="s">&#34;qty&#34;</span> <span class="o">:</span> <span class="nf">NumberInt</span><span class="p">(</span><span class="s">&#34;42&#34;</span><span class="p">),</span> <span class="s">&#34;price&#34;</span> <span class="o">:</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;10&#34;</span><span class="p">)</span> <span class="p">}</span>
<span class="n">]</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>假设要在下个月进行的销售，您需要对价格进行折价，使得：</p>
<ul>
<li>如果qty大于或等于100，则折扣价price为0.5。</li>
<li>如果qty小于100，则折价price为的0.75。</li>
</ul>
<p>在应用折扣之前，您想知道supplies集合中的哪些项目的折扣价小于5。</p>
<p>以下示例使用<code>$expr</code>和<code>$cond</code>来基于qty和$lt计算折扣价，并返回其折扣价小于NumberDecimal(&ldquo;5&rdquo;)的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">//</span> <span class="n">Aggregation</span> <span class="n">expression</span> <span class="n">to</span> <span class="n">calculate</span> <span class="n">discounted</span> <span class="n">price</span>

<span class="n">let</span> <span class="n">discountedPrice</span> <span class="o">=</span> <span class="p">{</span>
   <span class="o">$</span><span class="n">cond</span><span class="o">:</span> <span class="p">{</span>
      <span class="n">if</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="n">[</span><span class="s">&#34;$qty&#34;</span><span class="p">,</span> <span class="m">100</span><span class="n">]</span> <span class="p">},</span>
      <span class="n">then</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">multiply</span><span class="o">:</span> <span class="n">[</span><span class="s">&#34;$price&#34;</span><span class="p">,</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;0.50&#34;</span><span class="p">)</span><span class="n">]</span> <span class="p">},</span>
      <span class="n">else</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">multiply</span><span class="o">:</span> <span class="n">[</span><span class="s">&#34;$price&#34;</span><span class="p">,</span> <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;0.75&#34;</span><span class="p">)</span><span class="n">]</span> <span class="p">}</span>
   <span class="p">}</span>
<span class="p">};</span>

<span class="o">//</span> <span class="n">Query</span> <span class="n">the</span> <span class="n">supplies</span> <span class="n">collection</span> <span class="n">using</span> <span class="n">the</span> <span class="n">aggregation</span> <span class="n">expression</span>

<span class="nf">db.supplies.find</span><span class="p">(</span> <span class="p">{</span> <span class="o">$</span><span class="n">expr</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">lt</span><span class="o">:</span><span class="n">[</span> <span class="n">discountedPrice</span><span class="p">,</span>  <span class="nf">NumberDecimal</span><span class="p">(</span><span class="s">&#34;5&#34;</span><span class="p">)</span> <span class="n">]</span> <span class="p">}</span> <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><p>下表显示了每个文档的折扣价以及折扣价是否小于NumberDecimal(&ldquo;5&rdquo;)（即，文档是否满足查询条件）。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200513200449.png" alt=""></p>
<p>即使$cond计算出有效的折价，该价格也不会反映在返回的数据中。而是返回的文档以其原始状态表示匹配的文档。查找操作未返回legal,binder文件，因为它们的折扣价大于5。</p>
<h1 id="jsonschema">$jsonSchema</h1>
<p><code>$jsonSchema</code>匹配满足指定JSON Schema文档。</p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/">https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/</a></p>
<h1 id="mod">$mod</h1>
<p>选择filed除以除数的字段的值具有指定余数的文档（即执行模运算以选择文档）。要指定<code>$mod</code>表达式，请使用以下语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">field</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">mod</span><span class="o">:</span> <span class="n">[</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">remainder</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>$mod</code>当传递的元素少于或多于两个的数组时，运算符会出错。</p>
<h2 id="例子-1">例子</h2>
<h3 id="使用mod来选择文件">使用$mod来选择文件</h3>
<p>考虑inventory包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;xyz123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;ijk123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">12</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，以下查询选择inventory集合中qty模 取值4等于的那些文档 0：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">qty</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">mod</span><span class="o">:</span> <span class="n">[</span> <span class="m">4</span><span class="p">,</span> <span class="m">0</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询返回以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;ijk123&#34;</span><span class="p">,</span> <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">12</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="没有足够的元素错误">没有足够的元素错误</h3>
<p>$mod传递少于两个元素的数组时，运算符会出错。</p>
<h4 id="单元素数组">单元素数组</h4>
<p>以下操作错误地向$mod运算符传递了包含单个元素的数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">qty</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">mod</span><span class="o">:</span> <span class="n">[</span> <span class="m">4</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该语句导致以下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">error:</span> <span class="p">{</span>
     <span class="nt">&#34;$err&#34;</span> <span class="p">:</span> <span class="s2">&#34;bad query: BadValue malformed mod, not enough elements&#34;</span><span class="p">,</span>
     <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">16810</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="空数组">空数组</h4>
<p>以下操作错误地向$mod运算符传递了一个空数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">qty</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">mod</span><span class="o">:</span> <span class="n">[</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该语句导致以下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">error:</span> <span class="p">{</span>
     <span class="nt">&#34;$err&#34;</span> <span class="p">:</span> <span class="s2">&#34;bad query: BadValue malformed mod, not enough elements&#34;</span><span class="p">,</span>
     <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">16810</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="元素过多错误">元素过多错误</h4>
<p>$mod传递具有两个以上元素的数组时，运算符会出错。</p>
<p>例如，以下操作尝试将$mod 运算符与包含四个元素的数组一起使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">error:</span> <span class="p">{</span>
     <span class="nt">&#34;$err&#34;</span> <span class="p">:</span> <span class="s2">&#34;bad query: BadValue malformed mod, too many elements&#34;</span><span class="p">,</span>
     <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">16810</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="regex">$regex</h1>
<p>为查询中的模式匹配字符串提供正则表达式功能 。MongoDB使用具有UTF-8支持的Perl兼容正则表达式（即“PCRE”）版本8.42。</p>
<p>要使用$regex，请使用以下语法之一：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="err">&lt;field&gt;:</span> <span class="err">{</span> <span class="err">$regex:</span> <span class="err">/pattern/,</span> <span class="err">$options:</span> <span class="err">&#39;&lt;options&gt;&#39;</span> <span class="p">}</span> <span class="err">}</span>
<span class="p">{</span> <span class="err">&lt;field&gt;:</span> <span class="err">{</span> <span class="err">$regex:</span> <span class="err">&#39;pattern&#39;,</span> <span class="err">$options:</span> <span class="err">&#39;&lt;options&gt;&#39;</span> <span class="p">}</span> <span class="err">}</span>
<span class="p">{</span> <span class="err">&lt;field&gt;:</span> <span class="err">{</span> <span class="err">$regex:</span> <span class="err">/pattern/&lt;options&gt;</span> <span class="p">}</span> <span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在MongoDB中，您还可以使用正则表达式对象（即 /pattern/）来指定正则表达式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="err">&lt;field&gt;:</span> <span class="err">/pattern/&lt;options&gt;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="options">$options</h2>
<p>以下内容<code>&lt;options&gt;</code>可用于正则表达式。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
<th>语法限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>i</td>
<td>不区分大小写，以匹配大小写。</td>
<td></td>
</tr>
<tr>
<td>m</td>
<td>对于包含锚点的模式（即^开始， $结束），请在每行的开头或结尾匹配具有多行值的字符串。如果没有此选项，这些锚点将在字符串的开头或结尾匹配。如果模式不包含锚点，或者字符串值不包含换行符（例如\n），则该m选项无效。</td>
<td></td>
</tr>
<tr>
<td>x</td>
<td>“扩展”功能可以忽略模式中的所有空白字符，$regex除非转义或包含在字符类中。此外，它会忽略中间的字符，包括未转义的井号/磅（#）字符和下一个新行，因此您可以在复杂模式中添加注释。这仅适用于数据字符；空格字符永远不会出现在图案的特殊字符序列中。该x选项不影响VT字符（即代码11）的处理。</td>
<td>需要<code>$regex</code>与<code>$options</code>语法</td>
</tr>
<tr>
<td>s</td>
<td>允许点字符（即.）匹配所有字符，包括换行符。</td>
<td>需要<code>$regex</code>与<code>$options</code>语法</td>
</tr>
</tbody>
</table>
<h2 id="特性-1">特性</h2>
<h3 id="-regex-vs-pattern">$ regex vs /pattern/</h3>
<h4 id="in表达式">$in表达式</h4>
<p>要在<code>$in</code>查询表达式中包含正则表达式，您只能使用JavaScript正则对象（即/pattern/ ）。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">in</span><span class="o">:</span> <span class="n">[</span> <span class="o">/</span><span class="n">^acme</span><span class="o">/</span><span class="n">i</span><span class="p">,</span> <span class="o">/</span><span class="n">^ack</span><span class="o">/</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>您不能在中使用$regex运算符表达式$in。</p>
<h4 id="隐and条件字段">隐AND条件字段</h4>
<p>要将正则表达式包含在该字段的查询条件的逗号分隔列表中，请使用$regex运算符。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">acme.</span><span class="o">*</span><span class="n">corp</span><span class="o">/</span><span class="n">i</span><span class="p">,</span> <span class="o">$</span><span class="n">nin</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#39;acmeblahcorp&#39;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">acme.</span><span class="o">*</span><span class="n">corp</span><span class="o">/</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="o">$</span><span class="n">nin</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#39;acmeblahcorp&#39;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="s">&#39;acme.*corp&#39;</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#39;i&#39;</span><span class="p">,</span> <span class="o">$</span><span class="n">nin</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#39;acmeblahcorp&#39;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="x和s选项">x和s选项</h4>
<p>要使用任一x选项或s选项，则必须使用 <code>$regex</code>与该<code>$options</code>。例如，要指定i和s选项，必须同时使用$options：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">acme.</span><span class="o">*</span><span class="n">corp</span><span class="o">/</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#34;si&#34;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="s">&#39;acme.*corp&#39;</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#34;si&#34;</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="pcre-vs-javascript">PCRE VS JavaScript</h3>
<p>要在regex模式中使用JavaScript不支持的PCRE支持的功能，必须将<code>$regex</code>运算符表达式与模式一起用作字符串。例如，要在模式中使用(?i) 来为剩余的模式打开不区分大小写并为剩余的模式(?-i)打开区分大小写，您必须$regex将该模式的运算符用作字符串：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="s">&#39;(?i)a(?-i)cme&#39;</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="regex和not">$regex和$not</h3>
<p>从4.0.7版开始，$not可以对以下两种方式执行NOT逻辑操作：</p>
<p>正则表达式对象（即/pattern/）</p>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">item</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">not</span><span class="o">:</span> <span class="o">/</span><span class="n">^p.</span><span class="o">*/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>$regex 运算符表达式（从MongoDB 4.0.7开始）:</p>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">item</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">not</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="s">&#34;^p.*&#34;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
<span class="nf">db.inventory.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">item</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">not</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">^p.</span><span class="o">*/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>在4.0.6及更低版本中，您可以将<code>$not</code>运算符与正则表达式对象（即/pattern/）一起使用，但不能与<code>$regex</code>运算符表达式一起使用。</p>
<h3 id="索引使用">索引使用</h3>
<p>对于区分大小写的正则表达式查询，如果该字段存在索引，则MongoDB会将正则表达式与索引中的值进行匹配，这可能比集合扫描更快。如果正则表达式是“前缀表达式”，则可能会发生进一步的优化，这意味着所有潜在的匹配都以相同的字符串开头。这允许MongoDB从该前缀构造一个“范围”，并且仅与该范围内的索引值匹配。</p>
<p>如果正则表达式以尖号（^）或左锚（\A）开头，后跟一串简单符号，则为“前缀表达式” 。例如，<code>/^abc.*/</code>将仅通过匹配索引中以开头的值来优化正则表达式abc。</p>
<p>此外，虽然<code>/^a/</code>，<code>/^a.*/</code>和<code>/^a.*$</code>/匹配等效的字符串，但它们具有不同的性能特征。如果存在适当的索引，则所有这些表达式都使用索引；但是，<code>/^a.*/</code>和<code>/^a.*$/</code>较慢。<code>/^a/</code>匹配前缀后可以停止扫描。</p>
<p>不区分大小写的正则表达式查询通常不能有效地使用索引。该<code>$regex</code>实现不支持排序规则，并且无法使用不区分大小写的索引。</p>
<h2 id="例子-2">例子</h2>
<p>以下示例将集合products与以下文档结合使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">{ &#34;_id&#34; : 100, &#34;sku&#34; : &#34;abc123&#34;, &#34;description&#34; : &#34;Single line description.&#34; }
{ &#34;_id&#34; : 101, &#34;sku&#34; : &#34;abc789&#34;, &#34;description&#34; : &#34;First line\nSecond line&#34; }
{ &#34;_id&#34; : 102, &#34;sku&#34; : &#34;xyz456&#34;, &#34;description&#34; : &#34;Many spaces before     line&#34; }
{ &#34;_id&#34; : 103, &#34;sku&#34; : &#34;xyz789&#34;, &#34;description&#34; : &#34;Multiple\nline description&#34; }
</code></pre></td></tr></table>
</div>
</div><h3 id="执行like匹配">执行LIKE匹配</h3>
<p>以下示例匹配sku字段类似的所有文档&quot;%789&quot;：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">sku</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="m">789</span><span class="o">$/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该示例类似于以下SQL LIKE语句：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">products</span><span class="w">
</span><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">sku</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s2">&#34;%789&#34;</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="执行不区分大小写的正则表达式匹配">执行不区分大小写的正则表达式匹配</h3>
<p>以下示例使用i选项对sku值以开头的文档执行 不区分大小写的匹配ABC。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">sku</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">^ABC</span><span class="o">/</span><span class="n">i</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Single line description.&#34;</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc789&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;First line\nSecond line&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="从指定模式开始的行的多行匹配">从指定模式开始的行的多行匹配</h3>
<p>以下示例使用该m选项来匹配S多行字符串以字母开头的行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">description</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">^S</span><span class="o">/</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#39;m&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Single line description.&#34;</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc789&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;First line\nSecond line&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果没有该m选项，则查询将仅匹配以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Single line description.&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果该$regex模式不包含锚，则该模式将与整个字符串匹配，如以下示例所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">description</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">S</span><span class="o">/</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，$regex将匹配两个文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc123&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Single line description.&#34;</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">101</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;abc789&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;First line\nSecond line&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="使用点字符来匹配">使用.点字符来匹配</h3>
<p>以下示例使用允许点字符（即.）匹配所有字符（包括换行符）的s选项以及执行不区分大小写的匹配的i选项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">description</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="o">/</span><span class="n">m.</span><span class="o">*</span><span class="n">line</span><span class="o">/</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#39;si&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;xyz456&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Many spaces before     line&#34;</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">103</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;xyz789&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Multiple\nline description&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果没有该s选项，则查询将仅与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">102</span><span class="p">,</span> <span class="nt">&#34;sku&#34;</span> <span class="p">:</span> <span class="s2">&#34;xyz456&#34;</span><span class="p">,</span> <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Many spaces before     line&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="忽略pattern中的空格">忽略Pattern中的空格</h3>
<p>以下示例使用x选项“忽略空白”和注释，在匹配模式中以#表示并以\n结尾：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">var</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s">&#34;abc #category code\n123 #item number&#34;</span>
<span class="nf">db.products.find</span><span class="p">(</span> <span class="p">{</span> <span class="n">sku</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">regex</span><span class="o">:</span> <span class="n">pattern</span><span class="p">,</span> <span class="o">$</span><span class="n">options</span><span class="o">:</span> <span class="s">&#34;x&#34;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该查询与以下文档匹配：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">100</span><span class="p">,</span> <span class="s">&#34;sku&#34;</span> <span class="o">:</span> <span class="s">&#34;abc123&#34;</span><span class="p">,</span> <span class="s">&#34;description&#34;</span> <span class="o">:</span> <span class="s">&#34;Single line description.&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="text">$text</h1>
<p><code>$text</code>对用文本索引索引的字段的内容进行文本搜索。</p>
<p><a href="https://docs.mongodb.com/manual/reference/operator/query/text/">https://docs.mongodb.com/manual/reference/operator/query/text/</a></p>
<h1 id="where">$where</h1>
<p>使用<code>$where</code>运算符将包含JavaScript表达式的字符串或完整的JavaScript函数传递给查询系统。在<code>$where</code>提供了更大的灵活性，但无法利用索引。因此，当您使用标准MongoDB运算符（例如<code>$gt</code>，<code>$in</code>）来表达查询时，查询性能将会提高。</p>
<p>重要</p>
<p>在版本3.6中更改：<code>$expr</code>运算符允许在查询语言中使用聚合表达式。 <code>$expr</code>比<code>$where</code>快，因为它不执行JavaScript，因此应尽可能首选。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-05-13
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/mongodb/">MongoDB</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/mongodb%E7%9A%84%E6%95%B0%E7%BB%84%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">MongoDB的数组查询运算符</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/mongodb%E7%9A%84%E5%85%83%E7%B4%A0%E6%9F%A5%E8%AF%A2%E8%BF%90%E7%AE%97%E7%AC%A6/">
            <span class="next-text nav-default">MongoDB的元素查询运算符</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Forz</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>






<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
docsearch({
    apiKey: "b4b9da2eba53aa6dabe4b8ac9e8676e1",
    indexName: "forz.forzvina.com",
    appId: "IAR2EF5L65",
    inputSelector: '.docsearch-input',
    debug: false,
});
</script>
</body>
</html>
