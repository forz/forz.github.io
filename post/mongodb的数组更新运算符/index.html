<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MongoDB的数组更新运算符 | Forz Blog</title>
<meta name="keywords" content="MongoDB" />
<meta name="description" content="$ $运算符标识要更新的数组中的元素，而无需显式指定数组中元素的位置。 消歧 要通过读取操作$投影或返回数组元素，请参阅投影运算符。 要更新数组中的">
<meta name="author" content="">
<link rel="canonical" href="/post/mongodb%E7%9A%84%E6%95%B0%E7%BB%84%E6%9B%B4%E6%96%B0%E8%BF%90%E7%AE%97%E7%AC%A6/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="MongoDB的数组更新运算符" />
<meta property="og:description" content="$ $运算符标识要更新的数组中的元素，而无需显式指定数组中元素的位置。 消歧 要通过读取操作$投影或返回数组元素，请参阅投影运算符。 要更新数组中的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/mongodb%E7%9A%84%E6%95%B0%E7%BB%84%E6%9B%B4%E6%96%B0%E8%BF%90%E7%AE%97%E7%AC%A6/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-14T16:54:36&#43;00:00" />
<meta property="article:modified_time" content="2020-05-14T16:54:36&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MongoDB的数组更新运算符"/>
<meta name="twitter:description" content="$ $运算符标识要更新的数组中的元素，而无需显式指定数组中元素的位置。 消歧 要通过读取操作$投影或返回数组元素，请参阅投影运算符。 要更新数组中的"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "MongoDB的数组更新运算符",
      "item": "/post/mongodb%E7%9A%84%E6%95%B0%E7%BB%84%E6%9B%B4%E6%96%B0%E8%BF%90%E7%AE%97%E7%AC%A6/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MongoDB的数组更新运算符",
  "name": "MongoDB的数组更新运算符",
  "description": "$ $运算符标识要更新的数组中的元素，而无需显式指定数组中元素的位置。 消歧 要通过读取操作$投影或返回数组元素，请参阅投影运算符。 要更新数组中的",
  "keywords": [
    "MongoDB"
  ],
  "articleBody": "$ $运算符标识要更新的数组中的元素，而无需显式指定数组中元素的位置。\n消歧\n 要通过读取操作$投影或返回数组元素，请参阅投影运算符。 要更新数组中的所有元素，请参阅all位置运算符 $[]。 要更新所有符合一个或多个数组过滤条件的元素，请参阅过滤后的位置运算符 $[]。  $运算符的格式为：\n1  { \".$\" : value }   与更新操作（例如 db.collection.update()和 db.collection.findAndModify()）一起使用时\n 位置$运算符充当与查询文档匹配的第一个元素的占位符 数组字段必须作为查询文档的一部分出现。  例如：\n1 2 3 4  db.collection.update( { array: value ... }, { update operator: { \".$\" : value } } )   特性 upsert 不要将位置运算符$与upsert操作一起使用，因为插入操作会将$用作插入文档中的字段名称。\n嵌套数组 位置$运算符不能用于遍历一个以上数组的查询，例如遍历嵌套在其他数组中的数组的查询，因为$占位符的替换是单个值\nUnsets 与$unset运算符一起使用时，位置$运算符不会从数组中删除匹配的元素，而是将其设置为null。\n否定 如果查询使用否定运算符，如$ne，$not或者$nin，那么您将无法使用位置运算符来更新此数组中的值。\n但是，如果查询的否定部分在$elemMatch表达式内，则可以使用位置运算符更新此字段。\n例子 数组中的更新值 students使用以下文档创建一个集合：\n1 2 3 4 5  db.students.insert([ { \"_id\" : 1, \"grades\" : [ 85, 80, 80 ] }, { \"_id\" : 2, \"grades\" : [ 88, 90, 92 ] }, { \"_id\" : 3, \"grades\" : [ 85, 100, 90 ] } ])   要更新grades数组中第一个值为80到82的元素，如果您不知道该元素在数组中的位置，请使用$运算符：\n重要:您必须将数组字段包含在query文档中。\n1 2 3 4  db.students.updateOne( { _id: 1, grades: 80 }, { $set: { \"grades.$\" : 82 } } )   位置$运算符充当更新查询文档的第一个匹配项的占位符 。\n操作后，students集合包含以下文档：\n1 2 3  { \"_id\" : 1, \"grades\" : [ 85, 82, 80 ] } { \"_id\" : 2, \"grades\" : [ 88, 90, 92 ] } { \"_id\" : 3, \"grades\" : [ 85, 100, 90 ] }   更新数组中的文档 位置$运算符有助于更新包含嵌入式文档的数组。使用位置$运算符可使用$运算符上的点符号访问嵌入文档中的字段。\n1 2 3 4  db.collection.update( { query selector }, { update operator: { \"array.$.field\" : value } } )   请考虑students集合中的以下文档，该文档的 grades元素值为嵌入式文档的数组：\n1 2 3 4 5 6 7 8  { _id: 4, grades: [ { grade: 80, mean: 75, std: 8 }, { grade: 85, mean: 90, std: 5 }, { grade: 85, mean: 85, std: 8 } ] }   使用位置$运算符更新std匹配grade等于85条件的第一个数组元素的字段：\n重要\n您必须将数组字段包含在query文档中。\n1 2 3 4  db.students.updateOne( { _id: 4, \"grades.grade\": 85 }, { $set: { \"grades.$.std\" : 6 } } )   操作后，文档具有以下更新值：\n1 2 3 4 5 6 7 8  { \"_id\" : 4, \"grades\" : [ { \"grade\" : 80, \"mean\" : 75, \"std\" : 8 }, { \"grade\" : 85, \"mean\" : 90, \"std\" : 6 }, { \"grade\" : 85, \"mean\" : 85, \"std\" : 8 } ] }   使用多个字段匹配更新嵌入式文档 $运算符可以更新与$elemMatch（）运算符指定的多个查询条件匹配的第一个数组元素。\n考虑students集合中的以下文档，该文档的grades字段值为嵌入式文档的数组：\n1 2 3 4 5 6 7 8  { _id: 5, grades: [ { grade: 80, mean: 75, std: 8 }, { grade: 85, mean: 90, std: 5 }, { grade: 90, mean: 85, std: 3 } ] }   在下面的示例中，$运算符更新第一个嵌入式文档中std字段的值，该字段的等级字段的值小于或等于90，而平均值字段的值大于80：\n1 2 3 4 5 6 7  db.students.updateOne( { _id: 5, grades: { $elemMatch: { grade: { $lte: 90 }, mean: { $gt: 80 } } } }, { $set: { \"grades.$.std\" : 6 } } )   此操作将更新符合条件的第一个嵌入式文档，即数组中的第二个嵌入式文档：\n1 2 3 4 5 6 7 8 9 10  { _id: 5, grades: [ { grade: 80, mean: 75, std: 8 }, { grade: 85, mean: 90, std: 6 }, { grade: 90, mean: 85, std: 3 } ] }   $[] 3.6版的新功能。\nall位置运算符$[]指示update运算符应修改指定数组字段中的所有元素。\n$[]具有下列形式：\n1  { update operator: { \".$[]\" : value } }   用于更新操作（例如db.collection.update()和 db.collection.findAndModify()）来修改一个或多个查询条件匹配的文档的所有数组元素。例如：\n1 2 3 4  db.collection.updateMany( { query conditions }, { update operator: { \".$[]\" : value } } )   特性 upsert 如果upsert操作导致插入，则query必须在array字段上包含完全相等的匹配项，以便$[]在update语句中使用位置运算符。\n例如，$[]在更新文档中使用的以下upsert操作在array字段上指定完全相等的匹配条件：\n1 2 3 4 5  db.collection.update( { myArray: [ 5, 8 ] }, { $set: { \"myArray.$[]\": 10 } }, { upsert: true } )   如果不存在此类文档，则该操作将导致插入以下文档：\n1  { \"_id\" : ObjectId(...), \"myArray\" : [ 10, 10 ] }   如果upsert操作不包括完全相等的匹配项，并且找不到匹配的文档要更新，则upsert操作将出错。\n例如，如果找不到匹配的文档来更新，则以下操作将出错：\n1 2 3 4 5 6 7 8 9 10 11  db.collection.update( { myArray: 5 }, { $set: { \"myArray.$[]\": 10 } }, { upsert: true } ) db.collection.update( { }, { $set: { \"myArray.$[]\": 10 } }, { upsert: true } )   嵌套数组 该$[]运算符可用于遍历多个数组和嵌套数组的查询。\n例子 更新数组中的所有元素 考虑students包含以下文档的集合：\n1 2 3  { \"_id\" : 1, \"grades\" : [ 85, 82, 80 ] } { \"_id\" : 2, \"grades\" : [ 88, 90, 92 ] } { \"_id\" : 3, \"grades\" : [ 85, 100, 90 ] }   要为集合中的所有文档增加grades数组中的所有元素10，请使用$[]运算符：\n1 2 3 4 5  db.students.update( { }, { $inc: { \"grades.$[]\": 10 } }, { multi: true } )   所有位置的$[]运算符都充当array字段中所有元素的占位符。\n操作后，students集合包含以下文档：\n1 2 3  { \"_id\" : 1, \"grades\" : [ 95, 92, 90 ] } { \"_id\" : 2, \"grades\" : [ 98, 100, 102 ] } { \"_id\" : 3, \"grades\" : [ 95, 110, 100 ] }   更新数组中的所有文档 $[]操作方便的更新包含嵌入文档数组。要访问嵌入文档中的字段，请在运算符$[]上使用点符号。\n1 2 3 4  db.collection.update( { query selector }, { update operator: { \"array.$[].field\" : value } } )   考虑students2包含以下文档的集合：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  { \"_id\" : 1, \"grades\" : [ { \"grade\" : 80, \"mean\" : 75, \"std\" : 8 }, { \"grade\" : 85, \"mean\" : 90, \"std\" : 6 }, { \"grade\" : 85, \"mean\" : 85, \"std\" : 8 } ] } { \"_id\" : 2, \"grades\" : [ { \"grade\" : 90, \"mean\" : 75, \"std\" : 8 }, { \"grade\" : 87, \"mean\" : 90, \"std\" : 5 }, { \"grade\" : 85, \"mean\" : 85, \"std\" : 6 } ] }   要为grades数组中的所有元素修改std字段的值，请使用位置$[]运算符：\n1 2 3 4 5  db.students2.update( { }, { $inc: { \"grades.$[].std\" : -2 } }, { multi: true } )   操作后，集合具有以下文档：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  { \"_id\" : 1, \"grades\" : [ { \"grade\" : 80, \"mean\" : 75, \"std\" : 6 }, { \"grade\" : 85, \"mean\" : 90, \"std\" : 4 }, { \"grade\" : 85, \"mean\" : 85, \"std\" : 6 } ] } { \"_id\" : 2, \"grades\" : [ { \"grade\" : 90, \"mean\" : 75, \"std\" : 6 }, { \"grade\" : 87, \"mean\" : 90, \"std\" : 3 }, { \"grade\" : 85, \"mean\" : 85, \"std\" : 4 } ] }   使用否定查询运算符更新指定的数组 考虑results包含以下文档的集合：\n1 2 3  { \"_id\" : 1, \"grades\" : [ 85, 82, 80 ] } { \"_id\" : 2, \"grades\" : [ 88, 90, 92 ] } { \"_id\" : 3, \"grades\" : [ 85, 100, 90 ] }   要使所有文档的等级数组中的所有元素增加10，等级数组中值为100的元素除外，请使用$[]运算符：\n1 2 3 4 5  db.results.update( { \"grades\" : { $ne: 100 } }, { $inc: { \"grades.$[]\": 10 } }, { multi: true } )   $[]运算符充当数组字段中所有元素的占位符。\n操作后，students集合包含以下文档：\n1 2 3  { \"_id\" : 1, \"grades\" : [ 95, 92, 90 ] } { \"_id\" : 2, \"grades\" : [ 98, 100, 102 ] } { \"_id\" : 3, \"grades\" : [ 85, 100, 90 ] }   与$[]一起更新嵌套数组 $[]位置运算符与过滤器$[]位置运算符一起可用于更新嵌套数组。\nstudents3使用以下文档创建一个集合：\n1 2 3 4 5 6 7 8 9 10  db.students3.insert([ { \"_id\" : 1, \"grades\" : [ { type: \"quiz\", questions: [ 10, 8, 5 ] }, { type: \"quiz\", questions: [ 8, 9, 6 ] }, { type: \"hw\", questions: [ 5, 4, 3 ] }, { type: \"exam\", questions: [ 25, 10, 23, 0 ] }, ] } ])   要更新嵌套的grades.questions数组中所有大于或等于8的值，而不管类型如何：\n1 2 3 4 5  db.students3.update( {}, { $inc: { \"grades.$[].questions.$[score]\": 2 } }, { arrayFilters: [ { \"score\": { $gte: 8 } } ], multi: true} )   $[] 3.6版的新功能。\n过滤后的位置运算符$[]标识与arrayFilters条件匹配的数组元素以进行更新操作，例如db.collection.update()和 db.collection.findAndModify()。\n与该arrayFilters选项结合使用,$[]运算符具有以下形式：\n1 2  { update operator: { \".$[]\" : value } }, { arrayFilters: [ { identifier: condition } ] }   与arrayFilters选项结合使用，以更新一个或多个与查询条件匹配的文档中所有与arrayFilters条件匹配的元素。例如：\n1 2 3 4 5  db.collection.updateMany( { }, { : { \".$[]\" : value } }, { arrayFilters: [ { :  } ] } )   注意\n在必须以小写字母开头，并且只包含字母数字字符。\n特性 upsert 如果upsert操作导致插入，则query必须在array字段上包含完全相等的匹配项才能在update语句中使用$[]。\n例如，$[]在更新文档中使用的以下upsert操作在array字段上指定完全相等的匹配条件：\n1 2 3 4 5 6  db.collection.update( { myArray: [ 0, 1 ] }, { $set: { \"myArray.$[element]\": 2 } }, { arrayFilters: [ { element: 0 } ], upsert: true } )   如果不存在这样的文档，则该操作将导致插入类似于以下内容的文档：\n1  { \"_id\" : ObjectId(...), \"myArray\" : [ 2, 1 ] }   如果upsert操作不包括完全相等的匹配项，并且找不到匹配的文档要更新，则upsert操作将出错。例如，如果找不到匹配的文档来更新，则以下操作将出错：\n1 2 3 4 5 6  db.array.update( { }, { $set: { \"myArray.$[element]\": 10 } }, { arrayFilters: [ { element: 9 } ], upsert: true } )   该操作将返回类似于以下内容的错误：\n1 2 3 4 5 6 7 8 9  WriteResult({ \"nMatched\" : 0, \"nUpserted\" : 0, \"nModified\" : 0, \"writeError\" : { \"code\" : 2, \"errmsg\" : \"The path 'myArray' must exist in the document in order to apply array updates.\" } })   嵌套数组 过滤后的位置运算符$[]可用于遍历多个数组和嵌套数组的查询。\n例子 更新所有匹配arrayFilters的数组元素 考虑students包含以下文档的集合：\n1 2 3  { \"_id\" : 1, \"grades\" : [ 95, 92, 90 ] } { \"_id\" : 2, \"grades\" : [ 98, 100, 102 ] } { \"_id\" : 3, \"grades\" : [ 95, 110, 100 ] }   要更新grades数组中所有大于或等于100的元素，请对arrayFilters使用过滤后的位置运算符$[]：\n1 2 3 4 5 6 7  db.students.update( { }, { $set: { \"grades.$[element]\" : 100 } }, { multi: true, arrayFilters: [ { \"element\": { $gte: 100 } } ] } )   位置$[]运算符充当数组字段中与arrayFilters中指定的条件匹配的所有元素的占位符。\n操作后，students集合包含以下文档：\n1 2 3  { \"_id\" : 1, \"grades\" : [ 95, 92, 90 ] } { \"_id\" : 2, \"grades\" : [ 98, 100, 100 ] } { \"_id\" : 3, \"grades\" : [ 95, 100, 100 ] }   更新arrayFilters数组中所有匹配的文档 该$[]操作有利于更新包含嵌入文档数组。要访问嵌入文档中的字段，使用点符号上$[]。\n1 2 3 4 5  db.collection.update( { query selector }, { update operator: { \"array.$[].field\" : value } }, { arrayFilters: [ { identifier: condition } } ] } )   考虑students2包含以下文档的集合：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  { \"_id\" : 1, \"grades\" : [ { \"grade\" : 80, \"mean\" : 75, \"std\" : 6 }, { \"grade\" : 85, \"mean\" : 90, \"std\" : 4 }, { \"grade\" : 85, \"mean\" : 85, \"std\" : 6 } ] } { \"_id\" : 2, \"grades\" : [ { \"grade\" : 90, \"mean\" : 75, \"std\" : 6 }, { \"grade\" : 87, \"mean\" : 90, \"std\" : 3 }, { \"grade\" : 85, \"mean\" : 85, \"std\" : 4 } ] }   要修改grades中mean大于或等于85的grades数组中所有元素的字段，请使用位置$[]运算符和arrayFilters：\n1 2 3 4 5 6 7 8  db.students2.update( { }, { $set: { \"grades.$[elem].mean\" : 100 } }, { multi: true, arrayFilters: [ { \"elem.grade\": { $gte: 85 } } ] } )   操作后，集合具有以下文档：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  { \"_id\" : 1, \"grades\" : [ { \"grade\" : 80, \"mean\" : 75, \"std\" : 6 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 4 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 6 } ] } { \"_id\" : 2, \"grades\" : [ { \"grade\" : 90, \"mean\" : 100, \"std\" : 6 }, { \"grade\" : 87, \"mean\" : 100, \"std\" : 3 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 4 } ] }   更新匹配多个条件的所有数组元素 考虑students2包含以下文档的集合：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  { \"_id\" : 1, \"grades\" : [ { \"grade\" : 80, \"mean\" : 75, \"std\" : 6 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 4 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 6 } ] } { \"_id\" : 2, \"grades\" : [ { \"grade\" : 90, \"mean\" : 100, \"std\" : 6 }, { \"grade\" : 87, \"mean\" : 100, \"std\" : 3 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 4 } ] }   若要修改成绩数组中所有成绩均大于或等于80且std大于或等于5的std字段的值，请使用位置$[]运算符和arrayFilters：\n1 2 3 4 5  db.students2.update( { }, { $inc: { \"grades.$[elem].std\" : -1 } }, { arrayFilters: [ { \"elem.grade\": { $gte: 80 }, \"elem.std\": { $gt: 5 } } ], multi: true } )   操作后，集合具有以下文档：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  { \"_id\" : 1, \"grades\" : [ { \"grade\" : 80, \"mean\" : 75, \"std\" : 5 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 4 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 5 } ] } { \"_id\" : 2, \"grades\" : [ { \"grade\" : 90, \"mean\" : 100, \"std\" : 5 }, { \"grade\" : 87, \"mean\" : 100, \"std\" : 3 }, { \"grade\" : 85, \"mean\" : 100, \"std\" : 4 } ] }   使用求反运算符更新数组元素 考虑alumni包含以下文档的集合：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  { \"_id\": 1, \"name\": \"Christine Franklin\", \"degrees\": [ { \"level\": \"Master\", \"major\": \"Biology\", \"completion_year\": 2010, \"faculty\": \"Science\" }, { \"level\": \"Bachelor\", \"major\": \"Biology\", \"completion_year\": 2008, \"faculty\": \"Science\" } ], \"school_email\": \"cfranklin@example.edu\", \"email\": \"christine@example.com\" } { \"_id\": 2, \"name\": \"Reyansh Sengupta\", \"degrees\": [ { \"level\": \"Bachelor\", \"major\": \"Chemical Engineering\", \"completion_year\": 2002, \"faculty\": \"Engineering\" } ], \"school_email\": \"rsengupta2@example.edu\" }   若要修改度数组中不具有\"level\": \"Bachelor\"的所有元素，请对$ne查询运算符使用位置[]操作\n1 2 3 4 5 6  db.alumni.update( { }, { $set : { \"degrees.$[degree].gradcampaign\" : 1 } }, { arrayFilters : [ {\"degree.level\" : { $ne: \"Bachelor\" } } ], multi : true } )   操作后，集合具有以下文档：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  { \"_id\" : 1, \"name\" : \"Christine Franklin\", \"degrees\" : [ { \"level\" : \"Master\", \"major\" : \"Biology\", \"completion_year\" : 2010, \"faculty\" : \"Science\", \"gradcampaign\" : 1 }, { \"level\" : \"Bachelor\", \"major\" : \"Biology\", \"completion_year\" : 2008, \"faculty\" : \"Science\" } ], \"school_email\" : \"cfranklin@example.edu\", \"email\" : \"christine@example.com\" } { \"_id\" : 2, \"name\" : \"Reyansh Sengupta\", \"degrees\" : [ { \"level\" : \"Bachelor\", \"major\" : \"Chemical Engineering\", \"completion_year\" : 2002, \"faculty\" : \"Engineering\" } ], \"school_email\" : \"rsengupta2@example.edu\" }   与$[]一起更新嵌套数组 $ []过滤后的位置运算符与$[]所有位置运算符一起，可用于更新嵌套数组。\nstudents3使用以下文档创建一个集合：\n1 2 3 4 5 6 7 8 9 10 11  db.students3.insert( { \"_id\" : 1, \"grades\" : [ { type: \"quiz\", questions: [ 10, 8, 5 ] }, { type: \"quiz\", questions: [ 8, 9, 6 ] }, { type: \"hw\", questions: [ 5, 4, 3 ] }, { type: \"exam\", questions: [ 25, 10, 23, 0 ] }, ] } )   如果关联的grades.type字段为quiz，则以下内容将更新嵌套的grades.questions数组中大于或等于8的值。\n1 2 3 4 5  db.students3.update( {}, { $inc: { \"grades.$[t].questions.$[score]\": 2 } }, { arrayFilters: [ { \"t.type\": \"quiz\" } , { \"score\": { $gte: 8 } } ], multi: true} )   操作后，集合具有以下文档：\n1 2 3 4 5 6 7 8 9  { \"_id\" : 1, \"grades\" : [ { \"type\" : \"quiz\", \"questions\" : [ 12, 10, 5 ] }, { \"type\" : \"quiz\", \"questions\" : [ 10, 11, 6 ] }, { \"type\" : \"hw\", \"questions\" : [ 5, 4, 3 ] }, { \"type\" : \"exam\", \"questions\" : [ 25, 10, 23, 0 ] } ] }   要更新所有大于或等于8嵌套grades.questions数组中的值，无视type：\n1 2 3 4 5  db.students3.update( {}, { $inc: { \"grades.$[].questions.$[score]\": 2 } }, { arrayFilters: [ { \"score\": { $gte: 8 } } ], multi: true} )   $addToSet 除非该值已存在，否则$addToSet运算符会向该数组添加一个值，在这种情况下，$addToSet对该数组不执行任何操作。\n该$addToSet的形式为：\n1  { $addToSet: { field1: value1, ... } }   若要在嵌入式文档或数组中指定，请使用点表示法。\n特性 $addToSet仅确保没有重复项添加到集合中，并且不影响现有重复项。 $addToSet不保证修改后的集合中元素的特定顺序。\n缺少字段 如果$addToSet在文档中不存在的字段上进行更新，请$addToSet使用指定值作为元素创建数组字段。\n字段不是数组 如果$addToSet在不是数组的字段上使用，该操作将失败。例如，考虑foo包含非数组字段的集合中的文档 colors。\n1  { _id: 1, colors: \"blue,green,red\" }   $addToSet对非数组字段的以下操作 colors失败：\n1 2 3 4  db.foo.update( { _id: 1 }, { $addToSet: { colors: \"c\" } } )   要添加的值是一个数组 如果该值为数组，则$addToSet将整个数组作为单个元素附加。\n考虑test包含数组字段的集合中的文档letters：\n1  { _id: 1, letters: [\"a\", \"b\"] }   以下操作将数组[“ c”，“ d”]追加到letters字段：\n1 2 3 4  db.test.update( { _id: 1 }, { $addToSet: { letters: [ \"c\", \"d\" ] } } )   letters数组现在包含[“ c”，“ d”]数组作为元素：\n1  { _id: 1, letters: [ \"a\", \"b\", [ \"c\", \"d\" ] ] }   TIP:\n要分别添加值的每个元素，请将$each修饰符与$addToSet一起使用。 有关详细信息，请参见$each修饰符。\n要添加的值是一个文档 如果值为文档，则如果数组中的现有文档与要添加的文档完全匹配，则MongoDB会确定该文档为重复文档；也就是说，现有文档具有完全相同的字段和值，并且字段的顺序相同。因此，字段顺序很重要，您不能指定MongoDB仅比较文档中字段的子集来确定文档是否与现有数组元素重复。\n例子 考虑inventory包含以下文档的集合：\n1  { _id: 1, item: \"polarizing_filter\", tags: [ \"electronics\", \"camera\" ] }   添加到数组 由于数组中不存在此元素\"accessories\"，因此以下操作将tags:“accessories\"添加到数组中：\n1 2 3 4  db.inventory.update( { _id: 1 }, { $addToSet: { tags: \"accessories\" } } )   值已经存在 以下$addToSet操作无效，因为 “camera\"它已经是tags数组的元素：\n1 2 3 4  db.inventory.update( { _id: 1 }, { $addToSet: { tags: \"camera\" } } )   $each修饰符 您可以将$addToSet运算符与$each修饰符一起使用。 $each修饰符允许$addToSet运算符将多个值添加到数组字段。\n集合inventory具有以下文档：\n1  { _id: 2, item: \"cable\", tags: [ \"electronics\", \"supplies\" ] }   然后，以下操作将$addToSet运算符与$each修饰符一起使用，以将多个元素添加到tags数组中：\n1 2 3 4  db.inventory.update( { _id: 2 }, { $addToSet: { tags: { $each: [ \"camera\", \"electronics\", \"accessories\" ] } } } )   操作对tags数组仅增加\"camera\"以及\"accessories”，因为\"electronics\"数组中已经存在：\n1 2 3 4 5  { _id: 2, item: \"cable\", tags: [ \"electronics\", \"supplies\", \"camera\", \"accessories\" ] }   $pop $pop运算符删除数组的第一个或最后一个元素。传递$pop值为-1删除数组的第一个元素，传递1删除数组的最后一个元素。\n$pop的形式为：\n1  { $pop: { field: 1 | 1, ... } }   若要在嵌入式文档或数组中指定，请使用点表示法。\n特性 如果不是数组，则$ pop操作失败。\n如果$pop运算符删除了中的最后一项，则将保存一个空数组。\n例子 删除数组的第一个项目 给定以下文件的集合students：\n1  { _id: 1, scores: [ 8, 9, 10 ] }   以下示例删除了数组中的第一个元素scores（8） ：\n1  db.students.update( { _id: 1 }, { $pop: { scores: -1 } } )   操作后，将scores数组中的第一项删除：\n1  { _id: 1, scores: [ 9, 10 ] }   删除数组的最后一项 给定以下文件的集合students：\n1  { _id: 1, scores: [ 9, 10 ] }   以下示例通过在$ pop表达式中指定1来删除scores数组中的最后一个元素（10）：\n1  db.students.update( { _id: 1 }, { $pop: { scores: 1 } } )   操作后，更新后的文档将最后一个项目10 从其scores数组中删除：\n1  { _id: 1, scores: [ 9 ] }   $pull $pull运算符从现有数组中删除一个或多个与指定条件匹配的值的所有实例。\n$pull运算符的形式为：\n1  { $pull: { field1: value|condition, field2: value|condition, ... } }   若要在嵌入式文档或数组中指定，请使用点表示法。\n特性 如果指定并且数组元素是嵌入式文档，则$pull运算符将应用就像每个数组元素都是集合中的文档一样。\n如果要删除的指定是数组，则$ pull仅删除与指定的完全匹配的数组元素，包括顺序。\n如果要删除的指定是文档，则$ pull仅删除数组中具有完全相同的字段和值的元素。字段的顺序可以不同。\n例子 删除所有等于指定的值的项目 给定stores集合中的以下文档：\n1 2 3 4 5 6 7 8 9 10  { _id: 1, fruits: [ \"apples\", \"pears\", \"oranges\", \"grapes\", \"bananas\" ], vegetables: [ \"carrots\", \"celery\", \"squash\", \"carrots\" ] } { _id: 2, fruits: [ \"plums\", \"kiwis\", \"oranges\", \"bananas\", \"apples\" ], vegetables: [ \"broccoli\", \"zucchini\", \"carrots\", \"onions\" ] }   以下操作更新集合中的所有文档，以从fruits中除去“苹果”和“橙子”，并从vegetables中除去“carrots”：\n1 2 3 4 5  db.stores.update( { }, { $pull: { fruits: { $in: [ \"apples\", \"oranges\" ] }, vegetables: \"carrots\" } }, { multi: true } )   操作之后，fruits数组不再包含任何“apples”或“oranges”值，而蔬菜数组不再包含任何“carrots”值：\n1 2 3 4 5 6 7 8 9 10  { \"_id\" : 1, \"fruits\" : [ \"pears\", \"grapes\", \"bananas\" ], \"vegetables\" : [ \"celery\", \"squash\" ] } { \"_id\" : 2, \"fruits\" : [ \"plums\", \"kiwis\", \"bananas\" ], \"vegetables\" : [ \"broccoli\", \"zucchini\", \"onions\" ] }   删除所有符合指定$pull条件的项目 给定profiles集合中的以下文档：\n1  { _id: 1, votes: [ 3, 5, 6, 7, 7, 8 ] }   下面的操作将从votes数组中删除所有大于或等于（$gte）6的项目：\n1  db.profiles.update( { _id: 1 }, { $pull: { votes: { $gte: 6 } } } )   更新操作后，文档的值仅小于6：\n1  { _id: 1, votes: [ 3, 5 ] }   从文档数组中删除项目 一个survey集合包含以下文件：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  { _id: 1, results: [ { item: \"A\", score: 5 }, { item: \"B\", score: 8, comment: \"Strongly agree\" } ] } { _id: 2, results: [ { item: \"C\", score: 8, comment: \"Strongly agree\" }, { item: \"B\", score: 4 } ] }   以下操作将从results数组中删除所有既包含得分字段等于8又包含item字段等于“B”的元素：\n1 2 3 4 5  db.survey.update( { }, { $pull: { results: { score: 8 , item: \"B\" } } }, { multi: true } )   $pull表达式将条件应用于结果数组的每个元素，就好像它是顶级文档一样。\n操作之后，results数组将不包含score字段等于8且item字段等于“ B”的文档。\n1 2 3 4 5 6 7 8 9 10 11  { \"_id\" : 1, \"results\" : [ { \"item\" : \"A\", \"score\" : 5 } ] } { \"_id\" : 2, \"results\" : [ { \"item\" : \"C\", \"score\" : 8, \"comment\" : \"Strongly agree\" }, { \"item\" : \"B\", \"score\" : 4 } ] }   因为$pull运算符将其查询应用于每个元素，就好像它是顶级对象一样，该表达式不需要使用$elemMatch来指定等于8的score字段和等于“B”的item字段的条件。实际上，以下操作不会从原始集合中提取任何元素。\n1 2 3 4 5  db.survey.update( { }, { $pull: { results: { $elemMatch: { score: 8 , item: \"B\" } } } }, { multi: true } )   但是，如果survey集合包含以下文档，则该results数组包含的嵌入式文档也包含数组：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  { _id: 1, results: [ { item: \"A\", score: 5, answers: [ { q: 1, a: 4 }, { q: 2, a: 6 } ] }, { item: \"B\", score: 8, answers: [ { q: 1, a: 8 }, { q: 2, a: 9 } ] } ] } { _id: 2, results: [ { item: \"C\", score: 8, answers: [ { q: 1, a: 8 }, { q: 2, a: 7 } ] }, { item: \"B\", score: 4, answers: [ { q: 1, a: 0 }, { q: 2, a: 8 } ] } ] }   然后，您可以使用$elemMatch在Answers数组的元素上指定多个条件：\n1 2 3 4 5  db.survey.update( { }, { $pull: { results: { answers: { $elemMatch: { q: 2, a: { $gte: 8 } } } } } }, { multi: true } )   该操作从结果数组中删除了那些包含answer字段的嵌入式文档，这些文档包含至少一个q等于2且大于或等于8的元素：\n1 2 3 4 5 6 7 8 9 10 11 12  { \"_id\" : 1, \"results\" : [ { \"item\" : \"A\", \"score\" : 5, \"answers\" : [ { \"q\" : 1, \"a\" : 4 }, { \"q\" : 2, \"a\" : 6 } ] } ] } { \"_id\" : 2, \"results\" : [ { \"item\" : \"C\", \"score\" : 8, \"answers\" : [ { \"q\" : 1, \"a\" : 8 }, { \"q\" : 2, \"a\" : 7 } ] } ] }   $push $push运算符将指定的值附加到数组。\n$push运算符的形式为：\n1  { $push: { field1: value1, ... } }   若要在嵌入式文档或数组中指定，请使用点表示法。\n特性 如果文档中不存在要更新的字段，则$push将以值作为元素的数组字段添加。\n如果该字段不是数组，则操作将失败。\n如果该值为数组，则$push将整个数组作为单个元素附加。要分别添加值的每个元素，请将$each修饰符与$push一起使用。\nModifiers 您可以将$push运算符与以下修饰符一起使用：\n您可以将$push运算符与以下修饰符一起使用：\n   修饰符 描述     $each 将多个值附加到数组字段。   $slice 限制数组元素的数量。需要使用 $each修饰符。   $sort 排序数组的元素。需要使用 $each修饰符。   $position 指定要在数组中插入新元素的位置。需要使用$each修饰符。如果没有$position修饰符，则将$push 元素追加到数组的末尾。    与修饰符一起使用时，$push运算符具有以下形式：\n1  { $push: { field1: { modifier1: value1, ... }, ... } }   push不管修饰符出现的顺序如何，使用修饰符进行的操作的处理均按以下顺序进行：\n 更新数组以将元素添加到正确的位置。 如果指定，则应用排序。 切片数组（如果指定）。 存储数组。  例子 将值附加到数组 下面的示例追加89到scores数组：\n1 2 3 4  db.students.update( { _id: 1 }, { $push: { scores: 89 } } )   将多个值追加到数组中 $push与$each修饰符一起使用可将多个值附加到数组字段。\n下面的示例将[90、92、85]的每个元素附加到名称字段等于joe的文档的scores数组中：\n1 2 3 4  db.students.update( { name: \"joe\" }, { $push: { scores: { $each: [ 90, 92, 85 ] } } } )   将$push运算符与多个修饰符一起使用 集合students具有以下文档：\n1 2 3 4 5 6 7 8 9  { \"_id\" : 5, \"quizzes\" : [ { \"wk\": 1, \"score\" : 10 }, { \"wk\": 2, \"score\" : 8 }, { \"wk\": 3, \"score\" : 5 }, { \"wk\": 4, \"score\" : 6 } ] }   以下$push操作使用：\n $each修饰符可将多个文档添加到quizzes数组中， $sort修饰符可按分数字段的降序对修改后的quizzes数组的所有元素进行排序，并且 $slice修饰符仅保留quizzes数组的前三个排序元素。  1 2 3 4 5 6 7 8 9 10 11 12  db.students.update( { _id: 5 }, { $push: { quizzes: { $each: [ { wk: 5, score: 8 }, { wk: 6, score: 7 }, { wk: 7, score: 6 } ], $sort: { score: -1 }, $slice: 3 } } } )   该操作的结果是quizzes数组仅保留三个最高得分：\n1 2 3 4 5 6 7 8  { \"_id\" : 5, \"quizzes\" : [ { \"wk\" : 1, \"score\" : 10 }, { \"wk\" : 2, \"score\" : 8 }, { \"wk\" : 5, \"score\" : 8 } ] }   $pullAll $pullAll运算符将从现有数组中删除所有指定值的实例。与$pull运算符通过指定查询删除元素不同，$pullAll删除与列出的值匹配的元素。\n$pullAll运算符的形式为：\n1  { $pullAll: { field1: [ value1, value2 ... ], ... } }   若要在嵌入式文档或数组中指定，请使用点表示法。\n特性 如果要删除的是文档或数组，则$pullAll仅删除与指定的完全匹配的数组元素，包括顺序。\n示例 给定survey集合中的以下文档：\n1  { _id: 1, scores: [ 0, 2, 5, 5, 1, 0 ] }   以下操作从scores数组中删除值0和5的所有实例：\n1  db.survey.update( { _id: 1 }, { $pullAll: { scores: [ 0, 5 ] } } )   操作完成后，更新后的文档将从“分数”字段中删除了所有实例0和5：\n1  { \"_id\" : 1, \"scores\" : [ 2, 1 ] }   $each $each修饰符可与$addToSet运算符和$push运算符一起使用。\n如果值在中不存在，请与$addToSet运算符一起使用，以将多个值添加到数组中。\n1  { $addToSet: { field: { $each: [ value1, value2 ... ] } } }   与$push运算符一起使用，可以将多个值附加到数组中。\n1  { $push: { field: { $each: [ value1, value2 ... ] } } }   $push运算符可以将$each修饰符与其他修饰符一起使用。有关$push可用的修饰符的列表，请参见修饰符。\n例子 $each与$push运算符一起使用 下面的示例将[90、92、85]的每个元素附加到名称字段等于joe的文档的scores数组中：\n1 2 3 4  db.students.update( { name: \"joe\" }, { $push: { scores: { $each: [ 90, 92, 85 ] } } } )   $each 与$addToSet运算符一起使用 集合inventory具有以下文档：\n1  { _id: 2, item: \"cable\", tags: [ \"electronics\", \"supplies\" ] }   然后，以下操作将$addToSet运算符与$each修饰符一起使用，以将多个元素添加到tags数组：\n1 2 3 4  db.inventory.update( { _id: 2 }, { $addToSet: { tags: { $each: [ \"camera\", \"electronics\", \"accessories\" ] } } } )   该操作仅向标签数组添加“camera”和“accessories”，因为数组中已经存在“electronics”：\n1 2 3 4 5  { _id: 2, item: \"cable\", tags: [ \"electronics\", \"supplies\", \"camera\", \"accessories\" ] }   $position $position修饰符指定$push运算符在数组中插入元素的位置。如果没有$position修饰符，则$push运算符会将元素插入到数组的末尾。\n要使用$position修饰符，它必须与$each修饰符一起出现。\n1 2 3 4 5 6 7 8  { $push: { field: { $each: [ value1, value2, ... ], $position: num } } }   在版本3.6中更改：$position可以接受一个负数组索引值来指示从末尾开始的位置，该位置从（但不包括）数组的最后一个元素开始计数。\n 根据从零开始的索引指示数组中的位置：\n 从数组的开头开始，非负数对应于数组中的位置。如果的值大于或等于数组的长度，则$position修饰符无效，$push将元素添加到数组的末尾。 从（但不包括）数组的最后一个元素开始,负数对应于数组中的位置。例如，-1指示数组中最后一个元素之前的位置。如果在$each数组中指定多个元素 ，则最后添加的元素位于末尾的指定位置。如果的绝对值大于或等于数组的长度，则将$push 元素添加到数组的开头。  例子 在数组的开头添加元素 考虑一个students包含以下文档的集合：\n1  { \"_id\" : 1, \"scores\" : [ 100 ] }   以下操作将更新scores字段，以将元素50、60和70添加到数组的开头：\n1 2 3 4 5 6 7 8 9 10 11  db.students.update( { _id: 1 }, { $push: { scores: { $each: [ 50, 60, 70 ], $position: 0 } } } )   该操作生成以下更新的文档：\n1  { \"_id\" : 1, \"scores\" : [ 50, 60, 70, 100 ] }   在数组中间添加元素 考虑一个students包含以下文档的集合：\n1  { \"_id\" : 1, \"scores\" : [ 50, 60, 70, 100 ] }   以下操作将更新scores字段，以在数组索引2处添加元素20和30：\n1 2 3 4 5 6 7 8 9 10 11  db.students.update( { _id: 1 }, { $push: { scores: { $each: [ 20, 30 ], $position: 2 } } } )   该操作生成以下更新的文档：\n1  { \"_id\" : 1, \"scores\" : [ 50, 60, 20, 30, 70, 100 ] }   使用负索引将元素添加到数组中 在版本3.6中更改：$position可以接受一个负数组索引值来指示从末尾开始的位置，该位置从（但不包括）数组的最后一个元素开始计数。例如，-1 指示数组中最后一个元素之前的位置。\n考虑一个students包含以下文档的集合：\n1  { \"_id\" : 1, \"scores\" : [ 50, 60, 20, 30, 70, 100 ] }   以下操作为$position指定-2，以在最后一个元素之前两个位置的位置加90，然后在最后一个元素之前两个位置的位置加80。\n重要\n对于负索引位置，如果在$each数组中指定多个元素，则最后添加的元素位于末尾的指定位置。\n1 2 3 4 5 6 7 8 9 10 11  db.students.update( { _id: 1 }, { $push: { scores: { $each: [ 90, 80 ], $position: -2 } } } )   该操作生成以下更新的文档：\n1  { \"_id\" : 1, \"scores\" : [ 50, 60, 20, 30, 90, 80, 70, 100 ] }   $slice $slice修饰符在$push操作期间限制数组元素的数量。要从读取操作中投影或返回指定数量的数组元素，请参阅$slice投影运算符。\n要使用$slice修饰符，它必须与$each修饰符一起出现。您可以将一个空数组[]传递给$each修饰符，这样只有$slice修饰符才有效。\n1 2 3 4 5 6 7 8  { $push: { field: { $each: [ value1, value2, ... ], $slice: num } } }   可以是：\n   值 描述     零 将数组更新为空数组。   负 将数组更新为仅包含最后个元素。   正 要更新的数组仅包含最前 个元素。    特性 修饰符出现的顺序无关紧要。以前的版本要求$each修饰符与$slice一起使用时，它会作为第一个修饰符出现。\n尝试在没有$each修饰符的情况下使用$ slice修饰符会导致错误。\n例子 从数组末尾切片 集合students包含以下文档：\n1  { \"_id\" : 1, \"scores\" : [ 40, 50, 60 ] }   以下操作将新元素添加到scores数组，然后使用$slice修饰符将数组修剪为最后五个元素：\n1 2 3 4 5 6 7 8 9 10 11  db.students.update( { _id: 1 }, { $push: { scores: { $each: [ 80, 78, 86 ], $slice: -5 } } } )   操作的结果是将更新后的scores数组的元素切为最后五个元素：\n1  { \"_id\" : 1, \"scores\" : [ 50, 60, 80, 78, 86 ] }   从数组的前面切片 集合students包含以下文档：\n1  { \"_id\" : 2, \"scores\" : [ 89, 90 ] }   以下操作将新元素添加到scores数组，然后使用$slice修饰符将数组修剪为前三个元素。\n1 2 3 4 5 6 7 8 9 10 11  db.students.update( { _id: 2 }, { $push: { scores: { $each: [ 100, 20 ], $slice: 3 } } } )   该操作的结果是将更新的scores数组的元素切片为前三个元素：\n1  { \"_id\" : 2, \"scores\" : [ 89, 90, 100 ] }   仅使用分片更新数组 集合students包含以下文档：\n1  { \"_id\" : 3, \"scores\" : [ 89, 70, 100, 20 ] }   要仅使用$slice修饰符的效果更新分数字段，请为$slice修饰符指定要切片的元素数（例如-3），为$each修饰符指定一个空数组[]，如下所示：\n1 2 3 4 5 6 7 8 9 10 11  db.students.update( { _id: 3 }, { $push: { scores: { $each: [ ], $slice: -3 } } } )   该操作的结果是将scores数组的元素切片为最后三个元素：\n1  { \"_id\" : 3, \"scores\" : [ 70, 100, 20 ] }   $slice与其他$push修饰符一起使用 集合students具有以下文档：\n1 2 3 4 5 6 7 8 9  { \"_id\" : 5, \"quizzes\" : [ { \"wk\": 1, \"score\" : 10 }, { \"wk\": 2, \"score\" : 8 }, { \"wk\": 3, \"score\" : 5 }, { \"wk\": 4, \"score\" : 6 } ] }   以下$push操作使用：\n $each修饰符可将多个文档添加到quizzes数组中， $sort修饰符可按分数字段的降序对修改后的测quizzes数组的所有元素进行排序. $slice修饰符仅保留quizzes数组的前三个排序元素。  1 2 3 4 5 6 7 8 9 10 11 12  db.students.update( { _id: 5 }, { $push: { quizzes: { $each: [ { wk: 5, score: 8 }, { wk: 6, score: 7 }, { wk: 7, score: 6 } ], $sort: { score: -1 }, $slice: 3 } } } )   该操作的结果是quizzes仅保留三个最高得分：\n1 2 3 4 5 6 7 8  { \"_id\" : 5, \"quizzes\" : [ { \"wk\" : 1, \"score\" : 10 }, { \"wk\" : 2, \"score\" : 8 }, { \"wk\" : 5, \"score\" : 8 } ] }   修饰符的顺序与修饰符的处理顺序无关。\n$sort $sort修饰符在$push操作期间对数组的元素进行排序。\n要使用$sort修饰符，它必须与$each修饰符一起出现。您可以将一个空数组[]传递给$each修饰符，这样只有$sort修饰符才起作用。\n1 2 3 4 5 6 7 8  { $push: { field: { $each: [ value1, value2, ... ], $sort: sort specification } } }   对于：\n 要对不是文档的数组元素进行排序，或者如果数组元素是文档，则要对整个文档进行排序，请指定1代表升序，-1代表降序。 如果数组元素是文档，则要按文档中的字段排序，请指定具有字段和方向的排序文档，即{field：1}或{field：-1}。不要在排序规范中引用包含数组的字段（例如{“arrayField.field“：1}不正确）。  特性 $sort修饰符可以对不是文档的数组元素进行排序。在以前的版本中，$sort修饰符要求数组元素为文档。\n如果数组元素是文档，则修饰符可以按整个文档或文档中的特定字段进行排序。在以前的版本中，$sort修饰符只能按文档中的特定字段排序。\n尝试使用没有$each修饰符的$sort修饰符会导致错误。 $sort不再需要$slice修饰符。\n例子 按文档中的字段对文档数组进行排序 集合students包含以下文档：\n1 2 3 4 5 6 7  { \"_id\": 1, \"quizzes\": [ { \"id\" : 1, \"score\" : 6 }, { \"id\" : 2, \"score\" : 9 } ] }   以下更新将其他文档附加到quizzes数组，然后按升序对数组的所有元素score进行排序 ：\n1 2 3 4 5 6 7 8 9 10 11  db.students.update( { _id: 1 }, { $push: { quizzes: { $each: [ { id: 3, score: 8 }, { id: 4, score: 7 }, { id: 5, score: 6 } ], $sort: { score: 1 } } } } )   重要\n排序文档直接引用文档中的字段，而不引用包含的数组quizzes字段；即{ score: 1 } ，而不是{“quizzes.score”：1}\n更新后，数组元素按score字段升序排列 ：\n1 2 3 4 5 6 7 8 9 10  { \"_id\" : 1, \"quizzes\" : [ { \"id\" : 1, \"score\" : 6 }, { \"id\" : 5, \"score\" : 6 }, { \"id\" : 4, \"score\" : 7 }, { \"id\" : 3, \"score\" : 8 }, { \"id\" : 2, \"score\" : 9 } ] }   对不是文档的数组元素进行排序 集合students包含以下文档：\n1  { \"_id\" : 2, \"tests\" : [ 89, 70, 89, 50 ] }   以下操作将另外两个元素添加到scores数组并对元素进行排序：\n1 2 3 4  db.students.update( { _id: 2 }, { $push: { tests: { $each: [ 40, 60 ], $sort: 1 } } } )   更新的文档具有scores按升序排列的数组元素：\n1  { \"_id\" : 2, \"tests\" : [ 40, 50, 60, 70, 89, 89 ] }   使用仅排序更新数组 集合students包含以下文档：\n1  { \"_id\" : 3, \"tests\" : [ 89, 70, 100, 20 ] }   要更新测试字段以使其元素降序排序，请指定{$ sort：-1}并为$each修饰符指定一个空数组[]，如下所示：\n1 2 3 4  db.students.update( { _id: 3 }, { $push: { tests: { $each: [ ], $sort: -1 } } } )   该操作的结果是更新scores字段以按降序对其元素排序：\n1  { \"_id\" : 3, \"tests\" : [ 100, 89, 70, 20 ] }   $sort与$push一起使用 集合students具有以下文档：\n1 2 3 4 5 6 7 8 9  { \"_id\" : 5, \"quizzes\" : [ { \"wk\": 1, \"score\" : 10 }, { \"wk\": 2, \"score\" : 8 }, { \"wk\": 3, \"score\" : 5 }, { \"wk\": 4, \"score\" : 6 } ] }   以下$push操作使用：\n $each修饰符可将多个文档添加到quizzes数组中， $sort修饰符可按score字段的降序对修改后的quizzes数组的所有元素进行排序. $slice修饰符仅保留quizzes数组的前三个排序元素。  1 2 3 4 5 6 7 8 9 10 11 12  db.students.update( { _id: 5 }, { $push: { quizzes: { $each: [ { wk: 5, score: 8 }, { wk: 6, score: 7 }, { wk: 7, score: 6 } ], $sort: { score: -1 }, $slice: 3 } } } )   该操作的结果是仅保留三个最高得分测验：\n1 2 3 4 5 6 7 8  { \"_id\" : 5, \"quizzes\" : [ { \"wk\" : 1, \"score\" : 10 }, { \"wk\" : 2, \"score\" : 8 }, { \"wk\" : 5, \"score\" : 8 } ] }   修饰符的顺序与修饰符的处理顺序无关。\n",
  "wordCount" : "14314",
  "inLanguage": "zh-cn",
  "datePublished": "2020-05-14T16:54:36Z",
  "dateModified": "2020-05-14T16:54:36Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/mongodb%E7%9A%84%E6%95%B0%E7%BB%84%E6%9B%B4%E6%96%B0%E8%BF%90%E7%AE%97%E7%AC%A6/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      MongoDB的数组更新运算符
    </h1>
    <div class="post-meta">May 14, 2020
</div>
  </header> 
  <div class="post-content"><h1 id="heading"><code>$</code><a hidden class="anchor" aria-hidden="true" href="#heading">#</a></h1>
<p><code>$</code>运算符标识要更新的数组中的元素，而无需显式指定数组中元素的位置。</p>
<p>消歧</p>
<ul>
<li>要通过读取操作$投影或返回数组元素，请参阅投影运算符。</li>
<li>要更新数组中的所有元素，请参阅all位置运算符 <code>$[]</code>。</li>
<li>要更新所有符合一个或多个数组过滤条件的元素，请参阅过滤后的位置运算符 <code>$[&lt;identifier&gt;]</code>。</li>
</ul>
<p><code>$</code>运算符的格式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;&lt;array&gt;.$&#34;</span> <span class="o">:</span> <span class="n">value</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>与更新操作（例如 db.collection.update()和 db.collection.findAndModify()）一起使用时</p>
<ul>
<li>位置$运算符充当与查询文档匹配的第一个元素的占位符</li>
<li>数组字段必须作为查询文档的一部分出现。</li>
</ul>
<p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.collection.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">array</span><span class="o">&gt;:</span> <span class="n">value</span> <span class="kc">...</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">update</span> <span class="n">operator</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="s">&#34;&lt;array&gt;.$&#34;</span> <span class="o">:</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="特性">特性<a hidden class="anchor" aria-hidden="true" href="#特性">#</a></h2>
<h3 id="upsert">upsert<a hidden class="anchor" aria-hidden="true" href="#upsert">#</a></h3>
<p>不要将位置运算符<code>$</code>与<code>upsert</code>操作一起使用，因为插入操作会将<code>$</code>用作插入文档中的字段名称。</p>
<h3 id="嵌套数组">嵌套数组<a hidden class="anchor" aria-hidden="true" href="#嵌套数组">#</a></h3>
<p>位置<code>$</code>运算符不能用于遍历一个以上数组的查询，例如遍历嵌套在其他数组中的数组的查询，因为$占位符的替换是单个值</p>
<h3 id="unsets">Unsets<a hidden class="anchor" aria-hidden="true" href="#unsets">#</a></h3>
<p>与<code>$unset</code>运算符一起使用时，位置<code>$</code>运算符不会从数组中删除匹配的元素，而是将其设置为null。</p>
<h3 id="否定">否定<a hidden class="anchor" aria-hidden="true" href="#否定">#</a></h3>
<p>如果查询使用否定运算符，如<code>$ne</code>，<code>$not</code>或者<code>$nin</code>，那么您将无法使用位置运算符来更新此数组中的值。</p>
<p>但是，如果查询的否定部分在<code>$elemMatch</code>表达式内，则可以使用位置运算符更新此字段。</p>
<h2 id="例子">例子<a hidden class="anchor" aria-hidden="true" href="#例子">#</a></h2>
<h3 id="数组中的更新值">数组中的更新值<a hidden class="anchor" aria-hidden="true" href="#数组中的更新值">#</a></h3>
<p>students使用以下文档创建一个集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.insert</span><span class="p">(</span><span class="n">[</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span> <span class="m">85</span><span class="p">,</span> <span class="m">80</span><span class="p">,</span> <span class="m">80</span> <span class="n">]</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span> <span class="m">88</span><span class="p">,</span> <span class="m">90</span><span class="p">,</span> <span class="m">92</span> <span class="n">]</span> <span class="p">},</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">3</span><span class="p">,</span> <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span> <span class="m">85</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="m">90</span> <span class="n">]</span> <span class="p">}</span>
<span class="n">]</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>要更新grades数组中第一个值为80到82的元素，如果您不知道该元素在数组中的位置，请使用<code>$</code>运算符：</p>
<p>重要:您必须将数组字段包含在query文档中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.updateOne</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">grades</span><span class="o">:</span> <span class="m">80</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$&#34;</span> <span class="o">:</span> <span class="m">82</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>位置$运算符充当更新查询文档的第一个匹配项的占位符 。</p>
<p>操作后，students集合包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">80</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">92</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="更新数组中的文档">更新数组中的文档<a hidden class="anchor" aria-hidden="true" href="#更新数组中的文档">#</a></h3>
<p>位置<code>$</code>运算符有助于更新包含嵌入式文档的数组。使用位置<code>$</code>运算符可使用<code>$</code>运算符上的点符号访问嵌入文档中的字段。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.collection.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">query</span> <span class="n">selector</span><span class="o">&gt;</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">update</span> <span class="n">operator</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="s">&#34;array.$.field&#34;</span> <span class="o">:</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>请考虑students集合中的以下文档，该文档的 grades元素值为嵌入式文档的数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">_id:</span> <span class="err">4,</span>
  <span class="err">grades:</span> <span class="err">[</span>
     <span class="err">{</span> <span class="err">grade:</span> <span class="err">80,</span> <span class="err">mean:</span> <span class="err">75,</span> <span class="err">std:</span> <span class="err">8</span> <span class="p">}</span><span class="err">,</span>
     <span class="p">{</span> <span class="err">grade:</span> <span class="err">85,</span> <span class="err">mean:</span> <span class="err">90,</span> <span class="err">std:</span> <span class="err">5</span> <span class="p">}</span><span class="err">,</span>
     <span class="p">{</span> <span class="err">grade:</span> <span class="err">85,</span> <span class="err">mean:</span> <span class="err">85,</span> <span class="err">std:</span> <span class="err">8</span> <span class="p">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>使用位置<code>$</code>运算符更新std匹配grade等于85条件的第一个数组元素的字段：</p>
<p>重要</p>
<p>您必须将数组字段包含在query文档中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.updateOne</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">4</span><span class="p">,</span> <span class="s">&#34;grades.grade&#34;</span><span class="o">:</span> <span class="m">85</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$.std&#34;</span> <span class="o">:</span> <span class="m">6</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作后，文档具有以下更新值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span>
   <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">4</span><span class="p">,</span>
   <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span>
      <span class="p">{</span> <span class="s">&#34;grade&#34;</span> <span class="o">:</span> <span class="m">80</span><span class="p">,</span> <span class="s">&#34;mean&#34;</span> <span class="o">:</span> <span class="m">75</span><span class="p">,</span> <span class="s">&#34;std&#34;</span> <span class="o">:</span> <span class="m">8</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s">&#34;grade&#34;</span> <span class="o">:</span> <span class="m">85</span><span class="p">,</span> <span class="s">&#34;mean&#34;</span> <span class="o">:</span> <span class="m">90</span><span class="p">,</span> <span class="s">&#34;std&#34;</span> <span class="o">:</span> <span class="m">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="s">&#34;grade&#34;</span> <span class="o">:</span> <span class="m">85</span><span class="p">,</span> <span class="s">&#34;mean&#34;</span> <span class="o">:</span> <span class="m">85</span><span class="p">,</span> <span class="s">&#34;std&#34;</span> <span class="o">:</span> <span class="m">8</span> <span class="p">}</span>
   <span class="n">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="使用多个字段匹配更新嵌入式文档">使用多个字段匹配更新嵌入式文档<a hidden class="anchor" aria-hidden="true" href="#使用多个字段匹配更新嵌入式文档">#</a></h3>
<p><code>$</code>运算符可以更新与<code>$elemMatch（）</code>运算符指定的多个查询条件匹配的第一个数组元素。</p>
<p>考虑students集合中的以下文档，该文档的grades字段值为嵌入式文档的数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">_id:</span> <span class="err">5,</span>
  <span class="err">grades:</span> <span class="err">[</span>
     <span class="err">{</span> <span class="err">grade:</span> <span class="err">80,</span> <span class="err">mean:</span> <span class="err">75,</span> <span class="err">std:</span> <span class="err">8</span> <span class="p">}</span><span class="err">,</span>
     <span class="p">{</span> <span class="err">grade:</span> <span class="err">85,</span> <span class="err">mean:</span> <span class="err">90,</span> <span class="err">std:</span> <span class="err">5</span> <span class="p">}</span><span class="err">,</span>
     <span class="p">{</span> <span class="err">grade:</span> <span class="err">90,</span> <span class="err">mean:</span> <span class="err">85,</span> <span class="err">std:</span> <span class="err">3</span> <span class="p">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在下面的示例中，<code>$</code>运算符更新第一个嵌入式文档中std字段的值，该字段的等级字段的值小于或等于90，而平均值字段的值大于80：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.updateOne</span><span class="p">(</span>
   <span class="p">{</span>
     <span class="n">_id</span><span class="o">:</span> <span class="m">5</span><span class="p">,</span>
     <span class="n">grades</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">elemMatch</span><span class="o">:</span> <span class="p">{</span> <span class="n">grade</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">lte</span><span class="o">:</span> <span class="m">90</span> <span class="p">},</span> <span class="n">mean</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gt</span><span class="o">:</span> <span class="m">80</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
   <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$.std&#34;</span> <span class="o">:</span> <span class="m">6</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>此操作将更新符合条件的第一个嵌入式文档，即数组中的第二个嵌入式文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">_id:</span> <span class="err">5,</span>
  <span class="err">grades:</span> <span class="err">[</span>
    <span class="err">{</span> <span class="err">grade:</span> <span class="err">80,</span> <span class="err">mean:</span> <span class="err">75,</span> <span class="err">std:</span> <span class="err">8</span> <span class="p">}</span><span class="err">,</span>

    <span class="p">{</span> <span class="err">grade:</span> <span class="err">85,</span> <span class="err">mean:</span> <span class="err">90,</span> <span class="err">std:</span> <span class="err">6</span> <span class="p">}</span><span class="err">,</span>

    <span class="p">{</span> <span class="err">grade:</span> <span class="err">90,</span> <span class="err">mean:</span> <span class="err">85,</span> <span class="err">std:</span> <span class="err">3</span> <span class="p">}</span>
  <span class="err">]</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="heading-1"><code>$[]</code><a hidden class="anchor" aria-hidden="true" href="#heading-1">#</a></h1>
<p>3.6版的新功能。</p>
<p>all位置运算符<code>$[]</code>指示update运算符应修改指定数组字段中的所有元素。</p>
<p><code>$[]</code>具有下列形式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">&lt;</span><span class="n">update</span> <span class="n">operator</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="s">&#34;&lt;array&gt;.$[]&#34;</span> <span class="o">:</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>用于更新操作（例如db.collection.update()和 db.collection.findAndModify()）来修改一个或多个查询条件匹配的文档的所有数组元素。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.collection.updateMany</span><span class="p">(</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">query</span> <span class="n">conditions</span><span class="o">&gt;</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">update</span> <span class="n">operator</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="s">&#34;&lt;array&gt;.$[]&#34;</span> <span class="o">:</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="特性-1">特性<a hidden class="anchor" aria-hidden="true" href="#特性-1">#</a></h2>
<h3 id="upsert-1">upsert<a hidden class="anchor" aria-hidden="true" href="#upsert-1">#</a></h3>
<p>如果upsert操作导致插入，则query必须在array字段上包含完全相等的匹配项，以便<code>$[]</code>在update语句中使用位置运算符。</p>
<p>例如，<code>$[]</code>在更新文档中使用的以下upsert操作在array字段上指定完全相等的匹配条件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.collection.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">myArray</span><span class="o">:</span> <span class="n">[</span> <span class="m">5</span><span class="p">,</span> <span class="m">8</span> <span class="n">]</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;myArray.$[]&#34;</span><span class="o">:</span> <span class="m">10</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">upsert</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>如果不存在此类文档，则该操作将导致插入以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="err">ObjectId(...)</span><span class="p">,</span> <span class="nt">&#34;myArray&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果upsert操作不包括完全相等的匹配项，并且找不到匹配的文档要更新，则upsert操作将出错。</p>
<p>例如，如果找不到匹配的文档来更新，则以下操作将出错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.collection.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">myArray</span><span class="o">:</span> <span class="m">5</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;myArray.$[]&#34;</span><span class="o">:</span> <span class="m">10</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">upsert</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>

<span class="nf">db.collection.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;myArray.$[]&#34;</span><span class="o">:</span> <span class="m">10</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">upsert</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="嵌套数组-1">嵌套数组<a hidden class="anchor" aria-hidden="true" href="#嵌套数组-1">#</a></h3>
<p>该<code>$[]</code>运算符可用于遍历多个数组和嵌套数组的查询。</p>
<h2 id="例子-1">例子<a hidden class="anchor" aria-hidden="true" href="#例子-1">#</a></h2>
<h3 id="更新数组中的所有元素">更新数组中的所有元素<a hidden class="anchor" aria-hidden="true" href="#更新数组中的所有元素">#</a></h3>
<p>考虑students包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">80</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">92</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>要为集合中的所有文档增加grades数组中的所有元素10，请使用<code>$[]</code>运算符：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">inc</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[]&#34;</span><span class="o">:</span> <span class="m">10</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>所有位置的<code>$[]</code>运算符都充当array字段中所有元素的占位符。</p>
<p>操作后，students集合包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">102</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">100</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="更新数组中的所有文档">更新数组中的所有文档<a hidden class="anchor" aria-hidden="true" href="#更新数组中的所有文档">#</a></h3>
<p><code>$[]</code>操作方便的更新包含嵌入文档数组。要访问嵌入文档中的字段，请在运算符<code>$[]</code>上使用点符号。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.collection.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">query</span> <span class="n">selector</span><span class="o">&gt;</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">update</span> <span class="n">operator</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="s">&#34;array.$[].field&#34;</span> <span class="o">:</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>考虑students2包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">87</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>要为grades数组中的所有元素修改std字段的值，请使用位置<code>$[]</code>运算符：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students2.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">inc</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[].std&#34;</span> <span class="o">:</span> <span class="m">-2</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作后，集合具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">87</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">3</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="使用否定查询运算符更新指定的数组">使用否定查询运算符更新指定的数组<a hidden class="anchor" aria-hidden="true" href="#使用否定查询运算符更新指定的数组">#</a></h3>
<p>考虑results包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">80</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">92</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>要使所有文档的等级数组中的所有元素增加10，等级数组中值为100的元素除外，请使用<code>$[]</code>运算符：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.results.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">ne</span><span class="o">:</span> <span class="m">100</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">inc</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[]&#34;</span><span class="o">:</span> <span class="m">10</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>$[]</code>运算符充当数组字段中所有元素的占位符。</p>
<p>操作后，students集合包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span> <span class="m">95</span><span class="p">,</span> <span class="m">92</span><span class="p">,</span> <span class="m">90</span> <span class="n">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span> <span class="m">98</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="m">102</span> <span class="n">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">3</span><span class="p">,</span> <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span> <span class="m">85</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="m">90</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="与identifier一起更新嵌套数组">与<code>$[&lt;identifier&gt;]</code>一起更新嵌套数组<a hidden class="anchor" aria-hidden="true" href="#与identifier一起更新嵌套数组">#</a></h3>
<p><code>$[]</code>位置运算符与过滤器<code>$[&lt;identifier&gt;]</code>位置运算符一起可用于更新嵌套数组。</p>
<p>students3使用以下文档创建一个集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students3.insert</span><span class="p">(</span><span class="n">[</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span>
      <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span>
        <span class="p">{</span> <span class="n">type</span><span class="o">:</span> <span class="s">&#34;quiz&#34;</span><span class="p">,</span> <span class="n">questions</span><span class="o">:</span> <span class="n">[</span> <span class="m">10</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">5</span> <span class="n">]</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">type</span><span class="o">:</span> <span class="s">&#34;quiz&#34;</span><span class="p">,</span> <span class="n">questions</span><span class="o">:</span> <span class="n">[</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">6</span> <span class="n">]</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">type</span><span class="o">:</span> <span class="s">&#34;hw&#34;</span><span class="p">,</span> <span class="n">questions</span><span class="o">:</span> <span class="n">[</span> <span class="m">5</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">3</span> <span class="n">]</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">type</span><span class="o">:</span> <span class="s">&#34;exam&#34;</span><span class="p">,</span> <span class="n">questions</span><span class="o">:</span> <span class="n">[</span> <span class="m">25</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">23</span><span class="p">,</span> <span class="m">0</span> <span class="n">]</span> <span class="p">},</span>
      <span class="n">]</span>
   <span class="p">}</span>
<span class="n">]</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>要更新嵌套的<code>grades.questions</code>数组中所有大于或等于8的值，而不管类型如何：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students3.update</span><span class="p">(</span>
   <span class="p">{},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">inc</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[].questions.$[score]&#34;</span><span class="o">:</span> <span class="m">2</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span>  <span class="p">{</span> <span class="s">&#34;score&#34;</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="m">8</span> <span class="p">}</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="identifier"><code>$[&lt;identifier&gt;]</code><a hidden class="anchor" aria-hidden="true" href="#identifier">#</a></h1>
<p>3.6版的新功能。</p>
<p>过滤后的位置运算符<code>$[&lt;identifier&gt;]</code>标识与<code>arrayFilters</code>条件匹配的数组元素以进行更新操作，例如db.collection.update()和 db.collection.findAndModify()。</p>
<p>与该<code>arrayFilters</code>选项结合使用,<code>$[&lt;identifier&gt;]</code>运算符具有以下形式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">&lt;</span><span class="n">update</span> <span class="n">operator</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="s">&#34;&lt;array&gt;.$[&lt;identifier&gt;]&#34;</span> <span class="o">:</span> <span class="n">value</span> <span class="p">}</span> <span class="p">},</span>
<span class="p">{</span> <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;:</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span> <span class="p">}</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>与arrayFilters选项结合使用，以更新一个或多个与查询条件匹配的文档中所有与arrayFilters条件匹配的元素。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">db.collection.updateMany(
   { &lt;query conditions&gt; },
   { &lt;update operator&gt;: { &#34;&lt;array&gt;.$[&lt;identifier&gt;]&#34; : value } },
   { arrayFilters: [ { &lt;identifier&gt;: &lt;condition&gt; } ] }
)
</code></pre></td></tr></table>
</div>
</div><p>注意</p>
<p>在<code>&lt;identifier&gt;</code>必须以小写字母开头，并且只包含字母数字字符。</p>
<h2 id="特性-2">特性<a hidden class="anchor" aria-hidden="true" href="#特性-2">#</a></h2>
<h3 id="upsert-2">upsert<a hidden class="anchor" aria-hidden="true" href="#upsert-2">#</a></h3>
<p>如果upsert操作导致插入，则query必须在array字段上包含完全相等的匹配项才能在update语句中使用<code>$[&lt;identifier&gt;]</code>。</p>
<p>例如，<code>$[&lt;identifier&gt;]</code>在更新文档中使用的以下upsert操作在array字段上指定完全相等的匹配条件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.collection.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">myArray</span><span class="o">:</span> <span class="n">[</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span> <span class="n">]</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;myArray.$[element]&#34;</span><span class="o">:</span> <span class="m">2</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="n">element</span><span class="o">:</span> <span class="m">0</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span>
     <span class="n">upsert</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>如果不存在这样的文档，则该操作将导致插入类似于以下内容的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="err">ObjectId(...)</span><span class="p">,</span> <span class="nt">&#34;myArray&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果upsert操作不包括完全相等的匹配项，并且找不到匹配的文档要更新，则upsert操作将出错。例如，如果找不到匹配的文档来更新，则以下操作将出错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.array.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;myArray.$[element]&#34;</span><span class="o">:</span> <span class="m">10</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="n">element</span><span class="o">:</span> <span class="m">9</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span>
     <span class="n">upsert</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作将返回类似于以下内容的错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">WriteResult</span><span class="p">({</span>
   <span class="s">&#34;nMatched&#34;</span> <span class="o">:</span> <span class="m">0</span><span class="p">,</span>
   <span class="s">&#34;nUpserted&#34;</span> <span class="o">:</span> <span class="m">0</span><span class="p">,</span>
   <span class="s">&#34;nModified&#34;</span> <span class="o">:</span> <span class="m">0</span><span class="p">,</span>
   <span class="s">&#34;writeError&#34;</span> <span class="o">:</span> <span class="p">{</span>
      <span class="s">&#34;code&#34;</span> <span class="o">:</span> <span class="m">2</span><span class="p">,</span>
      <span class="s">&#34;errmsg&#34;</span> <span class="o">:</span> <span class="s">&#34;The path &#39;myArray&#39; must exist in the document in order to apply array updates.&#34;</span>
   <span class="p">}</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="嵌套数组-2">嵌套数组<a hidden class="anchor" aria-hidden="true" href="#嵌套数组-2">#</a></h3>
<p>过滤后的位置运算符<code>$[&lt;identifier&gt;]</code>可用于遍历多个数组和嵌套数组的查询。</p>
<h2 id="例子-2">例子<a hidden class="anchor" aria-hidden="true" href="#例子-2">#</a></h2>
<h3 id="更新所有匹配arrayfilters的数组元素">更新所有匹配arrayFilters的数组元素<a hidden class="anchor" aria-hidden="true" href="#更新所有匹配arrayfilters的数组元素">#</a></h3>
<p>考虑students包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">102</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">100</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>要更新grades数组中所有大于或等于100的元素，请对arrayFilters使用过滤后的位置运算符<code>$[&lt;identifier&gt;]</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[element]&#34;</span> <span class="o">:</span> <span class="m">100</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span><span class="p">,</span>
     <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="s">&#34;element&#34;</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="m">100</span> <span class="p">}</span> <span class="p">}</span> <span class="n">]</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>位置<code>$[&lt;identifier&gt;]</code>运算符充当数组字段中与arrayFilters中指定的条件匹配的所有元素的占位符。</p>
<p>操作后，students集合包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span> <span class="p">]</span> <span class="p">}</span>
<span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="更新arrayfilters数组中所有匹配的文档">更新arrayFilters数组中所有匹配的文档<a hidden class="anchor" aria-hidden="true" href="#更新arrayfilters数组中所有匹配的文档">#</a></h3>
<p>该<code>$[&lt;identifier&gt;]</code>操作有利于更新包含嵌入文档数组。要访问嵌入文档中的字段，使用点符号上<code>$[&lt;identifier&gt;]</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.collection.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">query</span> <span class="n">selector</span><span class="o">&gt;</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">&lt;</span><span class="n">update</span> <span class="n">operator</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="s">&#34;array.$[&lt;identifier&gt;].field&#34;</span> <span class="o">:</span> <span class="n">value</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">identifier</span><span class="o">&gt;:</span> <span class="o">&lt;</span><span class="n">condition</span><span class="o">&gt;</span> <span class="p">}</span> <span class="p">}</span> <span class="n">]</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>考虑students2包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">87</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">3</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>要修改grades中mean大于或等于85的grades数组中所有元素的字段，请使用位置<code>$[&lt;identifier&gt;]</code>运算符和<code>arrayFilters</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students2.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[elem].mean&#34;</span> <span class="o">:</span> <span class="m">100</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="n">multi</span><span class="o">:</span> <span class="n">true</span><span class="p">,</span>
     <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="s">&#34;elem.grade&#34;</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="m">85</span> <span class="p">}</span> <span class="p">}</span> <span class="n">]</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作后，集合具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">87</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">3</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="更新匹配多个条件的所有数组元素">更新匹配多个条件的所有数组元素<a hidden class="anchor" aria-hidden="true" href="#更新匹配多个条件的所有数组元素">#</a></h3>
<p>考虑students2包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">87</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">3</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>若要修改成绩数组中所有成绩均大于或等于80且std大于或等于5的std字段的值，请使用位置<code>$[&lt;identifier&gt;]</code>运算符和<code>arrayFilters</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students2.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">inc</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[elem].std&#34;</span> <span class="o">:</span> <span class="m">-1</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="s">&#34;elem.grade&#34;</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="m">80</span> <span class="p">},</span> <span class="s">&#34;elem.std&#34;</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gt</span><span class="o">:</span> <span class="m">5</span> <span class="p">}</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作后，集合具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">75</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">90</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">87</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">3</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;grade&#34;</span> <span class="p">:</span> <span class="mi">85</span><span class="p">,</span> <span class="nt">&#34;mean&#34;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="nt">&#34;std&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="使用求反运算符更新数组元素">使用求反运算符更新数组元素<a hidden class="anchor" aria-hidden="true" href="#使用求反运算符更新数组元素">#</a></h3>
<p>考虑alumni包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Christine Franklin&#34;</span><span class="p">,</span>
   <span class="nt">&#34;degrees&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;Master&#34;</span><span class="p">,</span>
        <span class="nt">&#34;major&#34;</span><span class="p">:</span> <span class="s2">&#34;Biology&#34;</span><span class="p">,</span>
        <span class="nt">&#34;completion_year&#34;</span><span class="p">:</span> <span class="mi">2010</span><span class="p">,</span>
        <span class="nt">&#34;faculty&#34;</span><span class="p">:</span> <span class="s2">&#34;Science&#34;</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;Bachelor&#34;</span><span class="p">,</span>
        <span class="nt">&#34;major&#34;</span><span class="p">:</span> <span class="s2">&#34;Biology&#34;</span><span class="p">,</span>
        <span class="nt">&#34;completion_year&#34;</span><span class="p">:</span> <span class="mi">2008</span><span class="p">,</span>
        <span class="nt">&#34;faculty&#34;</span><span class="p">:</span> <span class="s2">&#34;Science&#34;</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&#34;school_email&#34;</span><span class="p">:</span> <span class="s2">&#34;cfranklin@example.edu&#34;</span><span class="p">,</span>
   <span class="nt">&#34;email&#34;</span><span class="p">:</span> <span class="s2">&#34;christine@example.com&#34;</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Reyansh Sengupta&#34;</span><span class="p">,</span>
   <span class="nt">&#34;degrees&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;level&#34;</span><span class="p">:</span> <span class="s2">&#34;Bachelor&#34;</span><span class="p">,</span>
        <span class="nt">&#34;major&#34;</span><span class="p">:</span> <span class="s2">&#34;Chemical Engineering&#34;</span><span class="p">,</span>
        <span class="nt">&#34;completion_year&#34;</span><span class="p">:</span> <span class="mi">2002</span><span class="p">,</span>
        <span class="nt">&#34;faculty&#34;</span><span class="p">:</span> <span class="s2">&#34;Engineering&#34;</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&#34;school_email&#34;</span><span class="p">:</span> <span class="s2">&#34;rsengupta2@example.edu&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>若要修改度数组中不具有<code>&quot;level&quot;: &quot;Bachelor&quot;</code>的所有元素，请对<code>$ne</code>查询运算符使用位置<code>[&lt;identifier&gt;]</code>操作</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.alumni.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">set</span> <span class="o">:</span> <span class="p">{</span> <span class="s">&#34;degrees.$[degree].gradcampaign&#34;</span> <span class="o">:</span> <span class="m">1</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">arrayFilters</span> <span class="o">:</span> <span class="n">[</span> <span class="p">{</span><span class="s">&#34;degree.level&#34;</span> <span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">ne</span><span class="o">:</span> <span class="s">&#34;Bachelor&#34;</span> <span class="p">}</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span>
     <span class="n">multi</span> <span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作后，集合具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;Christine Franklin&#34;</span><span class="p">,</span>
   <span class="nt">&#34;degrees&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="nt">&#34;level&#34;</span> <span class="p">:</span> <span class="s2">&#34;Master&#34;</span><span class="p">,</span>
         <span class="nt">&#34;major&#34;</span> <span class="p">:</span> <span class="s2">&#34;Biology&#34;</span><span class="p">,</span>
         <span class="nt">&#34;completion_year&#34;</span> <span class="p">:</span> <span class="mi">2010</span><span class="p">,</span>
         <span class="nt">&#34;faculty&#34;</span> <span class="p">:</span> <span class="s2">&#34;Science&#34;</span><span class="p">,</span>
         <span class="nt">&#34;gradcampaign&#34;</span> <span class="p">:</span> <span class="mi">1</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="nt">&#34;level&#34;</span> <span class="p">:</span> <span class="s2">&#34;Bachelor&#34;</span><span class="p">,</span>
         <span class="nt">&#34;major&#34;</span> <span class="p">:</span> <span class="s2">&#34;Biology&#34;</span><span class="p">,</span>
         <span class="nt">&#34;completion_year&#34;</span> <span class="p">:</span> <span class="mi">2008</span><span class="p">,</span>
         <span class="nt">&#34;faculty&#34;</span> <span class="p">:</span> <span class="s2">&#34;Science&#34;</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&#34;school_email&#34;</span> <span class="p">:</span> <span class="s2">&#34;cfranklin@example.edu&#34;</span><span class="p">,</span>
   <span class="nt">&#34;email&#34;</span> <span class="p">:</span> <span class="s2">&#34;christine@example.com&#34;</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;name&#34;</span> <span class="p">:</span> <span class="s2">&#34;Reyansh Sengupta&#34;</span><span class="p">,</span>
   <span class="nt">&#34;degrees&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="nt">&#34;level&#34;</span> <span class="p">:</span> <span class="s2">&#34;Bachelor&#34;</span><span class="p">,</span>
         <span class="nt">&#34;major&#34;</span> <span class="p">:</span> <span class="s2">&#34;Chemical Engineering&#34;</span><span class="p">,</span>
         <span class="nt">&#34;completion_year&#34;</span> <span class="p">:</span> <span class="mi">2002</span><span class="p">,</span>
         <span class="nt">&#34;faculty&#34;</span> <span class="p">:</span> <span class="s2">&#34;Engineering&#34;</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&#34;school_email&#34;</span> <span class="p">:</span> <span class="s2">&#34;rsengupta2@example.edu&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="与一起更新嵌套数组">与<code>$[]</code>一起更新嵌套数组<a hidden class="anchor" aria-hidden="true" href="#与一起更新嵌套数组">#</a></h3>
<p><code>$ [&lt;identifier&gt;]</code>过滤后的位置运算符与<code>$[]</code>所有位置运算符一起，可用于更新嵌套数组。</p>
<p>students3使用以下文档创建一个集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students3.insert</span><span class="p">(</span>
   <span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span>
      <span class="s">&#34;grades&#34;</span> <span class="o">:</span> <span class="n">[</span>
        <span class="p">{</span> <span class="n">type</span><span class="o">:</span> <span class="s">&#34;quiz&#34;</span><span class="p">,</span> <span class="n">questions</span><span class="o">:</span> <span class="n">[</span> <span class="m">10</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">5</span> <span class="n">]</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">type</span><span class="o">:</span> <span class="s">&#34;quiz&#34;</span><span class="p">,</span> <span class="n">questions</span><span class="o">:</span> <span class="n">[</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">6</span> <span class="n">]</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">type</span><span class="o">:</span> <span class="s">&#34;hw&#34;</span><span class="p">,</span> <span class="n">questions</span><span class="o">:</span> <span class="n">[</span> <span class="m">5</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">3</span> <span class="n">]</span> <span class="p">},</span>
        <span class="p">{</span> <span class="n">type</span><span class="o">:</span> <span class="s">&#34;exam&#34;</span><span class="p">,</span> <span class="n">questions</span><span class="o">:</span> <span class="n">[</span> <span class="m">25</span><span class="p">,</span> <span class="m">10</span><span class="p">,</span> <span class="m">23</span><span class="p">,</span> <span class="m">0</span> <span class="n">]</span> <span class="p">},</span>

      <span class="n">]</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>如果关联的grades.type字段为quiz，则以下内容将更新嵌套的grades.questions数组中大于或等于8的值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students3.update</span><span class="p">(</span>
   <span class="p">{},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">inc</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[t].questions.$[score]&#34;</span><span class="o">:</span> <span class="m">2</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="s">&#34;t.type&#34;</span><span class="o">:</span> <span class="s">&#34;quiz&#34;</span> <span class="p">}</span> <span class="p">,</span> <span class="p">{</span> <span class="s">&#34;score&#34;</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="m">8</span> <span class="p">}</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作后，集合具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;grades&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;quiz&#34;</span><span class="p">,</span> <span class="nt">&#34;questions&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span> <span class="p">]</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;quiz&#34;</span><span class="p">,</span> <span class="nt">&#34;questions&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">6</span> <span class="p">]</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;hw&#34;</span><span class="p">,</span> <span class="nt">&#34;questions&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span> <span class="p">]</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;exam&#34;</span><span class="p">,</span> <span class="nt">&#34;questions&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>要更新所有大于或等于8嵌套grades.questions数组中的值，无视type：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students3.update</span><span class="p">(</span>
   <span class="p">{},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">inc</span><span class="o">:</span> <span class="p">{</span> <span class="s">&#34;grades.$[].questions.$[score]&#34;</span><span class="o">:</span> <span class="m">2</span> <span class="p">}</span> <span class="p">},</span>
   <span class="p">{</span> <span class="n">arrayFilters</span><span class="o">:</span> <span class="n">[</span>  <span class="p">{</span> <span class="s">&#34;score&#34;</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="m">8</span> <span class="p">}</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span><span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="addtoset"><code>$addToSet</code><a hidden class="anchor" aria-hidden="true" href="#addtoset">#</a></h1>
<p>除非该值已存在，否则<code>$addToSet</code>运算符会向该数组添加一个值，在这种情况下，<code>$addToSet</code>对该数组不执行任何操作。</p>
<p>该<code>$addToSet</code>的形式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">field1</span><span class="o">&gt;:</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>若要在嵌入式文档或数组中指定<code>&lt;field&gt;</code>，请使用点表示法。</p>
<h2 id="特性-3">特性<a hidden class="anchor" aria-hidden="true" href="#特性-3">#</a></h2>
<p><code>$addToSet</code>仅确保没有重复项添加到集合中，并且不影响现有重复项。 <code>$addToSet</code>不保证修改后的集合中元素的特定顺序。</p>
<h3 id="缺少字段">缺少字段<a hidden class="anchor" aria-hidden="true" href="#缺少字段">#</a></h3>
<p>如果<code>$addToSet</code>在文档中不存在的字段上进行更新，请<code>$addToSet</code>使用指定值作为元素创建数组字段。</p>
<h3 id="字段不是数组">字段不是数组<a hidden class="anchor" aria-hidden="true" href="#字段不是数组">#</a></h3>
<p>如果$addToSet在不是数组的字段上使用，该操作将失败。例如，考虑foo包含非数组字段的集合中的文档 colors。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">:</span> <span class="s">&#34;blue,green,red&#34;</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>$addToSet对非数组字段的以下操作 colors失败：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.foo.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="n">colors</span><span class="o">:</span> <span class="s">&#34;c&#34;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="要添加的值是一个数组">要添加的值是一个数组<a hidden class="anchor" aria-hidden="true" href="#要添加的值是一个数组">#</a></h3>
<p>如果该值为数组，则<code>$addToSet</code>将整个数组作为单个元素附加。</p>
<p>考虑test包含数组字段的集合中的文档letters：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="kc">letters</span><span class="o">:</span> <span class="n">[</span><span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作将数组[“ c”，“ d”]追加到letters字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.test.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="kc">letters</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;c&#34;</span><span class="p">,</span> <span class="s">&#34;d&#34;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>letters数组现在包含[“ c”，“ d”]数组作为元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="kc">letters</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">,</span> <span class="n">[</span> <span class="s">&#34;c&#34;</span><span class="p">,</span> <span class="s">&#34;d&#34;</span> <span class="n">]</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>TIP:</p>
<p>要分别添加值的每个元素，请将<code>$each</code>修饰符与<code>$addToSet</code>一起使用。 有关详细信息，请参见<code>$each</code>修饰符。</p>
<h3 id="要添加的值是一个文档">要添加的值是一个文档<a hidden class="anchor" aria-hidden="true" href="#要添加的值是一个文档">#</a></h3>
<p>如果值为文档，则如果数组中的现有文档与要添加的文档完全匹配，则MongoDB会确定该文档为重复文档；也就是说，现有文档具有完全相同的字段和值，并且字段的顺序相同。因此，字段顺序很重要，您不能指定MongoDB仅比较文档中字段的子集来确定文档是否与现有数组元素重复。</p>
<h2 id="例子-3">例子<a hidden class="anchor" aria-hidden="true" href="#例子-3">#</a></h2>
<p>考虑inventory包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">item</span><span class="o">:</span> <span class="s">&#34;polarizing_filter&#34;</span><span class="p">,</span> <span class="n">tags</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;electronics&#34;</span><span class="p">,</span> <span class="s">&#34;camera&#34;</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="添加到数组">添加到数组<a hidden class="anchor" aria-hidden="true" href="#添加到数组">#</a></h3>
<p>由于数组中不存在此元素&quot;accessories&quot;，因此以下操作将tags:&ldquo;accessories&quot;添加到数组中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="n">tags</span><span class="o">:</span> <span class="s">&#34;accessories&#34;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="值已经存在">值已经存在<a hidden class="anchor" aria-hidden="true" href="#值已经存在">#</a></h3>
<p>以下$addToSet操作无效，因为 &ldquo;camera&quot;它已经是tags数组的元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="n">tags</span><span class="o">:</span> <span class="s">&#34;camera&#34;</span>  <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="each修饰符"><code>$each</code>修饰符<a hidden class="anchor" aria-hidden="true" href="#each修饰符">#</a></h3>
<p>您可以将<code>$addToSet</code>运算符与<code>$each</code>修饰符一起使用。 <code>$each</code>修饰符允许<code>$addToSet</code>运算符将多个值添加到数组字段。</p>
<p>集合inventory具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="err">_id:</span> <span class="err">2,</span> <span class="err">item:</span> <span class="nt">&#34;cable&#34;</span><span class="p">,</span> <span class="err">tags:</span> <span class="err">[</span> <span class="nt">&#34;electronics&#34;</span><span class="p">,</span> <span class="nt">&#34;supplies&#34;</span> <span class="err">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，以下操作将<code>$addToSet</code>运算符与<code>$each</code>修饰符一起使用，以将多个元素添加到tags数组中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">2</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="n">tags</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;camera&#34;</span><span class="p">,</span> <span class="s">&#34;electronics&#34;</span><span class="p">,</span> <span class="s">&#34;accessories&#34;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
 <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作对tags数组仅增加&quot;camera&quot;以及&quot;accessories&rdquo;，因为&quot;electronics&quot;数组中已经存在：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="err">_id:</span> <span class="err">2,</span>
  <span class="err">item:</span> <span class="nt">&#34;cable&#34;</span><span class="p">,</span>
  <span class="err">tags:</span> <span class="err">[</span> <span class="nt">&#34;electronics&#34;</span><span class="p">,</span> <span class="nt">&#34;supplies&#34;</span><span class="p">,</span> <span class="nt">&#34;camera&#34;</span><span class="p">,</span> <span class="nt">&#34;accessories&#34;</span> <span class="err">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="pop"><code>$pop</code><a hidden class="anchor" aria-hidden="true" href="#pop">#</a></h1>
<p><code>$pop</code>运算符删除数组的第一个或最后一个元素。传递<code>$pop</code>值为-1删除数组的第一个元素，传递1删除数组的最后一个元素。</p>
<p><code>$pop</code>的形式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">pop</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">field</span><span class="o">&gt;:</span> <span class="o">&lt;-</span><span class="m">1</span> <span class="o">|</span> <span class="m">1</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>若要在嵌入式文档或数组中指定<code>&lt;field&gt;</code>，请使用点表示法。</p>
<h2 id="特性-4">特性<a hidden class="anchor" aria-hidden="true" href="#特性-4">#</a></h2>
<p>如果<code>&lt;field&gt;</code>不是数组，则$ pop操作失败。</p>
<p>如果<code>$pop</code>运算符删除了<code>&lt;field&gt;</code>中的最后一项，则<code>&lt;field&gt;</code>将保存一个空数组。</p>
<h2 id="例子-4">例子<a hidden class="anchor" aria-hidden="true" href="#例子-4">#</a></h2>
<h3 id="删除数组的第一个项目">删除数组的第一个项目<a hidden class="anchor" aria-hidden="true" href="#删除数组的第一个项目">#</a></h3>
<p>给定以下文件的集合students：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">scores</span><span class="o">:</span> <span class="n">[</span> <span class="m">8</span><span class="p">,</span> <span class="m">9</span><span class="p">,</span> <span class="m">10</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下示例删除了数组中的第一个元素scores（8） ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span> <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span> <span class="p">{</span> <span class="o">$</span><span class="n">pop</span><span class="o">:</span> <span class="p">{</span> <span class="n">scores</span><span class="o">:</span> <span class="m">-1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作后，将scores数组中的第一项删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">scores</span><span class="o">:</span> <span class="n">[</span> <span class="m">9</span><span class="p">,</span> <span class="m">10</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="删除数组的最后一项">删除数组的最后一项<a hidden class="anchor" aria-hidden="true" href="#删除数组的最后一项">#</a></h3>
<p>给定以下文件的集合students：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="n">scores</span><span class="o">:</span> <span class="n">[</span> <span class="m">9</span><span class="p">,</span> <span class="m">10</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下示例通过在$ pop表达式中指定1来删除scores数组中的最后一个元素（10）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span> <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span> <span class="p">{</span> <span class="o">$</span><span class="n">pop</span><span class="o">:</span> <span class="p">{</span> <span class="n">scores</span><span class="o">:</span> <span class="m">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作后，更新后的文档将最后一个项目10 从其scores数组中删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="err">_id:</span> <span class="err">1,</span> <span class="err">scores:</span> <span class="err">[</span> <span class="err">9</span> <span class="err">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="pull"><code>$pull</code><a hidden class="anchor" aria-hidden="true" href="#pull">#</a></h1>
<p><code>$pull</code>运算符从现有数组中删除一个或多个与指定条件匹配的值的所有实例。</p>
<p><code>$pull</code>运算符的形式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">pull</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">field1</span><span class="o">&gt;:</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">|</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">field2</span><span class="o">&gt;:</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">|</span><span class="n">condition</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>若要在嵌入式文档或数组中指定<code>&lt;field&gt;</code>，请使用点表示法。</p>
<h2 id="特性-5">特性<a hidden class="anchor" aria-hidden="true" href="#特性-5">#</a></h2>
<p>如果指定<code>&lt;condition&gt;</code>并且数组元素是嵌入式文档，则<code>$pull</code>运算符将应用<code>&lt;condition&gt;</code>就像每个数组元素都是集合中的文档一样。</p>
<p>如果要删除的指定<code>&lt;value&gt;</code>是数组，则$ pull仅删除与指定的<code>&lt;value&gt;</code>完全匹配的数组元素，包括顺序。</p>
<p>如果要删除的指定<code>&lt;value&gt;</code>是文档，则$ pull仅删除数组中具有完全相同的字段和值的元素。字段的顺序可以不同。</p>
<h2 id="例子-5">例子<a hidden class="anchor" aria-hidden="true" href="#例子-5">#</a></h2>
<h3 id="删除所有等于指定的值的项目">删除所有等于指定的值的项目<a hidden class="anchor" aria-hidden="true" href="#删除所有等于指定的值的项目">#</a></h3>
<p>给定stores集合中的以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span>
   <span class="n">_id</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
   <span class="n">fruits</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;apples&#34;</span><span class="p">,</span> <span class="s">&#34;pears&#34;</span><span class="p">,</span> <span class="s">&#34;oranges&#34;</span><span class="p">,</span> <span class="s">&#34;grapes&#34;</span><span class="p">,</span> <span class="s">&#34;bananas&#34;</span> <span class="n">]</span><span class="p">,</span>
   <span class="n">vegetables</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;carrots&#34;</span><span class="p">,</span> <span class="s">&#34;celery&#34;</span><span class="p">,</span> <span class="s">&#34;squash&#34;</span><span class="p">,</span> <span class="s">&#34;carrots&#34;</span> <span class="n">]</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="n">_id</span><span class="o">:</span> <span class="m">2</span><span class="p">,</span>
   <span class="n">fruits</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;plums&#34;</span><span class="p">,</span> <span class="s">&#34;kiwis&#34;</span><span class="p">,</span> <span class="s">&#34;oranges&#34;</span><span class="p">,</span> <span class="s">&#34;bananas&#34;</span><span class="p">,</span> <span class="s">&#34;apples&#34;</span> <span class="n">]</span><span class="p">,</span>
   <span class="n">vegetables</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;broccoli&#34;</span><span class="p">,</span> <span class="s">&#34;zucchini&#34;</span><span class="p">,</span> <span class="s">&#34;carrots&#34;</span><span class="p">,</span> <span class="s">&#34;onions&#34;</span> <span class="n">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作更新集合中的所有文档，以从fruits中除去“苹果”和“橙子”，并从vegetables中除去“carrots”：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.stores.update</span><span class="p">(</span>
    <span class="p">{</span> <span class="p">},</span>
    <span class="p">{</span> <span class="o">$</span><span class="n">pull</span><span class="o">:</span> <span class="p">{</span> <span class="n">fruits</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">in</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;apples&#34;</span><span class="p">,</span> <span class="s">&#34;oranges&#34;</span> <span class="n">]</span> <span class="p">},</span> <span class="n">vegetables</span><span class="o">:</span> <span class="s">&#34;carrots&#34;</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作之后，fruits数组不再包含任何“apples”或“oranges”值，而蔬菜数组不再包含任何“carrots”值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;fruits&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;pears&#34;</span><span class="p">,</span> <span class="s2">&#34;grapes&#34;</span><span class="p">,</span> <span class="s2">&#34;bananas&#34;</span> <span class="p">],</span>
  <span class="nt">&#34;vegetables&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;celery&#34;</span><span class="p">,</span> <span class="s2">&#34;squash&#34;</span> <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;fruits&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;plums&#34;</span><span class="p">,</span> <span class="s2">&#34;kiwis&#34;</span><span class="p">,</span> <span class="s2">&#34;bananas&#34;</span> <span class="p">],</span>
  <span class="nt">&#34;vegetables&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="s2">&#34;broccoli&#34;</span><span class="p">,</span> <span class="s2">&#34;zucchini&#34;</span><span class="p">,</span> <span class="s2">&#34;onions&#34;</span> <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="删除所有符合指定pull条件的项目">删除所有符合指定<code>$pull条件</code>的项目<a hidden class="anchor" aria-hidden="true" href="#删除所有符合指定pull条件的项目">#</a></h3>
<p>给定profiles集合中的以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="err">_id:</span> <span class="err">1,</span> <span class="err">votes:</span> <span class="err">[</span> <span class="err">3,</span> <span class="err">5,</span> <span class="err">6,</span> <span class="err">7,</span> <span class="err">7,</span> <span class="err">8</span> <span class="err">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面的操作将从votes数组中删除所有大于或等于（<code>$gte</code>）6的项目：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.profiles.update</span><span class="p">(</span> <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span> <span class="p">{</span> <span class="o">$</span><span class="n">pull</span><span class="o">:</span> <span class="p">{</span> <span class="n">votes</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="m">6</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>更新操作后，文档的值仅小于6：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="err">_id:</span> <span class="err">1,</span> <span class="err">votes:</span> <span class="err">[</span>  <span class="err">3,</span>  <span class="err">5</span> <span class="err">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="从文档数组中删除项目">从文档数组中删除项目<a hidden class="anchor" aria-hidden="true" href="#从文档数组中删除项目">#</a></h3>
<p>一个survey集合包含以下文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="err">_id:</span> <span class="err">1,</span>
   <span class="err">results:</span> <span class="err">[</span>
      <span class="err">{</span> <span class="err">item:</span> <span class="nt">&#34;A&#34;</span><span class="p">,</span> <span class="err">score:</span> <span class="err">5</span> <span class="p">}</span><span class="err">,</span>
      <span class="p">{</span> <span class="err">item:</span> <span class="nt">&#34;B&#34;</span><span class="p">,</span> <span class="err">score:</span> <span class="err">8,</span> <span class="err">comment:</span> <span class="nt">&#34;Strongly agree&#34;</span> <span class="p">}</span>
   <span class="err">]</span>
<span class="err">}</span>
<span class="p">{</span>
   <span class="err">_id:</span> <span class="err">2,</span>
   <span class="err">results:</span> <span class="err">[</span>
      <span class="err">{</span> <span class="err">item:</span> <span class="nt">&#34;C&#34;</span><span class="p">,</span> <span class="err">score:</span> <span class="err">8,</span> <span class="err">comment:</span> <span class="nt">&#34;Strongly agree&#34;</span> <span class="p">}</span><span class="err">,</span>
      <span class="p">{</span> <span class="err">item:</span> <span class="nt">&#34;B&#34;</span><span class="p">,</span> <span class="err">score:</span> <span class="err">4</span> <span class="p">}</span>
   <span class="err">]</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作将从results数组中删除所有既包含得分字段等于8又包含item字段等于“B”的元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.survey.update</span><span class="p">(</span>
  <span class="p">{</span> <span class="p">},</span>
  <span class="p">{</span> <span class="o">$</span><span class="n">pull</span><span class="o">:</span> <span class="p">{</span> <span class="n">results</span><span class="o">:</span> <span class="p">{</span> <span class="n">score</span><span class="o">:</span> <span class="m">8</span> <span class="p">,</span> <span class="n">item</span><span class="o">:</span> <span class="s">&#34;B&#34;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>$pull</code>表达式将条件应用于结果数组的每个元素，就好像它是顶级文档一样。</p>
<p>操作之后，results数组将不包含score字段等于8且item字段等于“ B”的文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;results&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;A&#34;</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">}</span> <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;results&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;C&#34;</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="nt">&#34;comment&#34;</span> <span class="p">:</span> <span class="s2">&#34;Strongly agree&#34;</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;B&#34;</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>因为<code>$pull</code>运算符将其查询应用于每个元素，就好像它是顶级对象一样，该表达式不需要使用<code>$elemMatch</code>来指定等于8的score字段和等于“B”的item字段的条件。实际上，以下操作不会从原始集合中提取任何元素。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.survey.update</span><span class="p">(</span>
  <span class="p">{</span> <span class="p">},</span>
  <span class="p">{</span> <span class="o">$</span><span class="n">pull</span><span class="o">:</span> <span class="p">{</span> <span class="n">results</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">elemMatch</span><span class="o">:</span> <span class="p">{</span> <span class="n">score</span><span class="o">:</span> <span class="m">8</span> <span class="p">,</span> <span class="n">item</span><span class="o">:</span> <span class="s">&#34;B&#34;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>但是，如果survey集合包含以下文档，则该results数组包含的嵌入式文档也包含数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="err">_id:</span> <span class="err">1,</span>
   <span class="err">results:</span> <span class="err">[</span>
      <span class="err">{</span> <span class="err">item:</span> <span class="nt">&#34;A&#34;</span><span class="p">,</span> <span class="err">score:</span> <span class="err">5,</span> <span class="err">answers:</span> <span class="err">[</span> <span class="err">{</span> <span class="err">q:</span> <span class="err">1,</span> <span class="err">a:</span> <span class="err">4</span> <span class="p">}</span><span class="err">,</span> <span class="p">{</span> <span class="err">q:</span> <span class="err">2,</span> <span class="err">a:</span> <span class="err">6</span> <span class="p">}</span> <span class="err">]</span> <span class="err">},</span>
      <span class="p">{</span> <span class="err">item:</span> <span class="nt">&#34;B&#34;</span><span class="p">,</span> <span class="err">score:</span> <span class="err">8,</span> <span class="err">answers:</span> <span class="err">[</span> <span class="err">{</span> <span class="err">q:</span> <span class="err">1,</span> <span class="err">a:</span> <span class="err">8</span> <span class="p">}</span><span class="err">,</span> <span class="p">{</span> <span class="err">q:</span> <span class="err">2,</span> <span class="err">a:</span> <span class="err">9</span> <span class="p">}</span> <span class="err">]</span> <span class="err">}</span>
   <span class="err">]</span>
<span class="err">}</span>
<span class="p">{</span>
   <span class="err">_id:</span> <span class="err">2,</span>
   <span class="err">results:</span> <span class="err">[</span>
      <span class="err">{</span> <span class="err">item:</span> <span class="nt">&#34;C&#34;</span><span class="p">,</span> <span class="err">score:</span> <span class="err">8,</span> <span class="err">answers:</span> <span class="err">[</span> <span class="err">{</span> <span class="err">q:</span> <span class="err">1,</span> <span class="err">a:</span> <span class="err">8</span> <span class="p">}</span><span class="err">,</span> <span class="p">{</span> <span class="err">q:</span> <span class="err">2,</span> <span class="err">a:</span> <span class="err">7</span> <span class="p">}</span> <span class="err">]</span> <span class="err">},</span>
      <span class="p">{</span> <span class="err">item:</span> <span class="nt">&#34;B&#34;</span><span class="p">,</span> <span class="err">score:</span> <span class="err">4,</span> <span class="err">answers:</span> <span class="err">[</span> <span class="err">{</span> <span class="err">q:</span> <span class="err">1,</span> <span class="err">a:</span> <span class="err">0</span> <span class="p">}</span><span class="err">,</span> <span class="p">{</span> <span class="err">q:</span> <span class="err">2,</span> <span class="err">a:</span> <span class="err">8</span> <span class="p">}</span> <span class="err">]</span> <span class="err">}</span>
   <span class="err">]</span>
<span class="err">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，您可以使用<code>$elemMatch</code>在Answers数组的元素上指定多个条件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.survey.update</span><span class="p">(</span>
  <span class="p">{</span> <span class="p">},</span>
  <span class="p">{</span> <span class="o">$</span><span class="n">pull</span><span class="o">:</span> <span class="p">{</span> <span class="n">results</span><span class="o">:</span> <span class="p">{</span> <span class="n">answers</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">elemMatch</span><span class="o">:</span> <span class="p">{</span> <span class="n">q</span><span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="n">a</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">gte</span><span class="o">:</span> <span class="m">8</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">multi</span><span class="o">:</span> <span class="n">true</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作从结果数组中删除了那些包含answer字段的嵌入式文档，这些文档包含至少一个q等于2且大于或等于8的元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;results&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;A&#34;</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&#34;answers&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nt">&#34;q&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;a&#34;</span> <span class="p">:</span> <span class="mi">4</span> <span class="p">},</span> <span class="p">{</span> <span class="nt">&#34;q&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;a&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
<span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
   <span class="nt">&#34;results&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;C&#34;</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="nt">&#34;answers&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">{</span> <span class="nt">&#34;q&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;a&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">},</span> <span class="p">{</span> <span class="nt">&#34;q&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;a&#34;</span> <span class="p">:</span> <span class="mi">7</span> <span class="p">}</span> <span class="p">]</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="push">$push<a hidden class="anchor" aria-hidden="true" href="#push">#</a></h1>
<p><code>$push</code>运算符将指定的值附加到数组。</p>
<p><code>$push</code>运算符的形式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">field1</span><span class="o">&gt;:</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>若要在嵌入式文档或数组中指定<code>&lt;field&gt;</code>，请使用点表示法。</p>
<h2 id="特性-6">特性<a hidden class="anchor" aria-hidden="true" href="#特性-6">#</a></h2>
<p>如果文档中不存在要更新的字段，则<code>$push</code>将以值作为元素的数组字段添加。</p>
<p>如果该字段不是数组，则操作将失败。</p>
<p>如果该值为数组，则<code>$push</code>将整个数组作为单个元素附加。要分别添加值的每个元素，请将<code>$each</code>修饰符与<code>$push</code>一起使用。</p>
<h3 id="modifiers">Modifiers<a hidden class="anchor" aria-hidden="true" href="#modifiers">#</a></h3>
<p>您可以将<code>$push</code>运算符与以下修饰符一起使用：</p>
<p>您可以将$push运算符与以下修饰符一起使用：</p>
<table>
<thead>
<tr>
<th>修饰符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>$each</td>
<td>将多个值附加到数组字段。</td>
</tr>
<tr>
<td>$slice</td>
<td>限制数组元素的数量。需要使用 $each修饰符。</td>
</tr>
<tr>
<td>$sort</td>
<td>排序数组的元素。需要使用 $each修饰符。</td>
</tr>
<tr>
<td>$position</td>
<td>指定要在数组中插入新元素的位置。需要使用$each修饰符。如果没有$position修饰符，则将$push 元素追加到数组的末尾。</td>
</tr>
</tbody>
</table>
<p>与修饰符一起使用时，$push运算符具有以下形式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">field1</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">modifier1</span><span class="o">&gt;:</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">...</span> <span class="p">},</span> <span class="kc">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>push不管修饰符出现的顺序如何，使用修饰符进行的操作的处理均按以下顺序进行：</p>
<ol>
<li>更新数组以将元素添加到正确的位置。</li>
<li>如果指定，则应用排序。</li>
<li>切片数组（如果指定）。</li>
<li>存储数组。</li>
</ol>
<h2 id="例子-6">例子<a hidden class="anchor" aria-hidden="true" href="#例子-6">#</a></h2>
<h3 id="将值附加到数组">将值附加到数组<a hidden class="anchor" aria-hidden="true" href="#将值附加到数组">#</a></h3>
<p>下面的示例追加89到scores数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span> <span class="n">scores</span><span class="o">:</span> <span class="m">89</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="将多个值追加到数组中">将多个值追加到数组中<a hidden class="anchor" aria-hidden="true" href="#将多个值追加到数组中">#</a></h3>
<p><code>$push</code>与<code>$each</code>修饰符一起使用可将多个值附加到数组字段。</p>
<p>下面的示例将[90、92、85]的每个元素附加到名称字段等于joe的文档的scores数组中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="s">&#34;joe&#34;</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span> <span class="n">scores</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="m">90</span><span class="p">,</span> <span class="m">92</span><span class="p">,</span> <span class="m">85</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="将push运算符与多个修饰符一起使用">将<code>$push</code>运算符与多个修饰符一起使用<a hidden class="anchor" aria-hidden="true" href="#将push运算符与多个修饰符一起使用">#</a></h3>
<p>集合students具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
   <span class="nt">&#34;quizzes&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下$push操作使用：</p>
<ul>
<li><code>$each</code>修饰符可将多个文档添加到quizzes数组中，</li>
<li><code>$sort</code>修饰符可按分数字段的降序对修改后的quizzes数组的所有元素进行排序，并且</li>
<li><code>$slice</code>修饰符仅保留quizzes数组的前三个排序元素。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">5</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
       <span class="n">quizzes</span><span class="o">:</span> <span class="p">{</span>
          <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">5</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">8</span> <span class="p">},</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">6</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">7</span> <span class="p">},</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">7</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">6</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span>
          <span class="o">$</span><span class="n">sort</span><span class="o">:</span> <span class="p">{</span> <span class="n">score</span><span class="o">:</span> <span class="m">-1</span> <span class="p">},</span>
          <span class="o">$</span><span class="n">slice</span><span class="o">:</span> <span class="m">3</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作的结果是quizzes数组仅保留三个最高得分：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span>
  <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">5</span><span class="p">,</span>
  <span class="s">&#34;quizzes&#34;</span> <span class="o">:</span> <span class="n">[</span>
     <span class="p">{</span> <span class="s">&#34;wk&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;score&#34;</span> <span class="o">:</span> <span class="m">10</span> <span class="p">},</span>
     <span class="p">{</span> <span class="s">&#34;wk&#34;</span> <span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="s">&#34;score&#34;</span> <span class="o">:</span> <span class="m">8</span> <span class="p">},</span>
     <span class="p">{</span> <span class="s">&#34;wk&#34;</span> <span class="o">:</span> <span class="m">5</span><span class="p">,</span> <span class="s">&#34;score&#34;</span> <span class="o">:</span> <span class="m">8</span> <span class="p">}</span>
  <span class="n">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="pullall">$pullAll<a hidden class="anchor" aria-hidden="true" href="#pullall">#</a></h1>
<p><code>$pullAll</code>运算符将从现有数组中删除所有指定值的实例。与<code>$pull</code>运算符通过指定查询删除元素不同，<code>$pullAll</code>删除与列出的值匹配的元素。</p>
<p><code>$pullAll</code>运算符的形式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">pullAll</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">field1</span><span class="o">&gt;:</span> <span class="n">[</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">value2</span><span class="o">&gt;</span> <span class="kc">...</span> <span class="n">]</span><span class="p">,</span> <span class="kc">...</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>若要在嵌入式文档或数组中指定<code>&lt;field&gt;</code>，请使用点表示法。</p>
<h2 id="特性-7">特性<a hidden class="anchor" aria-hidden="true" href="#特性-7">#</a></h2>
<p>如果要删除的<code>&lt;value&gt;</code>是文档或数组，则<code>$pullAll</code>仅删除与指定的<code>&lt;value&gt;</code>完全匹配的数组元素，包括顺序。</p>
<h2 id="示例">示例<a hidden class="anchor" aria-hidden="true" href="#示例">#</a></h2>
<p>给定survey集合中的以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">{ _id: 1, scores: [ 0, 2, 5, 5, 1, 0 ] }
</code></pre></td></tr></table>
</div>
</div><p>以下操作从scores数组中删除值0和5的所有实例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.survey.update</span><span class="p">(</span> <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span> <span class="p">{</span> <span class="o">$</span><span class="n">pullAll</span><span class="o">:</span> <span class="p">{</span> <span class="n">scores</span><span class="o">:</span> <span class="n">[</span> <span class="m">0</span><span class="p">,</span> <span class="m">5</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作完成后，更新后的文档将从“分数”字段中删除了所有实例0和5：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;scores&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="each">$each<a hidden class="anchor" aria-hidden="true" href="#each">#</a></h1>
<p><code>$each</code>修饰符可与<code>$addToSet</code>运算符和<code>$push</code>运算符一起使用。</p>
<p>如果值在<code>&lt;field&gt;</code>中不存在，请与<code>$addToSet</code>运算符一起使用，以将多个值添加到数组<code>&lt;field&gt;</code>中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">field</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">value2</span><span class="o">&gt;</span> <span class="kc">...</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>与<code>$push</code>运算符一起使用，可以将多个值附加到数组<code>&lt;field&gt;</code>中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span> <span class="o">&lt;</span><span class="n">field</span><span class="o">&gt;:</span> <span class="p">{</span> <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">value2</span><span class="o">&gt;</span> <span class="kc">...</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>$push</code>运算符可以将<code>$each</code>修饰符与其他修饰符一起使用。有关<code>$push</code>可用的修饰符的列表，请参见修饰符。</p>
<h2 id="例子-7">例子<a hidden class="anchor" aria-hidden="true" href="#例子-7">#</a></h2>
<h3 id="each与push运算符一起使用"><code>$each</code>与<code>$push</code>运算符一起使用<a hidden class="anchor" aria-hidden="true" href="#each与push运算符一起使用">#</a></h3>
<p>下面的示例将<code>[90、92、85]</code>的每个元素附加到名称字段等于joe的文档的scores数组中：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">name</span><span class="o">:</span> <span class="s">&#34;joe&#34;</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span> <span class="n">scores</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="m">90</span><span class="p">,</span> <span class="m">92</span><span class="p">,</span> <span class="m">85</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="each-与addtoset运算符一起使用"><code>$each</code> 与<code>$addToSet</code>运算符一起使用<a hidden class="anchor" aria-hidden="true" href="#each-与addtoset运算符一起使用">#</a></h3>
<p>集合inventory具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="n">item</span><span class="o">:</span> <span class="s">&#34;cable&#34;</span><span class="p">,</span> <span class="n">tags</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;electronics&#34;</span><span class="p">,</span> <span class="s">&#34;supplies&#34;</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后，以下操作将<code>$addToSet</code>运算符与<code>$each</code>修饰符一起使用，以将多个元素添加到tags数组：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.inventory.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">2</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="n">tags</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;camera&#34;</span><span class="p">,</span> <span class="s">&#34;electronics&#34;</span><span class="p">,</span> <span class="s">&#34;accessories&#34;</span> <span class="n">]</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
 <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作仅向标签数组添加“camera”和“accessories”，因为数组中已经存在“electronics”：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span>
  <span class="n">_id</span><span class="o">:</span> <span class="m">2</span><span class="p">,</span>
  <span class="n">item</span><span class="o">:</span> <span class="s">&#34;cable&#34;</span><span class="p">,</span>
  <span class="n">tags</span><span class="o">:</span> <span class="n">[</span> <span class="s">&#34;electronics&#34;</span><span class="p">,</span> <span class="s">&#34;supplies&#34;</span><span class="p">,</span> <span class="s">&#34;camera&#34;</span><span class="p">,</span> <span class="s">&#34;accessories&#34;</span> <span class="n">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="position">$position<a hidden class="anchor" aria-hidden="true" href="#position">#</a></h1>
<p><code>$position</code>修饰符指定<code>$push</code>运算符在数组中插入元素的位置。如果没有<code>$position</code>修饰符，则<code>$push</code>运算符会将元素插入到数组的末尾。</p>
<p>要使用<code>$position</code>修饰符，它必须与<code>$each</code>修饰符一起出现。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span>
  <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
    <span class="o">&lt;</span><span class="n">field</span><span class="o">&gt;:</span> <span class="p">{</span>
       <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">value2</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">...</span> <span class="n">]</span><span class="p">,</span>
       <span class="o">$</span><span class="n">position</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">num</span><span class="o">&gt;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在版本3.6中更改：<code>$position</code>可以接受一个负数组索引值来指示从末尾开始的位置，该位置从（但不包括）数组的最后一个元素开始计数。</p>
<p><code>&lt;num&gt;</code> 根据从零开始的索引指示数组中的位置：</p>
<ul>
<li>从数组的开头开始，非负数对应于数组中的位置。如果<code>&lt;num&gt;</code>的值大于或等于数组的长度，则<code>$position</code>修饰符无效，<code>$push</code>将元素添加到数组的末尾。</li>
<li>从（但不包括）数组的最后一个元素开始,负数对应于数组中的位置。例如，-1指示数组中最后一个元素之前的位置。如果在<code>$each</code>数组中指定多个元素 ，则最后添加的元素位于末尾的指定位置。如果的绝对值<code>&lt;num&gt;</code>大于或等于数组的长度，则将$push 元素添加到数组的开头。</li>
</ul>
<h2 id="例子-8">例子<a hidden class="anchor" aria-hidden="true" href="#例子-8">#</a></h2>
<h3 id="在数组的开头添加元素">在数组的开头添加元素<a hidden class="anchor" aria-hidden="true" href="#在数组的开头添加元素">#</a></h3>
<p>考虑一个students包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;scores&#34;</span> <span class="o">:</span> <span class="n">[</span> <span class="m">100</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作将更新scores字段，以将元素50、60和70添加到数组的开头：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
        <span class="n">scores</span><span class="o">:</span> <span class="p">{</span>
           <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="m">50</span><span class="p">,</span> <span class="m">60</span><span class="p">,</span> <span class="m">70</span> <span class="n">]</span><span class="p">,</span>
           <span class="o">$</span><span class="n">position</span><span class="o">:</span> <span class="m">0</span>
        <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作生成以下更新的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;scores&#34;</span> <span class="p">:</span> <span class="p">[</span>  <span class="mi">50</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">100</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="在数组中间添加元素">在数组中间添加元素<a hidden class="anchor" aria-hidden="true" href="#在数组中间添加元素">#</a></h3>
<p>考虑一个students包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;scores&#34;</span> <span class="p">:</span> <span class="p">[</span>  <span class="mi">50</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">100</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作将更新scores字段，以在数组索引2处添加元素20和30：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
        <span class="n">scores</span><span class="o">:</span> <span class="p">{</span>
           <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="m">20</span><span class="p">,</span> <span class="m">30</span> <span class="n">]</span><span class="p">,</span>
           <span class="o">$</span><span class="n">position</span><span class="o">:</span> <span class="m">2</span>
        <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作生成以下更新的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;scores&#34;</span> <span class="o">:</span> <span class="n">[</span>  <span class="m">50</span><span class="p">,</span>  <span class="m">60</span><span class="p">,</span>  <span class="m">20</span><span class="p">,</span>  <span class="m">30</span><span class="p">,</span>  <span class="m">70</span><span class="p">,</span>  <span class="m">100</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="使用负索引将元素添加到数组中">使用负索引将元素添加到数组中<a hidden class="anchor" aria-hidden="true" href="#使用负索引将元素添加到数组中">#</a></h3>
<p>在版本3.6中更改：$position可以接受一个负数组索引值来指示从末尾开始的位置，该位置从（但不包括）数组的最后一个元素开始计数。例如，-1 指示数组中最后一个元素之前的位置。</p>
<p>考虑一个students包含以下文档的集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;scores&#34;</span> <span class="o">:</span> <span class="n">[</span>  <span class="m">50</span><span class="p">,</span>  <span class="m">60</span><span class="p">,</span>  <span class="m">20</span><span class="p">,</span>  <span class="m">30</span><span class="p">,</span>  <span class="m">70</span><span class="p">,</span>  <span class="m">100</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作为<code>$position</code>指定-2，以在最后一个元素之前两个位置的位置加90，然后在最后一个元素之前两个位置的位置加80。</p>
<p>重要</p>
<p>对于负索引位置，如果在<code>$each</code>数组中指定多个元素，则最后添加的元素位于末尾的指定位置。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
        <span class="n">scores</span><span class="o">:</span> <span class="p">{</span>
           <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="m">90</span><span class="p">,</span> <span class="m">80</span> <span class="n">]</span><span class="p">,</span>
           <span class="o">$</span><span class="n">position</span><span class="o">:</span> <span class="m">-2</span>
        <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作生成以下更新的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;scores&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="slice">$slice<a hidden class="anchor" aria-hidden="true" href="#slice">#</a></h1>
<p><code>$slice</code>修饰符在<code>$push</code>操作期间限制数组元素的数量。要从读取操作中投影或返回指定数量的数组元素，请参阅<code>$slice</code>投影运算符。</p>
<p>要使用<code>$slice</code>修饰符，它必须与<code>$each</code>修饰符一起出现。您可以将一个空数组<code>[]</code>传递给<code>$each</code>修饰符，这样只有<code>$slice</code>修饰符才有效。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span>
  <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
     <span class="o">&lt;</span><span class="n">field</span><span class="o">&gt;:</span> <span class="p">{</span>
       <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">value2</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">...</span> <span class="n">]</span><span class="p">,</span>
       <span class="o">$</span><span class="n">slice</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">num</span><span class="o">&gt;</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>&lt;num&gt;</code>可以是：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>零</td>
<td>将数组更新为<code>&lt;field&gt;</code>空数组。</td>
</tr>
<tr>
<td>负</td>
<td>将数组更新为<code>&lt;field&gt;</code>仅包含最后<code>&lt;num&gt;</code>个元素。</td>
</tr>
<tr>
<td>正</td>
<td>要更新的数组<code>&lt;field&gt;</code>仅包含最前<code>&lt;num&gt;</code> 个元素。</td>
</tr>
</tbody>
</table>
<h2 id="特性-8">特性<a hidden class="anchor" aria-hidden="true" href="#特性-8">#</a></h2>
<p>修饰符出现的顺序无关紧要。以前的版本要求<code>$each</code>修饰符与<code>$slice</code>一起使用时，它会作为第一个修饰符出现。</p>
<p>尝试在没有<code>$each</code>修饰符的情况下使用$ slice修饰符会导致错误。</p>
<h2 id="例子-9">例子<a hidden class="anchor" aria-hidden="true" href="#例子-9">#</a></h2>
<h3 id="从数组末尾切片">从数组末尾切片<a hidden class="anchor" aria-hidden="true" href="#从数组末尾切片">#</a></h3>
<p>集合students包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;scores&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作将新元素添加到scores数组，然后使用<code>$slice</code>修饰符将数组修剪为最后五个元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
       <span class="n">scores</span><span class="o">:</span> <span class="p">{</span>
         <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="m">80</span><span class="p">,</span> <span class="m">78</span><span class="p">,</span> <span class="m">86</span> <span class="n">]</span><span class="p">,</span>
         <span class="o">$</span><span class="n">slice</span><span class="o">:</span> <span class="m">-5</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>操作的结果是将更新后的scores数组的元素切为最后五个元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;scores&#34;</span> <span class="p">:</span> <span class="p">[</span>  <span class="mi">50</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span>  <span class="mi">78</span><span class="p">,</span>  <span class="mi">86</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="从数组的前面切片">从数组的前面切片<a hidden class="anchor" aria-hidden="true" href="#从数组的前面切片">#</a></h3>
<p>集合students包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;scores&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">90</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作将新元素添加到scores数组，然后使用$slice修饰符将数组修剪为前三个元素。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">2</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
       <span class="n">scores</span><span class="o">:</span> <span class="p">{</span>
         <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="m">100</span><span class="p">,</span> <span class="m">20</span> <span class="n">]</span><span class="p">,</span>
         <span class="o">$</span><span class="n">slice</span><span class="o">:</span> <span class="m">3</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作的结果是将更新的scores数组的元素切片为前三个元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="s">&#34;scores&#34;</span> <span class="o">:</span> <span class="n">[</span>  <span class="m">89</span><span class="p">,</span>  <span class="m">90</span><span class="p">,</span>  <span class="m">100</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="仅使用分片更新数组">仅使用分片更新数组<a hidden class="anchor" aria-hidden="true" href="#仅使用分片更新数组">#</a></h3>
<p>集合students包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;scores&#34;</span> <span class="p">:</span> <span class="p">[</span>  <span class="mi">89</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">100</span><span class="p">,</span>  <span class="mi">20</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>要仅使用<code>$slice</code>修饰符的效果更新分数字段，请为<code>$slice</code>修饰符指定要切片的元素数（例如-3），为<code>$each</code>修饰符指定一个空数组[]，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
  <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">3</span> <span class="p">},</span>
  <span class="p">{</span>
    <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
      <span class="n">scores</span><span class="o">:</span> <span class="p">{</span>
         <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="n">]</span><span class="p">,</span>
         <span class="o">$</span><span class="n">slice</span><span class="o">:</span> <span class="m">-3</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作的结果是将scores数组的元素切片为最后三个元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span> <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">3</span><span class="p">,</span> <span class="s">&#34;scores&#34;</span> <span class="o">:</span> <span class="n">[</span>  <span class="m">70</span><span class="p">,</span>  <span class="m">100</span><span class="p">,</span>  <span class="m">20</span> <span class="n">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="slice与其他push修饰符一起使用"><code>$slice</code>与其他<code>$push</code>修饰符一起使用<a hidden class="anchor" aria-hidden="true" href="#slice与其他push修饰符一起使用">#</a></h3>
<p>集合students具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
   <span class="nt">&#34;quizzes&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下$push操作使用：</p>
<ul>
<li><code>$each</code>修饰符可将多个文档添加到quizzes数组中，</li>
<li><code>$sort</code>修饰符可按分数字段的降序对修改后的测quizzes数组的所有元素进行排序.</li>
<li><code>$slice</code>修饰符仅保留quizzes数组的前三个排序元素。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">5</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
       <span class="n">quizzes</span><span class="o">:</span> <span class="p">{</span>
          <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">5</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">8</span> <span class="p">},</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">6</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">7</span> <span class="p">},</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">7</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">6</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span>
          <span class="o">$</span><span class="n">sort</span><span class="o">:</span> <span class="p">{</span> <span class="n">score</span><span class="o">:</span> <span class="m">-1</span> <span class="p">},</span>
          <span class="o">$</span><span class="n">slice</span><span class="o">:</span> <span class="m">3</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作的结果是quizzes仅保留三个最高得分：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span>
  <span class="s">&#34;_id&#34;</span> <span class="o">:</span> <span class="m">5</span><span class="p">,</span>
  <span class="s">&#34;quizzes&#34;</span> <span class="o">:</span> <span class="n">[</span>
     <span class="p">{</span> <span class="s">&#34;wk&#34;</span> <span class="o">:</span> <span class="m">1</span><span class="p">,</span> <span class="s">&#34;score&#34;</span> <span class="o">:</span> <span class="m">10</span> <span class="p">},</span>
     <span class="p">{</span> <span class="s">&#34;wk&#34;</span> <span class="o">:</span> <span class="m">2</span><span class="p">,</span> <span class="s">&#34;score&#34;</span> <span class="o">:</span> <span class="m">8</span> <span class="p">},</span>
     <span class="p">{</span> <span class="s">&#34;wk&#34;</span> <span class="o">:</span> <span class="m">5</span><span class="p">,</span> <span class="s">&#34;score&#34;</span> <span class="o">:</span> <span class="m">8</span> <span class="p">}</span>
  <span class="n">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>修饰符的顺序与修饰符的处理顺序无关。</p>
<h1 id="sort">$sort<a hidden class="anchor" aria-hidden="true" href="#sort">#</a></h1>
<p><code>$sort</code>修饰符在<code>$push</code>操作期间对数组的元素进行排序。</p>
<p>要使用<code>$sort</code>修饰符，它必须与<code>$each</code>修饰符一起出现。您可以将一个空数组<code>[]</code>传递给<code>$each</code>修饰符，这样只有<code>$sort</code>修饰符才起作用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">{</span>
  <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
     <span class="o">&lt;</span><span class="n">field</span><span class="o">&gt;:</span> <span class="p">{</span>
       <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="o">&lt;</span><span class="n">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">value2</span><span class="o">&gt;</span><span class="p">,</span> <span class="kc">...</span> <span class="n">]</span><span class="p">,</span>
       <span class="o">$</span><span class="n">sort</span><span class="o">:</span> <span class="o">&lt;</span><span class="n">sort</span> <span class="n">specification</span><span class="o">&gt;</span>
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>对于：<code>&lt;sort specification&gt;</code></p>
<ul>
<li>要对不是文档的数组元素进行排序，或者如果数组元素是文档，则要对整个文档进行排序，请指定1代表升序，-1代表降序。</li>
<li>如果数组元素是文档，则要按文档中的字段排序，请指定具有字段和方向的排序文档，即{field：1}或{field：-1}。不要在排序规范中引用包含数组的字段（例如{“arrayField.field“：1}不正确）。</li>
</ul>
<h2 id="特性-9">特性<a hidden class="anchor" aria-hidden="true" href="#特性-9">#</a></h2>
<p><code>$sort</code>修饰符可以对不是文档的数组元素进行排序。在以前的版本中，<code>$sort</code>修饰符要求数组元素为文档。</p>
<p>如果数组元素是文档，则修饰符可以按整个文档或文档中的特定字段进行排序。在以前的版本中，<code>$sort</code>修饰符只能按文档中的特定字段排序。</p>
<p>尝试使用没有<code>$each</code>修饰符的<code>$sort</code>修饰符会导致错误。 <code>$sort</code>不再需要<code>$slice</code>修饰符。</p>
<h2 id="例子-10">例子<a hidden class="anchor" aria-hidden="true" href="#例子-10">#</a></h2>
<h3 id="按文档中的字段对文档数组进行排序">按文档中的字段对文档数组进行排序<a hidden class="anchor" aria-hidden="true" href="#按文档中的字段对文档数组进行排序">#</a></h3>
<p>集合students包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;_id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;quizzes&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nt">&#34;id&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nt">&#34;id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">9</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下更新将其他文档附加到quizzes数组，然后按升序对数组的所有元素score进行排序 ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">1</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
       <span class="n">quizzes</span><span class="o">:</span> <span class="p">{</span>
         <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="n">id</span><span class="o">:</span> <span class="m">3</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">8</span> <span class="p">},</span> <span class="p">{</span> <span class="n">id</span><span class="o">:</span> <span class="m">4</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">7</span> <span class="p">},</span> <span class="p">{</span> <span class="n">id</span><span class="o">:</span> <span class="m">5</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">6</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span>
         <span class="o">$</span><span class="n">sort</span><span class="o">:</span> <span class="p">{</span> <span class="n">score</span><span class="o">:</span> <span class="m">1</span> <span class="p">}</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>重要</p>
<p>排序文档直接引用文档中的字段，而不引用包含的数组quizzes字段；即{ score: 1 } ，而不是{“quizzes.score”：1}</p>
<p>更新后，数组元素按score字段升序排列 ：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">{
  &#34;_id&#34; : 1,
  &#34;quizzes&#34; : [
     { &#34;id&#34; : 1, &#34;score&#34; : 6 },
     { &#34;id&#34; : 5, &#34;score&#34; : 6 },
     { &#34;id&#34; : 4, &#34;score&#34; : 7 },
     { &#34;id&#34; : 3, &#34;score&#34; : 8 },
     { &#34;id&#34; : 2, &#34;score&#34; : 9 }
  ]
}
</code></pre></td></tr></table>
</div>
</div><h3 id="对不是文档的数组元素进行排序">对不是文档的数组元素进行排序<a hidden class="anchor" aria-hidden="true" href="#对不是文档的数组元素进行排序">#</a></h3>
<p>集合students包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;tests&#34;</span> <span class="p">:</span> <span class="p">[</span>  <span class="mi">89</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">89</span><span class="p">,</span>  <span class="mi">50</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下操作将另外两个元素添加到scores数组并对元素进行排序：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">2</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span> <span class="n">tests</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="m">40</span><span class="p">,</span> <span class="m">60</span> <span class="n">]</span><span class="p">,</span> <span class="o">$</span><span class="n">sort</span><span class="o">:</span> <span class="m">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>更新的文档具有scores按升序排列的数组元素：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;tests&#34;</span> <span class="p">:</span> <span class="p">[</span>  <span class="mi">40</span><span class="p">,</span>  <span class="mi">50</span><span class="p">,</span>  <span class="mi">60</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">89</span><span class="p">,</span>  <span class="mi">89</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="使用仅排序更新数组">使用仅排序更新数组<a hidden class="anchor" aria-hidden="true" href="#使用仅排序更新数组">#</a></h3>
<p>集合students包含以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;tests&#34;</span> <span class="p">:</span> <span class="p">[</span>  <span class="mi">89</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">100</span><span class="p">,</span>  <span class="mi">20</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>要更新测试字段以使其元素降序排序，请指定<code>{$ sort：-1}</code>并为<code>$each</code>修饰符指定一个空数组[]，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">3</span> <span class="p">},</span>
   <span class="p">{</span> <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span> <span class="n">tests</span><span class="o">:</span> <span class="p">{</span> <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="n">]</span><span class="p">,</span> <span class="o">$</span><span class="n">sort</span><span class="o">:</span> <span class="m">-1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作的结果是更新scores字段以按降序对其元素排序：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;tests&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">100</span><span class="p">,</span>  <span class="mi">89</span><span class="p">,</span>  <span class="mi">70</span><span class="p">,</span>  <span class="mi">20</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="sort与push一起使用"><code>$sort</code>与<code>$push</code>一起使用<a hidden class="anchor" aria-hidden="true" href="#sort与push一起使用">#</a></h3>
<p>集合students具有以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
   <span class="nt">&#34;quizzes&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">5</span> <span class="p">},</span>
      <span class="p">{</span> <span class="nt">&#34;wk&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">6</span> <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以下$push操作使用：</p>
<ul>
<li><code>$each</code>修饰符可将多个文档添加到quizzes数组中，</li>
<li><code>$sort</code>修饰符可按score字段的降序对修改后的quizzes数组的所有元素进行排序.</li>
<li><code>$slice</code>修饰符仅保留quizzes数组的前三个排序元素。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="nf">db.students.update</span><span class="p">(</span>
   <span class="p">{</span> <span class="n">_id</span><span class="o">:</span> <span class="m">5</span> <span class="p">},</span>
   <span class="p">{</span>
     <span class="o">$</span><span class="n">push</span><span class="o">:</span> <span class="p">{</span>
       <span class="n">quizzes</span><span class="o">:</span> <span class="p">{</span>
          <span class="o">$</span><span class="n">each</span><span class="o">:</span> <span class="n">[</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">5</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">8</span> <span class="p">},</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">6</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">7</span> <span class="p">},</span> <span class="p">{</span> <span class="n">wk</span><span class="o">:</span> <span class="m">7</span><span class="p">,</span> <span class="n">score</span><span class="o">:</span> <span class="m">6</span> <span class="p">}</span> <span class="n">]</span><span class="p">,</span>
          <span class="o">$</span><span class="n">sort</span><span class="o">:</span> <span class="p">{</span> <span class="n">score</span><span class="o">:</span> <span class="m">-1</span> <span class="p">},</span>
          <span class="o">$</span><span class="n">slice</span><span class="o">:</span> <span class="m">3</span>
       <span class="p">}</span>
     <span class="p">}</span>
   <span class="p">}</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作的结果是仅保留三个最高得分测验：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nt">&#34;quizzes&#34;</span> <span class="p">:</span> <span class="p">[</span>
     <span class="p">{</span> <span class="nt">&#34;wk&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">},</span>
     <span class="p">{</span> <span class="nt">&#34;wk&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">},</span>
     <span class="p">{</span> <span class="nt">&#34;wk&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&#34;score&#34;</span> <span class="p">:</span> <span class="mi">8</span> <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>修饰符的顺序与修饰符的处理顺序无关。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/mongodb/">MongoDB</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
