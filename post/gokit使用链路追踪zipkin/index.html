<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>GoKit使用:链路追踪Zipkin | Forz Blog</title>
<meta name="keywords" content="Gokit" />
<meta name="description" content="服务端trace 增加trace代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 //创建zipkin上报管理器 reporter := http.NewReporter(&#34;http://localhost:9411/api/v2/spans&#34;) //运行结束，关闭上报管理器的f">
<meta name="author" content="">
<link rel="canonical" href="/post/gokit%E4%BD%BF%E7%94%A8%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AAzipkin/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="GoKit使用:链路追踪Zipkin" />
<meta property="og:description" content="服务端trace 增加trace代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 //创建zipkin上报管理器 reporter := http.NewReporter(&#34;http://localhost:9411/api/v2/spans&#34;) //运行结束，关闭上报管理器的f" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/gokit%E4%BD%BF%E7%94%A8%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AAzipkin/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-10-30T14:57:53&#43;00:00" />
<meta property="article:modified_time" content="2019-10-30T14:57:53&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GoKit使用:链路追踪Zipkin"/>
<meta name="twitter:description" content="服务端trace 增加trace代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 //创建zipkin上报管理器 reporter := http.NewReporter(&#34;http://localhost:9411/api/v2/spans&#34;) //运行结束，关闭上报管理器的f"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "GoKit使用:链路追踪Zipkin",
      "item": "/post/gokit%E4%BD%BF%E7%94%A8%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AAzipkin/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "GoKit使用:链路追踪Zipkin",
  "name": "GoKit使用:链路追踪Zipkin",
  "description": "服务端trace 增加trace代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 //创建zipkin上报管理器 reporter := http.NewReporter(\u0026#34;http://localhost:9411/api/v2/spans\u0026#34;) //运行结束，关闭上报管理器的f",
  "keywords": [
    "Gokit"
  ],
  "articleBody": "服务端trace 增加trace代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  //创建zipkin上报管理器 reporter := http.NewReporter(\"http://localhost:9411/api/v2/spans\") //运行结束，关闭上报管理器的for-select协程 defer reporter.Close() //创建trace跟踪器 zkTracer, err := opzipkin.NewTracer(reporter) //添加grpc请求的before after finalizer 事件对应要处理的trace操作方法 zkServerTrace := zipkin.GRPCServerTrace(zkTracer) //通过options的方式运行trace bookListHandler := grpctransport.NewServer( bookListEndPoint, decodeRequest, encodeResponse, zkServerTrace, )   完整代码 我们还在之前的代码中加入trace的代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154  package main import ( \"grpc-test/pb\" \"context\" grpctransport \"github.com/go-kit/kit/transport/grpc\" \"github.com/go-kit/kit/endpoint\" \"google.golang.org/grpc\" \"net\" \"github.com/go-kit/kit/sd/etcdv3\" \"github.com/go-kit/kit/log\" \"time\" \"golang.org/x/time/rate\" \"github.com/go-kit/kit/ratelimit\" opzipkin \"github.com/openzipkin/zipkin-go\" \"github.com/openzipkin/zipkin-go/reporter/http\" \"github.com/go-kit/kit/tracing/zipkin\" \"math/rand\" ) type BookServer struct { bookListHandler grpctransport.Handler bookInfoHandler grpctransport.Handler } //通过grpc调用GetBookInfo时,GetBookInfo只做数据透传, 调用BookServer中对应Handler.ServeGRPC转交给go-kit处理 func (s *BookServer) GetBookInfo(ctx context.Context, in *book.BookInfoParams) (*book.BookInfo, error) { _, rsp, err := s.bookInfoHandler.ServeGRPC(ctx, in) if err != nil { return nil, err } return rsp.(*book.BookInfo),err } //通过grpc调用GetBookList时,GetBookList只做数据透传, 调用BookServer中对应Handler.ServeGRPC转交给go-kit处理 func (s *BookServer) GetBookList(ctx context.Context, in *book.BookListParams) (*book.BookList, error) { _, rsp, err := s.bookListHandler.ServeGRPC(ctx, in) if err != nil { return nil, err } return rsp.(*book.BookList),err } //创建bookList的EndPoint func makeGetBookListEndpoint() endpoint.Endpoint { return func(ctx context.Context, request interface{}) (interface{}, error) { rand.Seed(time.Now().Unix()) randInt := rand.Int63n(200) time.Sleep( time.Duration(randInt) * time.Millisecond) //请求列表时返回 书籍列表  bl := new(book.BookList) bl.BookList = append(bl.BookList, \u0026book.BookInfo{BookId:1,BookName:\"21天精通php\"}) bl.BookList = append(bl.BookList, \u0026book.BookInfo{BookId:2,BookName:\"21天精通java\"}) return bl,nil } } //创建bookInfo的EndPoint func makeGetBookInfoEndpoint() endpoint.Endpoint { return func(ctx context.Context, request interface{}) (interface{}, error) { rand.Seed(time.Now().Unix()) randInt := rand.Int63n(200) time.Sleep( time.Duration(randInt) * time.Microsecond) //请求详情时返回 书籍信息  req := request.(*book.BookInfoParams) b := new(book.BookInfo) b.BookId = req.BookId b.BookName = \"21天精通php\" return b,nil } } func decodeRequest(_ context.Context, req interface{}) (interface{}, error) { return req, nil } func encodeResponse(_ context.Context, rsp interface{}) (interface{}, error) { return rsp, nil } func main() { var ( //etcd服务地址  etcdServer = \"127.0.0.1:2379\" //服务的信息目录  prefix = \"/services/book/\" //当前启动服务实例的地址  instance = \"127.0.0.1:50051\" //服务实例注册的路径  key = prefix + instance //服务实例注册的val  value = instance ctx = context.Background() //服务监听地址  serviceAddress = \":50051\" ) //etcd的连接参数  options := etcdv3.ClientOptions{ DialTimeout: time.Second * 3, DialKeepAlive: time.Second * 3, } //创建etcd连接  client, err := etcdv3.NewClient(ctx, []string{etcdServer}, options) if err != nil { panic(err) } // 创建注册器  registrar := etcdv3.NewRegistrar(client, etcdv3.Service{ Key: key, Value: value, }, log.NewNopLogger()) // 注册器启动注册  registrar.Register() reporter := http.NewReporter(\"http://localhost:9411/api/v2/spans\") defer reporter.Close() zkTracer, err := opzipkin.NewTracer(reporter) zkServerTrace := zipkin.GRPCServerTrace(zkTracer) bookServer := new(BookServer) bookListEndPoint := makeGetBookListEndpoint() //创建限流器 1r/s limiter := rate.NewLimiter(rate.Every(time.Second * 1), 100000)  //通过DelayingLimiter中间件，在bookListEndPoint的外层再包裹一层限流的endPoint  bookListEndPoint = ratelimit.NewDelayingLimiter(limiter)(bookListEndPoint) bookListHandler := grpctransport.NewServer( bookListEndPoint, decodeRequest, encodeResponse, zkServerTrace, ) bookServer.bookListHandler = bookListHandler bookInfoEndPoint := makeGetBookInfoEndpoint() //通过DelayingLimiter中间件，在bookListEndPoint的外层再包裹一层限流的endPoint  bookInfoEndPoint = ratelimit.NewDelayingLimiter(limiter)(bookInfoEndPoint) bookInfoHandler := grpctransport.NewServer( bookInfoEndPoint, decodeRequest, encodeResponse, zkServerTrace, ) bookServer.bookInfoHandler = bookInfoHandler ls, _ := net.Listen(\"tcp\", serviceAddress) gs := grpc.NewServer(grpc.UnaryInterceptor(grpctransport.Interceptor)) book.RegisterBookServiceServer(gs, bookServer) gs.Serve(ls) }   客户端trace 增加trace代码 与服务端trace的区别在于kitzipkin.GRPCClientTrace\n1 2 3 4 5  reporter := http.NewReporter(\"http://localhost:9411/api/v2/spans\") defer reporter.Close() zkTracer, err := opzipkin.NewTracer(reporter) zkClientTrace := zipkin.GRPCClientTrace(zkTracer)   可以通过span组装span结构树\n1 2 3  parentSpan := zkTracer.StartSpan(\"bookCaller\") defer parentSpan.Flush() ctx = opzipkin.NewContext(context.Background(), parentSpan)   完整代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142  package main import ( \"context\" \"github.com/go-kit/kit/sd/etcdv3\" \"time\" \"github.com/go-kit/kit/sd\" \"github.com/go-kit/kit/log\" \"github.com/go-kit/kit/endpoint\" \"io\" \"github.com/go-kit/kit/sd/lb\" \"fmt\" \"google.golang.org/grpc\" \"github.com/afex/hystrix-go/hystrix\" \"github.com/go-kit/kit/circuitbreaker\" opzipkin \"github.com/openzipkin/zipkin-go\" \"github.com/go-kit/kit/tracing/zipkin\" grpctransport \"github.com/go-kit/kit/transport/grpc\" \"grpc-test/pb\" \"github.com/openzipkin/zipkin-go/reporter/http\" ) func main() { commandName := \"my-endpoint\" hystrix.ConfigureCommand(commandName, hystrix.CommandConfig{ Timeout: 1000 * 30, ErrorPercentThreshold: 1, SleepWindow: 10000, MaxConcurrentRequests: 1000, RequestVolumeThreshold: 5, }) breakerMw := circuitbreaker.Hystrix(commandName) var ( //注册中心地址  etcdServer = \"127.0.0.1:2379\" //监听的服务前缀  prefix = \"/services/book/\" ctx = context.Background() ) options := etcdv3.ClientOptions{ DialTimeout: time.Second * 3, DialKeepAlive: time.Second * 3, } //连接注册中心  client, err := etcdv3.NewClient(ctx, []string{etcdServer}, options) if err != nil { panic(err) } logger := log.NewNopLogger() //创建实例管理器, 此管理器会Watch监听etc中prefix的目录变化更新缓存的服务实例数据  instancer, err := etcdv3.NewInstancer(client, prefix, logger) if err != nil { panic(err) } //创建端点管理器， 此管理器根据Factory和监听的到实例创建endPoint并订阅instancer的变化动态更新Factory创建的endPoint  endpointer := sd.NewEndpointer(instancer, reqFactory, logger) //创建负载均衡器  balancer := lb.NewRoundRobin(endpointer) /** 我们可以通过负载均衡器直接获取请求的endPoint，发起请求 reqEndPoint,_ := balancer.Endpoint() */ /** 也可以通过retry定义尝试次数进行请求 */ reqEndPoint := lb.Retry(3, 100*time.Second, balancer) //增加熔断中间件  reqEndPoint = breakerMw(reqEndPoint) //现在我们可以通过 endPoint 发起请求了  req := struct{}{} for i := 1; i  1; i++ { if _, err = reqEndPoint(ctx, req); err != nil { fmt.Println(err) } } } //通过传入的 实例地址 创建对应的请求endPoint func reqFactory(instanceAddr string) (endpoint.Endpoint, io.Closer, error) { return func(ctx context.Context, request interface{}) (interface{}, error) { fmt.Println(\"请求服务: \", instanceAddr, \"当前时间: \", time.Now().Format(\"2006-01-02 15:04:05.99\")) conn, err := grpc.Dial(instanceAddr, grpc.WithInsecure()) if err != nil { fmt.Println(err) panic(\"connect error\") } reporter := http.NewReporter(\"http://localhost:9411/api/v2/spans\") defer reporter.Close() zkTracer, err := opzipkin.NewTracer(reporter) zkClientTrace := zipkin.GRPCClientTrace(zkTracer) bookInfoRequest := grpctransport.NewClient( conn, \"BookService\", \"GetBookInfo\", func(_ context.Context, in interface{}) (interface{}, error) { return nil, nil }, func(_ context.Context, out interface{}) (interface{}, error) { return out, nil }, book.BookInfo{}, zkClientTrace, ).Endpoint() bookListRequest := grpctransport.NewClient( conn, \"BookService\", \"GetBookList\", func(_ context.Context, in interface{}) (interface{}, error) { return nil, nil }, func(_ context.Context, out interface{}) (interface{}, error) { return out, nil }, book.BookList{}, zkClientTrace, ).Endpoint() parentSpan := zkTracer.StartSpan(\"bookCaller\") defer parentSpan.Flush() ctx = opzipkin.NewContext(ctx, parentSpan) infoRet ,_:= bookInfoRequest(ctx, request) bi := infoRet.(*book.BookInfo) fmt.Println(\"获取书籍详情\") fmt.Println(\"bookId: 1\", \" = \", \"bookName:\", bi.BookName) listRet,_ := bookListRequest(ctx, request) bl := listRet.(*book.BookList) fmt.Println(\"获取书籍列表\") for _,b := range bl.BookList { fmt.Println(\"bookId:\", b.BookId, \" = \", \"bookName:\", b.BookName) } return nil,nil },nil,nil }   ",
  "wordCount" : "2154",
  "inLanguage": "zh-cn",
  "datePublished": "2019-10-30T14:57:53Z",
  "dateModified": "2019-10-30T14:57:53Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/gokit%E4%BD%BF%E7%94%A8%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AAzipkin/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      GoKit使用:链路追踪Zipkin
    </h1>
    <div class="post-meta">October 30, 2019
</div>
  </header> 
  <div class="post-content"><h1 id="服务端trace">服务端trace<a hidden class="anchor" aria-hidden="true" href="#服务端trace">#</a></h1>
<h2 id="增加trace代码">增加trace代码<a hidden class="anchor" aria-hidden="true" href="#增加trace代码">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//创建zipkin上报管理器
</span><span class="c1"></span><span class="nx">reporter</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewReporter</span><span class="p">(</span><span class="s">&#34;http://localhost:9411/api/v2/spans&#34;</span><span class="p">)</span>
  
<span class="c1">//运行结束，关闭上报管理器的for-select协程
</span><span class="c1"></span><span class="k">defer</span> <span class="nx">reporter</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>  

<span class="c1">//创建trace跟踪器
</span><span class="c1"></span><span class="nx">zkTracer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">opzipkin</span><span class="p">.</span><span class="nf">NewTracer</span><span class="p">(</span><span class="nx">reporter</span><span class="p">)</span>  

<span class="c1">//添加grpc请求的before after finalizer 事件对应要处理的trace操作方法
</span><span class="c1"></span><span class="nx">zkServerTrace</span> <span class="o">:=</span> <span class="nx">zipkin</span><span class="p">.</span><span class="nf">GRPCServerTrace</span><span class="p">(</span><span class="nx">zkTracer</span><span class="p">)</span>  

<span class="c1">//通过options的方式运行trace
</span><span class="c1"></span><span class="nx">bookListHandler</span> <span class="o">:=</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>  
   <span class="nx">bookListEndPoint</span><span class="p">,</span>  
   <span class="nx">decodeRequest</span><span class="p">,</span>  
   <span class="nx">encodeResponse</span><span class="p">,</span>  
   <span class="nx">zkServerTrace</span><span class="p">,</span>  
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="完整代码">完整代码<a hidden class="anchor" aria-hidden="true" href="#完整代码">#</a></h2>
<p>我们还在之前的代码中加入trace的代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>  
  
<span class="kn">import</span> <span class="p">(</span>  
   <span class="s">&#34;grpc-test/pb&#34;</span>  
   <span class="s">&#34;context&#34;</span>  
   <span class="nx">grpctransport</span> 
   <span class="s">&#34;github.com/go-kit/kit/transport/grpc&#34;</span>  
   <span class="s">&#34;github.com/go-kit/kit/endpoint&#34;</span> 
   <span class="s">&#34;google.golang.org/grpc&#34;</span> 
   <span class="s">&#34;net&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/sd/etcdv3&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/log&#34;</span> 
   <span class="s">&#34;time&#34;</span> 
   <span class="s">&#34;golang.org/x/time/rate&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/ratelimit&#34;</span>  
   <span class="nx">opzipkin</span> <span class="s">&#34;github.com/openzipkin/zipkin-go&#34;</span>  
   <span class="s">&#34;github.com/openzipkin/zipkin-go/reporter/http&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/tracing/zipkin&#34;</span> 
   <span class="s">&#34;math/rand&#34;</span>
<span class="p">)</span>  
  
<span class="kd">type</span> <span class="nx">BookServer</span> <span class="kd">struct</span> <span class="p">{</span>  
   <span class="nx">bookListHandler</span>  <span class="nx">grpctransport</span><span class="p">.</span><span class="nx">Handler</span>  
   <span class="nx">bookInfoHandler</span>  <span class="nx">grpctransport</span><span class="p">.</span><span class="nx">Handler</span>  
<span class="p">}</span>  
  
<span class="c1">//通过grpc调用GetBookInfo时,GetBookInfo只做数据透传, 调用BookServer中对应Handler.ServeGRPC转交给go-kit处理  
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">BookServer</span><span class="p">)</span> <span class="nf">GetBookInfo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookInfoParams</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
   <span class="nx">_</span><span class="p">,</span> <span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">bookInfoHandler</span><span class="p">.</span><span class="nf">ServeGRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>  
   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>  
   <span class="p">}</span>  
   <span class="k">return</span> <span class="nx">rsp</span><span class="p">.(</span><span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookInfo</span><span class="p">),</span><span class="nx">err</span>  
<span class="p">}</span>  
  
<span class="c1">//通过grpc调用GetBookList时,GetBookList只做数据透传, 调用BookServer中对应Handler.ServeGRPC转交给go-kit处理  
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">BookServer</span><span class="p">)</span> <span class="nf">GetBookList</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookListParams</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookList</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
   <span class="nx">_</span><span class="p">,</span> <span class="nx">rsp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">bookListHandler</span><span class="p">.</span><span class="nf">ServeGRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>  
   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>  
   <span class="p">}</span>  
   <span class="k">return</span> <span class="nx">rsp</span><span class="p">.(</span><span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookList</span><span class="p">),</span><span class="nx">err</span>  
<span class="p">}</span>  
  
<span class="c1">//创建bookList的EndPoint  
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">makeGetBookListEndpoint</span><span class="p">()</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span> <span class="p">{</span>  
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
      <span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">())</span>  
      <span class="nx">randInt</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Int63n</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>  
      <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">randInt</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>  
      <span class="c1">//请求列表时返回 书籍列表  
</span><span class="c1"></span>      <span class="nx">bl</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookList</span><span class="p">)</span>  
      <span class="nx">bl</span><span class="p">.</span><span class="nx">BookList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">bl</span><span class="p">.</span><span class="nx">BookList</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookInfo</span><span class="p">{</span><span class="nx">BookId</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">BookName</span><span class="p">:</span><span class="s">&#34;21天精通php&#34;</span><span class="p">})</span>  
      <span class="nx">bl</span><span class="p">.</span><span class="nx">BookList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">bl</span><span class="p">.</span><span class="nx">BookList</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookInfo</span><span class="p">{</span><span class="nx">BookId</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nx">BookName</span><span class="p">:</span><span class="s">&#34;21天精通java&#34;</span><span class="p">})</span>  
      <span class="k">return</span> <span class="nx">bl</span><span class="p">,</span><span class="kc">nil</span>  
   <span class="p">}</span>  
<span class="p">}</span>  
  
<span class="c1">//创建bookInfo的EndPoint  
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">makeGetBookInfoEndpoint</span><span class="p">()</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span> <span class="p">{</span>  
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
      <span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">())</span>  
      <span class="nx">randInt</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Int63n</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>  
      <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">randInt</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Microsecond</span><span class="p">)</span>  
      <span class="c1">//请求详情时返回 书籍信息  
</span><span class="c1"></span>      <span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookInfoParams</span><span class="p">)</span>  
      <span class="nx">b</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookInfo</span><span class="p">)</span>  
      <span class="nx">b</span><span class="p">.</span><span class="nx">BookId</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">BookId</span>  
      <span class="nx">b</span><span class="p">.</span><span class="nx">BookName</span> <span class="p">=</span> <span class="s">&#34;21天精通php&#34;</span>  
      <span class="k">return</span> <span class="nx">b</span><span class="p">,</span><span class="kc">nil</span>  
   <span class="p">}</span>  
<span class="p">}</span>  
  
<span class="kd">func</span> <span class="nf">decodeRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
   <span class="k">return</span> <span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span>  
<span class="p">}</span>  
  
<span class="kd">func</span> <span class="nf">encodeResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">rsp</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
   <span class="k">return</span> <span class="nx">rsp</span><span class="p">,</span> <span class="kc">nil</span>  
<span class="p">}</span>  
  
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>  
  
   <span class="kd">var</span> <span class="p">(</span>  
      <span class="c1">//etcd服务地址  
</span><span class="c1"></span>      <span class="nx">etcdServer</span> <span class="p">=</span> <span class="s">&#34;127.0.0.1:2379&#34;</span>  
      <span class="c1">//服务的信息目录  
</span><span class="c1"></span>      <span class="nx">prefix</span>     <span class="p">=</span> <span class="s">&#34;/services/book/&#34;</span>  
      <span class="c1">//当前启动服务实例的地址  
</span><span class="c1"></span>      <span class="nx">instance</span>   <span class="p">=</span> <span class="s">&#34;127.0.0.1:50051&#34;</span>  
      <span class="c1">//服务实例注册的路径  
</span><span class="c1"></span>      <span class="nx">key</span>        <span class="p">=</span> <span class="nx">prefix</span> <span class="o">+</span> <span class="nx">instance</span>  
      <span class="c1">//服务实例注册的val  
</span><span class="c1"></span>      <span class="nx">value</span>      <span class="p">=</span> <span class="nx">instance</span>  
      <span class="nx">ctx</span>        <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>  
      <span class="c1">//服务监听地址  
</span><span class="c1"></span>      <span class="nx">serviceAddress</span> <span class="p">=</span> <span class="s">&#34;:50051&#34;</span>  
   <span class="p">)</span>  
  
   <span class="c1">//etcd的连接参数  
</span><span class="c1"></span>   <span class="nx">options</span> <span class="o">:=</span> <span class="nx">etcdv3</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">{</span>  
      <span class="nx">DialTimeout</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>  
      <span class="nx">DialKeepAlive</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>  
   <span class="p">}</span>  
   <span class="c1">//创建etcd连接  
</span><span class="c1"></span>   <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">etcdv3</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">etcdServer</span><span class="p">},</span> <span class="nx">options</span><span class="p">)</span>  
   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  
      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  
   <span class="p">}</span>  
  
   <span class="c1">// 创建注册器  
</span><span class="c1"></span>   <span class="nx">registrar</span> <span class="o">:=</span> <span class="nx">etcdv3</span><span class="p">.</span><span class="nf">NewRegistrar</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">etcdv3</span><span class="p">.</span><span class="nx">Service</span><span class="p">{</span>  
      <span class="nx">Key</span><span class="p">:</span>   <span class="nx">key</span><span class="p">,</span>  
      <span class="nx">Value</span><span class="p">:</span> <span class="nx">value</span><span class="p">,</span>  
   <span class="p">},</span> <span class="nx">log</span><span class="p">.</span><span class="nf">NewNopLogger</span><span class="p">())</span>  
  
   <span class="c1">// 注册器启动注册  
</span><span class="c1"></span>   <span class="nx">registrar</span><span class="p">.</span><span class="nf">Register</span><span class="p">()</span>  
  
   <span class="nx">reporter</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewReporter</span><span class="p">(</span><span class="s">&#34;http://localhost:9411/api/v2/spans&#34;</span><span class="p">)</span>  
   <span class="k">defer</span> <span class="nx">reporter</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>  
   <span class="nx">zkTracer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">opzipkin</span><span class="p">.</span><span class="nf">NewTracer</span><span class="p">(</span><span class="nx">reporter</span><span class="p">)</span>  
   <span class="nx">zkServerTrace</span> <span class="o">:=</span> <span class="nx">zipkin</span><span class="p">.</span><span class="nf">GRPCServerTrace</span><span class="p">(</span><span class="nx">zkTracer</span><span class="p">)</span>  
   <span class="nx">bookServer</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">BookServer</span><span class="p">)</span>  
   <span class="nx">bookListEndPoint</span> <span class="o">:=</span> <span class="nf">makeGetBookListEndpoint</span><span class="p">()</span>  
   <span class="c1">//创建限流器 1r/s  limiter := rate.NewLimiter(rate.Every(time.Second * 1), 100000)  
</span><span class="c1"></span>   <span class="c1">//通过DelayingLimiter中间件，在bookListEndPoint的外层再包裹一层限流的endPoint  
</span><span class="c1"></span>   <span class="nx">bookListEndPoint</span> <span class="p">=</span> <span class="nx">ratelimit</span><span class="p">.</span><span class="nf">NewDelayingLimiter</span><span class="p">(</span><span class="nx">limiter</span><span class="p">)(</span><span class="nx">bookListEndPoint</span><span class="p">)</span>  
  
   <span class="nx">bookListHandler</span> <span class="o">:=</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>  
      <span class="nx">bookListEndPoint</span><span class="p">,</span>  
      <span class="nx">decodeRequest</span><span class="p">,</span>  
      <span class="nx">encodeResponse</span><span class="p">,</span>  
      <span class="nx">zkServerTrace</span><span class="p">,</span>  
   <span class="p">)</span>  
   <span class="nx">bookServer</span><span class="p">.</span><span class="nx">bookListHandler</span> <span class="p">=</span> <span class="nx">bookListHandler</span>  
  
  
   <span class="nx">bookInfoEndPoint</span> <span class="o">:=</span> <span class="nf">makeGetBookInfoEndpoint</span><span class="p">()</span>  
   <span class="c1">//通过DelayingLimiter中间件，在bookListEndPoint的外层再包裹一层限流的endPoint  
</span><span class="c1"></span>   <span class="nx">bookInfoEndPoint</span> <span class="p">=</span> <span class="nx">ratelimit</span><span class="p">.</span><span class="nf">NewDelayingLimiter</span><span class="p">(</span><span class="nx">limiter</span><span class="p">)(</span><span class="nx">bookInfoEndPoint</span><span class="p">)</span>  
   <span class="nx">bookInfoHandler</span> <span class="o">:=</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>  
      <span class="nx">bookInfoEndPoint</span><span class="p">,</span>  
      <span class="nx">decodeRequest</span><span class="p">,</span>  
      <span class="nx">encodeResponse</span><span class="p">,</span>  
      <span class="nx">zkServerTrace</span><span class="p">,</span>  
   <span class="p">)</span>  
   <span class="nx">bookServer</span><span class="p">.</span><span class="nx">bookInfoHandler</span> <span class="p">=</span> <span class="nx">bookInfoHandler</span>  
  
   <span class="nx">ls</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">serviceAddress</span><span class="p">)</span>  
   <span class="nx">gs</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">grpc</span><span class="p">.</span><span class="nf">UnaryInterceptor</span><span class="p">(</span><span class="nx">grpctransport</span><span class="p">.</span><span class="nx">Interceptor</span><span class="p">))</span>  
   <span class="nx">book</span><span class="p">.</span><span class="nf">RegisterBookServiceServer</span><span class="p">(</span><span class="nx">gs</span><span class="p">,</span> <span class="nx">bookServer</span><span class="p">)</span>  
   <span class="nx">gs</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">ls</span><span class="p">)</span>  
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="客户端trace">客户端trace<a hidden class="anchor" aria-hidden="true" href="#客户端trace">#</a></h1>
<h2 id="增加trace代码-1">增加trace代码<a hidden class="anchor" aria-hidden="true" href="#增加trace代码-1">#</a></h2>
<p>与服务端trace的区别在于kitzipkin.GRPCClientTrace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">reporter</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewReporter</span><span class="p">(</span><span class="s">&#34;http://localhost:9411/api/v2/spans&#34;</span><span class="p">)</span>  
<span class="k">defer</span> <span class="nx">reporter</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>  
  
<span class="nx">zkTracer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">opzipkin</span><span class="p">.</span><span class="nf">NewTracer</span><span class="p">(</span><span class="nx">reporter</span><span class="p">)</span>  
<span class="nx">zkClientTrace</span> <span class="o">:=</span> <span class="nx">zipkin</span><span class="p">.</span><span class="nf">GRPCClientTrace</span><span class="p">(</span><span class="nx">zkTracer</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>可以通过span组装span结构树</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">parentSpan</span> <span class="o">:=</span> <span class="nx">zkTracer</span><span class="p">.</span><span class="nf">StartSpan</span><span class="p">(</span><span class="s">&#34;bookCaller&#34;</span><span class="p">)</span>  
<span class="k">defer</span> <span class="nx">parentSpan</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>  
<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">opzipkin</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">parentSpan</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="完整代码-1">完整代码<a hidden class="anchor" aria-hidden="true" href="#完整代码-1">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>  
  
<span class="kn">import</span> <span class="p">(</span>  
   <span class="s">&#34;context&#34;</span>  
   <span class="s">&#34;github.com/go-kit/kit/sd/etcdv3&#34;</span> 
   <span class="s">&#34;time&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/sd&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/log&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/endpoint&#34;</span> 
   <span class="s">&#34;io&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/sd/lb&#34;</span> 
   <span class="s">&#34;fmt&#34;</span> 
   <span class="s">&#34;google.golang.org/grpc&#34;</span> 
   <span class="s">&#34;github.com/afex/hystrix-go/hystrix&#34;</span> 
   <span class="s">&#34;github.com/go-kit/kit/circuitbreaker&#34;</span>  
   <span class="nx">opzipkin</span> <span class="s">&#34;github.com/openzipkin/zipkin-go&#34;</span>  
   <span class="s">&#34;github.com/go-kit/kit/tracing/zipkin&#34;</span>  
   <span class="nx">grpctransport</span> <span class="s">&#34;github.com/go-kit/kit/transport/grpc&#34;</span>  
   <span class="s">&#34;grpc-test/pb&#34;</span> 
   <span class="s">&#34;github.com/openzipkin/zipkin-go/reporter/http&#34;</span>
<span class="p">)</span>  
  
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>  
   <span class="nx">commandName</span> <span class="o">:=</span> <span class="s">&#34;my-endpoint&#34;</span>  
   <span class="nx">hystrix</span><span class="p">.</span><span class="nf">ConfigureCommand</span><span class="p">(</span><span class="nx">commandName</span><span class="p">,</span> <span class="nx">hystrix</span><span class="p">.</span><span class="nx">CommandConfig</span><span class="p">{</span>  
      <span class="nx">Timeout</span><span class="p">:</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span>  
      <span class="nx">ErrorPercentThreshold</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  
      <span class="nx">SleepWindow</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>  
      <span class="nx">MaxConcurrentRequests</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  
      <span class="nx">RequestVolumeThreshold</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  
   <span class="p">})</span>  
   <span class="nx">breakerMw</span> <span class="o">:=</span> <span class="nx">circuitbreaker</span><span class="p">.</span><span class="nf">Hystrix</span><span class="p">(</span><span class="nx">commandName</span><span class="p">)</span>  
  
  
   <span class="kd">var</span> <span class="p">(</span>  
      <span class="c1">//注册中心地址  
</span><span class="c1"></span>      <span class="nx">etcdServer</span> <span class="p">=</span> <span class="s">&#34;127.0.0.1:2379&#34;</span>  
      <span class="c1">//监听的服务前缀  
</span><span class="c1"></span>      <span class="nx">prefix</span>     <span class="p">=</span> <span class="s">&#34;/services/book/&#34;</span>  
      <span class="nx">ctx</span>        <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>  
   <span class="p">)</span>  
   <span class="nx">options</span> <span class="o">:=</span> <span class="nx">etcdv3</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">{</span>  
      <span class="nx">DialTimeout</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>  
      <span class="nx">DialKeepAlive</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>  
   <span class="p">}</span>  
   <span class="c1">//连接注册中心  
</span><span class="c1"></span>   <span class="nx">client</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">etcdv3</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="nx">etcdServer</span><span class="p">},</span> <span class="nx">options</span><span class="p">)</span>  
   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  
      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  
   <span class="p">}</span>  
   <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">log</span><span class="p">.</span><span class="nf">NewNopLogger</span><span class="p">()</span>  
   <span class="c1">//创建实例管理器, 此管理器会Watch监听etc中prefix的目录变化更新缓存的服务实例数据  
</span><span class="c1"></span>   <span class="nx">instancer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">etcdv3</span><span class="p">.</span><span class="nf">NewInstancer</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">logger</span><span class="p">)</span>  
   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  
      <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  
   <span class="p">}</span>  
   <span class="c1">//创建端点管理器， 此管理器根据Factory和监听的到实例创建endPoint并订阅instancer的变化动态更新Factory创建的endPoint  
</span><span class="c1"></span>   <span class="nx">endpointer</span> <span class="o">:=</span> <span class="nx">sd</span><span class="p">.</span><span class="nf">NewEndpointer</span><span class="p">(</span><span class="nx">instancer</span><span class="p">,</span> <span class="nx">reqFactory</span><span class="p">,</span> <span class="nx">logger</span><span class="p">)</span>  
   <span class="c1">//创建负载均衡器  
</span><span class="c1"></span>   <span class="nx">balancer</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nf">NewRoundRobin</span><span class="p">(</span><span class="nx">endpointer</span><span class="p">)</span>  
  
   <span class="cm">/**  
</span><span class="cm">   我们可以通过负载均衡器直接获取请求的endPoint，发起请求  
</span><span class="cm">   reqEndPoint,_ := balancer.Endpoint() 
</span><span class="cm">   */</span>  
   <span class="cm">/**  
</span><span class="cm">   也可以通过retry定义尝试次数进行请求  
</span><span class="cm">   */</span>  
   <span class="nx">reqEndPoint</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nf">Retry</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="nx">balancer</span><span class="p">)</span>  
  
   <span class="c1">//增加熔断中间件  
</span><span class="c1"></span>   <span class="nx">reqEndPoint</span> <span class="p">=</span> <span class="nf">breakerMw</span><span class="p">(</span><span class="nx">reqEndPoint</span><span class="p">)</span>  
   <span class="c1">//现在我们可以通过 endPoint 发起请求了  
</span><span class="c1"></span>  
   <span class="nx">req</span> <span class="o">:=</span> <span class="kd">struct</span><span class="p">{}{}</span>  
   <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>  
      <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">reqEndPoint</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  
         <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  
      <span class="p">}</span>  
   <span class="p">}</span>  
<span class="p">}</span>  
  
  
<span class="c1">//通过传入的 实例地址  创建对应的请求endPoint  
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">reqFactory</span><span class="p">(</span><span class="nx">instanceAddr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Closer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
   <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;请求服务: &#34;</span><span class="p">,</span> <span class="nx">instanceAddr</span><span class="p">,</span> <span class="s">&#34;当前时间: &#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Format</span><span class="p">(</span><span class="s">&#34;2006-01-02 15:04:05.99&#34;</span><span class="p">))</span>  
      <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">Dial</span><span class="p">(</span><span class="nx">instanceAddr</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithInsecure</span><span class="p">())</span>  
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>  
         <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>  
         <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;connect error&#34;</span><span class="p">)</span>  
      <span class="p">}</span>  
  
      <span class="nx">reporter</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewReporter</span><span class="p">(</span><span class="s">&#34;http://localhost:9411/api/v2/spans&#34;</span><span class="p">)</span>  
      <span class="k">defer</span> <span class="nx">reporter</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>  
  
      <span class="nx">zkTracer</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">opzipkin</span><span class="p">.</span><span class="nf">NewTracer</span><span class="p">(</span><span class="nx">reporter</span><span class="p">)</span>  
      <span class="nx">zkClientTrace</span> <span class="o">:=</span> <span class="nx">zipkin</span><span class="p">.</span><span class="nf">GRPCClientTrace</span><span class="p">(</span><span class="nx">zkTracer</span><span class="p">)</span>  
  
      <span class="nx">bookInfoRequest</span> <span class="o">:=</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span>  
         <span class="nx">conn</span><span class="p">,</span>  
         <span class="s">&#34;BookService&#34;</span><span class="p">,</span>  
         <span class="s">&#34;GetBookInfo&#34;</span><span class="p">,</span>  
         <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span> <span class="p">},</span>  
         <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">out</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
            <span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>  
         <span class="p">},</span>  
         <span class="nx">book</span><span class="p">.</span><span class="nx">BookInfo</span><span class="p">{},</span>  
         <span class="nx">zkClientTrace</span><span class="p">,</span>  
      <span class="p">).</span><span class="nf">Endpoint</span><span class="p">()</span>  
  
      <span class="nx">bookListRequest</span> <span class="o">:=</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span>  
         <span class="nx">conn</span><span class="p">,</span>  
         <span class="s">&#34;BookService&#34;</span><span class="p">,</span>  
         <span class="s">&#34;GetBookList&#34;</span><span class="p">,</span>  
         <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span> <span class="p">},</span>  
         <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">out</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>  
            <span class="k">return</span> <span class="nx">out</span><span class="p">,</span> <span class="kc">nil</span>  
         <span class="p">},</span>  
         <span class="nx">book</span><span class="p">.</span><span class="nx">BookList</span><span class="p">{},</span>  
         <span class="nx">zkClientTrace</span><span class="p">,</span>  
      <span class="p">).</span><span class="nf">Endpoint</span><span class="p">()</span>  
  
      <span class="nx">parentSpan</span> <span class="o">:=</span> <span class="nx">zkTracer</span><span class="p">.</span><span class="nf">StartSpan</span><span class="p">(</span><span class="s">&#34;bookCaller&#34;</span><span class="p">)</span>  
      <span class="k">defer</span> <span class="nx">parentSpan</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>  
  
      <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">opzipkin</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">parentSpan</span><span class="p">)</span>  
      <span class="nx">infoRet</span> <span class="p">,</span><span class="nx">_</span><span class="o">:=</span> <span class="nf">bookInfoRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>  
      <span class="nx">bi</span> <span class="o">:=</span> <span class="nx">infoRet</span><span class="p">.(</span><span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookInfo</span><span class="p">)</span>  
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;获取书籍详情&#34;</span><span class="p">)</span>  
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;bookId: 1&#34;</span><span class="p">,</span> <span class="s">&#34; =&gt; &#34;</span><span class="p">,</span> <span class="s">&#34;bookName:&#34;</span><span class="p">,</span> <span class="nx">bi</span><span class="p">.</span><span class="nx">BookName</span><span class="p">)</span>  
  
      <span class="nx">listRet</span><span class="p">,</span><span class="nx">_</span> <span class="o">:=</span> <span class="nf">bookListRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span>  
      <span class="nx">bl</span> <span class="o">:=</span> <span class="nx">listRet</span><span class="p">.(</span><span class="o">*</span><span class="nx">book</span><span class="p">.</span><span class="nx">BookList</span><span class="p">)</span>  
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;获取书籍列表&#34;</span><span class="p">)</span>  
      <span class="k">for</span> <span class="nx">_</span><span class="p">,</span><span class="nx">b</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">bl</span><span class="p">.</span><span class="nx">BookList</span> <span class="p">{</span>  
         <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;bookId:&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">BookId</span><span class="p">,</span> <span class="s">&#34; =&gt; &#34;</span><span class="p">,</span> <span class="s">&#34;bookName:&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">BookName</span><span class="p">)</span>  
      <span class="p">}</span>  
  
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span><span class="kc">nil</span>  
   <span class="p">},</span><span class="kc">nil</span><span class="p">,</span><span class="kc">nil</span>  
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/gokit/">Gokit</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
