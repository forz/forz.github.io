<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Gin的gzip中间件nanmu42-gzip | Forz Blog</title>
<meta name="keywords" content="gzip, Gin" />
<meta name="description" content="背景 最近在做一个 web 版的展示大屏，前端靠 HTTP(S)&#43;JSON 和后端交互，部分图形是密集的地理点位和时间序列，HTTP 返回数据量较大，公网上加载速度不佳。 调研 考虑">
<meta name="author" content="">
<link rel="canonical" href="/post/gin%E7%9A%84gzip%E4%B8%AD%E9%97%B4%E4%BB%B6nanmu42-gzip/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Gin的gzip中间件nanmu42-gzip" />
<meta property="og:description" content="背景 最近在做一个 web 版的展示大屏，前端靠 HTTP(S)&#43;JSON 和后端交互，部分图形是密集的地理点位和时间序列，HTTP 返回数据量较大，公网上加载速度不佳。 调研 考虑" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/gin%E7%9A%84gzip%E4%B8%AD%E9%97%B4%E4%BB%B6nanmu42-gzip/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-04-29T20:02:59&#43;00:00" />
<meta property="article:modified_time" content="2021-04-29T20:02:59&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Gin的gzip中间件nanmu42-gzip"/>
<meta name="twitter:description" content="背景 最近在做一个 web 版的展示大屏，前端靠 HTTP(S)&#43;JSON 和后端交互，部分图形是密集的地理点位和时间序列，HTTP 返回数据量较大，公网上加载速度不佳。 调研 考虑"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Gin的gzip中间件nanmu42-gzip",
      "item": "/post/gin%E7%9A%84gzip%E4%B8%AD%E9%97%B4%E4%BB%B6nanmu42-gzip/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Gin的gzip中间件nanmu42-gzip",
  "name": "Gin的gzip中间件nanmu42-gzip",
  "description": "背景 最近在做一个 web 版的展示大屏，前端靠 HTTP(S)+JSON 和后端交互，部分图形是密集的地理点位和时间序列，HTTP 返回数据量较大，公网上加载速度不佳。 调研 考虑",
  "keywords": [
    "gzip", "Gin"
  ],
  "articleBody": "背景 最近在做一个 web 版的展示大屏，前端靠 HTTP(S)+JSON 和后端交互，部分图形是密集的地理点位和时间序列，HTTP 返回数据量较大，公网上加载速度不佳。\n调研 考虑压缩 HTTP 返回，选了 gzip 这个常规选项。\ngzip 在压缩时，得考虑几点：\n 内容类型是否对压缩友好：例如 JPEG 本身已经压缩过，再次压缩收益太小，费力不讨好； 内容大小是否值得压缩：太小的内容压缩效果不好（甚至有可能比原文还大，毕竟有字典等开销），另外小内容本身传输时间短，直接放过去还能节约 CPU 和内存。  Nginx  Nginx 的压缩一般是用 ngx_http_gzip_module； 根据 Content-Type 判断内容类型是否对压缩友好，要压缩的类型由用户定义； 根据返回的 Content-Length 判断内容大小是否值得压缩；  当返回的 JSON 大于 2KB 时，Golang 会使用 chunk 的形式传输，这个时候没有 Content-Length，ngx_http_gzip_module 不会进行内容压缩。\ngin-contrib/gzip  根据扩展名判断内容类型是否对压缩友好； 根据 Path 判断是否启用压缩； 不支持判断内容大小是否值得压缩。  根据 Path 来判断确实可行，但太死板，业务和中间件耦合了。\nnanmu42/gzip  支持 Gin 和 标准库 net/http ； 支持基于 Content-Type、Content-Length、扩展名判断是否压缩； 启用压缩的阈值用户可以自定义； 压缩级别用户可以自定义； 不压缩已经压缩过的返回，不压缩 Head 请求的返回，不影响 HTTP Upgrade ； 中间件初始化简单，集成容易；  更进一步   还记得返回的 JSON 大于 2KB 时，Golang 会使用 chunk 的形式传输，这个时候没有 Content-Length 带来无法判断内容是否值得压缩的问题吗？\n  我取了个巧，如果 Content-Length 不存在，中间件会去观察 http.ResponseWriter.Write(data []byte) 的第一次调用时的 len(data)，如果此时 len(data) 已经大于启用压缩的阈值，那么可以安全地开始压缩。\n  效率  当返回体积不大时，Handler会智能地跳过压缩，这个过程带来的代价可以忽略不记； 当返回体积足够大时，Handler会进行gzip压缩，这个过程有着合理的代价。  1 2 3 4 5 6 7 8 9 10  $ go test -benchmem -bench . goos: linux goarch: amd64 pkg: github.com/nanmu42/gzip BenchmarkSoleGin_SmallPayload-4 4104684 276 ns/op 64 B/op 2 allocs/op BenchmarkGinWithDefaultHandler_SmallPayload-4 1683307 707 ns/op 96 B/op 3 allocs/op BenchmarkSoleGin_BigPayload-4 4198786 274 ns/op 64 B/op 2 allocs/op BenchmarkGinWithDefaultHandler_BigPayload-4 44780 27636 ns/op 190 B/op 5 allocs/op PASS ok github.com/nanmu42/gzip 6.373s   局限性   你应该总是在返回中提供Content-Type。虽然Handler会在Content-Type缺失时使用http.DetectContentType()进行猜测，但是效果并没有那么好；\n  返回的Content-Length 缺失时，Handler可能会缓冲返回的报文数据以决定报文是否大到值得进行压缩，如果MinContentLength设置得太大，这个过程可能会带来内存压力。Handler针对这个情况做了一些优化，例如查看http.ResponseWriter.Write(data []byte)在首次调用时的 len(data)，以及资源复用。\n  AC 自动机 原本我使用 Strings.Contains() 配合循环来判断文件后缀 /MIME 是否在支持压缩的列表中，但 benchmark 下来效果不太好。做了一些搜索后发现 Cloudflare 实现了一个 AC 自动机来做这个事情。和维护者聊了聊之后，我用了它的一个 fork： https://github.com/signalsciences/ac\nSync.Pool Sync.Pool 用来做对象重用，以降低系统内存分配和 Go 垃圾回收的压力，一开始我只对 gzip.Writer 做了对象重用，但发现中间件对内存的影响还有一些大，后来我用了第二个 Sync.Pool 重用 wrapper，内存使用量和 CPU 时间都有了可观的改善。\n两个调优之后，CPU 时间下降为调优前的 40%，内存使用量下降为原先的一半。\n使用示例 默认设置DefaultHandler()可以满足大部分场景。\nGin 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  package main import ( \"fmt\" \"log\" \"net/http\" \"strings\" \"github.com/gin-gonic/gin\" \"github.com/nanmu42/gzip\" ) func main() { g := gin.Default() g.Use(gzip.DefaultHandler().Gin) g.GET(\"/\", func(c *gin.Context) { c.JSON(http.StatusOK, map[string]interface{}{ \"code\": 0, \"msg\": \"hello\", \"data\": \"GET /short and GET /long to have a try!\", }) }) // short response will not be compressed \tg.GET(\"/short\", func(c *gin.Context) { c.JSON(http.StatusOK, map[string]interface{}{ \"code\": 0, \"msg\": \"This content is not long enough to be compressed.\", \"data\": \"short!\", }) }) // long response that will be compressed by gzip \tg.GET(\"/long\", func(c *gin.Context) { c.JSON(http.StatusOK, map[string]interface{}{ \"code\": 0, \"msg\": \"This content is compressed\", \"data\": fmt.Sprintf(\"l%sng!\", strings.Repeat(\"o\", 1000)), }) }) const port = 3000 log.Printf(\"Service is litsenning on port %d...\", port) log.Println(g.Run(fmt.Sprintf(\":%d\", port))) }   net/http 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  package main import ( \"fmt\" \"io\" \"log\" \"net/http\" \"strings\" \"github.com/nanmu42/gzip\" ) func main() { mux := http.NewServeMux() mux.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) { writeString(w, \"GET /short and /long to have a try!\") }) mux.HandleFunc(\"/short\", func(w http.ResponseWriter, r *http.Request) { writeString(w, \"This content is not long enough to be compressed.\") }) mux.HandleFunc(\"/long\", func(w http.ResponseWriter, r *http.Request) { writeString(w, fmt.Sprintf(\"This content is compressed: l%sng!\", strings.Repeat(\"o\", 1000))) }) const port = 3001 log.Printf(\"Service is litsenning on port %d...\", port) log.Println(http.ListenAndServe(fmt.Sprintf(\":%d\", port), gzip.DefaultHandler().WrapHandler(mux))) } func writeString(w http.ResponseWriter, payload string) { w.Header().Set(\"Content-Type\", \"text/plain; charset=utf8\") _, _ = io.WriteString(w, payload+\"\\n\") }   定制Handler 使用NewHandler()可以定制参数以满足你的特殊需要：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  import github.com/nanmu42/gzip handler := gzip.NewHandler(gzip.Config{ // gzip压缩等级 \tCompressionLevel: 6, // 触发gzip的最小body体积，单位：byte \tMinContentLength: 1024, // 请求过滤器基于请求来判断是否对这条请求的返回启用gzip，  // 过滤器按其定义顺序执行，下同。 \tRequestFilter: []RequestFilter{ NewCommonRequestFilter(), DefaultExtensionFilter(), }, // 返回header过滤器基于返回的header判断是否对这条请求的返回启用gzip \tResponseHeaderFilter: []ResponseHeaderFilter{ NewSkipCompressedFilter(), DefaultContentTypeFilter(), }, })   RequestFilter 和 ResponseHeaderFilter 是 interface. 你可以实现你自己的过滤器。\n源码 handler 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255  package gzip import ( \"bufio\" \"fmt\" \"io/ioutil\" \"net\" \"net/http\" \"sync\" \"github.com/gin-gonic/gin\" \"github.com/klauspost/compress/gzip\" ) // These constants are copied from the gzip package const ( NoCompression = gzip.NoCompression BestSpeed = gzip.BestSpeed BestCompression = gzip.BestCompression DefaultCompression = gzip.DefaultCompression HuffmanOnly = gzip.HuffmanOnly // Stateless will do compression but without maintaining any state \t// between Write calls, so long running responses will not take memory. \t// There will be no memory kept between Write calls, \t// but compression and speed will be suboptimal. \t// Because of this, the size of actual Write calls will affect output size. \tStateless = gzip.StatelessCompression ) // Config is used in Handler initialization type Config struct { // gzip compression level to use, \t// valid value: -3 = 9. \t// \t// see https://golang.org/pkg/compress/gzip/#NewWriterLevel \tCompressionLevel int // Minimum content length to trigger gzip, \t// the unit is in byte. \t// \t// When `Content-Length` is not available, handler may buffer your writes to \t// decide if its big enough to do a meaningful compression. \t// A high `MinContentLength` may bring memory overhead, \t// although the handler tries to be smart by reusing buffers \t// and testing if `len(data)` of the first \t// `http.ResponseWriter.Write(data []byte)` calling suffices or not. \tMinContentLength int64 // Filters are applied in the sequence here \tRequestFilter []RequestFilter // Filters are applied in the sequence here \tResponseHeaderFilter []ResponseHeaderFilter } // Handler implement gzip compression for gin and net/http type Handler struct { compressionLevel int minContentLength int64 requestFilter []RequestFilter responseHeaderFilter []ResponseHeaderFilter gzipWriterPool sync.Pool wrapperPool sync.Pool } // NewHandler initialized a costumed gzip handler to take care of response compression. // // config must not be modified after calling on NewHandler() func NewHandler(config Config) *Handler { if config.CompressionLevel  Stateless || config.CompressionLevel  BestCompression { panic(fmt.Sprintf(\"gzip: invalid CompressionLevel: %d\", config.CompressionLevel)) } if config.MinContentLength  0 { panic(fmt.Sprintf(\"gzip: invalid MinContentLength: %d\", config.MinContentLength)) } handler := Handler{ compressionLevel: config.CompressionLevel, minContentLength: config.MinContentLength, requestFilter: config.RequestFilter, responseHeaderFilter: config.ResponseHeaderFilter, } handler.gzipWriterPool.New = func() interface{} { writer, _ := gzip.NewWriterLevel(ioutil.Discard, handler.compressionLevel) return writer } handler.wrapperPool.New = func() interface{} { return newWriterWrapper(handler.responseHeaderFilter, handler.minContentLength, nil, handler.getGzipWriter, handler.putGzipWriter) } return \u0026handler } var defaultConfig = Config{ CompressionLevel: 6, MinContentLength: 1 * 1024, RequestFilter: []RequestFilter{ NewCommonRequestFilter(), DefaultExtensionFilter(), }, ResponseHeaderFilter: []ResponseHeaderFilter{ NewSkipCompressedFilter(), DefaultContentTypeFilter(), }, } // DefaultHandler creates a gzip handler to take care of response compression, // with meaningful preset. func DefaultHandler() *Handler { return NewHandler(defaultConfig) } func (h *Handler) getGzipWriter() *gzip.Writer { return h.gzipWriterPool.Get().(*gzip.Writer) } func (h *Handler) putGzipWriter(w *gzip.Writer) { if w == nil { return } _ = w.Close() w.Reset(ioutil.Discard) h.gzipWriterPool.Put(w) } func (h *Handler) getWriteWrapper() *writerWrapper { return h.wrapperPool.Get().(*writerWrapper) } func (h *Handler) putWriteWrapper(w *writerWrapper) { if w == nil { return } w.FinishWriting() w.OriginWriter = nil h.wrapperPool.Put(w) } type ginGzipWriter struct { wrapper *writerWrapper originWriter gin.ResponseWriter } // interface guard var _ gin.ResponseWriter = (*ginGzipWriter)(nil) func (g *ginGzipWriter) WriteHeaderNow() { g.wrapper.WriteHeaderNow() } func (g *ginGzipWriter) Hijack() (net.Conn, *bufio.ReadWriter, error) { return g.originWriter.Hijack() } func (g *ginGzipWriter) CloseNotify() chan bool { return g.originWriter.CloseNotify() } func (g *ginGzipWriter) Status() int { return g.wrapper.Status() } func (g *ginGzipWriter) Size() int { return g.wrapper.Size() } func (g *ginGzipWriter) Written() bool { return g.wrapper.Written() } func (g *ginGzipWriter) Pusher() http.Pusher { // TODO: not sure how to implement gzip for HTTP2 \treturn nil } // WriteString implements interface gin.ResponseWriter func (g *ginGzipWriter) WriteString(s string) (int, error) { return g.wrapper.Write([]byte(s)) } // Write implements interface gin.ResponseWriter func (g *ginGzipWriter) Write(data []byte) (int, error) { return g.wrapper.Write(data) } // WriteHeader implements interface gin.ResponseWriter func (g *ginGzipWriter) WriteHeader(code int) { g.wrapper.WriteHeader(code) } // WriteHeader implements interface gin.ResponseWriter func (g *ginGzipWriter) Header() http.Header { return g.wrapper.Header() } // Flush implements http.Flusher func (g *ginGzipWriter) Flush() { g.wrapper.Flush() } // Gin implement gin's middleware func (h *Handler) Gin(c *gin.Context) { var shouldCompress = true for _, filter := range h.requestFilter { shouldCompress = filter.ShouldCompress(c.Request) if !shouldCompress { break } } if shouldCompress { wrapper := h.getWriteWrapper() wrapper.Reset(c.Writer) originWriter := c.Writer c.Writer = \u0026ginGzipWriter{ originWriter: c.Writer, wrapper: wrapper, } defer func() { h.putWriteWrapper(wrapper) c.Writer = originWriter }() } c.Next() } // WrapHandler wraps a http.Handler, returning its gzip-enabled version func (h *Handler) WrapHandler(next http.Handler) http.Handler { return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { var shouldCompress = true for _, filter := range h.requestFilter { shouldCompress = filter.ShouldCompress(r) if !shouldCompress { break } } if shouldCompress { wrapper := h.getWriteWrapper() wrapper.Reset(w) originWriter := w w = wrapper defer func() { h.putWriteWrapper(wrapper) w = originWriter }() } next.ServeHTTP(w, r) }) }   requestfilters 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89  package gzip import ( \"net/http\" \"path\" \"strings\" \"github.com/signalsciences/ac/acascii\" ) // RequestFilter decide whether or not to compress response judging by request type RequestFilter interface { // ShouldCompress decide whether or not to compress response, \t// judging by request \tShouldCompress(req *http.Request) bool } // interface guards var ( _ RequestFilter = (*CommonRequestFilter)(nil) _ RequestFilter = (*ExtensionFilter)(nil) ) // CommonRequestFilter judge via common easy criteria like // http method, accept-encoding header, etc. type CommonRequestFilter struct{} // NewCommonRequestFilter ... func NewCommonRequestFilter() *CommonRequestFilter { return \u0026CommonRequestFilter{} } // ShouldCompress implements RequestFilter interface func (c *CommonRequestFilter) ShouldCompress(req *http.Request) bool { return req.Method != http.MethodHead \u0026\u0026 req.Method != http.MethodOptions \u0026\u0026 req.Header.Get(\"Upgrade\") == \"\" \u0026\u0026 strings.Contains(req.Header.Get(\"Accept-Encoding\"), \"gzip\") } // ExtensionFilter judge via the extension in path // // Omit this filter if you want to compress all extension. type ExtensionFilter struct { Exts *acascii.Matcher AllowEmpty bool } // NewExtensionFilter returns a extension or panics func NewExtensionFilter(extensions []string) *ExtensionFilter { var ( exts = make([]string, 0, len(extensions)) allowEmpty bool ) for _, item := range extensions { if item == \"\" { allowEmpty = true continue } exts = append(exts, item) } return \u0026ExtensionFilter{ Exts: acascii.MustCompileString(exts), AllowEmpty: allowEmpty, } } // ShouldCompress implements RequestFilter interface func (e *ExtensionFilter) ShouldCompress(req *http.Request) bool { ext := path.Ext(req.URL.Path) if ext == \"\" { return e.AllowEmpty } return e.Exts.MatchString(ext) } // defaultExtensions is the list of default extensions for which to enable gzip. // original source: // https://github.com/caddyserver/caddy/blob/7fa90f08aee0861187236b2fbea16b4fa69c5a28/caddyhttp/gzip/requestfilter.go#L32 var defaultExtensions = []string{\"\", \".txt\", \".htm\", \".html\", \".css\", \".php\", \".js\", \".json\", \".md\", \".mdown\", \".xml\", \".svg\", \".go\", \".cgi\", \".py\", \".pl\", \".aspx\", \".asp\", \".m3u\", \".m3u8\", \".wasm\"} // DefaultExtensionFilter permits func DefaultExtensionFilter() *ExtensionFilter { return NewExtensionFilter(defaultExtensions) }   responsefilters 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87  package gzip import ( \"net/http\" \"github.com/signalsciences/ac/acascii\" ) // ResponseHeaderFilter decide whether or not to compress response // judging by response header type ResponseHeaderFilter interface { // ShouldCompress decide whether or not to compress response, \t// judging by response header \tShouldCompress(header http.Header) bool } // interface guards var ( _ ResponseHeaderFilter = (*SkipCompressedFilter)(nil) _ ResponseHeaderFilter = (*ContentTypeFilter)(nil) ) // SkipCompressedFilter judges whether content has been // already compressed type SkipCompressedFilter struct{} // NewSkipCompressedFilter ... func NewSkipCompressedFilter() *SkipCompressedFilter { return \u0026SkipCompressedFilter{} } // ShouldCompress implements ResponseHeaderFilter interface // // Content-Encoding: https://tools.ietf.org/html/rfc2616#section-3.5 func (s *SkipCompressedFilter) ShouldCompress(header http.Header) bool { return header.Get(\"Content-Encoding\") == \"\" \u0026\u0026 header.Get(\"Transfer-Encoding\") == \"\" } // ContentTypeFilter judge via the response content type // // Omit this filter if you want to compress all content type. type ContentTypeFilter struct { Types *acascii.Matcher AllowEmpty bool } // NewContentTypeFilter ... func NewContentTypeFilter(types []string) *ContentTypeFilter { var ( nonEmpty = make([]string, 0, len(types)) allowEmpty bool ) for _, item := range types { if item == \"\" { allowEmpty = true continue } nonEmpty = append(nonEmpty, item) } return \u0026ContentTypeFilter{ Types: acascii.MustCompileString(nonEmpty), AllowEmpty: allowEmpty, } } // ShouldCompress implements RequestFilter interface func (e *ContentTypeFilter) ShouldCompress(header http.Header) bool { contentType := header.Get(\"Content-Type\") if contentType == \"\" { return e.AllowEmpty } return e.Types.MatchString(contentType) } // defaultContentType is the list of default content types for which to enable gzip. // original source: // https://support.cloudflare.com/hc/en-us/articles/200168396-What-will-Cloudflare-compress- var defaultContentType = []string{\"text/html\", \"text/richtext\", \"text/plain\", \"text/css\", \"text/x-script\", \"text/x-component\", \"text/x-java-source\", \"text/x-markdown\", \"application/javascript\", \"application/x-javascript\", \"text/javascript\", \"text/js\", \"image/x-icon\", \"application/x-perl\", \"application/x-httpd-cgi\", \"text/xml\", \"application/xml\", \"application/xml+rss\", \"application/json\", \"multipart/bag\", \"multipart/mixed\", \"application/xhtml+xml\", \"font/ttf\", \"font/otf\", \"font/x-woff\", \"image/svg+xml\", \"application/vnd.ms-fontobject\", \"application/ttf\", \"application/x-ttf\", \"application/otf\", \"application/x-otf\", \"application/truetype\", \"application/opentype\", \"application/x-opentype\", \"application/font-woff\", \"application/eot\", \"application/font\", \"application/font-sfnt\", \"application/wasm\"} // DefaultContentTypeFilter permits func DefaultContentTypeFilter() *ContentTypeFilter { return NewContentTypeFilter(defaultContentType) }   writerwrapper 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285  package gzip import ( \"fmt\" \"net/http\" \"strconv\" \"strings\" \"github.com/klauspost/compress/gzip\" ) // writerWrapper wraps the originalHandler // to test whether to gzip and gzip the body if applicable. type writerWrapper struct { // header filter are applied by its sequence \tFilters []ResponseHeaderFilter // min content length to enable compress \tMinContentLength int64 OriginWriter http.ResponseWriter // use initGzipWriter() to init gzipWriter when in need \tGetGzipWriter func() *gzip.Writer // must close gzip writer and put it back to pool \tPutGzipWriter func(*gzip.Writer) // internal below \t// *** WARNING *** \t// *writerWrapper.Reset() method must be updated \t// upon following field changing  // compress or not \t// default to true \tshouldCompress bool // whether body is large enough \tbodyBigEnough bool // is header already flushed? \theaderFlushed bool responseHeaderChecked bool statusCode int // how many raw bytes has been written \tsize int gzipWriter *gzip.Writer bodyBuffer []byte } // interface guard var _ http.ResponseWriter = (*writerWrapper)(nil) var _ http.Flusher = (*writerWrapper)(nil) func newWriterWrapper(filters []ResponseHeaderFilter, minContentLength int64, originWriter http.ResponseWriter, getGzipWriter func() *gzip.Writer, putGzipWriter func(*gzip.Writer)) *writerWrapper { return \u0026writerWrapper{ shouldCompress: true, bodyBuffer: make([]byte, 0, minContentLength), Filters: filters, MinContentLength: minContentLength, OriginWriter: originWriter, GetGzipWriter: getGzipWriter, PutGzipWriter: putGzipWriter, } } // Reset the wrapper into a fresh one, // writing to originWriter func (w *writerWrapper) Reset(originWriter http.ResponseWriter) { w.OriginWriter = originWriter // internal below  // reset status with caution \t// all internal fields should be taken good care \tw.shouldCompress = true w.headerFlushed = false w.responseHeaderChecked = false w.bodyBigEnough = false w.statusCode = 0 w.size = 0 if w.gzipWriter != nil { w.PutGzipWriter(w.gzipWriter) w.gzipWriter = nil } if w.bodyBuffer != nil { w.bodyBuffer = w.bodyBuffer[:0] } } func (w *writerWrapper) Status() int { return w.statusCode } func (w *writerWrapper) Size() int { return w.size } func (w *writerWrapper) Written() bool { return w.headerFlushed || len(w.bodyBuffer)  0 } func (w *writerWrapper) WriteHeaderCalled() bool { return w.statusCode != 0 } func (w *writerWrapper) initGzipWriter() { w.gzipWriter = w.GetGzipWriter() w.gzipWriter.Reset(w.OriginWriter) } // Header implements http.ResponseWriter func (w *writerWrapper) Header() http.Header { return w.OriginWriter.Header() } // Write implements http.ResponseWriter func (w *writerWrapper) Write(data []byte) (int, error) { w.size += len(data) if !w.WriteHeaderCalled() { w.WriteHeader(http.StatusOK) } if !w.shouldCompress { return w.OriginWriter.Write(data) } if w.bodyBigEnough { return w.gzipWriter.Write(data) } // fast check \tif !w.responseHeaderChecked { w.responseHeaderChecked = true header := w.Header() for _, filter := range w.Filters { w.shouldCompress = filter.ShouldCompress(header) if !w.shouldCompress { w.WriteHeaderNow() return w.OriginWriter.Write(data) } } if w.enoughContentLength() { w.bodyBigEnough = true w.WriteHeaderNow() w.initGzipWriter() return w.gzipWriter.Write(data) } } if !w.writeBuffer(data) { w.bodyBigEnough = true // detect Content-Type if there's none \tif header := w.Header(); header.Get(\"Content-Type\") == \"\" { header.Set(\"Content-Type\", http.DetectContentType(w.bodyBuffer)) } w.WriteHeaderNow() w.initGzipWriter() if len(w.bodyBuffer)  0 { written, err := w.gzipWriter.Write(w.bodyBuffer) if err != nil { err = fmt.Errorf(\"w.gzipWriter.Write: %w\", err) return written, err } } return w.gzipWriter.Write(data) } return len(data), nil } func (w *writerWrapper) writeBuffer(data []byte) (fit bool) { if int64(len(data)+len(w.bodyBuffer))  w.MinContentLength { return false } w.bodyBuffer = append(w.bodyBuffer, data...) return true } func (w *writerWrapper) enoughContentLength() bool { contentLength, err := strconv.ParseInt(w.Header().Get(\"Content-Length\"), 10, 64) if err != nil { return false } if contentLength != 0 \u0026\u0026 contentLength = w.MinContentLength { return true } return false } // WriteHeader implements http.ResponseWriter // // WriteHeader does not really calls originalHandler's WriteHeader, // and the calling will actually be handler by WriteHeaderNow(). // // http.ResponseWriter does not specify clearly whether permitting // updating status code on second call to WriteHeader(), and it's // conflicting between http and gin's implementation. // Here, gzip consider second(and furthermore) calls to WriteHeader() // valid. WriteHeader() is disabled after flushing header. // Do note setting status code to 204 or 304 marks content uncompressable, // and a later status code change does not revert this. func (w *writerWrapper) WriteHeader(statusCode int) { if w.headerFlushed { return } w.statusCode = statusCode if !w.shouldCompress { return } if statusCode == http.StatusNoContent || statusCode == http.StatusNotModified { w.shouldCompress = false return } } // WriteHeaderNow Forces to write the http header (status code + headers). // // WriteHeaderNow must always be called and called after // WriteHeader() is called and // w.shouldCompress is decided. // // This method is usually called by gin's AbortWithStatus() func (w *writerWrapper) WriteHeaderNow() { if w.headerFlushed { return } // if neither WriteHeader() or Write() are called, \t// do nothing \tif !w.WriteHeaderCalled() { return } if w.shouldCompress { header := w.Header() header.Del(\"Content-Length\") header.Set(\"Content-Encoding\", \"gzip\") header.Add(\"Vary\", \"Accept-Encoding\") originalEtag := w.Header().Get(\"ETag\") if originalEtag != \"\" \u0026\u0026 !strings.HasPrefix(originalEtag, \"W/\") { w.Header().Set(\"ETag\", \"W/\"+originalEtag) } } w.OriginWriter.WriteHeader(w.statusCode) w.headerFlushed = true } // FinishWriting flushes header and closed gzip writer // // Write() and WriteHeader() should not be called // after FinishWriting() func (w *writerWrapper) FinishWriting() { // still buffering \tif w.shouldCompress \u0026\u0026 !w.bodyBigEnough { w.shouldCompress = false w.WriteHeaderNow() if len(w.bodyBuffer)  0 { _, _ = w.OriginWriter.Write(w.bodyBuffer) } } w.WriteHeaderNow() if w.gzipWriter != nil { w.PutGzipWriter(w.gzipWriter) w.gzipWriter = nil } } // Flush implements http.Flusher func (w *writerWrapper) Flush() { w.FinishWriting() if flusher, ok := w.OriginWriter.(http.Flusher); ok { flusher.Flush() } }   参考 经历心得分享：用 Web 框架 Gin 开发 API，但业务返回的 JSON 太大，调研了一圈，最后自己写了个中间件做 gzip 压缩，记录下调研和开发调优时的心得\n",
  "wordCount" : "4752",
  "inLanguage": "zh-cn",
  "datePublished": "2021-04-29T20:02:59Z",
  "dateModified": "2021-04-29T20:02:59Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/gin%E7%9A%84gzip%E4%B8%AD%E9%97%B4%E4%BB%B6nanmu42-gzip/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Gin的gzip中间件nanmu42-gzip
    </h1>
    <div class="post-meta">April 29, 2021
</div>
  </header> 
  <div class="post-content"><h2 id="背景">背景<a hidden class="anchor" aria-hidden="true" href="#背景">#</a></h2>
<p>最近在做一个 web 版的展示大屏，前端靠 HTTP(S)+JSON 和后端交互，部分图形是密集的地理点位和时间序列，HTTP 返回数据量较大，公网上加载速度不佳。</p>
<h2 id="调研">调研<a hidden class="anchor" aria-hidden="true" href="#调研">#</a></h2>
<p>考虑压缩 HTTP 返回，选了 gzip 这个常规选项。</p>
<p>gzip 在压缩时，得考虑几点：</p>
<ul>
<li>内容类型是否对压缩友好：例如 JPEG 本身已经压缩过，再次压缩收益太小，费力不讨好；</li>
<li>内容大小是否值得压缩：太小的内容压缩效果不好（甚至有可能比原文还大，毕竟有字典等开销），另外小内容本身传输时间短，直接放过去还能节约 CPU 和内存。</li>
</ul>
<h2 id="nginx">Nginx<a hidden class="anchor" aria-hidden="true" href="#nginx">#</a></h2>
<ul>
<li>Nginx 的压缩一般是用 ngx_http_gzip_module；</li>
<li>根据 Content-Type 判断内容类型是否对压缩友好，要压缩的类型由用户定义；</li>
<li>根据返回的 Content-Length 判断内容大小是否值得压缩；</li>
</ul>
<p>当返回的 JSON 大于 2KB 时，Golang 会使用 chunk 的形式传输，这个时候没有 Content-Length，ngx_http_gzip_module 不会进行内容压缩。</p>
<h2 id="gin-contribgzip">gin-contrib/gzip<a hidden class="anchor" aria-hidden="true" href="#gin-contribgzip">#</a></h2>
<ul>
<li>根据扩展名判断内容类型是否对压缩友好；</li>
<li>根据 Path 判断是否启用压缩；</li>
<li>不支持判断内容大小是否值得压缩。</li>
</ul>
<p>根据 Path 来判断确实可行，但太死板，业务和中间件耦合了。</p>
<h2 id="nanmu42gzip">nanmu42/gzip<a hidden class="anchor" aria-hidden="true" href="#nanmu42gzip">#</a></h2>
<ul>
<li>支持 Gin 和 标准库 net/http ；</li>
<li>支持基于 Content-Type、Content-Length、扩展名判断是否压缩；</li>
<li>启用压缩的阈值用户可以自定义；</li>
<li>压缩级别用户可以自定义；</li>
<li>不压缩已经压缩过的返回，不压缩 Head 请求的返回，不影响 HTTP Upgrade ；</li>
<li>中间件初始化简单，集成容易；</li>
</ul>
<h2 id="更进一步">更进一步<a hidden class="anchor" aria-hidden="true" href="#更进一步">#</a></h2>
<ul>
<li>
<p>还记得返回的 JSON 大于 2KB 时，Golang 会使用 chunk 的形式传输，这个时候没有 Content-Length 带来无法判断内容是否值得压缩的问题吗？</p>
</li>
<li>
<p>我取了个巧，如果 Content-Length 不存在，中间件会去观察 http.ResponseWriter.Write(data []byte) 的第一次调用时的 len(data)，如果此时 len(data) 已经大于启用压缩的阈值，那么可以安全地开始压缩。</p>
</li>
</ul>
<h2 id="效率">效率<a hidden class="anchor" aria-hidden="true" href="#效率">#</a></h2>
<ul>
<li>当返回体积不大时，Handler会智能地跳过压缩，这个过程带来的代价可以忽略不记；</li>
<li>当返回体积足够大时，Handler会进行gzip压缩，这个过程有着合理的代价。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">$</span> <span class="n">go</span> <span class="n">test</span> <span class="o">-</span><span class="n">benchmem</span> <span class="o">-</span><span class="n">bench</span> <span class="n">.
</span><span class="n">goos</span><span class="o">:</span> <span class="n">linux</span>
<span class="n">goarch</span><span class="o">:</span> <span class="n">amd64</span>
<span class="n">pkg</span><span class="o">:</span> <span class="n">github.com</span><span class="o">/</span><span class="n">nanmu42</span><span class="o">/</span><span class="n">gzip</span>
<span class="n">BenchmarkSoleGin_SmallPayload</span><span class="m">-4</span>                          <span class="m">4104684</span>               <span class="m">276</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>              <span class="m">64</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">2</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkGinWithDefaultHandler_SmallPayload</span><span class="m">-4</span>            <span class="m">1683307</span>               <span class="m">707</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>              <span class="m">96</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">3</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkSoleGin_BigPayload</span><span class="m">-4</span>                            <span class="m">4198786</span>               <span class="m">274</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>              <span class="m">64</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">2</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkGinWithDefaultHandler_BigPayload</span><span class="m">-4</span>                <span class="m">44780</span>             <span class="m">27636</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>             <span class="m">190</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">5</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">PASS</span>
<span class="n">ok</span>      <span class="n">github.com</span><span class="o">/</span><span class="n">nanmu42</span><span class="o">/</span><span class="n">gzip</span> <span class="m">6.373</span><span class="n">s</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="局限性">局限性<a hidden class="anchor" aria-hidden="true" href="#局限性">#</a></h2>
<ul>
<li>
<p>你应该总是在返回中提供Content-Type。虽然Handler会在Content-Type缺失时使用http.DetectContentType()进行猜测，但是效果并没有那么好；</p>
</li>
<li>
<p>返回的Content-Length 缺失时，Handler可能会缓冲返回的报文数据以决定报文是否大到值得进行压缩，如果MinContentLength设置得太大，这个过程可能会带来内存压力。Handler针对这个情况做了一些优化，例如查看http.ResponseWriter.Write(data []byte)在首次调用时的 len(data)，以及资源复用。</p>
</li>
</ul>
<h2 id="ac-自动机">AC 自动机<a hidden class="anchor" aria-hidden="true" href="#ac-自动机">#</a></h2>
<p>原本我使用 Strings.Contains() 配合循环来判断文件后缀 /MIME 是否在支持压缩的列表中，但 benchmark 下来效果不太好。做了一些搜索后发现 Cloudflare 实现了一个 AC 自动机来做这个事情。和维护者聊了聊之后，我用了它的一个 fork： <a href="https://github.com/signalsciences/ac">https://github.com/signalsciences/ac</a></p>
<h2 id="syncpool">Sync.Pool<a hidden class="anchor" aria-hidden="true" href="#syncpool">#</a></h2>
<p>Sync.Pool 用来做对象重用，以降低系统内存分配和 Go 垃圾回收的压力，一开始我只对 gzip.Writer 做了对象重用，但发现中间件对内存的影响还有一些大，后来我用了第二个 Sync.Pool 重用 wrapper，内存使用量和 CPU 时间都有了可观的改善。</p>
<p>两个调优之后，CPU 时间下降为调优前的 40%，内存使用量下降为原先的一半。</p>
<h2 id="使用示例">使用示例<a hidden class="anchor" aria-hidden="true" href="#使用示例">#</a></h2>
<p>默认设置DefaultHandler()可以满足大部分场景。</p>
<h3 id="gin">Gin<a hidden class="anchor" aria-hidden="true" href="#gin">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;strings&#34;</span>

	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
	<span class="s">&#34;github.com/nanmu42/gzip&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">g</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">Default</span><span class="p">()</span>

	<span class="nx">g</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gzip</span><span class="p">.</span><span class="nf">DefaultHandler</span><span class="p">().</span><span class="nx">Gin</span><span class="p">)</span>

	<span class="nx">g</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
			<span class="s">&#34;code&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s">&#34;msg&#34;</span><span class="p">:</span>  <span class="s">&#34;hello&#34;</span><span class="p">,</span>
			<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="s">&#34;GET /short and GET /long to have a try!&#34;</span><span class="p">,</span>
		<span class="p">})</span>
	<span class="p">})</span>

	<span class="c1">// short response will not be compressed
</span><span class="c1"></span>	<span class="nx">g</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/short&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
			<span class="s">&#34;code&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s">&#34;msg&#34;</span><span class="p">:</span>  <span class="s">&#34;This content is not long enough to be compressed.&#34;</span><span class="p">,</span>
			<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="s">&#34;short!&#34;</span><span class="p">,</span>
		<span class="p">})</span>
	<span class="p">})</span>

	<span class="c1">// long response that will be compressed by gzip
</span><span class="c1"></span>	<span class="nx">g</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/long&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
			<span class="s">&#34;code&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="s">&#34;msg&#34;</span><span class="p">:</span>  <span class="s">&#34;This content is compressed&#34;</span><span class="p">,</span>
			<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;l%sng!&#34;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Repeat</span><span class="p">(</span><span class="s">&#34;o&#34;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)),</span>
		<span class="p">})</span>
	<span class="p">})</span>

	<span class="kd">const</span> <span class="nx">port</span> <span class="p">=</span> <span class="mi">3000</span>

	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Service is litsenning on port %d...&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">g</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;:%d&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">)))</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="nethttp">net/http<a hidden class="anchor" aria-hidden="true" href="#nethttp">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;strings&#34;</span>

	<span class="s">&#34;github.com/nanmu42/gzip&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">()</span>
	<span class="nx">mux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">writeString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;GET /short and /long to have a try!&#34;</span><span class="p">)</span>
	<span class="p">})</span>
	<span class="nx">mux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/short&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">writeString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;This content is not long enough to be compressed.&#34;</span><span class="p">)</span>
	<span class="p">})</span>
	<span class="nx">mux</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/long&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">writeString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;This content is compressed: l%sng!&#34;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Repeat</span><span class="p">(</span><span class="s">&#34;o&#34;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)))</span>
	<span class="p">})</span>

	<span class="kd">const</span> <span class="nx">port</span> <span class="p">=</span> <span class="mi">3001</span>

	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Service is litsenning on port %d...&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;:%d&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">),</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">DefaultHandler</span><span class="p">().</span><span class="nf">WrapHandler</span><span class="p">(</span><span class="nx">mux</span><span class="p">)))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">writeString</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">payload</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;text/plain; charset=utf8&#34;</span><span class="p">)</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">payload</span><span class="o">+</span><span class="s">&#34;\n&#34;</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="定制handler">定制Handler<a hidden class="anchor" aria-hidden="true" href="#定制handler">#</a></h3>
<p>使用NewHandler()可以定制参数以满足你的特殊需要：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">nanmu42</span><span class="o">/</span><span class="nx">gzip</span>

<span class="nx">handler</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewHandler</span><span class="p">(</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
    <span class="c1">// gzip压缩等级
</span><span class="c1"></span>	<span class="nx">CompressionLevel</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
    <span class="c1">// 触发gzip的最小body体积，单位：byte
</span><span class="c1"></span>	<span class="nx">MinContentLength</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
    <span class="c1">// 请求过滤器基于请求来判断是否对这条请求的返回启用gzip，
</span><span class="c1"></span>    <span class="c1">// 过滤器按其定义顺序执行，下同。
</span><span class="c1"></span>	<span class="nx">RequestFilter</span><span class="p">:</span> <span class="p">[]</span><span class="nx">RequestFilter</span><span class="p">{</span>
	    <span class="nf">NewCommonRequestFilter</span><span class="p">(),</span>
	    <span class="nf">DefaultExtensionFilter</span><span class="p">(),</span>
	<span class="p">},</span>
    <span class="c1">// 返回header过滤器基于返回的header判断是否对这条请求的返回启用gzip
</span><span class="c1"></span>	<span class="nx">ResponseHeaderFilter</span><span class="p">:</span> <span class="p">[]</span><span class="nx">ResponseHeaderFilter</span><span class="p">{</span>
		<span class="nf">NewSkipCompressedFilter</span><span class="p">(),</span>
		<span class="nf">DefaultContentTypeFilter</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>RequestFilter 和 ResponseHeaderFilter 是 interface. 你可以实现你自己的过滤器。</p>
<h2 id="源码">源码<a hidden class="anchor" aria-hidden="true" href="#源码">#</a></h2>
<h3 id="handler">handler<a hidden class="anchor" aria-hidden="true" href="#handler">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gzip</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;bufio&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io/ioutil&#34;</span>
	<span class="s">&#34;net&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;sync&#34;</span>

	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
	<span class="s">&#34;github.com/klauspost/compress/gzip&#34;</span>
<span class="p">)</span>

<span class="c1">// These constants are copied from the gzip package
</span><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
	<span class="nx">NoCompression</span>      <span class="p">=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nx">NoCompression</span>
	<span class="nx">BestSpeed</span>          <span class="p">=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nx">BestSpeed</span>
	<span class="nx">BestCompression</span>    <span class="p">=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nx">BestCompression</span>
	<span class="nx">DefaultCompression</span> <span class="p">=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nx">DefaultCompression</span>
	<span class="nx">HuffmanOnly</span>        <span class="p">=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nx">HuffmanOnly</span>
	<span class="c1">// Stateless will do compression but without maintaining any state
</span><span class="c1"></span>	<span class="c1">// between Write calls, so long running responses will not take memory.
</span><span class="c1"></span>	<span class="c1">// There will be no memory kept between Write calls,
</span><span class="c1"></span>	<span class="c1">// but compression and speed will be suboptimal.
</span><span class="c1"></span>	<span class="c1">// Because of this, the size of actual Write calls will affect output size.
</span><span class="c1"></span>	<span class="nx">Stateless</span> <span class="p">=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nx">StatelessCompression</span>
<span class="p">)</span>

<span class="c1">// Config is used in Handler initialization
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// gzip compression level to use,
</span><span class="c1"></span>	<span class="c1">// valid value: -3 =&gt; 9.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// see https://golang.org/pkg/compress/gzip/#NewWriterLevel
</span><span class="c1"></span>	<span class="nx">CompressionLevel</span> <span class="kt">int</span>
	<span class="c1">// Minimum content length to trigger gzip,
</span><span class="c1"></span>	<span class="c1">// the unit is in byte.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// When `Content-Length` is not available, handler may buffer your writes to
</span><span class="c1"></span>	<span class="c1">// decide if its big enough to do a meaningful compression.
</span><span class="c1"></span>	<span class="c1">// A high `MinContentLength` may bring memory overhead,
</span><span class="c1"></span>	<span class="c1">// although the handler tries to be smart by reusing buffers
</span><span class="c1"></span>	<span class="c1">// and testing if `len(data)` of the first
</span><span class="c1"></span>	<span class="c1">// `http.ResponseWriter.Write(data []byte)` calling suffices or not.
</span><span class="c1"></span>	<span class="nx">MinContentLength</span> <span class="kt">int64</span>
	<span class="c1">// Filters are applied in the sequence here
</span><span class="c1"></span>	<span class="nx">RequestFilter</span> <span class="p">[]</span><span class="nx">RequestFilter</span>
	<span class="c1">// Filters are applied in the sequence here
</span><span class="c1"></span>	<span class="nx">ResponseHeaderFilter</span> <span class="p">[]</span><span class="nx">ResponseHeaderFilter</span>
<span class="p">}</span>

<span class="c1">// Handler implement gzip compression for gin and net/http
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Handler</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">compressionLevel</span>     <span class="kt">int</span>
	<span class="nx">minContentLength</span>     <span class="kt">int64</span>
	<span class="nx">requestFilter</span>        <span class="p">[]</span><span class="nx">RequestFilter</span>
	<span class="nx">responseHeaderFilter</span> <span class="p">[]</span><span class="nx">ResponseHeaderFilter</span>
	<span class="nx">gzipWriterPool</span>       <span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span>
	<span class="nx">wrapperPool</span>          <span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span>
<span class="p">}</span>

<span class="c1">// NewHandler initialized a costumed gzip handler to take care of response compression.
</span><span class="c1">//
</span><span class="c1">// config must not be modified after calling on NewHandler()
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewHandler</span><span class="p">(</span><span class="nx">config</span> <span class="nx">Config</span><span class="p">)</span> <span class="o">*</span><span class="nx">Handler</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">CompressionLevel</span> <span class="p">&lt;</span> <span class="nx">Stateless</span> <span class="o">||</span> <span class="nx">config</span><span class="p">.</span><span class="nx">CompressionLevel</span> <span class="p">&gt;</span> <span class="nx">BestCompression</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;gzip: invalid CompressionLevel: %d&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">CompressionLevel</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">MinContentLength</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;gzip: invalid MinContentLength: %d&#34;</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">MinContentLength</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="nx">handler</span> <span class="o">:=</span> <span class="nx">Handler</span><span class="p">{</span>
		<span class="nx">compressionLevel</span><span class="p">:</span>     <span class="nx">config</span><span class="p">.</span><span class="nx">CompressionLevel</span><span class="p">,</span>
		<span class="nx">minContentLength</span><span class="p">:</span>     <span class="nx">config</span><span class="p">.</span><span class="nx">MinContentLength</span><span class="p">,</span>
		<span class="nx">requestFilter</span><span class="p">:</span>        <span class="nx">config</span><span class="p">.</span><span class="nx">RequestFilter</span><span class="p">,</span>
		<span class="nx">responseHeaderFilter</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">ResponseHeaderFilter</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="nx">handler</span><span class="p">.</span><span class="nx">gzipWriterPool</span><span class="p">.</span><span class="nx">New</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
		<span class="nx">writer</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">gzip</span><span class="p">.</span><span class="nf">NewWriterLevel</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">compressionLevel</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">writer</span>
	<span class="p">}</span>
	<span class="nx">handler</span><span class="p">.</span><span class="nx">wrapperPool</span><span class="p">.</span><span class="nx">New</span> <span class="p">=</span> <span class="kd">func</span><span class="p">()</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">newWriterWrapper</span><span class="p">(</span><span class="nx">handler</span><span class="p">.</span><span class="nx">responseHeaderFilter</span><span class="p">,</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">minContentLength</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">getGzipWriter</span><span class="p">,</span> <span class="nx">handler</span><span class="p">.</span><span class="nx">putGzipWriter</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">handler</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">defaultConfig</span> <span class="p">=</span> <span class="nx">Config</span><span class="p">{</span>
	<span class="nx">CompressionLevel</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
	<span class="nx">MinContentLength</span><span class="p">:</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="nx">RequestFilter</span><span class="p">:</span> <span class="p">[]</span><span class="nx">RequestFilter</span><span class="p">{</span>
		<span class="nf">NewCommonRequestFilter</span><span class="p">(),</span>
		<span class="nf">DefaultExtensionFilter</span><span class="p">(),</span>
	<span class="p">},</span>
	<span class="nx">ResponseHeaderFilter</span><span class="p">:</span> <span class="p">[]</span><span class="nx">ResponseHeaderFilter</span><span class="p">{</span>
		<span class="nf">NewSkipCompressedFilter</span><span class="p">(),</span>
		<span class="nf">DefaultContentTypeFilter</span><span class="p">(),</span>
	<span class="p">},</span>
<span class="p">}</span>

<span class="c1">// DefaultHandler creates a gzip handler to take care of response compression,
</span><span class="c1">// with meaningful preset.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DefaultHandler</span><span class="p">()</span> <span class="o">*</span><span class="nx">Handler</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">NewHandler</span><span class="p">(</span><span class="nx">defaultConfig</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handler</span><span class="p">)</span> <span class="nf">getGzipWriter</span><span class="p">()</span> <span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">gzipWriterPool</span><span class="p">.</span><span class="nf">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handler</span><span class="p">)</span> <span class="nf">putGzipWriter</span><span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">w</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">)</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">gzipWriterPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handler</span><span class="p">)</span> <span class="nf">getWriteWrapper</span><span class="p">()</span> <span class="o">*</span><span class="nx">writerWrapper</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">wrapperPool</span><span class="p">.</span><span class="nf">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handler</span><span class="p">)</span> <span class="nf">putWriteWrapper</span><span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">w</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">w</span><span class="p">.</span><span class="nf">FinishWriting</span><span class="p">()</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span> <span class="p">=</span> <span class="kc">nil</span>
	<span class="nx">h</span><span class="p">.</span><span class="nx">wrapperPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ginGzipWriter</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">wrapper</span>      <span class="o">*</span><span class="nx">writerWrapper</span>
	<span class="nx">originWriter</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">ResponseWriter</span>
<span class="p">}</span>

<span class="c1">// interface guard
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">_</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">ResponseWriter</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">WriteHeaderNow</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">Hijack</span><span class="p">()</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">,</span> <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">ReadWriter</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">originWriter</span><span class="p">.</span><span class="nf">Hijack</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">CloseNotify</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">originWriter</span><span class="p">.</span><span class="nf">CloseNotify</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">Status</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">Status</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">Size</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">Written</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">Written</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">Pusher</span><span class="p">()</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Pusher</span> <span class="p">{</span>
	<span class="c1">// TODO: not sure how to implement gzip for HTTP2
</span><span class="c1"></span>	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// WriteString implements interface gin.ResponseWriter
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">WriteString</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Write implements interface gin.ResponseWriter
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">Write</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// WriteHeader implements interface gin.ResponseWriter
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// WriteHeader implements interface gin.ResponseWriter
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">Header</span><span class="p">()</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">Header</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Flush implements http.Flusher
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">ginGzipWriter</span><span class="p">)</span> <span class="nf">Flush</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">g</span><span class="p">.</span><span class="nx">wrapper</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Gin implement gin&#39;s middleware
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handler</span><span class="p">)</span> <span class="nf">Gin</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">shouldCompress</span> <span class="p">=</span> <span class="kc">true</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">filter</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">h</span><span class="p">.</span><span class="nx">requestFilter</span> <span class="p">{</span>
		<span class="nx">shouldCompress</span> <span class="p">=</span> <span class="nx">filter</span><span class="p">.</span><span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">shouldCompress</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">shouldCompress</span> <span class="p">{</span>
		<span class="nx">wrapper</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">getWriteWrapper</span><span class="p">()</span>
		<span class="nx">wrapper</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span>
		<span class="nx">originWriter</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span>
		<span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">ginGzipWriter</span><span class="p">{</span>
			<span class="nx">originWriter</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span>
			<span class="nx">wrapper</span><span class="p">:</span>      <span class="nx">wrapper</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">h</span><span class="p">.</span><span class="nf">putWriteWrapper</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">)</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span> <span class="p">=</span> <span class="nx">originWriter</span>
		<span class="p">}()</span>
	<span class="p">}</span>

	<span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// WrapHandler wraps a http.Handler, returning its gzip-enabled version
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Handler</span><span class="p">)</span> <span class="nf">WrapHandler</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">shouldCompress</span> <span class="p">=</span> <span class="kc">true</span>

		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">filter</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">h</span><span class="p">.</span><span class="nx">requestFilter</span> <span class="p">{</span>
			<span class="nx">shouldCompress</span> <span class="p">=</span> <span class="nx">filter</span><span class="p">.</span><span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">shouldCompress</span> <span class="p">{</span>
				<span class="k">break</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">shouldCompress</span> <span class="p">{</span>
			<span class="nx">wrapper</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">getWriteWrapper</span><span class="p">()</span>
			<span class="nx">wrapper</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
			<span class="nx">originWriter</span> <span class="o">:=</span> <span class="nx">w</span>
			<span class="nx">w</span> <span class="p">=</span> <span class="nx">wrapper</span>
			<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">h</span><span class="p">.</span><span class="nf">putWriteWrapper</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">)</span>
				<span class="nx">w</span> <span class="p">=</span> <span class="nx">originWriter</span>
			<span class="p">}()</span>
		<span class="p">}</span>

		<span class="nx">next</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="requestfilters">requestfilters<a hidden class="anchor" aria-hidden="true" href="#requestfilters">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gzip</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;path&#34;</span>
	<span class="s">&#34;strings&#34;</span>

	<span class="s">&#34;github.com/signalsciences/ac/acascii&#34;</span>
<span class="p">)</span>

<span class="c1">// RequestFilter decide whether or not to compress response judging by request
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">RequestFilter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// ShouldCompress decide whether or not to compress response,
</span><span class="c1"></span>	<span class="c1">// judging by request
</span><span class="c1"></span>	<span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="c1">// interface guards
</span><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
	<span class="nx">_</span> <span class="nx">RequestFilter</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">CommonRequestFilter</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
	<span class="nx">_</span> <span class="nx">RequestFilter</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">ExtensionFilter</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">// CommonRequestFilter judge via common easy criteria like
</span><span class="c1">// http method, accept-encoding header, etc.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">CommonRequestFilter</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// NewCommonRequestFilter ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewCommonRequestFilter</span><span class="p">()</span> <span class="o">*</span><span class="nx">CommonRequestFilter</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">CommonRequestFilter</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// ShouldCompress implements RequestFilter interface
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">CommonRequestFilter</span><span class="p">)</span> <span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">MethodHead</span> <span class="o">&amp;&amp;</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">MethodOptions</span> <span class="o">&amp;&amp;</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Upgrade&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span>
		<span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Accept-Encoding&#34;</span><span class="p">),</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ExtensionFilter judge via the extension in path
</span><span class="c1">//
</span><span class="c1">// Omit this filter if you want to compress all extension.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ExtensionFilter</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Exts</span>       <span class="o">*</span><span class="nx">acascii</span><span class="p">.</span><span class="nx">Matcher</span>
	<span class="nx">AllowEmpty</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="c1">// NewExtensionFilter returns a extension or panics
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewExtensionFilter</span><span class="p">(</span><span class="nx">extensions</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">ExtensionFilter</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="p">(</span>
		<span class="nx">exts</span>       <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">extensions</span><span class="p">))</span>
		<span class="nx">allowEmpty</span> <span class="kt">bool</span>
	<span class="p">)</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">extensions</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">item</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">allowEmpty</span> <span class="p">=</span> <span class="kc">true</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="nx">exts</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">exts</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ExtensionFilter</span><span class="p">{</span>
		<span class="nx">Exts</span><span class="p">:</span>       <span class="nx">acascii</span><span class="p">.</span><span class="nf">MustCompileString</span><span class="p">(</span><span class="nx">exts</span><span class="p">),</span>
		<span class="nx">AllowEmpty</span><span class="p">:</span> <span class="nx">allowEmpty</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ShouldCompress implements RequestFilter interface
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ExtensionFilter</span><span class="p">)</span> <span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">ext</span> <span class="o">:=</span> <span class="nx">path</span><span class="p">.</span><span class="nf">Ext</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">ext</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">AllowEmpty</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Exts</span><span class="p">.</span><span class="nf">MatchString</span><span class="p">(</span><span class="nx">ext</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// defaultExtensions is the list of default extensions for which to enable gzip.
</span><span class="c1">// original source:
</span><span class="c1">// https://github.com/caddyserver/caddy/blob/7fa90f08aee0861187236b2fbea16b4fa69c5a28/caddyhttp/gzip/requestfilter.go#L32
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">defaultExtensions</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;.txt&#34;</span><span class="p">,</span> <span class="s">&#34;.htm&#34;</span><span class="p">,</span> <span class="s">&#34;.html&#34;</span><span class="p">,</span> <span class="s">&#34;.css&#34;</span><span class="p">,</span> <span class="s">&#34;.php&#34;</span><span class="p">,</span> <span class="s">&#34;.js&#34;</span><span class="p">,</span> <span class="s">&#34;.json&#34;</span><span class="p">,</span>
	<span class="s">&#34;.md&#34;</span><span class="p">,</span> <span class="s">&#34;.mdown&#34;</span><span class="p">,</span> <span class="s">&#34;.xml&#34;</span><span class="p">,</span> <span class="s">&#34;.svg&#34;</span><span class="p">,</span> <span class="s">&#34;.go&#34;</span><span class="p">,</span> <span class="s">&#34;.cgi&#34;</span><span class="p">,</span> <span class="s">&#34;.py&#34;</span><span class="p">,</span> <span class="s">&#34;.pl&#34;</span><span class="p">,</span> <span class="s">&#34;.aspx&#34;</span><span class="p">,</span> <span class="s">&#34;.asp&#34;</span><span class="p">,</span> <span class="s">&#34;.m3u&#34;</span><span class="p">,</span> <span class="s">&#34;.m3u8&#34;</span><span class="p">,</span> <span class="s">&#34;.wasm&#34;</span><span class="p">}</span>

<span class="c1">// DefaultExtensionFilter permits
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DefaultExtensionFilter</span><span class="p">()</span> <span class="o">*</span><span class="nx">ExtensionFilter</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">NewExtensionFilter</span><span class="p">(</span><span class="nx">defaultExtensions</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="responsefilters">responsefilters<a hidden class="anchor" aria-hidden="true" href="#responsefilters">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gzip</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;net/http&#34;</span>

	<span class="s">&#34;github.com/signalsciences/ac/acascii&#34;</span>
<span class="p">)</span>

<span class="c1">// ResponseHeaderFilter decide whether or not to compress response
</span><span class="c1">// judging by response header
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ResponseHeaderFilter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// ShouldCompress decide whether or not to compress response,
</span><span class="c1"></span>	<span class="c1">// judging by response header
</span><span class="c1"></span>	<span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">header</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">)</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="c1">// interface guards
</span><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
	<span class="nx">_</span> <span class="nx">ResponseHeaderFilter</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">SkipCompressedFilter</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
	<span class="nx">_</span> <span class="nx">ResponseHeaderFilter</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">ContentTypeFilter</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1">// SkipCompressedFilter judges whether content has been
</span><span class="c1">// already compressed
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SkipCompressedFilter</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// NewSkipCompressedFilter ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSkipCompressedFilter</span><span class="p">()</span> <span class="o">*</span><span class="nx">SkipCompressedFilter</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">SkipCompressedFilter</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// ShouldCompress implements ResponseHeaderFilter interface
</span><span class="c1">//
</span><span class="c1">// Content-Encoding: https://tools.ietf.org/html/rfc2616#section-3.5
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">SkipCompressedFilter</span><span class="p">)</span> <span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">header</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;&#34;</span>
<span class="p">}</span>

<span class="c1">// ContentTypeFilter judge via the response content type
</span><span class="c1">//
</span><span class="c1">// Omit this filter if you want to compress all content type.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ContentTypeFilter</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Types</span>      <span class="o">*</span><span class="nx">acascii</span><span class="p">.</span><span class="nx">Matcher</span>
	<span class="nx">AllowEmpty</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="c1">// NewContentTypeFilter ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewContentTypeFilter</span><span class="p">(</span><span class="nx">types</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">ContentTypeFilter</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="p">(</span>
		<span class="nx">nonEmpty</span>   <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">types</span><span class="p">))</span>
		<span class="nx">allowEmpty</span> <span class="kt">bool</span>
	<span class="p">)</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">types</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">item</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">allowEmpty</span> <span class="p">=</span> <span class="kc">true</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="nx">nonEmpty</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">nonEmpty</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">ContentTypeFilter</span><span class="p">{</span>
		<span class="nx">Types</span><span class="p">:</span>      <span class="nx">acascii</span><span class="p">.</span><span class="nf">MustCompileString</span><span class="p">(</span><span class="nx">nonEmpty</span><span class="p">),</span>
		<span class="nx">AllowEmpty</span><span class="p">:</span> <span class="nx">allowEmpty</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ShouldCompress implements RequestFilter interface
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">ContentTypeFilter</span><span class="p">)</span> <span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">header</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">contentType</span> <span class="o">:=</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">contentType</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">AllowEmpty</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nf">MatchString</span><span class="p">(</span><span class="nx">contentType</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// defaultContentType is the list of default content types for which to enable gzip.
</span><span class="c1">// original source:
</span><span class="c1">// https://support.cloudflare.com/hc/en-us/articles/200168396-What-will-Cloudflare-compress-
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">defaultContentType</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;text/html&#34;</span><span class="p">,</span> <span class="s">&#34;text/richtext&#34;</span><span class="p">,</span> <span class="s">&#34;text/plain&#34;</span><span class="p">,</span> <span class="s">&#34;text/css&#34;</span><span class="p">,</span> <span class="s">&#34;text/x-script&#34;</span><span class="p">,</span> <span class="s">&#34;text/x-component&#34;</span><span class="p">,</span> <span class="s">&#34;text/x-java-source&#34;</span><span class="p">,</span> <span class="s">&#34;text/x-markdown&#34;</span><span class="p">,</span> <span class="s">&#34;application/javascript&#34;</span><span class="p">,</span> <span class="s">&#34;application/x-javascript&#34;</span><span class="p">,</span> <span class="s">&#34;text/javascript&#34;</span><span class="p">,</span> <span class="s">&#34;text/js&#34;</span><span class="p">,</span> <span class="s">&#34;image/x-icon&#34;</span><span class="p">,</span> <span class="s">&#34;application/x-perl&#34;</span><span class="p">,</span> <span class="s">&#34;application/x-httpd-cgi&#34;</span><span class="p">,</span> <span class="s">&#34;text/xml&#34;</span><span class="p">,</span> <span class="s">&#34;application/xml&#34;</span><span class="p">,</span> <span class="s">&#34;application/xml+rss&#34;</span><span class="p">,</span> <span class="s">&#34;application/json&#34;</span><span class="p">,</span> <span class="s">&#34;multipart/bag&#34;</span><span class="p">,</span> <span class="s">&#34;multipart/mixed&#34;</span><span class="p">,</span> <span class="s">&#34;application/xhtml+xml&#34;</span><span class="p">,</span> <span class="s">&#34;font/ttf&#34;</span><span class="p">,</span> <span class="s">&#34;font/otf&#34;</span><span class="p">,</span> <span class="s">&#34;font/x-woff&#34;</span><span class="p">,</span> <span class="s">&#34;image/svg+xml&#34;</span><span class="p">,</span> <span class="s">&#34;application/vnd.ms-fontobject&#34;</span><span class="p">,</span> <span class="s">&#34;application/ttf&#34;</span><span class="p">,</span> <span class="s">&#34;application/x-ttf&#34;</span><span class="p">,</span> <span class="s">&#34;application/otf&#34;</span><span class="p">,</span> <span class="s">&#34;application/x-otf&#34;</span><span class="p">,</span> <span class="s">&#34;application/truetype&#34;</span><span class="p">,</span> <span class="s">&#34;application/opentype&#34;</span><span class="p">,</span> <span class="s">&#34;application/x-opentype&#34;</span><span class="p">,</span> <span class="s">&#34;application/font-woff&#34;</span><span class="p">,</span> <span class="s">&#34;application/eot&#34;</span><span class="p">,</span> <span class="s">&#34;application/font&#34;</span><span class="p">,</span> <span class="s">&#34;application/font-sfnt&#34;</span><span class="p">,</span> <span class="s">&#34;application/wasm&#34;</span><span class="p">}</span>

<span class="c1">// DefaultContentTypeFilter permits
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DefaultContentTypeFilter</span><span class="p">()</span> <span class="o">*</span><span class="nx">ContentTypeFilter</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">NewContentTypeFilter</span><span class="p">(</span><span class="nx">defaultContentType</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="writerwrapper">writerwrapper<a hidden class="anchor" aria-hidden="true" href="#writerwrapper">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">gzip</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;strconv&#34;</span>
	<span class="s">&#34;strings&#34;</span>

	<span class="s">&#34;github.com/klauspost/compress/gzip&#34;</span>
<span class="p">)</span>

<span class="c1">// writerWrapper wraps the originalHandler
</span><span class="c1">// to test whether to gzip and gzip the body if applicable.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">writerWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// header filter are applied by its sequence
</span><span class="c1"></span>	<span class="nx">Filters</span> <span class="p">[]</span><span class="nx">ResponseHeaderFilter</span>
	<span class="c1">// min content length to enable compress
</span><span class="c1"></span>	<span class="nx">MinContentLength</span> <span class="kt">int64</span>
	<span class="nx">OriginWriter</span>     <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span>
	<span class="c1">// use initGzipWriter() to init gzipWriter when in need
</span><span class="c1"></span>	<span class="nx">GetGzipWriter</span> <span class="kd">func</span><span class="p">()</span> <span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span>
	<span class="c1">// must close gzip writer and put it back to pool
</span><span class="c1"></span>	<span class="nx">PutGzipWriter</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span>

	<span class="c1">// internal below
</span><span class="c1"></span>	<span class="c1">// *** WARNING ***
</span><span class="c1"></span>	<span class="c1">// *writerWrapper.Reset() method must be updated
</span><span class="c1"></span>	<span class="c1">// upon following field changing
</span><span class="c1"></span>
	<span class="c1">// compress or not
</span><span class="c1"></span>	<span class="c1">// default to true
</span><span class="c1"></span>	<span class="nx">shouldCompress</span> <span class="kt">bool</span>
	<span class="c1">// whether body is large enough
</span><span class="c1"></span>	<span class="nx">bodyBigEnough</span> <span class="kt">bool</span>
	<span class="c1">// is header already flushed?
</span><span class="c1"></span>	<span class="nx">headerFlushed</span>         <span class="kt">bool</span>
	<span class="nx">responseHeaderChecked</span> <span class="kt">bool</span>
	<span class="nx">statusCode</span>            <span class="kt">int</span>
	<span class="c1">// how many raw bytes has been written
</span><span class="c1"></span>	<span class="nx">size</span>       <span class="kt">int</span>
	<span class="nx">gzipWriter</span> <span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span>
	<span class="nx">bodyBuffer</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>

<span class="c1">// interface guard
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">_</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Flusher</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">newWriterWrapper</span><span class="p">(</span><span class="nx">filters</span> <span class="p">[]</span><span class="nx">ResponseHeaderFilter</span><span class="p">,</span> <span class="nx">minContentLength</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">originWriter</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">getGzipWriter</span> <span class="kd">func</span><span class="p">()</span> <span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">putGzipWriter</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">gzip</span><span class="p">.</span><span class="nx">Writer</span><span class="p">))</span> <span class="o">*</span><span class="nx">writerWrapper</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">writerWrapper</span><span class="p">{</span>
		<span class="nx">shouldCompress</span><span class="p">:</span>   <span class="kc">true</span><span class="p">,</span>
		<span class="nx">bodyBuffer</span><span class="p">:</span>       <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">minContentLength</span><span class="p">),</span>
		<span class="nx">Filters</span><span class="p">:</span>          <span class="nx">filters</span><span class="p">,</span>
		<span class="nx">MinContentLength</span><span class="p">:</span> <span class="nx">minContentLength</span><span class="p">,</span>
		<span class="nx">OriginWriter</span><span class="p">:</span>     <span class="nx">originWriter</span><span class="p">,</span>
		<span class="nx">GetGzipWriter</span><span class="p">:</span>    <span class="nx">getGzipWriter</span><span class="p">,</span>
		<span class="nx">PutGzipWriter</span><span class="p">:</span>    <span class="nx">putGzipWriter</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Reset the wrapper into a fresh one,
</span><span class="c1">// writing to originWriter
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">Reset</span><span class="p">(</span><span class="nx">originWriter</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span> <span class="p">=</span> <span class="nx">originWriter</span>

	<span class="c1">// internal below
</span><span class="c1"></span>
	<span class="c1">// reset status with caution
</span><span class="c1"></span>	<span class="c1">// all internal fields should be taken good care
</span><span class="c1"></span>	<span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">headerFlushed</span> <span class="p">=</span> <span class="kc">false</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">responseHeaderChecked</span> <span class="p">=</span> <span class="kc">false</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">bodyBigEnough</span> <span class="p">=</span> <span class="kc">false</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">statusCode</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">size</span> <span class="p">=</span> <span class="mi">0</span>

	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nf">PutGzipWriter</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span><span class="p">)</span>
		<span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span> <span class="p">=</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">Status</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">statusCode</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">Size</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">size</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">Written</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">headerFlushed</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">WriteHeaderCalled</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">initGzipWriter</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">GetGzipWriter</span><span class="p">()</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Header implements http.ResponseWriter
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">Header</span><span class="p">()</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span><span class="p">.</span><span class="nf">Header</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Write implements http.ResponseWriter
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">Write</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">w</span><span class="p">.</span><span class="nx">size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeaderCalled</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">bodyBigEnough</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// fast check
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nx">responseHeaderChecked</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nx">responseHeaderChecked</span> <span class="p">=</span> <span class="kc">true</span>

		<span class="nx">header</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">()</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">filter</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Filters</span> <span class="p">{</span>
			<span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="p">=</span> <span class="nx">filter</span><span class="p">.</span><span class="nf">ShouldCompress</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="p">{</span>
				<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
				<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nf">enoughContentLength</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">w</span><span class="p">.</span><span class="nx">bodyBigEnough</span> <span class="p">=</span> <span class="kc">true</span>
			<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
			<span class="nx">w</span><span class="p">.</span><span class="nf">initGzipWriter</span><span class="p">()</span>
			<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nf">writeBuffer</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nx">bodyBigEnough</span> <span class="p">=</span> <span class="kc">true</span>

		<span class="c1">// detect Content-Type if there&#39;s none
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">header</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">();</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">DetectContentType</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">))</span>
		<span class="p">}</span>

		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
		<span class="nx">w</span><span class="p">.</span><span class="nf">initGzipWriter</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">written</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;w.gzipWriter.Write: %w&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="nx">written</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">writeBuffer</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">fit</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">int64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">))</span> <span class="p">&gt;</span> <span class="nx">w</span><span class="p">.</span><span class="nx">MinContentLength</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">,</span> <span class="nx">data</span><span class="o">...</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">enoughContentLength</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">contentLength</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">contentLength</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">contentLength</span> <span class="o">&gt;=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">MinContentLength</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="c1">// WriteHeader implements http.ResponseWriter
</span><span class="c1">//
</span><span class="c1">// WriteHeader does not really calls originalHandler&#39;s WriteHeader,
</span><span class="c1">// and the calling will actually be handler by WriteHeaderNow().
</span><span class="c1">//
</span><span class="c1">// http.ResponseWriter does not specify clearly whether permitting
</span><span class="c1">// updating status code on second call to WriteHeader(), and it&#39;s
</span><span class="c1">// conflicting between http and gin&#39;s implementation.
</span><span class="c1">// Here, gzip consider second(and furthermore) calls to WriteHeader()
</span><span class="c1">// valid. WriteHeader() is disabled after flushing header.
</span><span class="c1">// Do note setting status code to 204 or 304 marks content uncompressable,
</span><span class="c1">// and a later status code change does not revert this.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">statusCode</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">headerFlushed</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">w</span><span class="p">.</span><span class="nx">statusCode</span> <span class="p">=</span> <span class="nx">statusCode</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">statusCode</span> <span class="o">==</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusNoContent</span> <span class="o">||</span>
		<span class="nx">statusCode</span> <span class="o">==</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusNotModified</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="k">return</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// WriteHeaderNow Forces to write the http header (status code + headers).
</span><span class="c1">//
</span><span class="c1">// WriteHeaderNow must always be called and called after
</span><span class="c1">// WriteHeader() is called and
</span><span class="c1">// w.shouldCompress is decided.
</span><span class="c1">//
</span><span class="c1">// This method is usually called by gin&#39;s AbortWithStatus()
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">WriteHeaderNow</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">headerFlushed</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="c1">// if neither WriteHeader() or Write() are called,
</span><span class="c1"></span>	<span class="c1">// do nothing
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeaderCalled</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="p">{</span>
		<span class="nx">header</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">()</span>
		<span class="nx">header</span><span class="p">.</span><span class="nf">Del</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">)</span>
		<span class="nx">header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Encoding&#34;</span><span class="p">,</span> <span class="s">&#34;gzip&#34;</span><span class="p">)</span>
		<span class="nx">header</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;Vary&#34;</span><span class="p">,</span> <span class="s">&#34;Accept-Encoding&#34;</span><span class="p">)</span>
		<span class="nx">originalEtag</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;ETag&#34;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">originalEtag</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">originalEtag</span><span class="p">,</span> <span class="s">&#34;W/&#34;</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;ETag&#34;</span><span class="p">,</span> <span class="s">&#34;W/&#34;</span><span class="o">+</span><span class="nx">originalEtag</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">)</span>

	<span class="nx">w</span><span class="p">.</span><span class="nx">headerFlushed</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1">// FinishWriting flushes header and closed gzip writer
</span><span class="c1">//
</span><span class="c1">// Write() and WriteHeader() should not be called
</span><span class="c1">// after FinishWriting()
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">FinishWriting</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// still buffering
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBigEnough</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nx">shouldCompress</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">bodyBuffer</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeaderNow</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">.</span><span class="nf">PutGzipWriter</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span><span class="p">)</span>
		<span class="nx">w</span><span class="p">.</span><span class="nx">gzipWriter</span> <span class="p">=</span> <span class="kc">nil</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Flush implements http.Flusher
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">writerWrapper</span><span class="p">)</span> <span class="nf">Flush</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">FinishWriting</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">flusher</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">OriginWriter</span><span class="p">.(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Flusher</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">flusher</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<p><a href="https://ld246.com/article/1576226084467">经历心得分享：用 Web 框架 Gin 开发 API，但业务返回的 JSON 太大，调研了一圈，最后自己写了个中间件做 gzip 压缩，记录下调研和开发调优时的心得</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/gzip/">gzip</a></li>
      <li><a href="/tags/gin/">Gin</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
