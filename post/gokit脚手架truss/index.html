<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>GoKit脚手架:truss - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="Forz" /><meta name="description" content="我们使用Go-kit 代码生成工具 truss, 通过truss你可以快速编写Go-kit中繁杂的代码, 并生成支持http和grpc两种调用方式的服务 truss 目前" /><meta name="keywords"
  content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.68.1 with theme even" />


<link rel="canonical" href="/post/gokit%E8%84%9A%E6%89%8B%E6%9E%B6truss/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="stylesheet" href="/css/search.css" />


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="GoKit脚手架:truss" />
<meta property="og:description" content="我们使用Go-kit 代码生成工具 truss, 通过truss你可以快速编写Go-kit中繁杂的代码, 并生成支持http和grpc两种调用方式的服务 truss 目前" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/gokit%E8%84%9A%E6%89%8B%E6%9E%B6truss/" />
<meta property="article:published_time" content="2020-04-09T17:16:58+00:00" />
<meta property="article:modified_time" content="2020-04-09T17:16:58+00:00" />
<meta itemprop="name" content="GoKit脚手架:truss">
<meta itemprop="description" content="我们使用Go-kit 代码生成工具 truss, 通过truss你可以快速编写Go-kit中繁杂的代码, 并生成支持http和grpc两种调用方式的服务 truss 目前">
<meta itemprop="datePublished" content="2020-04-09T17:16:58&#43;00:00" />
<meta itemprop="dateModified" content="2020-04-09T17:16:58&#43;00:00" />
<meta itemprop="wordCount" content="8087">



<meta itemprop="keywords" content="Gokit,truss," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GoKit脚手架:truss"/>
<meta name="twitter:description" content="我们使用Go-kit 代码生成工具 truss, 通过truss你可以快速编写Go-kit中繁杂的代码, 并生成支持http和grpc两种调用方式的服务 truss 目前"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="clearfix">
  <div class="logo-wrapper">
    <a href="/" class="logo">Forz Blog</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
    </ul>
  </nav>
</div>


<div class="search-container">
  <div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..."
        name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path
            d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>
<script>
    var client = algoliasearch("IAR2EF5L65", "b4b9da2eba53aa6dabe4b8ac9e8676e1");
    var index = client.initIndex('forz.forzvina.com');
    autocomplete('#aa-search-input',
        { hint: false }, {
        source: autocomplete.sources.hits(index, { hitsPerPage: 8 }),
        displayKey: 'name',
        templates: {
            suggestion: function (suggestion) {
                var reg = /([A-Z]+)/ig
                var title = suggestion.uri.replace(reg, function (m) {
                    return m.toLowerCase()
                })
                return '<span class="search-item">' + '<a href="\/' + title + '">' +
                    suggestion._highlightResult.title.value + '</a></span>';
            }
        }
    });
</script>
</div>


    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">GoKit脚手架:truss</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-04-09 </span>
        <div class="post-category">
            <a href="/categories/gokit/"> GoKit </a>
            </div>
          <span class="more-meta"> 约 8087 字 </span>
          <span class="more-meta"> 预计阅读 17 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#endpoint">endpoint</a></li>
    <li><a href="#transport">transport</a></li>
    <li><a href="#server">server</a></li>
    <li><a href="#client">client</a></li>
    <li><a href="#handlers">handlers</a></li>
    <li><a href="#main">main</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>我们使用Go-kit 代码生成工具 truss, 通过truss你可以快速编写Go-kit中繁杂的代码, 并生成支持http和grpc两种调用方式的服务</p>
<p>truss 目前支持grpc,http, 它通过.proto文件定义你的服务</p>
<h1 id="使用">使用</h1>
<p>1.安装truss</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh">go get -u -d github.com/metaverse/truss
<span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/metaverse/truss
make dependencies
make
</code></pre></td></tr></table>
</div>
</div><p>2.编写echo.proto文件定义服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-protobuf" data-lang="protobuf"><span class="c1">// In general, while you can use proto2 (the current default protocol buffers
</span><span class="c1">// version), we recommend that you use proto3 with gRPC as it lets you use the
</span><span class="c1">// full range of gRPC-supported languages, as well as avoiding compatibility
</span><span class="c1">// issues with proto2 clients talking to proto3 servers and vice versa.
</span><span class="c1"></span><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="c1">// The package name determines the name of the directories that truss creates
</span><span class="c1">// for `package echo;` truss will create the directory &#34;echo-service&#34;.
</span><span class="c1"></span><span class="kn">package</span> <span class="nn">echo</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="k">import</span> <span class="s">&#34;github.com/metaverse/truss/deftree/googlethirdparty/annotations.proto&#34;</span><span class="p">;</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">service</span> <span class="n">Echo</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="c1">// Echo &#34;echos&#34; the incoming string
</span><span class="c1"></span>  <span class="k">rpc</span> <span class="n">Echo</span> <span class="p">(</span><span class="n">EchoRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">EchoResponse</span><span class="p">)</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>      <span class="c1">// All fields (In) are query parameters of the http request unless otherwise specified
</span><span class="c1"></span>      <span class="n">get</span><span class="o">:</span> <span class="s">&#34;/echo&#34;</span><span class="err">
</span><span class="err">
</span><span class="err"></span>      <span class="n">additional_bindings</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>        <span class="c1">// Trailing slashes are different routes
</span><span class="c1"></span>        <span class="n">get</span><span class="o">:</span> <span class="s">&#34;/echo/&#34;</span><span class="err">
</span><span class="err"></span>      <span class="p">}</span><span class="err">
</span><span class="err"></span>    <span class="p">};</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="c1">// Louder &#34;echos&#34; the incoming string with `Loudness` additional exclamation marks
</span><span class="c1"></span>  <span class="k">rpc</span> <span class="n">Louder</span> <span class="p">(</span><span class="n">LouderRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">EchoResponse</span><span class="p">)</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>      <span class="n">custom</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>        <span class="n">kind</span><span class="o">:</span> <span class="s">&#34;HEAD&#34;</span><span class="err">
</span><span class="err"></span>        <span class="c1">// Loudness is accepted in the http path
</span><span class="c1"></span>        <span class="n">path</span><span class="o">:</span> <span class="s">&#34;/louder/{Loudness}&#34;</span><span class="err">
</span><span class="err"></span>      <span class="p">}</span><span class="err">
</span><span class="err"></span>      <span class="n">additional_bindings</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>        <span class="n">post</span><span class="o">:</span> <span class="s">&#34;/louder/{Loudness}&#34;</span><span class="err">
</span><span class="err"></span>        <span class="c1">// All other fields (In) are located in the body of the http/json request
</span><span class="c1"></span>        <span class="n">body</span><span class="o">:</span> <span class="s">&#34;*&#34;</span><span class="err">
</span><span class="err"></span>      <span class="p">}</span><span class="err">
</span><span class="err"></span>    <span class="p">};</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span>  <span class="c1">// LouderGet is the same as Louder, but pulls fields other than Loudness (i.e. In) from query params instead of POST
</span><span class="c1"></span>  <span class="k">rpc</span> <span class="n">LouderGet</span> <span class="p">(</span><span class="n">LouderRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">EchoResponse</span><span class="p">)</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>    <span class="k">option</span> <span class="p">(</span><span class="n">google.api.http</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>      <span class="c1">// Loudness is accepted in the http path
</span><span class="c1"></span>      <span class="n">get</span><span class="o">:</span> <span class="s">&#34;/louder/{Loudness}&#34;</span><span class="err">
</span><span class="err"></span>    <span class="p">};</span><span class="err">
</span><span class="err"></span>  <span class="p">}</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">EchoRequest</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">In</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">LouderRequest</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="c1">// In is the string to echo back
</span><span class="c1"></span>  <span class="kt">string</span> <span class="n">In</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span>  <span class="c1">// Loudness is the number of exclamations marks to add to the echoed string
</span><span class="c1"></span>  <span class="kt">int32</span> <span class="n">Loudness</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span><span class="err">
</span><span class="err"></span><span class="kd">message</span> <span class="nc">EchoResponse</span> <span class="p">{</span><span class="err">
</span><span class="err"></span>  <span class="kt">string</span> <span class="n">Out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span><span class="err">
</span><span class="err"></span><span class="p">}</span><span class="err">
</span></code></pre></td></tr></table>
</div>
</div><p>3.执行truss命令<code>truss echo.proto</code> , 生成服务, 生成出来的代码目录结构如下图:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">├── echo-service
│   ├── cmd
│   │   └── echo
│   │       └── main.go
│   ├── handlers
│   │   ├── handlers.go
│   │   ├── hooks.go
│   │   └── middlewares.go
│   └── svc
│       ├── client
│       │   ├── grpc
│       │   │   └── client.go
│       │   └── http
│       │       └── client.go
│       ├── endpoints.go
│       ├── server
│       │   └── run.go
│       ├── transport_grpc.go
│       └── transport_http.go
├── echo.pb.go
├── echo.proto
├── go.mod
└── go.sum

</code></pre></td></tr></table>
</div>
</div><ul>
<li>svc 包含服务通信所需的接线和编码协议（生成的代码）</li>
<li>handlers/handlers.go 用endpoint填充，您将在其中添加业务逻辑</li>
<li>cmd/echo/ 包含服务主体，您将很快构建并运行该服务</li>
<li>echo.pb.go包含RPC接口定义和支持结构，这些定义已从echo.proto转换为golang</li>
</ul>
<p>您仅可以安全地修改handlers中的文件。下次使用truss重新生成服务时，对其他文件的更改将丢失。</p>
<p>4.在handlers中注入你所需要的中间件, 如日志, 服务发现, 负载均衡, Metrics, 限流器, 断路器等</p>
<p>5.在handlers/handlers.go文件中实现服务的业务逻辑</p>
<p>6.Run Your Service , 你已经同时实现了grpc和http的接口,如果需要的话, 还可以使用grpc生态中的grpc-gateway生成swagger</p>
<p>注意:</p>
<ol>
<li>
<p>仅修改handlers中的文件。用户逻辑可以在handlers中导入并执行。也可以当做unexported helper函数添加到handlers文件中。</p>
</li>
<li>
<p>Truss要求handlers/handlers.go文件中的函数必须符合*.proto文件中定义的rpc接口。下次重新运行truss时，将删除所有其他的函数。</p>
</li>
<li>
<p>请勿在NAME-service中创建文件或目录。所有用户逻辑必须存在于NAME-service外部，从而将逻辑的组织权交给用户。</p>
</li>
</ol>
<h1 id="生成代码解析">生成代码解析</h1>
<h2 id="endpoint">endpoint</h2>
<p>svc/endpoint.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by truss. DO NOT EDIT.
</span><span class="c1">// Rerunning truss will overwrite this file.
</span><span class="c1">// Version: 8907ffca23
</span><span class="c1">// Version Date: 2019年11月27日 星期三 21时28分21秒 UTC
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">svc</span>

<span class="c1">// This file contains methods to make individual endpoints from services,
</span><span class="c1">// request and response types to serve those endpoints, as well as encoders and
</span><span class="c1">// decoders for those types, for all of our supported transport serialization
</span><span class="c1">// formats.
</span><span class="c1"></span>
<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>

	<span class="s">&#34;github.com/go-kit/kit/endpoint&#34;</span>

	<span class="nx">pb</span> <span class="s">&#34;test&#34;</span>
<span class="p">)</span>

<span class="c1">// Endpoints collects all of the endpoints that compose an add service. It&#39;s
</span><span class="c1">// meant to be used as a helper struct, to collect all of the endpoints into a
</span><span class="c1">// single parameter.
</span><span class="c1">//
</span><span class="c1">// In a server, it&#39;s useful for functions that need to operate on a per-endpoint
</span><span class="c1">// basis. For example, you might pass an Endpoints to a function that produces
</span><span class="c1">// an http.Handler, with each method (endpoint) wired up to a specific path. (It
</span><span class="c1">// is probably a mistake in design to invoke the Service methods on the
</span><span class="c1">// Endpoints struct in a server.)
</span><span class="c1">//
</span><span class="c1">// In a client, it&#39;s useful to collect individually constructed endpoints into a
</span><span class="c1">// single type that implements the Service interface. For example, you might
</span><span class="c1">// construct individual endpoints using transport/http.NewClient, combine them into an Endpoints, and return it to the caller as a Service.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Endpoints</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">EchoEndpoint</span>      <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
	<span class="nx">LouderEndpoint</span>    <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
	<span class="nx">LouderGetEndpoint</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
<span class="p">}</span>

<span class="c1">// Endpoints
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">Endpoints</span><span class="p">)</span> <span class="nf">Echo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">EchoEndpoint</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">response</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">Endpoints</span><span class="p">)</span> <span class="nf">Louder</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">LouderEndpoint</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">response</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="nx">Endpoints</span><span class="p">)</span> <span class="nf">LouderGet</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">LouderGetEndpoint</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">response</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Make Endpoints
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">MakeEchoEndpoint</span><span class="p">(</span><span class="nx">s</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span><span class="p">)</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">response</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span><span class="p">)</span>
		<span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Echo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">MakeLouderEndpoint</span><span class="p">(</span><span class="nx">s</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span><span class="p">)</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">response</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
		<span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Louder</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">MakeLouderGetEndpoint</span><span class="p">(</span><span class="nx">s</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span><span class="p">)</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">response</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
		<span class="nx">v</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">LouderGet</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">v</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// WrapAllExcept wraps each Endpoint field of struct Endpoints with a
</span><span class="c1">// go-kit/kit/endpoint.Middleware.
</span><span class="c1">// Use this for applying a set of middlewares to every endpoint in the service.
</span><span class="c1">// Optionally, endpoints can be passed in by name to be excluded from being wrapped.
</span><span class="c1">// WrapAllExcept(middleware, &#34;Status&#34;, &#34;Ping&#34;)
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Endpoints</span><span class="p">)</span> <span class="nf">WrapAllExcept</span><span class="p">(</span><span class="nx">middleware</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Middleware</span><span class="p">,</span> <span class="nx">excluded</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">included</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}{</span>
		<span class="s">&#34;Echo&#34;</span><span class="p">:</span>      <span class="kd">struct</span><span class="p">{}{},</span>
		<span class="s">&#34;Louder&#34;</span><span class="p">:</span>    <span class="kd">struct</span><span class="p">{}{},</span>
		<span class="s">&#34;LouderGet&#34;</span><span class="p">:</span> <span class="kd">struct</span><span class="p">{}{},</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ex</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">excluded</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">included</span><span class="p">[</span><span class="nx">ex</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Excluded endpoint &#39;%s&#39; does not exist; see middlewares/endpoints.go&#34;</span><span class="p">,</span> <span class="nx">ex</span><span class="p">))</span>
		<span class="p">}</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">included</span><span class="p">,</span> <span class="nx">ex</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">inc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">included</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">inc</span> <span class="o">==</span> <span class="s">&#34;Echo&#34;</span> <span class="p">{</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">EchoEndpoint</span> <span class="p">=</span> <span class="nf">middleware</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">EchoEndpoint</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">inc</span> <span class="o">==</span> <span class="s">&#34;Louder&#34;</span> <span class="p">{</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">LouderEndpoint</span> <span class="p">=</span> <span class="nf">middleware</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">LouderEndpoint</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">inc</span> <span class="o">==</span> <span class="s">&#34;LouderGet&#34;</span> <span class="p">{</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">LouderGetEndpoint</span> <span class="p">=</span> <span class="nf">middleware</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">LouderGetEndpoint</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// LabeledMiddleware will get passed the endpoint name when passed to
</span><span class="c1">// WrapAllLabeledExcept, this can be used to write a generic metrics
</span><span class="c1">// middleware which can send the endpoint name to the metrics collector.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">LabeledMiddleware</span> <span class="kd">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">)</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>

<span class="c1">// WrapAllLabeledExcept wraps each Endpoint field of struct Endpoints with a
</span><span class="c1">// LabeledMiddleware, which will receive the name of the endpoint. See
</span><span class="c1">// LabeldMiddleware. See method WrapAllExept for details on excluded
</span><span class="c1">// functionality.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Endpoints</span><span class="p">)</span> <span class="nf">WrapAllLabeledExcept</span><span class="p">(</span><span class="nx">middleware</span> <span class="kd">func</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">)</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">,</span> <span class="nx">excluded</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">included</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{}{</span>
		<span class="s">&#34;Echo&#34;</span><span class="p">:</span>      <span class="kd">struct</span><span class="p">{}{},</span>
		<span class="s">&#34;Louder&#34;</span><span class="p">:</span>    <span class="kd">struct</span><span class="p">{}{},</span>
		<span class="s">&#34;LouderGet&#34;</span><span class="p">:</span> <span class="kd">struct</span><span class="p">{}{},</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ex</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">excluded</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">included</span><span class="p">[</span><span class="nx">ex</span><span class="p">];</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Excluded endpoint &#39;%s&#39; does not exist; see middlewares/endpoints.go&#34;</span><span class="p">,</span> <span class="nx">ex</span><span class="p">))</span>
		<span class="p">}</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">included</span><span class="p">,</span> <span class="nx">ex</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">inc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">included</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">inc</span> <span class="o">==</span> <span class="s">&#34;Echo&#34;</span> <span class="p">{</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">EchoEndpoint</span> <span class="p">=</span> <span class="nf">middleware</span><span class="p">(</span><span class="s">&#34;Echo&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">EchoEndpoint</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">inc</span> <span class="o">==</span> <span class="s">&#34;Louder&#34;</span> <span class="p">{</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">LouderEndpoint</span> <span class="p">=</span> <span class="nf">middleware</span><span class="p">(</span><span class="s">&#34;Louder&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">LouderEndpoint</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">inc</span> <span class="o">==</span> <span class="s">&#34;LouderGet&#34;</span> <span class="p">{</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">LouderGetEndpoint</span> <span class="p">=</span> <span class="nf">middleware</span><span class="p">(</span><span class="s">&#34;LouderGet&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">LouderGetEndpoint</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="transport">transport</h2>
<p>svc/transport_grpc.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by truss. DO NOT EDIT.
</span><span class="c1">// Rerunning truss will overwrite this file.
</span><span class="c1">// Version: 8907ffca23
</span><span class="c1">// Version Date: 2019年11月27日 星期三 21时28分21秒 UTC
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">svc</span>

<span class="c1">// This file provides server-side bindings for the gRPC transport.
</span><span class="c1">// It utilizes the transport/grpc.Server.
</span><span class="c1"></span>
<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;net/http&#34;</span>

	<span class="s">&#34;google.golang.org/grpc/metadata&#34;</span>

	<span class="nx">grpctransport</span> <span class="s">&#34;github.com/go-kit/kit/transport/grpc&#34;</span>

	<span class="c1">// This Service
</span><span class="c1"></span>	<span class="nx">pb</span> <span class="s">&#34;test&#34;</span>
<span class="p">)</span>

<span class="c1">// MakeGRPCServer makes a set of endpoints available as a gRPC EchoServer.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">MakeGRPCServer</span><span class="p">(</span><span class="nx">endpoints</span> <span class="nx">Endpoints</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="nx">grpctransport</span><span class="p">.</span><span class="nx">ServerOption</span><span class="p">)</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span> <span class="p">{</span>
	<span class="nx">serverOptions</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">grpctransport</span><span class="p">.</span><span class="nx">ServerOption</span><span class="p">{</span>
		<span class="nx">grpctransport</span><span class="p">.</span><span class="nf">ServerBefore</span><span class="p">(</span><span class="nx">metadataToContext</span><span class="p">),</span>
	<span class="p">}</span>
	<span class="nx">serverOptions</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">serverOptions</span><span class="p">,</span> <span class="nx">options</span><span class="o">...</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">grpcServer</span><span class="p">{</span>
		<span class="c1">// echo
</span><span class="c1"></span>
		<span class="nx">echo</span><span class="p">:</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
			<span class="nx">endpoints</span><span class="p">.</span><span class="nx">EchoEndpoint</span><span class="p">,</span>
			<span class="nx">DecodeGRPCEchoRequest</span><span class="p">,</span>
			<span class="nx">EncodeGRPCEchoResponse</span><span class="p">,</span>
			<span class="nx">serverOptions</span><span class="o">...</span><span class="p">,</span>
		<span class="p">),</span>
		<span class="nx">louder</span><span class="p">:</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
			<span class="nx">endpoints</span><span class="p">.</span><span class="nx">LouderEndpoint</span><span class="p">,</span>
			<span class="nx">DecodeGRPCLouderRequest</span><span class="p">,</span>
			<span class="nx">EncodeGRPCLouderResponse</span><span class="p">,</span>
			<span class="nx">serverOptions</span><span class="o">...</span><span class="p">,</span>
		<span class="p">),</span>
		<span class="nx">louderget</span><span class="p">:</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
			<span class="nx">endpoints</span><span class="p">.</span><span class="nx">LouderGetEndpoint</span><span class="p">,</span>
			<span class="nx">DecodeGRPCLouderGetRequest</span><span class="p">,</span>
			<span class="nx">EncodeGRPCLouderGetResponse</span><span class="p">,</span>
			<span class="nx">serverOptions</span><span class="o">...</span><span class="p">,</span>
		<span class="p">),</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// grpcServer implements the EchoServer interface
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">grpcServer</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">echo</span>      <span class="nx">grpctransport</span><span class="p">.</span><span class="nx">Handler</span>
	<span class="nx">louder</span>    <span class="nx">grpctransport</span><span class="p">.</span><span class="nx">Handler</span>
	<span class="nx">louderget</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nx">Handler</span>
<span class="p">}</span>

<span class="c1">// Methods for grpcServer to implement EchoServer interface
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">grpcServer</span><span class="p">)</span> <span class="nf">Echo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">rep</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">echo</span><span class="p">.</span><span class="nf">ServeGRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">rep</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">grpcServer</span><span class="p">)</span> <span class="nf">Louder</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">rep</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">louder</span><span class="p">.</span><span class="nf">ServeGRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">rep</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">grpcServer</span><span class="p">)</span> <span class="nf">LouderGet</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">rep</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">louderget</span><span class="p">.</span><span class="nf">ServeGRPC</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">rep</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Server Decode
</span><span class="c1"></span>
<span class="c1">// DecodeGRPCEchoRequest is a transport/grpc.DecodeRequestFunc that converts a
</span><span class="c1">// gRPC echo request to a user-domain echo request. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeGRPCEchoRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">grpcReq</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">grpcReq</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// DecodeGRPCLouderRequest is a transport/grpc.DecodeRequestFunc that converts a
</span><span class="c1">// gRPC louder request to a user-domain louder request. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeGRPCLouderRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">grpcReq</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">grpcReq</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// DecodeGRPCLouderGetRequest is a transport/grpc.DecodeRequestFunc that converts a
</span><span class="c1">// gRPC louderget request to a user-domain louderget request. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeGRPCLouderGetRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">grpcReq</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">grpcReq</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Server Encode
</span><span class="c1"></span>
<span class="c1">// EncodeGRPCEchoResponse is a transport/grpc.EncodeResponseFunc that converts a
</span><span class="c1">// user-domain echo response to a gRPC echo reply. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeGRPCEchoResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">response</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">resp</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// EncodeGRPCLouderResponse is a transport/grpc.EncodeResponseFunc that converts a
</span><span class="c1">// user-domain louder response to a gRPC louder reply. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeGRPCLouderResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">response</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">resp</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// EncodeGRPCLouderGetResponse is a transport/grpc.EncodeResponseFunc that converts a
</span><span class="c1">// user-domain louderget response to a gRPC louderget reply. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeGRPCLouderGetResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">response</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">resp</span> <span class="o">:=</span> <span class="nx">response</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Helpers
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">metadataToContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">md</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">MD</span><span class="p">)</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">md</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">v</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// The key is added both in metadata format (k) which is all lower
</span><span class="c1"></span>			<span class="c1">// and the http.CanonicalHeaderKey of the key so that it can be
</span><span class="c1"></span>			<span class="c1">// accessed in either format
</span><span class="c1"></span>			<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">CanonicalHeaderKey</span><span class="p">(</span><span class="nx">k</span><span class="p">),</span> <span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">ctx</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>svc/transport_http.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by truss. DO NOT EDIT.
</span><span class="c1">// Rerunning truss will overwrite this file.
</span><span class="c1">// Version: 8907ffca23
</span><span class="c1">// Version Date: 2019年11月27日 星期三 21时28分21秒 UTC
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">svc</span>

<span class="c1">// This file provides server-side bindings for the HTTP transport.
</span><span class="c1">// It utilizes the transport/http.Server.
</span><span class="c1"></span>
<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;bytes&#34;</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io&#34;</span>
	<span class="s">&#34;io/ioutil&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;strconv&#34;</span>
	<span class="s">&#34;strings&#34;</span>

	<span class="s">&#34;github.com/gogo/protobuf/jsonpb&#34;</span>
	<span class="s">&#34;github.com/gogo/protobuf/proto&#34;</span>

	<span class="s">&#34;context&#34;</span>

	<span class="nx">httptransport</span> <span class="s">&#34;github.com/go-kit/kit/transport/http&#34;</span>
	<span class="s">&#34;github.com/gorilla/mux&#34;</span>
	<span class="s">&#34;github.com/pkg/errors&#34;</span>

	<span class="c1">// This service
</span><span class="c1"></span>	<span class="nx">pb</span> <span class="s">&#34;test&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">contentType</span> <span class="p">=</span> <span class="s">&#34;application/json; charset=utf-8&#34;</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Compare</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">Atoi</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nx">NewServer</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">NopCloser</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">NewEchoClient</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Copy</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nx">Wrap</span>
<span class="p">)</span>

<span class="c1">// MakeHTTPHandler returns a handler that makes a set of endpoints available
</span><span class="c1">// on predefined paths.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">MakeHTTPHandler</span><span class="p">(</span><span class="nx">endpoints</span> <span class="nx">Endpoints</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="nx">httptransport</span><span class="p">.</span><span class="nx">ServerOption</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
	<span class="nx">serverOptions</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">httptransport</span><span class="p">.</span><span class="nx">ServerOption</span><span class="p">{</span>
		<span class="nx">httptransport</span><span class="p">.</span><span class="nf">ServerBefore</span><span class="p">(</span><span class="nx">headersToContext</span><span class="p">),</span>
		<span class="nx">httptransport</span><span class="p">.</span><span class="nf">ServerErrorEncoder</span><span class="p">(</span><span class="nx">errorEncoder</span><span class="p">),</span>
		<span class="nx">httptransport</span><span class="p">.</span><span class="nf">ServerAfter</span><span class="p">(</span><span class="nx">httptransport</span><span class="p">.</span><span class="nf">SetContentType</span><span class="p">(</span><span class="nx">contentType</span><span class="p">)),</span>
	<span class="p">}</span>
	<span class="nx">serverOptions</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">serverOptions</span><span class="p">,</span> <span class="nx">options</span><span class="o">...</span><span class="p">)</span>
	<span class="nx">m</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">NewRouter</span><span class="p">()</span>

	<span class="nx">m</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/echo/&#34;</span><span class="p">).</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">httptransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
		<span class="nx">endpoints</span><span class="p">.</span><span class="nx">EchoEndpoint</span><span class="p">,</span>
		<span class="nx">DecodeHTTPEchoZeroRequest</span><span class="p">,</span>
		<span class="nx">EncodeHTTPGenericResponse</span><span class="p">,</span>
		<span class="nx">serverOptions</span><span class="o">...</span><span class="p">,</span>
	<span class="p">))</span>
	<span class="nx">m</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/echo&#34;</span><span class="p">).</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">httptransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
		<span class="nx">endpoints</span><span class="p">.</span><span class="nx">EchoEndpoint</span><span class="p">,</span>
		<span class="nx">DecodeHTTPEchoOneRequest</span><span class="p">,</span>
		<span class="nx">EncodeHTTPGenericResponse</span><span class="p">,</span>
		<span class="nx">serverOptions</span><span class="o">...</span><span class="p">,</span>
	<span class="p">))</span>

	<span class="nx">m</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="s">&#34;POST&#34;</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/louder/{Loudness}&#34;</span><span class="p">).</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">httptransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
		<span class="nx">endpoints</span><span class="p">.</span><span class="nx">LouderEndpoint</span><span class="p">,</span>
		<span class="nx">DecodeHTTPLouderZeroRequest</span><span class="p">,</span>
		<span class="nx">EncodeHTTPGenericResponse</span><span class="p">,</span>
		<span class="nx">serverOptions</span><span class="o">...</span><span class="p">,</span>
	<span class="p">))</span>
	<span class="nx">m</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="s">&#34;HEAD&#34;</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/louder/{Loudness}&#34;</span><span class="p">).</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">httptransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
		<span class="nx">endpoints</span><span class="p">.</span><span class="nx">LouderEndpoint</span><span class="p">,</span>
		<span class="nx">DecodeHTTPLouderOneRequest</span><span class="p">,</span>
		<span class="nx">EncodeHTTPGenericResponse</span><span class="p">,</span>
		<span class="nx">serverOptions</span><span class="o">...</span><span class="p">,</span>
	<span class="p">))</span>

	<span class="nx">m</span><span class="p">.</span><span class="nf">Methods</span><span class="p">(</span><span class="s">&#34;GET&#34;</span><span class="p">).</span><span class="nf">Path</span><span class="p">(</span><span class="s">&#34;/louder/{Loudness}&#34;</span><span class="p">).</span><span class="nf">Handler</span><span class="p">(</span><span class="nx">httptransport</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span>
		<span class="nx">endpoints</span><span class="p">.</span><span class="nx">LouderGetEndpoint</span><span class="p">,</span>
		<span class="nx">DecodeHTTPLouderGetZeroRequest</span><span class="p">,</span>
		<span class="nx">EncodeHTTPGenericResponse</span><span class="p">,</span>
		<span class="nx">serverOptions</span><span class="o">...</span><span class="p">,</span>
	<span class="p">))</span>
	<span class="k">return</span> <span class="nx">m</span>
<span class="p">}</span>

<span class="c1">// ErrorEncoder writes the error to the ResponseWriter, by default a content
</span><span class="c1">// type of application/json, a body of json with key &#34;error&#34; and the value
</span><span class="c1">// error.Error(), and a status code of 500. If the error implements Headerer,
</span><span class="c1">// the provided headers will be applied to the response. If the error
</span><span class="c1">// implements json.Marshaler, and the marshaling succeeds, the JSON encoded
</span><span class="c1">// form of the error will be used. If the error implements StatusCoder, the
</span><span class="c1">// provided StatusCode will be used instead of 500.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">errorEncoder</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">,</span> <span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">errorWrapper</span><span class="p">{</span><span class="nx">Error</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()})</span>
	<span class="k">if</span> <span class="nx">marshaler</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshaler</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">jsonBody</span><span class="p">,</span> <span class="nx">marshalErr</span> <span class="o">:=</span> <span class="nx">marshaler</span><span class="p">.</span><span class="nf">MarshalJSON</span><span class="p">();</span> <span class="nx">marshalErr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">body</span> <span class="p">=</span> <span class="nx">jsonBody</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="nx">contentType</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">headerer</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">httptransport</span><span class="p">.</span><span class="nx">Headerer</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">headerer</span><span class="p">.</span><span class="nf">Headers</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">headerer</span><span class="p">.</span><span class="nf">Headers</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">code</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span>
	<span class="k">if</span> <span class="nx">sc</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">err</span><span class="p">.(</span><span class="nx">httptransport</span><span class="p">.</span><span class="nx">StatusCoder</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">code</span> <span class="p">=</span> <span class="nx">sc</span><span class="p">.</span><span class="nf">StatusCode</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
	<span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">errorWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Error</span> <span class="kt">string</span> <span class="s">`json:&#34;error&#34;`</span>
<span class="p">}</span>

<span class="c1">// httpError satisfies the Headerer and StatusCoder interfaces in
</span><span class="c1">// package github.com/go-kit/kit/transport/http.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">httpError</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="kt">error</span>
	<span class="nx">statusCode</span> <span class="kt">int</span>
	<span class="nx">headers</span>    <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">httpError</span><span class="p">)</span> <span class="nf">StatusCode</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">statusCode</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">httpError</span><span class="p">)</span> <span class="nf">Headers</span><span class="p">()</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">h</span><span class="p">.</span><span class="nx">headers</span>
<span class="p">}</span>

<span class="c1">// Server Decode
</span><span class="c1"></span>
<span class="c1">// DecodeHTTPEchoZeroRequest is a transport/http.DecodeRequestFunc that
</span><span class="c1">// decodes a JSON-encoded echo request from the HTTP request
</span><span class="c1">// body. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeHTTPEchoZeroRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span>
	<span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot read body of http request&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// AllowUnknownFields stops the unmarshaler from failing if the JSON contains unknown fields.
</span><span class="c1"></span>		<span class="nx">unmarshaller</span> <span class="o">:=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nx">Unmarshaler</span><span class="p">{</span>
			<span class="nx">AllowUnknownFields</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">unmarshaller</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">8196</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">size</span> <span class="p">{</span>
				<span class="nx">buf</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">httpError</span><span class="p">{</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;request body &#39;%s&#39;: cannot parse non-json request body&#34;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">),</span>
				<span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span>
				<span class="kc">nil</span><span class="p">,</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">pathParams</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">Vars</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">pathParams</span>

	<span class="nx">queryParams</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">queryParams</span>

	<span class="k">if</span> <span class="nx">InEchoStrArr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">queryParams</span><span class="p">[</span><span class="s">&#34;In&#34;</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">InEchoStr</span> <span class="o">:=</span> <span class="nx">InEchoStrArr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nx">InEcho</span> <span class="o">:=</span> <span class="nx">InEchoStr</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">In</span> <span class="p">=</span> <span class="nx">InEcho</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// DecodeHTTPEchoOneRequest is a transport/http.DecodeRequestFunc that
</span><span class="c1">// decodes a JSON-encoded echo request from the HTTP request
</span><span class="c1">// body. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeHTTPEchoOneRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span>
	<span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot read body of http request&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// AllowUnknownFields stops the unmarshaler from failing if the JSON contains unknown fields.
</span><span class="c1"></span>		<span class="nx">unmarshaller</span> <span class="o">:=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nx">Unmarshaler</span><span class="p">{</span>
			<span class="nx">AllowUnknownFields</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">unmarshaller</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">8196</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">size</span> <span class="p">{</span>
				<span class="nx">buf</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">httpError</span><span class="p">{</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;request body &#39;%s&#39;: cannot parse non-json request body&#34;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">),</span>
				<span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span>
				<span class="kc">nil</span><span class="p">,</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">pathParams</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">Vars</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">pathParams</span>

	<span class="nx">queryParams</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">queryParams</span>

	<span class="k">if</span> <span class="nx">InEchoStrArr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">queryParams</span><span class="p">[</span><span class="s">&#34;In&#34;</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">InEchoStr</span> <span class="o">:=</span> <span class="nx">InEchoStrArr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nx">InEcho</span> <span class="o">:=</span> <span class="nx">InEchoStr</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">In</span> <span class="p">=</span> <span class="nx">InEcho</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// DecodeHTTPLouderZeroRequest is a transport/http.DecodeRequestFunc that
</span><span class="c1">// decodes a JSON-encoded louder request from the HTTP request
</span><span class="c1">// body. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeHTTPLouderZeroRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span>
	<span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot read body of http request&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// AllowUnknownFields stops the unmarshaler from failing if the JSON contains unknown fields.
</span><span class="c1"></span>		<span class="nx">unmarshaller</span> <span class="o">:=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nx">Unmarshaler</span><span class="p">{</span>
			<span class="nx">AllowUnknownFields</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">unmarshaller</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">8196</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">size</span> <span class="p">{</span>
				<span class="nx">buf</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">httpError</span><span class="p">{</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;request body &#39;%s&#39;: cannot parse non-json request body&#34;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">),</span>
				<span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span>
				<span class="kc">nil</span><span class="p">,</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">pathParams</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">Vars</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">pathParams</span>

	<span class="nx">queryParams</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">queryParams</span>

	<span class="nx">LoudnessLouderStr</span> <span class="o">:=</span> <span class="nx">pathParams</span><span class="p">[</span><span class="s">&#34;Loudness&#34;</span><span class="p">]</span>
	<span class="nx">LoudnessLouder</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">LoudnessLouderStr</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Error while extracting LoudnessLouder from path, pathParams: %v&#34;</span><span class="p">,</span> <span class="nx">pathParams</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">Loudness</span> <span class="p">=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">LoudnessLouder</span><span class="p">)</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// DecodeHTTPLouderOneRequest is a transport/http.DecodeRequestFunc that
</span><span class="c1">// decodes a JSON-encoded louder request from the HTTP request
</span><span class="c1">// body. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeHTTPLouderOneRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span>
	<span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot read body of http request&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// AllowUnknownFields stops the unmarshaler from failing if the JSON contains unknown fields.
</span><span class="c1"></span>		<span class="nx">unmarshaller</span> <span class="o">:=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nx">Unmarshaler</span><span class="p">{</span>
			<span class="nx">AllowUnknownFields</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">unmarshaller</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">8196</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">size</span> <span class="p">{</span>
				<span class="nx">buf</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">httpError</span><span class="p">{</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;request body &#39;%s&#39;: cannot parse non-json request body&#34;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">),</span>
				<span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span>
				<span class="kc">nil</span><span class="p">,</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">pathParams</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">Vars</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">pathParams</span>

	<span class="nx">queryParams</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">queryParams</span>

	<span class="k">if</span> <span class="nx">InLouderStrArr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">queryParams</span><span class="p">[</span><span class="s">&#34;In&#34;</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">InLouderStr</span> <span class="o">:=</span> <span class="nx">InLouderStrArr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nx">InLouder</span> <span class="o">:=</span> <span class="nx">InLouderStr</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">In</span> <span class="p">=</span> <span class="nx">InLouder</span>
	<span class="p">}</span>

	<span class="nx">LoudnessLouderStr</span> <span class="o">:=</span> <span class="nx">pathParams</span><span class="p">[</span><span class="s">&#34;Loudness&#34;</span><span class="p">]</span>
	<span class="nx">LoudnessLouder</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">LoudnessLouderStr</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Error while extracting LoudnessLouder from path, pathParams: %v&#34;</span><span class="p">,</span> <span class="nx">pathParams</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">Loudness</span> <span class="p">=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">LoudnessLouder</span><span class="p">)</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// DecodeHTTPLouderGetZeroRequest is a transport/http.DecodeRequestFunc that
</span><span class="c1">// decodes a JSON-encoded louderget request from the HTTP request
</span><span class="c1">// body. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeHTTPLouderGetZeroRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">req</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span>
	<span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot read body of http request&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// AllowUnknownFields stops the unmarshaler from failing if the JSON contains unknown fields.
</span><span class="c1"></span>		<span class="nx">unmarshaller</span> <span class="o">:=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nx">Unmarshaler</span><span class="p">{</span>
			<span class="nx">AllowUnknownFields</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">unmarshaller</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">8196</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">size</span> <span class="p">{</span>
				<span class="nx">buf</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">httpError</span><span class="p">{</span><span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;request body &#39;%s&#39;: cannot parse non-json request body&#34;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">),</span>
				<span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span>
				<span class="kc">nil</span><span class="p">,</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">pathParams</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nf">Vars</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">pathParams</span>

	<span class="nx">queryParams</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">queryParams</span>

	<span class="k">if</span> <span class="nx">InLouderGetStrArr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">queryParams</span><span class="p">[</span><span class="s">&#34;In&#34;</span><span class="p">];</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">InLouderGetStr</span> <span class="o">:=</span> <span class="nx">InLouderGetStrArr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nx">InLouderGet</span> <span class="o">:=</span> <span class="nx">InLouderGetStr</span>
		<span class="nx">req</span><span class="p">.</span><span class="nx">In</span> <span class="p">=</span> <span class="nx">InLouderGet</span>
	<span class="p">}</span>

	<span class="nx">LoudnessLouderGetStr</span> <span class="o">:=</span> <span class="nx">pathParams</span><span class="p">[</span><span class="s">&#34;Loudness&#34;</span><span class="p">]</span>
	<span class="nx">LoudnessLouderGet</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">LoudnessLouderGetStr</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Error while extracting LoudnessLouderGet from path, pathParams: %v&#34;</span><span class="p">,</span> <span class="nx">pathParams</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="nx">req</span><span class="p">.</span><span class="nx">Loudness</span> <span class="p">=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">LoudnessLouderGet</span><span class="p">)</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">req</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// EncodeHTTPGenericResponse is a transport/http.EncodeResponseFunc that encodes
</span><span class="c1">// the response as JSON to the response writer. Primarily useful in a server.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeHTTPGenericResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">response</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">marshaller</span> <span class="o">:=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nx">Marshaler</span><span class="p">{</span>
		<span class="nx">EmitDefaults</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
		<span class="nx">OrigName</span><span class="p">:</span>     <span class="kc">true</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">marshaller</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">response</span><span class="p">.(</span><span class="nx">proto</span><span class="p">.</span><span class="nx">Message</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Helper functions
</span><span class="c1"></span>
<span class="kd">func</span> <span class="nf">headersToContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Header</span> <span class="p">{</span>
		<span class="c1">// The key is added both in http format (k) which has had
</span><span class="c1"></span>		<span class="c1">// http.CanonicalHeaderKey called on it in transport as well as the
</span><span class="c1"></span>		<span class="c1">// strings.ToLower which is the grpc metadata format of the key so
</span><span class="c1"></span>		<span class="c1">// that it can be accessed in either format
</span><span class="c1"></span>		<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span>
		<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nx">k</span><span class="p">),</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="c1">// Tune specific change.
</span><span class="c1"></span>	<span class="c1">// also add the request url
</span><span class="c1"></span>	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;request-url&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;HTTPJSON&#34;</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">ctx</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="server">server</h2>
<p>svc/server.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by truss. DO NOT EDIT.
</span><span class="c1">// Rerunning truss will overwrite this file.
</span><span class="c1">// Version: 8907ffca23
</span><span class="c1">// Version Date: 2019年11月27日 星期三 21时28分21秒 UTC
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">server</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;flag&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;net/http/pprof&#34;</span>
	<span class="s">&#34;os&#34;</span>

	<span class="c1">// 3d Party
</span><span class="c1"></span>	<span class="s">&#34;google.golang.org/grpc&#34;</span>

	<span class="c1">// This Service
</span><span class="c1"></span>	<span class="nx">pb</span> <span class="s">&#34;test&#34;</span>
	<span class="s">&#34;test/echo-service/handlers&#34;</span>
	<span class="s">&#34;test/echo-service/svc&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">DefaultConfig</span> <span class="nx">Config</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">DefaultConfig</span><span class="p">.</span><span class="nx">DebugAddr</span><span class="p">,</span> <span class="s">&#34;debug.addr&#34;</span><span class="p">,</span> <span class="s">&#34;:5060&#34;</span><span class="p">,</span> <span class="s">&#34;Debug and metrics listen address&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">DefaultConfig</span><span class="p">.</span><span class="nx">HTTPAddr</span><span class="p">,</span> <span class="s">&#34;http.addr&#34;</span><span class="p">,</span> <span class="s">&#34;:5050&#34;</span><span class="p">,</span> <span class="s">&#34;HTTP listen address&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">DefaultConfig</span><span class="p">.</span><span class="nx">GRPCAddr</span><span class="p">,</span> <span class="s">&#34;grpc.addr&#34;</span><span class="p">,</span> <span class="s">&#34;:5040&#34;</span><span class="p">,</span> <span class="s">&#34;gRPC (HTTP) listen address&#34;</span><span class="p">)</span>

	<span class="c1">// Use environment variables, if set. Flags have priority over Env vars.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;DEBUG_ADDR&#34;</span><span class="p">);</span> <span class="nx">addr</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">DefaultConfig</span><span class="p">.</span><span class="nx">DebugAddr</span> <span class="p">=</span> <span class="nx">addr</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PORT&#34;</span><span class="p">);</span> <span class="nx">port</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">DefaultConfig</span><span class="p">.</span><span class="nx">HTTPAddr</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;:%s&#34;</span><span class="p">,</span> <span class="nx">port</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;HTTP_ADDR&#34;</span><span class="p">);</span> <span class="nx">addr</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">DefaultConfig</span><span class="p">.</span><span class="nx">HTTPAddr</span> <span class="p">=</span> <span class="nx">addr</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;GRPC_ADDR&#34;</span><span class="p">);</span> <span class="nx">addr</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">DefaultConfig</span><span class="p">.</span><span class="nx">GRPCAddr</span> <span class="p">=</span> <span class="nx">addr</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Config contains the required fields for running a server
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">HTTPAddr</span>  <span class="kt">string</span>
	<span class="nx">DebugAddr</span> <span class="kt">string</span>
	<span class="nx">GRPCAddr</span>  <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewEndpoints</span><span class="p">()</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Endpoints</span> <span class="p">{</span>
	<span class="c1">// Business domain.
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">service</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span>
	<span class="p">{</span>
		<span class="nx">service</span> <span class="p">=</span> <span class="nx">handlers</span><span class="p">.</span><span class="nf">NewService</span><span class="p">()</span>
		<span class="c1">// Wrap Service with middlewares. See handlers/middlewares.go
</span><span class="c1"></span>		<span class="nx">service</span> <span class="p">=</span> <span class="nx">handlers</span><span class="p">.</span><span class="nf">WrapService</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Endpoint domain.
</span><span class="c1"></span>	<span class="kd">var</span> <span class="p">(</span>
		<span class="nx">echoEndpoint</span>      <span class="p">=</span> <span class="nx">svc</span><span class="p">.</span><span class="nf">MakeEchoEndpoint</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span>
		<span class="nx">louderEndpoint</span>    <span class="p">=</span> <span class="nx">svc</span><span class="p">.</span><span class="nf">MakeLouderEndpoint</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span>
		<span class="nx">loudergetEndpoint</span> <span class="p">=</span> <span class="nx">svc</span><span class="p">.</span><span class="nf">MakeLouderGetEndpoint</span><span class="p">(</span><span class="nx">service</span><span class="p">)</span>
	<span class="p">)</span>

	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Endpoints</span><span class="p">{</span>
		<span class="nx">EchoEndpoint</span><span class="p">:</span>      <span class="nx">echoEndpoint</span><span class="p">,</span>
		<span class="nx">LouderEndpoint</span><span class="p">:</span>    <span class="nx">louderEndpoint</span><span class="p">,</span>
		<span class="nx">LouderGetEndpoint</span><span class="p">:</span> <span class="nx">loudergetEndpoint</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// Wrap selected Endpoints with middlewares. See handlers/middlewares.go
</span><span class="c1"></span>	<span class="nx">endpoints</span> <span class="p">=</span> <span class="nx">handlers</span><span class="p">.</span><span class="nf">WrapEndpoints</span><span class="p">(</span><span class="nx">endpoints</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">endpoints</span>
<span class="p">}</span>

<span class="c1">// Run starts a new http server, gRPC server, and a debug server with the
</span><span class="c1">// passed config and logger
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">cfg</span> <span class="nx">Config</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="nf">NewEndpoints</span><span class="p">()</span>

	<span class="c1">// Mechanical domain.
</span><span class="c1"></span>	<span class="nx">errc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// Interrupt handler.
</span><span class="c1"></span>	<span class="k">go</span> <span class="nx">handlers</span><span class="p">.</span><span class="nf">InterruptHandler</span><span class="p">(</span><span class="nx">errc</span><span class="p">)</span>

	<span class="c1">// Debug listener.
</span><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;debug&#34;</span><span class="p">,</span> <span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">DebugAddr</span><span class="p">)</span>

		<span class="nx">m</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">NewServeMux</span><span class="p">()</span>
		<span class="nx">m</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/debug/pprof/&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">pprof</span><span class="p">.</span><span class="nx">Index</span><span class="p">))</span>
		<span class="nx">m</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/debug/pprof/cmdline&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">pprof</span><span class="p">.</span><span class="nx">Cmdline</span><span class="p">))</span>
		<span class="nx">m</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/debug/pprof/profile&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">pprof</span><span class="p">.</span><span class="nx">Profile</span><span class="p">))</span>
		<span class="nx">m</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/debug/pprof/symbol&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">pprof</span><span class="p">.</span><span class="nx">Symbol</span><span class="p">))</span>
		<span class="nx">m</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/debug/pprof/trace&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">pprof</span><span class="p">.</span><span class="nx">Trace</span><span class="p">))</span>

		<span class="nx">errc</span> <span class="o">&lt;-</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DebugAddr</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span>
	<span class="p">}()</span>

	<span class="c1">// HTTP transport.
</span><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;HTTP&#34;</span><span class="p">,</span> <span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">HTTPAddr</span><span class="p">)</span>
		<span class="nx">h</span> <span class="o">:=</span> <span class="nx">svc</span><span class="p">.</span><span class="nf">MakeHTTPHandler</span><span class="p">(</span><span class="nx">endpoints</span><span class="p">)</span>
		<span class="nx">errc</span> <span class="o">&lt;-</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">HTTPAddr</span><span class="p">,</span> <span class="nx">h</span><span class="p">)</span>
	<span class="p">}()</span>

	<span class="c1">// gRPC transport.
</span><span class="c1"></span>	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;gRPC&#34;</span><span class="p">,</span> <span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">GRPCAddr</span><span class="p">)</span>
		<span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">GRPCAddr</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">errc</span> <span class="o">&lt;-</span> <span class="nx">err</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="nx">srv</span> <span class="o">:=</span> <span class="nx">svc</span><span class="p">.</span><span class="nf">MakeGRPCServer</span><span class="p">(</span><span class="nx">endpoints</span><span class="p">)</span>
		<span class="nx">s</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">()</span>
		<span class="nx">pb</span><span class="p">.</span><span class="nf">RegisterEchoServer</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">srv</span><span class="p">)</span>

		<span class="nx">errc</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">ln</span><span class="p">)</span>
	<span class="p">}()</span>

	<span class="c1">// Run!
</span><span class="c1"></span>	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;exit&#34;</span><span class="p">,</span> <span class="o">&lt;-</span><span class="nx">errc</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="client">client</h2>
<p>svc/client/grpc:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by truss. DO NOT EDIT.
</span><span class="c1">// Rerunning truss will overwrite this file.
</span><span class="c1">// Version: 8907ffca23
</span><span class="c1">// Version Date: 2019年11月27日 星期三 21时28分21秒 UTC
</span><span class="c1"></span>
<span class="c1">// Package grpc provides a gRPC client for the Echo service.
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">grpc</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;github.com/pkg/errors&#34;</span>
	<span class="s">&#34;google.golang.org/grpc&#34;</span>
	<span class="s">&#34;google.golang.org/grpc/metadata&#34;</span>

	<span class="s">&#34;github.com/go-kit/kit/endpoint&#34;</span>
	<span class="nx">grpctransport</span> <span class="s">&#34;github.com/go-kit/kit/transport/grpc&#34;</span>

	<span class="c1">// This Service
</span><span class="c1"></span>	<span class="nx">pb</span> <span class="s">&#34;test&#34;</span>
	<span class="s">&#34;test/echo-service/svc&#34;</span>
<span class="p">)</span>

<span class="c1">// New returns an service backed by a gRPC client connection. It is the
</span><span class="c1">// responsibility of the caller to dial, and later close, the connection.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">grpc</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="nx">ClientOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">cc</span> <span class="nx">clientConfig</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">f</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">options</span> <span class="p">{</span>
		<span class="nx">err</span> <span class="o">:=</span> <span class="nf">f</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cc</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot apply option&#34;</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">clientOptions</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">grpctransport</span><span class="p">.</span><span class="nx">ClientOption</span><span class="p">{</span>
		<span class="nx">grpctransport</span><span class="p">.</span><span class="nf">ClientBefore</span><span class="p">(</span>
			<span class="nf">contextValuesToGRPCMetadata</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">headers</span><span class="p">)),</span>
	<span class="p">}</span>
	<span class="kd">var</span> <span class="nx">echoEndpoint</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
	<span class="p">{</span>
		<span class="nx">echoEndpoint</span> <span class="p">=</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span>
			<span class="nx">conn</span><span class="p">,</span>
			<span class="s">&#34;echo.Echo&#34;</span><span class="p">,</span>
			<span class="s">&#34;Echo&#34;</span><span class="p">,</span>
			<span class="nx">EncodeGRPCEchoRequest</span><span class="p">,</span>
			<span class="nx">DecodeGRPCEchoResponse</span><span class="p">,</span>
			<span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">{},</span>
			<span class="nx">clientOptions</span><span class="o">...</span><span class="p">,</span>
		<span class="p">).</span><span class="nf">Endpoint</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">louderEndpoint</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
	<span class="p">{</span>
		<span class="nx">louderEndpoint</span> <span class="p">=</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span>
			<span class="nx">conn</span><span class="p">,</span>
			<span class="s">&#34;echo.Echo&#34;</span><span class="p">,</span>
			<span class="s">&#34;Louder&#34;</span><span class="p">,</span>
			<span class="nx">EncodeGRPCLouderRequest</span><span class="p">,</span>
			<span class="nx">DecodeGRPCLouderResponse</span><span class="p">,</span>
			<span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">{},</span>
			<span class="nx">clientOptions</span><span class="o">...</span><span class="p">,</span>
		<span class="p">).</span><span class="nf">Endpoint</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">loudergetEndpoint</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
	<span class="p">{</span>
		<span class="nx">loudergetEndpoint</span> <span class="p">=</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span>
			<span class="nx">conn</span><span class="p">,</span>
			<span class="s">&#34;echo.Echo&#34;</span><span class="p">,</span>
			<span class="s">&#34;LouderGet&#34;</span><span class="p">,</span>
			<span class="nx">EncodeGRPCLouderGetRequest</span><span class="p">,</span>
			<span class="nx">DecodeGRPCLouderGetResponse</span><span class="p">,</span>
			<span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">{},</span>
			<span class="nx">clientOptions</span><span class="o">...</span><span class="p">,</span>
		<span class="p">).</span><span class="nf">Endpoint</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Endpoints</span><span class="p">{</span>
		<span class="nx">EchoEndpoint</span><span class="p">:</span>      <span class="nx">echoEndpoint</span><span class="p">,</span>
		<span class="nx">LouderEndpoint</span><span class="p">:</span>    <span class="nx">louderEndpoint</span><span class="p">,</span>
		<span class="nx">LouderGetEndpoint</span><span class="p">:</span> <span class="nx">loudergetEndpoint</span><span class="p">,</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// GRPC Client Decode
</span><span class="c1"></span>
<span class="c1">// DecodeGRPCEchoResponse is a transport/grpc.DecodeResponseFunc that converts a
</span><span class="c1">// gRPC echo reply to a user-domain echo response. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeGRPCEchoResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">grpcReply</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">reply</span> <span class="o">:=</span> <span class="nx">grpcReply</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">reply</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// DecodeGRPCLouderResponse is a transport/grpc.DecodeResponseFunc that converts a
</span><span class="c1">// gRPC louder reply to a user-domain louder response. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeGRPCLouderResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">grpcReply</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">reply</span> <span class="o">:=</span> <span class="nx">grpcReply</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">reply</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// DecodeGRPCLouderGetResponse is a transport/grpc.DecodeResponseFunc that converts a
</span><span class="c1">// gRPC louderget reply to a user-domain louderget response. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeGRPCLouderGetResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">grpcReply</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">reply</span> <span class="o">:=</span> <span class="nx">grpcReply</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">reply</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// GRPC Client Encode
</span><span class="c1"></span>
<span class="c1">// EncodeGRPCEchoRequest is a transport/grpc.EncodeRequestFunc that converts a
</span><span class="c1">// user-domain echo request to a gRPC echo request. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeGRPCEchoRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// EncodeGRPCLouderRequest is a transport/grpc.EncodeRequestFunc that converts a
</span><span class="c1">// user-domain louder request to a gRPC louder request. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeGRPCLouderRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// EncodeGRPCLouderGetRequest is a transport/grpc.EncodeRequestFunc that converts a
</span><span class="c1">// user-domain louderget request to a gRPC louderget request. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeGRPCLouderGetRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">req</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">clientConfig</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">headers</span> <span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// ClientOption is a function that modifies the client config
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ClientOption</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">clientConfig</span><span class="p">)</span> <span class="kt">error</span>

<span class="kd">func</span> <span class="nf">CtxValuesToSend</span><span class="p">(</span><span class="nx">keys</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="nx">ClientOption</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">o</span> <span class="o">*</span><span class="nx">clientConfig</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="nx">o</span><span class="p">.</span><span class="nx">headers</span> <span class="p">=</span> <span class="nx">keys</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">contextValuesToGRPCMetadata</span><span class="p">(</span><span class="nx">keys</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="nx">grpctransport</span><span class="p">.</span><span class="nx">ClientRequestFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">md</span> <span class="o">*</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">MD</span><span class="p">)</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">pairs</span> <span class="p">[]</span><span class="kt">string</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">keys</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="nx">k</span><span class="p">).(</span><span class="kt">string</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">pairs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">pairs</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">pairs</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="o">*</span><span class="nx">md</span> <span class="p">=</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="o">*</span><span class="nx">md</span><span class="p">,</span> <span class="nx">metadata</span><span class="p">.</span><span class="nf">Pairs</span><span class="p">(</span><span class="nx">pairs</span><span class="o">...</span><span class="p">))</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="nx">ctx</span>
	<span class="p">}</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>svc/client/http:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by truss. DO NOT EDIT.
</span><span class="c1">// Rerunning truss will overwrite this file.
</span><span class="c1">// Version: 8907ffca23
</span><span class="c1">// Version Date: 2019年11月27日 星期三 21时28分21秒 UTC
</span><span class="c1"></span>
<span class="c1">// Package http provides an HTTP client for the Echo service.
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">http</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;bytes&#34;</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io&#34;</span>
	<span class="s">&#34;io/ioutil&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;net/url&#34;</span>
	<span class="s">&#34;strings&#34;</span>

	<span class="s">&#34;github.com/gogo/protobuf/jsonpb&#34;</span>

	<span class="s">&#34;github.com/go-kit/kit/endpoint&#34;</span>
	<span class="nx">httptransport</span> <span class="s">&#34;github.com/go-kit/kit/transport/http&#34;</span>
	<span class="s">&#34;github.com/pkg/errors&#34;</span>

	<span class="c1">// This Service
</span><span class="c1"></span>	<span class="nx">pb</span> <span class="s">&#34;test&#34;</span>
	<span class="s">&#34;test/echo-service/svc&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Chain</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nx">NewClient</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Compare</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nx">NopCloser</span>
<span class="p">)</span>

<span class="c1">// New returns a service backed by an HTTP server living at the remote
</span><span class="c1">// instance. We expect instance to come from a service discovery system, so
</span><span class="c1">// likely of the form &#34;host:port&#34;.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">instance</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">options</span> <span class="o">...</span><span class="nx">httptransport</span><span class="p">.</span><span class="nx">ClientOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="s">&#34;http&#34;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">instance</span> <span class="p">=</span> <span class="s">&#34;http://&#34;</span> <span class="o">+</span> <span class="nx">instance</span>
	<span class="p">}</span>
	<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">instance</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">u</span>

	<span class="kd">var</span> <span class="nx">EchoZeroEndpoint</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
	<span class="p">{</span>
		<span class="nx">EchoZeroEndpoint</span> <span class="p">=</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span>
			<span class="s">&#34;GET&#34;</span><span class="p">,</span>
			<span class="nf">copyURL</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="s">&#34;/echo/&#34;</span><span class="p">),</span>
			<span class="nx">EncodeHTTPEchoZeroRequest</span><span class="p">,</span>
			<span class="nx">DecodeHTTPEchoResponse</span><span class="p">,</span>
			<span class="nx">options</span><span class="o">...</span><span class="p">,</span>
		<span class="p">).</span><span class="nf">Endpoint</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="kd">var</span> <span class="nx">LouderZeroEndpoint</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
	<span class="p">{</span>
		<span class="nx">LouderZeroEndpoint</span> <span class="p">=</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span>
			<span class="s">&#34;POST&#34;</span><span class="p">,</span>
			<span class="nf">copyURL</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="s">&#34;/louder/&#34;</span><span class="p">),</span>
			<span class="nx">EncodeHTTPLouderZeroRequest</span><span class="p">,</span>
			<span class="nx">DecodeHTTPLouderResponse</span><span class="p">,</span>
			<span class="nx">options</span><span class="o">...</span><span class="p">,</span>
		<span class="p">).</span><span class="nf">Endpoint</span><span class="p">()</span>
	<span class="p">}</span>
	<span class="kd">var</span> <span class="nx">LouderGetZeroEndpoint</span> <span class="nx">endpoint</span><span class="p">.</span><span class="nx">Endpoint</span>
	<span class="p">{</span>
		<span class="nx">LouderGetZeroEndpoint</span> <span class="p">=</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nf">NewClient</span><span class="p">(</span>
			<span class="s">&#34;GET&#34;</span><span class="p">,</span>
			<span class="nf">copyURL</span><span class="p">(</span><span class="nx">u</span><span class="p">,</span> <span class="s">&#34;/louder/&#34;</span><span class="p">),</span>
			<span class="nx">EncodeHTTPLouderGetZeroRequest</span><span class="p">,</span>
			<span class="nx">DecodeHTTPLouderGetResponse</span><span class="p">,</span>
			<span class="nx">options</span><span class="o">...</span><span class="p">,</span>
		<span class="p">).</span><span class="nf">Endpoint</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Endpoints</span><span class="p">{</span>
		<span class="nx">EchoEndpoint</span><span class="p">:</span>      <span class="nx">EchoZeroEndpoint</span><span class="p">,</span>
		<span class="nx">LouderEndpoint</span><span class="p">:</span>    <span class="nx">LouderZeroEndpoint</span><span class="p">,</span>
		<span class="nx">LouderGetEndpoint</span><span class="p">:</span> <span class="nx">LouderGetZeroEndpoint</span><span class="p">,</span>
	<span class="p">},</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">copyURL</span><span class="p">(</span><span class="nx">base</span> <span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span> <span class="p">{</span>
	<span class="nx">next</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">base</span>
	<span class="nx">next</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">path</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">next</span>
<span class="p">}</span>

<span class="c1">// CtxValuesToSend configures the http client to pull the specified keys out of
</span><span class="c1">// the context and add them to the http request as headers.  Note that keys
</span><span class="c1">// will have net/http.CanonicalHeaderKey called on them before being send over
</span><span class="c1">// the wire and that is the form they will be available in the server context.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">CtxValuesToSend</span><span class="p">(</span><span class="nx">keys</span> <span class="o">...</span><span class="kt">string</span><span class="p">)</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nx">ClientOption</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">httptransport</span><span class="p">.</span><span class="nf">ClientBefore</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">keys</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="nx">k</span><span class="p">).(</span><span class="kt">string</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
				<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">ctx</span>
	<span class="p">})</span>
<span class="p">}</span>

<span class="c1">// HTTP Client Decode
</span><span class="c1"></span>
<span class="c1">// DecodeHTTPEchoResponse is a transport/http.DecodeResponseFunc that decodes
</span><span class="c1">// a JSON-encoded EchoResponse response from the HTTP response body.
</span><span class="c1">// If the response has a non-200 status code, we will interpret that as an
</span><span class="c1">// error and attempt to decode the specific error message from the response
</span><span class="c1">// body. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeHTTPEchoResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;response http body empty&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot read http body&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nf">errorDecoder</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="s">&#34;status code: &#39;%d&#39;&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nf">UnmarshalString</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">errorDecoder</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// DecodeHTTPLouderResponse is a transport/http.DecodeResponseFunc that decodes
</span><span class="c1">// a JSON-encoded EchoResponse response from the HTTP response body.
</span><span class="c1">// If the response has a non-200 status code, we will interpret that as an
</span><span class="c1">// error and attempt to decode the specific error message from the response
</span><span class="c1">// body. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeHTTPLouderResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;response http body empty&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot read http body&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nf">errorDecoder</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="s">&#34;status code: &#39;%d&#39;&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nf">UnmarshalString</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">errorDecoder</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// DecodeHTTPLouderGetResponse is a transport/http.DecodeResponseFunc that decodes
</span><span class="c1">// a JSON-encoded EchoResponse response from the HTTP response body.
</span><span class="c1">// If the response has a non-200 status code, we will interpret that as an
</span><span class="c1">// error and attempt to decode the specific error message from the response
</span><span class="c1">// body. Primarily useful in a client.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">DecodeHTTPLouderGetResponse</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
	<span class="nx">buf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;response http body empty&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrap</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;cannot read http body&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="o">!=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nf">errorDecoder</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="s">&#34;status code: &#39;%d&#39;&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">jsonpb</span><span class="p">.</span><span class="nf">UnmarshalString</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nf">errorDecoder</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// HTTP Client Encode
</span><span class="c1"></span>
<span class="c1">// EncodeHTTPEchoZeroRequest is a transport/http.EncodeRequestFunc
</span><span class="c1">// that encodes a echo request into the various portions of
</span><span class="c1">// the http request (path, query, and body).
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeHTTPEchoZeroRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">strval</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">strval</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">req</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;HTTPJSON&#34;</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;request-url&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>

	<span class="c1">// Set the path parameters
</span><span class="c1"></span>	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">&#34;&#34;</span><span class="p">,</span>
		<span class="s">&#34;echo&#34;</span><span class="p">,</span>
		<span class="s">&#34;&#34;</span><span class="p">,</span>
	<span class="p">},</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
	<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;couldn&#39;t unmarshal path %q&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">RawPath</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Path</span>

	<span class="c1">// Set the query parameters
</span><span class="c1"></span>	<span class="nx">values</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">tmp</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">tmp</span>

	<span class="nx">values</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;In&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">In</span><span class="p">))</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="nx">values</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// EncodeHTTPEchoOneRequest is a transport/http.EncodeRequestFunc
</span><span class="c1">// that encodes a echo request into the various portions of
</span><span class="c1">// the http request (path, query, and body).
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeHTTPEchoOneRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">strval</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">strval</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">req</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;HTTPJSON&#34;</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;request-url&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>

	<span class="c1">// Set the path parameters
</span><span class="c1"></span>	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">&#34;&#34;</span><span class="p">,</span>
		<span class="s">&#34;echo&#34;</span><span class="p">,</span>
	<span class="p">},</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
	<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;couldn&#39;t unmarshal path %q&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">RawPath</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Path</span>

	<span class="c1">// Set the query parameters
</span><span class="c1"></span>	<span class="nx">values</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">tmp</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">tmp</span>

	<span class="nx">values</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;In&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">In</span><span class="p">))</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="nx">values</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// EncodeHTTPLouderZeroRequest is a transport/http.EncodeRequestFunc
</span><span class="c1">// that encodes a louder request into the various portions of
</span><span class="c1">// the http request (path, query, and body).
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeHTTPLouderZeroRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">strval</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">strval</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">req</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;HTTPJSON&#34;</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;request-url&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>

	<span class="c1">// Set the path parameters
</span><span class="c1"></span>	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">&#34;&#34;</span><span class="p">,</span>
		<span class="s">&#34;louder&#34;</span><span class="p">,</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Loudness</span><span class="p">),</span>
	<span class="p">},</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
	<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;couldn&#39;t unmarshal path %q&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">RawPath</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Path</span>

	<span class="c1">// Set the query parameters
</span><span class="c1"></span>	<span class="nx">values</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">tmp</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">tmp</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="nx">values</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
	<span class="c1">// Set the body parameters
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">buf</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
	<span class="nx">toRet</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>

	<span class="nx">toRet</span><span class="p">.</span><span class="nx">In</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">In</span>

	<span class="nx">encoder</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">)</span>
	<span class="nx">encoder</span><span class="p">.</span><span class="nf">SetEscapeHTML</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">encoder</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">toRet</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;couldn&#39;t encode body as json %v&#34;</span><span class="p">,</span> <span class="nx">toRet</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">NopCloser</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// EncodeHTTPLouderOneRequest is a transport/http.EncodeRequestFunc
</span><span class="c1">// that encodes a louder request into the various portions of
</span><span class="c1">// the http request (path, query, and body).
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeHTTPLouderOneRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">strval</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">strval</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">req</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;HTTPJSON&#34;</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;request-url&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>

	<span class="c1">// Set the path parameters
</span><span class="c1"></span>	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">&#34;&#34;</span><span class="p">,</span>
		<span class="s">&#34;louder&#34;</span><span class="p">,</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Loudness</span><span class="p">),</span>
	<span class="p">},</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
	<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;couldn&#39;t unmarshal path %q&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">RawPath</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Path</span>

	<span class="c1">// Set the query parameters
</span><span class="c1"></span>	<span class="nx">values</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">tmp</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">tmp</span>

	<span class="nx">values</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;In&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">In</span><span class="p">))</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="nx">values</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
	<span class="c1">// Set the body parameters
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">buf</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
	<span class="nx">toRet</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
	<span class="nx">encoder</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">)</span>
	<span class="nx">encoder</span><span class="p">.</span><span class="nf">SetEscapeHTML</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">encoder</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">toRet</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;couldn&#39;t encode body as json %v&#34;</span><span class="p">,</span> <span class="nx">toRet</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">NopCloser</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">buf</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// EncodeHTTPLouderGetZeroRequest is a transport/http.EncodeRequestFunc
</span><span class="c1">// that encodes a louderget request into the various portions of
</span><span class="c1">// the http request (path, query, and body).
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">EncodeHTTPLouderGetZeroRequest</span><span class="p">(</span><span class="nx">_</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">request</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">strval</span> <span class="o">:=</span> <span class="s">&#34;&#34;</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">strval</span>
	<span class="nx">req</span> <span class="o">:=</span> <span class="nx">request</span><span class="p">.(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">req</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;transport&#34;</span><span class="p">,</span> <span class="s">&#34;HTTPJSON&#34;</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;request-url&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>

	<span class="c1">// Set the path parameters
</span><span class="c1"></span>	<span class="nx">path</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span>
		<span class="s">&#34;&#34;</span><span class="p">,</span>
		<span class="s">&#34;louder&#34;</span><span class="p">,</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Loudness</span><span class="p">),</span>
	<span class="p">},</span> <span class="s">&#34;/&#34;</span><span class="p">)</span>
	<span class="nx">u</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">Wrapf</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="s">&#34;couldn&#39;t unmarshal path %q&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawPath</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">RawPath</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Path</span>

	<span class="c1">// Set the query parameters
</span><span class="c1"></span>	<span class="nx">values</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nf">Query</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">tmp</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">_</span> <span class="p">=</span> <span class="nx">tmp</span>

	<span class="nx">values</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;In&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">In</span><span class="p">))</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="nx">values</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">errorDecoder</span><span class="p">(</span><span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">w</span> <span class="nx">errorWrapper</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">w</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="kd">const</span> <span class="nx">size</span> <span class="p">=</span> <span class="mi">8196</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">size</span> <span class="p">{</span>
			<span class="nx">buf</span> <span class="p">=</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">size</span><span class="p">]</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;response body &#39;%s&#39;: cannot parse non-json request body&#34;</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">Error</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">errorWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Error</span> <span class="kt">string</span> <span class="s">`json:&#34;error&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="handlers">handlers</h2>
<p>handlers/handlers.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">handlers</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>

	<span class="nx">pb</span> <span class="s">&#34;test&#34;</span>
<span class="p">)</span>

<span class="c1">// NewService returns a naïve, stateless implementation of Service.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewService</span><span class="p">()</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">echoService</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">echoService</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="c1">// Echo implements Service.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">echoService</span><span class="p">)</span> <span class="nf">Echo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span>
	<span class="nx">resp</span> <span class="p">=</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">{</span>
		<span class="c1">// Out:
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Louder implements Service.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">echoService</span><span class="p">)</span> <span class="nf">Louder</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span>
	<span class="nx">resp</span> <span class="p">=</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">{</span>
		<span class="c1">// Out:
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// LouderGet implements Service.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="nx">echoService</span><span class="p">)</span> <span class="nf">LouderGet</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">in</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">LouderRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">resp</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span>
	<span class="nx">resp</span> <span class="p">=</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoResponse</span><span class="p">{</span>
		<span class="c1">// Out:
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>handlers/hooks.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">handlers</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;os/signal&#34;</span>
	<span class="s">&#34;syscall&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">InterruptHandler</span><span class="p">(</span><span class="nx">errc</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	<span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span>
	<span class="nx">terminateError</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">)</span>

	<span class="c1">// Place whatever shutdown handling you want here
</span><span class="c1"></span>
	<span class="nx">errc</span> <span class="o">&lt;-</span> <span class="nx">terminateError</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>handlers/middlewares.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">handlers</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="nx">pb</span> <span class="s">&#34;test&#34;</span>
	<span class="s">&#34;test/echo-service/svc&#34;</span>
<span class="p">)</span>

<span class="c1">// WrapEndpoints accepts the service&#39;s entire collection of endpoints, so that a
</span><span class="c1">// set of middlewares can be wrapped around every middleware (e.g., access
</span><span class="c1">// logging and instrumentation), and others wrapped selectively around some
</span><span class="c1">// endpoints and not others (e.g., endpoints requiring authenticated access).
</span><span class="c1">// Note that the final middleware wrapped will be the outermost middleware
</span><span class="c1">// (i.e. applied first)
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">WrapEndpoints</span><span class="p">(</span><span class="nx">in</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Endpoints</span><span class="p">)</span> <span class="nx">svc</span><span class="p">.</span><span class="nx">Endpoints</span> <span class="p">{</span>

	<span class="c1">// Pass a middleware you want applied to every endpoint.
</span><span class="c1"></span>	<span class="c1">// optionally pass in endpoints by name that you want to be excluded
</span><span class="c1"></span>	<span class="c1">// e.g.
</span><span class="c1"></span>	<span class="c1">// in.WrapAllExcept(authMiddleware, &#34;Status&#34;, &#34;Ping&#34;)
</span><span class="c1"></span>
	<span class="c1">// Pass in a svc.LabeledMiddleware you want applied to every endpoint.
</span><span class="c1"></span>	<span class="c1">// These middlewares get passed the endpoints name as their first argument when applied.
</span><span class="c1"></span>	<span class="c1">// This can be used to write generic metric gathering middlewares that can
</span><span class="c1"></span>	<span class="c1">// report the endpoint name for free.
</span><span class="c1"></span>	<span class="c1">// github.com/metaverse/truss/_example/middlewares/labeledmiddlewares.go for examples.
</span><span class="c1"></span>	<span class="c1">// in.WrapAllLabeledExcept(errorCounter(statsdCounter), &#34;Status&#34;, &#34;Ping&#34;)
</span><span class="c1"></span>
	<span class="c1">// How to apply a middleware to a single endpoint.
</span><span class="c1"></span>	<span class="c1">// in.ExampleEndpoint = authMiddleware(in.ExampleEndpoint)
</span><span class="c1"></span>
	<span class="k">return</span> <span class="nx">in</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">WrapService</span><span class="p">(</span><span class="nx">in</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span><span class="p">)</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">EchoServer</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">in</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="main">main</h2>
<p>cmd/echo/main.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by truss. DO NOT EDIT.
</span><span class="c1">// Rerunning truss will overwrite this file.
</span><span class="c1">// Version: 8907ffca23
</span><span class="c1">// Version Date: 2019年11月27日 星期三 21时28分21秒 UTC
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;flag&#34;</span>

	<span class="c1">// This Service
</span><span class="c1"></span>	<span class="s">&#34;test/echo-service/svc/server&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// Update addresses if they have been overwritten by flags
</span><span class="c1"></span>	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>

	<span class="nx">server</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="nx">server</span><span class="p">.</span><span class="nx">DefaultConfig</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>转载:<a href="https://www.jianshu.com/p/cffe039fa060">https://www.jianshu.com/p/cffe039fa060</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-04-09
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/gokit/">Gokit</a>
          <a href="/tags/truss/">truss</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/go-micro%E4%BD%BF%E7%94%A8%E5%88%9D%E6%8E%A2%E5%8F%8A%E5%85%B6%E5%BA%95%E5%B1%82%E6%9E%B6%E6%9E%84/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go-Micro初探及其底层架构</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/mongodb%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4%E6%9C%BA%E5%88%B6%E5%8F%8A%E5%8E%9F%E7%90%86/">
            <span class="next-text nav-default">MongoDB分片集群机制及原理</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Forz</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
