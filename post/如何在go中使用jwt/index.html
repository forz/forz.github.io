<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>如何在Go中使用JWT | Forz Blog</title>
<meta name="keywords" content="Go, JWT" />
<meta name="description" content="jwt-go 编写jwt工具 我们需要编写一个jwt的工具，我们在pkg下的util目录新建jwt.go，写入文件内容： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17">
<meta name="author" content="">
<link rel="canonical" href="/post/%E5%A6%82%E4%BD%95%E5%9C%A8go%E4%B8%AD%E4%BD%BF%E7%94%A8jwt/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="如何在Go中使用JWT" />
<meta property="og:description" content="jwt-go 编写jwt工具 我们需要编写一个jwt的工具，我们在pkg下的util目录新建jwt.go，写入文件内容： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/%E5%A6%82%E4%BD%95%E5%9C%A8go%E4%B8%AD%E4%BD%BF%E7%94%A8jwt/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-12-08T15:39:17&#43;00:00" />
<meta property="article:modified_time" content="2019-12-08T15:39:17&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何在Go中使用JWT"/>
<meta name="twitter:description" content="jwt-go 编写jwt工具 我们需要编写一个jwt的工具，我们在pkg下的util目录新建jwt.go，写入文件内容： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "如何在Go中使用JWT",
      "item": "/post/%E5%A6%82%E4%BD%95%E5%9C%A8go%E4%B8%AD%E4%BD%BF%E7%94%A8jwt/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "如何在Go中使用JWT",
  "name": "如何在Go中使用JWT",
  "description": "jwt-go 编写jwt工具 我们需要编写一个jwt的工具，我们在pkg下的util目录新建jwt.go，写入文件内容： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17",
  "keywords": [
    "Go", "JWT"
  ],
  "articleBody": "jwt-go 编写jwt工具 我们需要编写一个jwt的工具，我们在pkg下的util目录新建jwt.go，写入文件内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64  package util import ( \"time\" \"github.com/dgrijalva/jwt-go\" ) var jwtSecret = \"dong_tech\"// 加盐  //自定义payload结构体,不建议直接使用 dgrijalva/jwt-go jwt.StandardClaims结构体.因为他的payload包含的用户信息太少. type Claims struct { // token里面添加用户信息，验证token后可能会用到用户信息 \tjwt.StandardClaims UserID int `json:\"user_id\"` Password string `json:\"password\"` Username string `json:\"username\"` FullName string `json:\"full_name\"` Permissions []string `json:\"permissions\"` } //实现 `type Claims interface` 的 `Valid() error` 方法,自定义校验内容 func (c Claims) Valid() (err error) { if c.VerifyExpiresAt(time.Now().Unix(), true) == false { return errors.New(\"token is expired\") } if !c.VerifyIssuer(AppIss, true) { return errors.New(\"token's issuer is wrong\") } if c.User.Id  1 { return errors.New(\"invalid user in jwt\") } return } // GenerateToken generate tokens used for auth func GenerateToken(username, password string) (string, error) { username := c.Param(\"username\") password := c.Param(\"password\") claims := \u0026Claims{ UserID: 1, Username: username, Password: password, FullName: username, Permissions: []string{}, } claims.IssuedAt = time.Now().Unix() claims.ExpiresAt = time.Now().Add(time.Second * time.Duration(ExpireTime)).Unix() tokenClaims := jwt.NewWithClaims(jwt.SigningMethodHS256, claims) token, err := tokenClaims.SignedString(jwtSecret) return token, err } // ParseToken parsing token func ParseToken(token string) (*Claims, error) { tokenClaims, err := jwt.ParseWithClaims(token, \u0026Claims{}, func(token *jwt.Token) (interface{}, error) { return jwtSecret, nil }) if tokenClaims != nil { if claims, ok := tokenClaims.Claims.(*Claims); ok \u0026\u0026 tokenClaims.Valid { return claims, nil } } return nil, err }   在这个工具包，我们涉及到\n NewWithClaims(method SigningMethod, claims Claims) method对应着SigningMethodHMAC struct{}，其包含SigningMethodHS256、SigningMethodHS384、SigningMethodHS512三种crypto.Hash方案 func (t *Token) SignedString(key interface{}) 该方法内部生成签名字符串，再用于获取完整、已签名的token func (p *Parser) ParseWithClaims 用于解析鉴权的声明，方法内部主要是具体的解码和校验的过程，最终返回*Token func (m MapClaims) Valid() 验证基于时间的声明exp, iat, nbf，注意如果没有任何声明在令牌中，仍然会被认为是有效的。并且对于时区偏差没有计算方法,此处采用自己实现的方式  有了jwt工具包，接下来我们要编写要用于Gin的中间件，我们在middleware下新建jwt目录，新建jwt.go文件，写入内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  package jwt import ( \"net/http\" \"github.com/dgrijalva/jwt-go\" \"github.com/gin-gonic/gin\" \"github.com/EDDYCJY/go-gin-example/pkg/e\" \"github.com/EDDYCJY/go-gin-example/pkg/util\" ) // JWT is jwt middleware func JWT() gin.HandlerFunc { return func(c *gin.Context) { var code int var data interface{} code = e.SUCCESS token := c.Query(\"token\") if token == \"\" { code = e.INVALID_PARAMS } else { _, err := util.ParseToken(token) if err != nil { switch err.(*jwt.ValidationError).Errors { case jwt.ValidationErrorExpired: code = e.ERROR_AUTH_CHECK_TOKEN_TIMEOUT default: code = e.ERROR_AUTH_CHECK_TOKEN_FAIL } } } if code != e.SUCCESS { c.JSON(http.StatusUnauthorized, gin.H{ \"code\": code, \"msg\": e.GetMsg(code), \"data\": data, }) c.Abort() return } c.Next() } }   如何获取Token 那么我们如何调用它呢，我们还要获取Token呢？\n我们要新增一个获取Token的API,在models下新建auth.go文件，写入内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  package models type Auth struct { ID int `gorm:\"primary_key\" json:\"id\"` Username string `json:\"username\"` Password string `json:\"password\"` } func CheckAuth(username, password string) bool { var auth Auth db.Select(\"id\").Where(Auth{Username : username, Password : password}).First(\u0026auth) if auth.ID  0 { return true } return false }   在routers下的api目录新建auth.go文件，写入内容：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56  package api import ( \"log\" \"net/http\" \"github.com/gin-gonic/gin\" \"github.com/astaxie/beego/validation\" \"gin-blog/pkg/e\" \"gin-blog/pkg/util\" \"gin-blog/models\" ) type auth struct { Username string `valid:\"Required; MaxSize(50)\"` Password string `valid:\"Required; MaxSize(50)\"` } func GetAuth(c *gin.Context) { username := c.Query(\"username\") password := c.Query(\"password\") valid := validation.Validation{} a := auth{Username: username, Password: password} ok, _ := valid.Valid(\u0026a) data := make(map[string]interface{}) code := e.INVALID_PARAMS if ok { isExist := models.CheckAuth(username, password) if isExist { token, err := util.GenerateToken(username, password) if err != nil { code = e.ERROR_AUTH_TOKEN } else { data[\"token\"] = token code = e.SUCCESS } } else { code = e.ERROR_AUTH } } else { for _, err := range valid.Errors { log.Println(err.Key, err.Message) } } c.JSON(http.StatusOK, gin.H{ \"code\" : code, \"msg\" : e.GetMsg(code), \"data\" : data, }) }   我们打开routers目录下的router.go文件，修改文件内容（新增获取token的方法）：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  package routers import ( \"github.com/gin-gonic/gin\" \"gin-blog/routers/api\" \"gin-blog/routers/api/v1\" \"gin-blog/pkg/setting\" ) func InitRouter() *gin.Engine { r := gin.New() r.Use(gin.Logger()) r.Use(gin.Recovery()) gin.SetMode(setting.RunMode) r.GET(\"/auth\", api.GetAuth) apiv1 := r.Group(\"/api/v1\") { ... } return r }   将中间件接入Gin 接下来我们将中间件接入到Gin的访问流程中\n我们打开routers目录下的router.go文件，修改文件内容（新增引用包和中间件引用）\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  package routers import ( \"github.com/gin-gonic/gin\" \"gin-blog/routers/api\" \"gin-blog/routers/api/v1\" \"gin-blog/pkg/setting\" \"gin-blog/middleware/jwt\" ) func InitRouter() *gin.Engine { r := gin.New() r.Use(gin.Logger()) r.Use(gin.Recovery()) gin.SetMode(setting.RunMode) r.GET(\"/auth\", api.GetAuth) apiv1 := r.Group(\"/api/v1\") apiv1.Use(jwt.JWT()) { ... } return r }   当前目录结构：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  gin-blog/ ├── conf │ └── app.ini ├── main.go ├── middleware │ └── jwt │ └── jwt.go ├── models │ ├── article.go │ ├── auth.go │ ├── models.go │ └── tag.go ├── pkg │ ├── e │ │ ├── code.go │ │ └── msg.go │ ├── setting │ │ └── setting.go │ └── util │ ├── jwt.go │ └── pagination.go ├── routers │ ├── api │ │ ├── auth.go │ │ └── v1 │ │ ├── article.go │ │ └── tag.go │ └── router.go ├── runtime   到这里，我们的JWT编写就完成啦！\n验证功能 我们测试一下，访问\n1 2  http://127.0.0.1:8000/api/v1/articles http://127.0.0.1:8000/api/v1/articles?token=23131   正确的反馈应该是\n1 2 3 4 5  { \"code\": 400, \"data\": null, \"msg\": \"请求参数错误\" }   1 2 3 4 5  { \"code\": 20001, \"data\": null, \"msg\": \"Token鉴权失败\" }   我们需要访问http://127.0.0.1:8000/auth?username=test\u0026password=test123456，得到token\n1 2 3 4 5 6 7  { \"code\": 200, \"data\": { \"token\": \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InRlc3QiLCJwYXNzd29yZCI6InRlc3QxMjM0NTYiLCJleHAiOjE1MTg3MjQ2OTMsImlzcyI6Imdpbi1ibG9nIn0.KSBY6TeavV_30kfmP7HWLRYKP5TPEDgHtABe9HCsic4\" }, \"msg\": \"ok\" }   再用包含token的URL参数去访问我们的应用API，\n访问http://127.0.0.1:8000/api/v1/articles?token=eyJhbGci...，检查接口返回值\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  { \"code\": 200, \"data\": { \"lists\": [ { \"id\": 2, \"created_on\": 1518700920, \"modified_on\": 0, \"tag_id\": 1, \"tag\": { \"id\": 1, \"created_on\": 1518684200, \"modified_on\": 0, \"name\": \"tag1\", \"created_by\": \"\", \"modified_by\": \"\", \"state\": 0 }, \"content\": \"test-content\", \"created_by\": \"test-created\", \"modified_by\": \"\", \"state\": 0 } ], \"total\": 1 }, \"msg\": \"ok\" }   返回正确，至此我们的jwt-go在Gin中的验证就完成了！\ngin-jwt gin-jwt已经帮我们封装成中间件了，我们只需要设置并实例化它就可以直接用了。\n总的就是调用jwt.New函数来实例化一个jwt.GinJWTMiddleware\n然后我们看下jwt.GinJWTMiddleware中定义的属性和方法\n  TokenLookup：token检索模式，用于提取token，默认值为header:Authorization。\n  SigningAlgorithm：签名算法，默认值为HS256\n  Timeout：token过期时间，默认值为time.Hour\n  MaxRefresh:token 更新时间\n  TimeFunc：测试或服务器在其他时区可设置该属性，默认值为time.Now\n  TokenHeadName：token在请求头时的名称，默认值为Bearer\n  IdentityKey：身份验证的key值，默认值为identity\n  Realm：可以理解成该中间件的名称，用于展示，默认值为gin jwt\n  CookieName：Cookie名称，默认值为jwt\n  privKey：私钥\n  pubKey：公钥\n  Authenticator函数：在登录接口中使用的验证方法，并返回验证成功后的用户对象。\n  PayloadFunc函数：添加额外业务相关的信息\n  IdentityHandler函数：解析并设置用户身份信息\n  Authorizator函数：接收用户信息并编写授权规则，本项目的API权限控制就是通过该函数编写授权规则的\n  Unauthorized函数：验证失败后设置错误信息\n  LoginResponse函数：完成登录后返回的信息，用户可自定义返回数据，默认返回\n1 2 3 4 5  { \"code\": http.StatusOK, \"token\": token, \"expire\": expire.Format(time.RFC3339) }     RefreshResponse函数：刷新token后返回的信息，用户可自定义返回数据，默认返回\n1 2 3 4 5  { \"code\": http.StatusOK, \"token\": token, \"expire\": expire.Format(time.RFC3339) }     到这里我们应该就知道如何使用这个中间件了。\n代码示例:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184  package main import ( \"log\" \"net/http\" \"os\" \"time\" \"github.com/appleboy/gin-jwt/v2\" \"github.com/gin-gonic/gin\" ) type login struct { Username string `form:\"username\" json:\"username\" binding:\"required\"` Password string `form:\"password\" json:\"password\" binding:\"required\"` } var identityKey = \"id\" //定义一函数用来处理请求 func helloHandler(c *gin.Context) { //func ExtractClaims(c *gin.Context) jwt.MapClaims \t//ExtractClaims help to extract the JWT claims \t//用来将 Context 中的数据解析出来赋值给 claims \t//其实是解析出来了 JWT_PAYLOAD 里的内容 \t/* func ExtractClaims(c *gin.Context) jwt.MapClaims { claims, exists := c.Get(\"JWT_PAYLOAD\") if !exists { return make(jwt.MapClaims) } return claims.(jwt.MapClaims) } */ claims := jwt.ExtractClaims(c) user, _ := c.Get(identityKey) c.JSON(200, gin.H{ \"userID\": claims[identityKey], \"userName\": user.(*User).UserName, \"text\": \"Hello World.\", }) } // User demo type User struct { UserName string FirstName string LastName string } func main() { port := os.Getenv(\"PORT\") r := gin.New() r.Use(gin.Logger()) r.Use(gin.Recovery()) if port == \"\" { port = \"8000\" } // the jwt middleware \tauthMiddleware, err := jwt.New(\u0026jwt.GinJWTMiddleware{ //必要项，显示给用户看的域  Realm: \"test zone\", //用来进行签名的密钥，就是加盐用的  Key: []byte(\"secret key\"), //JWT 的有效时间，默认为一小时  Timeout: time.Hour, //最长的刷新时间，用来给客户端自己刷新 token 用的  MaxRefresh: time.Hour, //区分身份的key,此key需要每个用户唯一  IdentityKey: identityKey, //额外需要保存到MapClaims中的值,该函数接收Authenticator返回的interface{},返回jwt.MapClaims,该结构体将保存在context中.IdentityKey的值必须保存在其中 \tPayloadFunc: func(data interface{}) jwt.MapClaims { if v, ok := data.(*User); ok { return jwt.MapClaims{ identityKey: v.UserName, } } return jwt.MapClaims{} }, //返回某个用户的身份验证信息,有默认函数  // if mw.IdentityHandler == nil { \t// mw.IdentityHandler = func(c *gin.Context) interface{} { \t// claims := ExtractClaims(c) \t// return claims[mw.IdentityKey] \t// }  // } \tIdentityHandler: func(c *gin.Context) interface{} { claims := jwt.ExtractClaims(c) return \u0026User{ UserName: claims[identityKey].(string), } }, //必要项, 这个函数用来判断 User 信息是否合法，如果合法就反馈 true，否则就是 false, 认证的逻辑就在这里 \tAuthenticator: func(c *gin.Context) (interface{}, error) { var loginVals login if err := c.ShouldBind(\u0026loginVals); err != nil { return \"\", jwt.ErrMissingLoginValues } userID := loginVals.Username password := loginVals.Password if (userID == \"admin\" \u0026\u0026 password == \"admin\") || (userID == \"test\" \u0026\u0026 password == \"test\") { return \u0026User{ UserName: userID, LastName: \"Bo-Yi\", FirstName: \"Wu\", }, nil } return nil, jwt.ErrFailedAuthentication }, //可选项，用来在 Authenticator 认证成功的基础上进一步的检验用户是否有权限，默认为 success \tAuthorizator: func(data interface{}, c *gin.Context) bool { if v, ok := data.(*User); ok \u0026\u0026 v.UserName == \"admin\" { return true } return false }, //可以用来定义如果认证不成功的的处理函数,其中s是Authenticator函数中的err的string形式 \tUnauthorized: func(c *gin.Context, code int, message string) { c.JSON(code, gin.H{ \"code\": code, \"message\": message, }) }, //可以用来自定义登录成功后的返回  LoginResponse: func(context *gin.Context, i int, s string, i2 time.Time) { c.JSON(code, gin.H{ \"code\" : i, \"message\" : message, \"token\" : s, \"expire\" :i2.Unix(), }) }, //这个变量定义了从请求中解析 token 的格式 \t// TokenLookup is a string in the form of \":\" that is used \t// to extract token from the request. \t// Optional. Default value \"header:Authorization\". \t// Possible values: \t// - \"header:\" \t// - \"query:\" \t// - \"cookie:\" \t// - \"param:\" \tTokenLookup: \"header: Authorization, query: token, cookie: jwt\", // TokenLookup: \"query:token\", \t// TokenLookup: \"cookie:token\",  //TokenHeadName 是一个头部信息中的字符串 \t// TokenHeadName is a string in the header. Default value is \"Bearer\" \tTokenHeadName: \"Bearer\", // TimeFunc provides the current time. You can override it to use another time value. This is useful for testing or if your server uses a different time zone than your tokens.  //这个指定了提供当前时间的函数，也可以自定义 \tTimeFunc: time.Now, }) if err != nil { log.Fatal(\"JWT Error:\" + err.Error()) } r.POST(\"/login\", authMiddleware.LoginHandler) r.NoRoute(authMiddleware.MiddlewareFunc(), func(c *gin.Context) { claims := jwt.ExtractClaims(c) log.Printf(\"NoRoute claims: %#v\\n\", claims) c.JSON(404, gin.H{\"code\": \"PAGE_NOT_FOUND\", \"message\": \"Page not found\"}) }) auth := r.Group(\"/auth\") // Refresh time can be longer than token timeout \tauth.GET(\"/refresh_token\", authMiddleware.RefreshHandler) auth.Use(authMiddleware.MiddlewareFunc()) { auth.GET(\"/hello\", helloHandler) } if err := http.ListenAndServe(\":\"+port, r); err != nil { log.Fatal(err) } }   参考: https://segmentfault.com/a/1190000013297828 https://studygolang.com/articles/19838\n",
  "wordCount" : "3954",
  "inLanguage": "zh-cn",
  "datePublished": "2019-12-08T15:39:17Z",
  "dateModified": "2019-12-08T15:39:17Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/%E5%A6%82%E4%BD%95%E5%9C%A8go%E4%B8%AD%E4%BD%BF%E7%94%A8jwt/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      如何在Go中使用JWT
    </h1>
    <div class="post-meta">December 8, 2019
</div>
  </header> 
  <div class="post-content"><h1 id="jwt-go">jwt-go<a hidden class="anchor" aria-hidden="true" href="#jwt-go">#</a></h1>
<h2 id="编写jwt工具">编写jwt工具<a hidden class="anchor" aria-hidden="true" href="#编写jwt工具">#</a></h2>
<p>我们需要编写一个jwt的工具，我们在pkg下的util目录新建jwt.go，写入文件内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">util</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;github.com/dgrijalva/jwt-go&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">jwtSecret</span> <span class="p">=</span> <span class="s">&#34;dong_tech&#34;</span><span class="c1">// 加盐
</span><span class="c1"></span>
<span class="c1">//自定义payload结构体,不建议直接使用 dgrijalva/jwt-go jwt.StandardClaims结构体.因为他的payload包含的用户信息太少.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Claims</span> <span class="kd">struct</span> <span class="p">{</span> <span class="c1">// token里面添加用户信息，验证token后可能会用到用户信息
</span><span class="c1"></span>	<span class="nx">jwt</span><span class="p">.</span><span class="nx">StandardClaims</span>
	<span class="nx">UserID</span>      <span class="kt">int</span>      <span class="s">`json:&#34;user_id&#34;`</span>
	<span class="nx">Password</span>    <span class="kt">string</span>   <span class="s">`json:&#34;password&#34;`</span>
	<span class="nx">Username</span>    <span class="kt">string</span>   <span class="s">`json:&#34;username&#34;`</span>
	<span class="nx">FullName</span>    <span class="kt">string</span>   <span class="s">`json:&#34;full_name&#34;`</span>
	<span class="nx">Permissions</span> <span class="p">[]</span><span class="kt">string</span> <span class="s">`json:&#34;permissions&#34;`</span>
<span class="p">}</span>
<span class="c1">//实现 `type Claims interface` 的 `Valid() error` 方法,自定义校验内容
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="nx">Claims</span><span class="p">)</span> <span class="nf">Valid</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nf">VerifyExpiresAt</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">(),</span> <span class="kc">true</span><span class="p">)</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
		<span class="k">return</span>  <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;token is expired&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nf">VerifyIssuer</span><span class="p">(</span><span class="nx">AppIss</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span>  <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;token&#39;s issuer is wrong&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">Id</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;invalid user in jwt&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span>
<span class="p">}</span>
<span class="c1">// GenerateToken generate tokens used for auth
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GenerateToken</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">username</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Param</span><span class="p">(</span><span class="s">&#34;username&#34;</span><span class="p">)</span>
	<span class="nx">password</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Param</span><span class="p">(</span><span class="s">&#34;password&#34;</span><span class="p">)</span>
	<span class="nx">claims</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Claims</span><span class="p">{</span>
		<span class="nx">UserID</span><span class="p">:</span>      <span class="mi">1</span><span class="p">,</span>
		<span class="nx">Username</span><span class="p">:</span>    <span class="nx">username</span><span class="p">,</span>
		<span class="nx">Password</span><span class="p">:</span>    <span class="nx">password</span><span class="p">,</span>
		<span class="nx">FullName</span><span class="p">:</span>    <span class="nx">username</span><span class="p">,</span>
		<span class="nx">Permissions</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span>
	<span class="p">}</span>
	<span class="nx">claims</span><span class="p">.</span><span class="nx">IssuedAt</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">()</span>
	<span class="nx">claims</span><span class="p">.</span><span class="nx">ExpiresAt</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">ExpireTime</span><span class="p">)).</span><span class="nf">Unix</span><span class="p">()</span>
	<span class="nx">tokenClaims</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">NewWithClaims</span><span class="p">(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHS256</span><span class="p">,</span> <span class="nx">claims</span><span class="p">)</span>
	<span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tokenClaims</span><span class="p">.</span><span class="nf">SignedString</span><span class="p">(</span><span class="nx">jwtSecret</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// ParseToken parsing token
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">ParseToken</span><span class="p">(</span><span class="nx">token</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Claims</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">tokenClaims</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">ParseWithClaims</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">Claims</span><span class="p">{},</span> <span class="kd">func</span><span class="p">(</span><span class="nx">token</span> <span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Token</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">jwtSecret</span><span class="p">,</span> <span class="kc">nil</span>
	<span class="p">})</span>

	<span class="k">if</span> <span class="nx">tokenClaims</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">claims</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">tokenClaims</span><span class="p">.</span><span class="nx">Claims</span><span class="p">.(</span><span class="o">*</span><span class="nx">Claims</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">tokenClaims</span><span class="p">.</span><span class="nx">Valid</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">claims</span><span class="p">,</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在这个工具包，我们涉及到</p>
<ul>
<li><code>NewWithClaims(method SigningMethod, claims Claims)</code>
method对应着SigningMethodHMAC struct{}，其包含SigningMethodHS256、SigningMethodHS384、SigningMethodHS512三种crypto.Hash方案</li>
<li><code>func (t *Token) SignedString(key interface{})</code>
该方法内部生成签名字符串，再用于获取完整、已签名的token</li>
<li><code>func (p *Parser) ParseWithClaims</code>
用于解析鉴权的声明，方法内部主要是具体的解码和校验的过程，最终返回*Token</li>
<li><code>func (m MapClaims) Valid()</code>
验证基于时间的声明exp, iat, nbf，注意如果没有任何声明在令牌中，仍然会被认为是有效的。并且对于时区偏差没有计算方法,此处采用自己实现的方式</li>
</ul>
<p>有了jwt工具包，接下来我们要编写要用于Gin的中间件，我们在middleware下新建jwt目录，新建jwt.go文件，写入内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">jwt</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;net/http&#34;</span>

	<span class="s">&#34;github.com/dgrijalva/jwt-go&#34;</span>
	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>

	<span class="s">&#34;github.com/EDDYCJY/go-gin-example/pkg/e&#34;</span>
	<span class="s">&#34;github.com/EDDYCJY/go-gin-example/pkg/util&#34;</span>
<span class="p">)</span>

<span class="c1">// JWT is jwt middleware
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">JWT</span><span class="p">()</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span> <span class="p">{</span>
	<span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">code</span> <span class="kt">int</span>
		<span class="kd">var</span> <span class="nx">data</span> <span class="kd">interface</span><span class="p">{}</span>

		<span class="nx">code</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">SUCCESS</span>
		<span class="nx">token</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;token&#34;</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">token</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
			<span class="nx">code</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">INVALID_PARAMS</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">ParseToken</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">ValidationError</span><span class="p">).</span><span class="nx">Errors</span> <span class="p">{</span>
				<span class="k">case</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">ValidationErrorExpired</span><span class="p">:</span>
					<span class="nx">code</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ERROR_AUTH_CHECK_TOKEN_TIMEOUT</span>
				<span class="k">default</span><span class="p">:</span>
					<span class="nx">code</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ERROR_AUTH_CHECK_TOKEN_FAIL</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">code</span> <span class="o">!=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">SUCCESS</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
				<span class="s">&#34;code&#34;</span><span class="p">:</span> <span class="nx">code</span><span class="p">,</span>
				<span class="s">&#34;msg&#34;</span><span class="p">:</span>  <span class="nx">e</span><span class="p">.</span><span class="nf">GetMsg</span><span class="p">(</span><span class="nx">code</span><span class="p">),</span>
				<span class="s">&#34;data&#34;</span><span class="p">:</span> <span class="nx">data</span><span class="p">,</span>
			<span class="p">})</span>

			<span class="nx">c</span><span class="p">.</span><span class="nf">Abort</span><span class="p">()</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="nx">c</span><span class="p">.</span><span class="nf">Next</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="如何获取token">如何获取Token<a hidden class="anchor" aria-hidden="true" href="#如何获取token">#</a></h2>
<p>那么我们如何调用它呢，我们还要获取Token呢？</p>
<p>我们要新增一个获取Token的API,在models下新建auth.go文件，写入内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">models</span>

<span class="kd">type</span> <span class="nx">Auth</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">ID</span> <span class="kt">int</span> <span class="s">`gorm:&#34;primary_key&#34; json:&#34;id&#34;`</span>
    <span class="nx">Username</span> <span class="kt">string</span> <span class="s">`json:&#34;username&#34;`</span>
    <span class="nx">Password</span> <span class="kt">string</span> <span class="s">`json:&#34;password&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">CheckAuth</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">auth</span> <span class="nx">Auth</span>
    <span class="nx">db</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="s">&#34;id&#34;</span><span class="p">).</span><span class="nf">Where</span><span class="p">(</span><span class="nx">Auth</span><span class="p">{</span><span class="nx">Username</span> <span class="p">:</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">Password</span> <span class="p">:</span> <span class="nx">password</span><span class="p">}).</span><span class="nf">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">auth</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">ID</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在routers下的api目录新建auth.go文件，写入内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">api</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;log&#34;</span>
    <span class="s">&#34;net/http&#34;</span>

    <span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
    <span class="s">&#34;github.com/astaxie/beego/validation&#34;</span>

    <span class="s">&#34;gin-blog/pkg/e&#34;</span>
    <span class="s">&#34;gin-blog/pkg/util&#34;</span>
    <span class="s">&#34;gin-blog/models&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">auth</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Username</span> <span class="kt">string</span> <span class="s">`valid:&#34;Required; MaxSize(50)&#34;`</span>
    <span class="nx">Password</span> <span class="kt">string</span> <span class="s">`valid:&#34;Required; MaxSize(50)&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">GetAuth</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">username</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;username&#34;</span><span class="p">)</span>
    <span class="nx">password</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="s">&#34;password&#34;</span><span class="p">)</span>

    <span class="nx">valid</span> <span class="o">:=</span> <span class="nx">validation</span><span class="p">.</span><span class="nx">Validation</span><span class="p">{}</span>
    <span class="nx">a</span> <span class="o">:=</span> <span class="nx">auth</span><span class="p">{</span><span class="nx">Username</span><span class="p">:</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">Password</span><span class="p">:</span> <span class="nx">password</span><span class="p">}</span>
    <span class="nx">ok</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">valid</span><span class="p">.</span><span class="nf">Valid</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">)</span>

    <span class="nx">data</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>
    <span class="nx">code</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">INVALID_PARAMS</span>
    <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="nx">isExist</span> <span class="o">:=</span> <span class="nx">models</span><span class="p">.</span><span class="nf">CheckAuth</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">isExist</span> <span class="p">{</span>
            <span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">GenerateToken</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">code</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ERROR_AUTH_TOKEN</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">data</span><span class="p">[</span><span class="s">&#34;token&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">token</span>

                <span class="nx">code</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">SUCCESS</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">code</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ERROR_AUTH</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">valid</span><span class="p">.</span><span class="nx">Errors</span> <span class="p">{</span>
            <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
        <span class="s">&#34;code&#34;</span> <span class="p">:</span> <span class="nx">code</span><span class="p">,</span>
        <span class="s">&#34;msg&#34;</span> <span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nf">GetMsg</span><span class="p">(</span><span class="nx">code</span><span class="p">),</span>
        <span class="s">&#34;data&#34;</span> <span class="p">:</span> <span class="nx">data</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们打开routers目录下的router.go文件，修改文件内容（新增获取token的方法）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">routers</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/gin-gonic/gin&#34;</span>

    <span class="s">&#34;gin-blog/routers/api&#34;</span>
    <span class="s">&#34;gin-blog/routers/api/v1&#34;</span>
    <span class="s">&#34;gin-blog/pkg/setting&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">InitRouter</span><span class="p">()</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Engine</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>

    <span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nf">Logger</span><span class="p">())</span>

    <span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nf">Recovery</span><span class="p">())</span>

    <span class="nx">gin</span><span class="p">.</span><span class="nf">SetMode</span><span class="p">(</span><span class="nx">setting</span><span class="p">.</span><span class="nx">RunMode</span><span class="p">)</span>

    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/auth&#34;</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">GetAuth</span><span class="p">)</span>

    <span class="nx">apiv1</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;/api/v1&#34;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">...</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">r</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="将中间件接入gin">将中间件接入Gin<a hidden class="anchor" aria-hidden="true" href="#将中间件接入gin">#</a></h2>
<p>接下来我们将中间件接入到Gin的访问流程中</p>
<p>我们打开routers目录下的router.go文件，修改文件内容（新增引用包和中间件引用）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">routers</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/gin-gonic/gin&#34;</span>

    <span class="s">&#34;gin-blog/routers/api&#34;</span>
    <span class="s">&#34;gin-blog/routers/api/v1&#34;</span>
    <span class="s">&#34;gin-blog/pkg/setting&#34;</span>
    <span class="s">&#34;gin-blog/middleware/jwt&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">InitRouter</span><span class="p">()</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Engine</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>

    <span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nf">Logger</span><span class="p">())</span>

    <span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nf">Recovery</span><span class="p">())</span>

    <span class="nx">gin</span><span class="p">.</span><span class="nf">SetMode</span><span class="p">(</span><span class="nx">setting</span><span class="p">.</span><span class="nx">RunMode</span><span class="p">)</span>

    <span class="nx">r</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/auth&#34;</span><span class="p">,</span> <span class="nx">api</span><span class="p">.</span><span class="nx">GetAuth</span><span class="p">)</span>

    <span class="nx">apiv1</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;/api/v1&#34;</span><span class="p">)</span>
    <span class="nx">apiv1</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">jwt</span><span class="p">.</span><span class="nf">JWT</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="o">...</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">r</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>当前目录结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">gin-blog/
├── conf
│   └── app.ini
├── main.go
├── middleware
│   └── jwt
│       └── jwt.go
├── models
│   ├── article.go
│   ├── auth.go
│   ├── models.go
│   └── tag.go
├── pkg
│   ├── e
│   │   ├── code.go
│   │   └── msg.go
│   ├── setting
│   │   └── setting.go
│   └── util
│       ├── jwt.go
│       └── pagination.go
├── routers
│   ├── api
│   │   ├── auth.go
│   │   └── v1
│   │       ├── article.go
│   │       └── tag.go
│   └── router.go
├── runtime
</code></pre></td></tr></table>
</div>
</div><p>到这里，我们的JWT编写就完成啦！</p>
<h2 id="验证功能">验证功能<a hidden class="anchor" aria-hidden="true" href="#验证功能">#</a></h2>
<p>我们测试一下，访问</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">http://127.0.0.1:8000/api/v1/articles
http://127.0.0.1:8000/api/v1/articles?token=23131
</code></pre></td></tr></table>
</div>
</div><p>正确的反馈应该是</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;请求参数错误&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="mi">20001</span><span class="p">,</span>
  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;Token鉴权失败&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们需要访问<code>http://127.0.0.1:8000/auth?username=test&amp;password=test123456</code>，得到token</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6InRlc3QiLCJwYXNzd29yZCI6InRlc3QxMjM0NTYiLCJleHAiOjE1MTg3MjQ2OTMsImlzcyI6Imdpbi1ibG9nIn0.KSBY6TeavV_30kfmP7HWLRYKP5TPEDgHtABe9HCsic4&#34;</span>
  <span class="p">},</span>
  <span class="nt">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;ok&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再用包含token的URL参数去访问我们的应用API，</p>
<p>访问<code>http://127.0.0.1:8000/api/v1/articles?token=eyJhbGci...</code>，检查接口返回值</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
  <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;lists&#34;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nt">&#34;created_on&#34;</span><span class="p">:</span> <span class="mi">1518700920</span><span class="p">,</span>
        <span class="nt">&#34;modified_on&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nt">&#34;tag_id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&#34;tag&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nt">&#34;created_on&#34;</span><span class="p">:</span> <span class="mi">1518684200</span><span class="p">,</span>
          <span class="nt">&#34;modified_on&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;tag1&#34;</span><span class="p">,</span>
          <span class="nt">&#34;created_by&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
          <span class="nt">&#34;modified_by&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
          <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">},</span>
        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;test-content&#34;</span><span class="p">,</span>
        <span class="nt">&#34;created_by&#34;</span><span class="p">:</span> <span class="s2">&#34;test-created&#34;</span><span class="p">,</span>
        <span class="nt">&#34;modified_by&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
        <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">],</span>
    <span class="nt">&#34;total&#34;</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">},</span>
  <span class="nt">&#34;msg&#34;</span><span class="p">:</span> <span class="s2">&#34;ok&#34;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>返回正确，至此我们的jwt-go在Gin中的验证就完成了！</p>
<h1 id="gin-jwt">gin-jwt<a hidden class="anchor" aria-hidden="true" href="#gin-jwt">#</a></h1>
<p>gin-jwt已经帮我们封装成中间件了，我们只需要设置并实例化它就可以直接用了。</p>
<p>总的就是调用jwt.New函数来实例化一个jwt.GinJWTMiddleware</p>
<p>然后我们看下jwt.GinJWTMiddleware中定义的属性和方法</p>
<ul>
<li>
<p>TokenLookup：token检索模式，用于提取token，默认值为header:Authorization。</p>
</li>
<li>
<p>SigningAlgorithm：签名算法，默认值为HS256</p>
</li>
<li>
<p>Timeout：token过期时间，默认值为time.Hour</p>
</li>
<li>
<p>MaxRefresh:token 更新时间</p>
</li>
<li>
<p>TimeFunc：测试或服务器在其他时区可设置该属性，默认值为time.Now</p>
</li>
<li>
<p>TokenHeadName：token在请求头时的名称，默认值为Bearer</p>
</li>
<li>
<p>IdentityKey：身份验证的key值，默认值为identity</p>
</li>
<li>
<p>Realm：可以理解成该中间件的名称，用于展示，默认值为gin jwt</p>
</li>
<li>
<p>CookieName：Cookie名称，默认值为jwt</p>
</li>
<li>
<p>privKey：私钥</p>
</li>
<li>
<p>pubKey：公钥</p>
</li>
<li>
<p>Authenticator函数：在登录接口中使用的验证方法，并返回验证成功后的用户对象。</p>
</li>
<li>
<p>PayloadFunc函数：添加额外业务相关的信息</p>
</li>
<li>
<p>IdentityHandler函数：解析并设置用户身份信息</p>
</li>
<li>
<p>Authorizator函数：接收用户信息并编写授权规则，本项目的API权限控制就是通过该函数编写授权规则的</p>
</li>
<li>
<p>Unauthorized函数：验证失败后设置错误信息</p>
</li>
<li>
<p>LoginResponse函数：完成登录后返回的信息，用户可自定义返回数据，默认返回</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="err">http.StatusOK</span><span class="p">,</span>
  <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="err">token</span><span class="p">,</span>
  <span class="nt">&#34;expire&#34;</span><span class="p">:</span> <span class="err">expire.Format(time.RFC</span><span class="mi">3339</span><span class="err">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>RefreshResponse函数：刷新token后返回的信息，用户可自定义返回数据，默认返回</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="err">http.StatusOK</span><span class="p">,</span>
  <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="err">token</span><span class="p">,</span>
  <span class="nt">&#34;expire&#34;</span><span class="p">:</span> <span class="err">expire.Format(time.RFC</span><span class="mi">3339</span><span class="err">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>到这里我们应该就知道如何使用这个中间件了。</p>
<p>代码示例:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
	<span class="s">&#34;os&#34;</span>
	<span class="s">&#34;time&#34;</span>

	<span class="s">&#34;github.com/appleboy/gin-jwt/v2&#34;</span>
	<span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">login</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Username</span> <span class="kt">string</span> <span class="s">`form:&#34;username&#34; json:&#34;username&#34; binding:&#34;required&#34;`</span>
	<span class="nx">Password</span> <span class="kt">string</span> <span class="s">`form:&#34;password&#34; json:&#34;password&#34; binding:&#34;required&#34;`</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">identityKey</span> <span class="p">=</span> <span class="s">&#34;id&#34;</span>

<span class="c1">//定义一函数用来处理请求
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">helloHandler</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//func ExtractClaims(c *gin.Context) jwt.MapClaims
</span><span class="c1"></span>	<span class="c1">//ExtractClaims help to extract the JWT claims
</span><span class="c1"></span>	<span class="c1">//用来将 Context 中的数据解析出来赋值给 claims
</span><span class="c1"></span>	<span class="c1">//其实是解析出来了 JWT_PAYLOAD 里的内容
</span><span class="c1"></span>	<span class="cm">/*
</span><span class="cm">		func ExtractClaims(c *gin.Context) jwt.MapClaims {
</span><span class="cm">		claims, exists := c.Get(&#34;JWT_PAYLOAD&#34;)
</span><span class="cm">		if !exists {
</span><span class="cm">			return make(jwt.MapClaims)
</span><span class="cm">		}
</span><span class="cm">
</span><span class="cm">		return claims.(jwt.MapClaims)
</span><span class="cm">		}
</span><span class="cm">	*/</span>
	<span class="nx">claims</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">ExtractClaims</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
    <span class="nx">user</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">identityKey</span><span class="p">)</span>
	<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
		<span class="s">&#34;userID&#34;</span><span class="p">:</span>   <span class="nx">claims</span><span class="p">[</span><span class="nx">identityKey</span><span class="p">],</span>
		<span class="s">&#34;userName&#34;</span><span class="p">:</span> <span class="nx">user</span><span class="p">.(</span><span class="o">*</span><span class="nx">User</span><span class="p">).</span><span class="nx">UserName</span><span class="p">,</span>
		<span class="s">&#34;text&#34;</span><span class="p">:</span>     <span class="s">&#34;Hello World.&#34;</span><span class="p">,</span>
	<span class="p">})</span>
<span class="p">}</span>

<span class="c1">// User demo
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">UserName</span>  <span class="kt">string</span>
	<span class="nx">FirstName</span> <span class="kt">string</span>
	<span class="nx">LastName</span>  <span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">port</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Getenv</span><span class="p">(</span><span class="s">&#34;PORT&#34;</span><span class="p">)</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nf">Logger</span><span class="p">())</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">gin</span><span class="p">.</span><span class="nf">Recovery</span><span class="p">())</span>

	<span class="k">if</span> <span class="nx">port</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">port</span> <span class="p">=</span> <span class="s">&#34;8000&#34;</span>
	<span class="p">}</span>

	<span class="c1">// the jwt middleware
</span><span class="c1"></span>	<span class="nx">authMiddleware</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">GinJWTMiddleware</span><span class="p">{</span>
        <span class="c1">//必要项，显示给用户看的域
</span><span class="c1"></span>        <span class="nx">Realm</span><span class="p">:</span>       <span class="s">&#34;test zone&#34;</span><span class="p">,</span>
        <span class="c1">//用来进行签名的密钥，就是加盐用的
</span><span class="c1"></span>        <span class="nx">Key</span><span class="p">:</span>         <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;secret key&#34;</span><span class="p">),</span>
        <span class="c1">//JWT 的有效时间，默认为一小时
</span><span class="c1"></span>        <span class="nx">Timeout</span><span class="p">:</span>     <span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">,</span>
        <span class="c1">//最长的刷新时间，用来给客户端自己刷新 token 用的
</span><span class="c1"></span>        <span class="nx">MaxRefresh</span><span class="p">:</span>  <span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">,</span>
        <span class="c1">//区分身份的key,此key需要每个用户唯一
</span><span class="c1"></span>        <span class="nx">IdentityKey</span><span class="p">:</span> <span class="nx">identityKey</span><span class="p">,</span>
        <span class="c1">//额外需要保存到MapClaims中的值,该函数接收Authenticator返回的interface{},返回jwt.MapClaims,该结构体将保存在context中.IdentityKey的值必须保存在其中
</span><span class="c1"></span>		<span class="nx">PayloadFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">data</span> <span class="kd">interface</span><span class="p">{})</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">MapClaims</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">.(</span><span class="o">*</span><span class="nx">User</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">MapClaims</span><span class="p">{</span>
					<span class="nx">identityKey</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nx">UserName</span><span class="p">,</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">MapClaims</span><span class="p">{}</span>
        <span class="p">},</span>
        <span class="c1">//返回某个用户的身份验证信息,有默认函数
</span><span class="c1"></span>        <span class="c1">// 	if mw.IdentityHandler == nil {
</span><span class="c1"></span>		<span class="c1">// mw.IdentityHandler = func(c *gin.Context) interface{} {
</span><span class="c1"></span>		<span class="c1">// 	claims := ExtractClaims(c)
</span><span class="c1"></span>		<span class="c1">// 	return claims[mw.IdentityKey]
</span><span class="c1"></span>		<span class="c1">// }
</span><span class="c1"></span>        <span class="c1">// }
</span><span class="c1"></span>		<span class="nx">IdentityHandler</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kd">interface</span><span class="p">{}</span> <span class="p">{</span>
			<span class="nx">claims</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">ExtractClaims</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="nx">User</span><span class="p">{</span>
				<span class="nx">UserName</span><span class="p">:</span> <span class="nx">claims</span><span class="p">[</span><span class="nx">identityKey</span><span class="p">].(</span><span class="kt">string</span><span class="p">),</span>
			<span class="p">}</span>
        <span class="p">},</span>
        <span class="c1">//必要项, 这个函数用来判断 User 信息是否合法，如果合法就反馈 true，否则就是 false, 认证的逻辑就在这里
</span><span class="c1"></span>		<span class="nx">Authenticator</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">loginVals</span> <span class="nx">login</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ShouldBind</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">loginVals</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">ErrMissingLoginValues</span>
			<span class="p">}</span>
			<span class="nx">userID</span> <span class="o">:=</span> <span class="nx">loginVals</span><span class="p">.</span><span class="nx">Username</span>
			<span class="nx">password</span> <span class="o">:=</span> <span class="nx">loginVals</span><span class="p">.</span><span class="nx">Password</span>

			<span class="k">if</span> <span class="p">(</span><span class="nx">userID</span> <span class="o">==</span> <span class="s">&#34;admin&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span> <span class="o">==</span> <span class="s">&#34;admin&#34;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">userID</span> <span class="o">==</span> <span class="s">&#34;test&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span> <span class="o">==</span> <span class="s">&#34;test&#34;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">&amp;</span><span class="nx">User</span><span class="p">{</span>
					<span class="nx">UserName</span><span class="p">:</span>  <span class="nx">userID</span><span class="p">,</span>
					<span class="nx">LastName</span><span class="p">:</span>  <span class="s">&#34;Bo-Yi&#34;</span><span class="p">,</span>
					<span class="nx">FirstName</span><span class="p">:</span> <span class="s">&#34;Wu&#34;</span><span class="p">,</span>
				<span class="p">},</span> <span class="kc">nil</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">ErrFailedAuthentication</span>
        <span class="p">},</span>
        <span class="c1">//可选项，用来在 Authenticator 认证成功的基础上进一步的检验用户是否有权限，默认为 success
</span><span class="c1"></span>		<span class="nx">Authorizator</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">data</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">.(</span><span class="o">*</span><span class="nx">User</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">UserName</span> <span class="o">==</span> <span class="s">&#34;admin&#34;</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">true</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="kc">false</span>
        <span class="p">},</span>
        <span class="c1">//可以用来定义如果认证不成功的的处理函数,其中s是Authenticator函数中的err的string形式
</span><span class="c1"></span>		<span class="nx">Unauthorized</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">code</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">message</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
				<span class="s">&#34;code&#34;</span><span class="p">:</span>    <span class="nx">code</span><span class="p">,</span>
				<span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="nx">message</span><span class="p">,</span>
			<span class="p">})</span>
        <span class="p">},</span>
        <span class="c1">//可以用来自定义登录成功后的返回
</span><span class="c1"></span>        <span class="nx">LoginResponse</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">context</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">i</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">s</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">i2</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
				<span class="s">&#34;code&#34;</span>   <span class="p">:</span>    <span class="nx">i</span><span class="p">,</span>
                <span class="s">&#34;message&#34;</span> <span class="p">:</span> <span class="nx">message</span><span class="p">,</span>
                <span class="s">&#34;token&#34;</span> <span class="p">:</span> <span class="nx">s</span><span class="p">,</span>
                <span class="s">&#34;expire&#34;</span> <span class="p">:</span><span class="nx">i2</span><span class="p">.</span><span class="nf">Unix</span><span class="p">(),</span>
			<span class="p">})</span>
		<span class="p">},</span>
        <span class="c1">//这个变量定义了从请求中解析 token 的格式
</span><span class="c1"></span>		<span class="c1">// TokenLookup is a string in the form of &#34;&lt;source&gt;:&lt;name&gt;&#34; that is used
</span><span class="c1"></span>		<span class="c1">// to extract token from the request.
</span><span class="c1"></span>		<span class="c1">// Optional. Default value &#34;header:Authorization&#34;.
</span><span class="c1"></span>		<span class="c1">// Possible values:
</span><span class="c1"></span>		<span class="c1">// - &#34;header:&lt;name&gt;&#34;
</span><span class="c1"></span>		<span class="c1">// - &#34;query:&lt;name&gt;&#34;
</span><span class="c1"></span>		<span class="c1">// - &#34;cookie:&lt;name&gt;&#34;
</span><span class="c1"></span>		<span class="c1">// - &#34;param:&lt;name&gt;&#34;
</span><span class="c1"></span>		<span class="nx">TokenLookup</span><span class="p">:</span> <span class="s">&#34;header: Authorization, query: token, cookie: jwt&#34;</span><span class="p">,</span>
		<span class="c1">// TokenLookup: &#34;query:token&#34;,
</span><span class="c1"></span>		<span class="c1">// TokenLookup: &#34;cookie:token&#34;,
</span><span class="c1"></span>
        <span class="c1">//TokenHeadName 是一个头部信息中的字符串
</span><span class="c1"></span>		<span class="c1">// TokenHeadName is a string in the header. Default value is &#34;Bearer&#34;
</span><span class="c1"></span>		<span class="nx">TokenHeadName</span><span class="p">:</span> <span class="s">&#34;Bearer&#34;</span><span class="p">,</span>

        <span class="c1">// TimeFunc provides the current time. You can override it to use another time value. This is useful for testing or if your server uses a different time zone than your tokens.
</span><span class="c1"></span>        <span class="c1">//这个指定了提供当前时间的函数，也可以自定义
</span><span class="c1"></span>		<span class="nx">TimeFunc</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">,</span>
	<span class="p">})</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="s">&#34;JWT Error:&#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="nx">r</span><span class="p">.</span><span class="nf">POST</span><span class="p">(</span><span class="s">&#34;/login&#34;</span><span class="p">,</span> <span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">LoginHandler</span><span class="p">)</span>

	<span class="nx">r</span><span class="p">.</span><span class="nf">NoRoute</span><span class="p">(</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nf">MiddlewareFunc</span><span class="p">(),</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">claims</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nf">ExtractClaims</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;NoRoute claims: %#v\n&#34;</span><span class="p">,</span> <span class="nx">claims</span><span class="p">)</span>
		<span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&#34;code&#34;</span><span class="p">:</span> <span class="s">&#34;PAGE_NOT_FOUND&#34;</span><span class="p">,</span> <span class="s">&#34;message&#34;</span><span class="p">:</span> <span class="s">&#34;Page not found&#34;</span><span class="p">})</span>
	<span class="p">})</span>

	<span class="nx">auth</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Group</span><span class="p">(</span><span class="s">&#34;/auth&#34;</span><span class="p">)</span>
	<span class="c1">// Refresh time can be longer than token timeout
</span><span class="c1"></span>	<span class="nx">auth</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/refresh_token&#34;</span><span class="p">,</span> <span class="nx">authMiddleware</span><span class="p">.</span><span class="nx">RefreshHandler</span><span class="p">)</span>
	<span class="nx">auth</span><span class="p">.</span><span class="nf">Use</span><span class="p">(</span><span class="nx">authMiddleware</span><span class="p">.</span><span class="nf">MiddlewareFunc</span><span class="p">())</span>
	<span class="p">{</span>
		<span class="nx">auth</span><span class="p">.</span><span class="nf">GET</span><span class="p">(</span><span class="s">&#34;/hello&#34;</span><span class="p">,</span> <span class="nx">helloHandler</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:&#34;</span><span class="o">+</span><span class="nx">port</span><span class="p">,</span> <span class="nx">r</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>参考:
<a href="https://segmentfault.com/a/1190000013297828">https://segmentfault.com/a/1190000013297828</a>
<a href="https://studygolang.com/articles/19838">https://studygolang.com/articles/19838</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
      <li><a href="/tags/jwt/">JWT</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
