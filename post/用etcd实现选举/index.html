<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>用eTcd实现选举 | Forz Blog</title>
<meta name="keywords" content="" />
<meta name="description" content="选举 etcd的选举则需要在我们熟悉它的一系列基本概念后，调动我们充分的想象力： 1、MVCC，key存在版本属性，没被创建时版本号为0； 2、C">
<meta name="author" content="">
<link rel="canonical" href="/post/%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E9%80%89%E4%B8%BE/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="用eTcd实现选举" />
<meta property="og:description" content="选举 etcd的选举则需要在我们熟悉它的一系列基本概念后，调动我们充分的想象力： 1、MVCC，key存在版本属性，没被创建时版本号为0； 2、C" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E9%80%89%E4%B8%BE/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-09-07T16:32:17&#43;00:00" />
<meta property="article:modified_time" content="2019-09-07T16:32:17&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="用eTcd实现选举"/>
<meta name="twitter:description" content="选举 etcd的选举则需要在我们熟悉它的一系列基本概念后，调动我们充分的想象力： 1、MVCC，key存在版本属性，没被创建时版本号为0； 2、C"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "用eTcd实现选举",
      "item": "/post/%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E9%80%89%E4%B8%BE/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "用eTcd实现选举",
  "name": "用eTcd实现选举",
  "description": "选举 etcd的选举则需要在我们熟悉它的一系列基本概念后，调动我们充分的想象力： 1、MVCC，key存在版本属性，没被创建时版本号为0； 2、C",
  "keywords": [
    
  ],
  "articleBody": "选举 etcd的选举则需要在我们熟悉它的一系列基本概念后，调动我们充分的想象力：\n1、MVCC，key存在版本属性，没被创建时版本号为0；\n2、CAS操作，结合MVCC，可以实现竞选逻辑，if(version == 0) set(key,value),通过原子操作，确保只有一台机器能set成功；\n3、Lease租约，可以对key绑定一个租约，租约到期时没预约，这个key就会被回收；\n4、Watch监听，监听key的变化事件，如果key被删除，则重新发起竞选。\n至此，etcd选举的逻辑大体清晰了，etcdctl ctlv3里已经有master选举的实现了，下面针对这部分代码进行简单注释，在最后参考这部分代码实现自己的选举逻辑。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256  // Copyright 2016 The etcd Authors // // Licensed under the Apache License, Version 2.0 (the \"License\"); // you may not use this file except in compliance with the License. // You may obtain a copy of the License at // // http://www.apache.org/licenses/LICENSE-2.0 // // Unless required by applicable law or agreed to in writing, software // distributed under the License is distributed on an \"AS IS\" BASIS, // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. // See the License for the specific language governing permissions and // limitations under the License.  package concurrency import ( \"context\" \"errors\" \"fmt\" v3 \"github.com/coreos/etcd/clientv3\" pb \"github.com/coreos/etcd/etcdserver/etcdserverpb\" \"github.com/coreos/etcd/mvcc/mvccpb\" ) var ( ErrElectionNotLeader = errors.New(\"election: not leader\") ErrElectionNoLeader = errors.New(\"election: no leader\") ) type Election struct { session *Session keyPrefix string leaderKey string leaderRev int64 leaderSession *Session hdr *pb.ResponseHeader } // NewElection returns a new election on a given key prefix. func NewElection(s *Session, pfx string) *Election { return \u0026Election{session: s, keyPrefix: pfx + \"/\"} } // ResumeElection initializes an election with a known leader. func ResumeElection(s *Session, pfx string, leaderKey string, leaderRev int64) *Election { return \u0026Election{ session: s, leaderKey: leaderKey, leaderRev: leaderRev, leaderSession: s, } } /* * etcd的选举是在相应的prefix path下面创建key，该key绑定了lease并根据lease id进行命名， * key创建后就有revision号，这样使得在prefix path下的key也都是按revision有序 */ // Campaign puts a value as eligible for the election. It blocks until // it is elected, an error occurs, or the context is cancelled. func (e *Election) Campaign(ctx context.Context, val string) error { s := e.session client := e.session.Client() //真正创建的key名为：prefix + lease id \tk := fmt.Sprintf(\"%s%x\", e.keyPrefix, s.Lease()) //Txn：transaction，依靠Txn进行创建key的CAS操作，当key不存在时才会成功创建 \ttxn := client.Txn(ctx).If(v3.Compare(v3.CreateRevision(k), \"=\", 0)) txn = txn.Then(v3.OpPut(k, val, v3.WithLease(s.Lease()))) txn = txn.Else(v3.OpGet(k)) resp, err := txn.Commit() if err != nil { return err } e.leaderKey, e.leaderRev, e.leaderSession = k, resp.Header.Revision, s //如果key已存在 \tif !resp.Succeeded { //获取当前的kv \tkv := resp.Responses[0].GetResponseRange().Kvs[0] e.leaderRev = kv.CreateRevision //当key的value与当前value不等时，如果自己为leader，则不用重新执行选举直接设置value； \t//否则报错。 \tif string(kv.Value) != val { //用新值更新领导者的旧值 \tif err = e.Proclaim(ctx, val); err != nil { e.Resign(ctx) return err } } } //一直阻塞，直到确认自己的create revision为当前path中最小，从而确认自己当选为leader \t_, err = waitDeletes(ctx, client, e.keyPrefix, e.leaderRev-1) if err != nil { // clean up in case of context cancel \tselect { case ctx.Done(): e.Resign(client.Ctx()) default: e.leaderSession = nil } return err } e.hdr = resp.Header return nil } // Proclaim lets the leader announce a new value without another election. func (e *Election) Proclaim(ctx context.Context, val string) error { if e.leaderSession == nil { return ErrElectionNotLeader } client := e.session.Client() cmp := v3.Compare(v3.CreateRevision(e.leaderKey), \"=\", e.leaderRev) txn := client.Txn(ctx).If(cmp) txn = txn.Then(v3.OpPut(e.leaderKey, val, v3.WithLease(e.leaderSession.Lease()))) tresp, terr := txn.Commit() if terr != nil { return terr } if !tresp.Succeeded { e.leaderKey = \"\" return ErrElectionNotLeader } e.hdr = tresp.Header return nil } // Resign lets a leader start a new election. func (e *Election) Resign(ctx context.Context) (err error) { if e.leaderSession == nil { return nil } client := e.session.Client() cmp := v3.Compare(v3.CreateRevision(e.leaderKey), \"=\", e.leaderRev) resp, err := client.Txn(ctx).If(cmp).Then(v3.OpDelete(e.leaderKey)).Commit() if err == nil { e.hdr = resp.Header } e.leaderKey = \"\" e.leaderSession = nil return err } // Leader returns the leader value for the current election. func (e *Election) Leader(ctx context.Context) (*v3.GetResponse, error) { client := e.session.Client() resp, err := client.Get(ctx, e.keyPrefix, v3.WithFirstCreate()...) if err != nil { return nil, err } else if len(resp.Kvs) == 0 { // no leader currently elected \treturn nil, ErrElectionNoLeader } return resp, nil } // Observe returns a channel that reliably observes ordered leader proposals // as GetResponse values on every current elected leader key. It will not // necessarily fetch all historical leader updates, but will always post the // most recent leader value. // // The channel closes when the context is canceled or the underlying watcher // is otherwise disrupted. func (e *Election) Observe(ctx context.Context) chan v3.GetResponse { retc := make(chan v3.GetResponse) go e.observe(ctx, retc) return retc } func (e *Election) observe(ctx context.Context, ch chan v3.GetResponse) { client := e.session.Client() defer close(ch) for { resp, err := client.Get(ctx, e.keyPrefix, v3.WithFirstCreate()...) if err != nil { return } var kv *mvccpb.KeyValue var hdr *pb.ResponseHeader if len(resp.Kvs) == 0 { cctx, cancel := context.WithCancel(ctx) // wait for first key put on prefix \topts := []v3.OpOption{v3.WithRev(resp.Header.Revision), v3.WithPrefix()} wch := client.Watch(cctx, e.keyPrefix, opts...) for kv == nil { wr, ok := wch if !ok || wr.Err() != nil { cancel() return } // only accept puts; a delete will make observe() spin \tfor _, ev := range wr.Events { if ev.Type == mvccpb.PUT { hdr, kv = \u0026wr.Header, ev.Kv // may have multiple revs; hdr.rev = the last rev \t// set to kv's rev in case batch has multiple Puts \thdr.Revision = kv.ModRevision break } } } cancel() } else { hdr, kv = resp.Header, resp.Kvs[0] } select { case ch  v3.GetResponse{Header: hdr, Kvs: []*mvccpb.KeyValue{kv}}: case ctx.Done(): return } cctx, cancel := context.WithCancel(ctx) wch := client.Watch(cctx, string(kv.Key), v3.WithRev(hdr.Revision+1)) keyDeleted := false for !keyDeleted { wr, ok := wch if !ok { cancel() return } for _, ev := range wr.Events { if ev.Type == mvccpb.DELETE { keyDeleted = true break } resp.Header = \u0026wr.Header resp.Kvs = []*mvccpb.KeyValue{ev.Kv} select { case ch  *resp: case cctx.Done(): cancel() return } } } cancel() } } // Key returns the leader key if elected, empty string otherwise. func (e *Election) Key() string { return e.leaderKey } // Rev returns the leader key's creation revision, if elected. func (e *Election) Rev() int64 { return e.leaderRev } // Header is the response header from the last successful election proposal. func (e *Election) Header() *pb.ResponseHeader { return e.hdr }   最后给出一个Master选举的demo，模拟的场景：每5s执行一次crontab，且只有leader节点能执行crontab；lease租约有效期设为15s，leader节点异常，最长等待15s，集群会产生新的leader执行crontab。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72  package main import ( \"context\" \"fmt\" \"go.etcd.io/etcd/v3/clientv3\" \"go.etcd.io/etcd/v3/clientv3/concurrency\" \"log\" \"time\" ) const prefix = \"/election-demo\" const prop = \"local\" var leaderFlag bool func main() { endpoints := []string{\"127.0.0.1:2379\"} donec := make(chan struct{}) cli, err := clientv3.New(clientv3.Config{Endpoints: endpoints}) if err != nil { log.Fatal(err) } defer cli.Close() go campaign(cli, prefix, prop) go func() { ticker := time.NewTicker(time.Duration(5) * time.Second) for { select { case ticker.C: doCrontab() } } }() donec } func campaign(c *clientv3.Client, election string, prop string) { for { s, err := concurrency.NewSession(c, concurrency.WithTTL(15)) if err != nil { fmt.Println(err) continue } e := concurrency.NewElection(s, election) ctx := context.TODO() if err = e.Campaign(ctx, prop); err != nil { fmt.Println(err) continue } fmt.Println(\"elect: success\") leaderFlag = true select { case s.Done(): leaderFlag = false fmt.Println(\"elect: expired\") } } } func doCrontab() { if leaderFlag == true { fmt.Println(\"doCrontab\") } }   参考:https://cloud.tencent.com/developer/article/1458456\n",
  "wordCount" : "2164",
  "inLanguage": "zh-cn",
  "datePublished": "2019-09-07T16:32:17Z",
  "dateModified": "2019-09-07T16:32:17Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/%E7%94%A8etcd%E5%AE%9E%E7%8E%B0%E9%80%89%E4%B8%BE/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      用eTcd实现选举
    </h1>
    <div class="post-meta">September 7, 2019
</div>
  </header> 
  <div class="post-content"><h1 id="选举">选举<a hidden class="anchor" aria-hidden="true" href="#选举">#</a></h1>
<p>etcd的选举则需要在我们熟悉它的一系列基本概念后，调动我们充分的想象力：</p>
<p>1、MVCC，key存在版本属性，没被创建时版本号为0；</p>
<p>2、CAS操作，结合MVCC，可以实现竞选逻辑，if(version == 0) set(key,value),通过原子操作，确保只有一台机器能set成功；</p>
<p>3、Lease租约，可以对key绑定一个租约，租约到期时没预约，这个key就会被回收；</p>
<p>4、Watch监听，监听key的变化事件，如果key被删除，则重新发起竞选。</p>
<p>至此，etcd选举的逻辑大体清晰了，etcdctl ctlv3里已经有master选举的实现了，下面针对这部分代码进行简单注释，在最后参考这部分代码实现自己的选举逻辑。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Copyright 2016 The etcd Authors
</span><span class="c1">//
</span><span class="c1">// Licensed under the Apache License, Version 2.0 (the &#34;License&#34;);
</span><span class="c1">// you may not use this file except in compliance with the License.
</span><span class="c1">// You may obtain a copy of the License at
</span><span class="c1">//
</span><span class="c1">//     http://www.apache.org/licenses/LICENSE-2.0
</span><span class="c1">//
</span><span class="c1">// Unless required by applicable law or agreed to in writing, software
</span><span class="c1">// distributed under the License is distributed on an &#34;AS IS&#34; BASIS,
</span><span class="c1">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
</span><span class="c1">// See the License for the specific language governing permissions and
</span><span class="c1">// limitations under the License.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">concurrency</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;errors&#34;</span>
	<span class="s">&#34;fmt&#34;</span>

	<span class="nx">v3</span> <span class="s">&#34;github.com/coreos/etcd/clientv3&#34;</span>
	<span class="nx">pb</span> <span class="s">&#34;github.com/coreos/etcd/etcdserver/etcdserverpb&#34;</span>
	<span class="s">&#34;github.com/coreos/etcd/mvcc/mvccpb&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="p">(</span>
	<span class="nx">ErrElectionNotLeader</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;election: not leader&#34;</span><span class="p">)</span>
	<span class="nx">ErrElectionNoLeader</span>  <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;election: no leader&#34;</span><span class="p">)</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Election</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">session</span> <span class="o">*</span><span class="nx">Session</span>

	<span class="nx">keyPrefix</span> <span class="kt">string</span>

	<span class="nx">leaderKey</span>     <span class="kt">string</span>
	<span class="nx">leaderRev</span>     <span class="kt">int64</span>
	<span class="nx">leaderSession</span> <span class="o">*</span><span class="nx">Session</span>
	<span class="nx">hdr</span>           <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">ResponseHeader</span>
<span class="p">}</span>

<span class="c1">// NewElection returns a new election on a given key prefix.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewElection</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">,</span> <span class="nx">pfx</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">Election</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Election</span><span class="p">{</span><span class="nx">session</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">keyPrefix</span><span class="p">:</span> <span class="nx">pfx</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ResumeElection initializes an election with a known leader.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">ResumeElection</span><span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Session</span><span class="p">,</span> <span class="nx">pfx</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">leaderKey</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">leaderRev</span> <span class="kt">int64</span><span class="p">)</span> <span class="o">*</span><span class="nx">Election</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">Election</span><span class="p">{</span>
		<span class="nx">session</span><span class="p">:</span>       <span class="nx">s</span><span class="p">,</span>
		<span class="nx">leaderKey</span><span class="p">:</span>     <span class="nx">leaderKey</span><span class="p">,</span>
		<span class="nx">leaderRev</span><span class="p">:</span>     <span class="nx">leaderRev</span><span class="p">,</span>
		<span class="nx">leaderSession</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*
</span><span class="cm"> * etcd的选举是在相应的prefix path下面创建key，该key绑定了lease并根据lease id进行命名，
</span><span class="cm"> * key创建后就有revision号，这样使得在prefix path下的key也都是按revision有序
</span><span class="cm"> */</span>
<span class="c1">// Campaign puts a value as eligible for the election. It blocks until
</span><span class="c1">// it is elected, an error occurs, or the context is cancelled.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">Campaign</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">session</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nf">Client</span><span class="p">()</span>
	<span class="c1">//真正创建的key名为：prefix + lease id
</span><span class="c1"></span>	<span class="nx">k</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s%x&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyPrefix</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Lease</span><span class="p">())</span>
	<span class="c1">//Txn：transaction，依靠Txn进行创建key的CAS操作，当key不存在时才会成功创建
</span><span class="c1"></span>	<span class="nx">txn</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Txn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">If</span><span class="p">(</span><span class="nx">v3</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">v3</span><span class="p">.</span><span class="nf">CreateRevision</span><span class="p">(</span><span class="nx">k</span><span class="p">),</span> <span class="s">&#34;=&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
	<span class="nx">txn</span> <span class="p">=</span> <span class="nx">txn</span><span class="p">.</span><span class="nf">Then</span><span class="p">(</span><span class="nx">v3</span><span class="p">.</span><span class="nf">OpPut</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">WithLease</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nf">Lease</span><span class="p">())))</span>
	<span class="nx">txn</span> <span class="p">=</span> <span class="nx">txn</span><span class="p">.</span><span class="nf">Else</span><span class="p">(</span><span class="nx">v3</span><span class="p">.</span><span class="nf">OpGet</span><span class="p">(</span><span class="nx">k</span><span class="p">))</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">txn</span><span class="p">.</span><span class="nf">Commit</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">e</span><span class="p">.</span><span class="nx">leaderKey</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderRev</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderSession</span> <span class="p">=</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Revision</span><span class="p">,</span> <span class="nx">s</span>
	<span class="c1">//如果key已存在
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Succeeded</span> <span class="p">{</span>
		<span class="c1">//获取当前的kv
</span><span class="c1"></span>		<span class="nx">kv</span> <span class="o">:=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Responses</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">GetResponseRange</span><span class="p">().</span><span class="nx">Kvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">leaderRev</span> <span class="p">=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">CreateRevision</span>
		<span class="c1">//当key的value与当前value不等时，如果自己为leader，则不用重新执行选举直接设置value；
</span><span class="c1"></span>		<span class="c1">//否则报错。
</span><span class="c1"></span>		<span class="k">if</span> <span class="nb">string</span><span class="p">(</span><span class="nx">kv</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">val</span> <span class="p">{</span>
			<span class="c1">//用新值更新领导者的旧值
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Proclaim</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">val</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">e</span><span class="p">.</span><span class="nf">Resign</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
				<span class="k">return</span> <span class="nx">err</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="c1">//一直阻塞，直到确认自己的create revision为当前path中最小，从而确认自己当选为leader
</span><span class="c1"></span>	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">waitDeletes</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">client</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyPrefix</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderRev</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// clean up in case of context cancel
</span><span class="c1"></span>		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
			<span class="nx">e</span><span class="p">.</span><span class="nf">Resign</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nf">Ctx</span><span class="p">())</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="nx">e</span><span class="p">.</span><span class="nx">leaderSession</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">e</span><span class="p">.</span><span class="nx">hdr</span> <span class="p">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Proclaim lets the leader announce a new value without another election.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">Proclaim</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderSession</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">ErrElectionNotLeader</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nf">Client</span><span class="p">()</span>
	<span class="nx">cmp</span> <span class="o">:=</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">v3</span><span class="p">.</span><span class="nf">CreateRevision</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">leaderKey</span><span class="p">),</span> <span class="s">&#34;=&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderRev</span><span class="p">)</span>
	<span class="nx">txn</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Txn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">If</span><span class="p">(</span><span class="nx">cmp</span><span class="p">)</span>
	<span class="nx">txn</span> <span class="p">=</span> <span class="nx">txn</span><span class="p">.</span><span class="nf">Then</span><span class="p">(</span><span class="nx">v3</span><span class="p">.</span><span class="nf">OpPut</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">leaderKey</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">WithLease</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">leaderSession</span><span class="p">.</span><span class="nf">Lease</span><span class="p">())))</span>
	<span class="nx">tresp</span><span class="p">,</span> <span class="nx">terr</span> <span class="o">:=</span> <span class="nx">txn</span><span class="p">.</span><span class="nf">Commit</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">terr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">terr</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">tresp</span><span class="p">.</span><span class="nx">Succeeded</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">leaderKey</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
		<span class="k">return</span> <span class="nx">ErrElectionNotLeader</span>
	<span class="p">}</span>

	<span class="nx">e</span><span class="p">.</span><span class="nx">hdr</span> <span class="p">=</span> <span class="nx">tresp</span><span class="p">.</span><span class="nx">Header</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Resign lets a leader start a new election.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">Resign</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderSession</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nf">Client</span><span class="p">()</span>
	<span class="nx">cmp</span> <span class="o">:=</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">v3</span><span class="p">.</span><span class="nf">CreateRevision</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">leaderKey</span><span class="p">),</span> <span class="s">&#34;=&#34;</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderRev</span><span class="p">)</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Txn</span><span class="p">(</span><span class="nx">ctx</span><span class="p">).</span><span class="nf">If</span><span class="p">(</span><span class="nx">cmp</span><span class="p">).</span><span class="nf">Then</span><span class="p">(</span><span class="nx">v3</span><span class="p">.</span><span class="nf">OpDelete</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">leaderKey</span><span class="p">)).</span><span class="nf">Commit</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">hdr</span> <span class="p">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span>
	<span class="p">}</span>
	<span class="nx">e</span><span class="p">.</span><span class="nx">leaderKey</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
	<span class="nx">e</span><span class="p">.</span><span class="nx">leaderSession</span> <span class="p">=</span> <span class="kc">nil</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Leader returns the leader value for the current election.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">Leader</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">v3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nf">Client</span><span class="p">()</span>
	<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyPrefix</span><span class="p">,</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">WithFirstCreate</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// no leader currently elected
</span><span class="c1"></span>		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrElectionNoLeader</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">resp</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Observe returns a channel that reliably observes ordered leader proposals
</span><span class="c1">// as GetResponse values on every current elected leader key. It will not
</span><span class="c1">// necessarily fetch all historical leader updates, but will always post the
</span><span class="c1">// most recent leader value.
</span><span class="c1">//
</span><span class="c1">// The channel closes when the context is canceled or the underlying watcher
</span><span class="c1">// is otherwise disrupted.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">Observe</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">GetResponse</span> <span class="p">{</span>
	<span class="nx">retc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">)</span>
	<span class="k">go</span> <span class="nx">e</span><span class="p">.</span><span class="nf">observe</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">retc</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">retc</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">observe</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">ch</span> <span class="kd">chan</span><span class="o">&lt;-</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nf">Client</span><span class="p">()</span>

	<span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">resp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyPrefix</span><span class="p">,</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">WithFirstCreate</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="kd">var</span> <span class="nx">kv</span> <span class="o">*</span><span class="nx">mvccpb</span><span class="p">.</span><span class="nx">KeyValue</span>
		<span class="kd">var</span> <span class="nx">hdr</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">ResponseHeader</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">cctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
			<span class="c1">// wait for first key put on prefix
</span><span class="c1"></span>			<span class="nx">opts</span> <span class="o">:=</span> <span class="p">[]</span><span class="nx">v3</span><span class="p">.</span><span class="nx">OpOption</span><span class="p">{</span><span class="nx">v3</span><span class="p">.</span><span class="nf">WithRev</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nx">Revision</span><span class="p">),</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">WithPrefix</span><span class="p">()}</span>
			<span class="nx">wch</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">cctx</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">keyPrefix</span><span class="p">,</span> <span class="nx">opts</span><span class="o">...</span><span class="p">)</span>
			<span class="k">for</span> <span class="nx">kv</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">wr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">wch</span>
				<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="o">||</span> <span class="nx">wr</span><span class="p">.</span><span class="nf">Err</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nf">cancel</span><span class="p">()</span>
					<span class="k">return</span>
				<span class="p">}</span>
				<span class="c1">// only accept puts; a delete will make observe() spin
</span><span class="c1"></span>				<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ev</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">wr</span><span class="p">.</span><span class="nx">Events</span> <span class="p">{</span>
					<span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="nx">mvccpb</span><span class="p">.</span><span class="nx">PUT</span> <span class="p">{</span>
						<span class="nx">hdr</span><span class="p">,</span> <span class="nx">kv</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">wr</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Kv</span>
						<span class="c1">// may have multiple revs; hdr.rev = the last rev
</span><span class="c1"></span>						<span class="c1">// set to kv&#39;s rev in case batch has multiple Puts
</span><span class="c1"></span>						<span class="nx">hdr</span><span class="p">.</span><span class="nx">Revision</span> <span class="p">=</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">ModRevision</span>
						<span class="k">break</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="nf">cancel</span><span class="p">()</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">hdr</span><span class="p">,</span> <span class="nx">kv</span> <span class="p">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
		<span class="p">}</span>

		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">v3</span><span class="p">.</span><span class="nx">GetResponse</span><span class="p">{</span><span class="nx">Header</span><span class="p">:</span> <span class="nx">hdr</span><span class="p">,</span> <span class="nx">Kvs</span><span class="p">:</span> <span class="p">[]</span><span class="o">*</span><span class="nx">mvccpb</span><span class="p">.</span><span class="nx">KeyValue</span><span class="p">{</span><span class="nx">kv</span><span class="p">}}:</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
			<span class="k">return</span>
		<span class="p">}</span>

		<span class="nx">cctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="nx">wch</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Watch</span><span class="p">(</span><span class="nx">cctx</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">kv</span><span class="p">.</span><span class="nx">Key</span><span class="p">),</span> <span class="nx">v3</span><span class="p">.</span><span class="nf">WithRev</span><span class="p">(</span><span class="nx">hdr</span><span class="p">.</span><span class="nx">Revision</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
		<span class="nx">keyDeleted</span> <span class="o">:=</span> <span class="kc">false</span>
		<span class="k">for</span> <span class="p">!</span><span class="nx">keyDeleted</span> <span class="p">{</span>
			<span class="nx">wr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">wch</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
				<span class="nf">cancel</span><span class="p">()</span>
				<span class="k">return</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ev</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">wr</span><span class="p">.</span><span class="nx">Events</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="nx">mvccpb</span><span class="p">.</span><span class="nx">DELETE</span> <span class="p">{</span>
					<span class="nx">keyDeleted</span> <span class="p">=</span> <span class="kc">true</span>
					<span class="k">break</span>
				<span class="p">}</span>
				<span class="nx">resp</span><span class="p">.</span><span class="nx">Header</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">wr</span><span class="p">.</span><span class="nx">Header</span>
				<span class="nx">resp</span><span class="p">.</span><span class="nx">Kvs</span> <span class="p">=</span> <span class="p">[]</span><span class="o">*</span><span class="nx">mvccpb</span><span class="p">.</span><span class="nx">KeyValue</span><span class="p">{</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Kv</span><span class="p">}</span>
				<span class="k">select</span> <span class="p">{</span>
				<span class="k">case</span> <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="o">*</span><span class="nx">resp</span><span class="p">:</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">cctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
					<span class="nf">cancel</span><span class="p">()</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="nf">cancel</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Key returns the leader key if elected, empty string otherwise.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">Key</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderKey</span> <span class="p">}</span>

<span class="c1">// Rev returns the leader key&#39;s creation revision, if elected.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">Rev</span><span class="p">()</span> <span class="kt">int64</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">leaderRev</span> <span class="p">}</span>

<span class="c1">// Header is the response header from the last successful election proposal.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">Election</span><span class="p">)</span> <span class="nf">Header</span><span class="p">()</span> <span class="o">*</span><span class="nx">pb</span><span class="p">.</span><span class="nx">ResponseHeader</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">hdr</span> <span class="p">}</span>


</code></pre></td></tr></table>
</div>
</div><p>最后给出一个Master选举的demo，模拟的场景：每5s执行一次crontab，且只有leader节点能执行crontab；lease租约有效期设为15s，leader节点异常，最长等待15s，集群会产生新的leader执行crontab。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;context&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;go.etcd.io/etcd/v3/clientv3&#34;</span>
	<span class="s">&#34;go.etcd.io/etcd/v3/clientv3/concurrency&#34;</span>
	<span class="s">&#34;log&#34;</span>
	<span class="s">&#34;time&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">prefix</span> <span class="p">=</span> <span class="s">&#34;/election-demo&#34;</span>
<span class="kd">const</span> <span class="nx">prop</span> <span class="p">=</span> <span class="s">&#34;local&#34;</span>

<span class="kd">var</span> <span class="nx">leaderFlag</span> <span class="kt">bool</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">endpoints</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;127.0.0.1:2379&#34;</span><span class="p">}</span>
	<span class="nx">donec</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span>

	<span class="nx">cli</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span><span class="nx">Endpoints</span><span class="p">:</span> <span class="nx">endpoints</span><span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

	<span class="k">go</span> <span class="nf">campaign</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span> <span class="nx">prefix</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span>

	<span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
				<span class="nf">doCrontab</span><span class="p">()</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}()</span>

	<span class="o">&lt;-</span><span class="nx">donec</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">campaign</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span> <span class="nx">election</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">prop</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewSession</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">WithTTL</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="k">continue</span>
		<span class="p">}</span>
		<span class="nx">e</span> <span class="o">:=</span> <span class="nx">concurrency</span><span class="p">.</span><span class="nf">NewElection</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">election</span><span class="p">)</span>
		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>

		<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Campaign</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">prop</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
			<span class="k">continue</span>
		<span class="p">}</span>

		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;elect: success&#34;</span><span class="p">)</span>
		<span class="nx">leaderFlag</span> <span class="p">=</span> <span class="kc">true</span>

		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">s</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
			<span class="nx">leaderFlag</span> <span class="p">=</span> <span class="kc">false</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;elect: expired&#34;</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">doCrontab</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">leaderFlag</span> <span class="o">==</span> <span class="kc">true</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;doCrontab&#34;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>参考:<a href="https://cloud.tencent.com/developer/article/1458456">https://cloud.tencent.com/developer/article/1458456</a></p>


  </div>

  <footer class="post-footer">
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
