<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>性能测试工具wrk介绍 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Forz" /><meta name="description" content="性能测试 专有名词 1、吞吐量（Requests per second） 概念：服务器并发处理能力的量化描述，单位是reqs/s，指的是某个并发用户数下单" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.88.1 with theme even" />


<link rel="canonical" href="/post/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7wrk%E4%BB%8B%E7%BB%8D/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.98f8e47918247c097fa26317cbb567fe9f05503485bf08d8547f5579543303b1.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="性能测试工具wrk介绍" />
<meta property="og:description" content="性能测试 专有名词 1、吞吐量（Requests per second） 概念：服务器并发处理能力的量化描述，单位是reqs/s，指的是某个并发用户数下单" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7wrk%E4%BB%8B%E7%BB%8D/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-09-05T18:12:28+00:00" />
<meta property="article:modified_time" content="2021-09-05T18:12:28+00:00" />

<meta itemprop="name" content="性能测试工具wrk介绍">
<meta itemprop="description" content="性能测试 专有名词 1、吞吐量（Requests per second） 概念：服务器并发处理能力的量化描述，单位是reqs/s，指的是某个并发用户数下单"><meta itemprop="datePublished" content="2021-09-05T18:12:28+00:00" />
<meta itemprop="dateModified" content="2021-09-05T18:12:28+00:00" />
<meta itemprop="wordCount" content="16892">
<meta itemprop="keywords" content="wrk," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="性能测试工具wrk介绍"/>
<meta name="twitter:description" content="性能测试 专有名词 1、吞吐量（Requests per second） 概念：服务器并发处理能力的量化描述，单位是reqs/s，指的是某个并发用户数下单"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Forz Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
      <a class="menu-item-link" href="/">Home</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/post/">Archives</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/tags/">Tags</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/categories/">Categories</a>
    </li>
  </ul>
</nav><div class="docsearch-input__container">
  <input type="search" class="docsearch-input" placeholder="Search" />
</div>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">性能测试工具wrk介绍</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-09-05 </span>
        <div class="post-category">
            <a href="/categories/%E6%B5%8B%E8%AF%95/"> 测试 </a>
            </div>
          <span class="more-meta"> 约 16892 字 </span>
          <span class="more-meta"> 预计阅读 34 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#性能测试">性能测试</a>
      <ul>
        <li><a href="#专有名词">专有名词</a></li>
        <li><a href="#为什么平均值不靠谱">为什么平均值不靠谱</a></li>
        <li><a href="#为什么响应时间latency要和吞吐量thoughput挂钩">为什么响应时间（latency）要和吞吐量（Thoughput）挂钩</a></li>
        <li><a href="#为什么响应时间吞吐量和成功率要挂钩">为什么响应时间吞吐量和成功率要挂钩</a></li>
        <li><a href="#如何严谨地做性能测试">如何严谨地做性能测试</a></li>
      </ul>
    </li>
    <li><a href="#wrk">wrk</a>
      <ul>
        <li><a href="#架构">架构</a></li>
        <li><a href="#基本用法">基本用法</a></li>
        <li><a href="#输出结果">输出结果</a></li>
        <li><a href="#coordinated-omission">Coordinated Omission</a></li>
        <li><a href="#wrk2">wrk2</a></li>
      </ul>
    </li>
    <li><a href="#lua脚本">lua脚本</a>
      <ul>
        <li><a href="#三阶段">三阶段</a></li>
        <li><a href="#变量传递">变量传递</a></li>
        <li><a href="#自定义lua脚本中可访问的变量以及方法">自定义Lua脚本中可访问的变量以及方法</a></li>
        <li><a href="#调用post接口">调用POST接口</a></li>
        <li><a href="#认证后发起请求">认证后发起请求</a></li>
        <li><a href="#发送带随机参数的get请求例子">发送带随机参数的get请求例子</a></li>
        <li><a href="#添加参数txt文件的get请求例子">添加参数txt文件的get请求例子</a></li>
        <li><a href="#添加参数txt文件的post请求例子">添加参数txt文件的post请求例子</a></li>
        <li><a href="#提交不同表单内容例子">提交不同表单内容例子</a></li>
        <li><a href="#访问多个url例子">访问多个url例子</a></li>
        <li><a href="#通用压测脚本">通用压测脚本</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="性能测试">性能测试</h2>
<h3 id="专有名词">专有名词</h3>
<p>1、吞吐量（Requests per second）</p>
<p>概念：服务器并发处理能力的量化描述，单位是reqs/s，指的是某个并发用户数下单位时间内处理的请求数。某个并发用户数下单位时间内能处理的最大请求数，称之为最大吞吐率。 计算公式：总请求数 / 处理完成这些请求数所花费的时间，即 Request per second = Complete requests / Time taken for tests</p>
<p>2、并发连接数（The number of concurrent connections）</p>
<p>概念：某个时刻服务器所接受的请求数目，简单的讲，就是一个会话。</p>
<p>3、并发用户数（The number of concurrent users，Concurrency Level）</p>
<p>概念：要注意区分这个概念和并发连接数之间的区别，一个用户可能同时会产生多个会话，也即连接数。</p>
<p>4、用户平均请求等待时间（Time per request）</p>
<p>计算公式：处理完成所有请求数所花费的时间/ （总请求数 / 并发用户数），即 Time per request = Time taken for tests /（ Complete requests / Concurrency Level）</p>
<p>5、服务器平均请求等待时间（Time per request: across all concurrent requests）</p>
<p>计算公式：处理完成所有请求数所花费的时间 / 总请求数，即 Time taken for / testsComplete requests 可以看到，它是吞吐率的倒数。 同时，它也=用户平均请求等待时间/并发用户数，即 Time per request / Concurrency Level</p>
<h3 id="为什么平均值不靠谱">为什么平均值不靠谱</h3>
<p>关于平均值为什么不靠谱，我相信大家读新闻的时候经常可以看到，平均工资，平均房价，平均支出，等等这样的字眼，你就知道为什么平均值不靠谱了。（这些都是数学游戏，对于理工科的同学来说，天生应该有免疫力）</p>
<p>软件的性能测试也一样，平均数也是不靠谱的，这里可以参看这篇详细的文章《Why Averages Suck and Percentiles are Great》，我在这里简单说一下。</p>
<p>我们知道，性能测试时，测试得到的结果数据不总是一样的，而是有高有低的，如果算平均值就会出现这样的情况，假如，测试了10次，有9次是1ms，而有1次是1s，那么平均数据就是100ms，很明显，这完全不能反应性能测试的情况，也许那1s的请求就是一个不正常的值，是个噪点，应该去掉。所以，我们会在一些评委打分中看到要去掉一个最高分一个最低分，然后再算平均值。</p>
<p>另外，中位数（Mean）可能会比平均数要稍微靠谱一些，所谓中位数的意就是把将一组数据按大小顺序排列，处在最中间位置的一个数叫做这组数据的中位数 ，这意味着至少有50%的数据低于或高于这个中位数。</p>
<p>当然，最为正确的统计做法是用百分比分布统计。也就是英文中的TP – Top Percentile ，TP50的意思在，50%的请求都小于某个值，TP90表示90%的请求小于某个时间。</p>
<p>比如：我们有一组数据：[ 10ms,  1s, 200ms, 100ms]，我们把其从小到大排个序：[10ms, 100ms, 200ms, 1s]，于是我们知道，TP50，就是50%的请求ceil(4<em>0.5)=2时间是小于100ms的，TP90就是90%的请求ceil(4</em>0.9)=4时间小于1s。于是：TP50就是100ms，TP90就是1s。</p>
<p>我以前在路透做的金融系统响应时间的性能测试的要求是这样的，99.9%的请求必须小于1ms，所有的平均时间必须小于1ms。两个条件的限制。</p>
<h3 id="为什么响应时间latency要和吞吐量thoughput挂钩">为什么响应时间（latency）要和吞吐量（Thoughput）挂钩</h3>
<p>系统的性能如果只看吞吐量，不看响应时间是没有意义的。我的系统可以顶10万请求，但是响应时间已经到了5秒钟，这样的系统已经不可用了，这样的吞吐量也是没有意义的。</p>
<p>我们知道，当并发量（吞吐量）上涨的时候，系统会变得越来越不稳定，响应时间的波动也会越来越大，响应时间也会变得越来越慢，而吞吐率也越来越上不去（如下图所示），包括CPU的使用率情况也会如此。所以，当系统变得不稳定的时候，吞吐量已经没有意义了。吞吐量有意义的时候仅当系统稳定的时候。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906160720.png" alt=""></p>
<p>所以，吞吐量的值必需有响应时间来卡。比如：TP99小于100ms的时候，系统可以承载的最大并发数是1000qps。这意味着，我们要不断的在不同的并发数上测试，以找到软件的最稳定时的最大吞吐量。</p>
<h3 id="为什么响应时间吞吐量和成功率要挂钩">为什么响应时间吞吐量和成功率要挂钩</h3>
<p>我们这应该不难理解了，如果请求不成功的话，都还做毛的性能测试。比如，我说我的系统并发可以达到10万，但是失败率是</p>
<p>40%，那么，这10万的并发完全就是一个笑话了。</p>
<p>性能测试的失败率的容忍应该是非常低的。对于一些关键系统，成功请求数必须在100%，一点都不能含糊。</p>
<h3 id="如何严谨地做性能测试">如何严谨地做性能测试</h3>
<p>一般来说，性能测试要统一考虑这么几个因素：Thoughput吞吐量，Latency响应时间，资源利用（CPU/MEM/IO/Bandwidth…），成功率，系统稳定性。</p>
<p>下面的这些性能测试的方式基本上来源自我的老老东家汤森路透，一家做real-time的金融数据系统的公司。</p>
<p>一，你得定义一个系统的响应时间latency，建议是TP99，以及成功率。比如路透的定义：99.9%的响应时间必需在1ms之内，平均响应时间在1ms以内，100%的请求成功。</p>
<p>二，在这个响应时间的限制下，找到最高的吞吐量。测试用的数据，需要有大中小各种尺寸的数据，并可以混合。最好使用生产线上的测试数据。</p>
<p>三，在这个吞吐量做Soak Test，比如：使用第二步测试得到的吞吐量连续7天的不间断的压测系统。然后收集CPU，内存，硬盘/网络IO，等指标，查看系统是否稳定，比如，CPU是平稳的，内存使用也是平稳的。那么，这个值就是系统的性能</p>
<p>四，找到系统的极限值。比如：在成功率100%的情况下（不考虑响应时间的长短），系统能坚持10分钟的吞吐量。</p>
<p>五，做Burst Test。用第二步得到的吞吐量执行5分钟，然后在第四步得到的极限值执行1分钟，再回到第二步的吞吐量执行5钟，再到第四步的权限值执行1分钟，如此往复个一段时间，比如2天。收集系统数据：CPU、内存、硬盘/网络IO等，观察他们的曲线，以及相应的响应时间，确保系统是稳定的。</p>
<p>六、低吞吐量和网络小包的测试。有时候，在低吞吐量的时候，可能会导致latency上升，比如TCP_NODELAY的参数没有开启会导致latency上升（详见TCP的那些事），而网络小包会导致带宽用不满也会导致性能上不去，所以，性能测试还需要根据实际情况有选择的测试一下这两咱场景。</p>
<p>（注：在路透，路透会用第二步得到的吞吐量乘以66.7%来做为系统的软报警线，80%做为系统的硬报警线，而极限值仅仅用来扛突发的peak）</p>
<p>是不是很繁锁？是的，只因为，这是工程，工程是一门科学，科学是严谨的。</p>
<h2 id="wrk">wrk</h2>
<p>介绍</p>
<ul>
<li>wrk 是一个类似 ab(apache bench)、jmeter 的压力测试工具，官方称它为：现代的 HTTP 基准测试工具
用 C 编写的 HTTP 协议压测工具</li>
<li>底层基于 epoll 和 kqueue 实现，使用了多线程和多路复用 IO（非阻塞 IO），利用异步的事件驱动框架，通过很少的线程就可以压出很大的并发量</li>
<li>降低测试工具本身性能开销对测试结果准确性的影响</li>
<li>支持使用 LuaJIT 脚本，可以执行 HTTP 请求生成、响应处理和自定义报告</li>
</ul>
<p>它的定位</p>
<ul>
<li>轻量级性能测试工具</li>
<li>仅支持 HTTP 协议</li>
<li>仅支持单机压测，多机器压测需要每个机器都手动执行一次 wrk 命令</li>
<li>不可取代 Jmeter、LR 等专业性能工具</li>
</ul>
<p>官方 Tips</p>
<ul>
<li>运行 wrk 的机器必须有足够数量的临时端口可用，关闭的 socket 必须快速回收</li>
<li>仅更改 HTTP 方法、路径、添加请求头或正文的用户脚本不会对性能产生影响</li>
<li>每个请求的操作，特别是构建新的 HTTP 请求，以及 response() 的使用将必然减少可以生成的负载量</li>
</ul>
<h3 id="架构">架构</h3>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906201026.png" alt=""></p>
<ul>
<li>在 wrk 里面，每个线程都有自己独立的 Lua 虚拟机和 Event Loop</li>
<li>通过命令行参数 -c 指定的连接数，会平均分给所有线程，每个新建的 socket，都会调用 fcntl 将其设置为 NONBLOCK，即非阻塞，然后托管给 Event Loop</li>
<li>直接使用 redis 的 Event Loop 实现，适配了不同操作系统的实现</li>
<li>启动的时候，每个线程都会新建一个 Lua State，并调用 luaL_dofile 加载命令行参数 -s 指定的 lua 脚本文件</li>
<li>如果没有自定义的 lua 脚本，wrk 默认发送的是 HTTP 1.1 GET 请求，用长连接</li>
</ul>
<h3 id="基本用法">基本用法</h3>
<p>wrk 的安装非常简单，最直接的方式就是从 Github 上下载源代码然后 make 。</p>
<p>其单独无选项和参数运行的输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">Usage</span><span class="o">:</span> <span class="n">wrk</span> <span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">url</span><span class="o">&gt;</span>
  <span class="n">Options</span><span class="o">:</span>
    <span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="o">--</span><span class="n">connections</span> <span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span>  <span class="n">Connections</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">open</span>
    <span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="o">--</span><span class="n">duration</span>    <span class="o">&lt;</span><span class="bp">T</span><span class="o">&gt;</span>  <span class="n">Duration</span> <span class="n">of</span> <span class="n">test</span>
    <span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">threads</span>     <span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span>  <span class="n">Number</span> <span class="n">of</span> <span class="n">threads</span> <span class="n">to</span> <span class="n">use</span>

    <span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="o">--</span><span class="n">script</span>      <span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span>  <span class="n">Load</span> <span class="n">Lua</span> <span class="n">script</span> <span class="n">file</span>
    <span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="o">--</span><span class="n">header</span>      <span class="o">&lt;</span><span class="n">H</span><span class="o">&gt;</span>  <span class="n">Add</span> <span class="n">header</span> <span class="n">to</span> <span class="n">request</span>
        <span class="o">--</span><span class="n">latency</span>          <span class="n">Print</span> <span class="n">latency</span> <span class="n">statistics</span>
        <span class="o">--</span><span class="n">timeout</span>     <span class="o">&lt;</span><span class="bp">T</span><span class="o">&gt;</span>  <span class="n">Socket</span><span class="o">/</span><span class="n">request</span> <span class="n">timeout</span>
    <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="o">--</span><span class="n">version</span>          <span class="n">Print</span> <span class="n">version</span> <span class="n">details</span>

  <span class="n">Numeric</span> <span class="n">arguments</span> <span class="n">may</span> <span class="n">include</span> <span class="n">a</span> <span class="n">SI</span> <span class="nf">unit </span><span class="p">(</span><span class="m">1</span><span class="n">k</span><span class="p">,</span> <span class="m">1</span><span class="n">M</span><span class="p">,</span> <span class="m">1</span><span class="n">G</span><span class="p">)</span>
  <span class="n">Time</span> <span class="n">arguments</span> <span class="n">may</span> <span class="n">include</span> <span class="n">a</span> <span class="n">time</span> <span class="nf">unit </span><span class="p">(</span><span class="m">2</span><span class="n">s</span><span class="p">,</span> <span class="m">2</span><span class="n">m</span><span class="p">,</span> <span class="m">2</span><span class="n">h</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>-c 选项。同时保持打开的连接数，可以理解为并发数，一般在测试过程中，这个值需要使用者不断向上调试，直至 QPS 达到一个临界点，便可认为此时的并发数为系统所能承受的最大并发量；由于服务都有自身的负载极限，也会出现连接数越大QPS越低的情况，这种情况是因为连接数设置的过高，导致待测系统超出自身能承受的负载。</li>
<li>-d 选项。测试的时长；wrk 在开始执行指定的测试计划之后，会启动一个或多个工作线程分别开始在连接上发送请求接收响应，主线程会等待工作线程固定的时间，这个时间就是测试的时长 -d。</li>
<li>-t 选项。测试的并发线程数；wrk 在开始执行指定的测试计划之后，会启动指定数量的工作线程分别开始在连接上发送请求接收响应，每个工作线程会非阻塞地在多个连接上工作固定的时间；每个线程的连接数由 -c 指定的值除以并发线程数确定；每个线程的工作时长由 -d 指定的值确定。一般是依据CPU核数来设定，最大值不要超过2倍CPU核数。</li>
<li>-s 选项。可以使用 Lua 来扩展测试计划，这需要了解 wrk 的 Lua 扩展点。</li>
<li>-H 选项。可以在每一个 HTTP 请求中添加上自定义的请求头，比如 &ldquo;Host: a.b.c.org&rdquo;。</li>
<li>&ndash;latency 选项。不填加此选项，则压测的结果会比较简单；添加此选项之后，压测的结果中会包含请求延时百分位信息。</li>
<li>&ndash;timeout 选项。每个请求的超时设置。</li>
<li>-v 选项。输出当前 wrk 的版本信息并退出。</li>
</ul>
<p>实际上，线程数和并发数没有直接关系,wrk 会为每个线程分配（c/t）个 socket 连接.每个连接会先执行请求动作，然后等待直到收到响应后才会再发送请求，所以每个时间点的并发数大致等于连接数（connection）.所以这里要注意-c和-t连接数和参数的设置，一个线程只能占用一个cpu核，如果还没到cpu的瓶颈，决定qps的是连接处和瓶颈响应时间，举个例子，如果只有一个线程，链接数10，平均响应时间10ms，那么一个链接一秒能过100个请求，所以总共能压出1000qps。当cpu到瓶颈后，不管怎么去调大连接数qps都不会上去，这个时候就需要考虑调大线程数了，利用多核心的资源提升qps。</p>
<p>一般线程数不宜过多，核数的2到4倍足够了，多了反而因为线程切换过多造成效率降低，因为 wrk 不是使用每个连接一个线程的模型，而是通过异步网络 io 提升并发量，所以网络通信不会阻塞线程执行，这也是 wrk 可以用很少的线程模拟大量网路连接的原因。而现在很多性能工具并没有采用这种方式，而是采用提高线程数来实现高并发。所以并发量一旦设的很高，测试机自身压力就很大。测试效果反而下降。</p>
<p>wrk使用了多路复用的技术。多路复用使得用一个线程可以异步发起很多个请求，所以不太好用线程数来控制请求数。但一个http连接同时只能处理一个请求，所以可以按一次请求的latency估算出一个连接可以承载的qps数，调整连接数即可控制压测请求大小<code>qps = 1000/latency * Connectnum</code>。 这里需要注意的是单个线程只能占用一个cpu核心，当cpu到瓶颈时也可能压不上去，需要调整线程数。</p>
<p>另外一个方法，把连接数设置的非常大，让连接数不再是发压的瓶颈，然后调整脚本中的delayTime和线程数，可以精确控制qps。 qps = 1000/delayTime * threadnum</p>
<p>综上，常用的 wrk 命令行如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">./wrk</span> <span class="o">-</span><span class="n">c</span> <span class="m">100</span> <span class="o">-</span><span class="n">d</span> <span class="m">60</span><span class="n">s</span> <span class="o">-</span><span class="n">t</span> <span class="m">16</span> <span class="o">--</span><span class="n">latency</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="m">127.0.0.1</span><span class="o">:</span><span class="m">1993</span><span class="o">/</span><span class="n">instant</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="输出结果">输出结果</h3>
<p>命令 <code>./wrk -c 1700 -d 60s -t 16 --latency &lt;http://127.0.0.1:1993/instant&gt;</code> 的典型输出结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="p">(</span><span class="m">01</span><span class="p">)</span> <span class="n">Running</span> <span class="m">1</span><span class="n">m</span> <span class="n">test</span> <span class="o">@</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="m">127.0.0.1</span><span class="o">:</span><span class="m">1993</span><span class="o">/</span><span class="n">instant</span><span class="o">&gt;</span> <span class="o">//</span>
<span class="p">(</span><span class="m">02</span><span class="p">)</span>   <span class="m">16</span> <span class="n">threads</span> <span class="n">and</span> <span class="m">1700</span> <span class="nf">connections
</span><span class="nf"></span><span class="p">(</span><span class="m">03</span><span class="p">)</span>   <span class="n">Thread</span> <span class="n">Stats</span>   <span class="n">Avg</span>      <span class="n">Stdev</span>     <span class="n">Max</span>   <span class="o">+/-</span> <span class="nf">Stdev
</span><span class="nf"></span><span class="p">(</span><span class="m">04</span><span class="p">)</span>     <span class="n">Latency</span>    <span class="m">28.51</span><span class="n">ms</span>   <span class="m">11.92</span><span class="n">ms</span> <span class="m">688.79</span><span class="n">ms</span>   <span class="m">96.20</span><span class="o">%
</span><span class="o">(05)     Req/Sec     3.65k   542.74    14.77k    87.77%</span>
<span class="p">(</span><span class="m">06</span><span class="p">)</span>   <span class="n">Latency</span> <span class="nf">Distribution
</span><span class="nf"></span><span class="p">(</span><span class="m">07</span><span class="p">)</span>      <span class="m">50</span><span class="o">%   27.86ms
</span><span class="o">(08)      75%</span>   <span class="m">29.95</span><span class="nf">ms
</span><span class="nf"></span><span class="p">(</span><span class="m">09</span><span class="p">)</span>      <span class="m">90</span><span class="o">%   32.71ms
</span><span class="o">(10)      99%</span>   <span class="m">46.93</span><span class="nf">ms
</span><span class="nf"></span><span class="p">(</span><span class="m">11</span><span class="p">)</span>   <span class="m">3491898</span> <span class="n">requests</span> <span class="n">in</span> <span class="m">1.00</span><span class="n">m</span><span class="p">,</span> <span class="m">272.70</span><span class="n">MB</span> <span class="nf">read
</span><span class="nf"></span><span class="p">(</span><span class="m">12</span><span class="p">)</span>   <span class="n">Socket</span> <span class="n">errors</span><span class="o">:</span> <span class="n">connect</span> <span class="m">0</span><span class="p">,</span> <span class="n">read</span> <span class="m">0</span><span class="p">,</span> <span class="n">write</span> <span class="m">0</span><span class="p">,</span> <span class="n">timeout</span> <span class="m">435</span>
<span class="p">(</span><span class="m">13</span><span class="p">)</span> <span class="n">Requests</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>  <span class="m">58184.19</span>
<span class="p">(</span><span class="m">14</span><span class="p">)</span> <span class="n">Transfer</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">4.54</span><span class="n">MB</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>第 1 行和第 2 行简要说明了测试计划的情况和参数选项信息。</li>
<li>第 3/4/5 行是线程级别的测试统计结果，包括请求延时（从请求发出到收到响应的耗时）的平均值、标准差、最大值、平均值正负一个标准差范围内的请求占比和每秒请求数（QPS）的对应值。</li>
<li>第 6/7/8/9/10 行是请求延时的百分位统计，分别有 TP50/TP75/TP90/TP99。</li>
<li>第 11/12 行是测试结果的总体信息，如果有的话还会包含 HTTP 的响应不是 20x 的返回码的数据。</li>
<li>第 13 行是总的 QPS。</li>
<li>第 14 行是总的传输数据量。</li>
</ul>
<p>标准差啥意思？标准差如果太大说明样本本身离散程度比较高，有可能系统性能波动较大。</p>
<p>比较重要的部分是 Thread Stats &amp; Latency Distribution &amp; Socket errors。</p>
<h4 id="thread-stats">Thread Stats</h4>
<p>线程级别的统计输出了请求延时和每秒请求数的平均值、最大值和标准差等信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">count</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">limit</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">min</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">max</span><span class="p">;</span>
    <span class="kt">uint64_t</span> <span class="n">data</span><span class="p">[];</span>
<span class="p">}</span> <span class="n">stats</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>统计采样数据存储在一个巨大的数组 data 来存放统计数据。每得到一个采样数据之后，该采样数据被放入数组中，对 count 加一，并且同步更新 min 和 max 的值。由于采样是在多个线程并发进行，所以对上述数据值的更新都是采用了原子操作保护的。</p>
<p>数组的索引是采样值（请求延时即微秒数，请求数即每100毫秒请求数的1000倍），值是相同采样值重复的次数。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">-------------------------------------------------</span>

<span class="o">|</span> <span class="m">0</span> <span class="o">|</span> <span class="kc">...</span> <span class="o">|</span>  <span class="m">101</span> <span class="o">|</span> <span class="kc">...</span> <span class="o">|</span> <span class="m">135</span> <span class="o">|</span> <span class="kc">...</span> <span class="o">|</span>  <span class="m">501</span> <span class="o">|</span> <span class="kc">...</span> <span class="o">|</span>
<span class="o">-------------------------------------------------</span>

<span class="o">|</span> <span class="m">0</span> <span class="o">|</span> <span class="kc">...</span> <span class="o">|</span> <span class="m">2050</span> <span class="o">|</span> <span class="kc">...</span> <span class="o">|</span>  <span class="m">71</span> <span class="o">|</span> <span class="kc">...</span> <span class="o">|</span> <span class="m">1049</span> <span class="o">|</span> <span class="kc">...</span> <span class="o">|</span>
<span class="o">-------------------------------------------------</span>
</code></pre></td></tr></table>
</div>
</div><p>上述的数组第一行是索引，第二行是数值。可能表示的是请求延时的采样，延时为 101us 的请求数有 2050 次，135us 的 71 次，501us 的 1049 次。</p>
<p>在程序初始化时，请求延时对应的采样数组被初始化为请求超时时长的毫秒数（&ndash;timeout 选项指定值，或 2000s 的默认值），请求数对应初始化为 10000000。</p>
<p>所以，Latency 行和 Req/Sec 行的数据分别通过计算上述数据结构的对应值（均值、标准差等）得到。</p>
<p>Latency Distribution</p>
<p>延时分布即请求延时的百分位 Percentile 信息，包括 TP50/TP75/TP90/TP99。</p>
<p>Socket Errors</p>
<p>做性能测试时，需要得到的是在 HTTP 服务返回正确数据的情况下的极限能力；所以，每一次性能测试需要关注请求错误，包括连接失败、读失败、写失败、请求超时、返回码不符合预期等。</p>
<p>&ldquo;Req/Sec&rdquo; VS &ldquo;Requests/sec&rdquo;</p>
<p>在 wrk 的输出中，有两个地方显示的是压测的 QPS: 第 5 行 &ldquo;Req/Sec&rdquo; 和 第 13 行 &ldquo;Requests/sec&rdquo;。</p>
<p>如上所述，&ldquo;Req/Sec&rdquo; 是线程采样数据的统计结果：多个线程分别每 100ms 收集一次累积的请求响应数，该值乘以 1000 放入统计数组中参与最终的统计；假若程序总的 1s 中的请求响应数是 1000，线程数是 4，则统计数组中会出现 4 x 10 = 40 个采样，&ldquo;Req/Sec&rdquo; 是这 40 个采样的统计结果（如均值）。</p>
<p>而 &ldquo;Requests/sec&rdquo; 是简单地将所有的请求响应数除以测试时长，按前一段的描述应该得到 1000。</p>
<p>所以，基本上 &ldquo;Req/Sec&rdquo; 的值是 &ldquo;Requests/sec&rdquo; 值除以线程数；但由于采样误差和其他原因，二者的值会有一个差值存在，不是严格相等。</p>
<h3 id="coordinated-omission">Coordinated Omission</h3>
<p>Coordinated Omission 是性能测试中的一个陷阱，在 Your Load Generator is Probably Lying to You - Take the Red Pill and Find Out Why 和 七层网络性能基准测试中的协调遗漏问题&ndash;Coordinated Omission 中有详细介绍。</p>
<p>简单地说，在性能测试中会有两种情况造成测试得到的请求延时数据不能反应真实的情况。</p>
<p>当测试计划中请求的间隔小于单次请求耗时时，会造成后续的请求会等待被发送。由于 HTTP 是请求响应模型，同一个连接内只有当前一个请求的响应收到之后才能继续发送新的请求，所以如果计划 1s 之内要发送 10 个请求，也就是请求 1 被发送之后 100ms 就需要发送请求 2；但是请求 1 对应的响应 1 过了 150ms 才收到，所以实际上请求 2 在第 150ms 才被发出去；如果再过 150ms 之后请求 2 的响应才收到，则参与统计的采样是请求 1 对应的延时 150ms 和 请求 2 对应的延时 150ms；这看上去很合理，但是如果考虑到实际上请求 2 等待了 50ms 才发送请求的话，请求 2 的延时应该是 200ms。距离来说的话，就是你去麦当劳排队买东西，你买东西的耗时应该是你排队的时间加上店员处理你的订单的时间；如果排队超过 10 分钟，你可能就会不耐烦，尽管有可能店员给你拿一个汉堡你再付钱总共不超过 30s。</p>
<p>当测试计划被其他因素影响，导致请求的延时中包含了其他部分的耗时，比如进程调度或作业挂起等导致的睡眠时间。</p>
<p>wrk 已经于 2015 年添加了对 Coordinated Omission 的修正。</p>
<h3 id="wrk2">wrk2</h3>
<p>wrk2是一个主要基于wrk的HTTP基准测试工具，wrk2经过修改后能够提供稳定的吞吐量负载以及更精确的延时统计，即通过设置参数，wrk2增加了–rate或-R参数设置吞吐量（每秒总请求数）及–u_latency参数显示延时统计。</p>
<h4 id="基本用法-1">基本用法</h4>
<p>wrk2 的安装也非常简单，最直接的方式就是从 Github 上下载源代码然后 make -j8，其编译出来的二进制程序名，如果不特别指定的话，也是 wrk。</p>
<p>其单独无选项和参数运行的输出如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">Usage</span><span class="o">:</span> <span class="n">wrk</span> <span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">url</span><span class="o">&gt;</span>
  <span class="n">Options</span><span class="o">:</span>
    <span class="o">-</span><span class="n">c</span><span class="p">,</span> <span class="o">--</span><span class="n">connections</span> <span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span>  <span class="n">Connections</span> <span class="n">to</span> <span class="n">keep</span> <span class="n">open</span>
    <span class="o">-</span><span class="n">d</span><span class="p">,</span> <span class="o">--</span><span class="n">duration</span>    <span class="o">&lt;</span><span class="bp">T</span><span class="o">&gt;</span>  <span class="n">Duration</span> <span class="n">of</span> <span class="n">test</span>
    <span class="o">-</span><span class="n">t</span><span class="p">,</span> <span class="o">--</span><span class="n">threads</span>     <span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span>  <span class="n">Number</span> <span class="n">of</span> <span class="n">threads</span> <span class="n">to</span> <span class="n">use</span>

    <span class="o">-</span><span class="n">s</span><span class="p">,</span> <span class="o">--</span><span class="n">script</span>      <span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span>  <span class="n">Load</span> <span class="n">Lua</span> <span class="n">script</span> <span class="n">file</span>
    <span class="o">-</span><span class="n">H</span><span class="p">,</span> <span class="o">--</span><span class="n">header</span>      <span class="o">&lt;</span><span class="n">H</span><span class="o">&gt;</span>  <span class="n">Add</span> <span class="n">header</span> <span class="n">to</span> <span class="n">request</span>
    <span class="o">-</span><span class="n">L</span>  <span class="o">--</span><span class="n">latency</span>          <span class="n">Print</span> <span class="n">latency</span> <span class="n">statistics</span>
    <span class="o">-</span><span class="n">U</span>  <span class="o">--</span><span class="n">u_latency</span>        <span class="n">Print</span> <span class="n">uncorrected</span> <span class="n">latency</span> <span class="n">statistics</span>
        <span class="c1"># 设置请求超时时间，大于该时间的请求将被记录==</span>
        <span class="o">--</span><span class="n">timeout</span>     <span class="o">&lt;</span><span class="bp">T</span><span class="o">&gt;</span>  <span class="n">Socket</span><span class="o">/</span><span class="n">request</span> <span class="n">timeout</span>
    <span class="o">-</span><span class="n">B</span><span class="p">,</span> <span class="o">--</span><span class="n">batch_latency</span>    <span class="n">Measure</span> <span class="n">latency</span> <span class="n">of</span> <span class="n">whole</span>
                           <span class="n">batches</span> <span class="n">of</span> <span class="n">pipelined</span> <span class="nf">ops
</span><span class="nf">                           </span><span class="p">(</span><span class="n">as</span> <span class="n">opposed</span> <span class="n">to</span> <span class="n">each</span> <span class="n">op</span><span class="p">)</span>
    <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="o">--</span><span class="n">version</span>          <span class="n">Print</span> <span class="n">version</span> <span class="n">details</span>
    <span class="o">-</span><span class="n">R</span><span class="p">,</span> <span class="o">--</span><span class="n">rate</span>        <span class="o">&lt;</span><span class="bp">T</span><span class="o">&gt;</span>  <span class="n">work</span> <span class="nf">rate </span><span class="p">(</span><span class="n">throughput</span><span class="p">)</span>
                           <span class="n">in</span> <span class="n">requests</span><span class="o">/</span><span class="nf">sec </span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
                           <span class="n">[Required</span> <span class="n">Parameter]</span>

  <span class="n">Numeric</span> <span class="n">arguments</span> <span class="n">may</span> <span class="n">include</span> <span class="n">a</span> <span class="n">SI</span> <span class="nf">unit </span><span class="p">(</span><span class="m">1</span><span class="n">k</span><span class="p">,</span> <span class="m">1</span><span class="n">M</span><span class="p">,</span> <span class="m">1</span><span class="n">G</span><span class="p">)</span>
  <span class="n">Time</span> <span class="n">arguments</span> <span class="n">may</span> <span class="n">include</span> <span class="n">a</span> <span class="n">time</span> <span class="nf">unit </span><span class="p">(</span><span class="m">2</span><span class="n">s</span><span class="p">,</span> <span class="m">2</span><span class="n">m</span><span class="p">,</span> <span class="m">2</span><span class="n">h</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>参数选项基本同 wrk。</p>
<ol>
<li>-L 选项。输出经 HDR 直方图增强后的延时分布信息。打印详细延迟统计</li>
<li>-U 选项。输出经 HDR 直方图增强后的延时分布信息，与 -L 选项不同的是输出未修正 Coordinated Omission 的延时数据。</li>
<li>-R 选项。吞吐率,每个线程每秒完成的请求数，这个数值是wrk2必带的一个参数，在测试过程中也是需要测试人员多次调试，通过不断上调其数值，测试出QPS的临界值及保证服务可用的时延。。</li>
</ol>
<p>与 wrk 不同的是，wrk2 在执行测试计划时需要指定期望的负载，而不是尽全力产生最大的负载。</p>
<h4 id="输出结果-1">输出结果</h4>
<p>命令 <code>./wrk -c 300 -d 60s -t 16 -R 1200 --latency &lt;http://127.0.0.1:1993/instant&gt;</code> 的典型输出结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">Running</span> <span class="m">1</span><span class="n">m</span> <span class="n">test</span> <span class="o">@</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="m">10.145.67.20</span><span class="o">:</span><span class="m">8080</span><span class="o">/</span><span class="n">entry</span><span class="o">/</span><span class="n">rest0</span><span class="o">&gt;</span>
  <span class="m">16</span> <span class="n">threads</span> <span class="n">and</span> <span class="m">300</span> <span class="n">connections</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.816</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.759</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.794</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.802</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.804</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.814</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.788</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.775</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.794</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.808</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.804</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.807</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.816</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.796</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.771</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">calibration</span><span class="o">:</span> <span class="n">mean</span> <span class="n">lat.</span><span class="o">:</span> <span class="m">1.741</span><span class="n">ms</span><span class="p">,</span> <span class="n">rate</span> <span class="n">sampling</span> <span class="n">interval</span><span class="o">:</span> <span class="m">10</span><span class="n">ms</span>
  <span class="n">Thread</span> <span class="n">Stats</span>   <span class="n">Avg</span>      <span class="n">Stdev</span>     <span class="n">Max</span>   <span class="o">+/-</span> <span class="n">Stdev</span> <span class="c1"># 平均值 标准差 最大值 正负一个标准差所占的比例</span>
    <span class="n">Latency</span>     <span class="m">1.84</span><span class="n">ms</span>    <span class="m">1.24</span><span class="n">ms</span>  <span class="m">43.68</span><span class="n">ms</span>   <span class="m">98.54</span><span class="o">%  # 延迟
</span><span class="o">    Req/Sec    77.48    100.86   777.00     66.65%</span>  <span class="c1"># 处理中的请求数</span>
  <span class="n">Latency</span> <span class="nf">Distribution </span><span class="p">(</span><span class="n">HdrHistogram</span> <span class="o">-</span> <span class="n">Recorded</span> <span class="n">Latency</span><span class="p">)</span> <span class="c1"># 延迟分布</span>
 <span class="m">50.000</span><span class="o">%    1.73ms
</span><span class="o"> 75.000%</span>    <span class="m">2.01</span><span class="n">ms</span>
 <span class="m">90.000</span><span class="o">%    2.32ms
</span><span class="o"> 99.000%</span>    <span class="m">3.86</span><span class="n">ms</span>
 <span class="m">99.900</span><span class="o">%   20.09ms  # 99分位的延迟
</span><span class="o"> 99.990%</span>   <span class="m">29.93</span><span class="n">ms</span>
 <span class="m">99.999</span><span class="o">%   40.51ms
</span><span class="o">100.000%</span>   <span class="m">43.71</span><span class="n">ms</span>

  <span class="n">Detailed</span> <span class="n">Percentile</span> <span class="n">spectrum</span><span class="o">:</span>
       <span class="n">Value</span>   <span class="n">Percentile</span>   <span class="n">TotalCount</span> <span class="m">1</span><span class="o">/</span><span class="p">(</span><span class="m">1</span><span class="o">-</span><span class="n">Percentile</span><span class="p">)</span>

       <span class="m">0.813</span>     <span class="m">0.000000</span>            <span class="m">1</span>         <span class="m">1.00</span>
       <span class="m">1.192</span>     <span class="m">0.100000</span>         <span class="m">5995</span>         <span class="m">1.11</span>
       <span class="m">1.356</span>     <span class="m">0.200000</span>        <span class="m">11983</span>         <span class="m">1.25</span>
       <span class="m">1.493</span>     <span class="m">0.300000</span>        <span class="m">18014</span>         <span class="m">1.43</span>
       <span class="m">1.616</span>     <span class="m">0.400000</span>        <span class="m">23995</span>         <span class="m">1.67</span>
       <span class="m">1.734</span>     <span class="m">0.500000</span>        <span class="m">29979</span>         <span class="m">2.00</span>
       <span class="m">1.789</span>     <span class="m">0.550000</span>        <span class="m">32932</span>         <span class="m">2.22</span>
       <span class="m">1.847</span>     <span class="m">0.600000</span>        <span class="m">35990</span>         <span class="m">2.50</span>
       <span class="m">1.899</span>     <span class="m">0.650000</span>        <span class="m">38931</span>         <span class="m">2.86</span>
       <span class="m">1.954</span>     <span class="m">0.700000</span>        <span class="m">41939</span>         <span class="m">3.33</span>
       <span class="m">2.013</span>     <span class="m">0.750000</span>        <span class="m">44904</span>         <span class="m">4.00</span>
       <span class="m">2.049</span>     <span class="m">0.775000</span>        <span class="m">46407</span>         <span class="m">4.44</span>
       <span class="m">2.089</span>     <span class="m">0.800000</span>        <span class="m">47925</span>         <span class="m">5.00</span>
       <span class="m">2.135</span>     <span class="m">0.825000</span>        <span class="m">49438</span>         <span class="m">5.71</span>
       <span class="m">2.185</span>     <span class="m">0.850000</span>        <span class="m">50902</span>         <span class="m">6.67</span>
       <span class="m">2.247</span>     <span class="m">0.875000</span>        <span class="m">52424</span>         <span class="m">8.00</span>
       <span class="m">2.279</span>     <span class="m">0.887500</span>        <span class="m">53144</span>         <span class="m">8.89</span>
       <span class="m">2.317</span>     <span class="m">0.900000</span>        <span class="m">53888</span>        <span class="m">10.00</span>
       <span class="m">2.361</span>     <span class="m">0.912500</span>        <span class="m">54648</span>        <span class="m">11.43</span>
       <span class="m">2.407</span>     <span class="m">0.925000</span>        <span class="m">55396</span>        <span class="m">13.33</span>
       <span class="m">2.463</span>     <span class="m">0.937500</span>        <span class="m">56132</span>        <span class="m">16.00</span>
       <span class="m">2.499</span>     <span class="m">0.943750</span>        <span class="m">56512</span>        <span class="m">17.78</span>
       <span class="m">2.535</span>     <span class="m">0.950000</span>        <span class="m">56888</span>        <span class="m">20.00</span>
       <span class="m">2.579</span>     <span class="m">0.956250</span>        <span class="m">57263</span>        <span class="m">22.86</span>
       <span class="m">2.629</span>     <span class="m">0.962500</span>        <span class="m">57636</span>        <span class="m">26.67</span>
       <span class="m">2.691</span>     <span class="m">0.968750</span>        <span class="m">58010</span>        <span class="m">32.00</span>
       <span class="m">2.727</span>     <span class="m">0.971875</span>        <span class="m">58195</span>        <span class="m">35.56</span>
       <span class="m">2.769</span>     <span class="m">0.975000</span>        <span class="m">58377</span>        <span class="m">40.00</span>
       <span class="m">2.821</span>     <span class="m">0.978125</span>        <span class="m">58563</span>        <span class="m">45.71</span>
       <span class="m">2.891</span>     <span class="m">0.981250</span>        <span class="m">58752</span>        <span class="m">53.33</span>
       <span class="m">3.013</span>     <span class="m">0.984375</span>        <span class="m">58940</span>        <span class="m">64.00</span>
       <span class="m">3.119</span>     <span class="m">0.985938</span>        <span class="m">59032</span>        <span class="m">71.11</span>
       <span class="m">3.279</span>     <span class="m">0.987500</span>        <span class="m">59125</span>        <span class="m">80.00</span>
       <span class="m">3.621</span>     <span class="m">0.989062</span>        <span class="m">59219</span>        <span class="m">91.43</span>
       <span class="m">4.123</span>     <span class="m">0.990625</span>        <span class="m">59311</span>       <span class="m">106.67</span>
       <span class="m">5.139</span>     <span class="m">0.992188</span>        <span class="m">59405</span>       <span class="m">128.00</span>
       <span class="m">5.947</span>     <span class="m">0.992969</span>        <span class="m">59453</span>       <span class="m">142.22</span>
       <span class="m">7.071</span>     <span class="m">0.993750</span>        <span class="m">59498</span>       <span class="m">160.00</span>
       <span class="m">8.367</span>     <span class="m">0.994531</span>        <span class="m">59545</span>       <span class="m">182.86</span>
      <span class="m">10.527</span>     <span class="m">0.995313</span>        <span class="m">59592</span>       <span class="m">213.33</span>
      <span class="m">12.343</span>     <span class="m">0.996094</span>        <span class="m">59639</span>       <span class="m">256.00</span>
      <span class="m">12.999</span>     <span class="m">0.996484</span>        <span class="m">59662</span>       <span class="m">284.44</span>
      <span class="m">13.879</span>     <span class="m">0.996875</span>        <span class="m">59685</span>       <span class="m">320.00</span>
      <span class="m">14.839</span>     <span class="m">0.997266</span>        <span class="m">59710</span>       <span class="m">365.71</span>
      <span class="m">15.943</span>     <span class="m">0.997656</span>        <span class="m">59733</span>       <span class="m">426.67</span>
      <span class="m">17.007</span>     <span class="m">0.998047</span>        <span class="m">59757</span>       <span class="m">512.00</span>
      <span class="m">17.519</span>     <span class="m">0.998242</span>        <span class="m">59767</span>       <span class="m">568.89</span>
      <span class="m">17.999</span>     <span class="m">0.998437</span>        <span class="m">59779</span>       <span class="m">640.00</span>
      <span class="m">18.511</span>     <span class="m">0.998633</span>        <span class="m">59792</span>       <span class="m">731.43</span>
      <span class="m">19.279</span>     <span class="m">0.998828</span>        <span class="m">59802</span>       <span class="m">853.33</span>
      <span class="m">20.367</span>     <span class="m">0.999023</span>        <span class="m">59814</span>      <span class="m">1024.00</span>
      <span class="m">20.687</span>     <span class="m">0.999121</span>        <span class="m">59820</span>      <span class="m">1137.78</span>
      <span class="m">21.215</span>     <span class="m">0.999219</span>        <span class="m">59826</span>      <span class="m">1280.00</span>
      <span class="m">22.751</span>     <span class="m">0.999316</span>        <span class="m">59832</span>      <span class="m">1462.86</span>
      <span class="m">23.583</span>     <span class="m">0.999414</span>        <span class="m">59837</span>      <span class="m">1706.67</span>
      <span class="m">24.095</span>     <span class="m">0.999512</span>        <span class="m">59843</span>      <span class="m">2048.00</span>
      <span class="m">25.231</span>     <span class="m">0.999561</span>        <span class="m">59846</span>      <span class="m">2275.56</span>
      <span class="m">26.159</span>     <span class="m">0.999609</span>        <span class="m">59849</span>      <span class="m">2560.00</span>
      <span class="m">26.527</span>     <span class="m">0.999658</span>        <span class="m">59852</span>      <span class="m">2925.71</span>
      <span class="m">26.895</span>     <span class="m">0.999707</span>        <span class="m">59855</span>      <span class="m">3413.33</span>
      <span class="m">27.343</span>     <span class="m">0.999756</span>        <span class="m">59858</span>      <span class="m">4096.00</span>
      <span class="m">27.791</span>     <span class="m">0.999780</span>        <span class="m">59859</span>      <span class="m">4551.11</span>
      <span class="m">28.767</span>     <span class="m">0.999805</span>        <span class="m">59861</span>      <span class="m">5120.00</span>
      <span class="m">28.895</span>     <span class="m">0.999829</span>        <span class="m">59862</span>      <span class="m">5851.43</span>
      <span class="m">29.439</span>     <span class="m">0.999854</span>        <span class="m">59864</span>      <span class="m">6826.67</span>
      <span class="m">29.519</span>     <span class="m">0.999878</span>        <span class="m">59865</span>      <span class="m">8192.00</span>
      <span class="m">29.935</span>     <span class="m">0.999890</span>        <span class="m">59866</span>      <span class="m">9102.22</span>
      <span class="m">33.567</span>     <span class="m">0.999902</span>        <span class="m">59867</span>     <span class="m">10240.00</span>
      <span class="m">33.567</span>     <span class="m">0.999915</span>        <span class="m">59867</span>     <span class="m">11702.86</span>
      <span class="m">36.991</span>     <span class="m">0.999927</span>        <span class="m">59868</span>     <span class="m">13653.33</span>
      <span class="m">38.047</span>     <span class="m">0.999939</span>        <span class="m">59869</span>     <span class="m">16384.00</span>
      <span class="m">38.047</span>     <span class="m">0.999945</span>        <span class="m">59869</span>     <span class="m">18204.44</span>
      <span class="m">39.871</span>     <span class="m">0.999951</span>        <span class="m">59870</span>     <span class="m">20480.00</span>
      <span class="m">39.871</span>     <span class="m">0.999957</span>        <span class="m">59870</span>     <span class="m">23405.71</span>
      <span class="m">39.871</span>     <span class="m">0.999963</span>        <span class="m">59870</span>     <span class="m">27306.67</span>
      <span class="m">40.511</span>     <span class="m">0.999969</span>        <span class="m">59871</span>     <span class="m">32768.00</span>
      <span class="m">40.511</span>     <span class="m">0.999973</span>        <span class="m">59871</span>     <span class="m">36408.89</span>
      <span class="m">40.511</span>     <span class="m">0.999976</span>        <span class="m">59871</span>     <span class="m">40960.00</span>
      <span class="m">40.511</span>     <span class="m">0.999979</span>        <span class="m">59871</span>     <span class="m">46811.43</span>
      <span class="m">40.511</span>     <span class="m">0.999982</span>        <span class="m">59871</span>     <span class="m">54613.33</span>
      <span class="m">43.711</span>     <span class="m">0.999985</span>        <span class="m">59872</span>     <span class="m">65536.00</span>
      <span class="m">43.711</span>     <span class="m">1.000000</span>        <span class="m">59872</span>          <span class="n">inf</span>

 <span class="n">[Mean</span>    <span class="o">=</span>        <span class="m">1.836</span><span class="p">,</span> <span class="n">StdDeviation</span>   <span class="o">=</span>        <span class="m">1.244</span><span class="n">]</span>

 <span class="n">[Max</span>     <span class="o">=</span>       <span class="m">43.680</span><span class="p">,</span> <span class="n">Total</span> <span class="n">count</span>    <span class="o">=</span>        <span class="m">59872</span><span class="n">]</span>

 <span class="n">[Buckets</span> <span class="o">=</span>           <span class="m">27</span><span class="p">,</span> <span class="n">SubBuckets</span>     <span class="o">=</span>         <span class="m">2048</span><span class="n">]</span>

<span class="o">----------------------------------------------------------</span>

  <span class="m">72016</span> <span class="n">requests</span> <span class="n">in</span> <span class="m">1.00</span><span class="n">m</span><span class="p">,</span> <span class="m">5.62</span><span class="n">MB</span> <span class="n">read</span>
<span class="n">Requests</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>   <span class="m">1200.22</span> <span class="c1"># 平均每秒处理完成1200.22个请求</span>
<span class="n">Transfer</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>     <span class="m">95.91</span><span class="n">KB</span> <span class="c1"># 平均每秒读取数据95.91KB</span>
</code></pre></td></tr></table>
</div>
</div><p>与 wrk 的输出相比，wrk2 的输出多了一些内容：</p>
<ol>
<li>&ldquo;Thread calibration&rdquo; 显示了 10s 的线程预热/修正的数据。</li>
<li>&ldquo;Latency Distribution&rdquo; 部分多了 TP999/TP9999/TP99999/TP100 的数据。</li>
<li>&ldquo;Detailed Percentile spectrum&rdquo; 显示了详细的百分位图谱。</li>
</ol>
<p>综上，如果需要在相同并发度下使用不同的吞吐量QPS对 HTTP 服务进行压测，又或者需要获取更精确的 TP999/TP9999 百分位数据，可以考虑使用 wrk2 代替 wrk 进行性能测试。</p>
<p>我的一个性能测试实践是先使用 wrk 找到一个符合基本要求的并发读（-c 选项）和对应的QPS，然后以这个QPS为上限使用 wrk2 在相同并发度的基础上测试不同吞吐量（-R 选项）下的请求延时。</p>
<h2 id="lua脚本">lua脚本</h2>
<h3 id="三阶段">三阶段</h3>
<p>在wrk中是通过自定义相应的lua方法达到改变wrk行为的目的，wrk的执行分为三个阶段：启动阶段（setup）、运行阶段(running)、结束阶段(done)，每个测试线程，都拥有独立的lua 运行环境。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906202925.png" alt=""></p>
<h4 id="启动阶段">启动阶段</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kr">function</span> <span class="nf">setup</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>function setup(thread)是有参数传入的，传入的内容就是当前的线程，setup是在ip地址解析后并且所有线程初始化后，但没用启动前执行的，所以这个时候你可以对thread的构造做一些自定义。</p>
<p>在脚本文件中实现 setup 方法，wrk 就会在测试线程已经初始化，但还没有启动的时候调用该方法。wrk会为每一个测试线程调用一次 setup 方法，并传入代表测试线程的对象thread 作为参数。setup 方法中可操作该thread 对象，获取信息、存储信息、甚至关闭该线程。</p>
<p>这里一般做一些初始化的工作，例如读取配置文件，加载到内存（不要每次请求的时候读取一遍，这样对测试准确性影响很大）</p>
<p>thread 的一些方法和变量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">thread.addr</span>             <span class="o">-</span> <span class="n">get</span> <span class="ow">or</span> <span class="n">set</span> <span class="n">the</span> <span class="n">thread</span><span class="s1">&#39;s server address，获取或设置服务器地址信息
</span><span class="s1">thread:get(name)        - get the value of a global in the thread&#39;</span><span class="n">s</span> <span class="n">env</span><span class="err">，获取当前线程参数</span>
<span class="n">thread</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="n">set</span> <span class="n">the</span> <span class="n">value</span> <span class="n">of</span> <span class="n">a</span> <span class="n">global</span> <span class="kr">in</span> <span class="n">the</span> <span class="n">thread</span><span class="s1">&#39;s env，设置当前线程参数
</span><span class="s1">thread:stop()           - stop the thread，终止线程
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>只有布尔值、nil值、数字和字符串值或相同的 table 可以通过 get() / set() 进行操作</li>
<li>thread:stop() 只能在线程运行时被调用</li>
</ul>
<h4 id="运行阶段">运行阶段</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="kr">function</span> <span class="nf">delay</span><span class="p">()</span>
<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
<span class="kr">function</span> <span class="nf">response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>init(args):由测试线程调用，只会在进入运行阶段时，调用一次。支持从启动 wrk 的命令中，获取命令行参数,args 是通过命令行传入的参数，通过 &ndash; 指定</li>
<li>delay()：每次发送请求之前调用，可以在这里定制延迟时间，通过返回值（单位毫秒）如:return 1000，即延迟一秒</li>
<li>request():每次发送请求调用，可以对每一次的请求做一些自定义的操作，但是不要在该方法中做耗时的操作,返回一个自定义的 HTTP 请求字符串</li>
<li>response(status, headers, body):在每次收到一个响应时被调用，为提升性能，如果没有定义该方法，为了提升效率，那么wrk不会解析 headers 和 body,这样测试结果会更加准确（解析响应数据是客户端负责的，不能算到服务器处理时间里面）
<ul>
<li>status：响应状态码</li>
<li>headers：响应头</li>
<li>body：响应体</li>
</ul>
</li>
</ul>
<p>官方建议</p>
<ul>
<li>每次构建一个新的请求都很耗时耗资源</li>
<li>当测试高性能服务器时，建议在 init() 中预生成所有请求，并在 request() 中进行快速查找</li>
</ul>
<p>实际使用</p>
<ul>
<li>一般在request()会配合 wrk.format() 方法，动态创建请求</li>
<li>在request()不要执行耗时的代码，否则会影响测试结果准确性</li>
</ul>
<p><code>function init(args)</code>是在线程启动后调用，这里是可以传参数的，在启动命令后加<code>-- arg1 arg2</code>，你就可以在init里通过<code>args[1]</code>, <code>args[2]</code>获取到arg1和arg2，举例如下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">&gt;</span> <span class="n">./wrk</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span> <span class="o">-</span><span class="n">c100</span> <span class="o">-</span><span class="n">t10</span> <span class="o">-</span><span class="n">d100s</span> <span class="o">--</span> <span class="m">10</span> <span class="m">20</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1">-- 输出10</span>
    <span class="n">print</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1">-- 输出20</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>所以这里可以通过这种方式定义更多的自定义参数，然后通过init(args)做解析，后续可以实现多的功能。</p>
<p>function delay()就很简单了，它是为了让你去控制请求发送的之间间隔，如果你想隔10ms发送一次请求，直接return 10就行了，通过delay()可以实现qps大小的控制。</p>
<p>function request()主要功能是为了定制每次请求的参数数据，如果你想构造一些复杂的请求，request()是不得不改的，你可以再request()中修改上文wrk 结构体中的所有值，基本上最长改动的就是wrk.header, wrk.path, wrk.body。这里需要注意，request()是要求有返回值的，其返回值是wrk.format(method, path, headers, body)，wrk.format会将这些参数构造成一个http请求可用的请求数据。</p>
<p>function response(status, headers, body)是在每次wrk收到http请求响应后调用，wrk会将请求响应中的http status、headers和body作为参数传递进来，你可以通过这些参数信息做响应统计、调整压测流量、甚至停止压测……等比较自动化的操作。</p>
<h4 id="结束阶段">结束阶段</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kr">function</span> <span class="nf">done</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>done()方法是在压测结束后wrk会调用一次，即便有多个线程也只调用一次。wrk会将压测过程中的统计信息通过参数传递给你，你可以挑其中有用的部分输出。也可以输出你在response()中自行统计的内容。</p>
<p>wrk已经为你提供了以下的统计信息：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">latency.min</span>              <span class="c1">-- 最小延迟</span>
  <span class="n">latency.max</span>              <span class="c1">-- 最大延迟</span>
  <span class="n">latency.mean</span>             <span class="c1">-- 平均延迟</span>
  <span class="n">latency.stdev</span>            <span class="c1">-- 延迟的标准差</span>
  <span class="n">latency</span><span class="p">:</span><span class="n">percentile</span><span class="p">(</span><span class="mf">99.0</span><span class="p">)</span> <span class="c1">-- 99分位的延迟</span>
  <span class="n">latency</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>               <span class="c1">-- raw value and count</span>

<span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">duration</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span>  <span class="c1">-- 运行的时间ms</span>
  <span class="n">requests</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span>  <span class="c1">-- 总请求数</span>
  <span class="n">bytes</span>    <span class="o">=</span> <span class="n">N</span><span class="p">,</span>  <span class="c1">-- 总过收到的字节数</span>
  <span class="n">errors</span>   <span class="o">=</span> <span class="p">{</span>
    <span class="n">connect</span> <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="c1">-- 链接错误数</span>
    <span class="n">read</span>    <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="c1">-- socket数据读取出错数量</span>
    <span class="n">write</span>   <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="c1">-- socket数据写入出错数量</span>
    <span class="n">status</span>  <span class="o">=</span> <span class="n">N</span><span class="p">,</span> <span class="c1">-- http code 大于399的数量</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="n">N</span>  <span class="c1">-- 超时请求的总数量</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="变量传递">变量传递</h3>
<p>例一:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="c1">-- 启动阶段 （每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">setup</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
   <span class="n">print</span><span class="p">(</span><span class="s2">&#34;----------启动阶段----------------&#34;</span><span class="p">)</span>
   <span class="n">print</span><span class="p">(</span><span class="s2">&#34;setup&#34;</span><span class="p">,</span><span class="n">thread</span><span class="p">)</span>
   <span class="n">print</span><span class="p">(</span><span class="s2">&#34;setup&#34;</span><span class="p">,</span><span class="n">thread.addr</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 运行阶段 （该方法init每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
   <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------运行阶段---------------&#34;</span><span class="p">)</span>
   <span class="n">print</span><span class="p">(</span><span class="s2">&#34;init&#34;</span><span class="p">,</span><span class="n">args</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 这个三个方法每个请求都会调用一次</span>
<span class="kr">function</span> <span class="nf">delay</span><span class="p">()</span>
 <span class="n">print</span><span class="p">(</span><span class="s2">&#34;delay&#34;</span><span class="p">)</span>
 <span class="c1">-- 设置延迟990ms</span>
 <span class="kr">return</span> <span class="mi">990</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;request&#34;</span><span class="p">)</span>
  <span class="c1">-- 这个方法必须要有返回，不然会出错</span>
  <span class="kr">return</span> <span class="n">wrk.request</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;response&#34;</span><span class="p">,</span><span class="n">status</span><span class="p">,</span><span class="n">headers</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 结束阶段</span>
<span class="kr">function</span> <span class="nf">done</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
   <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------结束阶段---------------&#34;</span><span class="p">)</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;done&#34;</span><span class="p">,</span><span class="n">summary</span><span class="p">,</span><span class="n">latency</span><span class="p">,</span><span class="n">requests</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">$</span> <span class="n">wrk</span> <span class="o">-</span><span class="n">c</span> <span class="m">1</span> <span class="o">-</span><span class="n">t</span> <span class="m">1</span> <span class="o">-</span><span class="n">d</span> <span class="m">2</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span> <span class="o">-</span><span class="n">s</span> <span class="n">test.lua</span>
<span class="o">----------</span>启动阶段<span class="o">----------------</span>
<span class="n">setup</span>   <span class="n">userdata</span><span class="o">:</span> <span class="mh">0x0100913d20</span>
<span class="n">setup</span>   <span class="m">14.215.177.39</span><span class="o">:</span><span class="m">443</span>
<span class="o">-----------</span>运行阶段<span class="o">---------------</span>
<span class="n">init</span>    <span class="n">table</span><span class="o">:</span> <span class="mh">0x0100984ba0</span>
<span class="n">request</span>
<span class="n">Running</span> <span class="m">2</span><span class="n">s</span> <span class="n">test</span> <span class="o">@</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span>
  <span class="m">1</span> <span class="n">threads</span> <span class="n">and</span> <span class="m">1</span> <span class="n">connections</span>
<span class="n">delay</span>
<span class="n">request</span>
<span class="n">response</span>        <span class="m">200</span>     <span class="n">table</span><span class="o">:</span> <span class="mh">0x0100985170</span>
<span class="n">delay</span>
  <span class="n">Thread</span> <span class="n">Stats</span>   <span class="n">Avg</span>      <span class="n">Stdev</span>     <span class="n">Max</span>   <span class="o">+/-</span> <span class="n">Stdev</span>
    <span class="n">Latency</span>    <span class="m">41.23</span><span class="n">ms</span>    <span class="m">0.00</span><span class="n">us</span>  <span class="m">41.23</span><span class="n">ms</span>  <span class="m">100.00</span><span class="o">%
</span><span class="o">    Req/Sec     0.00      0.00     0.00    100.00%</span>
  <span class="m">1</span> <span class="n">requests</span> <span class="n">in</span> <span class="m">2.08</span><span class="n">s</span><span class="p">,</span> <span class="m">15.34</span><span class="n">KB</span> <span class="n">read</span>
<span class="n">Requests</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">0.48</span>
<span class="n">Transfer</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">7.39</span><span class="n">KB</span>
<span class="o">-----------</span>结束阶段<span class="o">---------------</span>
<span class="n">done</span>    <span class="n">table</span><span class="o">:</span> <span class="mh">0x0100914ed8</span>     <span class="n">userdata</span><span class="o">:</span> <span class="mh">0x0100915060</span>  <span class="n">userdata</span><span class="o">:</span> <span class="mh">0x0100915168</span>
</code></pre></td></tr></table>
</div>
</div><p>从运行结果中可以看出，先是调用setup启动，然后进行init初始化，然后再调用request获取请求内容，在调用delay获取延迟时间，这里因为delay比较多，所以当response被调用后才开始第二轮</p>
<p>例二:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">threads</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- 启动阶段 （每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">setup</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;----------启动阶段----------------&#34;</span><span class="p">)</span>
    <span class="n">table.insert</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span><span class="n">thread</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 运行阶段 （该方法init每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------运行阶段---------------&#34;</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;init:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 这个三个方法每个请求都会调用一次</span>
<span class="kr">function</span> <span class="nf">delay</span><span class="p">()</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;delay:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
  <span class="c1">-- 设置延迟990ms</span>
  <span class="kr">return</span> <span class="mi">990</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
    <span class="c1">-- 这个方法必须要有返回，不然会出错</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;request:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">wrk.request</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;response:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 结束阶段</span>
<span class="kr">function</span> <span class="nf">done</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------结束阶段---------------&#34;</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;done:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>例二运行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">$</span> <span class="n">wrk</span> <span class="o">-</span><span class="n">c1</span> <span class="o">-</span><span class="n">t1</span> <span class="o">-</span><span class="n">d2</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span> <span class="o">-</span><span class="n">s</span> <span class="n">test.lua</span>
<span class="o">----------</span>启动阶段<span class="o">----------------</span>
<span class="o">-----------</span>运行阶段<span class="o">---------------</span>
<span class="n">init</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>       <span class="m">0</span>
<span class="n">request</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>    <span class="m">0</span>
<span class="n">Running</span> <span class="m">2</span><span class="n">s</span> <span class="n">test</span> <span class="o">@</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span>
  <span class="m">1</span> <span class="n">threads</span> <span class="n">and</span> <span class="m">1</span> <span class="n">connections</span>
<span class="n">delay</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>      <span class="m">0</span>
<span class="n">request</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>    <span class="m">0</span>
<span class="n">response</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>   <span class="m">0</span>
<span class="n">delay</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>      <span class="m">0</span>
  <span class="n">Thread</span> <span class="n">Stats</span>   <span class="n">Avg</span>      <span class="n">Stdev</span>     <span class="n">Max</span>   <span class="o">+/-</span> <span class="n">Stdev</span>
    <span class="n">Latency</span>    <span class="m">46.47</span><span class="n">ms</span>    <span class="m">0.00</span><span class="n">us</span>  <span class="m">46.47</span><span class="n">ms</span>  <span class="m">100.00</span><span class="o">%
</span><span class="o">    Req/Sec     0.00      0.00     0.00    100.00%</span>
  <span class="m">1</span> <span class="n">requests</span> <span class="n">in</span> <span class="m">2.07</span><span class="n">s</span><span class="p">,</span> <span class="m">15.34</span><span class="n">KB</span> <span class="n">read</span>
<span class="n">Requests</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">0.48</span>
<span class="n">Transfer</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">7.40</span><span class="n">KB</span>
<span class="o">-----------</span>结束阶段<span class="o">---------------</span>
<span class="n">done</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>       <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><p>当一个局部变量table内部元素在启动阶段（setup）发生改变时，在运行阶段调用的方法是直接无法获取的，在结束阶段（done）是可以的</p>
<p>例三:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kd">local</span> <span class="n">threads</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- 启动阶段 （每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">setup</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;----------启动阶段----------------&#34;</span><span class="p">)</span>
    <span class="n">table.insert</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span><span class="n">thread</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 运行阶段 （该方法init每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------运行阶段---------------&#34;</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;init:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">222</span>
<span class="kr">end</span>

<span class="c1">-- 这个三个方法每个请求都会调用一次</span>
<span class="kr">function</span> <span class="nf">delay</span><span class="p">()</span>
  <span class="c1">-- 设置延迟990ms</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;delay:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;delay:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
  <span class="kr">return</span> <span class="mi">990</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
    <span class="c1">-- 这个方法必须要有返回，不然会出错</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;request:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;requset:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">wrk.request</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;response:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;response:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 结束阶段</span>
<span class="kr">function</span> <span class="nf">done</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------结束阶段---------------&#34;</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;done:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;done:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>例三运行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">$</span> <span class="n">wrk</span> <span class="o">-</span><span class="n">c1</span> <span class="o">-</span><span class="n">t1</span> <span class="o">-</span><span class="n">d2</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span> <span class="o">-</span><span class="n">s</span> <span class="n">test.lua</span>
<span class="o">----------</span>启动阶段<span class="o">----------------</span>
<span class="o">-----------</span>运行阶段<span class="o">---------------</span>
<span class="n">init</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>       <span class="m">0</span>
<span class="n">request</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>    <span class="m">0</span>
<span class="n">requset</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>        <span class="m">222</span>
<span class="n">Running</span> <span class="m">2</span><span class="n">s</span> <span class="n">test</span> <span class="o">@</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span>
  <span class="m">1</span> <span class="n">threads</span> <span class="n">and</span> <span class="m">1</span> <span class="n">connections</span>
<span class="n">delay</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>      <span class="m">0</span>
<span class="n">delay</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>  <span class="m">222</span>
<span class="n">request</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>    <span class="m">0</span>
<span class="n">requset</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>        <span class="m">222</span>
<span class="n">response</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>   <span class="m">0</span>
<span class="n">response</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>       <span class="m">222</span>
<span class="n">delay</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>      <span class="m">0</span>
<span class="n">delay</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>  <span class="m">222</span>
  <span class="n">Thread</span> <span class="n">Stats</span>   <span class="n">Avg</span>      <span class="n">Stdev</span>     <span class="n">Max</span>   <span class="o">+/-</span> <span class="n">Stdev</span>
    <span class="n">Latency</span>    <span class="m">44.94</span><span class="n">ms</span>    <span class="m">0.00</span><span class="n">us</span>  <span class="m">44.94</span><span class="n">ms</span>  <span class="m">100.00</span><span class="o">%
</span><span class="o">    Req/Sec     0.00      0.00     0.00    100.00%</span>
  <span class="m">1</span> <span class="n">requests</span> <span class="n">in</span> <span class="m">2.06</span><span class="n">s</span><span class="p">,</span> <span class="m">15.34</span><span class="n">KB</span> <span class="n">read</span>
<span class="n">Requests</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">0.48</span>
<span class="n">Transfer</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">7.43</span><span class="n">KB</span>
<span class="o">-----------</span>结束阶段<span class="o">---------------</span>
<span class="n">done</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>       <span class="m">1</span>
<span class="n">done</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>   <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><p>同样在运行阶段对局部变量的改变也在结束阶段获取不到</p>
<p>例四:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kd">local</span> <span class="n">threads</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- 启动阶段 （每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">setup</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;----------启动阶段----------------&#34;</span><span class="p">)</span>
    <span class="n">table.insert</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span><span class="n">thread</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;setup:thrads地址:&#34;</span><span class="p">,</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">111</span>
<span class="kr">end</span>

<span class="c1">-- 运行阶段 （该方法init每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------运行阶段---------------&#34;</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;init:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">,</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">222</span>
<span class="kr">end</span>

<span class="c1">-- 这个三个方法每个请求都会调用一次</span>
<span class="kr">function</span> <span class="nf">delay</span><span class="p">()</span>
  <span class="c1">-- 设置延迟990ms</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;delay:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">,</span><span class="n">threads</span><span class="p">)</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;delay:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
  <span class="kr">return</span> <span class="mi">990</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
    <span class="c1">-- 这个方法必须要有返回，不然会出错</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;request:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">,</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;requset:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">wrk.request</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;response:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">,</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;response:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 结束阶段</span>
<span class="kr">function</span> <span class="nf">done</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------结束阶段---------------&#34;</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;done:threads中的元素个数:&#34;</span><span class="p">,</span><span class="o">#</span><span class="n">threads</span><span class="p">,</span><span class="n">threads</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;done:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>例四运行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">$</span> <span class="n">wrk</span> <span class="o">-</span><span class="n">c1</span> <span class="o">-</span><span class="n">t1</span> <span class="o">-</span><span class="n">d2</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span> <span class="o">-</span><span class="n">s</span> <span class="n">test.lua</span>
<span class="o">----------</span>启动阶段<span class="o">----------------</span>
<span class="n">setup</span><span class="o">:</span><span class="n">thrads地址</span><span class="o">:</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x01032abe30</span>
<span class="o">-----------</span>运行阶段<span class="o">---------------</span>
<span class="n">init</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>       <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010331be30</span>
<span class="n">request</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>    <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010331be30</span>
<span class="n">requset</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>        <span class="m">222</span>
<span class="n">Running</span> <span class="m">2</span><span class="n">s</span> <span class="n">test</span> <span class="o">@</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span>
  <span class="m">1</span> <span class="n">threads</span> <span class="n">and</span> <span class="m">1</span> <span class="n">connections</span>
<span class="n">delay</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>      <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010331be30</span>
<span class="n">delay</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>  <span class="m">222</span>
<span class="n">request</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>    <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010331be30</span>
<span class="n">requset</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>        <span class="m">222</span>
<span class="n">response</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>   <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010331be30</span>
<span class="n">response</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>       <span class="m">222</span>
<span class="n">delay</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>      <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010331be30</span>
<span class="n">delay</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>  <span class="m">222</span>
  <span class="n">Thread</span> <span class="n">Stats</span>   <span class="n">Avg</span>      <span class="n">Stdev</span>     <span class="n">Max</span>   <span class="o">+/-</span> <span class="n">Stdev</span>
    <span class="n">Latency</span>    <span class="m">44.77</span><span class="n">ms</span>    <span class="m">0.00</span><span class="n">us</span>  <span class="m">44.77</span><span class="n">ms</span>  <span class="m">100.00</span><span class="o">%
</span><span class="o">    Req/Sec     0.00      0.00     0.00    100.00%</span>
  <span class="m">1</span> <span class="n">requests</span> <span class="n">in</span> <span class="m">2.05</span><span class="n">s</span><span class="p">,</span> <span class="m">15.34</span><span class="n">KB</span> <span class="n">read</span>
<span class="n">Requests</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">0.49</span>
<span class="n">Transfer</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">7.48</span><span class="n">KB</span>
<span class="o">-----------</span>结束阶段<span class="o">---------------</span>
<span class="n">done</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>       <span class="m">1</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x01032abe30</span>
<span class="n">done</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>   <span class="m">111</span>

</code></pre></td></tr></table>
</div>
</div><p>从运行结果发现其实改变无法察觉是因为他们并不是同一个变量，结束阶段打印的threads地址和运行阶段打印的地址是不一样的，但是启动阶段和结束阶段是一样的</p>
<p>将例四中的threads变量改为全局变量后运行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">$</span> <span class="n">wrk</span> <span class="o">-</span><span class="n">c1</span> <span class="o">-</span><span class="n">t1</span> <span class="o">-</span><span class="n">d2</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span> <span class="o">-</span><span class="n">s</span> <span class="n">test.lua</span>
<span class="o">----------</span>启动阶段<span class="o">----------------</span>
<span class="n">setup</span><span class="o">:</span><span class="n">thrads地址</span><span class="o">:</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x01025bbe30</span>
<span class="o">-----------</span>运行阶段<span class="o">---------------</span>
<span class="n">init</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>       <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010261be30</span>
<span class="n">request</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>    <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010261be30</span>
<span class="n">requset</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>        <span class="m">222</span>
<span class="n">Running</span> <span class="m">2</span><span class="n">s</span> <span class="n">test</span> <span class="o">@</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span>
  <span class="m">1</span> <span class="n">threads</span> <span class="n">and</span> <span class="m">1</span> <span class="n">connections</span>
<span class="n">delay</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>      <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010261be30</span>
<span class="n">delay</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>  <span class="m">222</span>
<span class="n">request</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>    <span class="m">0</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x010261be30</span>
<span class="n">requset</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>        <span class="m">222</span>
  <span class="n">Thread</span> <span class="n">Stats</span>   <span class="n">Avg</span>      <span class="n">Stdev</span>     <span class="n">Max</span>   <span class="o">+/-</span> <span class="n">Stdev</span>
    <span class="n">Latency</span>     <span class="m">0.00</span><span class="n">us</span>    <span class="m">0.00</span><span class="n">us</span>   <span class="m">0.00</span><span class="n">us</span>     <span class="n">nan</span><span class="o">%
</span><span class="o">    Req/Sec     0.00      0.00     0.00       nan%</span>
  <span class="m">0</span> <span class="n">requests</span> <span class="n">in</span> <span class="m">2.04</span><span class="n">s</span><span class="p">,</span> <span class="m">0.00</span><span class="n">B</span> <span class="n">read</span>
<span class="n">Requests</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">0.00</span>
<span class="n">Transfer</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>       <span class="m">0.00</span><span class="n">B</span>
<span class="o">-----------</span>结束阶段<span class="o">---------------</span>
<span class="n">done</span><span class="o">:</span><span class="n">threads中的元素个数</span><span class="o">:</span>       <span class="m">1</span>       <span class="n">table</span><span class="o">:</span> <span class="mh">0x01025bbe30</span>
<span class="n">done</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>   <span class="m">111</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果是一样的，这里我得出一个结论，前面说每个测试线程，都拥有独立的lua 运行环境，这个独立的环境是运行阶段用不同的线程体现，首先是有一个主线程获取命令行中的参数信息，然后解析-t 1后得知要创建一个线程thread，让后会创建一个线程在主线程中将创建的线程thread传入到以主线程环境的setup，当时间-d过了，主线程被唤醒，主线程关闭创建的线程，然后在主线程环境中执行 done方法，因为setup和done都是在主线环境中执行，线程上下文一样所以共享全局和外部定义的局部变量。</p>
<p>如何传递这些变量?这就轮到上面说过的<code>thread:set</code>和<code>thread:get</code>上场了，这两个方法分别是在主线程中将值设置给指定线程中的全局变量池中，用法如下例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="kd">local</span> <span class="n">threads</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1">-- 启动阶段 （每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">setup</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
   <span class="kd">local</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="n">table.insert</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span><span class="n">thread</span><span class="p">)</span>
   <span class="n">thread</span><span class="p">:</span><span class="n">set</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 运行阶段 （该方法init每个线程执行一次）</span>
<span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------运行阶段---------------&#34;</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">111</span>
<span class="kr">end</span>

<span class="c1">-- 这个三个方法每个请求都会调用一次</span>
<span class="kr">function</span> <span class="nf">delay</span><span class="p">()</span>
  <span class="c1">-- 设置延迟990ms</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;delay:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
  <span class="kr">return</span> <span class="mi">990</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
    <span class="c1">-- 这个方法必须要有返回，不然会出错</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;requset:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
    <span class="kr">return</span> <span class="n">wrk.request</span><span class="p">()</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;response:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
<span class="kr">end</span>

<span class="c1">-- 结束阶段</span>
<span class="kr">function</span> <span class="nf">done</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;-----------结束阶段---------------&#34;</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">threads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="kd">local</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">thread</span><span class="p">:</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;counter&#34;</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;done:counter:&#34;</span><span class="p">,</span><span class="n">counter</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>传递运行结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">$</span> <span class="n">wrk</span> <span class="o">-</span><span class="n">c1</span> <span class="o">-</span><span class="n">t1</span> <span class="o">-</span><span class="n">d2</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span> <span class="o">-</span><span class="n">s</span> <span class="n">test.lua</span>
<span class="o">-----------</span>运行阶段<span class="o">---------------</span>
<span class="n">requset</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>        <span class="m">111</span>
<span class="n">Running</span> <span class="m">2</span><span class="n">s</span> <span class="n">test</span> <span class="o">@</span> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span>
  <span class="m">1</span> <span class="n">threads</span> <span class="n">and</span> <span class="m">1</span> <span class="n">connections</span>
<span class="n">delay</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>  <span class="m">111</span>
<span class="n">requset</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>        <span class="m">111</span>
  <span class="n">Thread</span> <span class="n">Stats</span>   <span class="n">Avg</span>      <span class="n">Stdev</span>     <span class="n">Max</span>   <span class="o">+/-</span> <span class="n">Stdev</span>
    <span class="n">Latency</span>     <span class="m">0.00</span><span class="n">us</span>    <span class="m">0.00</span><span class="n">us</span>   <span class="m">0.00</span><span class="n">us</span>     <span class="n">nan</span><span class="o">%
</span><span class="o">    Req/Sec     0.00      0.00     0.00       nan%</span>
  <span class="m">0</span> <span class="n">requests</span> <span class="n">in</span> <span class="m">2.05</span><span class="n">s</span><span class="p">,</span> <span class="m">0.00</span><span class="n">B</span> <span class="n">read</span>
<span class="n">Requests</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>      <span class="m">0.00</span>
<span class="n">Transfer</span><span class="o">/</span><span class="n">sec</span><span class="o">:</span>       <span class="m">0.00</span><span class="n">B</span>
<span class="o">-----------</span>结束阶段<span class="o">---------------</span>
<span class="n">done</span><span class="o">:</span><span class="n">counter</span><span class="o">:</span>   <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><p>那么问题来了，我们如何对多个线程进行同步呢?thread:set是有局限性的，不支持function和thread的传递.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">threadCount</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="kd">local</span> <span class="n">passes</span> <span class="o">=</span> <span class="n">getPass</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">len</span> <span class="o">=</span> <span class="o">#</span><span class="n">passes</span> <span class="o">/</span> <span class="n">threadCount</span>
    <span class="kd">local</span> <span class="n">startIdx</span> <span class="o">=</span> <span class="n">len</span> <span class="o">*</span> <span class="p">(</span><span class="n">id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="kd">local</span> <span class="n">endIdx</span>
    <span class="kr">if</span> <span class="n">threadCount</span> <span class="o">==</span> <span class="n">id</span> <span class="kr">then</span>
        <span class="n">endIdx</span> <span class="o">=</span> <span class="o">#</span><span class="n">passes</span>
    <span class="kr">else</span>
        <span class="n">endIdx</span> <span class="o">=</span> <span class="n">startIdx</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="kr">end</span>

    <span class="n">print</span><span class="p">(</span><span class="n">string.format</span><span class="p">(</span><span class="s2">&#34;id为:%s,%d--&gt;%d&#34;</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">startIdx</span><span class="p">,</span><span class="n">endIdx</span><span class="p">))</span>
    <span class="n">co</span> <span class="o">=</span> <span class="n">coroutine.create</span><span class="p">(</span>
       <span class="kr">function</span><span class="p">()</span>
          <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">startIdx</span><span class="p">,</span><span class="n">endIdx</span> <span class="kr">do</span>
              <span class="n">coroutine.yield</span><span class="p">(</span><span class="n">passes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
          <span class="kr">end</span>
       <span class="kr">end</span>
    <span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">delay</span><span class="p">()</span>
  <span class="kr">return</span> <span class="mi">990</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
    <span class="kd">local</span> <span class="n">status</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">coroutine.resume</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="kr">then</span>

      <span class="n">wrk.thread</span><span class="p">:</span><span class="n">stop</span><span class="p">()</span>
      <span class="kr">return</span>
    <span class="kr">end</span>
    <span class="kd">local</span> <span class="n">path</span> <span class="o">=</span> <span class="s2">&#34;/?query=&#34;</span><span class="o">..</span><span class="n">i</span>
    <span class="kr">return</span> <span class="n">wrk.format</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>

<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;response&#34;</span><span class="p">,</span><span class="n">body</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>结果如下:</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906211417.png" alt=""></p>
<h3 id="自定义lua脚本中可访问的变量以及方法">自定义Lua脚本中可访问的变量以及方法</h3>
<p>变量：wrk</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">wrk</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">scheme</span>  <span class="o">=</span> <span class="s2">&#34;http&#34;</span><span class="p">,</span>
    <span class="n">host</span>    <span class="o">=</span> <span class="s2">&#34;localhost&#34;</span><span class="p">,</span>
    <span class="n">port</span>    <span class="o">=</span> <span class="mi">8080</span><span class="p">,</span>
    <span class="n">method</span>  <span class="o">=</span> <span class="s2">&#34;GET&#34;</span><span class="p">,</span>
    <span class="n">path</span>    <span class="o">=</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="n">body</span>    <span class="o">=</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="n">thread</span>  <span class="o">=</span> <span class="o">&lt;</span><span class="n">userdata</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>以上定义了一个table类型的全局变量，修改该wrk变量，会影响所有请求。</p>
<p>方法：</p>
<ol>
<li>
<p>wrk.fomat</p>
</li>
<li>
<p>wrk.lookup</p>
</li>
<li>
<p>wrk.connect</p>
</li>
</ol>
<p>上面三个方法解释如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kr">function</span> <span class="nc">wrk</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="n">wrk.format</span> <span class="n">returns</span> <span class="n">a</span> <span class="n">HTTP</span> <span class="n">request</span> <span class="n">string</span> <span class="n">containing</span> <span class="n">the</span> <span class="n">passed</span> <span class="n">parameters</span>
    <span class="n">merged</span> <span class="n">with</span> <span class="n">values</span> <span class="n">from</span> <span class="n">the</span> <span class="n">wrk</span> <span class="n">table</span><span class="p">.</span>
    <span class="o">#</span> <span class="err">根据参数和全局变量</span> <span class="n">wrk</span><span class="err">，生成一个</span> <span class="n">HTTP</span> <span class="n">rquest</span> <span class="err">字符串。</span>

<span class="kr">function</span> <span class="nc">wrk</span><span class="p">.</span><span class="nf">lookup</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">service</span><span class="p">)</span>

    <span class="n">wrk.lookup</span> <span class="n">returns</span> <span class="n">a</span> <span class="n">table</span> <span class="n">containing</span> <span class="n">all</span> <span class="n">known</span> <span class="n">addresses</span> <span class="kr">for</span> <span class="n">the</span> <span class="n">host</span>
    <span class="ow">and</span> <span class="n">service</span> <span class="n">pair</span><span class="p">.</span> <span class="n">This</span> <span class="n">corresponds</span> <span class="n">to</span> <span class="n">the</span> <span class="n">POSIX</span> <span class="n">getaddrinfo</span><span class="p">()</span> <span class="kr">function</span><span class="p">.</span>
    <span class="err">#</span> <span class="nf">给定</span> <span class="n">host</span> <span class="err">和</span> <span class="n">service</span><span class="err">（</span><span class="n">port</span><span class="o">/</span><span class="n">well</span> <span class="n">known</span> <span class="n">service</span> <span class="n">name</span><span class="err">），返回所有可用的服务器地址信息。</span>

<span class="kr">function</span> <span class="nc">wrk</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>

    <span class="n">wrk.connect</span> <span class="n">returns</span> <span class="kc">true</span> <span class="kr">if</span> <span class="n">the</span> <span class="n">address</span> <span class="n">can</span> <span class="n">be</span> <span class="n">connected</span> <span class="n">to</span><span class="p">,</span> <span class="n">otherwise</span>
    <span class="n">it</span> <span class="n">returns</span> <span class="kc">false</span><span class="p">.</span> <span class="n">The</span> <span class="n">address</span> <span class="n">must</span> <span class="n">be</span> <span class="n">one</span> <span class="n">returned</span> <span class="n">from</span> <span class="n">wrk.lookup</span><span class="p">().</span>
    <span class="o">#</span> <span class="err">测试给定的服务器地址信息是否可以成功创建连接</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="调用post接口">调用POST接口</h3>
<p>wrk压力测试POST请求&ndash;以本地项目地址为例：<a href="http://192.168.180.126">http://192.168.180.126</a></p>
<p>登录接口：/api/user/login/</p>
<p>请求数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;username&#34;</span><span class="p">:</span><span class="s2">&#34;admin&#34;</span><span class="p">,</span>
    <span class="nt">&#34;password&#34;</span><span class="p">:</span><span class="s2">&#34;admin123456&#34;</span><span class="p">,</span>
    <span class="nt">&#34;code&#34;</span><span class="p">:</span><span class="mi">666</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>1.编写lua脚本，填写post的数据，如login.lua</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">wrk.method</span> <span class="o">=</span> <span class="s2">&#34;POST&#34;</span>
<span class="n">wrk.body</span> <span class="o">=</span> <span class="s1">&#39;{&#34;username&#34;:&#34;admin&#34;,&#34;password&#34;:&#34;admin123456&#34;,&#34;code&#34;:666}&#39;</span>
<span class="n">wrk.headers</span><span class="p">[</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;application/json&#34;</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
   <span class="kr">return</span> <span class="n">wrk.format</span><span class="p">(</span><span class="s2">&#34;POST&#34;</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="kc">nil</span><span class="p">,</span><span class="n">body</span><span class="p">)</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
   <span class="kr">if</span> <span class="n">status</span> <span class="o">~=</span> <span class="mi">200</span> <span class="kr">then</span>
      <span class="n">print</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="n">wrk.thread</span><span class="p">:</span><span class="n">stop</span><span class="p">()</span>
   <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>2.执行wrk，开始压力测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">wrk</span> <span class="o">-</span><span class="n">t</span> <span class="m">16</span> <span class="o">-</span><span class="n">c</span> <span class="m">100</span> <span class="o">-</span><span class="n">d</span> <span class="m">30</span><span class="n">s</span> <span class="o">--</span><span class="n">latency</span> <span class="o">--</span><span class="n">timeout</span> <span class="m">5</span><span class="n">s</span> <span class="o">-</span><span class="n">s</span> <span class="n">login.lua</span> <span class="n">http</span><span class="o">://</span><span class="m">192.168.180.126</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">login</span><span class="o">/</span>
</code></pre></td></tr></table>
</div>
</div><p>压测结果如下：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906213105.png" alt=""></p>
<h3 id="认证后发起请求">认证后发起请求</h3>
<p>请求的接口需要先进行认证，获取token后，才能发起请求，处理如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">token</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="n">path</span>  <span class="o">=</span> <span class="s2">&#34;/auth&#34;</span>

<span class="n">request</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
   <span class="kr">return</span> <span class="n">wrk.format</span><span class="p">(</span><span class="s2">&#34;GET&#34;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="kr">end</span>

<span class="n">response</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
   <span class="kr">if</span> <span class="ow">not</span> <span class="n">token</span> <span class="ow">and</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="kr">then</span>
      <span class="n">token</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s2">&#34;X-Token&#34;</span><span class="p">]</span>
      <span class="n">path</span>  <span class="o">=</span> <span class="s2">&#34;/test&#34;</span>
      <span class="n">wrk.headers</span><span class="p">[</span><span class="s2">&#34;X-Token&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token</span>
   <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的脚本表示，在token为空的情况下，先请求/auth接口来认证，获取token，拿到token以后，将token放置到请求头中，再请求真正需要压测的/test接口。</p>
<h3 id="发送带随机参数的get请求例子">发送带随机参数的get请求例子</h3>
<p>wrk压力测试带随机参数的get请求&ndash;以本地项目地址为例： <code>http://192.168.160.30:8080</code></p>
<p>get接口：<code>/academy/train/course/?id=</code></p>
<p>1.构造不同的get请求，请求带随机参数，则lua脚本如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">request</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">math.random</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&#34;/academy/train/course/?id=&#34;</span><span class="o">..</span><span class="n">num</span>
        <span class="kr">return</span> <span class="n">wrk.format</span><span class="p">(</span><span class="s2">&#34;GET&#34;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>2.执行wrk，开始压力测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">wrk</span> <span class="o">-</span><span class="n">t</span> <span class="m">16</span> <span class="o">-</span><span class="n">c</span> <span class="m">100</span> <span class="o">-</span><span class="n">d</span> <span class="m">30</span><span class="n">s</span> <span class="o">--</span><span class="n">latency</span> <span class="o">--</span><span class="n">timeout</span> <span class="m">5</span><span class="n">s</span> <span class="o">-</span><span class="n">s</span> <span class="n">test.lua</span> <span class="n">http</span><span class="o">://</span><span class="m">192.168.160.30</span><span class="o">:</span><span class="m">8080</span>
</code></pre></td></tr></table>
</div>
</div><p>压测结果如下：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906213813.png" alt=""></p>
<h3 id="添加参数txt文件的get请求例子">添加参数txt文件的get请求例子</h3>
<p>wrk压力测试添加参数txt文件的get请求&ndash;以本地项目地址为例： <a href="http://192.168.160.30:8080">http://192.168.160.30:8080</a></p>
<p>get接口：/academy/train/course/?id=</p>
<p>id.txt文件内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="m">1</span>
<span class="m">2</span>
<span class="m">3</span>
<span class="m">4</span>
<span class="m">5</span>
</code></pre></td></tr></table>
</div>
</div><p>1.添加参数txt文件的get请求，则lua脚本如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">idmap</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="kr">for</span> <span class="n">line</span> <span class="kr">in</span> <span class="n">io.lines</span><span class="p">(</span><span class="s2">&#34;id.txt&#34;</span><span class="p">)</span> <span class="kr">do</span>
                <span class="n">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">idmap</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="kr">end</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">path</span> <span class="o">=</span> <span class="s2">&#34;/academy/train/course/?id=&#34;</span>
        <span class="n">parms</span> <span class="o">=</span> <span class="n">idmap</span><span class="p">[</span><span class="n">counter</span><span class="o">%</span><span class="p">(</span><span class="n">table.getn</span><span class="p">(</span><span class="n">idmap</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">string.format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">parms</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="kr">return</span> <span class="n">wrk.format</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>2.执行wrk，开始压力测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">wrk</span> <span class="o">-</span><span class="n">t</span> <span class="mi">16</span> <span class="o">-</span><span class="n">c</span> <span class="mi">100</span> <span class="o">-</span><span class="n">d</span> <span class="mi">30</span><span class="n">s</span> <span class="c1">--latency --timeout 5s -s id.lua http://192.168.160.30:8080</span>
</code></pre></td></tr></table>
</div>
</div><p>压测结果如下：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906214128.png" alt=""></p>
<h3 id="添加参数txt文件的post请求例子">添加参数txt文件的post请求例子</h3>
<p>wrk压力测试添加参数txt文件的post请求&ndash;以本地项目地址为例：<a href="http://192.168.180.126">http://192.168.180.126</a></p>
<p>登录接口：/api/user/login/</p>
<p>login.txt文件内容如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">admin</span>
</code></pre></td></tr></table>
</div>
</div><p>1.添加参数txt文件的post请求，则lua脚本如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">loginmap</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kr">function</span> <span class="nf">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="kr">for</span> <span class="n">line</span> <span class="kr">in</span> <span class="n">io.lines</span><span class="p">(</span><span class="s2">&#34;login.txt&#34;</span><span class="p">)</span> <span class="kr">do</span>
                <span class="n">loginmap</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="kr">end</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">request</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">body1</span> <span class="o">=</span> <span class="s1">&#39;{&#34;username&#34;:&#34;&#39;</span>
        <span class="kd">local</span> <span class="n">body2</span> <span class="o">=</span> <span class="s1">&#39;&#34;,&#34;password&#34;:&#34;admin123456&#34;,&#34;code&#34;:666}&#39;</span>
        <span class="n">parms</span> <span class="o">=</span> <span class="n">loginmap</span><span class="p">[</span><span class="n">counter</span><span class="o">%</span><span class="p">(</span><span class="n">table.getn</span><span class="p">(</span><span class="n">loginmap</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&#34;/api/user/login/&#34;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&#34;POST&#34;</span>
        <span class="n">wrk.headers</span><span class="p">[</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;application/json&#34;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">body1</span><span class="o">..</span><span class="n">parms</span><span class="o">..</span><span class="n">body2</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="kr">return</span> <span class="n">wrk.format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">wrk.headers</span><span class="p">,</span><span class="n">body</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>2.执行wrk，开始压力测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">wrk</span> <span class="o">-</span><span class="n">t</span> <span class="m">16</span> <span class="o">-</span><span class="n">c</span> <span class="m">100</span> <span class="o">-</span><span class="n">d</span> <span class="m">30</span><span class="n">s</span> <span class="o">--</span><span class="n">latency</span> <span class="o">--</span><span class="n">timeout</span> <span class="m">5</span><span class="n">s</span> <span class="o">-</span><span class="n">s</span> <span class="n">login_txt.lua</span> <span class="n">http</span><span class="o">://</span><span class="m">192.168.180.126</span>
</code></pre></td></tr></table>
</div>
</div><p>压测结果如下：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906214810.png" alt=""></p>
<p>若参数txt中有转义字符，可用如下方法处理：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">parms</span> <span class="o">=</span> <span class="n">string.gsub</span><span class="p">(</span><span class="n">urimap</span><span class="p">[</span><span class="n">counter</span><span class="o">%</span><span class="p">(</span><span class="n">table.getn</span><span class="p">(</span><span class="n">urimap</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="提交不同表单内容例子">提交不同表单内容例子</h3>
<p>wrk压力测试添加参数txt文件的post请求&ndash;以本地项目地址为例：<a href="http://192.168.180.126">http://192.168.180.126</a></p>
<p>登录接口：/api/user/login/</p>
<p>1.提交不同表单内容的post请求，则lua脚本如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="n">wrk.method</span> <span class="o">=</span> <span class="s2">&#34;POST&#34;</span>
<span class="n">wrk.body</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
<span class="n">wrk.headers</span><span class="p">[</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;application/x-www-form-urlencoded&#34;</span>
<span class="n">wrk.path</span> <span class="o">=</span> <span class="s2">&#34;/api/user/login/&#34;</span>

<span class="c1">-- 提交不同表单内容</span>
<span class="kd">local</span> <span class="n">queries</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&#34;username=admin&amp;password=admin123456&amp;code=666&#34;</span><span class="p">,</span>
        <span class="s2">&#34;username=ZY&amp;password=666666aa&amp;code=666&#34;</span>
<span class="p">}</span>

<span class="kd">local</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">request</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
        <span class="kd">local</span> <span class="n">body</span> <span class="o">=</span> <span class="n">wrk.format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">headers</span><span class="p">,</span><span class="n">queries</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="o">#</span><span class="n">queries</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="kr">return</span> <span class="n">body</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><p>2.执行wrk，开始压力测试。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">wrk</span> <span class="o">-</span><span class="n">t</span> <span class="m">16</span> <span class="o">-</span><span class="n">c</span> <span class="m">100</span> <span class="o">-</span><span class="n">d</span> <span class="m">30</span><span class="n">s</span> <span class="o">--</span><span class="n">latency</span> <span class="o">--</span><span class="n">timeout</span> <span class="m">5</span><span class="n">s</span> <span class="o">-</span><span class="n">s</span> <span class="n">queries.lua</span> <span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="m">192.168.180.126</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>压测结果如下：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210906215104.png" alt=""></p>
<h3 id="访问多个url例子">访问多个url例子</h3>
<p>1.需要创建一个文件名为paths.txt，里面每行是一个要测试的url网址，paths.txt如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"> <span class="n">https</span><span class="o">://</span><span class="n">www.baidu.com</span>
 <span class="n">https</span><span class="o">://</span><span class="n">www.csdn.net</span>
</code></pre></td></tr></table>
</div>
</div><p>2.lua脚本如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua">
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">-- Initialize the pseudo random number generator - http://lua-users.org/wiki/MathLibraryTutorial</span>
<span class="n">math.randomseed</span><span class="p">(</span><span class="n">os.time</span><span class="p">())</span>
<span class="n">math.random</span><span class="p">();</span> <span class="n">math.random</span><span class="p">();</span> <span class="n">math.random</span><span class="p">()</span>

<span class="kr">function</span> <span class="nf">file_exists</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">f</span> <span class="o">=</span> <span class="n">io.open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span>
  <span class="kr">if</span> <span class="n">f</span> <span class="kr">then</span> <span class="n">f</span><span class="p">:</span><span class="n">close</span><span class="p">()</span> <span class="kr">end</span>
  <span class="kr">return</span> <span class="n">f</span> <span class="o">~=</span> <span class="kc">nil</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">shuffle</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
  <span class="kd">local</span> <span class="n">n</span> <span class="o">=</span> <span class="o">#</span><span class="n">paths</span>
  <span class="kr">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="kr">do</span>
    <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">math.random</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">math.random</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">paths</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">paths</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">paths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
  <span class="kr">end</span>
  <span class="kr">return</span> <span class="n">paths</span>
<span class="kr">end</span>

<span class="kr">function</span> <span class="nf">non_empty_lines_from</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="kr">if</span> <span class="ow">not</span> <span class="n">file_exists</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="kr">then</span> <span class="kr">return</span> <span class="p">{}</span> <span class="kr">end</span>
  <span class="n">lines</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="kr">for</span> <span class="n">line</span> <span class="kr">in</span> <span class="n">io.lines</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="kr">do</span>
    <span class="kr">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="kr">then</span>
      <span class="n">lines</span><span class="p">[</span><span class="o">#</span><span class="n">lines</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
    <span class="kr">end</span>
  <span class="kr">end</span>
  <span class="kr">return</span> <span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<span class="kr">end</span>

<span class="n">paths</span> <span class="o">=</span> <span class="n">non_empty_lines_from</span><span class="p">(</span><span class="s2">&#34;paths.txt&#34;</span><span class="p">)</span>

<span class="kr">if</span> <span class="o">#</span><span class="n">paths</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="kr">then</span>
  <span class="n">print</span><span class="p">(</span><span class="s2">&#34;multiplepaths: No paths found. You have to create a file paths.txt with one path per line&#34;</span><span class="p">)</span>
  <span class="n">os.exit</span><span class="p">()</span>
<span class="kr">end</span>

<span class="n">print</span><span class="p">(</span><span class="s2">&#34;multiplepaths: Found &#34;</span> <span class="o">..</span> <span class="o">#</span><span class="n">paths</span> <span class="o">..</span> <span class="s2">&#34; paths&#34;</span><span class="p">)</span>

<span class="n">request</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="kr">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="o">#</span><span class="n">paths</span> <span class="kr">then</span>
      <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kr">end</span>
    <span class="kr">return</span> <span class="n">wrk.format</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="通用压测脚本">通用压测脚本</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="kd">local</span> <span class="n">list</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kd">local</span> <span class="n">delaytime</span> <span class="o">=</span> <span class="mi">0</span>             <span class="c1">-- 默认delay是0ms</span>
<span class="kd">local</span> <span class="n">filename</span> <span class="o">=</span> <span class="s2">&#34;reqdata.txt&#34;</span>  <span class="c1">-- 默认请求数据文件</span>

<span class="n">setup</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
    <span class="kr">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="kr">in</span>  <span class="n">pairs</span><span class="p">(</span><span class="n">wrk.addrs</span><span class="p">)</span>
    <span class="kr">do</span>
        <span class="n">print</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="kr">end</span>
<span class="kr">end</span>

<span class="n">init</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="kr">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="kr">then</span>
        <span class="n">delaytime</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>          <span class="c1">-- 启动命令中可以指定延迟时间，如未指定，使用默认文件</span>
    <span class="kr">end</span>
    <span class="kr">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">~=</span> <span class="kc">nil</span><span class="p">)</span> <span class="kr">then</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>           <span class="c1">-- 启动命令中可以指定请求文件目录，如未指定，使用默认文件</span>
    <span class="kr">end</span>
    <span class="n">math.randomseed</span><span class="p">(</span><span class="n">os.time</span><span class="p">())</span>
    <span class="kd">local</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kr">for</span> <span class="n">line</span> <span class="kr">in</span> <span class="n">io.lines</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>   <span class="c1">-- 把请求包体读入后写到list里，方便后续使用</span>
    <span class="kr">do</span>
        <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
    <span class="kr">end</span>
<span class="kr">end</span>

<span class="n">request</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="n">wrk.body</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">math.random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">#</span><span class="n">list</span><span class="p">)]</span>    <span class="c1">-- 随机使用一个包体</span>
    <span class="n">wrk.method</span> <span class="o">=</span> <span class="s2">&#34;POST&#34;</span>
    <span class="n">wrk.scheme</span> <span class="o">=</span> <span class="s2">&#34;http&#34;</span>
    <span class="n">wrk.path</span> <span class="o">=</span> <span class="s2">&#34;/appstore/uploadLogSDK&#34;</span>
    <span class="n">wrk.headers</span><span class="p">[</span><span class="s2">&#34;Content-Type&#34;</span><span class="p">]</span><span class="o">=</span><span class="s2">&#34;application/x-www-form-urlencoded&#34;</span>
    <span class="kr">return</span> <span class="n">wrk.format</span><span class="p">()</span>
<span class="kr">end</span>

<span class="n">delay</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span>
    <span class="kr">return</span> <span class="n">delaytime</span>
<span class="kr">end</span>

<span class="n">response</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>      <span class="c1">--这里我没做特殊统计，只是在调试过程中输出了一些内容</span>
    <span class="c1">--print(status)</span>
    <span class="c1">--print(body)</span>
    <span class="c1">--print(wrk.format(wrk.method, wrk.path, wrk.headers, wrk.body))</span>
    <span class="c1">--wrk.thread:stop()</span>
<span class="kr">end</span>

<span class="n">done</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">latency</span><span class="p">,</span> <span class="n">requests</span><span class="p">)</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&#34;99 latency:&#34;</span><span class="o">..</span><span class="n">latency</span><span class="p">:</span><span class="n">percentile</span><span class="p">(</span><span class="mf">99.0</span><span class="p">))</span>  <span class="c1">-- 这里我只是额外输出了99分位的延时，貌似数据不太对</span>
<span class="kr">end</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<p><a href="https://coolshell.cn/articles/17381.html">性能测试应该怎么做？</a></p>
<p><a href="https://www.wangbo.im/posts/usage-of-benchmarking-tool-wrk-and-wrk2/">Usage of Benchmarking Tool WRK and WRK2</a></p>
<p><a href="https://chende.ren/2021/01/14011523-test-tools.html">常用并发压力测试工具</a></p>
<p><a href="https://www.cnblogs.com/poloyy/p/14870879.html">wrk（1）- 详细使用</a></p>
<p><a href="https://www.jianshu.com/p/5bc2b48bd695">wrk - lua 进阶</a></p>
<p><a href="https://heixuanfeng.blog.csdn.net/article/details/104518674">轻量级性能测试工具wrk - 使用（提升篇）</a></p>
<p><a href="https://heixuanfeng.blog.csdn.net/article/details/104530113">轻量级性能测试工具wrk - 使用（实战篇）</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1777690">Web服务压测神器wrk</a></p>
<p><a href="https://www.cnblogs.com/poloyy/p/14872021.html">wrk（2）- Lua 脚本的使用</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-09-05
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/wrk/">wrk</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/go%E8%AF%AD%E8%A8%80%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E6%8C%87%E5%8D%97/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go语言性能调优指南</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95%E4%B8%8E%E5%93%88%E5%B8%8C%E8%A1%A8/">
            <span class="next-text nav-default">哈希算法与哈希表</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Forz</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>






<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
docsearch({
    apiKey: "b4b9da2eba53aa6dabe4b8ac9e8676e1",
    indexName: "forz.forzvina.com",
    appId: "IAR2EF5L65",
    inputSelector: '.docsearch-input',
    debug: false,
});
</script>
</body>
</html>
