<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go如何生成随机数 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Forz" /><meta name="description" content="math/rand 包 math/rand 包实现了伪随机数生成器 主要方法 （1）func Seed(seed int64) 设置随机种子，不设置则默认Seed(1) （2）func Int() int 返回一个非负的伪随机int值" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.88.1 with theme even" />


<link rel="canonical" href="/post/go%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E6%95%B0/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.98f8e47918247c097fa26317cbb567fe9f05503485bf08d8547f5579543303b1.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Go如何生成随机数" />
<meta property="og:description" content="math/rand 包 math/rand 包实现了伪随机数生成器 主要方法 （1）func Seed(seed int64) 设置随机种子，不设置则默认Seed(1) （2）func Int() int 返回一个非负的伪随机int值" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/go%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E6%95%B0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-01-09T23:44:37+00:00" />
<meta property="article:modified_time" content="2021-01-09T23:44:37+00:00" />

<meta itemprop="name" content="Go如何生成随机数">
<meta itemprop="description" content="math/rand 包 math/rand 包实现了伪随机数生成器 主要方法 （1）func Seed(seed int64) 设置随机种子，不设置则默认Seed(1) （2）func Int() int 返回一个非负的伪随机int值"><meta itemprop="datePublished" content="2021-01-09T23:44:37+00:00" />
<meta itemprop="dateModified" content="2021-01-09T23:44:37+00:00" />
<meta itemprop="wordCount" content="4693">
<meta itemprop="keywords" content="Go," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go如何生成随机数"/>
<meta name="twitter:description" content="math/rand 包 math/rand 包实现了伪随机数生成器 主要方法 （1）func Seed(seed int64) 设置随机种子，不设置则默认Seed(1) （2）func Int() int 返回一个非负的伪随机int值"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Forz Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
      <a class="menu-item-link" href="/">Home</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/post/">Archives</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/tags/">Tags</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/categories/">Categories</a>
    </li>
  </ul>
</nav><div class="docsearch-input__container">
  <input type="search" class="docsearch-input" placeholder="Search" />
</div>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go如何生成随机数</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-01-09 </span>
        <div class="post-category">
            <a href="/categories/go/"> Go </a>
            </div>
          <span class="more-meta"> 约 4693 字 </span>
          <span class="more-meta"> 预计阅读 10 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#mathrand-包">math/rand 包</a>
      <ul>
        <li><a href="#主要方法">主要方法</a></li>
        <li><a href="#代码示例">代码示例</a></li>
        <li><a href="#应用场景">应用场景</a></li>
        <li><a href="#源码剖析">源码剖析</a></li>
        <li><a href="#我遇到的那些坑">我遇到的那些坑</a></li>
        <li><a href="#rand-未来期望">rand 未来期望</a></li>
      </ul>
    </li>
    <li><a href="#cryptorand-包">crypto/rand 包</a>
      <ul>
        <li><a href="#主要方法-1">主要方法</a></li>
        <li><a href="#代码示例-1">代码示例</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="mathrand-包">math/rand 包</h2>
<p>math/rand 包实现了伪随机数生成器</p>
<h3 id="主要方法">主要方法</h3>
<p>（1）func Seed(seed int64)</p>
<p>设置随机种子，不设置则默认Seed(1)</p>
<p>（2）func Int() int</p>
<p>返回一个非负的伪随机int值</p>
<p>（3）func Int31() int32</p>
<p>返回一个int32类型的非负的31位伪随机数</p>
<p>（4）func Int63() int64</p>
<p>返回一个int64类型的非负的63位伪随机数</p>
<p>（5）func Intn(n int) int</p>
<p>返回一个取值范围在[0,n)的伪随机int值，如果n&lt;=0会panic</p>
<p>（6）func Int31n(n int32) int32</p>
<p>返回一个取值范围在[0,n)的伪随机int32值，如果n&lt;=0会panic</p>
<p>（7）func Int63n(n int64) int64</p>
<p>返回一个取值范围在[0, n)的伪随机int64值，如果n&lt;=0会panic</p>
<p>（8）func Float32() float32</p>
<p>返回一个取值范围在[0.0, 1.0)的伪随机float32值</p>
<p>（9）func Float64() float64</p>
<p>返回一个取值范围在[0.0, 1.0)的伪随机float64值</p>
<p>（10）func Perm(n int) []int</p>
<p>返回一个有n个元素的，[0,n)范围内整数的伪随机排列的切片</p>
<h3 id="代码示例">代码示例</h3>
<p>随机数由源生成。顶级函数（例如Float64和Int）使用默认的共享源，该源在每次运行程序时都会产生确定的值序列。 如果每次运行需要不同的行为， 请使用种子函数初始化默认的源。 默认的Source可安全地供多个goroutine并发使用，但不是由NewSource创建的Source。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;math/rand&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>
<span class="kd">func</span> <span class="nf">init</span><span class="p">(){</span>
    <span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UTC</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// launches 2 generators and the fanIn collector function
</span><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nf">fanIn</span><span class="p">(</span><span class="nf">genrt</span><span class="p">(),</span> <span class="nf">genrt</span><span class="p">())</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="o">&lt;-</span><span class="nx">c</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">fanIn</span><span class="p">(</span><span class="nx">a</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">b</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">string</span><span class="p">)</span>
    <span class="c1">// launch collector from a to channel
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">count</span> <span class="kt">int</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">count</span> <span class="o">+=</span> <span class="o">&lt;-</span><span class="nx">a</span>
            <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Tally of A is: %d&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="c1">// launch collector from b to channel
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">count</span> <span class="kt">int</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">count</span> <span class="o">+=</span> <span class="o">&lt;-</span><span class="nx">b</span>
            <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Tally of B is: %d&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">genrt</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="c1">// launch generator of Dice rolls
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>打印输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="kc">...</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">B</span> <span class="n">is</span><span class="o">:</span> <span class="m">17656</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">A</span> <span class="n">is</span><span class="o">:</span> <span class="m">17438</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">A</span> <span class="n">is</span><span class="o">:</span> <span class="m">17440</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">B</span> <span class="n">is</span><span class="o">:</span> <span class="m">17659</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">B</span> <span class="n">is</span><span class="o">:</span> <span class="m">17660</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">A</span> <span class="n">is</span><span class="o">:</span> <span class="m">17445</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="应用场景">应用场景</h3>
<p>（1）验证码</p>
<p>（2）随机密码</p>
<p>（3）抽奖</p>
<p>（4）随机算法</p>
<h3 id="源码剖析">源码剖析</h3>
<p>math/rand 源码其实很简单, 就两个比较重要的函数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Seed uses the provided seed value to initialize the generator to a deterministic state.
</span><span class="c1">// Seed should not be called concurrently with any other Rand method.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rand</span><span class="p">)</span> <span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">lk</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">src</span><span class="p">.(</span><span class="o">*</span><span class="nx">lockedSource</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">lk</span><span class="p">.</span><span class="nf">seedPos</span><span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">r</span><span class="p">.</span><span class="nx">readPos</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">readPos</span> <span class="p">=</span> <span class="mi">0</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Seed uses the provided seed value to initialize the generator to a deterministic state.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rng</span> <span class="o">*</span><span class="nx">rngSource</span><span class="p">)</span> <span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span> <span class="p">=</span> <span class="nx">rngLen</span> <span class="o">-</span> <span class="nx">rngTap</span>

	<span class="nx">seed</span> <span class="p">=</span> <span class="nx">seed</span> <span class="o">%</span> <span class="nx">int32max</span>
	<span class="k">if</span> <span class="nx">seed</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">seed</span> <span class="o">+=</span> <span class="nx">int32max</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">seed</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">seed</span> <span class="p">=</span> <span class="mi">89482311</span>
	<span class="p">}</span>

	<span class="nx">x</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">20</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">rngLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">x</span> <span class="p">=</span> <span class="nf">seedrand</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">u</span> <span class="kt">int64</span>
			<span class="nx">u</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span>
			<span class="nx">x</span> <span class="p">=</span> <span class="nf">seedrand</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
			<span class="nx">u</span> <span class="p">^=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span>
			<span class="nx">x</span> <span class="p">=</span> <span class="nf">seedrand</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
			<span class="nx">u</span> <span class="p">^=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
			<span class="nx">u</span> <span class="p">^=</span> <span class="nx">rngCooked</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
			<span class="nx">rng</span><span class="p">.</span><span class="nx">vec</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">u</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个函数就是在设置 seed, 其实就是对 rng.vec 各个位置设置对应的值. rng.vec 的大小是 607.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Uint64 returns a non-negative pseudo-random 64-bit integer as an uint64.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rng</span> <span class="o">*</span><span class="nx">rngSource</span><span class="p">)</span> <span class="nf">Uint64</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
	<span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span><span class="o">--</span>
	<span class="k">if</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span> <span class="o">+=</span> <span class="nx">rngLen</span>
	<span class="p">}</span>

	<span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span><span class="o">--</span>
	<span class="k">if</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span> <span class="o">+=</span> <span class="nx">rngLen</span>
	<span class="p">}</span>

	<span class="nx">x</span> <span class="o">:=</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">vec</span><span class="p">[</span><span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span><span class="p">]</span> <span class="o">+</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">vec</span><span class="p">[</span><span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span><span class="p">]</span>
	<span class="nx">rng</span><span class="p">.</span><span class="nx">vec</span><span class="p">[</span><span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span><span class="p">]</span> <span class="p">=</span> <span class="nx">x</span>
	<span class="k">return</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们在使用不管调用 <code>Intn()</code>, <code>Int31n()</code> 等其他函数, 最终调用到就是这个函数. 可以看到每次调用就是利用 <code>rng.feed</code> <code>rng.tap</code> 从 <code>rng.vec</code> 中取到两个值相加的结果返回了. 同时还是这个结果又重新放入 <code>rng.vec</code>.</p>
<p>在这里需要注意使用 rng.go 的 rngSource 时, 由于 rng.vec 在获取随机数时会同时设置 rng.vec 的值, 当多 goroutine 同时调用时就会有数据竞争问题. math/rand 采用在调用 rngSource 时加锁  sync.Mutex 解决.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">lockedSource</span><span class="p">)</span> <span class="nf">Uint64</span><span class="p">()</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">r</span><span class="p">.</span><span class="nx">lk</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
 <span class="nx">n</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nf">Uint64</span><span class="p">()</span>
 <span class="nx">r</span><span class="p">.</span><span class="nx">lk</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
 <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>另外我们能直接使用<code>rand.Seed()</code>,<code>rand.Intn(100)</code>, 是因为 math/rand 初始化了一个全局的 globalRand 变量.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">globalRand</span> <span class="p">=</span> <span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lockedSource</span><span class="p">{</span><span class="nx">src</span><span class="p">:</span> <span class="nf">NewSource</span><span class="p">(</span><span class="mi">1</span><span class="p">).(</span><span class="o">*</span><span class="nx">rngSource</span><span class="p">)})</span>

<span class="kd">func</span> <span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span> <span class="nx">globalRand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span> <span class="p">}</span>

<span class="kd">func</span> <span class="nf">Uint32</span><span class="p">()</span> <span class="kt">uint32</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">globalRand</span><span class="p">.</span><span class="nf">Uint32</span><span class="p">()</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>需要注意到由于调用 rngSource 加了锁, 所以直接使用<code>rand.Int32()</code>会导致全局的 goroutine 锁竞争, 所以在高并发场景时, 当你的程序的性能是卡在这里的话, 你需要考虑利用<code>New(&amp;lockedSource{src: NewSource(1).(*rngSource)})</code>为不同的模块生成单独的 rand. 不过根据目前的实践来看, 使用全局的 globalRand 锁竞争并没有我们想象中那么激烈. 使用 New 生成新的 rand 里面是有坑的, 开篇的 panic 就是这么产生的, 后面具体再说.</p>
<p>种子(seed)到底起什么作用?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;current:%d\n&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">())</span>
  <span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">())</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>结果:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">current</span><span class="o">:</span><span class="m">1613814632</span>
<span class="m">65</span>
<span class="n">current</span><span class="o">:</span><span class="m">1613814632</span>
<span class="m">65</span>
<span class="n">current</span><span class="o">:</span><span class="m">1613814632</span>
<span class="m">65</span>
<span class="kc">...</span>
</code></pre></td></tr></table>
</div>
</div><p>这个例子能得出一个结论: 相同种子, 每次运行的结果都是一样的,是一串相同顺序的随机数. 这是为什么呢?</p>
<p>在使用 math/rand 的时候, 一定需要通过调用 rand.Seed 来设置种子, 其实就是给 rng.vec 的 607 个槽设置对应的值. 通过上面的源码那可以看出来, rand.Seed 会调用一个 seedrand 的函数, 来计算对应槽的值.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">seedrand</span><span class="p">(</span><span class="nx">x</span> <span class="kt">int32</span><span class="p">)</span> <span class="kt">int32</span> <span class="p">{</span>
 <span class="kd">const</span> <span class="p">(</span>
  <span class="nx">A</span> <span class="p">=</span> <span class="mi">48271</span>
  <span class="nx">Q</span> <span class="p">=</span> <span class="mi">44488</span>
  <span class="nx">R</span> <span class="p">=</span> <span class="mi">3399</span>
 <span class="p">)</span>

 <span class="nx">hi</span> <span class="o">:=</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">Q</span>
 <span class="nx">lo</span> <span class="o">:=</span> <span class="nx">x</span> <span class="o">%</span> <span class="nx">Q</span>
 <span class="nx">x</span> <span class="p">=</span> <span class="nx">A</span><span class="o">*</span><span class="nx">lo</span> <span class="o">-</span> <span class="nx">R</span><span class="o">*</span><span class="nx">hi</span>
 <span class="k">if</span> <span class="nx">x</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
  <span class="nx">x</span> <span class="o">+=</span> <span class="nx">int32max</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="nx">x</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个函数的计算结果并不是随机的, 而是根据 seed 实际算出来的. 另外这个函数并不是随便写的, 是有相关的数学证明的.</p>
<p>这也导致了相同的 seed, 最终设置到 rng.vec里面的值是相同的, 通过 Intn 取出的也是相同的值.</p>
<h3 id="我遇到的那些坑">我遇到的那些坑</h3>
<h4 id="rand-panic">rand panic</h4>
<p>文章开头的截图就是项目开发中使用别人封装的底层库, 在某天出现的 panic. 大概实现的代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// random.go
</span><span class="c1"></span>
<span class="kd">var</span> <span class="p">(</span>
 <span class="nx">rrRand</span> <span class="p">=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">NewSource</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">()))</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Random</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Random</span><span class="p">)</span> <span class="nf">Balance</span><span class="p">(</span><span class="nx">sf</span><span class="o">*</span><span class="nx">service</span><span class="p">.</span><span class="nx">Service</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// .. 通过服务发现获取到一堆ip+port, 然后随机拿到其中的一些ip和port出来
</span><span class="c1"></span> <span class="nx">randIndexes</span> <span class="o">:=</span> <span class="nx">rrRand</span><span class="p">.</span><span class="nf">Perm</span><span class="p">(</span><span class="nx">randMax</span><span class="p">)</span>

 <span class="c1">// 返回这些ip 和port
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个 Random 会被并发调用, 由于 rrRand 不是并发安全的, 所以就导致了调用 rrRand.Perm 时偶尔会出现 panic 情况.</p>
<p>在使用 math/rand 的时候, 有些人使用 <code>math.Intn()</code>, 看了下注释发现是全局共享了一个锁, 担心出现锁竞争, 所以用 rand.New 来初始化一个新的 rand, 但是要注意到 rand.New 初始化出来的 rand 并不是并发安全的.</p>
<p>修复方案: 就是把 rrRand 换成了 globalRand, 在线上高并发场景下, 发现全局锁影响并不大.</p>
<h4 id="获取的都是同一个机器">获取的都是同一个机器</h4>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210618121457.png" alt=""></p>
<p>同样也是底层封装的 rpc 库, 使用 random 的方式来流量分发, 在线上跑了一段时间后, 流量都路由到一台机器上了, 导致服务直接宕机. 大概实现代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Call</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">service</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">data</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">ins</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ral</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ral</span><span class="p">.</span><span class="nx">TYPE_HTTP</span><span class="p">,</span> <span class="nx">service</span><span class="p">)</span>
 <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="c1">// 错误处理
</span><span class="c1"></span> <span class="p">}</span>
 <span class="k">defer</span> <span class="nx">ins</span><span class="p">.</span><span class="nf">Release</span><span class="p">()</span>

 <span class="k">if</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">ins</span><span class="p">.</span><span class="nf">Request</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">head</span><span class="p">);</span> <span class="nx">e</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="c1">// 错误处理
</span><span class="c1"></span> <span class="p">}</span>
 <span class="c1">// 其他逻辑, 重试等等
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">GetInstance</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">modType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// 其他逻辑..
</span><span class="c1"></span>
 <span class="k">switch</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Strategy</span> <span class="p">{</span>
 <span class="k">case</span> <span class="nx">WITH_RANDOM</span><span class="p">:</span>
  <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rand</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
   <span class="nx">res</span><span class="p">.</span><span class="nx">rand</span> <span class="p">=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">NewSource</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">()))</span>
  <span class="p">}</span>
  <span class="nx">which</span> <span class="p">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>
 <span class="k">case</span> <span class="nx">其他负载均衡查了</span>
 <span class="p">}</span>

 <span class="c1">// 返回其中一个ip和port
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>引起问题的原因: 可以看出来每次请求到来都是利用 GetInstance 来获取一个 ip 和 port, 如果采用 Random 方式的流量负载均衡, 每次都是重新初始化一个 rand. 我们已经知道当设置相同的种子, 每次运行的结果都是一样的. 当瞬间流量过大时, 并发请求 GetInstance, 由于那一刻 time.Now().Unix() 的值是一样的, 这样就会导致获取到随机数都是一样的, 所以就导致最后获取到的 ip, port 都是一样的, 流量都分发到这台机器上了.</p>
<p>修复方案: 修改成 globalRand 即可.</p>
<h3 id="rand-未来期望">rand 未来期望</h3>
<p>说到这里基本上可以看出来, 为了防止全局锁竞争问题, 在使用 math/rand 的时候, 首先都会想到自定义 rand, 但是就容易整出来莫名其妙的问题.</p>
<p>为什么 math/rand 需要加锁呢?</p>
<p>大家都知道 math/rand 是伪随机的, 但是在设置完 seed 后, rng.vec 数组的值基本上就确定下来了, 这明显就不是随机了, 为了增加随机性, 通过 Uint64() 获取到随机数后, 还会重新去设置 rng.vec. 由于存在并发获取随机数的需求, 也就有了并发设置 rng.vec 的值, 所以需要对 rng.vec 加锁保护.</p>
<h2 id="cryptorand-包">crypto/rand 包</h2>
<p>crypto/rand 包实现了用于加解密的更安全的随机数生成器</p>
<h3 id="主要方法-1">主要方法</h3>
<h4 id="variables">Variables</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">Reader</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span>
</code></pre></td></tr></table>
</div>
</div><p>Reader是一个全局、共享的密码用强随机数生成器。在Unix类型系统中，会从/dev/urandom读取；而Windows中会调用CryptGenRandom API。</p>
<p>举例说明该如何使用Reader：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;encoding/base64&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
    <span class="s">&#34;io&#34;</span>
<span class="p">)</span>

<span class="c1">//sessionId函数用来生成一个session ID，即session的唯一标识符
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">sessionId</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="c1">//ReadFull从rand.Reader精确地读取len(b)字节数据填充进b
</span><span class="c1"></span>    <span class="c1">//rand.Reader是一个全局、共享的密码用强随机数生成器
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="c1">//[62 186 123 16 209 19 130 218 146 136 171 211 12 233 45 99 80 200 59 20 56 254 170 110 59 147 223 177 48 136 220 142]
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">URLEncoding</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="c1">//将生成的随机数b编码后返回字符串,该值则作为session ID
</span><span class="c1"></span><span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">sessionId</span><span class="p">())</span> <span class="c1">//Prp7ENETgtqSiKvTDOktY1DIOxQ4_qpuO5PfsTCI3I4=
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="func-int">func Int</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Int</span><span class="p">(</span><span class="nx">rand</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">max</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span><span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>返回一个在[0, max)区间服从均匀分布的随机值，如果max&lt;=0则会panic。</p>
<p>举例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
    <span class="s">&#34;math/big&#34;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//从128开始，这样就能够将(max.BitLen() % 8) == 0的情况包含在里面
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="mi">128</span><span class="p">;</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">140</span><span class="p">;</span> <span class="nx">n</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">b</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">).</span><span class="nf">SetInt64</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="c1">//将new(big.Int)设为int64(n)并返回new(big.Int)
</span><span class="c1"></span>        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;max Int is : %v\n&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
        <span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Can&#39;t generate random value: %v, %v&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;rand Int is : %v\n&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">bogon</span><span class="o">:~</span> <span class="n">user</span><span class="o">$</span> <span class="n">go</span> <span class="n">run</span> <span class="n">testGo.go</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">128</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">25</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">129</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">117</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">130</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">85</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">131</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">62</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">132</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">27</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">133</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">120</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">134</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">10</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">135</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">27</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">136</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">11</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">137</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">119</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">138</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">35</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">139</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">83</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="func-prime">func Prime</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Prime</span><span class="p">(</span><span class="nx">rand</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">bits</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>返回一个具有指定字位数的数字，该数字具有很高可能性是质数。如果从rand读取时出错，或者bits&lt;2会返回错误。</p>
<p>举例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">n</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Prime</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="c1">//n代表位数，比如3为2位，127为7位
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Can&#39;t generate %d-bit prime: %v&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nf">BitLen</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">n</span> <span class="p">{</span> <span class="c1">//返回p的绝对值的字位数，0的字位数为0
</span><span class="c1"></span>            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v is not %d-bit&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nf">ProbablyPrime</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//对p进行32次Miller-Rabin质数检测。如果方法返回真则p是质数的几率为1-(1/4)**32；否则p不是质数
</span><span class="c1"></span>            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v is not prime&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">bogon</span><span class="o">:~</span> <span class="n">user</span><span class="o">$</span> <span class="n">go</span> <span class="n">run</span> <span class="n">testGo.go</span>
<span class="m">3</span>
<span class="m">7</span>
<span class="m">13</span>
<span class="m">31</span>
<span class="m">53</span>
<span class="m">109</span>
<span class="m">223</span>
<span class="m">439</span>
</code></pre></td></tr></table>
</div>
</div><p>如果位数小于2的话，会报错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
    <span class="s">&#34;log&#34;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Prime</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">//n代表位数，比如3为2位，127为7位
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">bogon</span><span class="o">:~</span> <span class="n">user</span><span class="o">$</span> <span class="n">go</span> <span class="n">run</span> <span class="n">testGo.go</span>
<span class="m">2019</span><span class="o">/</span><span class="m">02</span><span class="o">/</span><span class="m">23</span> <span class="m">12</span><span class="o">:</span><span class="m">31</span><span class="o">:</span><span class="m">37</span> <span class="n">crypto</span><span class="o">/</span><span class="n">rand</span><span class="o">:</span> <span class="n">prime</span> <span class="n">size</span> <span class="n">must</span> <span class="n">be</span> <span class="n">at</span> <span class="n">least</span> <span class="m">2</span><span class="o">-</span><span class="n">bit</span>
<span class="n">exit</span> <span class="n">status</span> <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="func-read">func Read</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>本函数是一个使用io.ReadFull调用Reader.Read的辅助性函数。当且仅当err == nil时，返回值n == len(b)。</p>
<p>因为本函数是一个使用io.ReadFull调用Reader.Read的辅助性函数，所以最上面的那个生成session ID的例子等价于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;encoding/base64&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
<span class="p">)</span>

<span class="c1">//sessionId函数用来生成一个session ID，即session的唯一标识符
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">sessionId</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="c1">//rand.Reader是一个全局、共享的密码用强随机数生成器
</span><span class="c1"></span>    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">b</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span> <span class="c1">//[154 94 244 2 147 96 148 6 13 27 3 52 231 127 160 159 40 47 84 116 79 87 160 217 185 216 47 143 101 107 219 178]
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">URLEncoding</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="c1">//将生成的随机数b编码后返回字符串,该值则作为session ID
</span><span class="c1"></span><span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">sessionId</span><span class="p">())</span> <span class="c1">//ml70ApNglAYNGwM053-gnygvVHRPV6DZudgvj2Vr27I=
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="代码示例-1">代码示例</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;crypto/rand&#34;</span>
    <span class="s">&#34;encoding/base64&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;math/big&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//1、Int
</span><span class="c1"></span>    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">big</span><span class="p">.</span><span class="nf">NewInt</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rand.Int：&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nf">BitLen</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="c1">//2、Prime
</span><span class="c1"></span>    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Prime</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rand.Prime：&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">//3、Read
</span><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="nx">m</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rand.Read：&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">[:</span><span class="nx">m</span><span class="p">])</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rand.Read：&#34;</span><span class="p">,</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">URLEncoding</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">rand.Int</span>： <span class="m">92</span> <span class="m">7</span>
<span class="n">rand.Prime</span>： <span class="m">29</span>
<span class="n">rand.Read</span>： <span class="n">[207</span> <span class="m">47</span> <span class="m">241</span> <span class="m">208</span> <span class="m">190</span> <span class="m">84</span> <span class="m">109</span> <span class="m">134</span> <span class="m">86</span> <span class="m">106</span> <span class="m">87</span> <span class="m">223</span> <span class="m">111</span> <span class="m">113</span> <span class="m">203</span> <span class="m">155</span> <span class="m">44</span> <span class="m">118</span> <span class="m">71</span> <span class="m">20</span> <span class="m">186</span> <span class="m">62</span> <span class="m">66</span> <span class="m">130</span> <span class="m">244</span> <span class="m">98</span> <span class="m">97</span> <span class="m">184</span> <span class="m">8</span> <span class="m">179</span> <span class="m">6</span> <span class="m">230</span><span class="n">]</span>
<span class="n">rand.Read</span>： <span class="n">zy_x0L5UbYZWalffb3HLmyx2RxS6PkKC9GJhuAizBuY</span><span class="o">=</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<p><a href="https://blog.csdn.net/whatday/article/details/106617208">golang 随机数 math/rand包 crypto/rand包</a></p>
<p><a href="https://segmentfault.com/a/1190000021543499">Golang: math/rand 和 crypto/rand 区别</a></p>
<p><a href="https://www.cnblogs.com/wanghui-garcia/p/10421659.html">go标准库的学习-crypto/rand</a></p>
<p><a href="https://mp.weixin.qq.com/s/zQq9lEDLGPh7shvJLm0AuQ">深度解密 Go math/rand</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-01-09
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/go/">Go</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/go%E4%B8%AD%E7%9A%84%E6%B5%8B%E8%AF%95%E6%8A%80%E5%B7%A7/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go中的测试技巧</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/go%E7%9A%84%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/">
            <span class="next-text nav-default">Go的条件编译</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2021<span class="heart"><i class="iconfont icon-heart"></i></span><span>Forz</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>






<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
docsearch({
    apiKey: "b4b9da2eba53aa6dabe4b8ac9e8676e1",
    indexName: "forz.forzvina.com",
    appId: "IAR2EF5L65",
    inputSelector: '.docsearch-input',
    debug: false,
});
</script>
</body>
</html>
