<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go如何生成随机数 | Forz Blog</title>
<meta name="keywords" content="Go" />
<meta name="description" content="math/rand 包 math/rand 包实现了伪随机数生成器 主要方法 （1）func Seed(seed int64) 设置随机种子，不设置则默认Seed(1) （2）func Int() int 返回一个非负的伪随机int值">
<meta name="author" content="">
<link rel="canonical" href="/post/go%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E6%95%B0/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Go如何生成随机数" />
<meta property="og:description" content="math/rand 包 math/rand 包实现了伪随机数生成器 主要方法 （1）func Seed(seed int64) 设置随机种子，不设置则默认Seed(1) （2）func Int() int 返回一个非负的伪随机int值" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/go%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E6%95%B0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-01-09T23:44:37&#43;00:00" />
<meta property="article:modified_time" content="2021-01-09T23:44:37&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go如何生成随机数"/>
<meta name="twitter:description" content="math/rand 包 math/rand 包实现了伪随机数生成器 主要方法 （1）func Seed(seed int64) 设置随机种子，不设置则默认Seed(1) （2）func Int() int 返回一个非负的伪随机int值"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Go如何生成随机数",
      "item": "/post/go%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E6%95%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go如何生成随机数",
  "name": "Go如何生成随机数",
  "description": "math/rand 包 math/rand 包实现了伪随机数生成器 主要方法 （1）func Seed(seed int64) 设置随机种子，不设置则默认Seed(1) （2）func Int() int 返回一个非负的伪随机int值",
  "keywords": [
    "Go"
  ],
  "articleBody": "math/rand 包 math/rand 包实现了伪随机数生成器\n主要方法 （1）func Seed(seed int64)\n设置随机种子，不设置则默认Seed(1)\n（2）func Int() int\n返回一个非负的伪随机int值\n（3）func Int31() int32\n返回一个int32类型的非负的31位伪随机数\n（4）func Int63() int64\n返回一个int64类型的非负的63位伪随机数\n（5）func Intn(n int) int\n返回一个取值范围在[0,n)的伪随机int值，如果n（6）func Int31n(n int32) int32\n返回一个取值范围在[0,n)的伪随机int32值，如果n（7）func Int63n(n int64) int64\n返回一个取值范围在[0, n)的伪随机int64值，如果n（8）func Float32() float32\n返回一个取值范围在[0.0, 1.0)的伪随机float32值\n（9）func Float64() float64\n返回一个取值范围在[0.0, 1.0)的伪随机float64值\n（10）func Perm(n int) []int\n返回一个有n个元素的，[0,n)范围内整数的伪随机排列的切片\n代码示例 随机数由源生成。顶级函数（例如Float64和Int）使用默认的共享源，该源在每次运行程序时都会产生确定的值序列。 如果每次运行需要不同的行为， 请使用种子函数初始化默认的源。 默认的Source可安全地供多个goroutine并发使用，但不是由NewSource创建的Source。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53  package main import ( \"fmt\" \"math/rand\" \"time\" ) func init(){ rand.Seed(time.Now().UTC().UnixNano()) } func main() { // launches 2 generators and the fanIn collector function  c := fanIn(genrt(), genrt()) for i := 0; i  10000; i++ { fmt.Println(c) } } func fanIn(a chan int, b chan int) chan string { c := make(chan string) // launch collector from a to channel  go func() { var count int for { count += a c  fmt.Sprintf(\"Tally of A is: %d\", count) } }() // launch collector from b to channel  go func() { var count int for { count += b c  fmt.Sprintf(\"Tally of B is: %d\", count) } }() return c } func genrt() chan int { c := make(chan int) // launch generator of Dice rolls  go func() { for i := 0; ; i++ { c  rand.Intn(6) + 1 time.Sleep(time.Duration(500 * time.Millisecond)) } }() return c }   打印输出\n1 2 3 4 5 6 7  ... Tally of B is: 17656 Tally of A is: 17438 Tally of A is: 17440 Tally of B is: 17659 Tally of B is: 17660 Tally of A is: 17445   应用场景 （1）验证码\n（2）随机密码\n（3）抽奖\n（4）随机算法\n源码剖析 math/rand 源码其实很简单, 就两个比较重要的函数:\n1 2 3 4 5 6 7 8 9 10 11  // Seed uses the provided seed value to initialize the generator to a deterministic state. // Seed should not be called concurrently with any other Rand method. func (r *Rand) Seed(seed int64) { if lk, ok := r.src.(*lockedSource); ok { lk.seedPos(seed, \u0026r.readPos) return } r.src.Seed(seed) r.readPos = 0 }   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  // Seed uses the provided seed value to initialize the generator to a deterministic state. func (rng *rngSource) Seed(seed int64) { rng.tap = 0 rng.feed = rngLen - rngTap seed = seed % int32max if seed  0 { seed += int32max } if seed == 0 { seed = 89482311 } x := int32(seed) for i := -20; i  rngLen; i++ { x = seedrand(x) if i = 0 { var u int64 u = int64(x)  40 x = seedrand(x) u ^= int64(x)  20 x = seedrand(x) u ^= int64(x) u ^= rngCooked[i] rng.vec[i] = u } } }   这个函数就是在设置 seed, 其实就是对 rng.vec 各个位置设置对应的值. rng.vec 的大小是 607.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // Uint64 returns a non-negative pseudo-random 64-bit integer as an uint64. func (rng *rngSource) Uint64() uint64 { rng.tap-- if rng.tap  0 { rng.tap += rngLen } rng.feed-- if rng.feed  0 { rng.feed += rngLen } x := rng.vec[rng.feed] + rng.vec[rng.tap] rng.vec[rng.feed] = x return uint64(x) }   我们在使用不管调用 Intn(), Int31n() 等其他函数, 最终调用到就是这个函数. 可以看到每次调用就是利用 rng.feed rng.tap 从 rng.vec 中取到两个值相加的结果返回了. 同时还是这个结果又重新放入 rng.vec.\n在这里需要注意使用 rng.go 的 rngSource 时, 由于 rng.vec 在获取随机数时会同时设置 rng.vec 的值, 当多 goroutine 同时调用时就会有数据竞争问题. math/rand 采用在调用 rngSource 时加锁 sync.Mutex 解决.\n1 2 3 4 5 6  func (r *lockedSource) Uint64() (n uint64) { r.lk.Lock() n = r.src.Uint64() r.lk.Unlock() return }   另外我们能直接使用rand.Seed(),rand.Intn(100), 是因为 math/rand 初始化了一个全局的 globalRand 变量.\n1 2 3 4 5  var globalRand = New(\u0026lockedSource{src: NewSource(1).(*rngSource)}) func Seed(seed int64) { globalRand.Seed(seed) } func Uint32() uint32 { return globalRand.Uint32() }   需要注意到由于调用 rngSource 加了锁, 所以直接使用rand.Int32()会导致全局的 goroutine 锁竞争, 所以在高并发场景时, 当你的程序的性能是卡在这里的话, 你需要考虑利用New(\u0026lockedSource{src: NewSource(1).(*rngSource)})为不同的模块生成单独的 rand. 不过根据目前的实践来看, 使用全局的 globalRand 锁竞争并没有我们想象中那么激烈. 使用 New 生成新的 rand 里面是有坑的, 开篇的 panic 就是这么产生的, 后面具体再说.\n种子(seed)到底起什么作用?\n1 2 3 4 5 6 7  func main() { for i := 0; i  10; i++ { fmt.Printf(\"current:%d\\n\", time.Now().Unix()) rand.Seed(time.Now().Unix()) fmt.Println(rand.Intn(100)) } }   结果:\n1 2 3 4 5 6 7  current:1613814632 65 current:1613814632 65 current:1613814632 65 ...   这个例子能得出一个结论: 相同种子, 每次运行的结果都是一样的,是一串相同顺序的随机数. 这是为什么呢?\n在使用 math/rand 的时候, 一定需要通过调用 rand.Seed 来设置种子, 其实就是给 rng.vec 的 607 个槽设置对应的值. 通过上面的源码那可以看出来, rand.Seed 会调用一个 seedrand 的函数, 来计算对应槽的值.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  func seedrand(x int32) int32 { const ( A = 48271 Q = 44488 R = 3399 ) hi := x / Q lo := x % Q x = A*lo - R*hi if x  0 { x += int32max } return x }   这个函数的计算结果并不是随机的, 而是根据 seed 实际算出来的. 另外这个函数并不是随便写的, 是有相关的数学证明的.\n这也导致了相同的 seed, 最终设置到 rng.vec里面的值是相同的, 通过 Intn 取出的也是相同的值.\n我遇到的那些坑 rand panic 文章开头的截图就是项目开发中使用别人封装的底层库, 在某天出现的 panic. 大概实现的代码:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  // random.go  var ( rrRand = rand.New(rand.NewSource(time.Now().Unix())) ) type Random struct{} func (r *Random) Balance(sf*service.Service) ([]string, error) { // .. 通过服务发现获取到一堆ip+port, 然后随机拿到其中的一些ip和port出来  randIndexes := rrRand.Perm(randMax) // 返回这些ip 和port }   这个 Random 会被并发调用, 由于 rrRand 不是并发安全的, 所以就导致了调用 rrRand.Perm 时偶尔会出现 panic 情况.\n在使用 math/rand 的时候, 有些人使用 math.Intn(), 看了下注释发现是全局共享了一个锁, 担心出现锁竞争, 所以用 rand.New 来初始化一个新的 rand, 但是要注意到 rand.New 初始化出来的 rand 并不是并发安全的.\n修复方案: 就是把 rrRand 换成了 globalRand, 在线上高并发场景下, 发现全局锁影响并不大.\n获取的都是同一个机器 同样也是底层封装的 rpc 库, 使用 random 的方式来流量分发, 在线上跑了一段时间后, 流量都路由到一台机器上了, 导致服务直接宕机. 大概实现代码:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  func Call(ctx *gin.Context, method string, service string, data map[string]interface{}) (buf []byte, err error) { ins, err := ral.GetInstance(ctx, ral.TYPE_HTTP, service) if err != nil { // 错误处理  } defer ins.Release() if b, e := ins.Request(ctx, method, data, head); e == nil { // 错误处理  } // 其他逻辑, 重试等等 } func GetInstance(ctx *gin.Context, modType string, name string) (*Instance, error) { // 其他逻辑..  switch res.Strategy { case WITH_RANDOM: if res.rand == nil { res.rand = rand.New(rand.NewSource(time.Now().Unix())) } which = res.rand.Intn(res.count) case 其他负载均衡查了 } // 返回其中一个ip和port }   引起问题的原因: 可以看出来每次请求到来都是利用 GetInstance 来获取一个 ip 和 port, 如果采用 Random 方式的流量负载均衡, 每次都是重新初始化一个 rand. 我们已经知道当设置相同的种子, 每次运行的结果都是一样的. 当瞬间流量过大时, 并发请求 GetInstance, 由于那一刻 time.Now().Unix() 的值是一样的, 这样就会导致获取到随机数都是一样的, 所以就导致最后获取到的 ip, port 都是一样的, 流量都分发到这台机器上了.\n修复方案: 修改成 globalRand 即可.\nrand 未来期望 说到这里基本上可以看出来, 为了防止全局锁竞争问题, 在使用 math/rand 的时候, 首先都会想到自定义 rand, 但是就容易整出来莫名其妙的问题.\n为什么 math/rand 需要加锁呢?\n大家都知道 math/rand 是伪随机的, 但是在设置完 seed 后, rng.vec 数组的值基本上就确定下来了, 这明显就不是随机了, 为了增加随机性, 通过 Uint64() 获取到随机数后, 还会重新去设置 rng.vec. 由于存在并发获取随机数的需求, 也就有了并发设置 rng.vec 的值, 所以需要对 rng.vec 加锁保护.\ncrypto/rand 包 crypto/rand 包实现了用于加解密的更安全的随机数生成器\n主要方法 Variables 1  var Reader io.Reader   Reader是一个全局、共享的密码用强随机数生成器。在Unix类型系统中，会从/dev/urandom读取；而Windows中会调用CryptGenRandom API。\n举例说明该如何使用Reader：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  package main import( \"fmt\" \"encoding/base64\" \"crypto/rand\" \"io\" ) //sessionId函数用来生成一个session ID，即session的唯一标识符 func sessionId() string { b := make([]byte, 32) //ReadFull从rand.Reader精确地读取len(b)字节数据填充进b  //rand.Reader是一个全局、共享的密码用强随机数生成器  if _, err := io.ReadFull(rand.Reader, b); err != nil { return \"\" } fmt.Println(b) //[62 186 123 16 209 19 130 218 146 136 171 211 12 233 45 99 80 200 59 20 56 254 170 110 59 147 223 177 48 136 220 142]  return base64.URLEncoding.EncodeToString(b)//将生成的随机数b编码后返回字符串,该值则作为session ID } func main() { fmt.Println(sessionId()) //Prp7ENETgtqSiKvTDOktY1DIOxQ4_qpuO5PfsTCI3I4= }   func Int 1  func Int(rand io.Reader, max *big.Int) (n*big.Int, err error)   返回一个在[0, max)区间服从均匀分布的随机值，如果max举例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  package main import( \"fmt\" \"crypto/rand\" \"math/big\" ) func main() { //从128开始，这样就能够将(max.BitLen() % 8) == 0的情况包含在里面  for n := 128; n  140; n++ { b := new(big.Int).SetInt64(int64(n)) //将new(big.Int)设为int64(n)并返回new(big.Int)  fmt.Printf(\"max Int is : %v\\n\", b) i, err := rand.Int(rand.Reader, b) if err != nil { fmt.Printf(\"Can't generate random value: %v, %v\", i, err) } fmt.Printf(\"rand Int is : %v\\n\", i) } }   返回：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  bogon:~ user$ go run testGo.go max Int is : 128 rand Int is : 25 max Int is : 129 rand Int is : 117 max Int is : 130 rand Int is : 85 max Int is : 131 rand Int is : 62 max Int is : 132 rand Int is : 27 max Int is : 133 rand Int is : 120 max Int is : 134 rand Int is : 10 max Int is : 135 rand Int is : 27 max Int is : 136 rand Int is : 11 max Int is : 137 rand Int is : 119 max Int is : 138 rand Int is : 35 max Int is : 139 rand Int is : 83   func Prime 1  func Prime(rand io.Reader, bits int) (p *big.Int, err error)   返回一个具有指定字位数的数字，该数字具有很高可能性是质数。如果从rand读取时出错，或者bits举例：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  package main import( \"fmt\" \"crypto/rand\" ) func main() { for n := 2; n  10; n++ { p, err := rand.Prime(rand.Reader, n) //n代表位数，比如3为2位，127为7位  if err != nil { fmt.Printf(\"Can't generate %d-bit prime: %v\", n, err) } if p.BitLen() != n { //返回p的绝对值的字位数，0的字位数为0  fmt.Printf(\"%v is not %d-bit\", p, n) } if !p.ProbablyPrime(32) { //对p进行32次Miller-Rabin质数检测。如果方法返回真则p是质数的几率为1-(1/4)**32；否则p不是质数  fmt.Printf(\"%v is not prime\", p) } fmt.Println(p) } }   返回：\n1 2 3 4 5 6 7 8 9  bogon:~ user$ go run testGo.go 3 7 13 31 53 109 223 439   如果位数小于2的话，会报错：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  package main import( \"fmt\" \"crypto/rand\" \"log\" ) func main() { p, err := rand.Prime(rand.Reader, 1) //n代表位数，比如3为2位，127为7位  if err != nil { log.Fatal(err) } fmt.Println(p) }   返回：\n1 2 3  bogon:~ user$ go run testGo.go 2019/02/23 12:31:37 crypto/rand: prime size must be at least 2-bit exit status 1   func Read 1  func Read(b []byte) (n int, err error)   本函数是一个使用io.ReadFull调用Reader.Read的辅助性函数。当且仅当err == nil时，返回值n == len(b)。\n因为本函数是一个使用io.ReadFull调用Reader.Read的辅助性函数，所以最上面的那个生成session ID的例子等价于：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  package main import( \"fmt\" \"encoding/base64\" \"crypto/rand\" ) //sessionId函数用来生成一个session ID，即session的唯一标识符 func sessionId() string { b := make([]byte, 32) //rand.Reader是一个全局、共享的密码用强随机数生成器  n, err := rand.Read(b); if err != nil { return \"\" } fmt.Println(b[:n]) //[154 94 244 2 147 96 148 6 13 27 3 52 231 127 160 159 40 47 84 116 79 87 160 217 185 216 47 143 101 107 219 178]  return base64.URLEncoding.EncodeToString(b)//将生成的随机数b编码后返回字符串,该值则作为session ID } func main() { fmt.Println(sessionId()) //ml70ApNglAYNGwM053-gnygvVHRPV6DZudgvj2Vr27I= }   代码示例 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  package main import ( \"crypto/rand\" \"encoding/base64\" \"fmt\" \"math/big\" ) func main() { //1、Int  n, err := rand.Int(rand.Reader, big.NewInt(128)) if err == nil { fmt.Println(\"rand.Int：\", n, n.BitLen()) } //2、Prime  p, err := rand.Prime(rand.Reader, 5) if err == nil { fmt.Println(\"rand.Prime：\", p) } //3、Read  b := make([]byte, 32) m, err := rand.Read(b) if err == nil { fmt.Println(\"rand.Read：\", b[:m]) fmt.Println(\"rand.Read：\", base64.URLEncoding.EncodeToString(b)) } }   输出：\n1 2 3 4  rand.Int： 92 7 rand.Prime： 29 rand.Read： [207 47 241 208 190 84 109 134 86 106 87 223 111 113 203 155 44 118 71 20 186 62 66 130 244 98 97 184 8 179 6 230] rand.Read： zy_x0L5UbYZWalffb3HLmyx2RxS6PkKC9GJhuAizBuY=   参考 golang 随机数 math/rand包 crypto/rand包\nGolang: math/rand 和 crypto/rand 区别\ngo标准库的学习-crypto/rand\n深度解密 Go math/rand\n",
  "wordCount" : "4693",
  "inLanguage": "zh-cn",
  "datePublished": "2021-01-09T23:44:37Z",
  "dateModified": "2021-01-09T23:44:37Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/go%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E6%95%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Go如何生成随机数
    </h1>
    <div class="post-meta">January 9, 2021
</div>
  </header> 
  <div class="post-content"><h2 id="mathrand-包">math/rand 包<a hidden class="anchor" aria-hidden="true" href="#mathrand-包">#</a></h2>
<p>math/rand 包实现了伪随机数生成器</p>
<h3 id="主要方法">主要方法<a hidden class="anchor" aria-hidden="true" href="#主要方法">#</a></h3>
<p>（1）func Seed(seed int64)</p>
<p>设置随机种子，不设置则默认Seed(1)</p>
<p>（2）func Int() int</p>
<p>返回一个非负的伪随机int值</p>
<p>（3）func Int31() int32</p>
<p>返回一个int32类型的非负的31位伪随机数</p>
<p>（4）func Int63() int64</p>
<p>返回一个int64类型的非负的63位伪随机数</p>
<p>（5）func Intn(n int) int</p>
<p>返回一个取值范围在[0,n)的伪随机int值，如果n&lt;=0会panic</p>
<p>（6）func Int31n(n int32) int32</p>
<p>返回一个取值范围在[0,n)的伪随机int32值，如果n&lt;=0会panic</p>
<p>（7）func Int63n(n int64) int64</p>
<p>返回一个取值范围在[0, n)的伪随机int64值，如果n&lt;=0会panic</p>
<p>（8）func Float32() float32</p>
<p>返回一个取值范围在[0.0, 1.0)的伪随机float32值</p>
<p>（9）func Float64() float64</p>
<p>返回一个取值范围在[0.0, 1.0)的伪随机float64值</p>
<p>（10）func Perm(n int) []int</p>
<p>返回一个有n个元素的，[0,n)范围内整数的伪随机排列的切片</p>
<h3 id="代码示例">代码示例<a hidden class="anchor" aria-hidden="true" href="#代码示例">#</a></h3>
<p>随机数由源生成。顶级函数（例如Float64和Int）使用默认的共享源，该源在每次运行程序时都会产生确定的值序列。 如果每次运行需要不同的行为， 请使用种子函数初始化默认的源。 默认的Source可安全地供多个goroutine并发使用，但不是由NewSource创建的Source。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;math/rand&#34;</span>
    <span class="s">&#34;time&#34;</span>
<span class="p">)</span>
<span class="kd">func</span> <span class="nf">init</span><span class="p">(){</span>
    <span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UTC</span><span class="p">().</span><span class="nf">UnixNano</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="c1">// launches 2 generators and the fanIn collector function
</span><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nf">fanIn</span><span class="p">(</span><span class="nf">genrt</span><span class="p">(),</span> <span class="nf">genrt</span><span class="p">())</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="o">&lt;-</span><span class="nx">c</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">fanIn</span><span class="p">(</span><span class="nx">a</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">b</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">string</span><span class="p">)</span>
    <span class="c1">// launch collector from a to channel
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">count</span> <span class="kt">int</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">count</span> <span class="o">+=</span> <span class="o">&lt;-</span><span class="nx">a</span>
            <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Tally of A is: %d&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="c1">// launch collector from b to channel
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">count</span> <span class="kt">int</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">count</span> <span class="o">+=</span> <span class="o">&lt;-</span><span class="nx">b</span>
            <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Tally of B is: %d&#34;</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">genrt</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="c1">// launch generator of Dice rolls
</span><span class="c1"></span>    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>打印输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="kc">...</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">B</span> <span class="n">is</span><span class="o">:</span> <span class="m">17656</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">A</span> <span class="n">is</span><span class="o">:</span> <span class="m">17438</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">A</span> <span class="n">is</span><span class="o">:</span> <span class="m">17440</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">B</span> <span class="n">is</span><span class="o">:</span> <span class="m">17659</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">B</span> <span class="n">is</span><span class="o">:</span> <span class="m">17660</span>
<span class="n">Tally</span> <span class="n">of</span> <span class="n">A</span> <span class="n">is</span><span class="o">:</span> <span class="m">17445</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="应用场景">应用场景<a hidden class="anchor" aria-hidden="true" href="#应用场景">#</a></h3>
<p>（1）验证码</p>
<p>（2）随机密码</p>
<p>（3）抽奖</p>
<p>（4）随机算法</p>
<h3 id="源码剖析">源码剖析<a hidden class="anchor" aria-hidden="true" href="#源码剖析">#</a></h3>
<p>math/rand 源码其实很简单, 就两个比较重要的函数:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Seed uses the provided seed value to initialize the generator to a deterministic state.
</span><span class="c1">// Seed should not be called concurrently with any other Rand method.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Rand</span><span class="p">)</span> <span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">lk</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">src</span><span class="p">.(</span><span class="o">*</span><span class="nx">lockedSource</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">lk</span><span class="p">.</span><span class="nf">seedPos</span><span class="p">(</span><span class="nx">seed</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">r</span><span class="p">.</span><span class="nx">readPos</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">r</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span>
	<span class="nx">r</span><span class="p">.</span><span class="nx">readPos</span> <span class="p">=</span> <span class="mi">0</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Seed uses the provided seed value to initialize the generator to a deterministic state.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rng</span> <span class="o">*</span><span class="nx">rngSource</span><span class="p">)</span> <span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span> <span class="p">=</span> <span class="mi">0</span>
	<span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span> <span class="p">=</span> <span class="nx">rngLen</span> <span class="o">-</span> <span class="nx">rngTap</span>

	<span class="nx">seed</span> <span class="p">=</span> <span class="nx">seed</span> <span class="o">%</span> <span class="nx">int32max</span>
	<span class="k">if</span> <span class="nx">seed</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">seed</span> <span class="o">+=</span> <span class="nx">int32max</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">seed</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">seed</span> <span class="p">=</span> <span class="mi">89482311</span>
	<span class="p">}</span>

	<span class="nx">x</span> <span class="o">:=</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">20</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">rngLen</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">x</span> <span class="p">=</span> <span class="nf">seedrand</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">u</span> <span class="kt">int64</span>
			<span class="nx">u</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span>
			<span class="nx">x</span> <span class="p">=</span> <span class="nf">seedrand</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
			<span class="nx">u</span> <span class="p">^=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span>
			<span class="nx">x</span> <span class="p">=</span> <span class="nf">seedrand</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
			<span class="nx">u</span> <span class="p">^=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
			<span class="nx">u</span> <span class="p">^=</span> <span class="nx">rngCooked</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
			<span class="nx">rng</span><span class="p">.</span><span class="nx">vec</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">u</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个函数就是在设置 seed, 其实就是对 rng.vec 各个位置设置对应的值. rng.vec 的大小是 607.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Uint64 returns a non-negative pseudo-random 64-bit integer as an uint64.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rng</span> <span class="o">*</span><span class="nx">rngSource</span><span class="p">)</span> <span class="nf">Uint64</span><span class="p">()</span> <span class="kt">uint64</span> <span class="p">{</span>
	<span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span><span class="o">--</span>
	<span class="k">if</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span> <span class="o">+=</span> <span class="nx">rngLen</span>
	<span class="p">}</span>

	<span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span><span class="o">--</span>
	<span class="k">if</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span> <span class="o">+=</span> <span class="nx">rngLen</span>
	<span class="p">}</span>

	<span class="nx">x</span> <span class="o">:=</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">vec</span><span class="p">[</span><span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span><span class="p">]</span> <span class="o">+</span> <span class="nx">rng</span><span class="p">.</span><span class="nx">vec</span><span class="p">[</span><span class="nx">rng</span><span class="p">.</span><span class="nx">tap</span><span class="p">]</span>
	<span class="nx">rng</span><span class="p">.</span><span class="nx">vec</span><span class="p">[</span><span class="nx">rng</span><span class="p">.</span><span class="nx">feed</span><span class="p">]</span> <span class="p">=</span> <span class="nx">x</span>
	<span class="k">return</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们在使用不管调用 <code>Intn()</code>, <code>Int31n()</code> 等其他函数, 最终调用到就是这个函数. 可以看到每次调用就是利用 <code>rng.feed</code> <code>rng.tap</code> 从 <code>rng.vec</code> 中取到两个值相加的结果返回了. 同时还是这个结果又重新放入 <code>rng.vec</code>.</p>
<p>在这里需要注意使用 rng.go 的 rngSource 时, 由于 rng.vec 在获取随机数时会同时设置 rng.vec 的值, 当多 goroutine 同时调用时就会有数据竞争问题. math/rand 采用在调用 rngSource 时加锁  sync.Mutex 解决.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">lockedSource</span><span class="p">)</span> <span class="nf">Uint64</span><span class="p">()</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">r</span><span class="p">.</span><span class="nx">lk</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
 <span class="nx">n</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nf">Uint64</span><span class="p">()</span>
 <span class="nx">r</span><span class="p">.</span><span class="nx">lk</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
 <span class="k">return</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>另外我们能直接使用<code>rand.Seed()</code>,<code>rand.Intn(100)</code>, 是因为 math/rand 初始化了一个全局的 globalRand 变量.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">globalRand</span> <span class="p">=</span> <span class="nf">New</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">lockedSource</span><span class="p">{</span><span class="nx">src</span><span class="p">:</span> <span class="nf">NewSource</span><span class="p">(</span><span class="mi">1</span><span class="p">).(</span><span class="o">*</span><span class="nx">rngSource</span><span class="p">)})</span>

<span class="kd">func</span> <span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span> <span class="nx">globalRand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">seed</span><span class="p">)</span> <span class="p">}</span>

<span class="kd">func</span> <span class="nf">Uint32</span><span class="p">()</span> <span class="kt">uint32</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">globalRand</span><span class="p">.</span><span class="nf">Uint32</span><span class="p">()</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>需要注意到由于调用 rngSource 加了锁, 所以直接使用<code>rand.Int32()</code>会导致全局的 goroutine 锁竞争, 所以在高并发场景时, 当你的程序的性能是卡在这里的话, 你需要考虑利用<code>New(&amp;lockedSource{src: NewSource(1).(*rngSource)})</code>为不同的模块生成单独的 rand. 不过根据目前的实践来看, 使用全局的 globalRand 锁竞争并没有我们想象中那么激烈. 使用 New 生成新的 rand 里面是有坑的, 开篇的 panic 就是这么产生的, 后面具体再说.</p>
<p>种子(seed)到底起什么作用?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
 <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;current:%d\n&#34;</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">())</span>
  <span class="nx">rand</span><span class="p">.</span><span class="nf">Seed</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">())</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>结果:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">current</span><span class="o">:</span><span class="m">1613814632</span>
<span class="m">65</span>
<span class="n">current</span><span class="o">:</span><span class="m">1613814632</span>
<span class="m">65</span>
<span class="n">current</span><span class="o">:</span><span class="m">1613814632</span>
<span class="m">65</span>
<span class="kc">...</span>
</code></pre></td></tr></table>
</div>
</div><p>这个例子能得出一个结论: 相同种子, 每次运行的结果都是一样的,是一串相同顺序的随机数. 这是为什么呢?</p>
<p>在使用 math/rand 的时候, 一定需要通过调用 rand.Seed 来设置种子, 其实就是给 rng.vec 的 607 个槽设置对应的值. 通过上面的源码那可以看出来, rand.Seed 会调用一个 seedrand 的函数, 来计算对应槽的值.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">seedrand</span><span class="p">(</span><span class="nx">x</span> <span class="kt">int32</span><span class="p">)</span> <span class="kt">int32</span> <span class="p">{</span>
 <span class="kd">const</span> <span class="p">(</span>
  <span class="nx">A</span> <span class="p">=</span> <span class="mi">48271</span>
  <span class="nx">Q</span> <span class="p">=</span> <span class="mi">44488</span>
  <span class="nx">R</span> <span class="p">=</span> <span class="mi">3399</span>
 <span class="p">)</span>

 <span class="nx">hi</span> <span class="o">:=</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">Q</span>
 <span class="nx">lo</span> <span class="o">:=</span> <span class="nx">x</span> <span class="o">%</span> <span class="nx">Q</span>
 <span class="nx">x</span> <span class="p">=</span> <span class="nx">A</span><span class="o">*</span><span class="nx">lo</span> <span class="o">-</span> <span class="nx">R</span><span class="o">*</span><span class="nx">hi</span>
 <span class="k">if</span> <span class="nx">x</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
  <span class="nx">x</span> <span class="o">+=</span> <span class="nx">int32max</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="nx">x</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个函数的计算结果并不是随机的, 而是根据 seed 实际算出来的. 另外这个函数并不是随便写的, 是有相关的数学证明的.</p>
<p>这也导致了相同的 seed, 最终设置到 rng.vec里面的值是相同的, 通过 Intn 取出的也是相同的值.</p>
<h3 id="我遇到的那些坑">我遇到的那些坑<a hidden class="anchor" aria-hidden="true" href="#我遇到的那些坑">#</a></h3>
<h4 id="rand-panic">rand panic<a hidden class="anchor" aria-hidden="true" href="#rand-panic">#</a></h4>
<p>文章开头的截图就是项目开发中使用别人封装的底层库, 在某天出现的 panic. 大概实现的代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// random.go
</span><span class="c1"></span>
<span class="kd">var</span> <span class="p">(</span>
 <span class="nx">rrRand</span> <span class="p">=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">NewSource</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">()))</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Random</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Random</span><span class="p">)</span> <span class="nf">Balance</span><span class="p">(</span><span class="nx">sf</span><span class="o">*</span><span class="nx">service</span><span class="p">.</span><span class="nx">Service</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// .. 通过服务发现获取到一堆ip+port, 然后随机拿到其中的一些ip和port出来
</span><span class="c1"></span> <span class="nx">randIndexes</span> <span class="o">:=</span> <span class="nx">rrRand</span><span class="p">.</span><span class="nf">Perm</span><span class="p">(</span><span class="nx">randMax</span><span class="p">)</span>

 <span class="c1">// 返回这些ip 和port
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这个 Random 会被并发调用, 由于 rrRand 不是并发安全的, 所以就导致了调用 rrRand.Perm 时偶尔会出现 panic 情况.</p>
<p>在使用 math/rand 的时候, 有些人使用 <code>math.Intn()</code>, 看了下注释发现是全局共享了一个锁, 担心出现锁竞争, 所以用 rand.New 来初始化一个新的 rand, 但是要注意到 rand.New 初始化出来的 rand 并不是并发安全的.</p>
<p>修复方案: 就是把 rrRand 换成了 globalRand, 在线上高并发场景下, 发现全局锁影响并不大.</p>
<h4 id="获取的都是同一个机器">获取的都是同一个机器<a hidden class="anchor" aria-hidden="true" href="#获取的都是同一个机器">#</a></h4>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210618121457.png" alt=""  />
</p>
<p>同样也是底层封装的 rpc 库, 使用 random 的方式来流量分发, 在线上跑了一段时间后, 流量都路由到一台机器上了, 导致服务直接宕机. 大概实现代码:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Call</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">service</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">data</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="nx">ins</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ral</span><span class="p">.</span><span class="nf">GetInstance</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ral</span><span class="p">.</span><span class="nx">TYPE_HTTP</span><span class="p">,</span> <span class="nx">service</span><span class="p">)</span>
 <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="c1">// 错误处理
</span><span class="c1"></span> <span class="p">}</span>
 <span class="k">defer</span> <span class="nx">ins</span><span class="p">.</span><span class="nf">Release</span><span class="p">()</span>

 <span class="k">if</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">ins</span><span class="p">.</span><span class="nf">Request</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">head</span><span class="p">);</span> <span class="nx">e</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="c1">// 错误处理
</span><span class="c1"></span> <span class="p">}</span>
 <span class="c1">// 其他逻辑, 重试等等
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">GetInstance</span><span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">modType</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="c1">// 其他逻辑..
</span><span class="c1"></span>
 <span class="k">switch</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Strategy</span> <span class="p">{</span>
 <span class="k">case</span> <span class="nx">WITH_RANDOM</span><span class="p">:</span>
  <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rand</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
   <span class="nx">res</span><span class="p">.</span><span class="nx">rand</span> <span class="p">=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nf">NewSource</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Unix</span><span class="p">()))</span>
  <span class="p">}</span>
  <span class="nx">which</span> <span class="p">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span>
 <span class="k">case</span> <span class="nx">其他负载均衡查了</span>
 <span class="p">}</span>

 <span class="c1">// 返回其中一个ip和port
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>引起问题的原因: 可以看出来每次请求到来都是利用 GetInstance 来获取一个 ip 和 port, 如果采用 Random 方式的流量负载均衡, 每次都是重新初始化一个 rand. 我们已经知道当设置相同的种子, 每次运行的结果都是一样的. 当瞬间流量过大时, 并发请求 GetInstance, 由于那一刻 time.Now().Unix() 的值是一样的, 这样就会导致获取到随机数都是一样的, 所以就导致最后获取到的 ip, port 都是一样的, 流量都分发到这台机器上了.</p>
<p>修复方案: 修改成 globalRand 即可.</p>
<h3 id="rand-未来期望">rand 未来期望<a hidden class="anchor" aria-hidden="true" href="#rand-未来期望">#</a></h3>
<p>说到这里基本上可以看出来, 为了防止全局锁竞争问题, 在使用 math/rand 的时候, 首先都会想到自定义 rand, 但是就容易整出来莫名其妙的问题.</p>
<p>为什么 math/rand 需要加锁呢?</p>
<p>大家都知道 math/rand 是伪随机的, 但是在设置完 seed 后, rng.vec 数组的值基本上就确定下来了, 这明显就不是随机了, 为了增加随机性, 通过 Uint64() 获取到随机数后, 还会重新去设置 rng.vec. 由于存在并发获取随机数的需求, 也就有了并发设置 rng.vec 的值, 所以需要对 rng.vec 加锁保护.</p>
<h2 id="cryptorand-包">crypto/rand 包<a hidden class="anchor" aria-hidden="true" href="#cryptorand-包">#</a></h2>
<p>crypto/rand 包实现了用于加解密的更安全的随机数生成器</p>
<h3 id="主要方法-1">主要方法<a hidden class="anchor" aria-hidden="true" href="#主要方法-1">#</a></h3>
<h4 id="variables">Variables<a hidden class="anchor" aria-hidden="true" href="#variables">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">Reader</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span>
</code></pre></td></tr></table>
</div>
</div><p>Reader是一个全局、共享的密码用强随机数生成器。在Unix类型系统中，会从/dev/urandom读取；而Windows中会调用CryptGenRandom API。</p>
<p>举例说明该如何使用Reader：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;encoding/base64&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
    <span class="s">&#34;io&#34;</span>
<span class="p">)</span>

<span class="c1">//sessionId函数用来生成一个session ID，即session的唯一标识符
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">sessionId</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="c1">//ReadFull从rand.Reader精确地读取len(b)字节数据填充进b
</span><span class="c1"></span>    <span class="c1">//rand.Reader是一个全局、共享的密码用强随机数生成器
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="c1">//[62 186 123 16 209 19 130 218 146 136 171 211 12 233 45 99 80 200 59 20 56 254 170 110 59 147 223 177 48 136 220 142]
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">URLEncoding</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="c1">//将生成的随机数b编码后返回字符串,该值则作为session ID
</span><span class="c1"></span><span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">sessionId</span><span class="p">())</span> <span class="c1">//Prp7ENETgtqSiKvTDOktY1DIOxQ4_qpuO5PfsTCI3I4=
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="func-int">func Int<a hidden class="anchor" aria-hidden="true" href="#func-int">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Int</span><span class="p">(</span><span class="nx">rand</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">max</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span><span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>返回一个在[0, max)区间服从均匀分布的随机值，如果max&lt;=0则会panic。</p>
<p>举例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
    <span class="s">&#34;math/big&#34;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//从128开始，这样就能够将(max.BitLen() % 8) == 0的情况包含在里面
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="mi">128</span><span class="p">;</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">140</span><span class="p">;</span> <span class="nx">n</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">b</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">).</span><span class="nf">SetInt64</span><span class="p">(</span><span class="nb">int64</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span> <span class="c1">//将new(big.Int)设为int64(n)并返回new(big.Int)
</span><span class="c1"></span>        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;max Int is : %v\n&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
        <span class="nx">i</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Can&#39;t generate random value: %v, %v&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;rand Int is : %v\n&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">bogon</span><span class="o">:~</span> <span class="n">user</span><span class="o">$</span> <span class="n">go</span> <span class="n">run</span> <span class="n">testGo.go</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">128</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">25</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">129</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">117</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">130</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">85</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">131</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">62</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">132</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">27</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">133</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">120</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">134</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">10</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">135</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">27</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">136</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">11</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">137</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">119</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">138</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">35</span>
<span class="n">max</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">139</span>
<span class="n">rand</span> <span class="n">Int</span> <span class="n">is</span> <span class="o">:</span> <span class="m">83</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="func-prime">func Prime<a hidden class="anchor" aria-hidden="true" href="#func-prime">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Prime</span><span class="p">(</span><span class="nx">rand</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">bits</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">big</span><span class="p">.</span><span class="nx">Int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>返回一个具有指定字位数的数字，该数字具有很高可能性是质数。如果从rand读取时出错，或者bits&lt;2会返回错误。</p>
<p>举例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">n</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Prime</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="c1">//n代表位数，比如3为2位，127为7位
</span><span class="c1"></span>        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Can&#39;t generate %d-bit prime: %v&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nf">BitLen</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">n</span> <span class="p">{</span> <span class="c1">//返回p的绝对值的字位数，0的字位数为0
</span><span class="c1"></span>            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v is not %d-bit&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">p</span><span class="p">.</span><span class="nf">ProbablyPrime</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//对p进行32次Miller-Rabin质数检测。如果方法返回真则p是质数的几率为1-(1/4)**32；否则p不是质数
</span><span class="c1"></span>            <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%v is not prime&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">bogon</span><span class="o">:~</span> <span class="n">user</span><span class="o">$</span> <span class="n">go</span> <span class="n">run</span> <span class="n">testGo.go</span>
<span class="m">3</span>
<span class="m">7</span>
<span class="m">13</span>
<span class="m">31</span>
<span class="m">53</span>
<span class="m">109</span>
<span class="m">223</span>
<span class="m">439</span>
</code></pre></td></tr></table>
</div>
</div><p>如果位数小于2的话，会报错：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
    <span class="s">&#34;log&#34;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Prime</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">//n代表位数，比如3为2位，127为7位
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">bogon</span><span class="o">:~</span> <span class="n">user</span><span class="o">$</span> <span class="n">go</span> <span class="n">run</span> <span class="n">testGo.go</span>
<span class="m">2019</span><span class="o">/</span><span class="m">02</span><span class="o">/</span><span class="m">23</span> <span class="m">12</span><span class="o">:</span><span class="m">31</span><span class="o">:</span><span class="m">37</span> <span class="n">crypto</span><span class="o">/</span><span class="n">rand</span><span class="o">:</span> <span class="n">prime</span> <span class="n">size</span> <span class="n">must</span> <span class="n">be</span> <span class="n">at</span> <span class="n">least</span> <span class="m">2</span><span class="o">-</span><span class="n">bit</span>
<span class="n">exit</span> <span class="n">status</span> <span class="m">1</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="func-read">func Read<a hidden class="anchor" aria-hidden="true" href="#func-read">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>本函数是一个使用io.ReadFull调用Reader.Read的辅助性函数。当且仅当err == nil时，返回值n == len(b)。</p>
<p>因为本函数是一个使用io.ReadFull调用Reader.Read的辅助性函数，所以最上面的那个生成session ID的例子等价于：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>
<span class="kn">import</span><span class="p">(</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;encoding/base64&#34;</span>
    <span class="s">&#34;crypto/rand&#34;</span>
<span class="p">)</span>

<span class="c1">//sessionId函数用来生成一个session ID，即session的唯一标识符
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">sessionId</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="c1">//rand.Reader是一个全局、共享的密码用强随机数生成器
</span><span class="c1"></span>    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">&#34;&#34;</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">b</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span> <span class="c1">//[154 94 244 2 147 96 148 6 13 27 3 52 231 127 160 159 40 47 84 116 79 87 160 217 185 216 47 143 101 107 219 178]
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">URLEncoding</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span><span class="c1">//将生成的随机数b编码后返回字符串,该值则作为session ID
</span><span class="c1"></span><span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nf">sessionId</span><span class="p">())</span> <span class="c1">//ml70ApNglAYNGwM053-gnygvVHRPV6DZudgvj2Vr27I=
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="代码示例-1">代码示例<a hidden class="anchor" aria-hidden="true" href="#代码示例-1">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;crypto/rand&#34;</span>
    <span class="s">&#34;encoding/base64&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;math/big&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//1、Int
</span><span class="c1"></span>    <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Int</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">big</span><span class="p">.</span><span class="nf">NewInt</span><span class="p">(</span><span class="mi">128</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rand.Int：&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">.</span><span class="nf">BitLen</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="c1">//2、Prime
</span><span class="c1"></span>    <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Prime</span><span class="p">(</span><span class="nx">rand</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rand.Prime：&#34;</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">//3、Read
</span><span class="c1"></span>    <span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
    <span class="nx">m</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rand</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rand.Read：&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">[:</span><span class="nx">m</span><span class="p">])</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;rand.Read：&#34;</span><span class="p">,</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">URLEncoding</span><span class="p">.</span><span class="nf">EncodeToString</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">rand.Int</span>： <span class="m">92</span> <span class="m">7</span>
<span class="n">rand.Prime</span>： <span class="m">29</span>
<span class="n">rand.Read</span>： <span class="n">[207</span> <span class="m">47</span> <span class="m">241</span> <span class="m">208</span> <span class="m">190</span> <span class="m">84</span> <span class="m">109</span> <span class="m">134</span> <span class="m">86</span> <span class="m">106</span> <span class="m">87</span> <span class="m">223</span> <span class="m">111</span> <span class="m">113</span> <span class="m">203</span> <span class="m">155</span> <span class="m">44</span> <span class="m">118</span> <span class="m">71</span> <span class="m">20</span> <span class="m">186</span> <span class="m">62</span> <span class="m">66</span> <span class="m">130</span> <span class="m">244</span> <span class="m">98</span> <span class="m">97</span> <span class="m">184</span> <span class="m">8</span> <span class="m">179</span> <span class="m">6</span> <span class="m">230</span><span class="n">]</span>
<span class="n">rand.Read</span>： <span class="n">zy_x0L5UbYZWalffb3HLmyx2RxS6PkKC9GJhuAizBuY</span><span class="o">=</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<p><a href="https://blog.csdn.net/whatday/article/details/106617208">golang 随机数 math/rand包 crypto/rand包</a></p>
<p><a href="https://segmentfault.com/a/1190000021543499">Golang: math/rand 和 crypto/rand 区别</a></p>
<p><a href="https://www.cnblogs.com/wanghui-garcia/p/10421659.html">go标准库的学习-crypto/rand</a></p>
<p><a href="https://mp.weixin.qq.com/s/zQq9lEDLGPh7shvJLm0AuQ">深度解密 Go math/rand</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
