<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>pprof实战:结合benchmark优化代码 | Forz Blog</title>
<meta name="keywords" content="Go" />
<meta name="description" content="示例代码:数独 sodoku.go: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62">
<meta name="author" content="">
<link rel="canonical" href="/post/pprof%E5%AE%9E%E6%88%98%E7%BB%93%E5%90%88benchmark%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="pprof实战:结合benchmark优化代码" />
<meta property="og:description" content="示例代码:数独 sodoku.go: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/pprof%E5%AE%9E%E6%88%98%E7%BB%93%E5%90%88benchmark%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-01-31T23:09:56&#43;00:00" />
<meta property="article:modified_time" content="2020-01-31T23:09:56&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="pprof实战:结合benchmark优化代码"/>
<meta name="twitter:description" content="示例代码:数独 sodoku.go: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "pprof实战:结合benchmark优化代码",
      "item": "/post/pprof%E5%AE%9E%E6%88%98%E7%BB%93%E5%90%88benchmark%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "pprof实战:结合benchmark优化代码",
  "name": "pprof实战:结合benchmark优化代码",
  "description": "示例代码:数独 sodoku.go: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62",
  "keywords": [
    "Go"
  ],
  "articleBody": "示例代码:数独 sodoku.go:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328  // Package godoku is a simple, brute-force, // in-place sudoku solver package godoku import ( \"bytes\" \"fmt\" \"io/ioutil\" \"strconv\" \"strings\" ) type Sudoku struct { board Board solved bool solutionCount int doPrint bool dim int solveAll bool solution Board } type Board [][]int func (s *Sudoku) PrintBoard() { for _, row := range s.board { fmt.Println(row) } } // IsValidBoard iterates through all initial // values on the board and verifies that they indeed // abide by the 3 laws of Sudoku func (s *Sudoku) IsValidBoard() bool { if s.board == nil { return false } for i, row := range s.board { for j, val := range row { if val == 0 { continue } s.board[i][j] = 0 if !s.ValidValueAtPosition(i, j, val) { s.board[i][j] = val return false } s.board[i][j] = val } } return true } // String returns either the unsolved board if the // sudoku has not been solved, or the solution // if such a solution has been found // by running one of the Solve* methods. func (s *Sudoku) String() string { var buffer bytes.Buffer if s.solved { for _, row := range s.solution { buffer.WriteString(fmt.Sprintf(\"%v\\n\", row)) } return buffer.String() } for _, row := range s.board { buffer.WriteString(fmt.Sprintf(\"%v\\n\", row)) } return buffer.String() } // GetSolution returns the solution // BUG(paddie): doesn't check if board is solved func (s *Sudoku) GetSolution() Board { return s.solution } // Load a sudoku from a path and a dimension argument func NewSudokuFromFile(path string, dim int) (*Sudoku, error) { s := new(Sudoku) var err error s.board, err = readBoardFromFile(path, dim) if err != nil { return nil, err } s.dim = dim return s, nil } // Loads a sudoku-board in a string-representation; // The values are in a 9x9 matrix, using space \" \" as delimiters and '\\n' as linebreaks func NewSudokuFromString(path string, dim int) (*Sudoku, error) { s := new(Sudoku) var err error s.board, err = readBoardFromString(path, dim) if err != nil { return nil, err } s.dim = dim return s, nil } /* Returns the number of solutions found. */ func (s *Sudoku) GetSolutionsCount() int { return s.solutionCount } // registers the first solutions in the s.solution // board, and prints if doPrint is set. func (s *Sudoku) registerSolution() { s.solutionCount++ if s.doPrint { s.PrintBoard() } if s.solved { return } s.solved = true s.solution = make(Board, 9, 9) for i, row := range s.board { s.solution[i] = make([]int, 9, 9) copy(s.solution[i], row) } } // Check if the solver has found a solution func (s *Sudoku) IsSolved() bool { return s.solved } // The dimensions of the sudoku board func (s *Sudoku) Dimension() int { return s.dim } // Solve and save the solution. Returns an error if no Sudoku has been loaded func (s *Sudoku) Solve() error { s.solved = false if s.board == nil { return fmt.Errorf(\"No Board has been loaded..\") } s.solveAll = false s.bruteforcePosition(0, 0) return nil } // Same as Solve(), but this one also prints // the solution to stdin func (s *Sudoku) SolveAndPrint() error { s.doPrint = true err := s.Solve() s.doPrint = false return err } // Same as Solve, but keeps running until it has all // the solutions and keeps a count. It only saves the first solution func (s *Sudoku) SolveAll() error { s.solved = false if s.board == nil { return fmt.Errorf(\"No Board has been loaded..\") } s.solveAll = true s.bruteforcePosition(0, 0) return nil } // Same as SolveAll but prints all the solutions // to stdin func (s *Sudoku) SolveAllAndPrint() error { s.doPrint = true err := s.SolveAll() s.doPrint = false return err } func (s *Sudoku) bruteforcePosition(row, col int) { // we use '0' to indicate a non-filled block \tif s.board[row][col] == 0 { for i := 1; i  10; i++ { if s.ValidValueAtPosition(row, col, i) { // place the value and attempt to solve \ts.board[row][col] = i // attempt to solve the sudoku with placed value \ts.nextPosition(row, col) if s.solved \u0026\u0026 !s.solveAll { // if Solve() was used, we break \t// after first solution \ts.board[row][col] = 0 return } // clean up after attempt \ts.board[row][col] = 0 } } } else { s.nextPosition(row, col) } } // Does two things: // // 1) if the board is in a finished state, calls // registerSolution() and returns; // enables bruteforcePostion to exhaust every remaining permutation // // 2) checks wether to move to next column or next row func (s *Sudoku) nextPosition(row, col int) { // we run through the Board row by row \t// meaning we only change rows when we're in \t// the final column \tif col  8 { s.bruteforcePosition(row, col+1) } else { // if we're in the final collumn in the final \t// row; we have a solution \t// - else we iterate to next row and reset the collumn \tif row  8 { s.bruteforcePosition(row+1, 0) } else { s.registerSolution() } } } // Verify that _val_ can be legally placed at (row,col) // given restrictions in column, row and 3x3 square func (s *Sudoku) ValidValueAtPosition(row, col, val int) bool { if s.ValidInSquare(row, col, val) \u0026\u0026 s.ValidInColumnAndRow(row, col, val) { // validInRow(row, val, Board) { \treturn true } return false } // Checks that the _val_ does not already occur in the // active 3x3 square func (s *Sudoku) ValidInSquare(row, col, val int) bool { row, col = int(row/3)*3, int(col/3)*3 for i := row; i  row+3; i++ { for j := col; j  col+3; j++ { //fmt.Printf(\"row, col = %v, %v\\n\", i, j) \tif s.board[i][j] == val { return false } } } return true } // Checks if _val_ already occurs in either the row or the column. func (s *Sudoku) ValidInColumnAndRow(row, col, val int) bool { for i := 0; i  9; i++ { if s.board[row][i] == val || s.board[i][col] == val { return false } } return true } func readBoardFromFile(path string, dim int) (Board, error) { content, err := ioutil.ReadFile(path) if err != nil { return nil, err } return readBoardFromString(string(content), dim) } func readBoardFromString(m string, dim int) (Board, error) { lines := strings.Split(m, \"\\n\") if len(lines)  dim { return nil, fmt.Errorf(\"row count of input: %v does not match dim: %v\", len(lines), dim) } Board := make(Board, dim, dim) for i := 0; i  dim; i++ { stringRows := strings.Split(lines[i], \" \") if len(stringRows)  dim { return nil, fmt.Errorf(\"column count of input: %v does not match dim: %v\", len(lines[i]), dim) } integerRow := make([]int, dim, dim) for j := 0; j  dim; j++ { str := stringRows[j] val, err := strconv.Atoi(str) if err != nil { return nil, err } integerRow[j] = val } Board[i] = integerRow } return Board, nil }   soduku_test.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210  package godoku import ( // \"fmt\" \t\"testing\" ) const solvable88 string = `0 7 0 0 0 0 0 8 0 0 3 0 7 6 2 0 0 1 0 0 1 9 8 0 0 0 0 1 0 0 0 0 0 0 0 0 8 0 3 0 0 0 0 0 2 0 0 6 0 0 0 0 0 8 0 0 0 0 3 1 6 0 0 5 0 0 2 4 9 0 1 0 0 1 0 0 0 0 0 9 0` const badRow string = `0 7 0 0 0 0 0 8 0 0 3 0 7 6 2 0 0 1 0 0 1 9 8 0 0 0 0 1 0 0 0 0 0 0 0 8 0 3 0 0 0 0 0 2 0 0 6 0 0 0 0 0 8 0 0 0 0 3 1 6 0 0 5 0 0 2 4 9 0 1 0 0 1 0 0 0 0 0 9 0` const badCol string = `0 7 0 0 0 0 0 8 0 0 3 0 7 6 2 0 0 1 0 0 1 9 8 0 0 0 0 1 0 0 0 0 0 0 0 0 8 0 3 0 0 0 0 0 2 0 0 6 0 0 0 0 0 8 0 0 0 0 3 1 6 0 0 5 0 0 2 4 9 0 1 0` const hard string = `0 0 0 0 0 0 0 0 0 0 0 1 0 0 3 0 0 0 8 0 0 0 0 0 0 0 6 0 0 0 2 0 9 0 1 0 6 4 0 0 0 0 9 0 0 0 0 0 0 0 0 0 0 0 0 0 2 0 0 0 7 3 0 7 0 0 6 4 0 0 0 0 0 0 0 8 0 0 0 0 0` const invalidBoard string = `8 0 0 0 0 0 0 0 0 0 0 1 0 0 3 0 0 0 8 0 0 0 0 0 0 0 6 0 0 0 2 0 9 0 1 0 6 4 0 0 0 0 9 0 0 0 0 0 0 0 0 0 0 0 0 0 2 0 0 0 7 3 0 7 0 0 6 4 0 0 0 0 0 0 0 8 0 0 0 0 0` const badFormatting = `0 7 0 0 0 0 0 8 0 0 3 0 7 6 2 0 0 1 0 0 1 9 8 0 0 0 0 6 1 0 0 0 0 0 0 0 0 8 0 3 0 0 0 0 0 2 7 0 0 6 0 0 0 0 0 8 0 0 0 0 3 1 6 0 0 5 0 0 2 4 9 0 1 0 0 1 0 0 0 0 0 9 0 ` const noSolution string = `7 0 8 0 0 0 7 0 0 0 0 0 0 6 0 0 5 0 0 0 0 9 0 0 0 2 4 1 6 7 0 0 8 0 0 5 0 0 0 6 3 0 9 0 0 9 3 0 7 1 4 2 0 0 8 0 0 1 5 2 4 6 3 5 0 6 0 4 9 8 1 7 3 1 4 8 7 0 5 9 2` // solution output const solution string = `[2 7 9 1 5 3 4 8 6] [4 3 8 7 6 2 9 5 1] [6 5 1 9 8 4 3 2 7] [1 4 5 3 2 8 7 6 9] [8 9 3 6 1 7 5 4 2] [7 2 6 4 9 5 1 3 8] [9 8 2 5 3 1 6 7 4] [5 6 7 2 4 9 8 1 3] [3 1 4 8 7 6 2 9 5] ` // solve only one of the 88 solutions func TestSolve1(t *testing.T) { s, err := NewSudokuFromString(solvable88, 9) if err != nil { t.Error(err) } s.Solve() if s.GetSolutionsCount() != 1 { t.Errorf(\"Expected 1 != Actual %v\", s.GetSolutionsCount()) } if s.String() != solution { t.Errorf(\"Expected\\n%v != Actual \\n%v\", solution, s) } } // make sure that the solver gets all 88 solutions func TestSolve88(t *testing.T) { s, err := NewSudokuFromString(solvable88, 9) if err != nil { t.Error(err) } s.SolveAll() if s.GetSolutionsCount() != 88 { t.Errorf(\"Expected 88 != Actual %v\", s.GetSolutionsCount()) } // should be the first solution and not the 88th solution \t// - same as testsolve01 \tif s.String() != solution { t.Errorf(\"Expected\\n%v != Actual \\n%v\", solution, s) } } // test that the package is resillient against trailing spaces etc. func TestBadFormatting(t *testing.T) { s, err := NewSudokuFromString(badFormatting, 9) if err != nil { t.Error(err) } s.Solve() if s.GetSolutionsCount() != 1 { t.Errorf(\"Expected 1 != Actual %v\", s.GetSolutionsCount()) } } // test that provided sudoku has at least Dim x Dim dimension func TestBadDims(t *testing.T) { _, err := NewSudokuFromString(badRow, 9) if err == nil { t.Error(err) } _, err = NewSudokuFromString(badCol, 9) if err == nil { t.Error(err) } } // test that it reports correctly if the sudoky does // not have any solutions func TestFail(t *testing.T) { // load sudoku \ts, err := NewSudokuFromString(noSolution, 9) if err != nil { t.Error(err) } s.Solve() if s.IsSolved() != false { t.Errorf(\"Expected: 'false' != Actual: %v\", s.IsSolved()) } } // ones the board has been read, validate it for // erroneously positioned starting values func TestInvalidBoard(t *testing.T) { // test that invalid board is invalid \ts, err := NewSudokuFromString(invalidBoard, 9) if err != nil { t.Error(err) } if s.IsValidBoard() { t.Errorf(\"Expected: 'false' != Actual: %v\", s.IsValidBoard()) } // test that valid board is not invalid \ts, err = NewSudokuFromString(solvable88, 9) if err != nil { t.Error(err) } if !s.IsValidBoard() { t.Errorf(\"Expected: 'true' != Actual: %v\", s.IsValidBoard()) } } // bench the solving of the hardest sudoku func BenchmarkSolveHard(b *testing.B) { b.StopTimer() s, err := NewSudokuFromString(hard, 9) if err != nil { b.Error(err) } b.StartTimer() s.Solve() } // bench how long it takes to get a \"no solution\" answer func BenchmarkSolveFail(b *testing.B) { b.StopTimer() s, err := NewSudokuFromString(noSolution, 9) if err != nil { b.Error(err) } b.StartTimer() for i := 0; i  b.N; i++ { // s.Reset() \ts.Solve() } }   main.go:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  package main import ( \"fmt\" \"github.com/paddie/godoku\" ) const solvable88 string = `0 7 0 0 0 0 0 8 0 0 3 0 7 6 2 0 0 1 0 0 1 9 8 0 0 0 0 1 0 0 0 0 0 0 0 0 8 0 3 0 0 0 0 0 2 0 0 6 0 0 0 0 0 8 0 0 0 0 3 1 6 0 0 5 0 0 2 4 9 0 1 0 0 1 0 0 0 0 0 9 0` func main() { s, err := godoku.NewSudokuFromString(solvable88, 9) if err != nil { fmt.Println(err) return } // check that board is valid \tif !s.IsValidBoard() { fmt.Println(\"Invalid board\") return } fmt.Println(s) // solve the board \ts.Solve() // print the solution \tfmt.Println(s) // checks the number of solutions; 1 in this case \tif s.GetSolutionsCount() != 1 { fmt.Printf(\"Expected 1 != Actual %v\\n\", s.GetSolutionsCount()) return } fmt.Println(\"This sudoku has one solution!\\n\") }   优化 Godoku 是一个 Go 编写的暴力破解数独的程序，逻辑比较简单，从上到下从左到右扫描每一个空格，从 1 到 9 开始填写数字，一旦数字无效（行冲突，列冲突或者 9 宫格冲突），那么就换一个数字，如果所有数字都换了还无效，那么就退回上一个格子，继续这个过程。\nStep1 程序自带了测试和 Benchmark，所以我们先来生成一个 Profiling 文件，看看哪个地方开销最大。\n1 2  $ go tool pprof godoku.test cpu.prof $ go tool pprof -http=\":8081\" godoku.test cpu.prof   很明显，ValidInSquare这个函数开销很大，这个函数是检测一个数字在九宫格里面存不存在，作者的实现如下。\n1 2 3 4 5 6 7 8 9 10 11 12 13  func (s *Sudoku) ValidInSquare(row, col, val int) bool { row, col = int(row/3)*3, int(col/3)*3 for i := row; i  row+3; i++ { for j := col; j  col+3; j++ { //fmt.Printf(\"row, col = %v, %v\\n\", i, j) \tif s.board[i][j] == val { return false } } } return true }   循环判断有没有这个数，逻辑很简单，但是 Profiling 告诉我们，这里成了性能瓶颈，每一次测试数字都要调用这个方法，而这个方法内部是一个循环，调用如此频繁的方法采用循环肯定是不行的。\nStep2 这里我们采用经典的 空间换时间 思路，使用另外一个结构存储九宫格内的状态信息，使得查询一个数字在九宫格内有没有可以通过简单的数组访问得到。\n1 2 3 4 5 6 7 8 9 10 11 12 13  s.regionInfo = make([]int, s.dim * s.dim / 9) func (s *Sudoku) updateRegion(row, col, val, delta int) { region := (row/3)*3 + col/3 key := region*9 + val - 1 s.regionInfo[key] += delta } func (s *Sudoku) checkRegion(row, col, val int) bool { region := (row/3)*3 + col/3 key := region*9 + val - 1 return s.regionInfo[key] == 1 }   我们使用一个额外的 regionInfo slice 来存储九宫格里的情况，每一次设置数独中格子的值时，我们更新一下 regionInfo 的信息。当要检查某个数在某个九宫格中是否已经存在时，直接查询 regionInfo 即可。\n1 2 3  func (s *Sudoku) ValidInSquare(row, col, val int) bool { return !s.checkRegion(row, col, val) }   再运行一次测试，看看性能改善了多少。\n很好！CPU 开销已经由 9770ms 降低到了 5460ms，性能提高 79%。现在程序的性能瓶颈已经是 ValidInColumnAndRow 这个函数了。\nStep3 作者 ValidInColumnAndRow 函数的实现仍然是直观简单的循环。\n1 2 3 4 5 6 7 8 9  func (s *Sudoku) ValidInColumnAndRow(row, col, val int) bool { for i := 0; i  9; i++ { if s.board[row][i] == val || s.board[i][col] == val { return false } } return true }   我们使用同样的策略来优化 ValidInColumnAndRow 这个函数，使用额外的数据结构存储每一行和每一列的数字状态信息。这样查询时可以马上返回，而不需要做任何循环比较。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  func (s *Sudoku) updateRowAndCol(row, col, val, delta int) { rowKey := row*9 + val - 1 colKey := col*9 + val - 1 s.rowInfo[rowKey] += delta s.colInfo[colKey] += delta } func (s *Sudoku) checkRowOrCol(row, col, val int) bool { rowKey := row*9 + val - 1 colKey := col*9 + val - 1 return s.rowInfo[rowKey] == 1 || s.colInfo[colKey] == 1 } func (s *Sudoku) ValidInColumnAndRow(row, col, val int) bool { return !s.checkRowOrCol(row, col, val) }   我们再来看看 Profiling 数据。\n性能再次得到了提升，由 5460ms 降低到了 3610ms。初步看来，已经没有了明显可以优化的地方了。到此为止，我们的程序性能已经得到了 170% 的提升！我们并没有怎么努力，只不过是生成了 Profiling 文件，一眼看出问题在哪儿，然后针对性地优化而已。\n感谢 Golang 提供了这套超赞的 pprof 工具，性能调优变得如此轻松和愉悦。这里我所举的只是 pprof 功能的冰山一角，pprof 的强大功能远不止这些。比如可以使用 list 指令查看函数的源码中每一行代码的开销以及使用 weblist 指令查看函数汇编以后每一句汇编指令的开销等等。不仅是 CPU Profiling，pprof 同样支持 Memory Profiling，可以帮助你检查程序中内存的分配情况。总之，在 pprof 的帮助下，程序的开销信息变得一清二楚，优化自然变得轻而易举。\n转载:https://cjting.me/2016/11/14/use-pprof-to-optimize-go/\n",
  "wordCount" : "4241",
  "inLanguage": "zh-cn",
  "datePublished": "2020-01-31T23:09:56Z",
  "dateModified": "2020-01-31T23:09:56Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/pprof%E5%AE%9E%E6%88%98%E7%BB%93%E5%90%88benchmark%E4%BC%98%E5%8C%96%E4%BB%A3%E7%A0%81/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      pprof实战:结合benchmark优化代码
    </h1>
    <div class="post-meta">January 31, 2020
</div>
  </header> 
  <div class="post-content"><h1 id="示例代码数独">示例代码:数独<a hidden class="anchor" aria-hidden="true" href="#示例代码数独">#</a></h1>
<p>sodoku.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Package godoku is a simple, brute-force,
</span><span class="c1">// in-place sudoku solver
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">godoku</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;bytes&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;io/ioutil&#34;</span>
	<span class="s">&#34;strconv&#34;</span>
	<span class="s">&#34;strings&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Sudoku</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">board</span>         <span class="nx">Board</span>
	<span class="nx">solved</span>        <span class="kt">bool</span>
	<span class="nx">solutionCount</span> <span class="kt">int</span>
	<span class="nx">doPrint</span>       <span class="kt">bool</span>
	<span class="nx">dim</span>           <span class="kt">int</span>
	<span class="nx">solveAll</span>      <span class="kt">bool</span>
	<span class="nx">solution</span>      <span class="nx">Board</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Board</span> <span class="p">[][]</span><span class="kt">int</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">PrintBoard</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">row</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// IsValidBoard iterates through all initial 
</span><span class="c1">// values on the board and verifies that they indeed
</span><span class="c1">// abide by the 3 laws of Sudoku
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">IsValidBoard</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">row</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">val</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">row</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nf">ValidValueAtPosition</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">val</span>
				<span class="k">return</span> <span class="kc">false</span>
			<span class="p">}</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">val</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1">// String returns either the unsolved board if the
</span><span class="c1">// sudoku has not been solved, or the solution 
</span><span class="c1">// if such a solution has been found
</span><span class="c1">// by running one of the Solve* methods.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">buffer</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">solved</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">row</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">solution</span> <span class="p">{</span>
			<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">row</span><span class="p">))</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">row</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span> <span class="p">{</span>
		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%v\n&#34;</span><span class="p">,</span> <span class="nx">row</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// GetSolution returns the solution
</span><span class="c1">// BUG(paddie): doesn&#39;t check if board is solved
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">GetSolution</span><span class="p">()</span> <span class="nx">Board</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">solution</span>
<span class="p">}</span>

<span class="c1">// Load a sudoku from a path and a dimension argument
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSudokuFromFile</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">dim</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Sudoku</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Sudoku</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">readBoardFromFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">dim</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">dim</span> <span class="p">=</span> <span class="nx">dim</span>

	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Loads a sudoku-board in a string-representation;
</span><span class="c1">// The values are in a 9x9 matrix, using space &#34; &#34; as delimiters and &#39;\n&#39; as linebreaks
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">dim</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Sudoku</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">Sudoku</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">readBoardFromString</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">dim</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">dim</span> <span class="p">=</span> <span class="nx">dim</span>

	<span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="cm">/* 
</span><span class="cm">Returns the number of solutions found.
</span><span class="cm">*/</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">GetSolutionsCount</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">solutionCount</span>
<span class="p">}</span>

<span class="c1">// registers the first solutions in the s.solution
</span><span class="c1">// board, and prints if doPrint is set.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">registerSolution</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">solutionCount</span><span class="o">++</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">doPrint</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">PrintBoard</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">solved</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">s</span><span class="p">.</span><span class="nx">solved</span> <span class="p">=</span> <span class="kc">true</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">solution</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Board</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

	<span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">row</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">solution</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
		<span class="nb">copy</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">solution</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">row</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Check if the solver has found a solution
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">IsSolved</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">solved</span>
<span class="p">}</span>

<span class="c1">// The dimensions of the sudoku board
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">Dimension</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dim</span>
<span class="p">}</span>

<span class="c1">// Solve and save the solution. Returns an error if no Sudoku has been loaded
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">Solve</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>

	<span class="nx">s</span><span class="p">.</span><span class="nx">solved</span> <span class="p">=</span> <span class="kc">false</span>

	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;No Board has been loaded..&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">s</span><span class="p">.</span><span class="nx">solveAll</span> <span class="p">=</span> <span class="kc">false</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">bruteforcePosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Same as Solve(), but this one also prints
</span><span class="c1">// the solution to stdin
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">SolveAndPrint</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">doPrint</span> <span class="p">=</span> <span class="kc">true</span>

	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Solve</span><span class="p">()</span>

	<span class="nx">s</span><span class="p">.</span><span class="nx">doPrint</span> <span class="p">=</span> <span class="kc">false</span>

	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="c1">// Same as Solve, but keeps running until it has all
</span><span class="c1">// the solutions and keeps a count. It only saves the first solution
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">SolveAll</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>

	<span class="nx">s</span><span class="p">.</span><span class="nx">solved</span> <span class="p">=</span> <span class="kc">false</span>

	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;No Board has been loaded..&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">s</span><span class="p">.</span><span class="nx">solveAll</span> <span class="p">=</span> <span class="kc">true</span>

	<span class="nx">s</span><span class="p">.</span><span class="nf">bruteforcePosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Same as SolveAll but prints all the solutions
</span><span class="c1">// to stdin
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">SolveAllAndPrint</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">doPrint</span> <span class="p">=</span> <span class="kc">true</span>

	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">SolveAll</span><span class="p">()</span>

	<span class="nx">s</span><span class="p">.</span><span class="nx">doPrint</span> <span class="p">=</span> <span class="kc">false</span>

	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">bruteforcePosition</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// we use &#39;0&#39; to indicate a non-filled block
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">ValidValueAtPosition</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="c1">// place the value and attempt to solve
</span><span class="c1"></span>				<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="p">=</span> <span class="nx">i</span>
				<span class="c1">// attempt to solve the sudoku with placed value
</span><span class="c1"></span>				<span class="nx">s</span><span class="p">.</span><span class="nf">nextPosition</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">)</span>

				<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">solved</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nx">solveAll</span> <span class="p">{</span>
					<span class="c1">// if Solve() was used, we break
</span><span class="c1"></span>					<span class="c1">// after first solution
</span><span class="c1"></span>					<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
					<span class="k">return</span>
				<span class="p">}</span>
				<span class="c1">// clean up after attempt
</span><span class="c1"></span>				<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="p">=</span> <span class="mi">0</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">nextPosition</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Does two things:
</span><span class="c1">//
</span><span class="c1">// 1) if the board is in a finished state, calls 
</span><span class="c1">// registerSolution() and returns; 
</span><span class="c1">// enables bruteforcePostion to exhaust every remaining permutation
</span><span class="c1">// 
</span><span class="c1">// 2) checks wether to move to next column or next row
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">nextPosition</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// we run through the Board row by row
</span><span class="c1"></span>	<span class="c1">// meaning we only change rows when we&#39;re in
</span><span class="c1"></span>	<span class="c1">// the final column
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">col</span> <span class="p">&lt;</span> <span class="mi">8</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">bruteforcePosition</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="c1">// if we&#39;re in the final collumn in the final 
</span><span class="c1"></span>		<span class="c1">// row; we have a solution
</span><span class="c1"></span>		<span class="c1">// - else we iterate to next row and reset the collumn
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">row</span> <span class="p">&lt;</span> <span class="mi">8</span> <span class="p">{</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">bruteforcePosition</span><span class="p">(</span><span class="nx">row</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">s</span><span class="p">.</span><span class="nf">registerSolution</span><span class="p">()</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Verify that _val_ can be legally placed at (row,col)
</span><span class="c1">// given restrictions in column, row and 3x3 square
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">ValidValueAtPosition</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">ValidInSquare</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">ValidInColumnAndRow</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">// validInRow(row, val, Board) {
</span><span class="c1"></span>		<span class="k">return</span> <span class="kc">true</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>

<span class="c1">// Checks that the _val_ does not already occur in the
</span><span class="c1">// active 3x3 square
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">ValidInSquare</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">row</span><span class="p">,</span> <span class="nx">col</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">row</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">col</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">row</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">row</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">col</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
			<span class="c1">//fmt.Printf(&#34;row, col = %v, %v\n&#34;, i, j)
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="nx">val</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">false</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1">// Checks if _val_ already occurs in either the row or the column.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">ValidInColumnAndRow</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">val</span> <span class="o">||</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="o">==</span> <span class="nx">val</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">readBoardFromFile</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">dim</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">Board</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">content</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">ReadFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nf">readBoardFromString</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">content</span><span class="p">),</span> <span class="nx">dim</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">readBoardFromString</span><span class="p">(</span><span class="nx">m</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">dim</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">Board</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">lines</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">dim</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;row count of input: %v does not match dim: %v&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lines</span><span class="p">),</span> <span class="nx">dim</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">Board</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="nx">Board</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">dim</span><span class="p">)</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">dim</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">stringRows</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="s">&#34; &#34;</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">stringRows</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">dim</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;column count of input: %v does not match dim: %v&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">dim</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="nx">integerRow</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">dim</span><span class="p">,</span> <span class="nx">dim</span><span class="p">)</span>
		<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">dim</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
			<span class="nx">str</span> <span class="o">:=</span> <span class="nx">stringRows</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
			<span class="nx">val</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Atoi</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
			<span class="p">}</span>
			<span class="nx">integerRow</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="p">=</span> <span class="nx">val</span>
		<span class="p">}</span>
		<span class="nx">Board</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">integerRow</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">Board</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>soduku_test.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">godoku</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="c1">// &#34;fmt&#34;
</span><span class="c1"></span>	<span class="s">&#34;testing&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">solvable88</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`0 7 0 0 0 0 0 8 0
</span><span class="s">0 3 0 7 6 2 0 0 1
</span><span class="s">0 0 1 9 8 0 0 0 0
</span><span class="s">1 0 0 0 0 0 0 0 0
</span><span class="s">8 0 3 0 0 0 0 0 2
</span><span class="s">0 0 6 0 0 0 0 0 8
</span><span class="s">0 0 0 0 3 1 6 0 0
</span><span class="s">5 0 0 2 4 9 0 1 0
</span><span class="s">0 1 0 0 0 0 0 9 0`</span>

<span class="kd">const</span> <span class="nx">badRow</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`0 7 0 0 0 0 0 8 0
</span><span class="s">0 3 0 7 6 2 0 0 1
</span><span class="s">0 0 1 9 8 0 0 0 0
</span><span class="s">1 0 0 0 0 0 0 0
</span><span class="s">8 0 3 0 0 0 0 0 2
</span><span class="s">0 0 6 0 0 0 0 0 8
</span><span class="s">0 0 0 0 3 1 6 0 0
</span><span class="s">5 0 0 2 4 9 0 1 0
</span><span class="s">0 1 0 0 0 0 0 9 0`</span>

<span class="kd">const</span> <span class="nx">badCol</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`0 7 0 0 0 0 0 8 0
</span><span class="s">0 3 0 7 6 2 0 0 1
</span><span class="s">0 0 1 9 8 0 0 0 0
</span><span class="s">1 0 0 0 0 0 0 0 0
</span><span class="s">8 0 3 0 0 0 0 0 2
</span><span class="s">0 0 6 0 0 0 0 0 8
</span><span class="s">0 0 0 0 3 1 6 0 0
</span><span class="s">5 0 0 2 4 9 0 1 0`</span>

<span class="kd">const</span> <span class="nx">hard</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`0 0 0 0 0 0 0 0 0
</span><span class="s">0 0 1 0 0 3 0 0 0
</span><span class="s">8 0 0 0 0 0 0 0 6
</span><span class="s">0 0 0 2 0 9 0 1 0
</span><span class="s">6 4 0 0 0 0 9 0 0
</span><span class="s">0 0 0 0 0 0 0 0 0
</span><span class="s">0 0 2 0 0 0 7 3 0
</span><span class="s">7 0 0 6 4 0 0 0 0
</span><span class="s">0 0 0 8 0 0 0 0 0`</span>

<span class="kd">const</span> <span class="nx">invalidBoard</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`8 0 0 0 0 0 0 0 0
</span><span class="s">0 0 1 0 0 3 0 0 0
</span><span class="s">8 0 0 0 0 0 0 0 6
</span><span class="s">0 0 0 2 0 9 0 1 0
</span><span class="s">6 4 0 0 0 0 9 0 0
</span><span class="s">0 0 0 0 0 0 0 0 0
</span><span class="s">0 0 2 0 0 0 7 3 0
</span><span class="s">7 0 0 6 4 0 0 0 0
</span><span class="s">0 0 0 8 0 0 0 0 0`</span>

<span class="kd">const</span> <span class="nx">badFormatting</span> <span class="p">=</span> <span class="s">`0 7 0 0 0 0 0 8 0
</span><span class="s">0 3 0 7 6 2 0 0 1    
</span><span class="s">0 0 1 9 8 0 0 0 0 6 
</span><span class="s">1 0 0 0 0 0 0 0 0 
</span><span class="s">8 0 3 0 0 0 0 0 2 7
</span><span class="s">0 0 6 0 0 0 0 0 8
</span><span class="s">0 0 0 0 3 1 6 0 0
</span><span class="s">5 0 0 2 4 9 0 1 0
</span><span class="s">0 1 0 0 0 0 0 9 0
</span><span class="s">`</span>

<span class="kd">const</span> <span class="nx">noSolution</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`7 0 8 0 0 0 7 0 0
</span><span class="s">0 0 0 0 6 0 0 5 0
</span><span class="s">0 0 0 9 0 0 0 2 4
</span><span class="s">1 6 7 0 0 8 0 0 5
</span><span class="s">0 0 0 6 3 0 9 0 0
</span><span class="s">9 3 0 7 1 4 2 0 0
</span><span class="s">8 0 0 1 5 2 4 6 3
</span><span class="s">5 0 6 0 4 9 8 1 7
</span><span class="s">3 1 4 8 7 0 5 9 2`</span>

<span class="c1">// solution output
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">solution</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`[2 7 9 1 5 3 4 8 6]
</span><span class="s">[4 3 8 7 6 2 9 5 1]
</span><span class="s">[6 5 1 9 8 4 3 2 7]
</span><span class="s">[1 4 5 3 2 8 7 6 9]
</span><span class="s">[8 9 3 6 1 7 5 4 2]
</span><span class="s">[7 2 6 4 9 5 1 3 8]
</span><span class="s">[9 8 2 5 3 1 6 7 4]
</span><span class="s">[5 6 7 2 4 9 8 1 3]
</span><span class="s">[3 1 4 8 7 6 2 9 5]
</span><span class="s">`</span>

<span class="c1">// solve only one of the 88 solutions
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestSolve1</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">solvable88</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">Solve</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetSolutionsCount</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected 1 != Actual %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetSolutionsCount</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">solution</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected\n%v != Actual \n%v&#34;</span><span class="p">,</span> <span class="nx">solution</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// make sure that the solver gets all 88 solutions
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestSolve88</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">solvable88</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">SolveAll</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetSolutionsCount</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">88</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected 88 != Actual %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetSolutionsCount</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="c1">// should be the first solution and not the 88th solution
</span><span class="c1"></span>	<span class="c1">// - same as testsolve01
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">String</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">solution</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected\n%v != Actual \n%v&#34;</span><span class="p">,</span> <span class="nx">solution</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// test that the package is resillient against trailing spaces etc.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestBadFormatting</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">badFormatting</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">Solve</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetSolutionsCount</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected 1 != Actual %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetSolutionsCount</span><span class="p">())</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// test that provided sudoku has at least Dim x Dim dimension
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestBadDims</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">badRow</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">badCol</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// test that it reports correctly if the sudoky does 
</span><span class="c1">// not have any solutions
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestFail</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// load sudoku
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">noSolution</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nf">Solve</span><span class="p">()</span>

	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">IsSolved</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">false</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected: &#39;false&#39; != Actual: %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">IsSolved</span><span class="p">())</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ones the board has been read, validate it for 
</span><span class="c1">// erroneously positioned starting values
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">TestInvalidBoard</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// test that invalid board is invalid
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">invalidBoard</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">IsValidBoard</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected: &#39;false&#39; != Actual: %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">IsValidBoard</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="c1">// test that valid board is not invalid
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">solvable88</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nf">IsValidBoard</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">t</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Expected: &#39;true&#39; != Actual: %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">IsValidBoard</span><span class="p">())</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// bench the solving of the hardest sudoku
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">BenchmarkSolveHard</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">hard</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">b</span><span class="p">.</span><span class="nf">StartTimer</span><span class="p">()</span>

	<span class="nx">s</span><span class="p">.</span><span class="nf">Solve</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// bench how long it takes to get a &#34;no solution&#34; answer
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">BenchmarkSolveFail</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">b</span><span class="p">.</span><span class="nf">StopTimer</span><span class="p">()</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">noSolution</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">b</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">b</span><span class="p">.</span><span class="nf">StartTimer</span><span class="p">()</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">N</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="c1">// s.Reset()
</span><span class="c1"></span>		<span class="nx">s</span><span class="p">.</span><span class="nf">Solve</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>main.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;github.com/paddie/godoku&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">solvable88</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`0 7 0 0 0 0 0 8 0
</span><span class="s">0 3 0 7 6 2 0 0 1
</span><span class="s">0 0 1 9 8 0 0 0 0
</span><span class="s">1 0 0 0 0 0 0 0 0
</span><span class="s">8 0 3 0 0 0 0 0 2
</span><span class="s">0 0 6 0 0 0 0 0 8
</span><span class="s">0 0 0 0 3 1 6 0 0
</span><span class="s">5 0 0 2 4 9 0 1 0
</span><span class="s">0 1 0 0 0 0 0 9 0`</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">godoku</span><span class="p">.</span><span class="nf">NewSudokuFromString</span><span class="p">(</span><span class="nx">solvable88</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="c1">// check that board is valid
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nf">IsValidBoard</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Invalid board&#34;</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>

	<span class="c1">// solve the board
</span><span class="c1"></span>	<span class="nx">s</span><span class="p">.</span><span class="nf">Solve</span><span class="p">()</span>
	
	<span class="c1">// print the solution
</span><span class="c1"></span>	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>

	<span class="c1">// checks the number of solutions; 1 in this case
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetSolutionsCount</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Expected 1 != Actual %v\n&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">GetSolutionsCount</span><span class="p">())</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;This sudoku has one solution!\n&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="优化">优化<a hidden class="anchor" aria-hidden="true" href="#优化">#</a></h1>
<p>Godoku 是一个 Go 编写的暴力破解数独的程序，逻辑比较简单，从上到下从左到右扫描每一个空格，从 1 到 9 开始填写数字，一旦数字无效（行冲突，列冲突或者 9 宫格冲突），那么就换一个数字，如果所有数字都换了还无效，那么就退回上一个格子，继续这个过程。</p>
<h2 id="step1">Step1<a hidden class="anchor" aria-hidden="true" href="#step1">#</a></h2>
<p>程序自带了测试和 Benchmark，所以我们先来生成一个 Profiling 文件，看看哪个地方开销最大。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">$ go tool pprof godoku.test cpu.prof
$ go tool pprof -http<span class="o">=</span><span class="s2">&#34;:8081&#34;</span> godoku.test cpu.prof
</code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200131233148.png" alt=""  />
</p>
<p>很明显，ValidInSquare这个函数开销很大，这个函数是检测一个数字在九宫格里面存不存在，作者的实现如下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">ValidInSquare</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">row</span><span class="p">,</span> <span class="nx">col</span> <span class="p">=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">row</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">col</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span>

	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">row</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">row</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="nx">col</span><span class="p">;</span> <span class="nx">j</span> <span class="p">&lt;</span> <span class="nx">col</span><span class="o">+</span><span class="mi">3</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span> <span class="p">{</span>
			<span class="c1">//fmt.Printf(&#34;row, col = %v, %v\n&#34;, i, j)
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span> <span class="o">==</span> <span class="nx">val</span> <span class="p">{</span>
				<span class="k">return</span> <span class="kc">false</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>循环判断有没有这个数，逻辑很简单，但是 Profiling 告诉我们，这里成了性能瓶颈，每一次测试数字都要调用这个方法，而这个方法内部是一个循环，调用如此频繁的方法采用循环肯定是不行的。</p>
<h2 id="step2">Step2<a hidden class="anchor" aria-hidden="true" href="#step2">#</a></h2>
<p>这里我们采用经典的 空间换时间 思路，使用另外一个结构存储九宫格内的状态信息，使得查询一个数字在九宫格内有没有可以通过简单的数组访问得到。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">s</span><span class="p">.</span><span class="nx">regionInfo</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dim</span> <span class="o">*</span> <span class="nx">s</span><span class="p">.</span><span class="nx">dim</span> <span class="o">/</span> <span class="mi">9</span><span class="p">)</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">updateRegion</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">delta</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">region</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">row</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="nx">col</span><span class="o">/</span><span class="mi">3</span>
	<span class="nx">key</span> <span class="o">:=</span> <span class="nx">region</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">regionInfo</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">delta</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">checkRegion</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">region</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">row</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="nx">col</span><span class="o">/</span><span class="mi">3</span>
	<span class="nx">key</span> <span class="o">:=</span> <span class="nx">region</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">regionInfo</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们使用一个额外的 regionInfo slice 来存储九宫格里的情况，每一次设置数独中格子的值时，我们更新一下 regionInfo 的信息。当要检查某个数在某个九宫格中是否已经存在时，直接查询 regionInfo 即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">ValidInSquare</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nf">checkRegion</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>再运行一次测试，看看性能改善了多少。</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200131233232.png" alt=""  />
</p>
<p>很好！CPU 开销已经由 9770ms 降低到了 5460ms，性能提高 79%。现在程序的性能瓶颈已经是 ValidInColumnAndRow 这个函数了。</p>
<h2 id="step3">Step3<a hidden class="anchor" aria-hidden="true" href="#step3">#</a></h2>
<p>作者 ValidInColumnAndRow 函数的实现仍然是直观简单的循环。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">ValidInColumnAndRow</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">val</span> <span class="o">||</span>
			<span class="nx">s</span><span class="p">.</span><span class="nx">board</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">col</span><span class="p">]</span> <span class="o">==</span> <span class="nx">val</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们使用同样的策略来优化 ValidInColumnAndRow 这个函数，使用额外的数据结构存储每一行和每一列的数字状态信息。这样查询时可以马上返回，而不需要做任何循环比较。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">updateRowAndCol</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">delta</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">rowKey</span> <span class="o">:=</span> <span class="nx">row</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="nx">colKey</span> <span class="o">:=</span> <span class="nx">col</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">rowInfo</span><span class="p">[</span><span class="nx">rowKey</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">delta</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">colInfo</span><span class="p">[</span><span class="nx">colKey</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">delta</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">checkRowOrCol</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">rowKey</span> <span class="o">:=</span> <span class="nx">row</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="nx">colKey</span> <span class="o">:=</span> <span class="nx">col</span><span class="o">*</span><span class="mi">9</span> <span class="o">+</span> <span class="nx">val</span> <span class="o">-</span> <span class="mi">1</span>
	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">rowInfo</span><span class="p">[</span><span class="nx">rowKey</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">s</span><span class="p">.</span><span class="nx">colInfo</span><span class="p">[</span><span class="nx">colKey</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Sudoku</span><span class="p">)</span> <span class="nf">ValidInColumnAndRow</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="k">return</span> <span class="p">!</span><span class="nx">s</span><span class="p">.</span><span class="nf">checkRowOrCol</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">col</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>我们再来看看 Profiling 数据。</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200131233247.png" alt=""  />
</p>
<p>性能再次得到了提升，由 5460ms 降低到了 3610ms。初步看来，已经没有了明显可以优化的地方了。到此为止，我们的程序性能已经得到了 170% 的提升！我们并没有怎么努力，只不过是生成了 Profiling 文件，一眼看出问题在哪儿，然后针对性地优化而已。</p>
<p>感谢 Golang 提供了这套超赞的 pprof 工具，性能调优变得如此轻松和愉悦。这里我所举的只是 pprof 功能的冰山一角，pprof 的强大功能远不止这些。比如可以使用 list 指令查看函数的源码中每一行代码的开销以及使用 weblist 指令查看函数汇编以后每一句汇编指令的开销等等。不仅是 CPU Profiling，pprof 同样支持 Memory Profiling，可以帮助你检查程序中内存的分配情况。总之，在 pprof 的帮助下，程序的开销信息变得一清二楚，优化自然变得轻而易举。</p>
<p>转载:<a href="https://cjting.me/2016/11/14/use-pprof-to-optimize-go/">https://cjting.me/2016/11/14/use-pprof-to-optimize-go/</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
