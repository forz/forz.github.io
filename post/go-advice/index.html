<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go Advice | Forz Blog</title>
<meta name="keywords" content="Go" />
<meta name="description" content="Go-advice 中文版本 Go 箴言 Go 之禅 代码 并发 性能 模块 构建 测试 工具 Misc Go-advice 中文版本 Go 箴言 不要通过共享内存进行通信，通过通信共享内存 并发不是并行 通道编排；互斥体序">
<meta name="author" content="">
<link rel="canonical" href="/post/go-advice/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Go Advice" />
<meta property="og:description" content="Go-advice 中文版本 Go 箴言 Go 之禅 代码 并发 性能 模块 构建 测试 工具 Misc Go-advice 中文版本 Go 箴言 不要通过共享内存进行通信，通过通信共享内存 并发不是并行 通道编排；互斥体序" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/go-advice/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-07-28T19:17:28&#43;00:00" />
<meta property="article:modified_time" content="2021-03-21T10:35:36&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go Advice"/>
<meta name="twitter:description" content="Go-advice 中文版本 Go 箴言 Go 之禅 代码 并发 性能 模块 构建 测试 工具 Misc Go-advice 中文版本 Go 箴言 不要通过共享内存进行通信，通过通信共享内存 并发不是并行 通道编排；互斥体序"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Go Advice",
      "item": "/post/go-advice/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go Advice",
  "name": "Go Advice",
  "description": "Go-advice 中文版本 Go 箴言 Go 之禅 代码 并发 性能 模块 构建 测试 工具 Misc Go-advice 中文版本 Go 箴言 不要通过共享内存进行通信，通过通信共享内存 并发不是并行 通道编排；互斥体序",
  "keywords": [
    "Go"
  ],
  "articleBody": " Go-advice 中文版本  Go 箴言 Go 之禅 代码 并发 性能 模块 构建 测试 工具 Misc    Go-advice 中文版本 Go 箴言  不要通过共享内存进行通信，通过通信共享内存 并发不是并行 通道编排；互斥体序列化 接口越大，抽象就越弱 使零值有用 interface{} 什么也没说 Gofmt 的风格不是人们最喜欢的，但 gofmt 是每个人的最爱 一点点复制比一点点依赖更好 系统调用必须始终使用构建标记进行保护 必须始终使用构建标记保护 Cgo Cgo 不是 Go 对于不安全的 package，没有任何保证 清楚比聪明更好 反射永远不清晰 错误就是价值观 不要只检查错误，还要优雅地处理它们 设计架构，命名组件，记录细节 文档是供用户使用的 不要恐慌  Author: Rob Pike See more: https://go-proverbs.github.io/\nGo 之禅  每个 package 实现单一的目的 显式处理错误 尽早返回，而不是使用深嵌套 让调用者选择并发 在启动一个 goroutine 时，需要知道何时它会停止 避免 package 级别的状态 简单很重要 编写测试以锁定 package API 的行为 如果你觉得慢，先编写 benchmark 来证明 节制是一种美德 可维护性  Author: Dave Cheney See more: https://the-zen-of-go.netlify.com/\n代码 Always go fmt your code  使用 go fmt / gofmt 格式化你的代码, 让大家都开心 多个 if 语句可以折叠成 switch 用 chan struct{} 来传递信号, chan bool 表达的不够清楚 30 * time.Second 比 time.Duration(30) * time.Second 更好 用 var foo time.Duration 代替 var fooMillis int64 会更好 总是把 for-select 换成一个函数 分组定义 const 类型声明和 var 逻辑类型声明  使用 go fmt 格式化 社区使用官方的 Go 格式，不要重新发明轮子。 尝试减少代码复杂度。 这将帮助所有人使代码易于阅读。\n多个 if 语句可以折叠成 switch 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  // NOT BAD if foo() { // ... } else if bar == baz { // ... } else { // ... } // BETTER switch { case foo(): // ... case bar == baz: // ... default: // ... }   用 chan struct{} 来传递信号, chan bool 表达的不够清楚 当你在结构中看到 chan bool 的定义时，有时不容易理解如何使用该值，例如：\n1 2 3  type Service struct { deleteCh chan bool // what does this bool mean? }   但是我们可以将其改为明确的 chan struct {} 来使其更清楚：我们不在乎值（它始终是 struct {}），我们关心可能发生的事件，例如：\n1 2 3  type Service struct { deleteCh chan struct{} // ok, if event than delete something. }   30 * time.Second 比 time.Duration(30) * time.Second 更好 你不需要将无类型的 const 包装在类型中，编译器会找出来。最好将 const 移到第一位：\n1 2 3 4 5 6 7 8  // BAD delay := time.Second * 60 * 24 * 60 // VERY BAD delay := 60 * time.Second * 60 * 24 // GOOD delay := 24 * 60 * 60 * time.Second   用 time.Duration 代替 int64 + 变量名 1 2 3 4 5  // BAD var delayMillis int64 = 15000 // GOOD var delay time.Duration = 15 * time.Second   按类型分组 const 声明，按逻辑和/或类型分组 var 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  // BAD const ( foo = 1 bar = 2 message = \"warn message\" ) // MOSTLY BAD const foo = 1 const bar = 2 const message = \"warn message\" // GOOD const ( foo = 1 bar = 2 ) const message = \"warn message\"   这个模式也适用于 var。\n 每个阻塞或者 IO 函数操作应该是可取消的或者至少是可超时的 为整型常量值实现 Stringer 接口  https://godoc.org/golang.org/x/tools/cmd/stringer   用 defer 来检查你的错误  1 2 3 4 5 6  defer func() { err := ocp.Close() if err != nil { rerr = err } }()    任何 panic 都不要使用 checkErr 函数或者用 os.Exit 仅仅在很特殊情况下才使用 panic, 你必须要去处理 error 不要给枚举使用别名，因为这打破了类型安全  https://play.golang.org/p/MGbeDwtXN3    1 2 3 4 5 6 7 8 9 10  package main type Status = int type Format = int // remove `=` to have type safety  const A Status = 1 const B Format = 1 func main() { println(A == B) }     如果你想省略返回参数，你最好表示出来\n _ = f() 比 f() 更好    我们用 a := []T{} 来简单初始化 slice\n  用 range 循环来进行数组或 slice 的迭代\n for _, c := range a[3:7] {...} 比 for i := 3; i 更好    多行字符串用反引号(`)\n  用 _ 来跳过不用的参数\n  1  func f(a int, _ string) {}    如果你要比较时间戳，请使用 time.Before 或 time.After ，不要使用 time.Sub 来获得 duration (持续时间)，然后检查它的值。 总是将上下文作为第一个参数传递给具有 ctx 名称的 func 几个相同类型的参数定义可以用简短的方式来进行  1  func f(a int, b int, s string, p string)   1  func f(a, b int, s, p string)    一个 slice 的零值是 nil  https://play.golang.org/p/pNT0d_Bunq    1 2 3 4 5 6 7 8  var s []int fmt.Println(s, len(s), cap(s)) if s == nil { fmt.Println(\"nil!\") } // Output:  // [] 0 0  // nil!    https://play.golang.org/p/meTInNyxtk  1 2 3 4 5 6 7 8  var a []string b := []string{} fmt.Println(reflect.DeepEqual(a, []string{})) fmt.Println(reflect.DeepEqual(b, []string{})) // Output:  // false  // true    不要将枚举类型与 , ,  和 = 进行比较  使用确定的值，不要像下面这样做:    1 2 3 4 5  value := reflect.ValueOf(object) kind := value.Kind() if kind = reflect.Chan \u0026\u0026 kind  reflect.Slice { // ...  }    用 %+v 来打印数据的比较全的信息 注意空结构 struct{}, 看 issue: https://github.com/golang/go/issues/23440  more: https://play.golang.org/p/9C0puRUstrP    1 2 3 4 5 6 7 8 9 10 11  func f1() { var a, b struct{} print(\u0026a, \"\\n\", \u0026b, \"\\n\") // Prints same address  fmt.Println(\u0026a == \u0026b) // Comparison returns false  } func f2() { var a, b struct{} fmt.Printf(\"%p\\n%p\\n\", \u0026a, \u0026b) // Again, same address  fmt.Println(\u0026a == \u0026b) // ...but the comparison returns true  }     包装错误： http://github.com/pkg/errors\n 例如: errors.Wrap(err, \"additional message to a given error\")    在 Go 里面要小心使用 range:\n for i := range a and for i, v := range \u0026a ，都不是 a 的副本 但是 for i, v := range a 里面的就是 a 的副本 更多: https://play.golang.org/p/4b181zkB1O    从 map 读取一个不存在的 key 将不会 panic\n value := map[\"no_key\"] 将得到一个 0 值 value, ok := map[\"no_key\"] 更好    不要使用原始参数进行文件操作\n 而不是一个八进制参数 os.MkdirAll(root, 0700) 使用此类型的预定义常量 os.FileMode    不要忘记为 iota 指定一种类型\n https://play.golang.org/p/mZZdMaI92cI    1 2 3 4  const ( _ = iota testvar // testvar 将是 int 类型  )   vs\n1 2 3 4 5  type myType int const ( _ myType = iota testvar // testvar 将是 myType 类型  )   不要在你不拥有的结构上使用 encoding/gob 在某些时候，结构可能会改变，而你可能会错过这一点。因此，这可能会导致很难找到 bug。\n不要依赖于计算顺序，特别是在 return 语句中 1 2 3 4 5 6  // BAD  return res, json.Unmarshal(b, \u0026res) // GOOD  err := json.Unmarshal(b, \u0026res) return res, err   为了防止 unkeyed 文字，添加 _ struct {} 字段 1 2 3 4  type Point struct { X, Y float64 _ struct{} // to prevent unkeyed literals }   对于 Point {X：1，Y：1} 都可以，但是对于 Point {1,1} 则会出现编译错误：\n1  ./file.go:1:11: too few values in Point literal   使用 go vet 命令进行检查，提示没有足够的参数在所有结构中添加 _ struct {}。\n为了防止结构比较，添加 func 类型的空字段 1 2 3 4  type Point struct { _ [0]func() // unexported, zero-width non-comparable field  X, Y float64 }   http.HandlerFunc 比 http.Handler 更好 用 http.HandlerFunc 你仅需要一个 func，http.Handler 需要一个类型。\n移动 defer 到顶部 代码可读性更好和在函数结束时有什么被调用也更清楚了。\nJavaScript 解析整数为浮点数并且你的 int64 可能溢出 用 json:\"id,string\" 代替\n1 2 3  type Request struct { ID int64 `json:\"id,string\"` }   并发  以线程安全的方式创建一些东西的最好选择是 sync.Once  不要用 flags, mutexes, channels or atomics   永远不要使用 select{}, 省略通道， 等待信号 不要在 channel 里关闭，这是它的创作者的责任。  往一个关闭的 channel 会引起 panic   math/rand 中的 func NewSource(seed int64) Source 不是并发安全的，默认的 lockedSource 是并发安全的, see issue: https://github.com/golang/go/issues/3611  更多: https://golang.org/pkg/math/rand/   当你需要一个自定义类型的 atomic 值时，可以使用 atomic.Value  性能  不要省略 defer  在大多数情况下 200ns 加速可以忽略不计   总是关闭 http body defer r.Body.Close()  除非你需要泄露 goroutine   过滤但不分配新内存  1 2 3 4 5 6  b := a[:0] for _, x := range a { if f(x) { b = append(b, x) } }   为了帮助编译器删除绑定检查，请参见此模式 _ = b [7]  time.Time 有指针字段 time.Location 并且这对 go GC 不好  只在大量的time.Time才有意义，用 timestamp 代替   regexp.MustCompile 比 regexp.Compile 更好  在大多数情况下，你的正则表达式是不可变的，所以你最好在 func init 中初始化它   请勿在你的热路径中过度使用 fmt.Sprintf. 由于维护接口的缓冲池和动态调度，它是很昂贵的。  如果你正在使用 fmt.Sprintf(\"%s%s\", var1, var2), 考虑使用简单的字符串连接。 如果你正在使用 fmt.Sprintf(\"%x\", var), 考虑使用 hex.EncodeToString or strconv.FormatInt(var, 16)   如果你不需要用它，可以考虑丢弃它，例如io.Copy(ioutil.Discard, resp.Body)  HTTP 客户端的传输不会重用连接，直到body被读完和关闭。    1 2 3  res, _ := client.Do(req) io.Copy(ioutil.Discard, res.Body) defer res.Body.Close()    不要在循环中使用 defer，否则会导致内存泄露  ‘cause defers will grow your stack without the reason   不要忘记停止 ticker, 除非你需要泄露 channel  1 2  ticker := time.NewTicker(1 * time.Second) defer ticker.Stop()    用自定义的 marshaler 去加速 marshaler 过程  但是在使用它之前要进行定制！例如：https://play.golang.org/p/SEm9Hvsi0r    1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  func (entry Entry) MarshalJSON() ([]byte, error) { buffer := bytes.NewBufferString(\"{\") first := true for key, value := range entry { jsonValue, err := json.Marshal(value) if err != nil { return nil, err } if !first { buffer.WriteString(\",\") } first = false buffer.WriteString(key + \":\" + string(jsonValue)) } buffer.WriteString(\"}\") return buffer.Bytes(), nil }     sync.Map 不是万能的，没有很强的理由就不要使用它。\n 了解更多: https://github.com/golang/go/blob/master/src/sync/map.go#L12    在 sync.Pool 中分配内存存储非指针数据\n 了解更多: https://github.com/dominikh/go-tools/blob/master/cmd/staticcheck/docs/checks/SA6002    为了隐藏逃生分析的指针，你可以小心使用这个函数：:\n 来源: https://go-review.googlesource.com/c/go/+/86976    1 2 3 4 5 6 7 8 9  // noescape hides a pointer from escape analysis. noescape is  // the identity function but escape analysis doesn't think the  // output depends on the input. noescape is inlined and currently  // compiles down to zero instructions.  //go:nosplit  func noescape(p unsafe.Pointer) unsafe.Pointer { x := uintptr(p) return unsafe.Pointer(x ^ 0) }     对于最快的原子交换，你可以使用这个 m := (*map[int]int)(atomic.LoadPointer(\u0026ptr))\n  如果执行许多顺序读取或写入操作，请使用缓冲 I/O\n 减少系统调用次数    有 2 种方法清空一个 map：\n 重用 map 内存 （但是也要注意 m 的回收）    1 2 3  for k := range m { delete(m, k) }    分配新的  1  m = make(map[int]int)   模块  如果你想在 CI 中测试 go.mod （和 go.sum）是否是最新 https://blog.urth.org/2019/08/13/testing-go-mod-tidiness-in-ci/  构建  用这个命令 go build -ldflags=\"-s -w\" ... 去掉你的二进制文件 拆分构建不同版本的简单方法  用 // +build integration 并且运行他们 go test -v --tags integration .   最小的 Go Docker 镜像  https://twitter.com/bbrodriges/status/873414658178396160 CGO_ENABLED=0 go build -ldflags=\"-s -w\" app.go \u0026\u0026 tar C app | docker import - myimage:latest   run go format on CI and compare diff  这将确保一切都是生成的和承诺的   用最新的 Go 运行 Travis-CI，用 travis 1  了解更多：https://github.com/travis-ci/travis-build/blob/master/public/version-aliases/go.json   检查代码格式是否有错误 diff -u   测试  测试名称 package_test 比 package 要好 go test -short 允许减少要运行的测试数  1 2 3 4 5  func TestSomething(t *testing.T) { if testing.Short() { t.Skip(\"skipping test in short mode.\") } }    根据系统架构跳过测试  1 2 3  if runtime.GOARM == \"arm\" { t.Skip(\"this doesn't work under ARM\") }    用 testing.AllocsPerRun 跟踪你的内存分配  https://godoc.org/testing#AllocsPerRun   多次运行你的基准测试可以避免噪音。  go test -test.bench=. -count=20    工具   快速替换 gofmt -w -l -r \"panic(err) - log.Error(err)\" .\n  go list 允许找到所有直接和传递的依赖关系\n go list -f '{{ .Imports }}' package go list -f '{{ .Deps }}' package    对于快速基准比较，我们有一个 benchstat 工具。\n https://godoc.org/golang.org/x/perf/cmd/benchstat    go-critic linter 从这个文件中强制执行几条建议\n  go mod why -m  告诉我们为什么特定的模块在 go.mod 文件中。\n  GOGC=off go build ... 应该会加快构建速度 source\n  内存分析器每 512KB 记录一次分配。你能通过 GODEBUG 环境变量增加比例，来查看你的文件的更多详细信息。\n 来源：https://twitter.com/bboreham/status/1105036740253937664    go mod why -m  告诉我们为什么特定的模块是在 go.mod 文件中。\n  Misc  dump goroutines https://stackoverflow.com/a/27398062/433041  1 2 3 4 5 6 7 8 9 10  go func() { sigs := make(chan os.Signal, 1) signal.Notify(sigs, syscall.SIGQUIT) buf := make([]byte, 120) for { sigs stacklen := runtime.Stack(buf, true) log.Printf(\"=== received SIGQUIT ===\\n*** goroutine dump...\\n%s\\n*** end\\n\" , buf[:stacklen]) } }()     在编译期检查接口的实现\n1  var _ io.Reader = (*MyFastReader)(nil)     len(nil) = 0\n https://golang.org/pkg/builtin/#len    匿名结构很酷\n  1 2 3 4 5 6 7  var hits struct { sync.Mutex n int } hits.Lock() hits.n++ hits.Unlock()     httputil.DumpRequest 是非常有用的东西，不要自己创建\n https://godoc.org/net/http/httputil#DumpRequest    获得调用堆栈，我们可以使用 runtime.Caller\n https://golang.org/pkg/runtime/#Caller    要 marshal 任意的 JSON， 你可以 marshal 为 map[string]interface{}{}\n  配置你的 CDPATH 以便你能在任何目录执行 cd github.com/golang/go\n 添加这一行代码到 bashrc(或者其他类似的) export CDPATH=$CDPATH:$GOPATH/src    从一个 slice 生成简单的随机元素\n []string{\"one\", \"two\", \"three\"}[rand.Intn(3)]    ",
  "wordCount" : "3735",
  "inLanguage": "zh-cn",
  "datePublished": "2020-07-28T19:17:28Z",
  "dateModified": "2021-03-21T10:35:36+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/go-advice/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Go Advice
    </h1>
    <div class="post-meta">July 28, 2020
</div>
  </header> 
  <div class="post-content"><ul>
<li><a href="#go-advice-%E4%B8%AD%E6%96%87%E7%89%88%E6%9C%AC">Go-advice 中文版本</a>
<ul>
<li><a href="#go-%E7%AE%B4%E8%A8%80">Go 箴言</a></li>
<li><a href="#go-%E4%B9%8B%E7%A6%85">Go 之禅</a></li>
<li><a href="#%E4%BB%A3%E7%A0%81">代码</a></li>
<li><a href="#%E5%B9%B6%E5%8F%91">并发</a></li>
<li><a href="#%E6%80%A7%E8%83%BD">性能</a></li>
<li><a href="#%E6%A8%A1%E5%9D%97">模块</a></li>
<li><a href="#%E6%9E%84%E5%BB%BA">构建</a></li>
<li><a href="#%E6%B5%8B%E8%AF%95">测试</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7">工具</a></li>
<li><a href="#misc">Misc</a></li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="go-advice-中文版本">Go-advice 中文版本<a hidden class="anchor" aria-hidden="true" href="#go-advice-中文版本">#</a></h1>
<h3 id="go-箴言">Go 箴言<a hidden class="anchor" aria-hidden="true" href="#go-箴言">#</a></h3>
<ul>
<li>不要通过共享内存进行通信，通过通信共享内存</li>
<li>并发不是并行</li>
<li>通道编排；互斥体序列化</li>
<li>接口越大，抽象就越弱</li>
<li>使零值有用</li>
<li><code>interface{}</code> 什么也没说</li>
<li>Gofmt 的风格不是人们最喜欢的，但 gofmt 是每个人的最爱</li>
<li>一点点复制比一点点依赖更好</li>
<li>系统调用必须始终使用构建标记进行保护</li>
<li>必须始终使用构建标记保护 Cgo</li>
<li>Cgo 不是 Go</li>
<li>对于不安全的 package，没有任何保证</li>
<li>清楚比聪明更好</li>
<li>反射永远不清晰</li>
<li>错误就是价值观</li>
<li>不要只检查错误，还要优雅地处理它们</li>
<li>设计架构，命名组件，记录细节</li>
<li>文档是供用户使用的</li>
<li>不要恐慌</li>
</ul>
<p>Author: Rob Pike
See more: <a href="https://go-proverbs.github.io/">https://go-proverbs.github.io/</a></p>
<h3 id="go-之禅">Go 之禅<a hidden class="anchor" aria-hidden="true" href="#go-之禅">#</a></h3>
<ul>
<li>每个 package 实现单一的目的</li>
<li>显式处理错误</li>
<li>尽早返回，而不是使用深嵌套</li>
<li>让调用者选择并发</li>
<li>在启动一个 goroutine 时，需要知道何时它会停止</li>
<li>避免 package 级别的状态</li>
<li>简单很重要</li>
<li>编写测试以锁定 package API 的行为</li>
<li>如果你觉得慢，先编写 benchmark 来证明</li>
<li>节制是一种美德</li>
<li>可维护性</li>
</ul>
<p>Author: Dave Cheney
See more: <a href="https://the-zen-of-go.netlify.com/">https://the-zen-of-go.netlify.com/</a></p>
<h3 id="代码">代码<a hidden class="anchor" aria-hidden="true" href="#代码">#</a></h3>
<h4 id="always-go-fmt-your-code">Always <code>go fmt</code> your code<a hidden class="anchor" aria-hidden="true" href="#always-go-fmt-your-code">#</a></h4>
<ul>
<li><input disabled="" type="checkbox"> 使用 <code>go fmt</code> / <code>gofmt</code> 格式化你的代码, 让大家都开心</li>
<li><input disabled="" type="checkbox"> 多个 if 语句可以折叠成 switch</li>
<li><input disabled="" type="checkbox"> 用 <code>chan struct{}</code> 来传递信号, <code>chan bool</code> 表达的不够清楚</li>
<li><input disabled="" type="checkbox"> <code>30 * time.Second</code> 比 <code>time.Duration(30) * time.Second</code> 更好</li>
<li><input disabled="" type="checkbox"> 用 <code>var foo time.Duration</code> 代替 <code>var fooMillis int64</code> 会更好</li>
<li><input disabled="" type="checkbox"> 总是把 for-select 换成一个函数</li>
<li><input disabled="" type="checkbox"> 分组定义 <code>const</code> 类型声明和 <code>var</code> 逻辑类型声明</li>
</ul>
<h4 id="使用-go-fmt-格式化">使用 <code>go fmt</code> 格式化<a hidden class="anchor" aria-hidden="true" href="#使用-go-fmt-格式化">#</a></h4>
<p>社区使用官方的 Go 格式，不要重新发明轮子。
尝试减少代码复杂度。 这将帮助所有人使代码易于阅读。</p>
<h4 id="多个-if-语句可以折叠成-switch">多个 if 语句可以折叠成 switch<a hidden class="anchor" aria-hidden="true" href="#多个-if-语句可以折叠成-switch">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// NOT BAD
</span><span class="c1"></span><span class="k">if</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">bar</span> <span class="o">==</span> <span class="nx">baz</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="c1">// BETTER
</span><span class="c1"></span><span class="k">switch</span> <span class="p">{</span>
<span class="k">case</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="k">case</span> <span class="nx">bar</span> <span class="o">==</span> <span class="nx">baz</span><span class="p">:</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="k">default</span><span class="p">:</span>
    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="用-chan-struct-来传递信号-chan-bool-表达的不够清楚">用 <code>chan struct{}</code> 来传递信号, <code>chan bool</code> 表达的不够清楚<a hidden class="anchor" aria-hidden="true" href="#用-chan-struct-来传递信号-chan-bool-表达的不够清楚">#</a></h4>
<p>当你在结构中看到 <code>chan bool</code> 的定义时，有时不容易理解如何使用该值，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Service</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">deleteCh</span> <span class="kd">chan</span> <span class="kt">bool</span> <span class="c1">// what does this bool mean?
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>但是我们可以将其改为明确的 <code>chan struct {}</code> 来使其更清楚：我们不在乎值（它始终是 <code>struct {}</code>），我们关心可能发生的事件，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Service</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">deleteCh</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span> <span class="c1">// ok, if event than delete something.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="30--timesecond-比-timeduration30--timesecond-更好"><code>30 * time.Second</code> 比 <code>time.Duration(30) * time.Second</code> 更好<a hidden class="anchor" aria-hidden="true" href="#30--timesecond-比-timeduration30--timesecond-更好">#</a></h4>
<p>你不需要将无类型的 const 包装在类型中，编译器会找出来。最好将 const 移到第一位：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// BAD
</span><span class="c1"></span><span class="nx">delay</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span>

<span class="c1">// VERY BAD
</span><span class="c1"></span><span class="nx">delay</span> <span class="o">:=</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span>

<span class="c1">// GOOD
</span><span class="c1"></span><span class="nx">delay</span> <span class="o">:=</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="用-timeduration-代替-int64--变量名">用 <code>time.Duration</code> 代替 <code>int64</code> + 变量名<a hidden class="anchor" aria-hidden="true" href="#用-timeduration-代替-int64--变量名">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// BAD
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">delayMillis</span> <span class="kt">int64</span> <span class="p">=</span> <span class="mi">15000</span>

<span class="c1">// GOOD
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">delay</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="p">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="按类型分组-const-声明按逻辑和或类型分组-var">按类型分组 <code>const</code> 声明，按逻辑和/或类型分组 <code>var</code><a hidden class="anchor" aria-hidden="true" href="#按类型分组-const-声明按逻辑和或类型分组-var">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// BAD
</span><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
    <span class="nx">foo</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="nx">bar</span> <span class="p">=</span> <span class="mi">2</span>
    <span class="nx">message</span> <span class="p">=</span> <span class="s">&#34;warn message&#34;</span>
<span class="p">)</span>

<span class="c1">// MOSTLY BAD
</span><span class="c1"></span><span class="kd">const</span> <span class="nx">foo</span> <span class="p">=</span> <span class="mi">1</span>
<span class="kd">const</span> <span class="nx">bar</span> <span class="p">=</span> <span class="mi">2</span>
<span class="kd">const</span> <span class="nx">message</span> <span class="p">=</span> <span class="s">&#34;warn message&#34;</span>

<span class="c1">// GOOD
</span><span class="c1"></span><span class="kd">const</span> <span class="p">(</span>
    <span class="nx">foo</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="nx">bar</span> <span class="p">=</span> <span class="mi">2</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">message</span> <span class="p">=</span> <span class="s">&#34;warn message&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>这个模式也适用于 <code>var</code>。</p>
<ul>
<li><input disabled="" type="checkbox"> 每个阻塞或者 IO 函数操作应该是可取消的或者至少是可超时的</li>
<li><input disabled="" type="checkbox"> 为整型常量值实现 <code>Stringer</code> 接口
<ul>
<li><a href="https://godoc.org/golang.org/x/tools/cmd/stringer">https://godoc.org/golang.org/x/tools/cmd/stringer</a></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 用 defer 来检查你的错误</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ocp</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
          <span class="nx">rerr</span> <span class="p">=</span> <span class="nx">err</span>
      <span class="p">}</span>
  <span class="p">}()</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 任何 panic 都不要使用 <code>checkErr</code> 函数或者用 <code>os.Exit</code></li>
<li><input disabled="" type="checkbox"> 仅仅在很特殊情况下才使用 panic, 你必须要去处理 error</li>
<li><input disabled="" type="checkbox"> 不要给枚举使用别名，因为这打破了类型安全
<ul>
<li><a href="https://play.golang.org/p/MGbeDwtXN3">https://play.golang.org/p/MGbeDwtXN3</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kn">package</span> <span class="nx">main</span>
  <span class="kd">type</span> <span class="nx">Status</span> <span class="p">=</span> <span class="kt">int</span>
  <span class="kd">type</span> <span class="nx">Format</span> <span class="p">=</span> <span class="kt">int</span> <span class="c1">// remove `=` to have type safety
</span><span class="c1"></span>
  <span class="kd">const</span> <span class="nx">A</span> <span class="nx">Status</span> <span class="p">=</span> <span class="mi">1</span>
  <span class="kd">const</span> <span class="nx">B</span> <span class="nx">Format</span> <span class="p">=</span> <span class="mi">1</span>

  <span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
      <span class="nb">println</span><span class="p">(</span><span class="nx">A</span> <span class="o">==</span> <span class="nx">B</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><input disabled="" type="checkbox"> 如果你想省略返回参数，你最好表示出来</p>
<ul>
<li><code>_ = f()</code> 比 <code>f()</code> 更好</li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 我们用 <code>a := []T{}</code> 来简单初始化 slice</p>
</li>
<li>
<p><input disabled="" type="checkbox"> 用 range 循环来进行数组或 slice 的迭代</p>
<ul>
<li><code>for _, c := range a[3:7] {...}</code> 比 <code>for i := 3; i &lt; 7; i++ {...}</code> 更好</li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 多行字符串用反引号(`)</p>
</li>
<li>
<p><input disabled="" type="checkbox"> 用 <code>_</code> 来跳过不用的参数</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">_</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 如果你要比较时间戳，请使用 <code>time.Before</code> 或 <code>time.After</code> ，不要使用 <code>time.Sub</code> 来获得 duration (持续时间)，然后检查它的值。</li>
<li><input disabled="" type="checkbox"> 总是将上下文作为第一个参数传递给具有 <code>ctx</code> 名称的 func</li>
<li><input disabled="" type="checkbox"> 几个相同类型的参数定义可以用简短的方式来进行</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">a</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">s</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">p</span> <span class="kt">string</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">func</span> <span class="nf">f</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">p</span> <span class="kt">string</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 一个 slice 的零值是 nil
<ul>
<li><a href="https://play.golang.org/p/pNT0d_Bunq">https://play.golang.org/p/pNT0d_Bunq</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">var</span> <span class="nx">s</span> <span class="p">[]</span><span class="kt">int</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
  <span class="k">if</span> <span class="nx">s</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;nil!&#34;</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="c1">// Output:
</span><span class="c1"></span>  <span class="c1">// [] 0 0
</span><span class="c1"></span>  <span class="c1">// nil!
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li><a href="https://play.golang.org/p/meTInNyxtk">https://play.golang.org/p/meTInNyxtk</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">var</span> <span class="nx">a</span> <span class="p">[]</span><span class="kt">string</span>
  <span class="nx">b</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}</span>

  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">DeepEqual</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}))</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">DeepEqual</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{}))</span>
  <span class="c1">// Output:
</span><span class="c1"></span>  <span class="c1">// false
</span><span class="c1"></span>  <span class="c1">// true
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 不要将枚举类型与 <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code> 和 <code>&gt;=</code> 进行比较
<ul>
<li>使用确定的值，不要像下面这样做:</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="nx">value</span> <span class="o">:=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span>
  <span class="nx">kind</span> <span class="o">:=</span> <span class="nx">value</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">kind</span> <span class="o">&gt;=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Chan</span> <span class="o">&amp;&amp;</span> <span class="nx">kind</span> <span class="o">&lt;=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Slice</span> <span class="p">{</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 用 <code>%+v</code> 来打印数据的比较全的信息</li>
<li><input disabled="" type="checkbox"> 注意空结构 <code>struct{}</code>, 看 issue: <a href="https://github.com/golang/go/issues/23440">https://github.com/golang/go/issues/23440</a>
<ul>
<li>more: <a href="https://play.golang.org/p/9C0puRUstrP">https://play.golang.org/p/9C0puRUstrP</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">func</span> <span class="nf">f1</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">struct</span><span class="p">{}</span>
    <span class="nb">print</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">b</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span> <span class="c1">// Prints same address
</span><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span>     <span class="c1">// Comparison returns false
</span><span class="c1"></span>  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">f2</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kd">struct</span><span class="p">{}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%p\n%p\n&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">a</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span> <span class="c1">// Again, same address
</span><span class="c1"></span>    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">a</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">b</span><span class="p">)</span>          <span class="c1">// ...but the comparison returns true
</span><span class="c1"></span>  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><input disabled="" type="checkbox"> 包装错误： <a href="http://github.com/pkg/errors">http://github.com/pkg/errors</a></p>
<ul>
<li>例如: <code>errors.Wrap(err, &quot;additional message to a given error&quot;)</code></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 在 Go 里面要小心使用 <code>range</code>:</p>
<ul>
<li><code>for i := range a</code> and <code>for i, v := range &amp;a</code> ，都不是 <code>a</code> 的副本</li>
<li>但是 <code>for i, v := range a</code> 里面的就是 <code>a</code> 的副本</li>
<li>更多: <a href="https://play.golang.org/p/4b181zkB1O">https://play.golang.org/p/4b181zkB1O</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 从 map 读取一个不存在的 key 将不会 panic</p>
<ul>
<li><code>value := map[&quot;no_key&quot;]</code> 将得到一个 0 值</li>
<li><code>value, ok := map[&quot;no_key&quot;]</code> 更好</li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 不要使用原始参数进行文件操作</p>
<ul>
<li>而不是一个八进制参数 <code>os.MkdirAll(root, 0700)</code></li>
<li>使用此类型的预定义常量 <code>os.FileMode</code></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 不要忘记为 <code>iota</code> 指定一种类型</p>
<ul>
<li><a href="https://play.golang.org/p/mZZdMaI92cI">https://play.golang.org/p/mZZdMaI92cI</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="kd">const</span> <span class="p">(</span>
      <span class="nx">_</span> <span class="p">=</span> <span class="kc">iota</span>
      <span class="nx">testvar</span>         <span class="c1">// testvar 将是 int 类型
</span><span class="c1"></span>    <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>vs</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">    <span class="kd">type</span> <span class="nx">myType</span> <span class="kt">int</span>
    <span class="kd">const</span> <span class="p">(</span>
      <span class="nx">_</span> <span class="nx">myType</span> <span class="p">=</span> <span class="kc">iota</span>
      <span class="nx">testvar</span>         <span class="c1">// testvar 将是 myType 类型
</span><span class="c1"></span>    <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="不要在你不拥有的结构上使用-encodinggob">不要在你不拥有的结构上使用 <code>encoding/gob</code><a hidden class="anchor" aria-hidden="true" href="#不要在你不拥有的结构上使用-encodinggob">#</a></h4>
<p>在某些时候，结构可能会改变，而你可能会错过这一点。因此，这可能会导致很难找到 bug。</p>
<h4 id="不要依赖于计算顺序特别是在-return-语句中">不要依赖于计算顺序，特别是在 return 语句中<a hidden class="anchor" aria-hidden="true" href="#不要依赖于计算顺序特别是在-return-语句中">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// BAD
</span><span class="c1"></span>  <span class="k">return</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">res</span><span class="p">)</span>

  <span class="c1">// GOOD
</span><span class="c1"></span>  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">res</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">err</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="为了防止-unkeyed-文字添加-_-struct--字段">为了防止 unkeyed 文字，添加 <code>_ struct {}</code> 字段<a hidden class="anchor" aria-hidden="true" href="#为了防止-unkeyed-文字添加-_-struct--字段">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Point</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">X</span><span class="p">,</span> <span class="nx">Y</span> <span class="kt">float64</span>
  <span class="nx">_</span>    <span class="kd">struct</span><span class="p">{}</span> <span class="c1">// to prevent unkeyed literals
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>对于 <code>Point {X：1，Y：1}</code> 都可以，但是对于 <code>Point {1,1}</code> 则会出现编译错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">./file.go:1:11: too few values in Point literal
</code></pre></td></tr></table>
</div>
</div><p>使用 <code>go vet</code> 命令进行检查，提示没有足够的参数在所有结构中添加 <code>_ struct {}</code>。</p>
<h4 id="为了防止结构比较添加-func-类型的空字段">为了防止结构比较，添加 <code>func</code> 类型的空字段<a hidden class="anchor" aria-hidden="true" href="#为了防止结构比较添加-func-类型的空字段">#</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">type</span> <span class="nx">Point</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">_</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="kd">func</span><span class="p">()</span> <span class="c1">// unexported, zero-width non-comparable field
</span><span class="c1"></span>    <span class="nx">X</span><span class="p">,</span> <span class="nx">Y</span> <span class="kt">float64</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="httphandlerfunc-比-httphandler-更好"><code>http.HandlerFunc</code> 比 <code>http.Handler</code> 更好<a hidden class="anchor" aria-hidden="true" href="#httphandlerfunc-比-httphandler-更好">#</a></h4>
<p>用 <code>http.HandlerFunc</code> 你仅需要一个 func，<code>http.Handler</code> 需要一个类型。</p>
<h4 id="移动-defer-到顶部">移动 <code>defer</code> 到顶部<a hidden class="anchor" aria-hidden="true" href="#移动-defer-到顶部">#</a></h4>
<p>代码可读性更好和在函数结束时有什么被调用也更清楚了。</p>
<h4 id="javascript-解析整数为浮点数并且你的-int64-可能溢出">JavaScript 解析整数为浮点数并且你的 int64 可能溢出<a hidden class="anchor" aria-hidden="true" href="#javascript-解析整数为浮点数并且你的-int64-可能溢出">#</a></h4>
<p>用 <code>json:&quot;id,string&quot;</code> 代替</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ID</span> <span class="kt">int64</span> <span class="s">`json:&#34;id,string&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="并发">并发<a hidden class="anchor" aria-hidden="true" href="#并发">#</a></h3>
<ul>
<li><input disabled="" type="checkbox"> 以线程安全的方式创建一些东西的最好选择是 <code>sync.Once</code>
<ul>
<li>不要用 flags, mutexes, channels or atomics</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 永远不要使用 <code>select{}</code>, 省略通道， 等待信号</li>
<li><input disabled="" type="checkbox"> 不要在 channel 里关闭，这是它的创作者的责任。
<ul>
<li>往一个关闭的 channel 会引起 panic</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> <code>math/rand</code> 中的 <code>func NewSource(seed int64) Source</code> 不是并发安全的，默认的 <code>lockedSource</code> 是并发安全的, see issue: <a href="https://github.com/golang/go/issues/3611">https://github.com/golang/go/issues/3611</a>
<ul>
<li>更多: <a href="https://golang.org/pkg/math/rand/">https://golang.org/pkg/math/rand/</a></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 当你需要一个自定义类型的 atomic 值时，可以使用 <a href="https://godoc.org/sync/atomic#Value">atomic.Value</a></li>
</ul>
<h3 id="性能">性能<a hidden class="anchor" aria-hidden="true" href="#性能">#</a></h3>
<ul>
<li><input disabled="" type="checkbox"> 不要省略 <code>defer</code>
<ul>
<li>在大多数情况下 200ns 加速可以忽略不计</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 总是关闭 http body <code>defer r.Body.Close()</code>
<ul>
<li>除非你需要泄露 goroutine</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 过滤但不分配新内存</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="nx">b</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">x</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">a</span> <span class="p">{</span>
  	<span class="k">if</span> <span class="nf">f</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
	    <span class="nx">b</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
  	<span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="为了帮助编译器删除绑定检查请参见此模式-_--b-7">为了帮助编译器删除绑定检查，请参见此模式 <code>_ = b [7]</code><a hidden class="anchor" aria-hidden="true" href="#为了帮助编译器删除绑定检查请参见此模式-_--b-7">#</a></h4>
<ul>
<li><input disabled="" type="checkbox"> <code>time.Time</code> 有指针字段 <code>time.Location</code> 并且这对 go GC 不好
<ul>
<li>只在大量的<code>time.Time</code>才有意义，用 timestamp 代替</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> <code>regexp.MustCompile</code> 比 <code>regexp.Compile</code> 更好
<ul>
<li>在大多数情况下，你的正则表达式是不可变的，所以你最好在 <code>func init</code> 中初始化它</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 请勿在你的热路径中过度使用 <code>fmt.Sprintf</code>. 由于维护接口的缓冲池和动态调度，它是很昂贵的。
<ul>
<li>如果你正在使用 <code>fmt.Sprintf(&quot;%s%s&quot;, var1, var2)</code>, 考虑使用简单的字符串连接。</li>
<li>如果你正在使用 <code>fmt.Sprintf(&quot;%x&quot;, var)</code>, 考虑使用 <code>hex.EncodeToString</code> or <code>strconv.FormatInt(var, 16)</code></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 如果你不需要用它，可以考虑丢弃它，例如<code>io.Copy(ioutil.Discard, resp.Body)</code>
<ul>
<li>HTTP 客户端的传输不会重用连接，直到body被读完和关闭。</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="nx">res</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
  <span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">ioutil</span><span class="p">.</span><span class="nx">Discard</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
  <span class="k">defer</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 不要在循环中使用 defer，否则会导致内存泄露
<ul>
<li>&lsquo;cause defers will grow your stack without the reason</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 不要忘记停止 ticker, 除非你需要泄露 channel</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
  <span class="k">defer</span> <span class="nx">ticker</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 用自定义的 marshaler 去加速 marshaler 过程
<ul>
<li>但是在使用它之前要进行定制！例如：<a href="https://play.golang.org/p/SEm9Hvsi0r">https://play.golang.org/p/SEm9Hvsi0r</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">func</span> <span class="p">(</span><span class="nx">entry</span> <span class="nx">Entry</span><span class="p">)</span> <span class="nf">MarshalJSON</span><span class="p">()</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">buffer</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBufferString</span><span class="p">(</span><span class="s">&#34;{&#34;</span><span class="p">)</span>
	<span class="nx">first</span> <span class="o">:=</span> <span class="kc">true</span>
	<span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">entry</span> <span class="p">{</span>
		<span class="nx">jsonValue</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">first</span> <span class="p">{</span>
			<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;,&#34;</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">first</span> <span class="p">=</span> <span class="kc">false</span>
		<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="nx">key</span> <span class="o">+</span> <span class="s">&#34;:&#34;</span> <span class="o">+</span> <span class="nb">string</span><span class="p">(</span><span class="nx">jsonValue</span><span class="p">))</span>
	<span class="p">}</span>
	<span class="nx">buffer</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;}&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">buffer</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">(),</span> <span class="kc">nil</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><input disabled="" type="checkbox"> <code>sync.Map</code> 不是万能的，没有很强的理由就不要使用它。</p>
<ul>
<li>了解更多: <a href="https://github.com/golang/go/blob/master/src/sync/map.go#L12">https://github.com/golang/go/blob/master/src/sync/map.go#L12</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 在 <code>sync.Pool</code> 中分配内存存储非指针数据</p>
<ul>
<li>了解更多: <a href="https://github.com/dominikh/go-tools/blob/master/cmd/staticcheck/docs/checks/SA6002">https://github.com/dominikh/go-tools/blob/master/cmd/staticcheck/docs/checks/SA6002</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 为了隐藏逃生分析的指针，你可以小心使用这个函数：:</p>
<ul>
<li>来源: <a href="https://go-review.googlesource.com/c/go/+/86976">https://go-review.googlesource.com/c/go/+/86976</a></li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="c1">// noescape hides a pointer from escape analysis.  noescape is
</span><span class="c1"></span>  <span class="c1">// the identity function but escape analysis doesn&#39;t think the
</span><span class="c1"></span>  <span class="c1">// output depends on the input. noescape is inlined and currently
</span><span class="c1"></span>  <span class="c1">// compiles down to zero instructions.
</span><span class="c1"></span>  <span class="c1">//go:nosplit
</span><span class="c1"></span>  <span class="kd">func</span> <span class="nf">noescape</span><span class="p">(</span><span class="nx">p</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
    <span class="nx">x</span> <span class="o">:=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">x</span> <span class="p">^</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><input disabled="" type="checkbox"> 对于最快的原子交换，你可以使用这个 <code>m := (*map[int]int)(atomic.LoadPointer(&amp;ptr))</code></p>
</li>
<li>
<p><input disabled="" type="checkbox"> 如果执行许多顺序读取或写入操作，请使用缓冲 I/O</p>
<ul>
<li>减少系统调用次数</li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 有 2 种方法清空一个 map：</p>
<ul>
<li>重用 map 内存 （但是也要注意 m 的回收）</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="k">for</span> <span class="nx">k</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span> <span class="p">{</span>
    <span class="nb">delete</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>分配新的</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="nx">m</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kt">int</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="模块">模块<a hidden class="anchor" aria-hidden="true" href="#模块">#</a></h3>
<ul>
<li><input disabled="" type="checkbox"> 如果你想在 CI 中测试 <code>go.mod</code> （和 <code>go.sum</code>）是否是最新 <a href="https://blog.urth.org/2019/08/13/testing-go-mod-tidiness-in-ci/">https://blog.urth.org/2019/08/13/testing-go-mod-tidiness-in-ci/</a></li>
</ul>
<h3 id="构建">构建<a hidden class="anchor" aria-hidden="true" href="#构建">#</a></h3>
<ul>
<li><input disabled="" type="checkbox"> 用这个命令 <code>go build -ldflags=&quot;-s -w&quot; ...</code> 去掉你的二进制文件</li>
<li><input disabled="" type="checkbox"> 拆分构建不同版本的简单方法
<ul>
<li>用 <code>// +build integration</code> 并且运行他们 <code>go test -v --tags integration .</code></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 最小的 Go Docker 镜像
<ul>
<li><a href="https://twitter.com/bbrodriges/status/873414658178396160">https://twitter.com/bbrodriges/status/873414658178396160</a></li>
<li><code>CGO_ENABLED=0 go build -ldflags=&quot;-s -w&quot; app.go &amp;&amp; tar C app | docker import - myimage:latest</code></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> run go format on CI and compare diff
<ul>
<li>这将确保一切都是生成的和承诺的</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 用最新的 Go 运行 Travis-CI，用 <code>travis 1</code>
<ul>
<li>了解更多：<a href="https://github.com/travis-ci/travis-build/blob/master/public/version-aliases/go.json">https://github.com/travis-ci/travis-build/blob/master/public/version-aliases/go.json</a></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 检查代码格式是否有错误 <code>diff -u &lt;(echo -n) &lt;(gofmt -d .)</code></li>
</ul>
<h3 id="测试">测试<a hidden class="anchor" aria-hidden="true" href="#测试">#</a></h3>
<ul>
<li><input disabled="" type="checkbox"> 测试名称 <code>package_test</code> 比 <code>package</code> 要好</li>
<li><input disabled="" type="checkbox"> <code>go test -short</code> 允许减少要运行的测试数</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">func</span> <span class="nf">TestSomething</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">testing</span><span class="p">.</span><span class="nf">Short</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nf">Skip</span><span class="p">(</span><span class="s">&#34;skipping test in short mode.&#34;</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 根据系统架构跳过测试</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="k">if</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">GOARM</span> <span class="o">==</span> <span class="s">&#34;arm&#34;</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">.</span><span class="nf">Skip</span><span class="p">(</span><span class="s">&#34;this doesn&#39;t work under ARM&#34;</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><input disabled="" type="checkbox"> 用 <code>testing.AllocsPerRun</code> 跟踪你的内存分配
<ul>
<li><a href="https://godoc.org/testing#AllocsPerRun">https://godoc.org/testing#AllocsPerRun</a></li>
</ul>
</li>
<li><input disabled="" type="checkbox"> 多次运行你的基准测试可以避免噪音。
<ul>
<li><code>go test -test.bench=. -count=20</code></li>
</ul>
</li>
</ul>
<h3 id="工具">工具<a hidden class="anchor" aria-hidden="true" href="#工具">#</a></h3>
<ul>
<li>
<p><input disabled="" type="checkbox"> 快速替换 <code>gofmt -w -l -r &quot;panic(err) -&gt; log.Error(err)&quot; .</code></p>
</li>
<li>
<p><input disabled="" type="checkbox"> <code>go list</code> 允许找到所有直接和传递的依赖关系</p>
<ul>
<li><code>go list -f '{{ .Imports }}' package</code></li>
<li><code>go list -f '{{ .Deps }}' package</code></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 对于快速基准比较，我们有一个 <code>benchstat</code> 工具。</p>
<ul>
<li><a href="https://godoc.org/golang.org/x/perf/cmd/benchstat">https://godoc.org/golang.org/x/perf/cmd/benchstat</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> <a href="https://github.com/go-critic/go-critic">go-critic</a> linter 从这个文件中强制执行几条建议</p>
</li>
<li>
<p><input disabled="" type="checkbox"> <code>go mod why -m &lt;module&gt;</code> 告诉我们为什么特定的模块在 <code>go.mod</code> 文件中。</p>
</li>
<li>
<p><input disabled="" type="checkbox"> <code>GOGC=off go build ...</code> 应该会加快构建速度 <a href="https://twitter.com/mvdan_/status/1107579946501853191">source</a></p>
</li>
<li>
<p><input disabled="" type="checkbox"> 内存分析器每 512KB 记录一次分配。你能通过 <code>GODEBUG</code> 环境变量增加比例，来查看你的文件的更多详细信息。</p>
<ul>
<li>来源：<a href="https://twitter.com/bboreham/status/1105036740253937664">https://twitter.com/bboreham/status/1105036740253937664</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> <code>go mod why -m &lt;module&gt;</code> 告诉我们为什么特定的模块是在 <code>go.mod</code> 文件中。</p>
</li>
</ul>
<h3 id="misc">Misc<a hidden class="anchor" aria-hidden="true" href="#misc">#</a></h3>
<ul>
<li><input disabled="" type="checkbox"> dump goroutines <a href="https://stackoverflow.com/a/27398062/433041">https://stackoverflow.com/a/27398062/433041</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">sigs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">sigs</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">)</span>
    <span class="nx">buf</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">{</span>
      <span class="o">&lt;-</span><span class="nx">sigs</span>
      <span class="nx">stacklen</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">Stack</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      <span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;=== received SIGQUIT ===\n*** goroutine dump...\n%s\n*** end\n&#34;</span>  <span class="p">,</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">stacklen</span><span class="p">])</span>
    <span class="p">}</span>
  <span class="p">}()</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><input disabled="" type="checkbox"> 在编译期检查接口的实现</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">var</span> <span class="nx">_</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">MyFastReader</span><span class="p">)(</span><span class="kc">nil</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><input disabled="" type="checkbox"> len(nil) = 0</p>
<ul>
<li><a href="https://golang.org/pkg/builtin/#len">https://golang.org/pkg/builtin/#len</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 匿名结构很酷</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="kd">var</span> <span class="nx">hits</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">n</span> <span class="kt">int</span>
  <span class="p">}</span>
  <span class="nx">hits</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="nx">hits</span><span class="p">.</span><span class="nx">n</span><span class="o">++</span>
  <span class="nx">hits</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p><input disabled="" type="checkbox"> <code>httputil.DumpRequest</code> 是非常有用的东西，不要自己创建</p>
<ul>
<li><a href="https://godoc.org/net/http/httputil#DumpRequest">https://godoc.org/net/http/httputil#DumpRequest</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 获得调用堆栈，我们可以使用 <code>runtime.Caller</code></p>
<ul>
<li><a href="https://golang.org/pkg/runtime/#Caller">https://golang.org/pkg/runtime/#Caller</a></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 要 marshal 任意的 JSON， 你可以 marshal 为 <code>map[string]interface{}{}</code></p>
</li>
<li>
<p><input disabled="" type="checkbox"> 配置你的 <code>CDPATH</code> 以便你能在任何目录执行 <code>cd github.com/golang/go</code></p>
<ul>
<li>添加这一行代码到 <code>bashrc</code>(或者其他类似的) <code>export CDPATH=$CDPATH:$GOPATH/src</code></li>
</ul>
</li>
<li>
<p><input disabled="" type="checkbox"> 从一个 slice 生成简单的随机元素</p>
<ul>
<li><code>[]string{&quot;one&quot;, &quot;two&quot;, &quot;three&quot;}[rand.Intn(3)]</code></li>
</ul>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
