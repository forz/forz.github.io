<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>MongoDB的插入操作 | Forz Blog</title>
<meta name="keywords" content="MongoDB" />
<meta name="description" content="创建collection 如果该集合当前不存在，则插入操作将创建该集合。 插入一个文档 Collection.InsertOne 将单个文档插入到集合中。 以下示例将一个新文档插入到inv">
<meta name="author" content="">
<link rel="canonical" href="/post/mongodb%E7%9A%84%E6%8F%92%E5%85%A5%E6%93%8D%E4%BD%9C/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="MongoDB的插入操作" />
<meta property="og:description" content="创建collection 如果该集合当前不存在，则插入操作将创建该集合。 插入一个文档 Collection.InsertOne 将单个文档插入到集合中。 以下示例将一个新文档插入到inv" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/mongodb%E7%9A%84%E6%8F%92%E5%85%A5%E6%93%8D%E4%BD%9C/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-05-06T14:55:26&#43;00:00" />
<meta property="article:modified_time" content="2020-05-06T14:55:26&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MongoDB的插入操作"/>
<meta name="twitter:description" content="创建collection 如果该集合当前不存在，则插入操作将创建该集合。 插入一个文档 Collection.InsertOne 将单个文档插入到集合中。 以下示例将一个新文档插入到inv"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "MongoDB的插入操作",
      "item": "/post/mongodb%E7%9A%84%E6%8F%92%E5%85%A5%E6%93%8D%E4%BD%9C/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "MongoDB的插入操作",
  "name": "MongoDB的插入操作",
  "description": "创建collection 如果该集合当前不存在，则插入操作将创建该集合。 插入一个文档 Collection.InsertOne 将单个文档插入到集合中。 以下示例将一个新文档插入到inv",
  "keywords": [
    "MongoDB"
  ],
  "articleBody": "创建collection 如果该集合当前不存在，则插入操作将创建该集合。\n插入一个文档 Collection.InsertOne 将单个文档插入到集合中。\n以下示例将一个新文档插入到inventory集合中。如果文档未指定_id字段，则驱动程序会将_id具有ObjectId值的字段添加到新文档中。请参阅插入特性。\n1 2 3 4 5 6 7 8 9 10 11 12  result, err := coll.InsertOne( context.Background(), bson.D{ {\"item\", \"canvas\"}, {\"qty\", 100}, {\"tags\", bson.A{\"cotton\"}}, {\"size\", bson.D{ {\"h\", 28}, {\"w\", 35.5}, {\"uom\", \"cm\"}, }}, })   insertOne()返回包含新插入的文档的_id字段值的文档。有关返回文档的示例，请参见 db.collection.insertOne（）参考。\n要检索刚刚插入的文档，请查询集合：\n1 2 3 4  cursor, err := coll.Find( context.Background(), bson.D{{\"item\", \"canvas\"}}, )   插入多个文档 Collection.InsertMany 可以将多个文档插入一个集合中。\n下面的示例将三个新文档插入到 inventory集合中。如果文档未指定_id字段，则驱动程序会将_id具有ObjectId值的字段添加到每个文档中。请参阅插入特性。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  result, err := coll.InsertMany( context.Background(), []interface{}{ bson.D{ {\"item\", \"journal\"}, {\"qty\", int32(25)}, {\"tags\", bson.A{\"blank\", \"red\"}}, {\"size\", bson.D{ {\"h\", 14}, {\"w\", 21}, {\"uom\", \"cm\"}, }}, }, bson.D{ {\"item\", \"mat\"}, {\"qty\", int32(25)}, {\"tags\", bson.A{\"gray\"}}, {\"size\", bson.D{ {\"h\", 27.9}, {\"w\", 35.5}, {\"uom\", \"cm\"}, }}, }, bson.D{ {\"item\", \"mousepad\"}, {\"qty\", 25}, {\"tags\", bson.A{\"gel\", \"blue\"}}, {\"size\", bson.D{ {\"h\", 19}, {\"w\", 22.85}, {\"uom\", \"cm\"}, }}, }, })   要检索插入的文档，请查询集合：\n1 2 3 4  cursor, err := coll.Find( context.Background(), bson.D{}, )   特性 集合创建 如果该集合当前不存在，则插入操作将创建该集合。\n_id字段 在MongoDB中，存储在集合中的每个文档都需要一个唯一的 _id字段作为主键。如果插入的文档省略了该_id字段，则MongoDB驱动程序会自动为该字段生成一个ObjectId_id。\n这也适用于通过upsert：true通过更新操作插入的文档。\n原子性 MongoDB中的所有写操作都是单个文档级别的原子操作。\n写确认 对于写入问题，您可以指定从MongoDB请求的写入操作的确认级别。\nMongoShell方法 MongoDB提供了以下将文档插入到集合中的方法：\ndb.collection.insertOne() 定义 此小节记录了mongoshell方法，对于相应的MongoDB驱动程序API，请改为参考您特定的MongoDB驱动程序文档。\n3.2版中的新功能。\n将文档插入集合中。\n该insertOne()方法具有以下语法：\n1 2 3 4 5 6  db.collection.insertOne( , { writeConcern:  } )      参数 类型 描述     document document 要插入集合中的文档。   writeConcern document 可选的。表达文档的写关注。忽略使用默认的写关注。如果在事务中运行，则不要为操作明确设置写关注。要对事务使用写关注，请参见事务和写关注。    返回值:包含以下内容的文档：\n 一个布尔值acknowledged，true为该操作在运行时带有写关注，false为禁用了写关注点。 insertedId为插入文档的_id字段。  特性 集合创建 如果该集合不存在，则该 insertOne()方法将创建该集合。\n_id字段 如果文档未指定_id字段，则将在插入之前mongod 添加该_id字段并ObjectId为文档分配唯一性 。大多数驱动程序会创建一个ObjectId并插入该_id字段，但是 如果驱动程序或应用程序未mongod创建，则会创建并填充_id。\n如果文档包含一个_id字段，则该_id值在集合中必须唯一，以避免重复的键错误。\n可解释性 insertOne()不兼容 db.collection.explain()。\n使用insert()代替。\n错误处理 错误时，db.collection.insertOne()引发writeError 或writeConcernError异常。\n事务 db.collection.insertOne()可以在多文档事务中使用。\n集合必须已经存在。事务中不允许执行会导致创建新集合的插入操作。\n如果在事务中运行，则不要为操作明确设置写关注点。要对事务使用写关注，请参见 事务和写关注。\n重要 在大多数情况下，与单文档写入相比，多文档事务会产生更高的性能成本，并且多文档事务的可用性不应替代有效的架构设计。在许多情况下， 非规范化数据模型（嵌入式文档和数组）将继续是您的数据和用例的最佳选择。也就是说，在许多情况下，对数据进行适当的建模将最大程度地减少对多文档交易的需求。\n有关其他事务使用方面的注意事项（例如运行时限制和oplog大小限制），另请参见生产注意事项。\n例子 插入文档而不指定_id字段 在以下示例中，传递给该insertOne()方法的文档 不包含该_id 字段：\n1 2 3 4 5  try { db.products.insertOne( { item: \"card\", qty: 15 } ); } catch (e) { print (e); };   该操作返回以下文档：\n1 2 3 4  { \"acknowledged\" : true, \"insertedId\" : ObjectId(\"56fc40f9d735c28df206d078\") }   由于文档不包含_id，因此 mongod创建并添加了该_id字段并为其分配了唯一ObjectId值。\n这些ObjectId值特定于机器和运行该操作的时间。因此，您的值可能与示例中的值不同。\n插入指定_id字段的文档 在以下示例中，传递给该insertOne()方法的文档 包括该_id字段。值_id在集合中必须唯一，以避免重复的键错误。\n1 2 3 4 5  try { db.products.insertOne( { _id: 10, item: \"box\", qty: 20 } ); } catch (e) { print (e); }   该操作返回以下内容：\n1  { \"acknowledged\" : true, \"insertedId\" : 10 }   为唯一索引（例如）的一部分的任何键插入重复值_id会引发异常。以下尝试插入具有_id已经存在的值的文档：\n1 2 3 4 5  try { db.products.insertOne( { _id: 10, \"item\" : \"packing peanuts\", \"qty\" : 200 } ); } catch (e) { print (e); }   由于已经存在，因此将引发以下异常：_id: 10\n1 2 3 4 5 6 7 8 9 10  WriteError({ \"index\" : 0, \"code\" : 11000, \"errmsg\" : \"E11000 duplicate key error collection: inventory.products index: _id_ dup key: { : 10.0 }\", \"op\" : { \"_id\" : 10, \"item\" : \"packing peanuts\", \"qty\" : 200 } })   提高写入关注 给定一个三成员副本集，以下操作指定w:majority，wtimeoutw:100：\n1 2 3 4 5 6 7 8  try { db.products.insertOne( { \"item\": \"envelopes\", \"qty\": 100, type: \"Self-Sealing\" }, { writeConcern: { w : \"majority\", wtimeout : 100 } } ); } catch (e) { print (e); }   如果确认花费的时间超过wtimeout限制，则会引发以下异常：\n1 2 3 4 5 6 7  WriteConcernError({ \"code\" : 64, \"errInfo\" : { \"wtimeout\" : true }, \"errmsg\" : \"waiting for replication timed out\" })   db.collection.insertMany() db.collection.insertMany()将多个文档插入集合中。\n定义 db.collection.insertMany（）\n此小节记录了mongoshell方法，对于相应的MongoDB驱动程序API，请改为参考您特定的MongoDB驱动程序文档。\n3.2版中的新功能。\n将多个文档插入集合中。\n该insertMany()方法具有以下语法：\n1 2 3 4 5 6 7  db.collection.insertMany( [  1 ,  2, ... ], { writeConcern: , ordered:  } )      参数 类型 描述     document document 要插入集合中的一组文档。   writeConcern document 可选的。表达文档的写关注。忽略使用默认的写关注。如果在事务中运行，则不要为操作明确设置写关注。要对事务使用写关注，请参见事务和写关注。   ordered 布尔值 可选的。一个布尔值，指定mongod实例应执行有序插入还是无序插入。默认为true。    返回值：包含以下内容的文档：\n 一个布尔值acknowledged，就true好像该操作运行时具有写关注或false禁用了写关注 成功插入的文档的数组的每个_id  特性 给定一个文档数组，insertMany() 将数组中的每个文档插入集合中。\n操作的执行 默认情况下，按顺序插入文档。\n如果ordered设置为false，则文档将以无序格式插入，并且可以通过重新排序mongod来提高性能。如果使用无序，则应用程序不应依赖于insertMany()插入的顺序。\n每个组中的操作数不能超过maxWriteBatchSize数据库的值。从MongoDB 3.6开始，此值为100,000。该值显示在该isMaster.maxWriteBatchSize字段中。\n此限制可防止出现错误消息过多的问题。如果某个组超过了此数量limit，则客户端驱动程序会将其分为计数小于或等于限制值的较小组。例如，如果maxWriteBatchSize值为100,000，则如果队列包含 200,000操作，则驱动程序将创建2个组，每个组均包含100,000操作。\n注意:当使用高级API时，驱动程序仅将组分为较小的组。如果直接使用 db.runCommand（）（例如，在编写驱动程序时），则MongoDB在尝试执行超出限制的写批处理时会引发错误。\n从MongoDB 3.6开始，一旦单个批次的错误报告变得太大，MongoDB就会将所有剩余的错误消息截断为空字符串。当前，一旦至少有2条错误消息且总大小大于1MB,便开始截断。\n大小和分组机制是内部性能的详细信息，将来可能会更改。\nordered在分片集合上执行操作列表通常比执行unordered列表要慢， 因为对于有序列表，每个操作必须等待上一个操作完成。\n集合创建 如果该集合不存在，则insertMany() 在成功写入时创建该集合。\n_id字段 如果文档未指定_id字段，则mongod 添加该_id字段并为文档分配唯一ObjectId。大多数驱动程序会创建一个ObjectId并插入该_id字段，但是如果驱动程序或应用程序未创建，mongod则会创建并填充_id。\n如果文档包含一个_id字段，则该_id值在集合中必须唯一，以避免重复的键错误。\n可解释性 insertMany()与不兼容 db.collection.explain()。\n使用insert()代替。\n错误处理 插入引发BulkWriteError异常。\n排除“写关注”错误后，有序操作将在发生错误后停止，而无序操作将继续处理队列中所有剩余的写操作。\n写关注错误显示在该writeConcernErrors字段中，而所有其他错误显示在该writeErrors字段中。如果遇到错误，将显示成功写入操作的次数，而不是插入的_id的列表。有序操作显示遇到的单个错误，而无序操作显示数组中的每个错误。\n事务 db.collection.insertMany()可以在多文档事务中使用。\n集合必须已经存在。事务中不允许执行会导致创建新集合的插入操作。\n如果在事务中运行，则不要为操作明确设置写关注点。要对事务使用写关注，请参见 事务和写关注。\n重要 在大多数情况下，与单文档写入相比，多文档事务会产生更高的性能成本，并且多文档事务的可用性不应替代有效的架构设计。在许多情况下， 非规范化数据模型（嵌入式文档和数组）将继续是您的数据和用例的最佳选择。也就是说，在许多情况下，对数据进行适当的建模将最大程度地减少对多文档交易的需求。\n有关其他事务使用方面的注意事项（例如运行时限制和oplog大小限制），另请参见生产注意事项。\n例子 以下示例将文档插入products 集合中。\n插入多个文档而不指定_id字段 以下示例用于db.collection.insertMany()插入不包含该_id字段的文档：\n1 2 3 4 5 6 7 8 9  try { db.products.insertMany( [ { item: \"card\", qty: 15 }, { item: \"envelope\", qty: 20 }, { item: \"stamps\" , qty: 30 } ] ); } catch (e) { print (e); }   该操作返回以下文档：\n1 2 3 4 5 6 7 8  { \"acknowledged\" : true, \"insertedIds\" : [ ObjectId(\"562a94d381cb9f1cd6eb0e1a\"), ObjectId(\"562a94d381cb9f1cd6eb0e1b\"), ObjectId(\"562a94d381cb9f1cd6eb0e1c\") ] }   由于文档不包含_id， mongod因此_id为每个文档创建并添加字段，并为其分配唯一ObjectId值。\n这些ObjectId值特定于机器和运行该操作的时间。因此，您的值可能与示例中的值不同。\n插入多个指定_id字段的文档 以下示例/操作用于insertMany()插入包含该_id字段的文档。值_id在集合中必须唯一，以避免重复的键错误。\n1 2 3 4 5 6 7 8 9  try { db.products.insertMany( [ { _id: 10, item: \"large box\", qty: 20 }, { _id: 11, item: \"small box\", qty: 55 }, { _id: 12, item: \"medium box\", qty: 30 } ] ); } catch (e) { print (e); }   该操作返回以下文档：\n1  { \"acknowledged\" : true, \"insertedIds\" : [ 10, 11, 12 ] }   为唯一索引（例如）的一部分的任何键插入重复值都会_id引发异常。以下尝试插入具有_id已经存在的值的文档：\n1 2 3 4 5 6 7 8 9  try { db.products.insertMany( [ { _id: 13, item: \"envelopes\", qty: 60 }, { _id: 13, item: \"stamps\", qty: 110 }, { _id: 14, item: \"packing tape\", qty: 38 } ] ); } catch (e) { print (e); }   由于已经存在，因此将引发以下异常：_id: 13\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  BulkWriteError({ \"writeErrors\" : [ { \"index\" : 0, \"code\" : 11000, \"errmsg\" : \"E11000 duplicate key error collection: inventory.products index: _id_ dup key: { : 13.0 }\", \"op\" : { \"_id\" : 13, \"item\" : \"stamps\", \"qty\" : 110 } } ], \"writeConcernErrors\" : [ ], \"nInserted\" : 1, \"nUpserted\" : 0, \"nMatched\" : 0, \"nModified\" : 0, \"nRemoved\" : 0, \"upserted\" : [ ] })   请注意，第一个_id: 13的文档将成功插入，但第二个插入将失败。这也将阻止插入队列中剩余的其他文档。\n使用ordered为false，插入操作将继续处理所有剩余文档。\n无序插入 以下尝试插入带有和_id字段的 多个文档。文档数组包含两个具有重复字段的文档。ordered为false\n1 2 3 4 5 6 7 8 9 10 11 12 13  try { db.products.insertMany( [ { _id: 10, item: \"large box\", qty: 20 }, { _id: 11, item: \"small box\", qty: 55 }, { _id: 11, item: \"medium box\", qty: 30 }, { _id: 12, item: \"envelope\", qty: 100}, { _id: 13, item: \"stamps\", qty: 125 }, { _id: 13, item: \"tape\", qty: 20}, { _id: 14, item: \"bubble wrap\", qty: 30} ], { ordered: false } ); } catch (e) { print (e); }   该操作引发以下异常：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  BulkWriteError({ \"writeErrors\" : [ { \"index\" : 2, \"code\" : 11000, \"errmsg\" : \"E11000 duplicate key error collection: inventory.products index: _id_ dup key: { : 11.0 }\", \"op\" : { \"_id\" : 11, \"item\" : \"medium box\", \"qty\" : 30 } }, { \"index\" : 5, \"code\" : 11000, \"errmsg\" : \"E11000 duplicate key error collection: inventory.products index: _id_ dup key: { : 13.0 }\", \"op\" : { \"_id\" : 13, \"item\" : \"tape\", \"qty\" : 20 } } ], \"writeConcernErrors\" : [ ], \"nInserted\" : 5, \"nUpserted\" : 0, \"nMatched\" : 0, \"nModified\" : 0, \"nRemoved\" : 0, \"upserted\" : [ ] })   尽管由于重复值而有且文档插入失败，但表明剩余的5个文档已插入。\n使用写关注 给定一个三成员副本集，以下操作指定 wof majority和wtimeoutof 100：\n1 2 3 4 5 6 7 8 9 10 11 12  try { db.products.insertMany( [ { _id: 10, item: \"large box\", qty: 20 }, { _id: 11, item: \"small box\", qty: 55 }, { _id: 12, item: \"medium box\", qty: 30 } ], { w: \"majority\", wtimeout: 100 } ); } catch (e) { print (e); }   如果主服务器和至少一个辅助服务器在100毫秒内确认每个写操作，则返回：\n1 2 3 4 5 6 7 8  { \"acknowledged\" : true, \"insertedIds\" : [ ObjectId(\"562a94d381cb9f1cd6eb0e1a\"), ObjectId(\"562a94d381cb9f1cd6eb0e1b\"), ObjectId(\"562a94d381cb9f1cd6eb0e1c\") ] }   如果副本集中所有必需节点确认写操作所需的总时间大于wtimeout，则在wtimeout时间段后将显示以下writeConcernError内容。\n该操作返回：\n1 2 3 4 5 6 7  WriteConcernError({ \"code\" : 64, \"errInfo\" : { \"wtimeout\" : true }, \"errmsg\" : \"waiting for replication timed out\" })   其他插入方法 以下方法还可以将新文档添加到集合中：\ndb.collection.update()与该选项一起使用时:upsert: true db.collection.updateOne()与该选项一起使用时:upsert: true db.collection.updateMany()与该选项一起使用时:upsert: true db.collection.findAndModify()与该选项一起使用时:upsert: true db.collection.findOneAndUpdate()与该选项一起使用时 :upsert: true db.collection.findOneAndReplace()与该选项一起使用时 :upsert: true db.collection.save()。 db.collection.bulkWrite()。\n有关更多方法和示例，请参见各个方法的参考页。\n",
  "wordCount" : "5671",
  "inLanguage": "zh-cn",
  "datePublished": "2020-05-06T14:55:26Z",
  "dateModified": "2020-05-06T14:55:26Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/mongodb%E7%9A%84%E6%8F%92%E5%85%A5%E6%93%8D%E4%BD%9C/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      MongoDB的插入操作
    </h1>
    <div class="post-meta">May 6, 2020
</div>
  </header> 
  <div class="post-content"><h1 id="创建collection">创建collection<a hidden class="anchor" aria-hidden="true" href="#创建collection">#</a></h1>
<p>如果该集合当前不存在，则插入操作将创建该集合。</p>
<h1 id="插入一个文档">插入一个文档<a hidden class="anchor" aria-hidden="true" href="#插入一个文档">#</a></h1>
<p>Collection.InsertOne 将单个文档插入到集合中。</p>
<p>以下示例将一个新文档插入到inventory集合中。如果文档未指定_id字段，则驱动程序会将_id具有ObjectId值的字段添加到新文档中。请参阅插入特性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">result, err :<span class="o">=</span> coll.InsertOne<span class="o">(</span>
	context.Background<span class="o">()</span>,
	bson.D<span class="o">{</span>
		<span class="o">{</span><span class="s2">&#34;item&#34;</span>, <span class="s2">&#34;canvas&#34;</span><span class="o">}</span>,
		<span class="o">{</span><span class="s2">&#34;qty&#34;</span>, 100<span class="o">}</span>,
		<span class="o">{</span><span class="s2">&#34;tags&#34;</span>, bson.A<span class="o">{</span><span class="s2">&#34;cotton&#34;</span><span class="o">}}</span>,
		<span class="o">{</span><span class="s2">&#34;size&#34;</span>, bson.D<span class="o">{</span>
			<span class="o">{</span><span class="s2">&#34;h&#34;</span>, 28<span class="o">}</span>,
			<span class="o">{</span><span class="s2">&#34;w&#34;</span>, 35.5<span class="o">}</span>,
			<span class="o">{</span><span class="s2">&#34;uom&#34;</span>, <span class="s2">&#34;cm&#34;</span><span class="o">}</span>,
		<span class="o">}}</span>,
	<span class="o">})</span>
</code></pre></td></tr></table>
</div>
</div><p>insertOne()返回包含新插入的文档的_id字段值的文档。有关返回文档的示例，请参见 db.collection.insertOne（）参考。</p>
<p>要检索刚刚插入的文档，请查询集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">cursor, err :<span class="o">=</span> coll.Find<span class="o">(</span>
	context.Background<span class="o">()</span>,
	bson.D<span class="o">{{</span><span class="s2">&#34;item&#34;</span>, <span class="s2">&#34;canvas&#34;</span><span class="o">}}</span>,
<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="插入多个文档">插入多个文档<a hidden class="anchor" aria-hidden="true" href="#插入多个文档">#</a></h1>
<p>Collection.InsertMany 可以将多个文档插入一个集合中。</p>
<p>下面的示例将三个新文档插入到 inventory集合中。如果文档未指定_id字段，则驱动程序会将_id具有ObjectId值的字段添加到每个文档中。请参阅插入特性。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">coll</span><span class="p">.</span><span class="nf">InsertMany</span><span class="p">(</span>
	<span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span>
	<span class="p">[]</span><span class="kd">interface</span><span class="p">{}{</span>
		<span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
			<span class="p">{</span><span class="s">&#34;item&#34;</span><span class="p">,</span> <span class="s">&#34;journal&#34;</span><span class="p">},</span>
			<span class="p">{</span><span class="s">&#34;qty&#34;</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">25</span><span class="p">)},</span>
			<span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">A</span><span class="p">{</span><span class="s">&#34;blank&#34;</span><span class="p">,</span> <span class="s">&#34;red&#34;</span><span class="p">}},</span>
			<span class="p">{</span><span class="s">&#34;size&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
				<span class="p">{</span><span class="s">&#34;h&#34;</span><span class="p">,</span> <span class="mi">14</span><span class="p">},</span>
				<span class="p">{</span><span class="s">&#34;w&#34;</span><span class="p">,</span> <span class="mi">21</span><span class="p">},</span>
				<span class="p">{</span><span class="s">&#34;uom&#34;</span><span class="p">,</span> <span class="s">&#34;cm&#34;</span><span class="p">},</span>
			<span class="p">}},</span>
		<span class="p">},</span>
		<span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
			<span class="p">{</span><span class="s">&#34;item&#34;</span><span class="p">,</span> <span class="s">&#34;mat&#34;</span><span class="p">},</span>
			<span class="p">{</span><span class="s">&#34;qty&#34;</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="mi">25</span><span class="p">)},</span>
			<span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">A</span><span class="p">{</span><span class="s">&#34;gray&#34;</span><span class="p">}},</span>
			<span class="p">{</span><span class="s">&#34;size&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
				<span class="p">{</span><span class="s">&#34;h&#34;</span><span class="p">,</span> <span class="mf">27.9</span><span class="p">},</span>
				<span class="p">{</span><span class="s">&#34;w&#34;</span><span class="p">,</span> <span class="mf">35.5</span><span class="p">},</span>
				<span class="p">{</span><span class="s">&#34;uom&#34;</span><span class="p">,</span> <span class="s">&#34;cm&#34;</span><span class="p">},</span>
			<span class="p">}},</span>
		<span class="p">},</span>
		<span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
			<span class="p">{</span><span class="s">&#34;item&#34;</span><span class="p">,</span> <span class="s">&#34;mousepad&#34;</span><span class="p">},</span>
			<span class="p">{</span><span class="s">&#34;qty&#34;</span><span class="p">,</span> <span class="mi">25</span><span class="p">},</span>
			<span class="p">{</span><span class="s">&#34;tags&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">A</span><span class="p">{</span><span class="s">&#34;gel&#34;</span><span class="p">,</span> <span class="s">&#34;blue&#34;</span><span class="p">}},</span>
			<span class="p">{</span><span class="s">&#34;size&#34;</span><span class="p">,</span> <span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{</span>
				<span class="p">{</span><span class="s">&#34;h&#34;</span><span class="p">,</span> <span class="mi">19</span><span class="p">},</span>
				<span class="p">{</span><span class="s">&#34;w&#34;</span><span class="p">,</span> <span class="mf">22.85</span><span class="p">},</span>
				<span class="p">{</span><span class="s">&#34;uom&#34;</span><span class="p">,</span> <span class="s">&#34;cm&#34;</span><span class="p">},</span>
			<span class="p">}},</span>
		<span class="p">},</span>
	<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>要检索插入的文档，请查询集合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cursor</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">coll</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span>
	<span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span>
	<span class="nx">bson</span><span class="p">.</span><span class="nx">D</span><span class="p">{},</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="特性">特性<a hidden class="anchor" aria-hidden="true" href="#特性">#</a></h1>
<h2 id="集合创建">集合创建<a hidden class="anchor" aria-hidden="true" href="#集合创建">#</a></h2>
<p>如果该集合当前不存在，则插入操作将创建该集合。</p>
<h2 id="_id字段">_id字段<a hidden class="anchor" aria-hidden="true" href="#_id字段">#</a></h2>
<p>在MongoDB中，存储在集合中的每个文档都需要一个唯一的 _id字段作为主键。如果插入的文档省略了该_id字段，则MongoDB驱动程序会自动为该字段生成一个ObjectId_id。</p>
<p>这也适用于通过<code>upsert：true</code>通过更新操作插入的文档。</p>
<h2 id="原子性">原子性<a hidden class="anchor" aria-hidden="true" href="#原子性">#</a></h2>
<p>MongoDB中的所有写操作都是单个文档级别的原子操作。</p>
<h2 id="写确认">写确认<a hidden class="anchor" aria-hidden="true" href="#写确认">#</a></h2>
<p>对于写入问题，您可以指定从MongoDB请求的写入操作的确认级别。</p>
<h1 id="mongoshell方法">MongoShell方法<a hidden class="anchor" aria-hidden="true" href="#mongoshell方法">#</a></h1>
<p>MongoDB提供了以下将文档插入到集合中的方法：</p>
<h2 id="dbcollectioninsertone">db.collection.insertOne()<a hidden class="anchor" aria-hidden="true" href="#dbcollectioninsertone">#</a></h2>
<h3 id="定义">定义<a hidden class="anchor" aria-hidden="true" href="#定义">#</a></h3>
<p>此小节记录了mongoshell方法，对于相应的MongoDB驱动程序API，请改为参考您特定的MongoDB驱动程序文档。</p>
<p>3.2版中的新功能。</p>
<p>将文档插入集合中。</p>
<p>该insertOne()方法具有以下语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">db.collection.insertOne<span class="o">(</span>
   &lt;document&gt;,
   <span class="o">{</span>
      writeConcern: &lt;document&gt;
   <span class="o">}</span>
<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>document</td>
<td>document</td>
<td>要插入集合中的文档。</td>
</tr>
<tr>
<td>writeConcern</td>
<td>document</td>
<td>可选的。表达文档的写关注。忽略使用默认的写关注。如果在事务中运行，则不要为操作明确设置写关注。要对事务使用写关注，请参见事务和写关注。</td>
</tr>
</tbody>
</table>
<p>返回值:包含以下内容的文档：</p>
<ul>
<li>一个布尔值acknowledged，true为该操作在运行时带有写关注，false为禁用了写关注点。</li>
<li>insertedId为插入文档的_id字段。</li>
</ul>
<h3 id="特性-1">特性<a hidden class="anchor" aria-hidden="true" href="#特性-1">#</a></h3>
<h4 id="集合创建-1">集合创建<a hidden class="anchor" aria-hidden="true" href="#集合创建-1">#</a></h4>
<p>如果该集合不存在，则该 insertOne()方法将创建该集合。</p>
<h4 id="_id字段-1">_id字段<a hidden class="anchor" aria-hidden="true" href="#_id字段-1">#</a></h4>
<p>如果文档未指定_id字段，则将在插入之前mongod 添加该_id字段并ObjectId为文档分配唯一性 。大多数驱动程序会创建一个ObjectId并插入该_id字段，但是 如果驱动程序或应用程序未mongod创建，则会创建并填充_id。</p>
<p>如果文档包含一个_id字段，则该_id值在集合中必须唯一，以避免重复的键错误。</p>
<h4 id="可解释性">可解释性<a hidden class="anchor" aria-hidden="true" href="#可解释性">#</a></h4>
<p>insertOne()不兼容 db.collection.explain()。</p>
<p>使用insert()代替。</p>
<h4 id="错误处理">错误处理<a hidden class="anchor" aria-hidden="true" href="#错误处理">#</a></h4>
<p>错误时，<code>db.collection.insertOne()</code>引发writeError 或writeConcernError异常。</p>
<h4 id="事务">事务<a hidden class="anchor" aria-hidden="true" href="#事务">#</a></h4>
<p>db.collection.insertOne()可以在多文档事务中使用。</p>
<p>集合必须已经存在。事务中不允许执行会导致创建新集合的插入操作。</p>
<p>如果在事务中运行，则不要为操作明确设置写关注点。要对事务使用写关注，请参见 <a href="https://docs.mongodb.com/manual/core/transactions/#transactions-write-concern">事务和写关注</a>。</p>
<p><strong>重要</strong>
<strong>在大多数情况下，与单文档写入相比，多文档事务会产生更高的性能成本，并且多文档事务的可用性不应替代有效的架构设计。在许多情况下， 非规范化数据模型（嵌入式文档和数组）将继续是您的数据和用例的最佳选择。也就是说，在许多情况下，对数据进行适当的建模将最大程度地减少对多文档交易的需求。</strong></p>
<p>有关其他事务使用方面的注意事项（例如运行时限制和oplog大小限制），另请参见<a href="https://docs.mongodb.com/manual/core/transactions-production-consideration/">生产注意事项</a>。</p>
<h3 id="例子">例子<a hidden class="anchor" aria-hidden="true" href="#例子">#</a></h3>
<h4 id="插入文档而不指定_id字段">插入文档而不指定_id字段<a hidden class="anchor" aria-hidden="true" href="#插入文档而不指定_id字段">#</a></h4>
<p>在以下示例中，传递给该insertOne()方法的文档 不包含该_id 字段：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">try <span class="o">{</span>
   db.products.insertOne<span class="o">(</span> <span class="o">{</span> item: <span class="s2">&#34;card&#34;</span>, qty: <span class="m">15</span> <span class="o">}</span> <span class="o">)</span><span class="p">;</span>
<span class="o">}</span> catch <span class="o">(</span>e<span class="o">)</span> <span class="o">{</span>
   print <span class="o">(</span>e<span class="o">)</span><span class="p">;</span>
<span class="o">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作返回以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;acknowledged&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
   <span class="nt">&#34;insertedId&#34;</span> <span class="p">:</span> <span class="err">ObjectId(</span><span class="s2">&#34;56fc40f9d735c28df206d078&#34;</span><span class="err">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>由于文档不包含_id，因此 mongod创建并添加了该_id字段并为其分配了唯一ObjectId值。</p>
<p>这些ObjectId值特定于机器和运行该操作的时间。因此，您的值可能与示例中的值不同。</p>
<h4 id="插入指定_id字段的文档">插入指定_id字段的文档<a hidden class="anchor" aria-hidden="true" href="#插入指定_id字段的文档">#</a></h4>
<p>在以下示例中，传递给该insertOne()方法的文档 包括该_id字段。值_id在集合中必须唯一，以避免重复的键错误。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">try <span class="o">{</span>
   db.products.insertOne<span class="o">(</span> <span class="o">{</span> _id: 10, item: <span class="s2">&#34;box&#34;</span>, qty: <span class="m">20</span> <span class="o">}</span> <span class="o">)</span><span class="p">;</span>
<span class="o">}</span> catch <span class="o">(</span>e<span class="o">)</span> <span class="o">{</span>
   print <span class="o">(</span>e<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作返回以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;acknowledged&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nt">&#34;insertedId&#34;</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>为唯一索引（例如）的一部分的任何键插入重复值_id会引发异常。以下尝试插入具有_id已经存在的值的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">try <span class="o">{</span>
   db.products.insertOne<span class="o">(</span> <span class="o">{</span> _id: 10, <span class="s2">&#34;item&#34;</span> : <span class="s2">&#34;packing peanuts&#34;</span>, <span class="s2">&#34;qty&#34;</span> : <span class="m">200</span> <span class="o">}</span> <span class="o">)</span><span class="p">;</span>
<span class="o">}</span> catch <span class="o">(</span>e<span class="o">)</span> <span class="o">{</span>
   print <span class="o">(</span>e<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>由于已经存在，因此将引发以下异常：_id: 10</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">WriteError<span class="o">({</span>
   <span class="s2">&#34;index&#34;</span> : 0,
   <span class="s2">&#34;code&#34;</span> : 11000,
   <span class="s2">&#34;errmsg&#34;</span> : <span class="s2">&#34;E11000 duplicate key error collection: inventory.products index: _id_ dup key: { : 10.0 }&#34;</span>,
   <span class="s2">&#34;op&#34;</span> : <span class="o">{</span>
      <span class="s2">&#34;_id&#34;</span> : 10,
      <span class="s2">&#34;item&#34;</span> : <span class="s2">&#34;packing peanuts&#34;</span>,
      <span class="s2">&#34;qty&#34;</span> : <span class="m">200</span>
   <span class="o">}</span>
<span class="o">})</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="提高写入关注">提高写入关注<a hidden class="anchor" aria-hidden="true" href="#提高写入关注">#</a></h4>
<p>给定一个三成员副本集，以下操作指定w:majority，wtimeoutw:100：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">try <span class="o">{</span>
   db.products.insertOne<span class="o">(</span>
       <span class="o">{</span> <span class="s2">&#34;item&#34;</span>: <span class="s2">&#34;envelopes&#34;</span>, <span class="s2">&#34;qty&#34;</span>: 100, type: <span class="s2">&#34;Self-Sealing&#34;</span> <span class="o">}</span>,
       <span class="o">{</span> writeConcern: <span class="o">{</span> w : <span class="s2">&#34;majority&#34;</span>, wtimeout : <span class="m">100</span> <span class="o">}</span> <span class="o">}</span>
   <span class="o">)</span><span class="p">;</span>
<span class="o">}</span> catch <span class="o">(</span>e<span class="o">)</span> <span class="o">{</span>
   print <span class="o">(</span>e<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果确认花费的时间超过wtimeout限制，则会引发以下异常：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">WriteConcernError(</span><span class="p">{</span>
   <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
   <span class="nt">&#34;errInfo&#34;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;wtimeout&#34;</span> <span class="p">:</span> <span class="kc">true</span>
   <span class="p">},</span>
   <span class="nt">&#34;errmsg&#34;</span> <span class="p">:</span> <span class="s2">&#34;waiting for replication timed out&#34;</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="dbcollectioninsertmany">db.collection.insertMany()<a hidden class="anchor" aria-hidden="true" href="#dbcollectioninsertmany">#</a></h2>
<p>db.collection.insertMany()将多个文档插入集合中。</p>
<h3 id="定义-1">定义<a hidden class="anchor" aria-hidden="true" href="#定义-1">#</a></h3>
<p>db.collection.insertMany（）</p>
<p>此小节记录了mongoshell方法，对于相应的MongoDB驱动程序API，请改为参考您特定的MongoDB驱动程序文档。</p>
<p>3.2版中的新功能。</p>
<p>将多个文档插入集合中。</p>
<p>该insertMany()方法具有以下语法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">db.collection.insertMany(</span>
   <span class="p">[</span> <span class="err">&lt;document</span> <span class="mi">1</span><span class="err">&gt;</span> <span class="p">,</span> <span class="err">&lt;document</span> <span class="mi">2</span><span class="err">&gt;</span><span class="p">,</span> <span class="err">...</span> <span class="p">]</span><span class="err">,</span>
   <span class="p">{</span>
      <span class="err">writeConcern:</span> <span class="err">&lt;document&gt;,</span>
      <span class="err">ordered:</span> <span class="err">&lt;boolean&gt;</span>
   <span class="p">}</span>
<span class="err">)</span>
</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>document</td>
<td>document</td>
<td>要插入集合中的一组文档。</td>
</tr>
<tr>
<td>writeConcern</td>
<td>document</td>
<td>可选的。表达文档的写关注。忽略使用默认的写关注。如果在事务中运行，则不要为操作明确设置写关注。要对事务使用写关注，请参见事务和写关注。</td>
</tr>
<tr>
<td>ordered</td>
<td>布尔值</td>
<td>可选的。一个布尔值，指定mongod实例应执行有序插入还是无序插入。默认为true。</td>
</tr>
</tbody>
</table>
<p>返回值：包含以下内容的文档：</p>
<ul>
<li>一个布尔值acknowledged，就true好像该操作运行时具有写关注或false禁用了写关注</li>
<li>成功插入的文档的数组的每个_id</li>
</ul>
<h3 id="特性-2">特性<a hidden class="anchor" aria-hidden="true" href="#特性-2">#</a></h3>
<p>给定一个文档数组，insertMany() 将数组中的每个文档插入集合中。</p>
<h4 id="操作的执行">操作的执行<a hidden class="anchor" aria-hidden="true" href="#操作的执行">#</a></h4>
<p>默认情况下，按顺序插入文档。</p>
<p>如果ordered设置为false，则文档将以无序格式插入，并且可以通过重新排序mongod来提高性能。如果使用无序，则应用程序不应依赖于insertMany()插入的顺序。</p>
<p>每个组中的操作数不能超过maxWriteBatchSize数据库的值。从MongoDB 3.6开始，此值为100,000。该值显示在该isMaster.maxWriteBatchSize字段中。</p>
<p>此限制可防止出现错误消息过多的问题。如果某个组超过了此数量limit，则客户端驱动程序会将其分为计数小于或等于限制值的较小组。例如，如果maxWriteBatchSize值为100,000，则如果队列包含 200,000操作，则驱动程序将创建2个组，每个组均包含100,000操作。</p>
<p>注意:当使用高级API时，驱动程序仅将组分为较小的组。如果直接使用 db.runCommand（）（例如，在编写驱动程序时），则MongoDB在尝试执行超出限制的写批处理时会引发错误。</p>
<p>从MongoDB 3.6开始，一旦单个批次的错误报告变得太大，MongoDB就会将所有剩余的错误消息截断为空字符串。当前，一旦至少有2条错误消息且总大小大于1MB,便开始截断。</p>
<p>大小和分组机制是内部性能的详细信息，将来可能会更改。</p>
<p>ordered在分片集合上执行操作列表通常比执行unordered列表要慢， 因为对于有序列表，每个操作必须等待上一个操作完成。</p>
<h4 id="集合创建-2">集合创建<a hidden class="anchor" aria-hidden="true" href="#集合创建-2">#</a></h4>
<p>如果该集合不存在，则insertMany() 在成功写入时创建该集合。</p>
<h4 id="_id字段-2">_id字段<a hidden class="anchor" aria-hidden="true" href="#_id字段-2">#</a></h4>
<p>如果文档未指定_id字段，则mongod 添加该_id字段并为文档分配唯一ObjectId。大多数驱动程序会创建一个ObjectId并插入该_id字段，但是如果驱动程序或应用程序未创建，mongod则会创建并填充_id。</p>
<p>如果文档包含一个_id字段，则该_id值在集合中必须唯一，以避免重复的键错误。</p>
<h4 id="可解释性-1">可解释性<a hidden class="anchor" aria-hidden="true" href="#可解释性-1">#</a></h4>
<p>insertMany()与不兼容 db.collection.explain()。</p>
<p>使用insert()代替。</p>
<h4 id="错误处理-1">错误处理<a hidden class="anchor" aria-hidden="true" href="#错误处理-1">#</a></h4>
<p>插入引发BulkWriteError异常。</p>
<p>排除“写关注”错误后，有序操作将在发生错误后停止，而无序操作将继续处理队列中所有剩余的写操作。</p>
<p>写关注错误显示在该writeConcernErrors字段中，而所有其他错误显示在该writeErrors字段中。如果遇到错误，将显示成功写入操作的次数，而不是插入的_id的列表。有序操作显示遇到的单个错误，而无序操作显示数组中的每个错误。</p>
<h4 id="事务-1">事务<a hidden class="anchor" aria-hidden="true" href="#事务-1">#</a></h4>
<p>db.collection.insertMany()可以在多文档事务中使用。</p>
<p>集合必须已经存在。事务中不允许执行会导致创建新集合的插入操作。</p>
<p>如果在事务中运行，则不要为操作明确设置写关注点。要对事务使用写关注，请参见 事务和写关注。</p>
<p><strong>重要</strong>
<strong>在大多数情况下，与单文档写入相比，多文档事务会产生更高的性能成本，并且多文档事务的可用性不应替代有效的架构设计。在许多情况下， 非规范化数据模型（嵌入式文档和数组）将继续是您的数据和用例的最佳选择。也就是说，在许多情况下，对数据进行适当的建模将最大程度地减少对多文档交易的需求。</strong></p>
<p>有关其他事务使用方面的注意事项（例如运行时限制和oplog大小限制），另请参见<a href="https://docs.mongodb.com/manual/core/transactions-production-consideration/">生产注意事项</a>。</p>
<h3 id="例子-1">例子<a hidden class="anchor" aria-hidden="true" href="#例子-1">#</a></h3>
<p>以下示例将文档插入products 集合中。</p>
<h4 id="插入多个文档而不指定_id字段">插入多个文档而不指定_id字段<a hidden class="anchor" aria-hidden="true" href="#插入多个文档而不指定_id字段">#</a></h4>
<p>以下示例用于db.collection.insertMany()插入不包含该_id字段的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">try <span class="o">{</span>
   db.products.insertMany<span class="o">(</span> <span class="o">[</span>
      <span class="o">{</span> item: <span class="s2">&#34;card&#34;</span>, qty: <span class="m">15</span> <span class="o">}</span>,
      <span class="o">{</span> item: <span class="s2">&#34;envelope&#34;</span>, qty: <span class="m">20</span> <span class="o">}</span>,
      <span class="o">{</span> item: <span class="s2">&#34;stamps&#34;</span> , qty: <span class="m">30</span> <span class="o">}</span>
   <span class="o">]</span> <span class="o">)</span><span class="p">;</span>
<span class="o">}</span> catch <span class="o">(</span>e<span class="o">)</span> <span class="o">{</span>
   print <span class="o">(</span>e<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作返回以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
   <span class="nt">&#34;acknowledged&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
   <span class="nt">&#34;insertedIds&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="err">ObjectId(</span><span class="s2">&#34;562a94d381cb9f1cd6eb0e1a&#34;</span><span class="err">)</span><span class="p">,</span>
      <span class="err">ObjectId(</span><span class="s2">&#34;562a94d381cb9f1cd6eb0e1b&#34;</span><span class="err">)</span><span class="p">,</span>
      <span class="err">ObjectId(</span><span class="s2">&#34;562a94d381cb9f1cd6eb0e1c&#34;</span><span class="err">)</span>
   <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>由于文档不包含_id， mongod因此_id为每个文档创建并添加字段，并为其分配唯一ObjectId值。</p>
<p>这些ObjectId值特定于机器和运行该操作的时间。因此，您的值可能与示例中的值不同。</p>
<h4 id="插入多个指定_id字段的文档">插入多个指定_id字段的文档<a hidden class="anchor" aria-hidden="true" href="#插入多个指定_id字段的文档">#</a></h4>
<p>以下示例/操作用于insertMany()插入包含该_id字段的文档。值_id在集合中必须唯一，以避免重复的键错误。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell">try <span class="o">{</span>
   db.products.insertMany<span class="o">(</span> <span class="o">[</span>
      <span class="o">{</span> _id: 10, item: <span class="s2">&#34;large box&#34;</span>, qty: <span class="m">20</span> <span class="o">}</span>,
      <span class="o">{</span> _id: 11, item: <span class="s2">&#34;small box&#34;</span>, qty: <span class="m">55</span> <span class="o">}</span>,
      <span class="o">{</span> _id: 12, item: <span class="s2">&#34;medium box&#34;</span>, qty: <span class="m">30</span> <span class="o">}</span>
   <span class="o">]</span> <span class="o">)</span><span class="p">;</span>
<span class="o">}</span> catch <span class="o">(</span>e<span class="o">)</span> <span class="o">{</span>
   print <span class="o">(</span>e<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作返回以下文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span> <span class="nt">&#34;acknowledged&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nt">&#34;insertedIds&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span> <span class="p">]</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>为唯一索引（例如）的一部分的任何键插入重复值都会_id引发异常。以下尝试插入具有_id已经存在的值的文档：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">try <span class="o">{</span>
   db.products.insertMany<span class="o">(</span> <span class="o">[</span>
      <span class="o">{</span> _id: 13, item: <span class="s2">&#34;envelopes&#34;</span>, qty: <span class="m">60</span> <span class="o">}</span>,
      <span class="o">{</span> _id: 13, item: <span class="s2">&#34;stamps&#34;</span>, qty: <span class="m">110</span> <span class="o">}</span>,
      <span class="o">{</span> _id: 14, item: <span class="s2">&#34;packing tape&#34;</span>, qty: <span class="m">38</span> <span class="o">}</span>
   <span class="o">]</span> <span class="o">)</span><span class="p">;</span>
<span class="o">}</span> catch <span class="o">(</span>e<span class="o">)</span> <span class="o">{</span>
   print <span class="o">(</span>e<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>由于已经存在，因此将引发以下异常：_id: 13</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">BulkWriteError(</span><span class="p">{</span>
   <span class="nt">&#34;writeErrors&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="nt">&#34;index&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
         <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">11000</span><span class="p">,</span>
         <span class="nt">&#34;errmsg&#34;</span> <span class="p">:</span> <span class="s2">&#34;E11000 duplicate key error collection: inventory.products index: _id_ dup key: { : 13.0 }&#34;</span><span class="p">,</span>
         <span class="nt">&#34;op&#34;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
            <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;stamps&#34;</span><span class="p">,</span>
            <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">110</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&#34;writeConcernErrors&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
   <span class="nt">&#34;nInserted&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&#34;nUpserted&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&#34;nMatched&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&#34;nModified&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&#34;nRemoved&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&#34;upserted&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></td></tr></table>
</div>
</div><p>请注意，第一个_id: 13的文档将成功插入，但第二个插入将失败。这也将阻止插入队列中剩余的其他文档。</p>
<p>使用ordered为false，插入操作将继续处理所有剩余文档。</p>
<h4 id="无序插入">无序插入<a hidden class="anchor" aria-hidden="true" href="#无序插入">#</a></h4>
<p>以下尝试插入带有和_id字段的 多个文档。文档数组包含两个具有重复字段的文档。ordered为false</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">try <span class="o">{</span>
   db.products.insertMany<span class="o">(</span> <span class="o">[</span>
      <span class="o">{</span> _id: 10, item: <span class="s2">&#34;large box&#34;</span>, qty: <span class="m">20</span> <span class="o">}</span>,
      <span class="o">{</span> _id: 11, item: <span class="s2">&#34;small box&#34;</span>, qty: <span class="m">55</span> <span class="o">}</span>,
      <span class="o">{</span> _id: 11, item: <span class="s2">&#34;medium box&#34;</span>, qty: <span class="m">30</span> <span class="o">}</span>,
      <span class="o">{</span> _id: 12, item: <span class="s2">&#34;envelope&#34;</span>, qty: 100<span class="o">}</span>,
      <span class="o">{</span> _id: 13, item: <span class="s2">&#34;stamps&#34;</span>, qty: <span class="m">125</span> <span class="o">}</span>,
      <span class="o">{</span> _id: 13, item: <span class="s2">&#34;tape&#34;</span>, qty: 20<span class="o">}</span>,
      <span class="o">{</span> _id: 14, item: <span class="s2">&#34;bubble wrap&#34;</span>, qty: 30<span class="o">}</span>
   <span class="o">]</span>, <span class="o">{</span> ordered: <span class="nb">false</span> <span class="o">}</span> <span class="o">)</span><span class="p">;</span>
<span class="o">}</span> catch <span class="o">(</span>e<span class="o">)</span> <span class="o">{</span>
   print <span class="o">(</span>e<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>该操作引发以下异常：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">BulkWriteError(</span><span class="p">{</span>
   <span class="nt">&#34;writeErrors&#34;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="nt">&#34;index&#34;</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
         <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">11000</span><span class="p">,</span>
         <span class="nt">&#34;errmsg&#34;</span> <span class="p">:</span> <span class="s2">&#34;E11000 duplicate key error collection: inventory.products index: _id_ dup key: { : 11.0 }&#34;</span><span class="p">,</span>
         <span class="nt">&#34;op&#34;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
            <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;medium box&#34;</span><span class="p">,</span>
            <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">30</span>
         <span class="p">}</span>
      <span class="p">},</span>
      <span class="p">{</span>
         <span class="nt">&#34;index&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
         <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">11000</span><span class="p">,</span>
         <span class="nt">&#34;errmsg&#34;</span> <span class="p">:</span> <span class="s2">&#34;E11000 duplicate key error collection: inventory.products index: _id_ dup key: { : 13.0 }&#34;</span><span class="p">,</span>
         <span class="nt">&#34;op&#34;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;_id&#34;</span> <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
            <span class="nt">&#34;item&#34;</span> <span class="p">:</span> <span class="s2">&#34;tape&#34;</span><span class="p">,</span>
            <span class="nt">&#34;qty&#34;</span> <span class="p">:</span> <span class="mi">20</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&#34;writeConcernErrors&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
   <span class="nt">&#34;nInserted&#34;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
   <span class="nt">&#34;nUpserted&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&#34;nMatched&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&#34;nModified&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&#34;nRemoved&#34;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
   <span class="nt">&#34;upserted&#34;</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></td></tr></table>
</div>
</div><p>尽管由于重复值而有且文档插入失败，但表明剩余的5个文档已插入。</p>
<h4 id="使用写关注">使用写关注<a hidden class="anchor" aria-hidden="true" href="#使用写关注">#</a></h4>
<p>给定一个三成员副本集，以下操作指定 wof majority和wtimeoutof 100：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">try</span> <span class="p">{</span>
   <span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nf">insertMany</span><span class="p">(</span>
      <span class="p">[</span>
         <span class="p">{</span> <span class="nx">_id</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">item</span><span class="p">:</span> <span class="s">&#34;large box&#34;</span><span class="p">,</span> <span class="nx">qty</span><span class="p">:</span> <span class="mi">20</span> <span class="p">},</span>
         <span class="p">{</span> <span class="nx">_id</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="nx">item</span><span class="p">:</span> <span class="s">&#34;small box&#34;</span><span class="p">,</span> <span class="nx">qty</span><span class="p">:</span> <span class="mi">55</span> <span class="p">},</span>
         <span class="p">{</span> <span class="nx">_id</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="nx">item</span><span class="p">:</span> <span class="s">&#34;medium box&#34;</span><span class="p">,</span> <span class="nx">qty</span><span class="p">:</span> <span class="mi">30</span> <span class="p">}</span>
      <span class="p">],</span>
      <span class="p">{</span> <span class="nx">w</span><span class="p">:</span> <span class="s">&#34;majority&#34;</span><span class="p">,</span> <span class="nx">wtimeout</span><span class="p">:</span> <span class="mi">100</span> <span class="p">}</span>
   <span class="p">);</span>
<span class="p">}</span> <span class="nf">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
   <span class="nf">print</span> <span class="p">(</span><span class="nx">e</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果主服务器和至少一个辅助服务器在100毫秒内确认每个写操作，则返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;acknowledged&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nt">&#34;insertedIds&#34;</span> <span class="p">:</span> <span class="p">[</span>
     <span class="err">ObjectId(</span><span class="s2">&#34;562a94d381cb9f1cd6eb0e1a&#34;</span><span class="err">)</span><span class="p">,</span>
     <span class="err">ObjectId(</span><span class="s2">&#34;562a94d381cb9f1cd6eb0e1b&#34;</span><span class="err">)</span><span class="p">,</span>
     <span class="err">ObjectId(</span><span class="s2">&#34;562a94d381cb9f1cd6eb0e1c&#34;</span><span class="err">)</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果副本集中所有必需节点确认写操作所需的总时间大于wtimeout，则在wtimeout时间段后将显示以下writeConcernError内容。</p>
<p>该操作返回：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="err">WriteConcernError(</span><span class="p">{</span>
   <span class="nt">&#34;code&#34;</span> <span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
   <span class="nt">&#34;errInfo&#34;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;wtimeout&#34;</span> <span class="p">:</span> <span class="kc">true</span>
   <span class="p">},</span>
   <span class="nt">&#34;errmsg&#34;</span> <span class="p">:</span> <span class="s2">&#34;waiting for replication timed out&#34;</span>
<span class="p">}</span><span class="err">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="其他插入方法">其他插入方法<a hidden class="anchor" aria-hidden="true" href="#其他插入方法">#</a></h2>
<p>以下方法还可以将新文档添加到集合中：</p>
<p>db.collection.update()与该选项一起使用时:<code>upsert: true</code>
db.collection.updateOne()与该选项一起使用时:<code>upsert: true</code>
db.collection.updateMany()与该选项一起使用时:<code>upsert: true</code>
db.collection.findAndModify()与该选项一起使用时:<code>upsert: true</code>
db.collection.findOneAndUpdate()与该选项一起使用时 :<code>upsert: true</code>
db.collection.findOneAndReplace()与该选项一起使用时 :<code>upsert: true</code>
db.collection.save()。
db.collection.bulkWrite()。</p>
<p>有关更多方法和示例，请参见各个方法的参考页。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/mongodb/">MongoDB</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
