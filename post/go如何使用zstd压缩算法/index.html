<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go如何使用zstd压缩算法 | Forz Blog</title>
<meta name="keywords" content="Go, zstd" />
<meta name="description" content="zstd Zstandard是一种实时压缩算法，提供高压缩率。它提供了非常广泛的压缩/速度权衡，同时由非常快速的解码器提供支持。实现了高性能压缩算法">
<meta name="author" content="">
<link rel="canonical" href="/post/go%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8zstd%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Go如何使用zstd压缩算法" />
<meta property="og:description" content="zstd Zstandard是一种实时压缩算法，提供高压缩率。它提供了非常广泛的压缩/速度权衡，同时由非常快速的解码器提供支持。实现了高性能压缩算法" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/go%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8zstd%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-06-06T18:20:33&#43;00:00" />
<meta property="article:modified_time" content="2021-06-06T18:20:33&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go如何使用zstd压缩算法"/>
<meta name="twitter:description" content="zstd Zstandard是一种实时压缩算法，提供高压缩率。它提供了非常广泛的压缩/速度权衡，同时由非常快速的解码器提供支持。实现了高性能压缩算法"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Go如何使用zstd压缩算法",
      "item": "/post/go%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8zstd%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go如何使用zstd压缩算法",
  "name": "Go如何使用zstd压缩算法",
  "description": "zstd Zstandard是一种实时压缩算法，提供高压缩率。它提供了非常广泛的压缩/速度权衡，同时由非常快速的解码器提供支持。实现了高性能压缩算法",
  "keywords": [
    "Go", "zstd"
  ],
  "articleBody": "zstd Zstandard是一种实时压缩算法，提供高压缩率。它提供了非常广泛的压缩/速度权衡，同时由非常快速的解码器提供支持。实现了高性能压缩算法。现在专注于速度。\n该包提供压缩并减压Zstandard内容。\n这个包是纯 Go 的，没有使用“不安全”。\n该zstd软件包是使用 Go 标准许可证作为开源软件提供的。\n目前，该软件包针对 64 位处理器进行了大量优化，在 32 位处理器上会显着降低。\n安装 使用go get -u github.com/klauspost/compress. 该包位于github.com/klauspost/compress/zstd.\n压缩 地位： 稳定 - 可能总是存在细微的错误，已经测试了各种各样的内容，并且该库被多个项目积极使用。该库正在针对所有更新进行模糊测试。\n可能仍然存在可能导致边缘情况的数据类型/大小/设置的特定组合，因此一如既往，建议进行测试。\n目前，已经实现了高速（最快）和中速（默认）压缩器。\n “Fastest”压缩率大致相当于 zstd 级别 1。 “Default”压缩率大致相当于 zstd 级别 3（默认）。 “Better”的压缩率大致相当于 zstd 7 级。 “Best”压缩率大致相当于 zstd 级别 11。  在速度方面，它通常是 stdlib deflate/gzip 在最快模式下的 2 倍。与 stdlib 相比，压缩率约为 3 级，但通常快 3 倍。\n用法 编码器可用于通过io.WriteCloser编码器支持的接口压缩流 或通过EncodeAll函数作为多个独立任务。鼓励较小的编码使用 EncodeAll 函数。使用NewWriter来创建可用于两个新的实例。\n要使用默认选项创建编写器，请执行以下操作：\n1 2 3 4 5 6 7 8 9 10 11 12 13  // Compress input to output. func Compress(in io.Reader, out io.Writer) error { enc, err := zstd.NewWriter(out) if err != nil { return err } _, err = io.Copy(enc, in) if err != nil { enc.Close() return err } return enc.Close() }   现在您可以通过将数据写入enc. 输出将在Close()调用时完成写入。即使你的编码失败，你仍然应该调用Close()释放任何可能被阻塞的资源。\n以上适用于大编码。但是，只要有可能，请尝试重用编写器。\n要重用编码器，您可以使用该Reset(io.Writer)函数更改为另一个输出。这将允许编码器重用所有资源并避免浪费分配。\n当前流编码具有“轻”并发性，这意味着最多 2 个 goroutine 可以处理流的一部分。这与WithEncoderConcurrency(n)无关，但将来可能会改变。因此，如果您想限制未来更新的并发性，请指定您想要的并发性。\n您可以使用WithEncoderLevel()选项指定所需的压缩级别。目前只能指定预定义的压缩设置。\n未来兼容性保证 这将是一个不断发展的项目。使用此包时，重要的是要注意压缩效率和速度都可能会发生变化。\n目标是将默认效率保持在默认 zstd（级别 3）。但是，永远不应假定编码保持不变，并且不应使用压缩输出的哈希值进行相似性检查。\n可以假设编码器从完全相同的代码版本产生相同的输出。但是，将来可能会打破这种模式，尽管如果没有明确的选项，它们将无法启用。\n该编码器并非旨在（并且可能永远不会）输出与参考编码器完全相同的比特流。\n另请注意，cgo 解压缩器当前不报告无效输入的所有错误， 省略错误检查，忽略校验 和，并且似乎忽略连接流，即使它是规范的一部分。\n块 为了压缩小块，返回的编码器有一个名为EncodeAll(src, dst []byte) []byte的函数。\nEncodeAll将对 src 中的所有输入进行编码并将其附加到 dst。这个函数可以被并发调用，但每次调用只会在一个 goroutine 上运行。\n编码块可以连接在一起，结果将是组合的输入流。使用 EncodeAll 压缩的数据可以使用解码器解码，使用流或DecodeAll.\n特别是在编码块时，您应该特别注意重复使用编码器。这将有效地使其在预热期后无需分配即可运行。为了让它在没有分配的情况下完全运行，为所有内容提供一个带有空间的目标缓冲区。\n1 2 3 4 5 6 7 8 9 10 11  import \"github.com/klauspost/compress/zstd\" // Create a writer that caches compressors. // For this operation type we supply a nil Reader. var encoder, _ = zstd.NewWriter(nil) // Compress a buffer. // If you have a destination buffer, the allocation in the call can also be eliminated. func Compress(src []byte) []byte { return encoder.EncodeAll(src, make([]byte, 0, len(src))) }   您可以在创建编写器时使用WithEncoderConcurrency(n)选项控制并发编码的最大数量。\n同时对流和单个块使用编码器是安全的。\n表现 我收集了一些速度示例，以将速度和压缩与其他压缩器进行比较。\n file 是输入文件。 out是使用的压缩机。zskp是这个包吗 zstd是 Datadog cgo 库。gzstd/gzkp是 gzip 标准和这个库。 level是使用的压缩级别。因为zskp级别 1 是“最快”，级别 2 是“默认”；3 是“更好”，4 是“最好”。 insize/outsize是输入/输出大小。 millis 是用于压缩的毫秒数。 mb/s 是每秒兆字节（2^20 字节）。  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95  Silesia Corpus: http://sun.aei.polsl.pl/~sdeor/corpus/silesia.zip This package: file out level insize outsize millis mb/s silesia.tar zskp 1 211947520 73101992 643 313.87 silesia.tar zskp 2 211947520 67504318 969 208.38 silesia.tar zskp 3 211947520 64595893 2007 100.68 silesia.tar zskp 4 211947520 60995370 7691 26.28 cgo zstd: silesia.tar zstd 1 211947520 73605392 543 371.56 silesia.tar zstd 3 211947520 66793289 864 233.68 silesia.tar zstd 6 211947520 62916450 1913 105.66 silesia.tar zstd 9 211947520 60212393 5063 39.92 gzip, stdlib/this package: silesia.tar gzstd 1 211947520 80007735 1654 122.21 silesia.tar gzkp 1 211947520 80369488 1168 173.06 GOB stream of binary data. Highly compressible. https://files.klauspost.com/compress/gob-stream.7z file out level insize outsize millis mb/s gob-stream zskp 1 1911399616 235022249 3088 590.30 gob-stream zskp 2 1911399616 205669791 3786 481.34 gob-stream zskp 3 1911399616 175034659 9636 189.17 gob-stream zskp 4 1911399616 167273881 29337 62.13 gob-stream zstd 1 1911399616 249810424 2637 691.26 gob-stream zstd 3 1911399616 208192146 3490 522.31 gob-stream zstd 6 1911399616 193632038 6687 272.56 gob-stream zstd 9 1911399616 177620386 16175 112.70 gob-stream gzstd 1 1911399616 357382641 10251 177.82 gob-stream gzkp 1 1911399616 362156523 5695 320.08 The test data for the Large Text Compression Benchmark is the first 10^9 bytes of the English Wikipedia dump on Mar. 3, 2006. http://mattmahoney.net/dc/textdata.html file out level insize outsize millis mb/s enwik9 zskp 1 1000000000 343848582 3609 264.18 enwik9 zskp 2 1000000000 317276632 5746 165.97 enwik9 zskp 3 1000000000 292243069 12162 78.41 enwik9 zskp 4 1000000000 275241169 36430 26.18 enwik9 zstd 1 1000000000 358072021 3110 306.65 enwik9 zstd 3 1000000000 313734672 4784 199.35 enwik9 zstd 6 1000000000 295138875 10290 92.68 enwik9 zstd 9 1000000000 278348700 28549 33.40 enwik9 gzstd 1 1000000000 382578136 9604 99.30 enwik9 gzkp 1 1000000000 383825945 6544 145.73 Highly compressible JSON file. https://files.klauspost.com/compress/github-june-2days-2019.json.zst file out level insize outsize millis mb/s github-june-2days-2019.json zskp 1 6273951764 699045015 10620 563.40 github-june-2days-2019.json zskp 2 6273951764 617881763 11687 511.96 github-june-2days-2019.json zskp 3 6273951764 524340691 34043 175.75 github-june-2days-2019.json zskp 4 6273951764 503314661 93811 63.78 github-june-2days-2019.json zstd 1 6273951764 766284037 8450 708.00 github-june-2days-2019.json zstd 3 6273951764 661889476 10927 547.57 github-june-2days-2019.json zstd 6 6273951764 642756859 22996 260.18 github-june-2days-2019.json zstd 9 6273951764 601974523 52413 114.16 github-june-2days-2019.json gzstd 1 6273951764 1164400847 29948 199.79 github-june-2days-2019.json gzkp 1 6273951764 1128755542 19236 311.03 VM Image, Linux mint with a few installed applications: https://files.klauspost.com/compress/rawstudio-mint14.7z file out level insize outsize millis mb/s rawstudio-mint14.tar zskp 1 8558382592 3667489370 20210 403.84 rawstudio-mint14.tar zskp 2 8558382592 3364592300 31873 256.07 rawstudio-mint14.tar zskp 3 8558382592 3158085214 77675 105.08 rawstudio-mint14.tar zskp 4 8558382592 3020370044 404956 20.16 rawstudio-mint14.tar zstd 1 8558382592 3609250104 17136 476.27 rawstudio-mint14.tar zstd 3 8558382592 3341679997 29262 278.92 rawstudio-mint14.tar zstd 6 8558382592 3235846406 77904 104.77 rawstudio-mint14.tar zstd 9 8558382592 3160778861 140946 57.91 rawstudio-mint14.tar gzstd 1 8558382592 3926257486 57722 141.40 rawstudio-mint14.tar gzkp 1 8558382592 3970463184 41749 195.49 CSV data: https://files.klauspost.com/compress/nyc-taxi-data-10M.csv.zst file out level insize outsize millis mb/s nyc-taxi-data-10M.csv zskp 1 3325605752 641339945 8925 355.35 nyc-taxi-data-10M.csv zskp 2 3325605752 591748091 11268 281.44 nyc-taxi-data-10M.csv zskp 3 3325605752 530289687 25239 125.66 nyc-taxi-data-10M.csv zskp 4 3325605752 490907191 65939 48.10 nyc-taxi-data-10M.csv zstd 1 3325605752 687399637 8233 385.18 nyc-taxi-data-10M.csv zstd 3 3325605752 598514411 10065 315.07 nyc-taxi-data-10M.csv zstd 6 3325605752 570522953 20038 158.27 nyc-taxi-data-10M.csv zstd 9 3325605752 517554797 64565 49.12 nyc-taxi-data-10M.csv gzstd 1 3325605752 928656485 23876 132.83 nyc-taxi-data-10M.csv gzkp 1 3325605752 924718719 16388 193.53   解压器 状态：稳定 - 可能仍然存在细微的错误，但已经测试了各种各样的内容。\n该库正在不断进行模糊测试，由fuzzit.dev 友情提供。模糊测试的主要目的是确保解码器不会崩溃，或在提供任何输入的情况下运行超过其限制。\n用法 该包被设计用于两种主要用途，大数据流和较小的内存缓冲区。这些包有两个主要用途。它们都可以通过创建一个Decoder.\n对于流媒体使用，一个简单的设置可能如下所示：\n1 2 3 4 5 6 7 8 9 10 11 12 13  import \"github.com/klauspost/compress/zstd\" func Decompress(in io.Reader, out io.Writer) error { d, err := zstd.NewReader(in) if err != nil { return err } defer d.Close() // Copy content...  _, err = io.Copy(out, d) return err }   当您不再需要 Reader 来停止运行 goroutine 时，使用“关闭”功能很重要。请参阅下面的“无分配操作”。\n对于解码缓冲区，它可能如下所示：\n1 2 3 4 5 6 7 8 9 10 11  import \"github.com/klauspost/compress/zstd\" // Create a reader that caches decompressors. // For this operation type we supply a nil Reader. var decoder, _ = zstd.NewReader(nil) // Decompress a buffer. We don't supply a destination buffer, // so it will be allocated by the decoder. func Decompress(src []byte) ([]byte, error) { return decoder.DecodeAll(src, nil) }   这两种情况都应该提供所需的功能。解码器可用于多个缓冲区的并发解压缩。它只允许运行一定数量的并发操作。要自己调整，请在创建解码器时使用WithDecoderConcurrency(n)选项。\n字典 用字典压缩的数据可以解压。\n字典单独添加到解码器。字典由zstd --train命令生成并包含解码器的初始状态。要添加字典，请使用WithDecoderDicts(dicts ...[]byte)带有字典数据的选项。可以一次添加多个词典。\n字典将自动用于指定它们的数据。重用的解码器仍将包含已注册的词典。\n注册多个同一个ID的词典时，会使用最后一个。\n压缩数据时可以使用字典。\n要启用字典，请使用WithEncoderDict(dict []byte). 这里只使用一本字典，即使它没有改进压缩，它也可能会被使用。\n必须使用使用的字典来解压缩内容。\n对于任何真正的收益，字典都应该使用类似的数据构建。如果使用不合适的字典，输出可能比不使用字典稍大。使用zstd 命令行工具从示例数据构建字典。有关信息，请参阅zstd 字典信息。\n目前，使用字典压缩内容存在固定的启动性能损失。随着时间的推移，这可能会得到改善。请注意在实施时测试性能。\n无分配操作 解码器设计为在预热后无需分配即可运行。\n这意味着您应该存储解码器以获得最佳性能。要重新使用流解码器，请使用Reset(r io.Reader) error切换到另一个流。即使前一个流失败，解码器也可以安全地重新使用。\n要释放资源，您必须在解码器上调用Close()函数。在此之后它不能再被重用，但所有正在运行的 goroutine 将被停止。因此，如果您不再需要阅读器，则必须使用它。\n为了解压缩较小的缓冲区，可以使用单个解码器。解码缓冲区时，您可以提供长度为 0 和预期容量的目标切片。在这种情况下，不应进行不需要的分配。\n并发 缓冲区解码器在同一个 goroutine 上执行所有操作，并且不同时执行任何操作。然而，它可以同时解码多个缓冲区。使用WithDecoderConcurrency(n)来限制。\n流解码器操作:\n 一个 goroutine 读取输入并将输入拆分到多个块解码器。 许多解码器将解码块。 goroutine 协调这些块并将历史从一个块发送到下一个。  如此有效，这也意味着解码器将“提前读取”并准备数据以始终可用于输出。\n由于“块”非常依赖于先前块流解码的输出，因此只有有限的并发性。\n在实践中，这意味着并发通常仅限于有效利用大约 2 个内核。\n基准 这些是与datadog cgo 库相比的一些性能示例。\n前两个是流式解码，最后一个是较小的输入。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  BenchmarkDecoderSilesia-8 3 385000067 ns/op 550.51 MB/s 5498 B/op 8 allocs/op BenchmarkDecoderSilesiaCgo-8 6 197666567 ns/op 1072.25 MB/s 270672 B/op 8 allocs/op BenchmarkDecoderEnwik9-8 1 2027001600 ns/op 493.34 MB/s 10496 B/op 18 allocs/op BenchmarkDecoderEnwik9Cgo-8 2 979499200 ns/op 1020.93 MB/s 270672 B/op 8 allocs/op Concurrent performance: BenchmarkDecoder_DecodeAllParallel/kppkn.gtb.zst-16 28915 42469 ns/op 4340.07 MB/s 114 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/geo.protodata.zst-16 116505 9965 ns/op 11900.16 MB/s 16 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/plrabn12.txt.zst-16 8952 134272 ns/op 3588.70 MB/s 915 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/lcet10.txt.zst-16 11820 102538 ns/op 4161.90 MB/s 594 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/asyoulik.txt.zst-16 34782 34184 ns/op 3661.88 MB/s 60 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/alice29.txt.zst-16 27712 43447 ns/op 3500.58 MB/s 99 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/html_x_4.zst-16 62826 18750 ns/op 21845.10 MB/s 104 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/paper-100k.pdf.zst-16 631545 1794 ns/op 57078.74 MB/s 2 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/fireworks.jpeg.zst-16 1690140 712 ns/op 172938.13 MB/s 1 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/urls.10K.zst-16 10432 113593 ns/op 6180.73 MB/s 1143 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/html.zst-16 113206 10671 ns/op 9596.27 MB/s 15 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallel/comp-data.bin.zst-16 1530615 779 ns/op 5229.49 MB/s 0 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/kppkn.gtb.zst-16 65217 16192 ns/op 11383.34 MB/s 46 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/geo.protodata.zst-16 292671 4039 ns/op 29363.19 MB/s 6 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/plrabn12.txt.zst-16 26314 46021 ns/op 10470.43 MB/s 293 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/lcet10.txt.zst-16 33897 34900 ns/op 12227.96 MB/s 205 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/asyoulik.txt.zst-16 104348 11433 ns/op 10949.01 MB/s 20 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/alice29.txt.zst-16 75949 15510 ns/op 9805.60 MB/s 32 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/html_x_4.zst-16 173910 6756 ns/op 60624.29 MB/s 37 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/paper-100k.pdf.zst-16 923076 1339 ns/op 76474.87 MB/s 1 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/fireworks.jpeg.zst-16 922920 1351 ns/op 91102.57 MB/s 2 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/urls.10K.zst-16 27649 43618 ns/op 16096.19 MB/s 407 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/html.zst-16 279073 4160 ns/op 24614.18 MB/s 6 B/op 0 allocs/op BenchmarkDecoder_DecodeAllParallelCgo/comp-data.bin.zst-16 749938 1579 ns/op 2581.71 MB/s 0 B/op 0 allocs/op   这反映了 2020 年 5 月前后的表现，但这可能已经过时。\nZIP 文件中的 Zstd 可以使用 zstandard 来压缩 zip 档案中的单个文件。虽然这没有得到广泛支持，但它对内部文件很有用。\n要支持这些文件的压缩和解压，您必须注册一个压缩器和解压器。\n强烈建议在单独的 zip Reader/Writer 上注册（解）压缩器，而不是使用全局注册功能。造成这种情况的主要原因是来自不同包的 2 个注册会导致恐慌。\n最好只有一个压缩器和解压缩器，因为它们可以同时用于多个 zip 文件，并且使用单个实例将允许重用某些资源。\n请参阅此示例了解如何压缩和解压缩 zip 档案中的文件。\n转载 zstd\n",
  "wordCount" : "4333",
  "inLanguage": "zh-cn",
  "datePublished": "2021-06-06T18:20:33Z",
  "dateModified": "2021-06-06T18:20:33Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/go%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8zstd%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Go如何使用zstd压缩算法
    </h1>
    <div class="post-meta">June 6, 2021
</div>
  </header> 
  <div class="post-content"><h2 id="zstd">zstd<a hidden class="anchor" aria-hidden="true" href="#zstd">#</a></h2>
<p>Zstandard是一种实时压缩算法，提供高压缩率。它提供了非常广泛的压缩/速度权衡，同时由非常快速的解码器提供支持。实现了高性能压缩算法。现在专注于速度。</p>
<p>该包提供压缩并减压Zstandard内容。</p>
<p>这个包是纯 Go 的，没有使用“不安全”。</p>
<p>该zstd软件包是使用 Go 标准许可证作为开源软件提供的。</p>
<p>目前，该软件包针对 64 位处理器进行了大量优化，在 32 位处理器上会显着降低。</p>
<h2 id="安装">安装<a hidden class="anchor" aria-hidden="true" href="#安装">#</a></h2>
<p>使用<code>go get -u github.com/klauspost/compress</code>. 该包位于<code>github.com/klauspost/compress/zstd</code>.</p>
<h2 id="压缩">压缩<a hidden class="anchor" aria-hidden="true" href="#压缩">#</a></h2>
<p>地位：
稳定 - 可能总是存在细微的错误，已经测试了各种各样的内容，并且该库被多个项目积极使用。该库正在针对所有更新进行模糊测试。</p>
<p>可能仍然存在可能导致边缘情况的数据类型/大小/设置的特定组合，因此一如既往，建议进行测试。</p>
<p>目前，已经实现了高速（最快）和中速（默认）压缩器。</p>
<ul>
<li>“Fastest”压缩率大致相当于 zstd 级别 1。</li>
<li>“Default”压缩率大致相当于 zstd 级别 3（默认）。</li>
<li>“Better”的压缩率大致相当于 zstd 7 级。</li>
<li>“Best”压缩率大致相当于 zstd 级别 11。</li>
</ul>
<p>在速度方面，它通常是 stdlib deflate/gzip 在最快模式下的 2 倍。与 stdlib 相比，压缩率约为 3 级，但通常快 3 倍。</p>
<h2 id="用法">用法<a hidden class="anchor" aria-hidden="true" href="#用法">#</a></h2>
<p>编码器可用于通过io.WriteCloser编码器支持的接口压缩流 或通过EncodeAll函数作为多个独立任务。鼓励较小的编码使用 EncodeAll 函数。使用NewWriter来创建可用于两个新的实例。</p>
<p>要使用默认选项创建编写器，请执行以下操作：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Compress input to output.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Compress</span><span class="p">(</span><span class="nx">in</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">out</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">enc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">zstd</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="nx">out</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">enc</span><span class="p">,</span> <span class="nx">in</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">enc</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">enc</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>现在您可以通过将数据写入enc. 输出将在Close()调用时完成写入。即使你的编码失败，你仍然应该调用Close()释放任何可能被阻塞的资源。</p>
<p>以上适用于大编码。但是，只要有可能，请尝试重用编写器。</p>
<p>要重用编码器，您可以使用该<code>Reset(io.Writer)</code>函数更改为另一个输出。这将允许编码器重用所有资源并避免浪费分配。</p>
<p>当前流编码具有“轻”并发性，这意味着最多 2 个 goroutine 可以处理流的一部分。这与<code>WithEncoderConcurrency(n)</code>无关，但将来可能会改变。因此，如果您想限制未来更新的并发性，请指定您想要的并发性。</p>
<p>您可以使用<code>WithEncoderLevel()</code>选项指定所需的压缩级别。目前只能指定预定义的压缩设置。</p>
<h2 id="未来兼容性保证">未来兼容性保证<a hidden class="anchor" aria-hidden="true" href="#未来兼容性保证">#</a></h2>
<p>这将是一个不断发展的项目。使用此包时，重要的是要注意压缩效率和速度都可能会发生变化。</p>
<p>目标是将默认效率保持在默认 zstd（级别 3）。但是，永远不应假定编码保持不变，并且不应使用压缩输出的哈希值进行相似性检查。</p>
<p>可以假设编码器从完全相同的代码版本产生相同的输出。但是，将来可能会打破这种模式，尽管如果没有明确的选项，它们将无法启用。</p>
<p>该编码器并非旨在（并且可能永远不会）输出与参考编码器完全相同的比特流。</p>
<p>另请注意，cgo 解压缩器当前不报告无效输入的所有错误， 省略错误检查，忽略校验 和，并且似乎忽略连接流，即使它是规范的一部分。</p>
<h2 id="块">块<a hidden class="anchor" aria-hidden="true" href="#块">#</a></h2>
<p>为了压缩小块，返回的编码器有一个名为<code>EncodeAll(src, dst []byte) []byte</code>的函数。</p>
<p><code>EncodeAll</code>将对 src 中的所有输入进行编码并将其附加到 dst。这个函数可以被并发调用，但每次调用只会在一个 goroutine 上运行。</p>
<p>编码块可以连接在一起，结果将是组合的输入流。使用 EncodeAll 压缩的数据可以使用解码器解码，使用流或DecodeAll.</p>
<p>特别是在编码块时，您应该特别注意重复使用编码器。这将有效地使其在预热期后无需分配即可运行。为了让它在没有分配的情况下完全运行，为所有内容提供一个带有空间的目标缓冲区。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;github.com/klauspost/compress/zstd&#34;</span>

<span class="c1">// Create a writer that caches compressors.
</span><span class="c1">// For this operation type we supply a nil Reader.
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">encoder</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">zstd</span><span class="p">.</span><span class="nf">NewWriter</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>

<span class="c1">// Compress a buffer.
</span><span class="c1">// If you have a destination buffer, the allocation in the call can also be eliminated.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Compress</span><span class="p">(</span><span class="nx">src</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">encoder</span><span class="p">.</span><span class="nf">EncodeAll</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">src</span><span class="p">)))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>您可以在创建编写器时使用<code>WithEncoderConcurrency(n)</code>选项控制并发编码的最大数量。</p>
<p>同时对流和单个块使用编码器是安全的。</p>
<h1 id="表现">表现<a hidden class="anchor" aria-hidden="true" href="#表现">#</a></h1>
<p>我收集了一些速度示例，以将速度和压缩与其他压缩器进行比较。</p>
<ul>
<li>file 是输入文件。</li>
<li>out是使用的压缩机。zskp是这个包吗 zstd是 Datadog cgo 库。gzstd/gzkp是 gzip 标准和这个库。</li>
<li>level是使用的压缩级别。因为zskp级别 1 是“最快”，级别 2 是“默认”；3 是“更好”，4 是“最好”。</li>
<li>insize/outsize是输入/输出大小。</li>
<li>millis 是用于压缩的毫秒数。</li>
<li>mb/s 是每秒兆字节（2^20 字节）。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">Silesia</span> <span class="n">Corpus</span><span class="o">:</span>
<span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="n">sun.aei.polsl.pl</span><span class="o">/~</span><span class="n">sdeor</span><span class="o">/</span><span class="n">corpus</span><span class="o">/</span><span class="n">silesia.zip</span><span class="o">&gt;</span>

<span class="n">This</span> <span class="n">package</span><span class="o">:</span>
<span class="n">file</span>    <span class="n">out</span>     <span class="n">level</span>   <span class="n">insize</span>      <span class="n">outsize</span>     <span class="n">millis</span>  <span class="n">mb</span><span class="o">/</span><span class="n">s</span>
<span class="n">silesia.tar</span> <span class="n">zskp</span>    <span class="m">1</span>   <span class="m">211947520</span>   <span class="m">73101992</span>    <span class="m">643</span>     <span class="m">313.87</span>
<span class="n">silesia.tar</span> <span class="n">zskp</span>    <span class="m">2</span>   <span class="m">211947520</span>   <span class="m">67504318</span>    <span class="m">969</span>     <span class="m">208.38</span>
<span class="n">silesia.tar</span> <span class="n">zskp</span>    <span class="m">3</span>   <span class="m">211947520</span>   <span class="m">64595893</span>    <span class="m">2007</span>    <span class="m">100.68</span>
<span class="n">silesia.tar</span> <span class="n">zskp</span>    <span class="m">4</span>   <span class="m">211947520</span>   <span class="m">60995370</span>    <span class="m">7691</span>    <span class="m">26.28</span>

<span class="n">cgo</span> <span class="n">zstd</span><span class="o">:</span>
<span class="n">silesia.tar</span> <span class="n">zstd</span>    <span class="m">1</span>   <span class="m">211947520</span>   <span class="m">73605392</span>    <span class="m">543</span>     <span class="m">371.56</span>
<span class="n">silesia.tar</span> <span class="n">zstd</span>    <span class="m">3</span>   <span class="m">211947520</span>   <span class="m">66793289</span>    <span class="m">864</span>     <span class="m">233.68</span>
<span class="n">silesia.tar</span> <span class="n">zstd</span>    <span class="m">6</span>   <span class="m">211947520</span>   <span class="m">62916450</span>    <span class="m">1913</span>    <span class="m">105.66</span>
<span class="n">silesia.tar</span> <span class="n">zstd</span>    <span class="m">9</span>   <span class="m">211947520</span>   <span class="m">60212393</span>    <span class="m">5063</span>    <span class="m">39.92</span>

<span class="n">gzip</span><span class="p">,</span> <span class="n">stdlib</span><span class="o">/</span><span class="n">this</span> <span class="n">package</span><span class="o">:</span>
<span class="n">silesia.tar</span> <span class="n">gzstd</span>   <span class="m">1</span>   <span class="m">211947520</span>   <span class="m">80007735</span>    <span class="m">1654</span>    <span class="m">122.21</span>
<span class="n">silesia.tar</span> <span class="n">gzkp</span>    <span class="m">1</span>   <span class="m">211947520</span>   <span class="m">80369488</span>    <span class="m">1168</span>    <span class="m">173.06</span>

<span class="n">GOB</span> <span class="n">stream</span> <span class="n">of</span> <span class="n">binary</span> <span class="n">data.</span> <span class="n">Highly</span> <span class="n">compressible.</span>
<span class="o">&lt;</span><span class="n">https</span><span class="o">://</span><span class="n">files.klauspost.com</span><span class="o">/</span><span class="n">compress</span><span class="o">/</span><span class="n">gob</span><span class="o">-</span><span class="n">stream.7z</span><span class="o">&gt;</span>

<span class="n">file</span>        <span class="n">out</span>     <span class="n">level</span>   <span class="n">insize</span>  <span class="n">outsize</span>     <span class="n">millis</span>  <span class="n">mb</span><span class="o">/</span><span class="n">s</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">zskp</span>    <span class="m">1</span>   <span class="m">1911399616</span>  <span class="m">235022249</span>   <span class="m">3088</span>    <span class="m">590.30</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">zskp</span>    <span class="m">2</span>   <span class="m">1911399616</span>  <span class="m">205669791</span>   <span class="m">3786</span>    <span class="m">481.34</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">zskp</span>    <span class="m">3</span>   <span class="m">1911399616</span>  <span class="m">175034659</span>   <span class="m">9636</span>    <span class="m">189.17</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">zskp</span>    <span class="m">4</span>   <span class="m">1911399616</span>  <span class="m">167273881</span>   <span class="m">29337</span>   <span class="m">62.13</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">zstd</span>    <span class="m">1</span>   <span class="m">1911399616</span>  <span class="m">249810424</span>   <span class="m">2637</span>    <span class="m">691.26</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">zstd</span>    <span class="m">3</span>   <span class="m">1911399616</span>  <span class="m">208192146</span>   <span class="m">3490</span>    <span class="m">522.31</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">zstd</span>    <span class="m">6</span>   <span class="m">1911399616</span>  <span class="m">193632038</span>   <span class="m">6687</span>    <span class="m">272.56</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">zstd</span>    <span class="m">9</span>   <span class="m">1911399616</span>  <span class="m">177620386</span>   <span class="m">16175</span>   <span class="m">112.70</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">gzstd</span>   <span class="m">1</span>   <span class="m">1911399616</span>  <span class="m">357382641</span>   <span class="m">10251</span>   <span class="m">177.82</span>
<span class="n">gob</span><span class="o">-</span><span class="n">stream</span>  <span class="n">gzkp</span>    <span class="m">1</span>   <span class="m">1911399616</span>  <span class="m">362156523</span>   <span class="m">5695</span>    <span class="m">320.08</span>

<span class="n">The</span> <span class="n">test</span> <span class="n">data</span> <span class="n">for</span> <span class="n">the</span> <span class="n">Large</span> <span class="n">Text</span> <span class="n">Compression</span> <span class="n">Benchmark</span> <span class="n">is</span> <span class="n">the</span> <span class="n">first</span>
<span class="m">10</span><span class="n">^9</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">the</span> <span class="n">English</span> <span class="n">Wikipedia</span> <span class="n">dump</span> <span class="n">on</span> <span class="n">Mar.</span> <span class="m">3</span><span class="p">,</span> <span class="m">2006</span><span class="n">.
</span><span class="n"></span><span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="n">mattmahoney.net</span><span class="o">/</span><span class="n">dc</span><span class="o">/</span><span class="n">textdata.html</span><span class="o">&gt;</span>

<span class="n">file</span>    <span class="n">out</span> <span class="n">level</span>   <span class="n">insize</span>      <span class="n">outsize</span>     <span class="n">millis</span>  <span class="n">mb</span><span class="o">/</span><span class="n">s</span>
<span class="n">enwik9</span>  <span class="n">zskp</span>    <span class="m">1</span>   <span class="m">1000000000</span>  <span class="m">343848582</span>   <span class="m">3609</span>    <span class="m">264.18</span>
<span class="n">enwik9</span>  <span class="n">zskp</span>    <span class="m">2</span>   <span class="m">1000000000</span>  <span class="m">317276632</span>   <span class="m">5746</span>    <span class="m">165.97</span>
<span class="n">enwik9</span>  <span class="n">zskp</span>    <span class="m">3</span>   <span class="m">1000000000</span>  <span class="m">292243069</span>   <span class="m">12162</span>   <span class="m">78.41</span>
<span class="n">enwik9</span>  <span class="n">zskp</span>    <span class="m">4</span>   <span class="m">1000000000</span>  <span class="m">275241169</span>   <span class="m">36430</span>   <span class="m">26.18</span>
<span class="n">enwik9</span>  <span class="n">zstd</span>    <span class="m">1</span>   <span class="m">1000000000</span>  <span class="m">358072021</span>   <span class="m">3110</span>    <span class="m">306.65</span>
<span class="n">enwik9</span>  <span class="n">zstd</span>    <span class="m">3</span>   <span class="m">1000000000</span>  <span class="m">313734672</span>   <span class="m">4784</span>    <span class="m">199.35</span>
<span class="n">enwik9</span>  <span class="n">zstd</span>    <span class="m">6</span>   <span class="m">1000000000</span>  <span class="m">295138875</span>   <span class="m">10290</span>   <span class="m">92.68</span>
<span class="n">enwik9</span>  <span class="n">zstd</span>    <span class="m">9</span>   <span class="m">1000000000</span>  <span class="m">278348700</span>   <span class="m">28549</span>   <span class="m">33.40</span>
<span class="n">enwik9</span>  <span class="n">gzstd</span>   <span class="m">1</span>   <span class="m">1000000000</span>  <span class="m">382578136</span>   <span class="m">9604</span>    <span class="m">99.30</span>
<span class="n">enwik9</span>  <span class="n">gzkp</span>    <span class="m">1</span>   <span class="m">1000000000</span>  <span class="m">383825945</span>   <span class="m">6544</span>    <span class="m">145.73</span>

<span class="n">Highly</span> <span class="n">compressible</span> <span class="n">JSON</span> <span class="n">file.</span>
<span class="o">&lt;</span><span class="n">https</span><span class="o">://</span><span class="n">files.klauspost.com</span><span class="o">/</span><span class="n">compress</span><span class="o">/</span><span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json.zst</span><span class="o">&gt;</span>

<span class="n">file</span>                        <span class="n">out</span> <span class="n">level</span>   <span class="n">insize</span>      <span class="n">outsize</span>     <span class="n">millis</span>  <span class="n">mb</span><span class="o">/</span><span class="n">s</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">zskp</span>    <span class="m">1</span>   <span class="m">6273951764</span>  <span class="m">699045015</span>   <span class="m">10620</span>   <span class="m">563.40</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">zskp</span>    <span class="m">2</span>   <span class="m">6273951764</span>  <span class="m">617881763</span>   <span class="m">11687</span>   <span class="m">511.96</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">zskp</span>    <span class="m">3</span>   <span class="m">6273951764</span>  <span class="m">524340691</span>   <span class="m">34043</span>   <span class="m">175.75</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">zskp</span>    <span class="m">4</span>   <span class="m">6273951764</span>  <span class="m">503314661</span>   <span class="m">93811</span>   <span class="m">63.78</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">zstd</span>    <span class="m">1</span>   <span class="m">6273951764</span>  <span class="m">766284037</span>   <span class="m">8450</span>    <span class="m">708.00</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">zstd</span>    <span class="m">3</span>   <span class="m">6273951764</span>  <span class="m">661889476</span>   <span class="m">10927</span>   <span class="m">547.57</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">zstd</span>    <span class="m">6</span>   <span class="m">6273951764</span>  <span class="m">642756859</span>   <span class="m">22996</span>   <span class="m">260.18</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">zstd</span>    <span class="m">9</span>   <span class="m">6273951764</span>  <span class="m">601974523</span>   <span class="m">52413</span>   <span class="m">114.16</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">gzstd</span>   <span class="m">1</span>   <span class="m">6273951764</span>  <span class="m">1164400847</span>  <span class="m">29948</span>   <span class="m">199.79</span>
<span class="n">github</span><span class="o">-</span><span class="n">june</span><span class="m">-2</span><span class="n">days</span><span class="m">-2019</span><span class="n">.json</span> <span class="n">gzkp</span>    <span class="m">1</span>   <span class="m">6273951764</span>  <span class="m">1128755542</span>  <span class="m">19236</span>   <span class="m">311.03</span>

<span class="n">VM</span> <span class="n">Image</span><span class="p">,</span> <span class="n">Linux</span> <span class="n">mint</span> <span class="n">with</span> <span class="n">a</span> <span class="n">few</span> <span class="n">installed</span> <span class="n">applications</span><span class="o">:</span>
<span class="o">&lt;</span><span class="n">https</span><span class="o">://</span><span class="n">files.klauspost.com</span><span class="o">/</span><span class="n">compress</span><span class="o">/</span><span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.7z</span><span class="o">&gt;</span>

<span class="n">file</span>                    <span class="n">out</span> <span class="n">level</span>   <span class="n">insize</span>      <span class="n">outsize</span>     <span class="n">millis</span>  <span class="n">mb</span><span class="o">/</span><span class="n">s</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">zskp</span>    <span class="m">1</span>   <span class="m">8558382592</span>  <span class="m">3667489370</span>  <span class="m">20210</span>   <span class="m">403.84</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">zskp</span>    <span class="m">2</span>   <span class="m">8558382592</span>  <span class="m">3364592300</span>  <span class="m">31873</span>   <span class="m">256.07</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">zskp</span>    <span class="m">3</span>   <span class="m">8558382592</span>  <span class="m">3158085214</span>  <span class="m">77675</span>   <span class="m">105.08</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">zskp</span>    <span class="m">4</span>   <span class="m">8558382592</span>  <span class="m">3020370044</span>  <span class="m">404956</span>  <span class="m">20.16</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">zstd</span>    <span class="m">1</span>   <span class="m">8558382592</span>  <span class="m">3609250104</span>  <span class="m">17136</span>   <span class="m">476.27</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">zstd</span>    <span class="m">3</span>   <span class="m">8558382592</span>  <span class="m">3341679997</span>  <span class="m">29262</span>   <span class="m">278.92</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">zstd</span>    <span class="m">6</span>   <span class="m">8558382592</span>  <span class="m">3235846406</span>  <span class="m">77904</span>   <span class="m">104.77</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">zstd</span>    <span class="m">9</span>   <span class="m">8558382592</span>  <span class="m">3160778861</span>  <span class="m">140946</span>  <span class="m">57.91</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">gzstd</span>   <span class="m">1</span>   <span class="m">8558382592</span>  <span class="m">3926257486</span>  <span class="m">57722</span>   <span class="m">141.40</span>
<span class="n">rawstudio</span><span class="o">-</span><span class="n">mint14.tar</span>    <span class="n">gzkp</span>    <span class="m">1</span>   <span class="m">8558382592</span>  <span class="m">3970463184</span>  <span class="m">41749</span>   <span class="m">195.49</span>

<span class="n">CSV</span> <span class="n">data</span><span class="o">:</span>
<span class="o">&lt;</span><span class="n">https</span><span class="o">://</span><span class="n">files.klauspost.com</span><span class="o">/</span><span class="n">compress</span><span class="o">/</span><span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv.zst</span><span class="o">&gt;</span>

<span class="n">file</span>                    <span class="n">out</span> <span class="n">level</span>   <span class="n">insize</span>      <span class="n">outsize</span>     <span class="n">millis</span>  <span class="n">mb</span><span class="o">/</span><span class="n">s</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">zskp</span>    <span class="m">1</span>   <span class="m">3325605752</span>  <span class="m">641339945</span>   <span class="m">8925</span>    <span class="m">355.35</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">zskp</span>    <span class="m">2</span>   <span class="m">3325605752</span>  <span class="m">591748091</span>   <span class="m">11268</span>   <span class="m">281.44</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">zskp</span>    <span class="m">3</span>   <span class="m">3325605752</span>  <span class="m">530289687</span>   <span class="m">25239</span>   <span class="m">125.66</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">zskp</span>    <span class="m">4</span>   <span class="m">3325605752</span>  <span class="m">490907191</span>   <span class="m">65939</span>   <span class="m">48.10</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">zstd</span>    <span class="m">1</span>   <span class="m">3325605752</span>  <span class="m">687399637</span>   <span class="m">8233</span>    <span class="m">385.18</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">zstd</span>    <span class="m">3</span>   <span class="m">3325605752</span>  <span class="m">598514411</span>   <span class="m">10065</span>   <span class="m">315.07</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">zstd</span>    <span class="m">6</span>   <span class="m">3325605752</span>  <span class="m">570522953</span>   <span class="m">20038</span>   <span class="m">158.27</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">zstd</span>    <span class="m">9</span>   <span class="m">3325605752</span>  <span class="m">517554797</span>   <span class="m">64565</span>   <span class="m">49.12</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">gzstd</span>   <span class="m">1</span>   <span class="m">3325605752</span>  <span class="m">928656485</span>   <span class="m">23876</span>   <span class="m">132.83</span>
<span class="n">nyc</span><span class="o">-</span><span class="n">taxi</span><span class="o">-</span><span class="n">data</span><span class="m">-10</span><span class="n">M.csv</span>   <span class="n">gzkp</span>    <span class="m">1</span>   <span class="m">3325605752</span>  <span class="m">924718719</span>   <span class="m">16388</span>   <span class="m">193.53</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="解压器">解压器<a hidden class="anchor" aria-hidden="true" href="#解压器">#</a></h2>
<p>状态：稳定 - 可能仍然存在细微的错误，但已经测试了各种各样的内容。</p>
<p>该库正在不断进行模糊测试，由fuzzit.dev 友情提供。模糊测试的主要目的是确保解码器不会崩溃，或在提供任何输入的情况下运行超过其限制。</p>
<h2 id="用法-1">用法<a hidden class="anchor" aria-hidden="true" href="#用法-1">#</a></h2>
<p>该包被设计用于两种主要用途，大数据流和较小的内存缓冲区。这些包有两个主要用途。它们都可以通过创建一个Decoder.</p>
<p>对于流媒体使用，一个简单的设置可能如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;github.com/klauspost/compress/zstd&#34;</span>

<span class="kd">func</span> <span class="nf">Decompress</span><span class="p">(</span><span class="nx">in</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">out</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">d</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">zstd</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">in</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

    <span class="c1">// Copy content...
</span><span class="c1"></span>    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">Copy</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>当您不再需要 Reader 来停止运行 goroutine 时，使用“关闭”功能很重要。请参阅下面的“无分配操作”。</p>
<p>对于解码缓冲区，它可能如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;github.com/klauspost/compress/zstd&#34;</span>

<span class="c1">// Create a reader that caches decompressors.
</span><span class="c1">// For this operation type we supply a nil Reader.
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">decoder</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">zstd</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>

<span class="c1">// Decompress a buffer. We don&#39;t supply a destination buffer,
</span><span class="c1">// so it will be allocated by the decoder.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Decompress</span><span class="p">(</span><span class="nx">src</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">decoder</span><span class="p">.</span><span class="nf">DecodeAll</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这两种情况都应该提供所需的功能。解码器可用于多个缓冲区的并发解压缩。它只允许运行一定数量的并发操作。要自己调整，请在创建解码器时使用<code>WithDecoderConcurrency(n)</code>选项。</p>
<h2 id="字典">字典<a hidden class="anchor" aria-hidden="true" href="#字典">#</a></h2>
<p>用字典压缩的数据可以解压。</p>
<p>字典单独添加到解码器。字典由<code>zstd --train</code>命令生成并包含解码器的初始状态。要添加字典，请使用<code>WithDecoderDicts(dicts ...[]byte)</code>带有字典数据的选项。可以一次添加多个词典。</p>
<p>字典将自动用于指定它们的数据。重用的解码器仍将包含已注册的词典。</p>
<p>注册多个同一个ID的词典时，会使用最后一个。</p>
<p>压缩数据时可以使用字典。</p>
<p>要启用字典，请使用<code>WithEncoderDict(dict []byte)</code>. 这里只使用一本字典，即使它没有改进压缩，它也可能会被使用。</p>
<p>必须使用使用的字典来解压缩内容。</p>
<p>对于任何真正的收益，字典都应该使用类似的数据构建。如果使用不合适的字典，输出可能比不使用字典稍大。使用zstd 命令行工具从示例数据构建字典。有关信息，请参阅zstd 字典信息。</p>
<p>目前，使用字典压缩内容存在固定的启动性能损失。随着时间的推移，这可能会得到改善。请注意在实施时测试性能。</p>
<h2 id="无分配操作">无分配操作<a hidden class="anchor" aria-hidden="true" href="#无分配操作">#</a></h2>
<p>解码器设计为在预热后无需分配即可运行。</p>
<p>这意味着您应该存储解码器以获得最佳性能。要重新使用流解码器，请使用<code>Reset(r io.Reader) error</code>切换到另一个流。即使前一个流失败，解码器也可以安全地重新使用。</p>
<p>要释放资源，您必须在解码器上调用<code>Close()</code>函数。在此之后它不能再被重用，但所有正在运行的 goroutine 将被停止。因此，如果您不再需要阅读器，则必须使用它。</p>
<p>为了解压缩较小的缓冲区，可以使用单个解码器。解码缓冲区时，您可以提供长度为 0 和预期容量的目标切片。在这种情况下，不应进行不需要的分配。</p>
<h2 id="并发">并发<a hidden class="anchor" aria-hidden="true" href="#并发">#</a></h2>
<p>缓冲区解码器在同一个 goroutine 上执行所有操作，并且不同时执行任何操作。然而，它可以同时解码多个缓冲区。使用<code>WithDecoderConcurrency(n)</code>来限制。</p>
<p>流解码器操作:</p>
<ul>
<li>一个 goroutine 读取输入并将输入拆分到多个块解码器。</li>
<li>许多解码器将解码块。</li>
<li>goroutine 协调这些块并将历史从一个块发送到下一个。</li>
</ul>
<p>如此有效，这也意味着解码器将“提前读取”并准备数据以始终可用于输出。</p>
<p>由于“块”非常依赖于先前块流解码的输出，因此只有有限的并发性。</p>
<p>在实践中，这意味着并发通常仅限于有效利用大约 2 个内核。</p>
<h2 id="基准">基准<a hidden class="anchor" aria-hidden="true" href="#基准">#</a></h2>
<p>这些是与datadog cgo 库相比的一些性能示例。</p>
<p>前两个是流式解码，最后一个是较小的输入。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">BenchmarkDecoderSilesia</span><span class="m">-8</span>                          <span class="m">3</span>     <span class="m">385000067</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>     <span class="m">550.51</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>        <span class="m">5498</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">8</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoderSilesiaCgo</span><span class="m">-8</span>                       <span class="m">6</span>     <span class="m">197666567</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">1072.25</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>      <span class="m">270672</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">8</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>

<span class="n">BenchmarkDecoderEnwik9</span><span class="m">-8</span>                           <span class="m">1</span>    <span class="m">2027001600</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>     <span class="m">493.34</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>       <span class="m">10496</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>         <span class="m">18</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoderEnwik9Cgo</span><span class="m">-8</span>                        <span class="m">2</span>     <span class="m">979499200</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">1020.93</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>      <span class="m">270672</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">8</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>

<span class="n">Concurrent</span> <span class="n">performance</span><span class="o">:</span>

<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">kppkn.gtb.zst</span><span class="m">-16</span>                <span class="m">28915</span>         <span class="m">42469</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">4340.07</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>         <span class="m">114</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">geo.protodata.zst</span><span class="m">-16</span>           <span class="m">116505</span>          <span class="m">9965</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">11900.16</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>         <span class="m">16</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">plrabn12.txt.zst</span><span class="m">-16</span>              <span class="m">8952</span>        <span class="m">134272</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">3588.70</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>         <span class="m">915</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">lcet10.txt.zst</span><span class="m">-16</span>               <span class="m">11820</span>        <span class="m">102538</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">4161.90</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>         <span class="m">594</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">asyoulik.txt.zst</span><span class="m">-16</span>             <span class="m">34782</span>         <span class="m">34184</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">3661.88</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">60</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">alice29.txt.zst</span><span class="m">-16</span>              <span class="m">27712</span>         <span class="m">43447</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">3500.58</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">99</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">html_x_4.zst</span><span class="m">-16</span>                 <span class="m">62826</span>         <span class="m">18750</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">21845.10</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>        <span class="m">104</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">paper</span><span class="m">-100</span><span class="n">k.pdf.zst</span><span class="m">-16</span>          <span class="m">631545</span>          <span class="m">1794</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">57078.74</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">2</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">fireworks.jpeg.zst</span><span class="m">-16</span>         <span class="m">1690140</span>           <span class="m">712</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">172938.13</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>         <span class="m">1</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">urls.10K.zst</span><span class="m">-16</span>                 <span class="m">10432</span>        <span class="m">113593</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">6180.73</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>        <span class="m">1143</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">html.zst</span><span class="m">-16</span>                    <span class="m">113206</span>         <span class="m">10671</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">9596.27</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">15</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallel</span><span class="o">/</span><span class="n">comp</span><span class="o">-</span><span class="n">data.bin.zst</span><span class="m">-16</span>          <span class="m">1530615</span>           <span class="m">779</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">5229.49</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>           <span class="m">0</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>

<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">kppkn.gtb.zst</span><span class="m">-16</span>             <span class="m">65217</span>         <span class="m">16192</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">11383.34</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>         <span class="m">46</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">geo.protodata.zst</span><span class="m">-16</span>        <span class="m">292671</span>          <span class="m">4039</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">29363.19</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">6</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">plrabn12.txt.zst</span><span class="m">-16</span>          <span class="m">26314</span>         <span class="m">46021</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">10470.43</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>        <span class="m">293</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">lcet10.txt.zst</span><span class="m">-16</span>            <span class="m">33897</span>         <span class="m">34900</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">12227.96</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>        <span class="m">205</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">asyoulik.txt.zst</span><span class="m">-16</span>         <span class="m">104348</span>         <span class="m">11433</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">10949.01</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>         <span class="m">20</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">alice29.txt.zst</span><span class="m">-16</span>           <span class="m">75949</span>         <span class="m">15510</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">9805.60</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">32</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">html_x_4.zst</span><span class="m">-16</span>             <span class="m">173910</span>          <span class="m">6756</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">60624.29</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>         <span class="m">37</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">paper</span><span class="m">-100</span><span class="n">k.pdf.zst</span><span class="m">-16</span>       <span class="m">923076</span>          <span class="m">1339</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">76474.87</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">1</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">fireworks.jpeg.zst</span><span class="m">-16</span>       <span class="m">922920</span>          <span class="m">1351</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">91102.57</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">2</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">urls.10K.zst</span><span class="m">-16</span>              <span class="m">27649</span>         <span class="m">43618</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">16096.19</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>        <span class="m">407</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">html.zst</span><span class="m">-16</span>                 <span class="m">279073</span>          <span class="m">4160</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">24614.18</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>          <span class="m">6</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
<span class="n">BenchmarkDecoder_DecodeAllParallelCgo</span><span class="o">/</span><span class="n">comp</span><span class="o">-</span><span class="n">data.bin.zst</span><span class="m">-16</span>        <span class="m">749938</span>          <span class="m">1579</span> <span class="n">ns</span><span class="o">/</span><span class="n">op</span>    <span class="m">2581.71</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>           <span class="m">0</span> <span class="n">B</span><span class="o">/</span><span class="n">op</span>          <span class="m">0</span> <span class="n">allocs</span><span class="o">/</span><span class="n">op</span>
</code></pre></td></tr></table>
</div>
</div><p>这反映了 2020 年 5 月前后的表现，但这可能已经过时。</p>
<h2 id="zip-文件中的-zstd">ZIP 文件中的 Zstd<a hidden class="anchor" aria-hidden="true" href="#zip-文件中的-zstd">#</a></h2>
<p>可以使用 zstandard 来压缩 zip 档案中的单个文件。虽然这没有得到广泛支持，但它对内部文件很有用。</p>
<p>要支持这些文件的压缩和解压，您必须注册一个压缩器和解压器。</p>
<p>强烈建议在单独的 zip Reader/Writer 上注册（解）压缩器，而不是使用全局注册功能。造成这种情况的主要原因是来自不同包的 2 个注册会导致恐慌。</p>
<p>最好只有一个压缩器和解压缩器，因为它们可以同时用于多个 zip 文件，并且使用单个实例将允许重用某些资源。</p>
<p>请参阅此示例了解如何压缩和解压缩 zip 档案中的文件。</p>
<h2 id="转载">转载<a hidden class="anchor" aria-hidden="true" href="#转载">#</a></h2>
<p><a href="https://github.com/klauspost/compress/tree/master/zstd#zstd">zstd</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
      <li><a href="/tags/zstd/">zstd</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
