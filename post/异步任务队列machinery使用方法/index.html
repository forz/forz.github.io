<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>异步任务队列:machinery使用方法 | Forz Blog</title>
<meta name="keywords" content="machinery" />
<meta name="description" content="Config machinery的配置结构体是config包中的Config类型,具体结构如下: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Config holds all configuration for our program type Config struct {">
<meta name="author" content="">
<link rel="canonical" href="/post/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97machinery%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="异步任务队列:machinery使用方法" />
<meta property="og:description" content="Config machinery的配置结构体是config包中的Config类型,具体结构如下: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Config holds all configuration for our program type Config struct {" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97machinery%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-10-16T21:09:01&#43;00:00" />
<meta property="article:modified_time" content="2019-10-16T21:09:01&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="异步任务队列:machinery使用方法"/>
<meta name="twitter:description" content="Config machinery的配置结构体是config包中的Config类型,具体结构如下: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Config holds all configuration for our program type Config struct {"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "异步任务队列:machinery使用方法",
      "item": "/post/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97machinery%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "异步任务队列:machinery使用方法",
  "name": "异步任务队列:machinery使用方法",
  "description": "Config machinery的配置结构体是config包中的Config类型,具体结构如下: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Config holds all configuration for our program type Config struct {",
  "keywords": [
    "machinery"
  ],
  "articleBody": "Config machinery的配置结构体是config包中的Config类型,具体结构如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // Config holds all configuration for our program type Config struct { Broker string `yaml:\"broker\" envconfig:\"BROKER\"` DefaultQueue string `yaml:\"default_queue\" envconfig:\"DEFAULT_QUEUE\"` ResultBackend string `yaml:\"result_backend\" envconfig:\"RESULT_BACKEND\"` ResultsExpireIn int `yaml:\"results_expire_in\" envconfig:\"RESULTS_EXPIRE_IN\"` AMQP *AMQPConfig `yaml:\"amqp\"` SQS *SQSConfig `yaml:\"sqs\"` Redis *RedisConfig `yaml:\"redis\"` GCPPubSub *GCPPubSubConfig `yaml:\"-\" ignored:\"true\"` MongoDB *MongoDBConfig `yaml:\"-\" ignored:\"true\"` TLSConfig *tls.Config // NoUnixSignals - when set disables signal handling in machinery \tNoUnixSignals bool `yaml:\"no_unix_signals\" envconfig:\"NO_UNIX_SIGNALS\"` DynamoDB *DynamoDBConfig `yaml:\"dynamodb\"` }   machinery具有用于从环境变量或YAML文件加载构造方便的方法。,例如，从环境变量加载配置：\n1  cnf, err := config.NewFromEnvironment(true)   或从YAML文件加载：\n1  cnf, err := config.NewFromYaml(\"config.yml\", true)   第二个布尔值标志允许每10秒实时重新加载配置。使用false禁用重新加载。\nmachinery的配置由Config结构封装，并作为对需要它的对象的依赖项注入。\n举例:config.yaml配置如下:\n1 2 3 4 5 6 7 8 9 10  ---broker:'redis://localhost:6379'#broker: 'redis://localhost:6379'#broker: 'https://sqs.us-west-2.amazonaws.com/123456789012'default_queue:machinery_tasksresult_backend:'redis://localhost:6379'#result_backend: 'memcache://localhost:11211'#result_backend: 'mongodb://localhost:27017'results_expire_in:3600000  broker 消息代理。\nAMQP 使用以下格式的AMQP URL：\n1  amqp://[username:password@]@host[:port]   例如：\n1  amqp://guest:guest@localhost:5672   Redis 使用以下格式之一的Redis URL：\n1 2  redis://[password@]host[port][/db_num] redis+socket://[password@]/path/to/file.sock[:/db_num]   例如：\n1 2  redis://localhost:6379, or with password redis://password@localhost:6379 redis+socket://password@/path/to/file.sock:/0   default_queue 默认队列名称，例如machinery_tasks。\nresult_backend 后端，用于保留任务状态和结果。\nRedis 使用以下格式之一的Redis URL：\n1 2  redis://[password@]host[port][/db_num] redis+socket://[password@]/path/to/file.sock[:/db_num]   例如：\n1 2 3  redis://localhost:6379, or with password redis://password@localhost:6379 redis+socket://password@/path/to/file.sock:/0 cluster redis://host1:port1,host2:port2,host3:port3   Memcache 使用以下格式的Memcache URL：\n1  memcache://host1[:port1][,host2[:port2],...[,hostN[:portN]]]   例如：\n1 2  memcache://localhost:11211 for a single instance, or memcache://10.0.0.1:11211,10.0.0.2:11211 for a cluster   AMQP 使用以下格式的AMQP URL：\n1  amqp://[username:password@]@host[:port]   例如：\n1  amqp://guest:guest@localhost:5672   请记住，不建议将AMQP作为后端。原因见下文.\nMongoDB 使用以下格式的Mongodb URL：\n1  mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]   例如：\n1  mongodb://localhost:27017/taskresults   有关更多信息，请参见MongoDB文档。\nresults_expire_in 任务结果存储多长时间（以秒为单位）。默认为3600（1小时）。\nAMQP RabbitMQ相关的配置。如果您正在使用其他代理/后端，则没有必要。\n Exchange：交换名称，例如 machinery_exchange ExchangeType：交换类型，例如 direct QueueBindingArguments：绑定到AMQP队列时使用的附加参数的可选映射 BindingKey：使用此密钥将队列绑定到交换，例如 machinery_task PrefetchCount：要预取多少个任务（1如果您有长期运行的任务，则设置为）  Server Machinery必须在使用前实例化。完成此操作的方法是创建一个Server实例。Server是存储Machinery配置和已注册任务的基础对象。\nserver基本结构如下:\n1 2 3 4 5 6 7  type Server struct { config *config.Config registeredTasks map[string]interface{} broker brokersiface.Broker backend backendsiface.Backend prePublishHandler func(*tasks.Signature) }   存储配置 server例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  import ( \"github.com/RichardKnop/machinery/v1/config\" \"github.com/RichardKnop/machinery/v1\" ) var cnf = \u0026config.Config{ Broker: \"amqp://guest:guest@localhost:5672/\", DefaultQueue: \"machinery_tasks\", ResultBackend: \"amqp://guest:guest@localhost:5672/\", AMQP: \u0026config.AMQPConfig{ Exchange: \"machinery_exchange\", ExchangeType: \"direct\", BindingKey: \"machinery_task\", }, } server, err := machinery.NewServer(cnf) if err != nil { // do something with the error }   注册任务 注册任务名和对应的执行函数,下面有更详细的解释.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  // Register tasks tasks := map[string]interface{}{ \"add\": exampletasks.Add, \"multiply\": exampletasks.Multiply, \"sum_ints\": exampletasks.SumInts, \"sum_floats\": exampletasks.SumFloats, \"concat\": exampletasks.Concat, \"split\": exampletasks.Split, \"panic_task\": exampletasks.PanicTask, \"long_running_task\": exampletasks.LongRunningTask, } err:=server.RegisterTasks(tasks) if err != nil { // do something with the error }   Worker 注册worker 为了消费任务，您需要让一个或多个workers运行。\nworker结构体信息如下:\n1 2 3 4 5 6 7 8 9 10  // Worker represents a single worker process type Worker struct { server *Server ConsumerTag string Concurrency int Queue string errorHandler func(err error) preTaskHandler func(*tasks.Signature) postTaskHandler func(*tasks.Signature) }   你需要利用server创建一个worker实例来运行并注册worker,例如：\n1  worker := server.NewWorker(\"worker_name\", 10)   每个worker将只消费注册的任务。对于队列中的每个任务，Worker.Process()方法将在goroutine中运行。\n第一个参数是消费者标签,理想情况下，每个worker都应该有一个唯一的标签（worker1，worker2等）\n使用的第二个参数server.NewWorker来限制同时运行的Worker.Process()调用的数量（每个worker）。例如:1将序列化任务执行，而0将使并发执行的任务数不受限制（默认）。\n添加Handler 可以为任务开始和结束时添加hook,也可以做错误处理.\n当任务返回错误时，默认行为是首先尝试重试该任务（如果可重试），否则记录该错误，然后最终调用任何错误回调。\n要对此进行自定义，可以在worker上设置一个自定义的错误处理程序，它不仅可以执行重试失败且触发了错误回调后的日志记录，还可以做更多的事情:\n1 2 3 4 5 6 7 8 9 10 11 12 13  //这里，我们注入了一些用于错误处理的自定义代码，还有任务开始和结束的钩子 errorhandler := func(err error) { log.ERROR.Println(\"I am an error handler:\", err) } pretaskhandler := func(signature *tasks.Signature) { log.INFO.Println(\"I am a start of task handler for:\", signature.Name) } posttaskhandler := func(signature *tasks.Signature) { log.INFO.Println(\"I am an end of task handler for:\", signature.Name) } worker.SetPostTaskHandler(posttaskhandler) worker.SetErrorHandler(errorhandler) worker.SetPreTaskHandler(pretaskhandler)   执行worker 1 2 3 4  err := worker.Launch() if err != nil { // do something with the error }   Task Task是machinery的基础概念。Tasks的本质是一个传参和返回值有规定的function，它定义了当worker收到消息时会发生什么。\n每个task都需要返回一个错误作为最后的返回值。除了错误，现在还可以返回任意数量的参数。\n顾泽task规则的示例function如下:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  // Add ... func Add(args ...int64) (int64, error) { sum := int64(0) for _, arg := range args { sum += arg } return sum, nil } // Multiply ... func Multiply(args ...int64) (int64, error) { sum := int64(1) for _, arg := range args { sum *= arg } return sum, nil } // SumInts ... func SumInts(numbers []int64) (int64, error) { var sum int64 for _, num := range numbers { sum += num } return sum, nil } // SumFloats ... func SumFloats(numbers []float64) (float64, error) { var sum float64 for _, num := range numbers { sum += num } return sum, nil } // Concat ... func Concat(strs []string) (string, error) { var res string for _, s := range strs { res += s } return res, nil } // Split ... func Split(str string) ([]string, error) { return strings.Split(str, \"\"), nil } // PanicTask ... func PanicTask() (string, error) { panic(errors.New(\"oops\")) } // LongRunningTask ... func LongRunningTask() error { log.INFO.Print(\"Long running task started\") for i := 0; i  10; i++ { log.INFO.Print(10 - i) time.Sleep(1 * time.Second) } log.INFO.Print(\"Long running task finished\") return nil }   注册task 在您的worker可以使用任务之前，您需要在服务器上注册它。这可以通过为任务分配唯一的名称来完成：\n1 2 3 4  server.RegisterTasks(map[string]interface{}{ \"add\": Add, \"multiply\": Multiply, })   任务也可以一一注册：\n1 2  server.RegisterTask(\"add\", Add) server.RegisterTask(\"multiply\", Multiply)   简而言之，当一个work收到这样的消息时：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  { \"UUID\": \"48760a1a-8576-4536-973b-da09048c2ac5\", \"Name\": \"add\", \"RoutingKey\": \"\", \"ETA\": null, \"GroupUUID\": \"\", \"GroupTaskCount\": 0, \"Args\": [ { \"Type\": \"int64\", \"Value\": 1, }, { \"Type\": \"int64\", \"Value\": 1, } ], \"Immutable\": false, \"RetryCount\": 0, \"RetryTimeout\": 0, \"OnSuccess\": null, \"OnError\": null, \"ChordCallback\": null }   它将调用Add(1，1)。每个task也应该返回一个错误，以便我们处理失败。\n理想情况下，task应该是幂等的，这意味着当使用相同的参数多次调用task时，不会有意外的后果。\nSignature 基本类型 Signature 包装了task的调用参数，执行选项（例如immutability）和 success/error 回调，因此可以通过网络将其发送给worker。 Task signature 实现了一个简单的interface：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  // Arg represents a single argument passed to invocation fo a task type Arg struct { Type string Value interface{} } // Headers represents the headers which should be used to direct the task type Headers map[string]interface{} // Signature represents a single task invocation type Signature struct { UUID string Name string RoutingKey string ETA *time.Time GroupUUID string GroupTaskCount int Args []Arg Headers Headers Priority uint8 Immutable bool RetryCount int RetryTimeout int OnSuccess []*Signature OnError []*Signature ChordCallback *Signature //MessageGroupId for Broker, e.g. SQS \tBrokerMessageGroupId string //ReceiptHandle of SQS Message \tSQSReceiptHandle string // StopTaskDeletionOnError used with sqs when we want to send failed messages to dlq,  // and don't want machinery to delete from source queue \tStopTaskDeletionOnError bool // IgnoreWhenTaskNotRegistered auto removes the request when there is no handeler available \t// When this is true a task with no handler will be ignored and not placed back in the queue \tIgnoreWhenTaskNotRegistered bool }    UUID，任务的unique ID，可以主动设定也可以由系统自行设定； Name，任务的名称，用于识别任务； RoutingKey，根据这个key，用于将任务扔到一个正确的队列中； ETA，专用于延时任务，若该参数为nil，说明需要立即将该任务扔给worker，否则，在参数数值到来之前，该任务将一直delay； GroupUUID和GroupTaskCount，用于workflow中的Group分组任务创建 Args，任务传递给worker时的参数列表 Headers，用于tracing RetryCount和RetryTimeout，用于实现任务的重试机制 Immutable，该参数可以控制任务之间是否需要参数传递 OnSuccess和OnError，实现回调，workflow中的链式任务（chain），就是通过OnSuccess来实现链式调度 ChordCallback，workflow中的chord模式，在group内所有任务全部执行完成后，进行callback。  在将tasks发送到broker之前，Machinery将task编码为JSON。task结果也作为JSON编码的字符串存储在后端。因此，Signature仅支持具有JSON表示形式的类型。当前支持的类型是：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  bool int int8 int16 int32 int64 uint uint8 uint16 uint32 uint64 float32 float64 string []bool []int []int8 []int16 []int32 []int64 []uint []uint8 []uint16 []uint32 []uint64 []float32 []float64 []string   示例代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101  var ( addTask0, addTask1, addTask2 tasks.Signature multiplyTask0, multiplyTask1 tasks.Signature sumIntsTask, sumFloatsTask, concatTask, splitTask tasks.Signature panicTask tasks.Signature longRunningTask tasks.Signature ) addTask0 = tasks.Signature{ Name: \"add\", Args: []tasks.Arg{ { Type: \"int64\", Value: 1, }, { Type: \"int64\", Value: 1, }, }, } addTask1 = tasks.Signature{ Name: \"add\", Args: []tasks.Arg{ { Type: \"int64\", Value: 2, }, { Type: \"int64\", Value: 2, }, }, } addTask2 = tasks.Signature{ Name: \"add\", Args: []tasks.Arg{ { Type: \"int64\", Value: 5, }, { Type: \"int64\", Value: 6, }, }, } multiplyTask0 = tasks.Signature{ Name: \"multiply\", Args: []tasks.Arg{ { Type: \"int64\", Value: 4, }, }, } multiplyTask1 = tasks.Signature{ Name: \"multiply\", } sumIntsTask = tasks.Signature{ Name: \"sum_ints\", Args: []tasks.Arg{ { Type: \"[]int64\", Value: []int64{1, 2}, }, }, } sumFloatsTask = tasks.Signature{ Name: \"sum_floats\", Args: []tasks.Arg{ { Type: \"[]float64\", Value: []float64{1.5, 2.7}, }, }, } concatTask = tasks.Signature{ Name: \"concat\", Args: []tasks.Arg{ { Type: \"[]string\", Value: []string{\"foo\", \"bar\"}, }, }, } splitTask = tasks.Signature{ Name: \"split\", Args: []tasks.Arg{ { Type: \"string\", Value: \"foo\", }, }, } panicTask = tasks.Signature{ Name: \"panic_task\", } longRunningTask = tasks.Signature{ Name: \"long_running_task\", }   设置参数 延迟 您可以通过ETA在Signature 上设置时间戳字段来延迟任务。\n1 2 3  // Delay the task by 5 seconds eta := time.Now().UTC().Add(time.Second * 5) signature.ETA = \u0026eta   重试 您可以设置多个重试尝试，然后再将任务声明为失败。Fibonacci序列将用于随着时间间隔重试请求。\n1 2  // If the task fails, retry it up to 3 times signature.RetryCount = 3   或者，您可以从任务中返回tasks.ErrRetryTaskLater并指定应重试任务的持续时间，例如：\n1  return tasks.NewErrRetryTaskLater(\"some error\", 4 * time.Hour)   发送task Single task可以通过Server的sendtask实例调用。例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  asyncResult, err := server.SendTaskWithContext(ctx, \u0026addTask0) if err != nil { return fmt.Errorf(\"Could not send task: %s\", err.Error()) } results, err := asyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting task result failed with error: %s\", err.Error()) } log.INFO.Printf(\"1 + 1 = %v\\n\", tasks.HumanReadableResults(results)) /* * Try couple of tasks with a slice argument and slice return value */ asyncResult, err = server.SendTaskWithContext(ctx, \u0026sumIntsTask) if err != nil { return fmt.Errorf(\"Could not send task: %s\", err.Error()) } results, err = asyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting task result failed with error: %s\", err.Error()) } log.INFO.Printf(\"sum([1, 2]) = %v\\n\", tasks.HumanReadableResults(results)) asyncResult, err = server.SendTaskWithContext(ctx, \u0026sumFloatsTask) if err != nil { return fmt.Errorf(\"Could not send task: %s\", err.Error()) } results, err = asyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting task result failed with error: %s\", err.Error()) } log.INFO.Printf(\"sum([1.5, 2.7]) = %v\\n\", tasks.HumanReadableResults(results)) asyncResult, err = server.SendTaskWithContext(ctx, \u0026concatTask) if err != nil { return fmt.Errorf(\"Could not send task: %s\", err.Error()) } results, err = asyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting task result failed with error: %s\", err.Error()) } log.INFO.Printf(\"concat([\\\"foo\\\", \\\"bar\\\"]) = %v\\n\", tasks.HumanReadableResults(results)) asyncResult, err = server.SendTaskWithContext(ctx, \u0026splitTask) if err != nil { return fmt.Errorf(\"Could not send task: %s\", err.Error()) } results, err = asyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting task result failed with error: %s\", err.Error()) } log.INFO.Printf(\"split([\\\"foo\\\"]) = %v\\n\", tasks.HumanReadableResults(results))   tasks.HumanReadableResults返回string类型.\nWorkflows 运行单个异步任务很好，但是通常您会想要设计一种以协调方式执行的任务工作流。有几个有用的功能可以帮助您设计工作流程。\nGroup Group 是一组将彼此独立执行的并行任务。例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  group, err := tasks.NewGroup(\u0026addTask0, \u0026addTask1, \u0026addTask2) if err != nil { return fmt.Errorf(\"Error creating group: %s\", err.Error()) } asyncResults, err := server.SendGroupWithContext(ctx, group, 10)//The second parameter specifies the number of concurrent sending tasks. 0 means unlimited. if err != nil { return fmt.Errorf(\"Could not send group: %s\", err.Error()) } for _, asyncResult := range asyncResults { results, err = asyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting task result failed with error: %s\", err.Error()) } log.INFO.Printf( \"%v + %v = %v\\n\", asyncResult.Signature.Args[0].Value, asyncResult.Signature.Args[1].Value, tasks.HumanReadableResults(results), ) }   SendGroup返回AsyncResult对象的切片。因此，您可以进行阻塞调用并等待组任务的结果\nChord Chord允许您定义要在组中的所有任务完成处理之后执行的回调，例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  group, err = tasks.NewGroup(\u0026addTask0, \u0026addTask1, \u0026addTask2) if err != nil { return fmt.Errorf(\"Error creating group: %s\", err.Error()) } chord, err := tasks.NewChord(group, \u0026multiplyTask1) if err != nil { return fmt.Errorf(\"Error creating chord: %s\", err) } chordAsyncResult, err := server.SendChordWithContext(ctx, chord, 10) if err != nil { return fmt.Errorf(\"Could not send chord: %s\", err.Error()) } results, err = chordAsyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting chord result failed with error: %s\", err.Error()) } log.INFO.Printf(\"(1 + 1) * (2 + 2) * (5 + 6) = %v\\n\", tasks.HumanReadableResults(results))   上面的示例并行执行\u0026addTask0, \u0026addTask1, \u0026addTask2，将其结果汇总并将其传递给\u0026multiplyTask1。因此，最终将发生的是：\n1  (1 + 1) * (2 + 2) * (5 + 6)   Chain Chain只是一组将逐个执行的任务，每个成功的任务都会触发链中的下一个任务。例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  chain, err := tasks.NewChain(\u0026addTask0, \u0026addTask1, \u0026addTask2, \u0026multiplyTask0) if err != nil { return fmt.Errorf(\"Error creating chain: %s\", err) } chainAsyncResult, err := server.SendChainWithContext(ctx, chain) if err != nil { return fmt.Errorf(\"Could not send chain: %s\", err.Error()) } results, err = chainAsyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting chain result failed with error: %s\", err.Error()) } log.INFO.Printf(\"(((1 + 1) + (2 + 2)) + (5 + 6)) * 4 = %v\\n\", tasks.HumanReadableResult(results))   上面的示例先执行task1，然后执行task2，再执行task3，将每个任务的结果传递给链中的下一个任务。因此，最终将发生的是：\n1  (((1 + 1) + (2 + 2)) + (5 + 6)) * 4   获取待处理task 可以检查队列中当前正在等待工作的任务，例如：\n1  server.GetBroker().GetPendingTasks(\"some_queue\")   当前仅Redis broker支持。\n保存结果 如果您配置result backend，则任务状态和结果将保留下来。可能的状态：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  const ( // StatePending - initial state of a task \tStatePending = \"PENDING\" // StateReceived - when task is received by a worker \tStateReceived = \"RECEIVED\" // StateStarted - when the worker starts processing the task \tStateStarted = \"STARTED\" // StateRetry - when failed task has been scheduled for retry \tStateRetry = \"RETRY\" // StateSuccess - when the task is processed successfully \tStateSuccess = \"SUCCESS\" // StateFailure - when processing of the task fails \tStateFailure = \"FAILURE\" )   当将AMQP用作result backend时，任务状态将针对每个任务保留在单独的队列中。尽管RabbitMQ可以扩展到数千个队列，但强烈建议您在运行大量并行任务时使用更适合的result backend（例如Memcache）。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  // TaskResult represents an actual return value of a processed task type TaskResult struct { Type string `bson:\"type\"` Value interface{} `bson:\"value\"` } // TaskState represents a state of a task type TaskState struct { TaskUUID string `bson:\"_id\"` State string `bson:\"state\"` Results []*TaskResult `bson:\"results\"` Error string `bson:\"error\"` } // GroupMeta stores useful metadata about tasks within the same group // E.g. UUIDs of all tasks which are used in order to check if all tasks // completed successfully or not and thus whether to trigger chord callback type GroupMeta struct { GroupUUID string `bson:\"_id\"` TaskUUIDs []string `bson:\"task_uuids\"` ChordTriggered bool `bson:\"chord_triggered\"` Lock bool `bson:\"lock\"` }     TaskResult 表示已处理任务的返回值的一部分。\n  TaskState 每次任务状态更改时，都会对struct进行序列化和存储。\n  GroupMeta存储有关同一组内任务的有用元数据。例如，用于检查所有任务是否成功完成以及是否触发和弦回调的所有任务的UUID。\n  AsyncResult 对象允许您检查任务的状态：\n  1 2 3  taskState := asyncResult.GetState() fmt.Printf(\"Current state of %v task is:\\n\", taskState.TaskUUID) fmt.Println(taskState.State)   有几种方便的方法可以检查任务状态：\n1 2 3  asyncResult.GetState().IsCompleted() asyncResult.GetState().IsSuccess() asyncResult.GetState().IsFailure()   您还可以进行同步阻塞调用以等待任务结果：\n1 2 3 4 5 6 7 8  results, err := asyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { // getting result of a task failed  // do something with the error } for _, result := range results { fmt.Println(result.Interface()) }   日志处理 您可以通过实现以下接口来定义Custom Logger：\n1 2 3 4 5 6 7 8 9 10 11 12 13  type Interface interface { Print(...interface{}) Printf(string, ...interface{}) Println(...interface{}) Fatal(...interface{}) Fatalf(string, ...interface{}) Fatalln(...interface{}) Panic(...interface{}) Panicf(string, ...interface{}) Panicln(...interface{}) }   然后只需通过调用package中的log包里的set函数设置即可\n1  log.Set(myCustomLogger)   Tracing work:\n1 2 3 4 5  cleanup, err := tracers.SetupTracer(consumerTag) if err != nil { log.FATAL.Fatalln(\"Unable to instantiate a tracer:\", err) } defer cleanup()   send:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  /* * Lets start a span representing this run of the `send` command and * set a batch id as baggage so it can travel all the way into * the worker functions. */ span, ctx := opentracing.StartSpanFromContext(context.Background(), \"send\") defer span.Finish() batchID := uuid.New().String() span.SetBaggageItem(\"batch.id\", batchID) span.LogFields(opentracing_log.String(\"batch.id\", batchID)) // Let's try a task which throws panic to make sure stack trace is not lost asyncResult, err = server.SendTaskWithContext(ctx, \u0026panicTask) if err != nil { return fmt.Errorf(\"Could not send task: %s\", err.Error()) } _, err = asyncResult.Get(time.Duration(time.Millisecond * 5)) if err == nil { return errors.New(\"Error should not be nil if task panicked\") } log.INFO.Printf(\"Task panicked and returned error = %v\\n\", err.Error()) // Let's try a long running task  asyncResult, err = server.SendTaskWithContext(ctx, \u0026longRunningTask) if err != nil { return fmt.Errorf(\"Could not send task: %s\", err.Error()) } results, err = asyncResult.Get(time.Duration(time.Millisecond * 5)) if err != nil { return fmt.Errorf(\"Getting long running task result failed with error: %s\", err.Error() } log.INFO.Printf(\"Long running task returned = %v\\n\", tasks.HumanReadableResults(results)) return nil   参考:https://github.com/RichardKnop/machinery\n",
  "wordCount" : "5720",
  "inLanguage": "zh-cn",
  "datePublished": "2019-10-16T21:09:01Z",
  "dateModified": "2019-10-16T21:09:01Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97machinery%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      异步任务队列:machinery使用方法
    </h1>
    <div class="post-meta">October 16, 2019
</div>
  </header> 
  <div class="post-content"><h1 id="config">Config<a hidden class="anchor" aria-hidden="true" href="#config">#</a></h1>
<p>machinery的配置结构体是config包中的Config类型,具体结构如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Config holds all configuration for our program
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Broker</span>          <span class="kt">string</span>           <span class="s">`yaml:&#34;broker&#34; envconfig:&#34;BROKER&#34;`</span>
	<span class="nx">DefaultQueue</span>    <span class="kt">string</span>           <span class="s">`yaml:&#34;default_queue&#34; envconfig:&#34;DEFAULT_QUEUE&#34;`</span>
	<span class="nx">ResultBackend</span>   <span class="kt">string</span>           <span class="s">`yaml:&#34;result_backend&#34; envconfig:&#34;RESULT_BACKEND&#34;`</span>
	<span class="nx">ResultsExpireIn</span> <span class="kt">int</span>              <span class="s">`yaml:&#34;results_expire_in&#34; envconfig:&#34;RESULTS_EXPIRE_IN&#34;`</span>
	<span class="nx">AMQP</span>            <span class="o">*</span><span class="nx">AMQPConfig</span>      <span class="s">`yaml:&#34;amqp&#34;`</span>
	<span class="nx">SQS</span>             <span class="o">*</span><span class="nx">SQSConfig</span>       <span class="s">`yaml:&#34;sqs&#34;`</span>
	<span class="nx">Redis</span>           <span class="o">*</span><span class="nx">RedisConfig</span>     <span class="s">`yaml:&#34;redis&#34;`</span>
	<span class="nx">GCPPubSub</span>       <span class="o">*</span><span class="nx">GCPPubSubConfig</span> <span class="s">`yaml:&#34;-&#34; ignored:&#34;true&#34;`</span>
	<span class="nx">MongoDB</span>         <span class="o">*</span><span class="nx">MongoDBConfig</span>   <span class="s">`yaml:&#34;-&#34; ignored:&#34;true&#34;`</span>
	<span class="nx">TLSConfig</span>       <span class="o">*</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span>
	<span class="c1">// NoUnixSignals - when set disables signal handling in machinery
</span><span class="c1"></span>	<span class="nx">NoUnixSignals</span> <span class="kt">bool</span>            <span class="s">`yaml:&#34;no_unix_signals&#34; envconfig:&#34;NO_UNIX_SIGNALS&#34;`</span>
	<span class="nx">DynamoDB</span>      <span class="o">*</span><span class="nx">DynamoDBConfig</span> <span class="s">`yaml:&#34;dynamodb&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>machinery具有用于从环境变量或YAML文件加载构造方便的方法。,例如，从环境变量加载配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cnf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">NewFromEnvironment</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>或从YAML文件加载：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cnf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">config</span><span class="p">.</span><span class="nf">NewFromYaml</span><span class="p">(</span><span class="s">&#34;config.yml&#34;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>第二个布尔值标志允许每10秒实时重新加载配置。使用false禁用重新加载。</p>
<p>machinery的配置由Config结构封装，并作为对需要它的对象的依赖项注入。</p>
<p>举例:config.yaml配置如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">broker</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;redis://localhost:6379&#39;</span><span class="w">
</span><span class="w"></span><span class="c">#broker: &#39;redis://localhost:6379&#39;</span><span class="w">
</span><span class="w"></span><span class="c">#broker: &#39;https://sqs.us-west-2.amazonaws.com/123456789012&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">default_queue</span><span class="p">:</span><span class="w"> </span><span class="l">machinery_tasks</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">result_backend</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;redis://localhost:6379&#39;</span><span class="w">
</span><span class="w"></span><span class="c">#result_backend: &#39;memcache://localhost:11211&#39;</span><span class="w">
</span><span class="w"></span><span class="c">#result_backend: &#39;mongodb://localhost:27017&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">results_expire_in</span><span class="p">:</span><span class="w"> </span><span class="m">3600000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="broker">broker<a hidden class="anchor" aria-hidden="true" href="#broker">#</a></h2>
<p>消息代理。</p>
<h3 id="amqp">AMQP<a hidden class="anchor" aria-hidden="true" href="#amqp">#</a></h3>
<p>使用以下格式的AMQP URL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">amqp</span><span class="p">:</span><span class="c1">//[username:password@]@host[:port]
</span></code></pre></td></tr></table>
</div>
</div><p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">amqp</span><span class="p">:</span><span class="c1">//guest:guest@localhost:5672
</span></code></pre></td></tr></table>
</div>
</div><h3 id="redis">Redis<a hidden class="anchor" aria-hidden="true" href="#redis">#</a></h3>
<p>使用以下格式之一的Redis URL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">redis</span><span class="p">:</span><span class="c1">//[password@]host[port][/db_num]
</span><span class="c1"></span><span class="nx">redis</span><span class="o">+</span><span class="nx">socket</span><span class="p">:</span><span class="c1">//[password@]/path/to/file.sock[:/db_num]
</span></code></pre></td></tr></table>
</div>
</div><p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">redis</span><span class="p">:</span><span class="c1">//localhost:6379, or with password redis://password@localhost:6379
</span><span class="c1"></span><span class="nx">redis</span><span class="o">+</span><span class="nx">socket</span><span class="p">:</span><span class="c1">//password@/path/to/file.sock:/0
</span></code></pre></td></tr></table>
</div>
</div><h2 id="default_queue">default_queue<a hidden class="anchor" aria-hidden="true" href="#default_queue">#</a></h2>
<p>默认队列名称，例如machinery_tasks。</p>
<h2 id="result_backend">result_backend<a hidden class="anchor" aria-hidden="true" href="#result_backend">#</a></h2>
<p>后端，用于保留任务状态和结果。</p>
<h3 id="redis-1">Redis<a hidden class="anchor" aria-hidden="true" href="#redis-1">#</a></h3>
<p>使用以下格式之一的Redis URL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">redis</span><span class="p">:</span><span class="c1">//[password@]host[port][/db_num]
</span><span class="c1"></span><span class="nx">redis</span><span class="o">+</span><span class="nx">socket</span><span class="p">:</span><span class="c1">//[password@]/path/to/file.sock[:/db_num]
</span></code></pre></td></tr></table>
</div>
</div><p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">redis</span><span class="p">:</span><span class="c1">//localhost:6379, or with password redis://password@localhost:6379
</span><span class="c1"></span><span class="nx">redis</span><span class="o">+</span><span class="nx">socket</span><span class="p">:</span><span class="c1">//password@/path/to/file.sock:/0
</span><span class="c1"></span><span class="nx">cluster</span> <span class="nx">redis</span><span class="p">:</span><span class="c1">//host1:port1,host2:port2,host3:port3
</span></code></pre></td></tr></table>
</div>
</div><h3 id="memcache">Memcache<a hidden class="anchor" aria-hidden="true" href="#memcache">#</a></h3>
<p>使用以下格式的Memcache URL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">memcache</span><span class="p">:</span><span class="c1">//host1[:port1][,host2[:port2],...[,hostN[:portN]]]
</span></code></pre></td></tr></table>
</div>
</div><p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">memcache</span><span class="p">:</span><span class="c1">//localhost:11211 for a single instance, or
</span><span class="c1"></span><span class="nx">memcache</span><span class="p">:</span><span class="c1">//10.0.0.1:11211,10.0.0.2:11211 for a cluster
</span></code></pre></td></tr></table>
</div>
</div><h3 id="amqp-1">AMQP<a hidden class="anchor" aria-hidden="true" href="#amqp-1">#</a></h3>
<p>使用以下格式的AMQP URL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">amqp</span><span class="p">:</span><span class="c1">//[username:password@]@host[:port]
</span></code></pre></td></tr></table>
</div>
</div><p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">amqp</span><span class="p">:</span><span class="c1">//guest:guest@localhost:5672
</span></code></pre></td></tr></table>
</div>
</div><p>请记住，不建议将AMQP作为后端。原因见下文.</p>
<h3 id="mongodb">MongoDB<a hidden class="anchor" aria-hidden="true" href="#mongodb">#</a></h3>
<p>使用以下格式的Mongodb URL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">mongodb</span><span class="p">:</span><span class="c1">//[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]
</span></code></pre></td></tr></table>
</div>
</div><p>例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">mongodb</span><span class="p">:</span><span class="c1">//localhost:27017/taskresults
</span></code></pre></td></tr></table>
</div>
</div><p>有关更多信息，请参见MongoDB文档。</p>
<h2 id="results_expire_in">results_expire_in<a hidden class="anchor" aria-hidden="true" href="#results_expire_in">#</a></h2>
<p>任务结果存储多长时间（以秒为单位）。默认为3600（1小时）。</p>
<h3 id="amqp-2">AMQP<a hidden class="anchor" aria-hidden="true" href="#amqp-2">#</a></h3>
<p>RabbitMQ相关的配置。如果您正在使用其他代理/后端，则没有必要。</p>
<ul>
<li>Exchange：交换名称，例如 machinery_exchange</li>
<li>ExchangeType：交换类型，例如 direct</li>
<li>QueueBindingArguments：绑定到AMQP队列时使用的附加参数的可选映射</li>
<li>BindingKey：使用此密钥将队列绑定到交换，例如 machinery_task</li>
<li>PrefetchCount：要预取多少个任务（1如果您有长期运行的任务，则设置为）</li>
</ul>
<h1 id="server">Server<a hidden class="anchor" aria-hidden="true" href="#server">#</a></h1>
<p>Machinery必须在使用前实例化。完成此操作的方法是创建一个Server实例。Server是存储Machinery配置和已注册任务的基础对象。</p>
<p>server基本结构如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Server</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">config</span>            <span class="o">*</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span>
	<span class="nx">registeredTasks</span>   <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="nx">broker</span>            <span class="nx">brokersiface</span><span class="p">.</span><span class="nx">Broker</span>
	<span class="nx">backend</span>           <span class="nx">backendsiface</span><span class="p">.</span><span class="nx">Backend</span>
	<span class="nx">prePublishHandler</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="存储配置">存储配置<a hidden class="anchor" aria-hidden="true" href="#存储配置">#</a></h2>
<p>server例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;github.com/RichardKnop/machinery/v1/config&#34;</span>
  <span class="s">&#34;github.com/RichardKnop/machinery/v1&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">cnf</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
  <span class="nx">Broker</span><span class="p">:</span>             <span class="s">&#34;amqp://guest:guest@localhost:5672/&#34;</span><span class="p">,</span>
  <span class="nx">DefaultQueue</span><span class="p">:</span>       <span class="s">&#34;machinery_tasks&#34;</span><span class="p">,</span>
  <span class="nx">ResultBackend</span><span class="p">:</span>      <span class="s">&#34;amqp://guest:guest@localhost:5672/&#34;</span><span class="p">,</span>
  <span class="nx">AMQP</span><span class="p">:</span>               <span class="o">&amp;</span><span class="nx">config</span><span class="p">.</span><span class="nx">AMQPConfig</span><span class="p">{</span>
    <span class="nx">Exchange</span><span class="p">:</span>     <span class="s">&#34;machinery_exchange&#34;</span><span class="p">,</span>
    <span class="nx">ExchangeType</span><span class="p">:</span> <span class="s">&#34;direct&#34;</span><span class="p">,</span>
    <span class="nx">BindingKey</span><span class="p">:</span>   <span class="s">&#34;machinery_task&#34;</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">}</span>

<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">machinery</span><span class="p">.</span><span class="nf">NewServer</span><span class="p">(</span><span class="nx">cnf</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="c1">// do something with the error
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="注册任务">注册任务<a hidden class="anchor" aria-hidden="true" href="#注册任务">#</a></h2>
<p>注册任务名和对应的执行函数,下面有更详细的解释.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Register tasks
</span><span class="c1"></span><span class="nx">tasks</span> <span class="o">:=</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
	<span class="s">&#34;add&#34;</span><span class="p">:</span>               <span class="nx">exampletasks</span><span class="p">.</span><span class="nx">Add</span><span class="p">,</span>
	<span class="s">&#34;multiply&#34;</span><span class="p">:</span>          <span class="nx">exampletasks</span><span class="p">.</span><span class="nx">Multiply</span><span class="p">,</span>
	<span class="s">&#34;sum_ints&#34;</span><span class="p">:</span>          <span class="nx">exampletasks</span><span class="p">.</span><span class="nx">SumInts</span><span class="p">,</span>
	<span class="s">&#34;sum_floats&#34;</span><span class="p">:</span>        <span class="nx">exampletasks</span><span class="p">.</span><span class="nx">SumFloats</span><span class="p">,</span>
	<span class="s">&#34;concat&#34;</span><span class="p">:</span>            <span class="nx">exampletasks</span><span class="p">.</span><span class="nx">Concat</span><span class="p">,</span>
	<span class="s">&#34;split&#34;</span><span class="p">:</span>             <span class="nx">exampletasks</span><span class="p">.</span><span class="nx">Split</span><span class="p">,</span>
	<span class="s">&#34;panic_task&#34;</span><span class="p">:</span>        <span class="nx">exampletasks</span><span class="p">.</span><span class="nx">PanicTask</span><span class="p">,</span>
	<span class="s">&#34;long_running_task&#34;</span><span class="p">:</span> <span class="nx">exampletasks</span><span class="p">.</span><span class="nx">LongRunningTask</span><span class="p">,</span>
<span class="p">}</span>

<span class="nx">err</span><span class="o">:=</span><span class="nx">server</span><span class="p">.</span><span class="nf">RegisterTasks</span><span class="p">(</span><span class="nx">tasks</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="c1">// do something with the error
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="worker">Worker<a hidden class="anchor" aria-hidden="true" href="#worker">#</a></h1>
<h2 id="注册worker">注册worker<a hidden class="anchor" aria-hidden="true" href="#注册worker">#</a></h2>
<p>为了消费任务，您需要让一个或多个workers运行。</p>
<p>worker结构体信息如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Worker represents a single worker process
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Worker</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">server</span>          <span class="o">*</span><span class="nx">Server</span>
	<span class="nx">ConsumerTag</span>     <span class="kt">string</span>
	<span class="nx">Concurrency</span>     <span class="kt">int</span>
	<span class="nx">Queue</span>           <span class="kt">string</span>
	<span class="nx">errorHandler</span>    <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span>
	<span class="nx">preTaskHandler</span>  <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">)</span>
	<span class="nx">postTaskHandler</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>你需要利用server创建一个worker实例来运行并注册worker,例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">worker</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">NewWorker</span><span class="p">(</span><span class="s">&#34;worker_name&#34;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>每个worker将只消费注册的任务。对于队列中的每个任务，Worker.Process()方法将在goroutine中运行。</p>
<p>第一个参数是消费者标签,理想情况下，每个worker都应该有一个唯一的标签（worker1，worker2等）</p>
<p>使用的第二个参数server.NewWorker来限制同时运行的Worker.Process()调用的数量（每个worker）。例如:1将序列化任务执行，而0将使并发执行的任务数不受限制（默认）。</p>
<h2 id="添加handler">添加Handler<a hidden class="anchor" aria-hidden="true" href="#添加handler">#</a></h2>
<p>可以为任务开始和结束时添加hook,也可以做错误处理.</p>
<p>当任务返回错误时，默认行为是首先尝试重试该任务（如果可重试），否则记录该错误，然后最终调用任何错误回调。</p>
<p>要对此进行自定义，可以在worker上设置一个自定义的错误处理程序，它不仅可以执行重试失败且触发了错误回调后的日志记录，还可以做更多的事情:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">//这里，我们注入了一些用于错误处理的自定义代码，还有任务开始和结束的钩子
</span><span class="c1"></span><span class="nx">errorhandler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;I am an error handler:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">pretaskhandler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">signature</span> <span class="o">*</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;I am a start of task handler for:&#34;</span><span class="p">,</span> <span class="nx">signature</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">posttaskhandler</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">signature</span> <span class="o">*</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;I am an end of task handler for:&#34;</span><span class="p">,</span> <span class="nx">signature</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">worker</span><span class="p">.</span><span class="nf">SetPostTaskHandler</span><span class="p">(</span><span class="nx">posttaskhandler</span><span class="p">)</span>
<span class="nx">worker</span><span class="p">.</span><span class="nf">SetErrorHandler</span><span class="p">(</span><span class="nx">errorhandler</span><span class="p">)</span>
<span class="nx">worker</span><span class="p">.</span><span class="nf">SetPreTaskHandler</span><span class="p">(</span><span class="nx">pretaskhandler</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="执行worker">执行worker<a hidden class="anchor" aria-hidden="true" href="#执行worker">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">worker</span><span class="p">.</span><span class="nf">Launch</span><span class="p">()</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="c1">// do something with the error
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="task">Task<a hidden class="anchor" aria-hidden="true" href="#task">#</a></h1>
<p>Task是machinery的基础概念。Tasks的本质是一个传参和返回值有规定的function，它定义了当worker收到消息时会发生什么。</p>
<p>每个task都需要返回一个错误作为最后的返回值。除了错误，现在还可以返回任意数量的参数。</p>
<p>顾泽task规则的示例function如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Add ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">args</span> <span class="o">...</span><span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">sum</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">arg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">args</span> <span class="p">{</span>
		<span class="nx">sum</span> <span class="o">+=</span> <span class="nx">arg</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">sum</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Multiply ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Multiply</span><span class="p">(</span><span class="nx">args</span> <span class="o">...</span><span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">sum</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">arg</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">args</span> <span class="p">{</span>
		<span class="nx">sum</span> <span class="o">*=</span> <span class="nx">arg</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">sum</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// SumInts ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SumInts</span><span class="p">(</span><span class="nx">numbers</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">sum</span> <span class="kt">int64</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">num</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">numbers</span> <span class="p">{</span>
		<span class="nx">sum</span> <span class="o">+=</span> <span class="nx">num</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">sum</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// SumFloats ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SumFloats</span><span class="p">(</span><span class="nx">numbers</span> <span class="p">[]</span><span class="kt">float64</span><span class="p">)</span> <span class="p">(</span><span class="kt">float64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">sum</span> <span class="kt">float64</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">num</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">numbers</span> <span class="p">{</span>
		<span class="nx">sum</span> <span class="o">+=</span> <span class="nx">num</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">sum</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Concat ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Concat</span><span class="p">(</span><span class="nx">strs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">res</span> <span class="kt">string</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">strs</span> <span class="p">{</span>
		<span class="nx">res</span> <span class="o">+=</span> <span class="nx">s</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">res</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Split ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Split</span><span class="p">(</span><span class="nx">str</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">),</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// PanicTask ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">PanicTask</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;oops&#34;</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// LongRunningTask ...
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">LongRunningTask</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Long running task started&#34;</span><span class="p">)</span>
	<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="nx">i</span><span class="p">)</span>
		<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;Long running task finished&#34;</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="注册task">注册task<a hidden class="anchor" aria-hidden="true" href="#注册task">#</a></h2>
<p>在您的worker可以使用任务之前，您需要在服务器上注册它。这可以通过为任务分配唯一的名称来完成：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">server</span><span class="p">.</span><span class="nf">RegisterTasks</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
  <span class="s">&#34;add&#34;</span><span class="p">:</span>      <span class="nx">Add</span><span class="p">,</span>
  <span class="s">&#34;multiply&#34;</span><span class="p">:</span> <span class="nx">Multiply</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>任务也可以一一注册：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">server</span><span class="p">.</span><span class="nf">RegisterTask</span><span class="p">(</span><span class="s">&#34;add&#34;</span><span class="p">,</span> <span class="nx">Add</span><span class="p">)</span>
<span class="nx">server</span><span class="p">.</span><span class="nf">RegisterTask</span><span class="p">(</span><span class="s">&#34;multiply&#34;</span><span class="p">,</span> <span class="nx">Multiply</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>简而言之，当一个work收到这样的消息时：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;UUID&#34;</span><span class="p">:</span> <span class="s2">&#34;48760a1a-8576-4536-973b-da09048c2ac5&#34;</span><span class="p">,</span>
  <span class="nt">&#34;Name&#34;</span><span class="p">:</span> <span class="s2">&#34;add&#34;</span><span class="p">,</span>
  <span class="nt">&#34;RoutingKey&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;ETA&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&#34;GroupUUID&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;GroupTaskCount&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;Args&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;int64&#34;</span><span class="p">,</span>
      <span class="nt">&#34;Value&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;int64&#34;</span><span class="p">,</span>
      <span class="nt">&#34;Value&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">],</span>
  <span class="nt">&#34;Immutable&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nt">&#34;RetryCount&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;RetryTimeout&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;OnSuccess&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&#34;OnError&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
  <span class="nt">&#34;ChordCallback&#34;</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>它将调用<code>Add(1，1)</code>。每个task也应该返回一个错误，以便我们处理失败。</p>
<p>理想情况下，task应该是幂等的，这意味着当使用相同的参数多次调用task时，不会有意外的后果。</p>
<h2 id="signature">Signature<a hidden class="anchor" aria-hidden="true" href="#signature">#</a></h2>
<h3 id="基本类型">基本类型<a hidden class="anchor" aria-hidden="true" href="#基本类型">#</a></h3>
<p>Signature 包装了task的调用参数，执行选项（例如immutability）和 success/error 回调，因此可以通过网络将其发送给worker。 Task signature 实现了一个简单的interface：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Arg represents a single argument passed to invocation fo a task
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Arg</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Type</span>  <span class="kt">string</span>
  <span class="nx">Value</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// Headers represents the headers which should be used to direct the task
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Headers</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>

<span class="c1">// Signature represents a single task invocation
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Signature</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">UUID</span>           <span class="kt">string</span>
	<span class="nx">Name</span>           <span class="kt">string</span>
	<span class="nx">RoutingKey</span>     <span class="kt">string</span>
	<span class="nx">ETA</span>            <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
	<span class="nx">GroupUUID</span>      <span class="kt">string</span>
	<span class="nx">GroupTaskCount</span> <span class="kt">int</span>
	<span class="nx">Args</span>           <span class="p">[]</span><span class="nx">Arg</span>
	<span class="nx">Headers</span>        <span class="nx">Headers</span>
	<span class="nx">Priority</span>       <span class="kt">uint8</span>
	<span class="nx">Immutable</span>      <span class="kt">bool</span>
	<span class="nx">RetryCount</span>     <span class="kt">int</span>
	<span class="nx">RetryTimeout</span>   <span class="kt">int</span>
	<span class="nx">OnSuccess</span>      <span class="p">[]</span><span class="o">*</span><span class="nx">Signature</span>
	<span class="nx">OnError</span>        <span class="p">[]</span><span class="o">*</span><span class="nx">Signature</span>
	<span class="nx">ChordCallback</span>  <span class="o">*</span><span class="nx">Signature</span>
	<span class="c1">//MessageGroupId for Broker, e.g. SQS
</span><span class="c1"></span>	<span class="nx">BrokerMessageGroupId</span> <span class="kt">string</span>
	<span class="c1">//ReceiptHandle of SQS Message
</span><span class="c1"></span>	<span class="nx">SQSReceiptHandle</span> <span class="kt">string</span>
	<span class="c1">// StopTaskDeletionOnError used with sqs when we want to send failed messages to dlq, 
</span><span class="c1"></span>  <span class="c1">// and don&#39;t want machinery to delete from source queue
</span><span class="c1"></span>	<span class="nx">StopTaskDeletionOnError</span> <span class="kt">bool</span>
	<span class="c1">// IgnoreWhenTaskNotRegistered auto removes the request when there is no handeler available
</span><span class="c1"></span>	<span class="c1">// When this is true a task with no handler will be ignored and not placed back in the queue
</span><span class="c1"></span>	<span class="nx">IgnoreWhenTaskNotRegistered</span> <span class="kt">bool</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>UUID，任务的unique ID，可以主动设定也可以由系统自行设定；</li>
<li>Name，任务的名称，用于识别任务；</li>
<li>RoutingKey，根据这个key，用于将任务扔到一个正确的队列中；</li>
<li>ETA，专用于延时任务，若该参数为nil，说明需要立即将该任务扔给worker，否则，在参数数值到来之前，该任务将一直delay；</li>
<li>GroupUUID和GroupTaskCount，用于workflow中的Group分组任务创建</li>
<li>Args，任务传递给worker时的参数列表</li>
<li>Headers，用于tracing</li>
<li>RetryCount和RetryTimeout，用于实现任务的重试机制</li>
<li>Immutable，该参数可以控制任务之间是否需要参数传递</li>
<li>OnSuccess和OnError，实现回调，workflow中的链式任务（chain），就是通过OnSuccess来实现链式调度</li>
<li>ChordCallback，workflow中的chord模式，在group内所有任务全部执行完成后，进行callback。</li>
</ul>
<p>在将tasks发送到broker之前，Machinery将task编码为JSON。task结果也作为JSON编码的字符串存储在后端。因此，Signature仅支持具有JSON表示形式的类型。当前支持的类型是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kt">bool</span>
<span class="kt">int</span>
<span class="kt">int8</span>
<span class="kt">int16</span>
<span class="kt">int32</span>
<span class="kt">int64</span>
<span class="kt">uint</span>
<span class="kt">uint8</span>
<span class="kt">uint16</span>
<span class="kt">uint32</span>
<span class="kt">uint64</span>
<span class="kt">float32</span>
<span class="kt">float64</span>
<span class="kt">string</span>
<span class="p">[]</span><span class="kt">bool</span>
<span class="p">[]</span><span class="kt">int</span>
<span class="p">[]</span><span class="kt">int8</span>
<span class="p">[]</span><span class="kt">int16</span>
<span class="p">[]</span><span class="kt">int32</span>
<span class="p">[]</span><span class="kt">int64</span>
<span class="p">[]</span><span class="kt">uint</span>
<span class="p">[]</span><span class="kt">uint8</span>
<span class="p">[]</span><span class="kt">uint16</span>
<span class="p">[]</span><span class="kt">uint32</span>
<span class="p">[]</span><span class="kt">uint64</span>
<span class="p">[]</span><span class="kt">float32</span>
<span class="p">[]</span><span class="kt">float64</span>
<span class="p">[]</span><span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="示例代码">示例代码<a hidden class="anchor" aria-hidden="true" href="#示例代码">#</a></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
	<span class="nx">addTask0</span><span class="p">,</span> <span class="nx">addTask1</span><span class="p">,</span> <span class="nx">addTask2</span>                      <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span>
	<span class="nx">multiplyTask0</span><span class="p">,</span> <span class="nx">multiplyTask1</span>                      <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span>
	<span class="nx">sumIntsTask</span><span class="p">,</span> <span class="nx">sumFloatsTask</span><span class="p">,</span> <span class="nx">concatTask</span><span class="p">,</span> <span class="nx">splitTask</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span>
	<span class="nx">panicTask</span>                                         <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span>
	<span class="nx">longRunningTask</span>                                   <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span>
<span class="p">)</span>

<span class="nx">addTask0</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;add&#34;</span><span class="p">,</span>
	<span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Arg</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;int64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;int64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">}</span>
<span class="nx">addTask1</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;add&#34;</span><span class="p">,</span>
	<span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Arg</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;int64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;int64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">}</span>
<span class="nx">addTask2</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;add&#34;</span><span class="p">,</span>
	<span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Arg</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;int64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;int64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">}</span>
<span class="nx">multiplyTask0</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;multiply&#34;</span><span class="p">,</span>
	<span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Arg</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;int64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">}</span>
<span class="nx">multiplyTask1</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;multiply&#34;</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">sumIntsTask</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;sum_ints&#34;</span><span class="p">,</span>
	<span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Arg</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;[]int64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">}</span>
<span class="nx">sumFloatsTask</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;sum_floats&#34;</span><span class="p">,</span>
	<span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Arg</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;[]float64&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="kt">float64</span><span class="p">{</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">},</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">}</span>
<span class="nx">concatTask</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;concat&#34;</span><span class="p">,</span>
	<span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Arg</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;[]string&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;foo&#34;</span><span class="p">,</span> <span class="s">&#34;bar&#34;</span><span class="p">},</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">}</span>
<span class="nx">splitTask</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;split&#34;</span><span class="p">,</span>
	<span class="nx">Args</span><span class="p">:</span> <span class="p">[]</span><span class="nx">tasks</span><span class="p">.</span><span class="nx">Arg</span><span class="p">{</span>
		<span class="p">{</span>
			<span class="nx">Type</span><span class="p">:</span>  <span class="s">&#34;string&#34;</span><span class="p">,</span>
			<span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;foo&#34;</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">}</span>
<span class="nx">panicTask</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;panic_task&#34;</span><span class="p">,</span>
<span class="p">}</span>
<span class="nx">longRunningTask</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nx">Signature</span><span class="p">{</span>
	<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;long_running_task&#34;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="设置参数">设置参数<a hidden class="anchor" aria-hidden="true" href="#设置参数">#</a></h3>
<h4 id="延迟">延迟<a hidden class="anchor" aria-hidden="true" href="#延迟">#</a></h4>
<p>您可以通过ETA在Signature 上设置时间戳字段来延迟任务。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Delay the task by 5 seconds
</span><span class="c1"></span><span class="nx">eta</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">UTC</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<span class="nx">signature</span><span class="p">.</span><span class="nx">ETA</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">eta</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="重试">重试<a hidden class="anchor" aria-hidden="true" href="#重试">#</a></h4>
<p>您可以设置多个重试尝试，然后再将任务声明为失败。Fibonacci序列将用于随着时间间隔重试请求。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// If the task fails, retry it up to 3 times
</span><span class="c1"></span><span class="nx">signature</span><span class="p">.</span><span class="nx">RetryCount</span> <span class="p">=</span> <span class="mi">3</span>
</code></pre></td></tr></table>
</div>
</div><p>或者，您可以从任务中返回tasks.ErrRetryTaskLater并指定应重试任务的持续时间，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">return</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">NewErrRetryTaskLater</span><span class="p">(</span><span class="s">&#34;some error&#34;</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="发送task">发送task<a hidden class="anchor" aria-hidden="true" href="#发送task">#</a></h2>
<h3 id="single">Single<a hidden class="anchor" aria-hidden="true" href="#single">#</a></h3>
<p>task可以通过Server的sendtask实例调用。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">	<span class="nx">asyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendTaskWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addTask0</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send task: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting task result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;1 + 1 = %v\n&#34;</span><span class="p">,</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResults</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>

	<span class="cm">/*
</span><span class="cm">	* Try couple of tasks with a slice argument and slice return value
</span><span class="cm">	*/</span>
	<span class="nx">asyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendTaskWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sumIntsTask</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send task: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting task result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;sum([1, 2]) = %v\n&#34;</span><span class="p">,</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResults</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>

	<span class="nx">asyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendTaskWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sumFloatsTask</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send task: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting task result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;sum([1.5, 2.7]) = %v\n&#34;</span><span class="p">,</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResults</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>

	<span class="nx">asyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendTaskWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">concatTask</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send task: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting task result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;concat([\&#34;foo\&#34;, \&#34;bar\&#34;]) = %v\n&#34;</span><span class="p">,</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResults</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>

	<span class="nx">asyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendTaskWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">splitTask</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send task: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>

	<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting task result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;split([\&#34;foo\&#34;]) = %v\n&#34;</span><span class="p">,</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResults</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>

</code></pre></td></tr></table>
</div>
</div><p>tasks.HumanReadableResults返回string类型.</p>
<h3 id="workflows">Workflows<a hidden class="anchor" aria-hidden="true" href="#workflows">#</a></h3>
<p>运行单个异步任务很好，但是通常您会想要设计一种以协调方式执行的任务工作流。有几个有用的功能可以帮助您设计工作流程。</p>
<h4 id="group">Group<a hidden class="anchor" aria-hidden="true" href="#group">#</a></h4>
<p>Group 是一组将彼此独立执行的并行任务。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">group</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">NewGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">addTask0</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addTask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addTask2</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error creating group: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">asyncResults</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendGroupWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="c1">//The second parameter specifies the number of concurrent sending tasks. 0 means unlimited.
</span><span class="c1"></span><span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send group: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">asyncResult</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">asyncResults</span> <span class="p">{</span>
	<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting task result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
	<span class="p">}</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span>
		<span class="s">&#34;%v + %v = %v\n&#34;</span><span class="p">,</span>
		<span class="nx">asyncResult</span><span class="p">.</span><span class="nx">Signature</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Value</span><span class="p">,</span>
		<span class="nx">asyncResult</span><span class="p">.</span><span class="nx">Signature</span><span class="p">.</span><span class="nx">Args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">Value</span><span class="p">,</span>
		<span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResults</span><span class="p">(</span><span class="nx">results</span><span class="p">),</span>
	<span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>SendGroup返回AsyncResult对象的切片。因此，您可以进行阻塞调用并等待组任务的结果</p>
<h4 id="chord">Chord<a hidden class="anchor" aria-hidden="true" href="#chord">#</a></h4>
<p>Chord允许您定义要在组中的所有任务完成处理之后执行的回调，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">group</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">NewGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">addTask0</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addTask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addTask2</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error creating group: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">chord</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">NewChord</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">multiplyTask1</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error creating chord: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">chordAsyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendChordWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">chord</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send chord: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">chordAsyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting chord result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;(1 + 1) * (2 + 2) * (5 + 6) = %v\n&#34;</span><span class="p">,</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResults</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>

</code></pre></td></tr></table>
</div>
</div><p>上面的示例并行执行&amp;addTask0, &amp;addTask1, &amp;addTask2，将其结果汇总并将其传递给&amp;multiplyTask1。因此，最终将发生的是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">(1 + 1) * (2 + 2) * (5 + 6) 
</code></pre></td></tr></table>
</div>
</div><h4 id="chain">Chain<a hidden class="anchor" aria-hidden="true" href="#chain">#</a></h4>
<p>Chain只是一组将逐个执行的任务，每个成功的任务都会触发链中的下一个任务。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">chain</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">NewChain</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">addTask0</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addTask1</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">addTask2</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">multiplyTask0</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Error creating chain: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">chainAsyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendChainWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">chain</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send chain: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">chainAsyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting chain result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;(((1 + 1) + (2 + 2)) + (5 + 6)) * 4 = %v\n&#34;</span><span class="p">,</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResult</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>

</code></pre></td></tr></table>
</div>
</div><p>上面的示例先执行task1，然后执行task2，再执行task3，将每个任务的结果传递给链中的下一个任务。因此，最终将发生的是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">(((1 + 1) + (2 + 2)) + (5 + 6)) * 4
</code></pre></td></tr></table>
</div>
</div><h2 id="获取待处理task">获取待处理task<a hidden class="anchor" aria-hidden="true" href="#获取待处理task">#</a></h2>
<p>可以检查队列中当前正在等待工作的任务，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">server</span><span class="p">.</span><span class="nf">GetBroker</span><span class="p">().</span><span class="nf">GetPendingTasks</span><span class="p">(</span><span class="s">&#34;some_queue&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>当前仅Redis broker支持。</p>
<h1 id="保存结果">保存结果<a hidden class="anchor" aria-hidden="true" href="#保存结果">#</a></h1>
<p>如果您配置result backend，则任务状态和结果将保留下来。可能的状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="p">(</span>
	<span class="c1">// StatePending - initial state of a task
</span><span class="c1"></span>	<span class="nx">StatePending</span> <span class="p">=</span> <span class="s">&#34;PENDING&#34;</span>
	<span class="c1">// StateReceived - when task is received by a worker
</span><span class="c1"></span>	<span class="nx">StateReceived</span> <span class="p">=</span> <span class="s">&#34;RECEIVED&#34;</span>
	<span class="c1">// StateStarted - when the worker starts processing the task
</span><span class="c1"></span>	<span class="nx">StateStarted</span> <span class="p">=</span> <span class="s">&#34;STARTED&#34;</span>
	<span class="c1">// StateRetry - when failed task has been scheduled for retry
</span><span class="c1"></span>	<span class="nx">StateRetry</span> <span class="p">=</span> <span class="s">&#34;RETRY&#34;</span>
	<span class="c1">// StateSuccess - when the task is processed successfully
</span><span class="c1"></span>	<span class="nx">StateSuccess</span> <span class="p">=</span> <span class="s">&#34;SUCCESS&#34;</span>
	<span class="c1">// StateFailure - when processing of the task fails
</span><span class="c1"></span>	<span class="nx">StateFailure</span> <span class="p">=</span> <span class="s">&#34;FAILURE&#34;</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>当将AMQP用作result backend时，任务状态将针对每个任务保留在单独的队列中。尽管RabbitMQ可以扩展到数千个队列，但强烈建议您在运行大量并行任务时使用更适合的result backend（例如Memcache）。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// TaskResult represents an actual return value of a processed task
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">TaskResult</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">Type</span>  <span class="kt">string</span>      <span class="s">`bson:&#34;type&#34;`</span>
  <span class="nx">Value</span> <span class="kd">interface</span><span class="p">{}</span> <span class="s">`bson:&#34;value&#34;`</span>
<span class="p">}</span>

<span class="c1">// TaskState represents a state of a task
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">TaskState</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">TaskUUID</span>  <span class="kt">string</span>        <span class="s">`bson:&#34;_id&#34;`</span>
  <span class="nx">State</span>     <span class="kt">string</span>        <span class="s">`bson:&#34;state&#34;`</span>
  <span class="nx">Results</span>   <span class="p">[]</span><span class="o">*</span><span class="nx">TaskResult</span> <span class="s">`bson:&#34;results&#34;`</span>
  <span class="nx">Error</span>     <span class="kt">string</span>        <span class="s">`bson:&#34;error&#34;`</span>
<span class="p">}</span>

<span class="c1">// GroupMeta stores useful metadata about tasks within the same group
</span><span class="c1">// E.g. UUIDs of all tasks which are used in order to check if all tasks
</span><span class="c1">// completed successfully or not and thus whether to trigger chord callback
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">GroupMeta</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">GroupUUID</span>      <span class="kt">string</span>   <span class="s">`bson:&#34;_id&#34;`</span>
  <span class="nx">TaskUUIDs</span>      <span class="p">[]</span><span class="kt">string</span> <span class="s">`bson:&#34;task_uuids&#34;`</span>
  <span class="nx">ChordTriggered</span> <span class="kt">bool</span>     <span class="s">`bson:&#34;chord_triggered&#34;`</span>
  <span class="nx">Lock</span>           <span class="kt">bool</span>     <span class="s">`bson:&#34;lock&#34;`</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>TaskResult 表示已处理任务的返回值的一部分。</p>
</li>
<li>
<p>TaskState 每次任务状态更改时，都会对struct进行序列化和存储。</p>
</li>
<li>
<p>GroupMeta存储有关同一组内任务的有用元数据。例如，用于检查所有任务是否成功完成以及是否触发和弦回调的所有任务的UUID。</p>
</li>
<li>
<p>AsyncResult 对象允许您检查任务的状态：</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">taskState</span> <span class="o">:=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">GetState</span><span class="p">()</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Current state of %v task is:\n&#34;</span><span class="p">,</span> <span class="nx">taskState</span><span class="p">.</span><span class="nx">TaskUUID</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">taskState</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>有几种方便的方法可以检查任务状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">asyncResult</span><span class="p">.</span><span class="nf">GetState</span><span class="p">().</span><span class="nf">IsCompleted</span><span class="p">()</span>
<span class="nx">asyncResult</span><span class="p">.</span><span class="nf">GetState</span><span class="p">().</span><span class="nf">IsSuccess</span><span class="p">()</span>
<span class="nx">asyncResult</span><span class="p">.</span><span class="nf">GetState</span><span class="p">().</span><span class="nf">IsFailure</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>您还可以进行同步阻塞调用以等待任务结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="c1">// getting result of a task failed
</span><span class="c1"></span>  <span class="c1">// do something with the error
</span><span class="c1"></span><span class="p">}</span>
<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">result</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">results</span> <span class="p">{</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nf">Interface</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="日志处理">日志处理<a hidden class="anchor" aria-hidden="true" href="#日志处理">#</a></h1>
<p>您可以通过实现以下接口来定义Custom Logger：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Interface</span> <span class="kd">interface</span> <span class="p">{</span>
  <span class="nf">Print</span><span class="p">(</span><span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nf">Printf</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nf">Println</span><span class="p">(</span><span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>

  <span class="nf">Fatal</span><span class="p">(</span><span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nf">Fatalf</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nf">Fatalln</span><span class="p">(</span><span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>

  <span class="nf">Panic</span><span class="p">(</span><span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nf">Panicf</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
  <span class="nf">Panicln</span><span class="p">(</span><span class="o">...</span><span class="kd">interface</span><span class="p">{})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后只需通过调用package中的log包里的set函数设置即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">log</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">myCustomLogger</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="tracing">Tracing<a hidden class="anchor" aria-hidden="true" href="#tracing">#</a></h1>
<p>work:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cleanup</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tracers</span><span class="p">.</span><span class="nf">SetupTracer</span><span class="p">(</span><span class="nx">consumerTag</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nx">FATAL</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="s">&#34;Unable to instantiate a tracer:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nf">cleanup</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>send:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="cm">/*
</span><span class="cm"> * Lets start a span representing this run of the `send` command and
</span><span class="cm"> * set a batch id as baggage so it can travel all the way into
</span><span class="cm"> * the worker functions.
</span><span class="cm"> */</span>
<span class="nx">span</span><span class="p">,</span> <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">opentracing</span><span class="p">.</span><span class="nf">StartSpanFromContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="s">&#34;send&#34;</span><span class="p">)</span>
<span class="k">defer</span> <span class="nx">span</span><span class="p">.</span><span class="nf">Finish</span><span class="p">()</span>
<span class="nx">batchID</span> <span class="o">:=</span> <span class="nx">uuid</span><span class="p">.</span><span class="nf">New</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
<span class="nx">span</span><span class="p">.</span><span class="nf">SetBaggageItem</span><span class="p">(</span><span class="s">&#34;batch.id&#34;</span><span class="p">,</span> <span class="nx">batchID</span><span class="p">)</span>
<span class="nx">span</span><span class="p">.</span><span class="nf">LogFields</span><span class="p">(</span><span class="nx">opentracing_log</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;batch.id&#34;</span><span class="p">,</span> <span class="nx">batchID</span><span class="p">))</span>

<span class="c1">// Let&#39;s try a task which throws panic to make sure stack trace is not lost
</span><span class="c1"></span><span class="nx">asyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendTaskWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">panicTask</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send task: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;Error should not be nil if task panicked&#34;</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Task panicked and returned error = %v\n&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="c1">// Let&#39;s try a long running task
</span><span class="c1"></span>
<span class="nx">asyncResult</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">server</span><span class="p">.</span><span class="nf">SendTaskWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">longRunningTask</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Could not send task: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
<span class="p">}</span>
<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">asyncResult</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Getting long running task result failed with error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span>
<span class="p">}</span>
<span class="nx">log</span><span class="p">.</span><span class="nx">INFO</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Long running task returned = %v\n&#34;</span><span class="p">,</span> <span class="nx">tasks</span><span class="p">.</span><span class="nf">HumanReadableResults</span><span class="p">(</span><span class="nx">results</span><span class="p">))</span>
<span class="k">return</span> <span class="kc">nil</span>
</code></pre></td></tr></table>
</div>
</div><p>参考:<a href="https://github.com/RichardKnop/machinery">https://github.com/RichardKnop/machinery</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/machinery/">machinery</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
