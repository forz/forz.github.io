<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>RmqClient源码分析 | Forz Blog</title>
<meta name="keywords" content="rocketmq" />
<meta name="description" content="前言 RmqClient是客户端各种类型的Consumer和Producer的底层类。这个类首先从NameServer获取并保存各种配置信息，">
<meta name="author" content="">
<link rel="canonical" href="/post/rmqclient%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="RmqClient源码分析" />
<meta property="og:description" content="前言 RmqClient是客户端各种类型的Consumer和Producer的底层类。这个类首先从NameServer获取并保存各种配置信息，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/rmqclient%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-04-23T15:43:10&#43;00:00" />
<meta property="article:modified_time" content="2020-04-23T15:43:10&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="RmqClient源码分析"/>
<meta name="twitter:description" content="前言 RmqClient是客户端各种类型的Consumer和Producer的底层类。这个类首先从NameServer获取并保存各种配置信息，"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "RmqClient源码分析",
      "item": "/post/rmqclient%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "RmqClient源码分析",
  "name": "RmqClient源码分析",
  "description": "前言 RmqClient是客户端各种类型的Consumer和Producer的底层类。这个类首先从NameServer获取并保存各种配置信息，",
  "keywords": [
    "rocketmq"
  ],
  "articleBody": "前言 RmqClient是客户端各种类型的Consumer和Producer的底层类。这个类首先从NameServer获取并保存各种配置信息，比如Topic的Route信息。同时RmqClient还会通过MQClientAPIImpl类实现消息的收发，也就是从Broker获取消息或者发送消息到Broker。\n创建 既然RmqClient实现的是底层通信功能和获取并保存元数据的功能，就没必要每个Consumer或Producer都创建一个对象，一个RmqClient对象可以被多个Consumer或Producer公用。RocketMQ通过一个工厂类达到共用RmqClient的目的。创建函数为func GetOrNewRocketMQClient(option ClientOptions, callbackCh chan interface{}) RMQClient \n注意, RmqClient是通过工厂类被创建的,并不是一个单例模式,有些情况下需要创建多个实例。首先来看看 RmqClient的创建规则.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94  func GetOrNewRocketMQClient(option ClientOptions, callbackCh chan interface{}) RMQClient { client := \u0026rmqClient{ option: option, remoteClient: remote.NewRemotingClient(), namesrvs: option.Namesrv, done: make(chan struct{}), } actual, loaded := clientMap.LoadOrStore(client.ClientID(), client) if !loaded { client.remoteClient.RegisterRequestFunc(ReqNotifyConsumerIdsChanged, func(req *remote.RemotingCommand, addr net.Addr) *remote.RemotingCommand { rlog.Info(\"receive broker's notification to consumer group\", map[string]interface{}{ rlog.LogKeyConsumerGroup: req.ExtFields[\"consumerGroup\"], }) client.RebalanceImmediately() return nil }) client.remoteClient.RegisterRequestFunc(ReqCheckTransactionState, func(req *remote.RemotingCommand, addr net.Addr) *remote.RemotingCommand { header := new(CheckTransactionStateRequestHeader) header.Decode(req.ExtFields) msgExts := primitive.DecodeMessage(req.Body) if len(msgExts) == 0 { rlog.Warning(\"checkTransactionState, decode message failed\", nil) return nil } msgExt := msgExts[0] // TODO: add namespace support \ttransactionID := msgExt.GetProperty(primitive.PropertyUniqueClientMessageIdKeyIndex) if len(transactionID)  0 { msgExt.TransactionId = transactionID } group := msgExt.GetProperty(primitive.PropertyProducerGroup) if group == \"\" { rlog.Warning(\"checkTransactionState, pick producer group failed\", nil) return nil } if option.GroupName != group { rlog.Warning(\"producer group is not equal\", nil) return nil } callback := \u0026CheckTransactionStateCallback{ Addr: addr, Msg: msgExt, Header: *header, } callbackCh  callback return nil }) client.remoteClient.RegisterRequestFunc(ReqGetConsumerRunningInfo, func(req *remote.RemotingCommand, addr net.Addr) *remote.RemotingCommand { rlog.Info(\"receive get consumer running info request...\", nil) header := new(GetConsumerRunningInfoHeader) header.Decode(req.ExtFields) val, exist := clientMap.Load(header.clientID) res := remote.NewRemotingCommand(ResError, nil, nil) if !exist { res.Remark = fmt.Sprintf(\"Can't find specified client instance of: %s\", header.clientID) } else { cli, ok := val.(*rmqClient) var runningInfo *ConsumerRunningInfo if ok { runningInfo = cli.getConsumerRunningInfo(header.consumerGroup) } if runningInfo != nil { res.Code = ResSuccess data, err := runningInfo.Encode() if err != nil { res.Remark = fmt.Sprintf(\"json marshal error: %s\", err.Error()) } else { res.Body = data } } else { res.Remark = \"there is unexpected error when get running info, please check log\" } } return res }) } return actual.(*rmqClient) } func (c *rmqClient) ClientID() string { id := c.option.ClientIP + \"@\" if c.option.InstanceName == \"DEFAULT\" { id += strconv.Itoa(os.Getpid()) } else { id += c.option.InstanceName } if c.option.UnitName != \"\" { id += \"@\" + c.option.UnitName } return id }   系统中维护了clientMap这个Map对象,每创建一个新的 MQClient,都会以 clientId作为Key放人Map结构中。 clientId的格式是“clientIP”+@+“Instancename”,其中 clientIP是客户端机器的IP地址,一般不会变,instancename有默认值,也可以被手动设置。\nclientId为客户端IP+instance+（unitname可选），如果在同一台物理服务器部署两个应用程序，应用程序岂不是clientId相同，会造成混乱？\n为了避免这个问题，如果instance为默认值DEFAULT的话，RocketMQ会自动将instance设置为进程ID，这样避免了不同进程的相互影响，但同一个进程中的不同消费者和不同生产者在启动时获取到的MQClientInstane实例都是同一个。\n普通情况下,一个用到RocketMQ客户端的程序,只要有一个RmqClient实例就够了。这时候创建一个或多个Consumer或者 Producer,底层使用的是同一个RmqClient实例\n创建一个 DefaultMQPushConsumer来接收消息,没有设置这个 Consumer的 InstanceName参数(通过 setInstancename函数进行设置),这个时候 InstanceName的值是默认的“DEFAULT”。实际创建的RmqClient个数由设定的逻辑进行控制。\n从 InstanceName的创建逻辑就可以看出,如果创建 Consumer或者 Producer类型的时候不手动指定 InstanceName,进程中只会有一个RmqClient对象。\n有些情况下只有一个RmqClient对象是不够的,比如一个程序需要连接两个RoceketMQ集群,从一个集群读取消息,发送到另一个集群,一个RmqClient对象无法支持这种场景。这种情况下一定要手动指定不同的InstanceName,底层会创建两个RmqClient对象。\n功能 首先来看一下 RmqClient的 Start函数,从Start函数中的逻辑能大致了解 RmqClient的功能.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130  func (c *rmqClient) Start() { //ctx, cancel := context.WithCancel(context.Background()) \t//c.cancel = cancel \tc.once.Do(func() { if !c.option.Credentials.IsEmpty() { c.remoteClient.RegisterInterceptor(remote.ACLInterceptor(c.option.Credentials)) } // fetchNameServerAddr \tif len(c.option.NameServerAddrs) == 0 { c.namesrvs.UpdateNameServerAddress(c.option.NameServerDomain, c.option.InstanceName) go primitive.WithRecover(func() { op := func() { c.namesrvs.UpdateNameServerAddress(c.option.NameServerDomain, c.option.InstanceName) } time.Sleep(10 * time.Second) op() ticker := time.NewTicker(2 * time.Minute) defer ticker.Stop() for { select { case ticker.C: op() case c.done: rlog.Info(\"The RMQClient stopping update name server domain info.\", map[string]interface{}{ \"clientID\": c.ClientID(), }) return } } }) } // schedule update route info \tgo primitive.WithRecover(func() { // delay \top := func() { c.UpdateTopicRouteInfo() } time.Sleep(10 * time.Millisecond) op() ticker := time.NewTicker(_PullNameServerInterval) defer ticker.Stop() for { select { case ticker.C: op() case c.done: rlog.Info(\"The RMQClient stopping update topic route info.\", map[string]interface{}{ \"clientID\": c.ClientID(), }) return } } }) go primitive.WithRecover(func() { op := func() { c.namesrvs.cleanOfflineBroker() c.SendHeartbeatToAllBrokerWithLock() } time.Sleep(time.Second) op() ticker := time.NewTicker(_HeartbeatBrokerInterval) defer ticker.Stop() for { select { case ticker.C: op() case c.done: rlog.Info(\"The RMQClient stopping clean off line broker and heart beat\", map[string]interface{}{ \"clientID\": c.ClientID(), }) return } } }) // schedule persist offset \tgo primitive.WithRecover(func() { op := func() { c.consumerMap.Range(func(key, value interface{}) bool { consumer := value.(InnerConsumer) err := consumer.PersistConsumerOffset() if err != nil { rlog.Error(\"persist offset failed\", map[string]interface{}{ rlog.LogKeyUnderlayError: err, }) } return true }) } time.Sleep(10 * time.Second) op() ticker := time.NewTicker(_PersistOffsetInterval) defer ticker.Stop() for { select { case ticker.C: op() case c.done: rlog.Info(\"The RMQClient stopping persist offset\", map[string]interface{}{ \"clientID\": c.ClientID(), }) return } } }) go primitive.WithRecover(func() { ticker := time.NewTicker(_RebalanceInterval) defer ticker.Stop() for { select { case ticker.C: c.RebalanceImmediately() case c.done: rlog.Info(\"The RMQClient stopping do rebalance\", map[string]interface{}{ \"clientID\": c.ClientID(), }) return } } }) }) }   RmqClient会定时进行如下几个操作：获取NameServer地址、更新TopicRoute信息、清理离线的Broker和保存消费者的Offset。\n",
  "wordCount" : "2125",
  "inLanguage": "zh-cn",
  "datePublished": "2020-04-23T15:43:10Z",
  "dateModified": "2020-04-23T15:43:10Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/rmqclient%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      RmqClient源码分析
    </h1>
    <div class="post-meta">April 23, 2020
</div>
  </header> 
  <div class="post-content"><h1 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h1>
<p>RmqClient是客户端各种类型的Consumer和Producer的底层类。这个类首先从NameServer获取并保存各种配置信息，比如Topic的Route信息。同时RmqClient还会通过MQClientAPIImpl类实现消息的收发，也就是从Broker获取消息或者发送消息到Broker。</p>
<h1 id="创建">创建<a hidden class="anchor" aria-hidden="true" href="#创建">#</a></h1>
<p>既然RmqClient实现的是底层通信功能和获取并保存元数据的功能，就没必要每个Consumer或Producer都创建一个对象，一个RmqClient对象可以被多个Consumer或Producer公用。RocketMQ通过一个工厂类达到共用RmqClient的目的。创建函数为<code>func GetOrNewRocketMQClient(option ClientOptions, callbackCh chan interface{}) RMQClient </code></p>
<p>注意, RmqClient是通过工厂类被创建的,并不是一个单例模式,有些情况下需要创建多个实例。首先来看看 RmqClient的创建规则.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">GetOrNewRocketMQClient</span><span class="p">(</span><span class="nx">option</span> <span class="nx">ClientOptions</span><span class="p">,</span> <span class="nx">callbackCh</span> <span class="kd">chan</span> <span class="kd">interface</span><span class="p">{})</span> <span class="nx">RMQClient</span> <span class="p">{</span>
	<span class="nx">client</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">rmqClient</span><span class="p">{</span>
		<span class="nx">option</span><span class="p">:</span>       <span class="nx">option</span><span class="p">,</span>
		<span class="nx">remoteClient</span><span class="p">:</span> <span class="nx">remote</span><span class="p">.</span><span class="nf">NewRemotingClient</span><span class="p">(),</span>
		<span class="nx">namesrvs</span><span class="p">:</span>     <span class="nx">option</span><span class="p">.</span><span class="nx">Namesrv</span><span class="p">,</span>
		<span class="nx">done</span><span class="p">:</span>         <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}),</span>
	<span class="p">}</span>
	<span class="nx">actual</span><span class="p">,</span> <span class="nx">loaded</span> <span class="o">:=</span> <span class="nx">clientMap</span><span class="p">.</span><span class="nf">LoadOrStore</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nf">ClientID</span><span class="p">(),</span> <span class="nx">client</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">loaded</span> <span class="p">{</span>
		<span class="nx">client</span><span class="p">.</span><span class="nx">remoteClient</span><span class="p">.</span><span class="nf">RegisterRequestFunc</span><span class="p">(</span><span class="nx">ReqNotifyConsumerIdsChanged</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">remote</span><span class="p">.</span><span class="nx">RemotingCommand</span><span class="p">,</span> <span class="nx">addr</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Addr</span><span class="p">)</span> <span class="o">*</span><span class="nx">remote</span><span class="p">.</span><span class="nx">RemotingCommand</span> <span class="p">{</span>
			<span class="nx">rlog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;receive broker&#39;s notification to consumer group&#34;</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
				<span class="nx">rlog</span><span class="p">.</span><span class="nx">LogKeyConsumerGroup</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ExtFields</span><span class="p">[</span><span class="s">&#34;consumerGroup&#34;</span><span class="p">],</span>
			<span class="p">})</span>
			<span class="nx">client</span><span class="p">.</span><span class="nf">RebalanceImmediately</span><span class="p">()</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">})</span>
		<span class="nx">client</span><span class="p">.</span><span class="nx">remoteClient</span><span class="p">.</span><span class="nf">RegisterRequestFunc</span><span class="p">(</span><span class="nx">ReqCheckTransactionState</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">remote</span><span class="p">.</span><span class="nx">RemotingCommand</span><span class="p">,</span> <span class="nx">addr</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Addr</span><span class="p">)</span> <span class="o">*</span><span class="nx">remote</span><span class="p">.</span><span class="nx">RemotingCommand</span> <span class="p">{</span>
			<span class="nx">header</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">CheckTransactionStateRequestHeader</span><span class="p">)</span>
			<span class="nx">header</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">ExtFields</span><span class="p">)</span>
			<span class="nx">msgExts</span> <span class="o">:=</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">DecodeMessage</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">msgExts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="nx">rlog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;checkTransactionState, decode message failed&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
				<span class="k">return</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="nx">msgExt</span> <span class="o">:=</span> <span class="nx">msgExts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			<span class="c1">// TODO: add namespace support
</span><span class="c1"></span>			<span class="nx">transactionID</span> <span class="o">:=</span> <span class="nx">msgExt</span><span class="p">.</span><span class="nf">GetProperty</span><span class="p">(</span><span class="nx">primitive</span><span class="p">.</span><span class="nx">PropertyUniqueClientMessageIdKeyIndex</span><span class="p">)</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">transactionID</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="nx">msgExt</span><span class="p">.</span><span class="nx">TransactionId</span> <span class="p">=</span> <span class="nx">transactionID</span>
			<span class="p">}</span>
			<span class="nx">group</span> <span class="o">:=</span> <span class="nx">msgExt</span><span class="p">.</span><span class="nf">GetProperty</span><span class="p">(</span><span class="nx">primitive</span><span class="p">.</span><span class="nx">PropertyProducerGroup</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">group</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
				<span class="nx">rlog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;checkTransactionState, pick producer group failed&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
				<span class="k">return</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">option</span><span class="p">.</span><span class="nx">GroupName</span> <span class="o">!=</span> <span class="nx">group</span> <span class="p">{</span>
				<span class="nx">rlog</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span><span class="s">&#34;producer group is not equal&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
				<span class="k">return</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="nx">callback</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">CheckTransactionStateCallback</span><span class="p">{</span>
				<span class="nx">Addr</span><span class="p">:</span>   <span class="nx">addr</span><span class="p">,</span>
				<span class="nx">Msg</span><span class="p">:</span>    <span class="nx">msgExt</span><span class="p">,</span>
				<span class="nx">Header</span><span class="p">:</span> <span class="o">*</span><span class="nx">header</span><span class="p">,</span>
			<span class="p">}</span>
			<span class="nx">callbackCh</span> <span class="o">&lt;-</span> <span class="nx">callback</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">})</span>

		<span class="nx">client</span><span class="p">.</span><span class="nx">remoteClient</span><span class="p">.</span><span class="nf">RegisterRequestFunc</span><span class="p">(</span><span class="nx">ReqGetConsumerRunningInfo</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">remote</span><span class="p">.</span><span class="nx">RemotingCommand</span><span class="p">,</span> <span class="nx">addr</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Addr</span><span class="p">)</span> <span class="o">*</span><span class="nx">remote</span><span class="p">.</span><span class="nx">RemotingCommand</span> <span class="p">{</span>
			<span class="nx">rlog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;receive get consumer running info request...&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
			<span class="nx">header</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">GetConsumerRunningInfoHeader</span><span class="p">)</span>
			<span class="nx">header</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">ExtFields</span><span class="p">)</span>
			<span class="nx">val</span><span class="p">,</span> <span class="nx">exist</span> <span class="o">:=</span> <span class="nx">clientMap</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nx">clientID</span><span class="p">)</span>
			<span class="nx">res</span> <span class="o">:=</span> <span class="nx">remote</span><span class="p">.</span><span class="nf">NewRemotingCommand</span><span class="p">(</span><span class="nx">ResError</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">!</span><span class="nx">exist</span> <span class="p">{</span>
				<span class="nx">res</span><span class="p">.</span><span class="nx">Remark</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Can&#39;t find specified client instance of: %s&#34;</span><span class="p">,</span> <span class="nx">header</span><span class="p">.</span><span class="nx">clientID</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">cli</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">val</span><span class="p">.(</span><span class="o">*</span><span class="nx">rmqClient</span><span class="p">)</span>
				<span class="kd">var</span> <span class="nx">runningInfo</span> <span class="o">*</span><span class="nx">ConsumerRunningInfo</span>
				<span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
					<span class="nx">runningInfo</span> <span class="p">=</span> <span class="nx">cli</span><span class="p">.</span><span class="nf">getConsumerRunningInfo</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nx">consumerGroup</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="nx">runningInfo</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">res</span><span class="p">.</span><span class="nx">Code</span> <span class="p">=</span> <span class="nx">ResSuccess</span>
					<span class="nx">data</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">runningInfo</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
					<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
						<span class="nx">res</span><span class="p">.</span><span class="nx">Remark</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;json marshal error: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="nx">res</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">data</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">res</span><span class="p">.</span><span class="nx">Remark</span> <span class="p">=</span> <span class="s">&#34;there is unexpected error when get running info, please check log&#34;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">res</span>
		<span class="p">})</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">actual</span><span class="p">.(</span><span class="o">*</span><span class="nx">rmqClient</span><span class="p">)</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">rmqClient</span><span class="p">)</span> <span class="nf">ClientID</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="nx">id</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">ClientIP</span> <span class="o">+</span> <span class="s">&#34;@&#34;</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">InstanceName</span> <span class="o">==</span> <span class="s">&#34;DEFAULT&#34;</span> <span class="p">{</span>
		<span class="nx">id</span> <span class="o">+=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">Itoa</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nf">Getpid</span><span class="p">())</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">id</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">InstanceName</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">UnitName</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
		<span class="nx">id</span> <span class="o">+=</span> <span class="s">&#34;@&#34;</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">UnitName</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">id</span>
<span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><p>系统中维护了clientMap这个Map对象,每创建一个新的 MQClient,都会以 clientId作为Key放人Map结构中。 clientId的格式是“clientIP”+@+“Instancename”,其中 clientIP是客户端机器的IP地址,一般不会变,instancename有默认值,也可以被手动设置。</p>
<p>clientId为客户端IP+instance+（unitname可选），如果在同一台物理服务器部署两个应用程序，应用程序岂不是clientId相同，会造成混乱？</p>
<p>为了避免这个问题，如果instance为默认值DEFAULT的话，RocketMQ会自动将instance设置为进程ID，这样避免了不同进程的相互影响，但同一个进程中的不同消费者和不同生产者在启动时获取到的MQClientInstane实例都是同一个。</p>
<p>普通情况下,一个用到RocketMQ客户端的程序,只要有一个RmqClient实例就够了。这时候创建一个或多个Consumer或者 Producer,底层使用的是同一个RmqClient实例</p>
<p>创建一个 DefaultMQPushConsumer来接收消息,没有设置这个 Consumer的 InstanceName参数(通过 setInstancename函数进行设置),这个时候 InstanceName的值是默认的“DEFAULT”。实际创建的RmqClient个数由设定的逻辑进行控制。</p>
<p>从 InstanceName的创建逻辑就可以看出,如果创建 Consumer或者 Producer类型的时候不手动指定 InstanceName,进程中只会有一个RmqClient对象。</p>
<p>有些情况下只有一个RmqClient对象是不够的,比如一个程序需要连接两个RoceketMQ集群,从一个集群读取消息,发送到另一个集群,一个RmqClient对象无法支持这种场景。这种情况下一定要手动指定不同的InstanceName,底层会创建两个RmqClient对象。</p>
<h1 id="功能">功能<a hidden class="anchor" aria-hidden="true" href="#功能">#</a></h1>
<p>首先来看一下 RmqClient的 Start函数,从Start函数中的逻辑能大致了解 RmqClient的功能.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">rmqClient</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">//ctx, cancel := context.WithCancel(context.Background())
</span><span class="c1"></span>	<span class="c1">//c.cancel = cancel
</span><span class="c1"></span>	<span class="nx">c</span><span class="p">.</span><span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">Credentials</span><span class="p">.</span><span class="nf">IsEmpty</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">remoteClient</span><span class="p">.</span><span class="nf">RegisterInterceptor</span><span class="p">(</span><span class="nx">remote</span><span class="p">.</span><span class="nf">ACLInterceptor</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">Credentials</span><span class="p">))</span>
		<span class="p">}</span>
		<span class="c1">// fetchNameServerAddr
</span><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">NameServerAddrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
			<span class="nx">c</span><span class="p">.</span><span class="nx">namesrvs</span><span class="p">.</span><span class="nf">UpdateNameServerAddress</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">NameServerDomain</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">InstanceName</span><span class="p">)</span>
			<span class="k">go</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">WithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">op</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
					<span class="nx">c</span><span class="p">.</span><span class="nx">namesrvs</span><span class="p">.</span><span class="nf">UpdateNameServerAddress</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">NameServerDomain</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">option</span><span class="p">.</span><span class="nx">InstanceName</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
				<span class="nf">op</span><span class="p">()</span>

				<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>
				<span class="k">defer</span> <span class="nx">ticker</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
				<span class="k">for</span> <span class="p">{</span>
					<span class="k">select</span> <span class="p">{</span>
					<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
						<span class="nf">op</span><span class="p">()</span>
					<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">done</span><span class="p">:</span>
						<span class="nx">rlog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;The RMQClient stopping update name server domain info.&#34;</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
							<span class="s">&#34;clientID&#34;</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ClientID</span><span class="p">(),</span>
						<span class="p">})</span>
						<span class="k">return</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">})</span>
		<span class="p">}</span>

		<span class="c1">// schedule update route info
</span><span class="c1"></span>		<span class="k">go</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">WithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="c1">// delay
</span><span class="c1"></span>			<span class="nx">op</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">c</span><span class="p">.</span><span class="nf">UpdateTopicRouteInfo</span><span class="p">()</span>
			<span class="p">}</span>
			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
			<span class="nf">op</span><span class="p">()</span>

			<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">_PullNameServerInterval</span><span class="p">)</span>
			<span class="k">defer</span> <span class="nx">ticker</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
			<span class="k">for</span> <span class="p">{</span>
				<span class="k">select</span> <span class="p">{</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
					<span class="nf">op</span><span class="p">()</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">done</span><span class="p">:</span>
					<span class="nx">rlog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;The RMQClient stopping update topic route info.&#34;</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
						<span class="s">&#34;clientID&#34;</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ClientID</span><span class="p">(),</span>
					<span class="p">})</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">})</span>

		<span class="k">go</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">WithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">op</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">c</span><span class="p">.</span><span class="nx">namesrvs</span><span class="p">.</span><span class="nf">cleanOfflineBroker</span><span class="p">()</span>
				<span class="nx">c</span><span class="p">.</span><span class="nf">SendHeartbeatToAllBrokerWithLock</span><span class="p">()</span>
			<span class="p">}</span>

			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
			<span class="nf">op</span><span class="p">()</span>

			<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">_HeartbeatBrokerInterval</span><span class="p">)</span>
			<span class="k">defer</span> <span class="nx">ticker</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
			<span class="k">for</span> <span class="p">{</span>
				<span class="k">select</span> <span class="p">{</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
					<span class="nf">op</span><span class="p">()</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">done</span><span class="p">:</span>
					<span class="nx">rlog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;The RMQClient stopping clean off line broker and heart beat&#34;</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
						<span class="s">&#34;clientID&#34;</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ClientID</span><span class="p">(),</span>
					<span class="p">})</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">})</span>

		<span class="c1">// schedule persist offset
</span><span class="c1"></span>		<span class="k">go</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">WithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">op</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
				<span class="nx">c</span><span class="p">.</span><span class="nx">consumerMap</span><span class="p">.</span><span class="nf">Range</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kt">bool</span> <span class="p">{</span>
					<span class="nx">consumer</span> <span class="o">:=</span> <span class="nx">value</span><span class="p">.(</span><span class="nx">InnerConsumer</span><span class="p">)</span>
					<span class="nx">err</span> <span class="o">:=</span> <span class="nx">consumer</span><span class="p">.</span><span class="nf">PersistConsumerOffset</span><span class="p">()</span>
					<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
						<span class="nx">rlog</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;persist offset failed&#34;</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
							<span class="nx">rlog</span><span class="p">.</span><span class="nx">LogKeyUnderlayError</span><span class="p">:</span> <span class="nx">err</span><span class="p">,</span>
						<span class="p">})</span>
					<span class="p">}</span>
					<span class="k">return</span> <span class="kc">true</span>
				<span class="p">})</span>
			<span class="p">}</span>
			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
			<span class="nf">op</span><span class="p">()</span>

			<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">_PersistOffsetInterval</span><span class="p">)</span>
			<span class="k">defer</span> <span class="nx">ticker</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
			<span class="k">for</span> <span class="p">{</span>
				<span class="k">select</span> <span class="p">{</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
					<span class="nf">op</span><span class="p">()</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">done</span><span class="p">:</span>
					<span class="nx">rlog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;The RMQClient stopping persist offset&#34;</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
						<span class="s">&#34;clientID&#34;</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ClientID</span><span class="p">(),</span>
					<span class="p">})</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">})</span>

		<span class="k">go</span> <span class="nx">primitive</span><span class="p">.</span><span class="nf">WithRecover</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">ticker</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">_RebalanceInterval</span><span class="p">)</span>
			<span class="k">defer</span> <span class="nx">ticker</span><span class="p">.</span><span class="nf">Stop</span><span class="p">()</span>
			<span class="k">for</span> <span class="p">{</span>
				<span class="k">select</span> <span class="p">{</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
					<span class="nx">c</span><span class="p">.</span><span class="nf">RebalanceImmediately</span><span class="p">()</span>
				<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">.</span><span class="nx">done</span><span class="p">:</span>
					<span class="nx">rlog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;The RMQClient stopping do rebalance&#34;</span><span class="p">,</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}{</span>
						<span class="s">&#34;clientID&#34;</span><span class="p">:</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ClientID</span><span class="p">(),</span>
					<span class="p">})</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">})</span>
	<span class="p">})</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>RmqClient会定时进行如下几个操作：获取NameServer地址、更新TopicRoute信息、清理离线的Broker和保存消费者的Offset。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/rocketmq/">rocketmq</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
