<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go如何嵌入静态资源 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author"
  content="Forz" /><meta name="description" content="背景 Go 中一个常被吹捧的特性是 Go 应用容易部署，原因是 Go 写的程序是静态编译的。但在你 运行一个 Web 应用时，如果需要管理一系列文件的路径和权限的话，这" /><meta name="keywords"
  content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.55.6 with theme even" />


<link rel="canonical" href="/post/go%E5%A6%82%E4%BD%95%E5%B5%8C%E5%85%A5%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link rel="stylesheet" href="/css/search.css" />


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Go如何嵌入静态资源" />
<meta property="og:description" content="背景 Go 中一个常被吹捧的特性是 Go 应用容易部署，原因是 Go 写的程序是静态编译的。但在你 运行一个 Web 应用时，如果需要管理一系列文件的路径和权限的话，这" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/go%E5%A6%82%E4%BD%95%E5%B5%8C%E5%85%A5%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90/" />
<meta property="article:published_time" content="2019-10-11T16:54:16&#43;00:00"/>
<meta property="article:modified_time" content="2019-10-11T16:54:16&#43;00:00"/>

<meta itemprop="name" content="Go如何嵌入静态资源">
<meta itemprop="description" content="背景 Go 中一个常被吹捧的特性是 Go 应用容易部署，原因是 Go 写的程序是静态编译的。但在你 运行一个 Web 应用时，如果需要管理一系列文件的路径和权限的话，这">


<meta itemprop="datePublished" content="2019-10-11T16:54:16&#43;00:00" />
<meta itemprop="dateModified" content="2019-10-11T16:54:16&#43;00:00" />
<meta itemprop="wordCount" content="5188">



<meta itemprop="keywords" content="vfsgen,packr," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go如何嵌入静态资源"/>
<meta name="twitter:description" content="背景 Go 中一个常被吹捧的特性是 Go 应用容易部署，原因是 Go 写的程序是静态编译的。但在你 运行一个 Web 应用时，如果需要管理一系列文件的路径和权限的话，这"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="clearfix">
  <div class="logo-wrapper">
    <a href="/" class="logo">Forz Blog</a>
  </div>

  <nav class="site-navbar">
    <ul id="menu" class="menu">
      <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
    </ul>
  </nav>
</div>


<div class="search-container">
  <div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..."
        name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path
            d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/algoliasearch.min.js"></script>
<script
    src="https://res.cloudinary.com/jimmysong/raw/upload/rootsongjc-hugo/autocomplete.min.js"></script>
<script>
    var client = algoliasearch("IAR2EF5L65", "b4b9da2eba53aa6dabe4b8ac9e8676e1");
    var index = client.initIndex('forz.forzvina.com');
    autocomplete('#aa-search-input',
        { hint: false }, {
        source: autocomplete.sources.hits(index, { hitsPerPage: 8 }),
        displayKey: 'name',
        templates: {
            suggestion: function (suggestion) {
                var reg = /([A-Z]+)/ig
                var title = suggestion.uri.replace(reg, function (m) {
                    return m.toLowerCase()
                })
                return '<span class="search-item">' + '<a href="\/' + title + '">' +
                    suggestion._highlightResult.title.value + '</a></span>';
            }
        }
    });
</script>
</div>


    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go如何嵌入静态资源</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-10-11 </span>
        <div class="post-category">
            <a href="/categories/go/"> Go </a>
            </div>
          <span class="more-meta"> 约 5188 字 </span>
          <span class="more-meta"> 预计阅读 11 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#背景">背景</a></li>
<li><a href="#第三方库的选择">第三方库的选择</a>
<ul>
<li><a href="#判断标准">判断标准</a>
<ul>
<li><a href="#压缩">压缩</a></li>
<li><a href="#可选解压缩">可选解压缩</a></li>
<li><a href="#从本地文件系统加载">从本地文件系统加载</a></li>
<li><a href="#可重现的构建">可重现的构建</a></li>
<li><a href="#附加的标准">附加的标准</a>
<ul>
<li><a href="#配置文件">配置文件</a></li>
<li><a href="#http-filesystem-接口">http.FileSystem 接口</a></li>
<li><a href="#github-超过-200-星">GitHub 超过 200 星</a></li>
</ul></li>
</ul></li>
<li><a href="#对比">对比</a></li>
</ul></li>
<li><a href="#vfsgen">vfsgen</a>
<ul>
<li><a href="#go-generate-用法">go generate 用法</a></li>
<li><a href="#vfsgendev-用法">vfsgendev 用法</a></li>
<li><a href="#其他嵌入式信息">其他嵌入式信息</a></li>
</ul></li>
<li><a href="#packr">packr</a>
<ul>
<li><a href="#代码">代码</a></li>
<li><a href="#什么是box">什么是box？</a>
<ul>
<li><a href="#例">例</a></li>
</ul></li>
<li><a href="#开发变得容易">开发变得容易</a></li>
<li><a href="#http的用法">HTTP的用法</a></li>
<li><a href="#建立一个二进制文件">建立一个二进制文件</a></li>
<li><a href="#实现go-generate">实现go generate</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="背景">背景</h1>

<p>Go 中一个常被吹捧的特性是 Go 应用容易部署，原因是 Go 写的程序是静态编译的。但在你 运行一个 Web 应用时，如果需要管理一系列文件的路径和权限的话，这个优势就基本不复存在了。</p>

<p>解决方法是把必要的文件编译到应用二进制里去。在 Go 中可以用字节切片存放文件中 String literals 形式的字节内容。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">fileData</span> <span class="o">:=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;\x1f\x8b\ ... \x0f\x00\x00&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>但这种方法最大的几个坏处是：</p>

<ul>
<li>更大的二进制文件
对我当前的项目 Lex Library 而言，在没嵌入静态文件之前， 可执行文件大小为 20MB，嵌入后为 21MB。</li>
<li>更长的编译时间
最新 Go 编译器的缓存机制能有效减少构建时间。</li>
<li>编译时更占内存
如果你在用小内存的设备开发，这会影响到你。但对我个人来说，还无需关心。</li>
</ul>

<p>你需要在开发效率和运维管理时间上作取舍。如果你的应用受众是普罗大众（或者是那些有 个人网上应用的极客用户），就更值得权衡利弊了。</p>

<h1 id="第三方库的选择">第三方库的选择</h1>

<p>第一个处理 Go 嵌入静态文件的库，或者说第一个真正知名的，应该是 jteeuwen 的 Go-BinData。 这是个命令行应用，你输入一个文件路径，它会生成包含静态文件的 .go 文件。</p>

<p>然而，作者 jteeuwen 似乎离开了星球，并在走时候把 GitHub 上这个仓库中所有东西删了。 幸运的是，他的代码是开源的，并在社区被广泛 fork。你在 GitHub 能找到好几个维护得很好的 fork。 我起初选的 fork 是 shuLhan 的，但后来又选了别的方案，原因下面会讲。</p>

<p>既然 jteewen 的库有很多很多替代品。下面是我搜索并整理的一个不完全列表：</p>

<ul>
<li>vfsgen - <a href="https://github.com/shurcooL/vfsgen">https://github.com/shurcooL/vfsgen</a></li>
<li>go.rice - <a href="https://github.com/GeertJohan/go.rice">https://github.com/GeertJohan/go.rice</a></li>
<li>statik - <a href="https://github.com/rakyll/statik">https://github.com/rakyll/statik</a></li>
<li>esc - <a href="https://github.com/mjibson/esc">https://github.com/mjibson/esc</a></li>
<li>go-embed - <a href="https://github.com/pyros2097/go-embed">https://github.com/pyros2097/go-embed</a></li>
<li>go-resources - <a href="https://github.com/omeid/go-resources">https://github.com/omeid/go-resources</a></li>
<li>packr - <a href="https://github.com/gobuffalo/packr">https://github.com/gobuffalo/packr</a></li>
<li>statics - <a href="https://github.com/go-playground/statics">https://github.com/go-playground/statics</a></li>
<li>templify - <a href="https://github.com/wlbr/templify">https://github.com/wlbr/templify</a></li>
<li>gnoso/go-bindata - <a href="https://github.com/gnoso/go-bindata">https://github.com/gnoso/go-bindata</a></li>
<li>shuLhan/go-bindata - <a href="https://github.com/shuLhan/go-bindata">https://github.com/shuLhan/go-bindata</a></li>
<li>fileb0x - <a href="https://github.com/UnnoTed/fileb0x">https://github.com/UnnoTed/fileb0x</a></li>
<li>gobundle - <a href="https://github.com/alecthomas/gobundle">https://github.com/alecthomas/gobundle</a></li>
<li>parcello - <a href="https://github.com/phogolabs/parcello">https://github.com/phogolabs/parcello</a></li>
</ul>

<p>有了这么多选项，当决定要用哪一个才最适合需求时，就让人头大。你的程序和我的可能不一样， 但如果是 Web 应用的话，那会有很多可借鉴的地方。如果你需要做同样的选择，下文的比较将会很有用。</p>

<h2 id="判断标准">判断标准</h2>

<h3 id="压缩">压缩</h3>

<p>上文提到的，嵌入静态文件一个缺点是增加了可执行文件大小。你可以在嵌入静态文件之前， 用一个库去压缩，这样能减少一些空间。同时也需要花点小功夫去解压缩，但这通常是值得的， 因为除了节省空间外，构建时内存占用量也会减少。此外，网页静态文件压缩率较高（相比 图片），这就是为什么大多数浏览器支持 gzip 压缩的原因。这就引入了下一个标准。</p>

<h3 id="可选解压缩">可选解压缩</h3>

<p>如果你的可执行文件中存有 gzip 压缩的静态文件，并且你想把这些文件按 gzip 格式提供 给客户端，那为何不直接发送这些已经压缩的文件呢？理想的库应该支持一个选项，让你在运行时去设定直接接受压缩后的文件，而不需要先解压。</p>

<h3 id="从本地文件系统加载">从本地文件系统加载</h3>

<p>在你开发 Web 应用时，在你修改代码与看到改变之间，任何增加了时间或困难的事都应该 被避免。如果在你每次修改 CSS 或 HTML 代码时，都必须重新构建 Go 程序来静态嵌入文件， 你很快（就会放弃并）会选别的方案。</p>

<p>理想的库应该允许我们轻松切换开发中构建的程序，从本地快速加载静态文件；在生产中，静态 文件已经嵌入可执行程序并准备好发布了。</p>

<h3 id="可重现的构建">可重现的构建</h3>

<p>这个准则让我很意外，在我着手开发 Lex Library 时，我起初都没有考虑过。 前面提到的，我第一个选择的库是 shuLhan fork 的 go-bindata。 我选择它主要是因为我对原始的 go-bindata 库熟悉，而且这个 fork 看起来维护得很好。</p>

<p>这个库用起来很赞，不过出乎意料的事，我的持续集成（CI）构建开始失败。像每一位碰到测试失败 的开发者一样，我想到的是改动了什么。我立刻去检查最新提交的改动，并试着弄明白为什么 这些改动导致模版处理失败。在我困惑一阵后，并没有找到原因，于是我重新跑了一次测试套件， 这次测试是基于最后一次构建成功的代码的，但也失败了。这说明改动在于环境，而不是我的代码。 不过这引出了更多了问题。</p>

<p>我是在 Docker 容器中跑持续集成测试的。测试环境应该是自我包好的、崭新的并且可复现的。 但我的假设并不正确。在我看 Dockerfile 时，找到了问题所在：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">RUN</span> <span class="k">go</span> <span class="nx">get</span> <span class="o">-</span><span class="nx">u</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">shuLhan</span><span class="o">/</span><span class="k">go</span><span class="o">-</span><span class="nx">bindata</span><span class="o">/...</span></code></pre></td></tr></table>
</div>
</div>
<p>库 go-bindata 有一次小的更新，这影响了我传静态文件路径的过程。突然间我嵌入的文件路径 就和我的预期不一样了。这可能怪一些因素，比如 go get 总是获取默认的分支。最后， 归结为这样简单的事实：程序中生成代码的模块版本没有被确定并让我的 git 仓库追踪。程序依赖的 外部代码如果改动了，就会在不知不觉时，导致我的构建或测试失败。</p>

<p>一种解决办法是存个预先编译的 go-bindata 可执行文件到我的 git 项目中，但是：</p>

<ul>
<li>通常 git 仓库中不宜存二进制文件。</li>
<li>如果依赖的库修复了漏洞，我每次都需要手动更新 go-bindata。</li>
<li>如果换一个平台，将会使构建变得困难。</li>
</ul>

<p>此外，我找到了一个无需独立二进制文件的库，完全依赖代码版本，这可以用 vendor 来管理。 意思是有一个支持 go-generate 的库，但不同的是，不需要依赖外部程序运行。</p>

<h3 id="附加的标准">附加的标准</h3>

<p>上文讲你可能有不同的需求，所以在我的下面的对比表中，还添加了一些额外的标准，这或许对你有用。</p>

<h4 id="配置文件">配置文件</h4>

<p>如果你有大量不同的目录和文件需要管理，使用配置文件并放到你的源码里，这样管理就轻松多了。</p>

<h4 id="http-filesystem-接口">http.FileSystem 接口</h4>

<p>实现 http.FileSystem 接口的库能让嵌入文件更容易处理。</p>

<h4 id="github-超过-200-星">GitHub 超过 200 星</h4>

<p>这有点武断，星数不一定是衡量代码质量的方法。不过项目星数能说明库的活跃性，起码能说明是不是 一个在多处被引用的库。这反过来也说明很多人都在测试它，和（或）反馈问题。我选的库， 仅仅超过了这个星数，注意一下。</p>

<h2 id="对比">对比</h2>

<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20191011172215.jpg" alt="" /></p>

<h1 id="vfsgen">vfsgen</h1>

<p>软件包vfsgen接受一个http.FileSystem（可能在某个go generate时间）并生成Go代码，该代码静态地实现了所提供的http.FileSystem。</p>

<p>特征：
* 高效生成的代码，没有不必要的开销。
* 内部使用gzip压缩（有选择地，仅用于压缩效果良好的文件）。
* 允许通过可选接口直接访问内部gzip压缩字节。
* 输出经过go fmt的Go代码。</p>

<p>用法:</p>

<p>包vfsgen是一个Go代码生成器库。它拥有Generate功能,能接受输入的filesystem（作为http.FileSystem类型）并生成Go代码文件，该文件静态实现输入的filesystem的内容。</p>

<p>例如，我们可以将http.Dir用作http.FileSystem</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">fs</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileSystem</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="s">&#34;/path/to/assets&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>现在，当您执行以下代码时：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="o">:=</span> <span class="nx">vfsgen</span><span class="p">.</span><span class="nf">Generate</span><span class="p">(</span><span class="nx">fs</span><span class="p">,</span> <span class="nx">vfsgen</span><span class="p">.</span><span class="nx">Options</span><span class="p">{})</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>assets_vfsdata.go 文件将在当前目录中生成：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Code generated by vfsgen; DO NOT EDIT.
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="o">...</span>

<span class="c1">// assets statically implements the virtual filesystem provided to vfsgen.Generate.
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">assets</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileSystem</span> <span class="p">=</span> <span class="o">...</span></code></pre></td></tr></table>
</div>
</div>
<p>然后，在您的程序中，您可以将其assets用作任何其他http.FileSystem，例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">file</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">assets</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="s">&#34;/some/file.txt&#34;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">file</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>

<span class="nx">http</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/assets/&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">FileServer</span><span class="p">(</span><span class="nx">assets</span><span class="p">))</span></code></pre></td></tr></table>
</div>
</div>
<p>vfsgen与build tags和go generate结合使用时可能会更有用。下面我们介绍一下.</p>

<h2 id="go-generate-用法">go generate 用法</h2>

<p>vfsgen非常适合与go generate指令一起使用。vfsgen.Generate的调用可以放在assets_generate.go文件中，然后可以通过“ // go：generate go run asset_generate.go”调用该文件。输入虚拟filesystem可以直接从磁盘读取，也可以涉及更多内容。</p>

<p>通过使用build tags，您可以创建一种开发模式，在该开发模式中，通过可以直接从磁盘加载文件http.Dir，然后为最终发行版静态加载文件。</p>

<p>例如，假设您的源filesystem是在导入路径为“ example.com/project/data”</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +build dev
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">data</span>

<span class="kn">import</span> <span class="s">&#34;net/http&#34;</span>

<span class="c1">// Assets contains project assets.
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">Assets</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileSystem</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="s">&#34;assets&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>当使用“dev”构建标记构建时，访问data.Assets将直接通过从磁盘读取http.Dir。</p>

<p>generate帮助文件assets_generate.go可以通过&rdquo;//go:generate go run -tags=dev assets_generate.go&rdquo;被引导:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +build ignore
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;log&#34;</span>

	<span class="s">&#34;example.com/project/data&#34;</span>
	<span class="s">&#34;github.com/shurcooL/vfsgen&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">vfsgen</span><span class="p">.</span><span class="nf">Generate</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">Assets</span><span class="p">,</span> <span class="nx">vfsgen</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
		<span class="nx">PackageName</span><span class="p">:</span>  <span class="s">&#34;data&#34;</span><span class="p">,</span>
		<span class="nx">BuildTags</span><span class="p">:</span>    <span class="s">&#34;!dev&#34;</span><span class="p">,</span>
		<span class="nx">VariableName</span><span class="p">:</span> <span class="s">&#34;Assets&#34;</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>请注意，“ dev”构建标记用于访问源filesystem，并且输出文件将包含“！dev” build tag。当未指定自定义build tag时，将使用静态构建的版本。</p>

<h2 id="vfsgendev-用法">vfsgendev 用法</h2>

<p>vfsgendev 是一个二进制文件，可用于替换assets_generate.go文件的需求。</p>

<p>确保它已安装并且在您的PATH中可用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">get</span> <span class="o">-</span><span class="nx">u</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">shurcooL</span><span class="o">/</span><span class="nx">vfsgen</span><span class="o">/</span><span class="nx">cmd</span><span class="o">/</span><span class="nx">vfsgendev</span></code></pre></td></tr></table>
</div>
</div>
<p>然后，可以将“ // go：generate go run -tags = dev asset_generate.go”指令替换为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="o">//</span><span class="k">go</span><span class="p">:</span><span class="nx">generate</span> <span class="nx">vfsgendev</span> <span class="o">-</span><span class="nx">source</span><span class="p">=</span><span class="s">&#34;example.com/project/data&#34;</span><span class="p">.</span><span class="nx">Assets</span></code></pre></td></tr></table>
</div>
</div>
<p>vfsgendev使用“dev”构建标记访问源变量，并使用“！dev”构建标记生成输出文件。</p>

<h2 id="其他嵌入式信息">其他嵌入式信息</h2>

<p>所有压缩文件都实现了httpgzip.GzipByter接口，可以有效地直接访问内部压缩字节：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// GzipByter is implemented by compressed files for
</span><span class="c1">// efficient direct access to the internal compressed bytes.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">GzipByter</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// GzipBytes returns gzip compressed contents of the file.
</span><span class="c1"></span>	<span class="nf">GzipBytes</span><span class="p">()</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>确定不值得进行gzip压缩的文件（压缩后的大小大于原始文件）实现httpgzip.NotWorthGzipCompressing接口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// NotWorthGzipCompressing is implemented by files that were determined
</span><span class="c1">// not to be worth gzip compressing (the file size did not decrease as a result).
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">NotWorthGzipCompressing</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// NotWorthGzipCompressing is a noop. It&#39;s implemented in order to indicate
</span><span class="c1"></span>	<span class="c1">// the file is not worth gzip compressing.
</span><span class="c1"></span>	<span class="nf">NotWorthGzipCompressing</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h1 id="packr">packr</h1>

<h2 id="代码">代码</h2>

<p>使用Packr的第一步是创建一个新box。一个box代表磁盘上的文件夹。拥有一个box后，您可以获取string或[]byte表示文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// set up a new box by giving it a name and an optional (relative) path to a folder on disk:
</span><span class="c1"></span><span class="nx">box</span> <span class="o">:=</span> <span class="nx">packr</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;My Box&#34;</span><span class="p">,</span> <span class="s">&#34;./templates&#34;</span><span class="p">)</span>

<span class="c1">// Get the string representation of a file, or an error if it doesn&#39;t exist:
</span><span class="c1"></span><span class="nx">html</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">box</span><span class="p">.</span><span class="nf">FindString</span><span class="p">(</span><span class="s">&#34;index.html&#34;</span><span class="p">)</span>

<span class="c1">// Get the []byte representation of a file, or an error if it doesn&#39;t exist:
</span><span class="c1"></span><span class="nx">html</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">box</span><span class="p">.</span><span class="nf">Find</span><span class="p">(</span><span class="s">&#34;index.html&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>注意,New()函数中的第一个参数不能是数字和字符串的组合,也不能是两个字符串的拼接,也不能是传入的字符串参数,否则无法通过<code>packr</code>生成二进制文件.最好是字符串常量.</p>

<p>如下使用方式为错误示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">box</span> <span class="o">:=</span> <span class="nx">packr</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;1&#34;</span><span class="o">+</span><span class="s">&#34;dsf&#34;</span><span class="p">,</span> <span class="s">&#34;./templates&#34;</span><span class="p">)</span>
<span class="nx">box</span> <span class="o">:=</span> <span class="nx">packr</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;abc&#34;</span><span class="o">+</span><span class="s">&#34;dsf&#34;</span><span class="p">,</span> <span class="s">&#34;./templates&#34;</span><span class="p">)</span>

<span class="kd">func</span> <span class="nf">Generate</span><span class="p">(</span><span class="nx">moduleName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">box</span> <span class="o">:=</span> <span class="nx">packr</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">moduleName</span><span class="p">,</span> <span class="s">&#34;./templates&#34;</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="什么是box">什么是box？</h2>

<p>一个box代表您要在二进制文件中访问的磁盘上的文件夹以及所有子文件夹。使用packr2CLI 编译二进制文件时，文件夹的内容将转换为Go文件，这些文件可以在“标准” go二进制文件内进行编译。在已编译的二进制文件内部，将从内存中读取文件。在本地工作时，将直接从磁盘读取文件。这是一个无缝的开关，不需要您特别注意。</p>

<h3 id="例">例</h3>

<p>假定以下目录结构：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">├──</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
<span class="err">└──</span> <span class="nx">templates</span>
    <span class="err">├──</span> <span class="nx">admin</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="nx">index</span><span class="p">.</span><span class="nx">html</span>
    <span class="err">└──</span> <span class="nx">index</span><span class="p">.</span><span class="nx">html</span></code></pre></td></tr></table>
</div>
</div>
<p>以下程序将读取./templates/admin/index.html文件并打印出来。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>

  <span class="s">&#34;github.com/gobuffalo/packr/v2&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">box</span> <span class="o">:=</span> <span class="nx">packr</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;myBox&#34;</span><span class="p">,</span> <span class="s">&#34;./templates&#34;</span><span class="p">)</span>

  <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">box</span><span class="p">.</span><span class="nf">FindString</span><span class="p">(</span><span class="s">&#34;admin/index.html&#34;</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="开发变得容易">开发变得容易</h2>

<p>为了将静态文件转换为Go二进制文件，必须首先将这些文件转换为Go代码。为此，Packr附带了一些工具来帮助生成二进制文件。见下文。</p>

<p>但是，在开发过程中，必须继续运行工具来编译这些文件是很痛苦的。</p>

<p>查找文件时，Packr使用以下解析规则：</p>

<ol>
<li>在内存中查找文件（在Go二进制文件内部）</li>
<li>在磁盘上查找文件（在开发过程中）</li>
</ol>

<p>由于Packr知道如何处理文件系统，因此开发人员无需担心将其静态文件不断编译为二进制文件。他们可以不受阻碍地工作。</p>

<p>Packr使文件解析更进一步。声明新box时，请使用相对路径./templates。Packr收到此调用后，将计算出该目录的绝对路径。这样一来，即使您不在运行该文件夹的目录中，也可以确保Packr可以正确找到文件。这有助于解决测试问题，其中Go更改了pwd每个软件包的名称，使相对路径难以使用。使用Packr时这不是问题。</p>

<h2 id="http的用法">HTTP的用法</h2>

<p>box实现了http.FileSystem接口，这意味着它可用于提供静态文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;net/http&#34;</span>

	<span class="s">&#34;github.com/gobuffalo/packr/v2&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">box</span> <span class="o">:=</span> <span class="nx">packr</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;someBoxName&#34;</span><span class="p">,</span> <span class="s">&#34;./templates&#34;</span><span class="p">)</span>

	<span class="nx">http</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nf">FileServer</span><span class="p">(</span><span class="nx">box</span><span class="p">))</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:3000&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="建立一个二进制文件">建立一个二进制文件</h2>

<p>在构建Go二进制文件之前，请先运行packr2命令。它将查找代码中的所有box，然后生成.go将静态文件打包为字节的文件，这些字节可以捆绑到Go二进制文件中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">packr2</span></code></pre></td></tr></table>
</div>
</div>
<p>执行此命令后会在main函数同级目录下生成<code>main-packr.go</code>文件:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +build !skippackr
</span><span class="c1">// Code generated by github.com/gobuffalo/packr/v2. DO NOT EDIT.
</span><span class="c1"></span>
<span class="c1">// You can use the &#34;packr clean&#34; command to clean up this,
</span><span class="c1">// and any other packr generated files.
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="nx">_</span> <span class="s">&#34;suyang/example/packrd&#34;</span></code></pre></td></tr></table>
</div>
</div>
<p>还会生成文件夹<code>packrd</code>,保存的是二进制文件.</p>

<p>然后像平常一样运行go build command。</p>

<p>注意：不建议检入这些生成的-packr.go文件。它们可能很大，如果不小心，很容易过时。建议您始终packr2 clean在运行该packr2工具后运行。</p>

<p>完成后，建议您运行packr2 clean命令。这将删除Packr为您创建的所有生成的文件。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">packr2</span> <span class="nx">clean</span></code></pre></td></tr></table>
</div>
</div>
<p>为什么要这样做？Packr首先查找存储在这些生成的文件中的信息，如果该信息不存在，它将查找磁盘。这使得在开发中易于使用。</p>

<h2 id="实现go-generate">实现go generate</h2>

<p>项目目录如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="p">.</span>
<span class="err">├──</span> <span class="k">go</span><span class="p">.</span><span class="nx">mod</span>
<span class="err">├──</span> <span class="k">go</span><span class="p">.</span><span class="nx">sum</span>
<span class="err">├──</span> <span class="nx">main</span><span class="o">-</span><span class="nx">packr</span><span class="p">.</span><span class="k">go</span>
<span class="err">├──</span> <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
<span class="err">├──</span> <span class="nx">pack</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="nx">packr</span><span class="p">.</span><span class="k">go</span>
<span class="err">├──</span> <span class="nx">packrd</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="nx">packed</span><span class="o">-</span><span class="nx">packr</span><span class="p">.</span><span class="k">go</span>
<span class="err">└──</span> <span class="nx">templates</span>
    <span class="err">└──</span> <span class="nx">index</span><span class="p">.</span><span class="nx">html</span></code></pre></td></tr></table>
</div>
</div>
<p>templates:模板文件
pack/packr.go:打包代码,供go generate使用
main.go:是程序文件</p>

<p>packrd/packed-packr.go:生成代码
main-packr.go:生成代码</p>

<p>pack/packr.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;github.com/gobuffalo/packr/v2/packr2/cmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">cmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>main.go:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;log&#34;</span>

	<span class="s">&#34;github.com/gobuffalo/packr/v2&#34;</span>
<span class="p">)</span>

<span class="c1">//go:generate go run ./pack/packr.go
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">box</span> <span class="o">:=</span> <span class="nx">packr</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;myBox&#34;</span><span class="p">,</span> <span class="s">&#34;./templates&#34;</span><span class="p">)</span>

	<span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">box</span><span class="p">.</span><span class="nf">FindString</span><span class="p">(</span><span class="s">&#34;index.html&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>参考:<a href="https://zyfdegh.github.io/post/201805-translation-go-static/">https://zyfdegh.github.io/post/201805-translation-go-static</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2019-10-11
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/vfsgen/">vfsgen</a>
          <a href="/tags/packr/">packr</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/groupcache%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Groupcache的一致性哈希算法</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95-maglev%E7%AE%97%E6%B3%95/">
            <span class="next-text nav-default">一致性哈希算法-Maglev算法</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Forz</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
