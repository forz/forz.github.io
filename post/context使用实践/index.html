<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>contextä½¿ç”¨å®è·µ | Forz Blog</title>
<meta name="keywords" content="Go" />
<meta name="description" content="å¦‚ä½•ä½¿ç”¨ context context ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æºç é‡Œå¯¹å¤–æä¾›äº†ä¸€ä¸ªåˆ›å»ºæ ¹èŠ‚ç‚¹ context çš„å‡½æ•°ï¼š 1 func Background() Context background æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œ å®ƒä¸èƒ½è¢«å–æ¶ˆï¼Œæ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰è¶…æ—¶æ—¶">
<meta name="author" content="">
<link rel="canonical" href="/post/context%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="contextä½¿ç”¨å®è·µ" />
<meta property="og:description" content="å¦‚ä½•ä½¿ç”¨ context context ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æºç é‡Œå¯¹å¤–æä¾›äº†ä¸€ä¸ªåˆ›å»ºæ ¹èŠ‚ç‚¹ context çš„å‡½æ•°ï¼š 1 func Background() Context background æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œ å®ƒä¸èƒ½è¢«å–æ¶ˆï¼Œæ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰è¶…æ—¶æ—¶" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/context%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-19T17:47:08&#43;00:00" />
<meta property="article:modified_time" content="2021-05-19T17:47:08&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="contextä½¿ç”¨å®è·µ"/>
<meta name="twitter:description" content="å¦‚ä½•ä½¿ç”¨ context context ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æºç é‡Œå¯¹å¤–æä¾›äº†ä¸€ä¸ªåˆ›å»ºæ ¹èŠ‚ç‚¹ context çš„å‡½æ•°ï¼š 1 func Background() Context background æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œ å®ƒä¸èƒ½è¢«å–æ¶ˆï¼Œæ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰è¶…æ—¶æ—¶"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "contextä½¿ç”¨å®è·µ",
      "item": "/post/context%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "contextä½¿ç”¨å®è·µ",
  "name": "contextä½¿ç”¨å®è·µ",
  "description": "å¦‚ä½•ä½¿ç”¨ context context ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æºç é‡Œå¯¹å¤–æä¾›äº†ä¸€ä¸ªåˆ›å»ºæ ¹èŠ‚ç‚¹ context çš„å‡½æ•°ï¼š 1 func Background() Context background æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œ å®ƒä¸èƒ½è¢«å–æ¶ˆï¼Œæ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰è¶…æ—¶æ—¶",
  "keywords": [
    "Go"
  ],
  "articleBody": "å¦‚ä½•ä½¿ç”¨ context context ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æºç é‡Œå¯¹å¤–æä¾›äº†ä¸€ä¸ªåˆ›å»ºæ ¹èŠ‚ç‚¹ context çš„å‡½æ•°ï¼š\n1  func Background() Context   background æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œ å®ƒä¸èƒ½è¢«å–æ¶ˆï¼Œæ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰è¶…æ—¶æ—¶é—´ã€‚\næœ‰äº†æ ¹èŠ‚ç‚¹ contextï¼Œåˆæä¾›äº†å››ä¸ªå‡½æ•°åˆ›å»ºå­èŠ‚ç‚¹ contextï¼š\n1 2 3 4  func WithCancel(parent Context) (ctx Context, cancel CancelFunc) func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc) func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) func WithValue(parent Context, key, val interface{}) Context   context ä¼šåœ¨å‡½æ•°ä¼ é€’é—´ä¼ é€’ã€‚åªéœ€è¦åœ¨é€‚å½“çš„æ—¶é—´è°ƒç”¨ cancel å‡½æ•°å‘ goroutines å‘å‡ºå–æ¶ˆä¿¡å·æˆ–è€…è°ƒç”¨ Value å‡½æ•°å–å‡º context ä¸­çš„å€¼ã€‚\nåœ¨ä½¿ç”¨ Context çš„æ—¶å€™,æœ‰ä¸€äº›çº¦å®šä¿—æˆçš„è§„åˆ™ã€‚\n ä¸€èˆ¬å‡½æ•°ä½¿ç”¨ Context çš„æ—¶å€™,ä¼šæŠŠè¿™ä¸ªå‚æ•°æ”¾åœ¨ç¬¬ä¸€ä¸ªå‚æ•°çš„ä½ç½®ã€‚ ä»æ¥ä¸æŠŠ nil å½“åš Context ç±»å‹çš„å‚æ•°å€¼,å¯ä»¥ä½¿ç”¨ context.Background() åˆ›å»ºä¸€ä¸ªç©ºçš„ä¸Šä¸‹æ–‡å¯¹è±¡,ä¹Ÿä¸è¦ä½¿ç”¨ nilã€‚ Context åªç”¨æ¥ä¸´æ—¶åšå‡½æ•°ä¹‹é—´çš„ä¸Šä¸‹æ–‡é€ä¼ ,ä¸èƒ½æŒä¹…åŒ– Context æˆ–è€…æŠŠ Context é•¿ä¹…ä¿å­˜ã€‚æŠŠ Context æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€æœ¬åœ°æ–‡ä»¶æˆ–è€…å…¨å±€å˜é‡ã€ç¼“å­˜ä¸­éƒ½æ˜¯é”™è¯¯çš„ç”¨æ³•ã€‚ key çš„ç±»å‹ä¸åº”è¯¥æ˜¯å­—ç¬¦ä¸²ç±»å‹æˆ–è€…å…¶å®ƒå†…å»ºç±»å‹,å¦åˆ™å®¹æ˜“åœ¨åŒ…ä¹‹é—´ä½¿ç”¨ Context æ—¶å€™äº§ç”Ÿå†²çªã€‚ä½¿ç”¨ WithValue æ—¶,key çš„ç±»å‹åº”è¯¥æ˜¯è‡ªå·±å®šä¹‰çš„ç±»å‹ã€‚ å¸¸å¸¸ä½¿ç”¨ struct{}ä½œä¸ºåº•å±‚ç±»å‹å®šä¹‰ key çš„ç±»å‹ã€‚å¯¹äº exported key çš„é™æ€ç±»å‹,å¸¸å¸¸æ˜¯æ¥å£æˆ–è€…æŒ‡é’ˆã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘å†…å­˜åˆ†é…ã€‚  ä¼ é€’å…±äº«çš„æ•°æ® å¯¹äº Web æœåŠ¡ç«¯å¼€å‘ï¼Œå¾€å¾€å¸Œæœ›å°†ä¸€ä¸ªè¯·æ±‚å¤„ç†çš„æ•´ä¸ªè¿‡ç¨‹ä¸²èµ·æ¥ï¼Œè¿™å°±éå¸¸ä¾èµ–äº Thread Localï¼ˆå¯¹äº Go å¯ç†è§£ä¸ºå•ä¸ªåç¨‹æ‰€ç‹¬æœ‰ï¼‰ çš„å˜é‡ï¼Œè€Œåœ¨ Go è¯­è¨€ä¸­å¹¶æ²¡æœ‰è¿™ä¸ªæ¦‚å¿µï¼Œå› æ­¤éœ€è¦åœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ä¼ é€’ contextã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  package main import ( \"context\" \"fmt\" ) func main() { ctx := context.Background() process(ctx) ctx = context.WithValue(ctx, \"traceId\", \"qcrao-2019\") process(ctx) } func process(ctx context.Context) { traceId, ok := ctx.Value(\"traceId\").(string) if ok { fmt.Printf(\"process over. trace_id=%s\\n\", traceId) } else { fmt.Printf(\"process over. no trace_id\\n\") } }   è¿è¡Œç»“æœï¼š\n1 2  process over. no trace_id process over. trace_id=qcrao-2019   ç¬¬ä¸€æ¬¡è°ƒç”¨ process å‡½æ•°æ—¶ï¼Œctx æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œè‡ªç„¶å–ä¸å‡ºæ¥ traceIdã€‚ç¬¬äºŒæ¬¡ï¼Œé€šè¿‡ WithValue å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª contextï¼Œå¹¶èµ‹ä¸Šäº† traceId è¿™ä¸ª keyï¼Œè‡ªç„¶å°±èƒ½å–å‡ºæ¥ä¼ å…¥çš„ value å€¼ã€‚\nå½“ç„¶ï¼Œç°å®åœºæ™¯ä¸­å¯èƒ½æ˜¯ä»ä¸€ä¸ª HTTP è¯·æ±‚ä¸­è·å–åˆ°çš„ Request-IDã€‚æ‰€ä»¥ï¼Œä¸‹é¢è¿™ä¸ªæ ·ä¾‹å¯èƒ½æ›´é€‚åˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  const requestIDKey int = 0 func WithRequestID(next http.Handler) http.Handler { return http.HandlerFunc( func(rw http.ResponseWriter, req *http.Request) { // ä» header ä¸­æå– request-id  reqID := req.Header.Get(\"X-Request-ID\") // åˆ›å»º valueCtxã€‚ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»å‹ï¼Œä¸å®¹æ˜“å†²çª  ctx := context.WithValue( req.Context(), requestIDKey, reqID) // åˆ›å»ºæ–°çš„è¯·æ±‚  req = req.WithContext(ctx) // è°ƒç”¨ HTTP å¤„ç†å‡½æ•°  next.ServeHTTP(rw, req) } ) } // è·å– request-id func GetRequestID(ctx context.Context) string { ctx.Value(requestIDKey).(string) } func Handle(rw http.ResponseWriter, req *http.Request) { // æ‹¿åˆ° reqIdï¼Œåé¢å¯ä»¥è®°å½•æ—¥å¿—ç­‰ç­‰  reqID := GetRequestID(req.Context()) ... } func main() { handler := WithRequestID(http.HandlerFunc(Handle)) http.ListenAndServe(\"/\", handler) }   å–æ¶ˆ goroutine æˆ‘ä»¬å…ˆæ¥è®¾æƒ³ä¸€ä¸ªåœºæ™¯ï¼šæ‰“å¼€å¤–å–çš„è®¢å•é¡µï¼Œåœ°å›¾ä¸Šæ˜¾ç¤ºå¤–å–å°å“¥çš„ä½ç½®ï¼Œè€Œä¸”æ˜¯æ¯ç§’æ›´æ–° 1 æ¬¡ã€‚app ç«¯å‘åå°å‘èµ· websocket è¿æ¥ï¼ˆç°å®ä¸­å¯èƒ½æ˜¯è½®è¯¢ï¼‰è¯·æ±‚åï¼Œåå°å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ¯éš” 1 ç§’è®¡ç®— 1 æ¬¡å°å“¥çš„ä½ç½®ï¼Œå¹¶å‘é€ç»™ç«¯ã€‚å¦‚æœç”¨æˆ·é€€å‡ºæ­¤é¡µé¢ï¼Œåˆ™åå°éœ€è¦â€œå–æ¶ˆâ€æ­¤è¿‡ç¨‹ï¼Œé€€å‡º goroutineï¼Œç³»ç»Ÿå›æ”¶èµ„æºã€‚\nåç«¯å¯èƒ½çš„å®ç°å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7  func Perform() { for { calculatePos() sendResult() time.Sleep(time.Second) } }   å¦‚æœéœ€è¦å®ç°â€œå–æ¶ˆâ€åŠŸèƒ½ï¼Œå¹¶ä¸”åœ¨ä¸äº†è§£ context åŠŸèƒ½çš„å‰æä¸‹ï¼Œå¯èƒ½ä¼šè¿™æ ·åšï¼šç»™å‡½æ•°å¢åŠ ä¸€ä¸ªæŒ‡é’ˆå‹çš„ bool å˜é‡ï¼Œåœ¨ for è¯­å¥çš„å¼€å§‹å¤„åˆ¤æ–­ bool å˜é‡æ˜¯å‘ç”± true å˜ä¸º falseï¼Œå¦‚æœæ”¹å˜ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚\nä¸Šé¢ç»™å‡ºçš„ç®€å•åšæ³•ï¼Œå¯ä»¥å®ç°æƒ³è¦çš„æ•ˆæœï¼Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¹¶ä¸ä¼˜é›…ï¼Œå¹¶ä¸”ä¸€æ—¦åç¨‹æ•°é‡å¤šäº†ä¹‹åï¼Œå¹¶ä¸”å„ç§åµŒå¥—ï¼Œå°±ä¼šå¾ˆéº»çƒ¦ã€‚ä¼˜é›…çš„åšæ³•ï¼Œè‡ªç„¶å°±è¦ç”¨åˆ° contextã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  func Perform(ctx context.Context) { for { calculatePos() sendResult() select { case ctx.Done(): // è¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›  return case time.After(time.Second): // block 1 ç§’é’Ÿ  } } }   ä¸»æµç¨‹å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š\n1 2 3 4 5 6  ctx, cancel := context.WithTimeout(context.Background(), time.Hour) go Perform(ctx) // â€¦â€¦ // app ç«¯è¿”å›é¡µé¢ï¼Œè°ƒç”¨cancel å‡½æ•° cancel()   æ³¨æ„ä¸€ä¸ªç»†èŠ‚ï¼ŒWithTimeOut å‡½æ•°è¿”å›çš„ context å’Œ cancelFun æ˜¯åˆ†å¼€çš„ã€‚context æœ¬èº«å¹¶æ²¡æœ‰å–æ¶ˆå‡½æ•°ï¼Œè¿™æ ·åšçš„åŸå› æ˜¯å–æ¶ˆå‡½æ•°åªèƒ½ç”±å¤–å±‚å‡½æ•°è°ƒç”¨ï¼Œé˜²æ­¢å­èŠ‚ç‚¹ context è°ƒç”¨å–æ¶ˆå‡½æ•°ï¼Œä»è€Œä¸¥æ ¼æ§åˆ¶ä¿¡æ¯çš„æµå‘ï¼šç”±çˆ¶èŠ‚ç‚¹ context æµå‘å­èŠ‚ç‚¹ contextã€‚\né˜²æ­¢ goroutine æ³„æ¼ å‰é¢é‚£ä¸ªä¾‹å­é‡Œï¼Œgoroutine è¿˜æ˜¯ä¼šè‡ªå·±æ‰§è¡Œå®Œï¼Œæœ€åè¿”å›ï¼Œåªä¸è¿‡ä¼šå¤šæµªè´¹ä¸€äº›ç³»ç»Ÿèµ„æºã€‚è¿™é‡Œæ”¹ç¼–ä¸€ä¸ªâ€œå¦‚æœä¸ç”¨ context å–æ¶ˆï¼Œgoroutine å°±ä¼šæ³„æ¼çš„ä¾‹å­â€ï¼Œæ¥è‡ªå‚è€ƒèµ„æ–™ï¼šã€é¿å…åç¨‹æ³„æ¼ã€‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  func gen() chan int { ch := make(chan int) go func() { var n int for { ch  n n++ time.Sleep(time.Second) } }() return ch }   è¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç”Ÿæˆæ— é™æ•´æ•°çš„åç¨‹ï¼Œä½†å¦‚æœæˆ‘åªéœ€è¦å®ƒäº§ç”Ÿçš„å‰ 5 ä¸ªæ•°ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿ goroutine æ³„æ¼ï¼š\n1 2 3 4 5 6 7 8 9  func main() { for n := range gen() { fmt.Println(n) if n == 5 { break } } // â€¦â€¦ }   å½“ n == 5 çš„æ—¶å€™ï¼Œç›´æ¥ break æ‰ã€‚é‚£ä¹ˆ gen å‡½æ•°çš„åç¨‹å°±ä¼šæ‰§è¡Œæ— é™å¾ªç¯ï¼Œæ°¸è¿œä¸ä¼šåœä¸‹æ¥ã€‚å‘ç”Ÿäº† goroutine æ³„æ¼ã€‚\nç”¨ context æ”¹è¿›è¿™ä¸ªä¾‹å­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  func gen(ctx context.Context) chan int { ch := make(chan int) go func() { var n int for { select { case ctx.Done(): return case ch  n: n++ time.Sleep(time.Second) } } }() return ch } func main() { ctx, cancel := context.WithCancel(context.Background()) defer cancel() // é¿å…å…¶ä»–åœ°æ–¹å¿˜è®° cancelï¼Œä¸”é‡å¤è°ƒç”¨ä¸å½±å“  for n := range gen(ctx) { fmt.Println(n) if n == 5 { cancel() break } } // â€¦â€¦ }   å¢åŠ ä¸€ä¸ª contextï¼Œåœ¨ break å‰è°ƒç”¨ cancel å‡½æ•°ï¼Œå–æ¶ˆ goroutineã€‚gen å‡½æ•°åœ¨æ¥æ”¶åˆ°å–æ¶ˆä¿¡å·åï¼Œç›´æ¥é€€å‡ºï¼Œç³»ç»Ÿå›æ”¶èµ„æºã€‚\nä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’ åœ¨è®¸å¤š Go APIï¼Œå°¤å…¶æ˜¯ç°ä»£ API ä¸­ï¼Œå‡½æ•°å’Œæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°é€šå¸¸æ˜¯ context.Contextã€‚context æä¾›äº†å¾ˆå¤šæ–¹æ³•ä¾‹å¦‚ WithCancelã€WithDeadlineã€WithValueã€ä»¥å®ç°è·¨ API çš„æµç¨‹æ§åˆ¶ã€‚å¾ˆå¤š lib åœ¨ä¸è¿œç¨‹æœåŠ¡å™¨(å¦‚æ•°æ®åº“ã€apiç­‰)äº¤äº’æ—¶ï¼Œç»å¸¸ä½¿ç”¨ context åšæ§åˆ¶ã€‚\ncontext çš„æ–‡æ¡£ä¸­è®²åˆ°:\ncontext ä¸åº”å­˜å‚¨åœ¨ struct å†…éƒ¨ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’\næœ¬æ–‡åœ¨æ­¤å»ºè®®çš„åŸºç¡€ä¸Šè®²è§£äº†åŸå› å’Œç¤ºä¾‹ï¼Œè¯´æ˜äº†ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å‡½æ•°ä¼ é€’ Context è€Œä¸æ˜¯å°†å…¶å­˜å‚¨åœ¨ struct ä¸­çš„é‡è¦æ€§ã€‚è¿˜ä»¥ net/http çš„ä»£ç ä¸ºä¾‹ï¼Œè§£é‡Šäº†åº”è¯¥åœ¨ä½•ç§æƒ…å†µä¸‹å¯ä»¥åœ¨ struct ä¸­ å­˜å‚¨ Context ã€‚\næ¨è context ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’ è®©æˆ‘ä»¬å…ˆçœ‹ä¸‹åœ¨å‡½æ•°ä¸­ä¼ é€’ contextï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  type Worker struct { /*â€¦*/ } type Work struct { /*â€¦*/ } func New() *Worker { return \u0026Worker{} } func (w *Worker) Fetch(ctx context.Context) (*Work, error) { _ = ctx // A per-call ctx is used for cancellation, deadlines, and metadata. } func (w *Worker) Process(ctx context.Context, w*Work) error { _ = ctx // A per-call ctx is used for cancellation, deadlines, and metadata. }   è¿™é‡Œ (*Worker).Fetch å’Œ (*Worker).Process éƒ½ç›´æ¥å°† context ä½œä¸ºå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ã€‚è¿™æ ·ä» context çš„ç”Ÿæˆåˆ°ç»“æŸï¼Œè°ƒç”¨æ–¹å¯ä»¥å¾ˆæ¸…æ™°åœ°çŸ¥é“ context çš„ä¼ é€’è·¯çº¿ã€‚\nå°† context å­˜å‚¨åˆ° strcut æ‰€å¸¦æ¥çš„ä¸€äº›å›°æƒ‘ åœ¨ç»“æ„ä½“ä¸­åµŒå¥— context æ¥å®ç°ä¸Šé¢çš„ Worker ç¤ºä¾‹ï¼Œè°ƒç”¨è€…å¯¹æ‰€ä½¿ç”¨çš„ context ç”Ÿå‘½å‘¨æœŸäº§ç”Ÿè¿·æƒ‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  type Worker struct { ctx context.Context } func New(ctx context.Context) *Worker { return \u0026Worker{ctx: ctx} } func (w *Worker) Fetch() (*Work, error) { _ = w.ctx // A shared w.ctx is used for cancellation, deadlines, and metadata. } func (w *Worker) Process(w*Work) error { _ = w.ctx // A shared w.ctx is used for cancellation, deadlines, and metadata. }   (*Worker).Fetch å’Œ (*Worker).Process æ–¹æ³•åŒæ—¶ä½¿ç”¨äº† Worker ç»“æ„ä½“ä¸­çš„ context ï¼Œè¿™ç§æƒ…å†µä¸‹ä½¿å¾—è°ƒç”¨æ–¹æ— æ³•å®šä¹‰ä¸åŒçš„ context ï¼Œæ¯”å¦‚æœ‰è°ƒç”¨æ–¹æƒ³ç”¨ WitchCancelï¼Œæœ‰çš„æƒ³ç”¨ WithDeadlineï¼Œä¹Ÿå¾ˆéš¾ç†è§£ä¸Šé¢ä¼ æ¥çš„ context çš„ä½œç”¨æ˜¯ cancelï¼Ÿè¿˜æ˜¯ deadline?è°ƒç”¨è€…æ‰€ä½¿ç”¨ context çš„ç”Ÿå‘½å‘¨æœŸè¢«ç»‘å®šåˆ°äº†ä¸€ä¸ªå…±äº«çš„ context ä¸Šé¢ã€‚\nç‰¹æ®Šæƒ…å†µï¼šä¿ç•™å‘åå…¼å®¹æ€§ å½“ go 1.7 ç‰ˆæœ¬å‘å¸ƒæ—¶ï¼Œå¤§é‡çš„çš„ API éœ€è¦ä»¥å‘åå…¼å®¹çš„æ–¹å¼æ”¯æŒ context.Contextï¼Œä¾‹å¦‚ï¼Œnet/http çš„ Client æ–¹æ³•ï¼ˆä¾‹å¦‚Getå’ŒDoï¼‰æ˜¯ä½¿ç”¨ context çš„å…¸èŒƒã€‚ä½¿ç”¨è¿™äº›æ–¹æ³•å‘é€çš„ http è¯·æ±‚éƒ½å°†å—ç›Šäº context.Context é™„å¸¦çš„ WithDeadlineï¼ŒWithCancel å’Œ WithValue ç­‰æ–¹æ³•æ”¯æŒã€‚\nä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼èƒ½å¤Ÿåœ¨æ”¯æŒ context.Context çš„åŒæ—¶ä¿æŒä»£ç çš„å‘åå…¼å®¹ï¼š\n åœ¨ struct ä¸­æ·»åŠ  context (ç¨åæˆ‘ä»¬å°†çœ‹åˆ°)ï¼› å¤åˆ¶åŸæœ‰å‡½æ•°ï¼Œåœ¨å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ä¸­ä½¿ç”¨ contextï¼Œä¸¾ä¸ªæ —å­ï¼Œdatabase/sql è¿™ä¸ª package çš„ Query æ–¹æ³•çš„ç­¾åä¸€ç›´æ˜¯:  1  func (db *DB) Query(query string, args ...interface{}) (*Rows, error)   å½“ context package å¼•å…¥çš„æ—¶å€™ï¼ŒGo team æ–°å¢äº†è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼š\n1  func (db *DB) QueryContext(ctx context.Context, query string, args ...interface{}) (*Rows, error)   å¹¶ä¸”åªä¿®æ”¹äº†ä¸€å¤„ä»£ç ï¼š\n1 2 3  func (db *DB) Query(query string, args ...interface{}) (*Rows, error) { return db.QueryContext(context.Background(), query, args...) }   é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒGo team èƒ½å¤Ÿåœ¨å¹³æ»‘åœ°å‡çº§ä¸€ä¸ª package çš„åŒæ—¶ä¸å¯¹ä»£ç çš„å¯è¯»æ€§ã€å…¼å®¹æ€§é€ æˆå½±å“ã€‚ç±»ä¼¼çš„ä»£ç åœ¨ golang æºç ä¸­éšå¤„å¯è§ã€‚æ›´å¤šçš„ä¿æŒä»£ç å…¼å®¹æ€§çš„è®¨è®ºå¯è§ [Go team å…³äºå¦‚ä½•ä¿æŒ Go Modules å…¼å®¹æ€§çš„ä¸€äº›å®è·µ]ã€‚\nç„¶è€Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ API å…¬å¼€äº†å¤§é‡ functionï¼Œé‡å†™æ‰€æœ‰å‡½æ•°æ˜¯ä¸åˆ‡å®é™…çš„ã€‚\npackage net/http é€‰æ‹©åœ¨ struct ä¸­æ·»åŠ  context.Contextï¼Œè¿™æ˜¯ä¸€ä¸ªç»“æ„ä½“åµŒå¥— context æ¯”è¾ƒæ°å½“çš„èŒƒä¾‹ã€‚å…ˆè®©æˆ‘ä»¬çœ‹ä¸‹ net/http çš„ Do å‡½æ•°ã€‚åœ¨å¼•å…¥ context ä¹‹å‰ï¼ŒDo çš„å®šä¹‰å¦‚ä¸‹:\n1  func (c *Client) Do(req*Request) (*Response, error)   åœ¨ 1.7 å¼•å…¥ context åï¼Œä¸ºäº†éµå¾ª net/http è¿™ç§æ ‡å‡†åº“çš„å‘åå…¼å®¹åŸåˆ™ï¼Œè€ƒè™‘åˆ°è¯¥æ ¸å¿ƒåº“æ‰€åŒ…å«çš„å‡½æ•°è¿‡äºå¤šï¼Œmaintainers é€‰æ‹©åœ¨ç»“æ„ä½“ http.Request ä¸­æ·»åŠ  context.Contextã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  type Request struct { ctx context.Context // ... } func NewRequestWithContext(ctx context.Context, method, url string, body io.Reader) (*Request, error) { // Simplified for brevity of this article.  return \u0026Request{ ctx: ctx, // ...  } } func (c *Client) Do(req*Request) (*Response, error)   åœ¨ä¿®æ”¹å¤§é‡ API ä»¥æ”¯æŒ context æ—¶ï¼Œåœ¨ç»“æ„ä½“ä¸­æ·»åŠ  context.Context æ˜¯æœ‰æ„ä¹‰çš„ï¼Œ å¦‚ä¸Šæ‰€è¿°ã€‚ä½†æ˜¯ï¼Œè®°ä½é¦–å…ˆè¦è€ƒè™‘å¤åˆ¶å‡½æ•°å¯¹ context è¿›è¡Œæ”¯æŒï¼Œåœ¨ä¸ç‰ºç‰²å®ç”¨æ€§å’Œç†è§£æ€§çš„å‰æä¸‹å‘åå…¼å®¹ä¸Šä¸‹æ–‡:\n1 2 3 4 5 6 7  func (c *Client) Call() error { return c.CallContext(context.Background()) } func (c *Client) CallContext(ctx context.Context) error { // ... }   context çœŸçš„è¿™ä¹ˆå¥½å— è¯»å®Œå…¨æ–‡ï¼Œä½ ä¸€å®šæœ‰è¿™ç§æ„Ÿè§‰ï¼šcontext å°±æ˜¯ä¸º server è€Œè®¾è®¡çš„ã€‚è¯´ä»€ä¹ˆå¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œéœ€è¦å¯åŠ¨å¤šä¸ª goroutine å¹¶è¡Œåœ°å»å¤„ç†ï¼Œå¹¶ä¸”åœ¨è¿™äº› goroutine ä¹‹é—´è¿˜è¦ä¼ é€’ä¸€äº›å…±äº«çš„æ•°æ®ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯å†™ä¸€ä¸ª server è¦åšçš„äº‹ã€‚\næ²¡é”™ï¼ŒGo å¾ˆé€‚åˆå†™ serverï¼Œä½†å®ƒç»ˆå½’æ˜¯ä¸€é—¨é€šç”¨çš„è¯­è¨€ã€‚ä½ åœ¨ç”¨ Go åš Leetcode ä¸Šé¢çš„é¢˜ç›®çš„æ—¶å€™ï¼Œè‚¯å®šä¸ä¼šè®¤ä¸ºå®ƒå’Œä¸€èˆ¬çš„è¯­è¨€æœ‰ä»€ä¹ˆå·®åˆ«ã€‚æ‰€ä»¥ï¼Œå¾ˆå¤šç‰¹æ€§å¥½ä¸å¥½ï¼Œåº”è¯¥ä» Go åªæ˜¯ä¸€é—¨æ™®é€šçš„è¯­è¨€ï¼Œå¾ˆæ“…é•¿å†™ server çš„è§’åº¦æ¥çœ‹ã€‚\nä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œcontext å¹¶æ²¡æœ‰é‚£ä¹ˆç¾å¥½ã€‚Go å®˜æ–¹å»ºè®®æˆ‘ä»¬æŠŠ Context ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç”šè‡³è¿åå­—éƒ½å‡†å¤‡å¥½äº†ã€‚è¿™é€ æˆä¸€ä¸ªåæœï¼šå› ä¸ºæˆ‘ä»¬æƒ³æ§åˆ¶æ‰€æœ‰çš„åç¨‹çš„å–æ¶ˆåŠ¨ä½œï¼Œæ‰€ä»¥éœ€è¦åœ¨å‡ ä¹æ‰€æœ‰çš„å‡½æ•°é‡ŒåŠ ä¸Šä¸€ä¸ª Context å‚æ•°ã€‚å¾ˆå¿«ï¼Œæˆ‘ä»¬çš„ä»£ç é‡Œï¼Œcontext å°†åƒç—…æ¯’ä¸€æ ·æ‰©æ•£çš„åˆ°å¤„éƒ½æ˜¯ã€‚\nåœ¨å‚è€ƒèµ„æ–™ã€Go2 åº”è¯¥å»æ‰ contextã€‘è¿™ç¯‡è‹±æ–‡åšå®¢é‡Œï¼Œä½œè€…ç”šè‡³è°ƒä¾ƒè¯´ï¼šå¦‚æœè¦æŠŠ Go æ ‡å‡†åº“çš„å¤§éƒ¨åˆ†å‡½æ•°éƒ½åŠ ä¸Š context å‚æ•°çš„è¯ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼š\n1  n, err := r.Read(context.TODO(), p)   å°±ç»™æˆ‘æ¥ä¸€æªå§ï¼\nåŸæ–‡æ˜¯è¿™æ ·è¯´çš„ï¼šput a bullet in my head, please.æˆ‘å½“æ—¶çœ‹åˆ°è¿™å¥è¯çš„æ—¶å€™ï¼Œä¼šå¿ƒä¸€ç¬‘ã€‚è¿™å¯èƒ½å°±æ˜¯é™¶æ¸Šæ˜è¯´çš„ï¼šæ¯æœ‰ä¼šæ„ï¼Œä¾¿æ¬£ç„¶å¿˜é£Ÿã€‚å½“ç„¶ï¼Œæˆ‘æ˜¯åœ¨æ™šé¥­ä¼šçœ‹åˆ°è¿™å¥è¯çš„ã€‚\nä¸ºäº†è¡¨è¾¾è‡ªå·±å¯¹ context å¹¶æ²¡æœ‰ä»€ä¹ˆå¥½æ„Ÿï¼Œä½œè€…æ¥ç€åˆè¯´äº†ä¸€å¥ï¼šIf you use ctx.Value in my (non-existent) company, youâ€™re fired. ç®€ç›´å¤ªå¹½é»˜äº†ï¼Œå“ˆå“ˆã€‚\nå¦å¤–ï¼Œåƒ WithCancelã€WithDeadlineã€WithTimeoutã€WithValue è¿™äº›åˆ›å»ºå‡½æ•°ï¼Œå®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ªä¸ªçš„é“¾è¡¨ç»“ç‚¹è€Œå·²ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹é“¾è¡¨çš„æ“ä½œï¼Œé€šå¸¸éƒ½æ˜¯ O(n) å¤æ‚åº¦çš„ï¼Œæ•ˆç‡ä¸é«˜ã€‚\né‚£ä¹ˆï¼Œcontext åŒ…åˆ°åº•è§£å†³äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šcancelationã€‚ä»…ç®¡å®ƒå¹¶ä¸å®Œç¾ï¼Œä½†å®ƒç¡®å®å¾ˆç®€æ´åœ°è§£å†³äº†é—®é¢˜ã€‚\næ‰“å°contextå¼•èµ·panic åˆ†æé—®é¢˜ ä¸‹é¢æ˜¯å‡ºç°net/http context panicçš„é—®é¢˜ä»£ç ï¼Œä»£ç çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å®šä¹‰ä¸€ä¸ªapiï¼Œç„¶åæ‰“å°contextè€Œå·²ã€‚æŠŠæœåŠ¡è¿è¡Œèµ·æ¥åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ab, wrkæ¥è¿›è¡Œå‹æµ‹ï¼Œæ¥åˆ¶é€ data raceç«äº‰çš„åœºæ™¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // xiaorui.cc  package main import ( \"fmt\" \"net/http\" ) func panic(w http.ResponseWriter, r *http.Request) { fmt.Printf(\"%+v\", r.Context()) } func main() { http.HandleFunc(\"/\", panic) err := http.ListenAndServe(\":9090\", nil) if err != nil { fmt.Println(err) } }   ä¸‹é¢æ˜¯wrkå‹æµ‹æ—¶ï¼Œnet/httpæœåŠ¡çš„å¼‚å¸¸ä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73  // xiaorui.cc fatal error: concurrent map read and map write context.Background.WithValue(\u0026http.contextKey{name:\"http-server\"}, \u0026http.Server{Addr:\":9090\", Handler:http.Handler(nil), TLSConfig:(*tls.Config)(0xc000062780), ReadTimeout:0, ReadHeaderTimeout:0, WriteTimeout:0, IdleTimeout:0, MaxHeaderBytes:0, TLSNextProto:map[string]func(*http.Server, *tls.Conn, http.Handler){\"h2\":(func(*http.Server, *tls.Conn, http.Handler))(0x120b620)}, ConnState:(func(net.Conn, http.ConnState))(nil), ErrorLog:(*log.Logger)(nil), disableKeepAlives:0, inShutdown:0, nextProtoOnce:sync.Once{m:sync.Mutex{state:0, sema:0x0}, done:0x1}, nextProtoErr:error(nil), mu:sync.Mutex{state:0, sema:0x0}, listeners:map[*net.Listener]struct {}{(*net.Listener)(0xc00007ccb0):struct {}{}}, activeConn:map[*http.conn]struct {}{(*http.conn)(0xc00009cb40):struct {}{}, (*http.conn)(0xc00009d2c0):struct {}{}, (*http.conn)(0xc00009d540):struct {}{}, (*http.conn)(0xc00009dcc0):struct {}{}, (*http.conn)(0xc00009cd20):struct {}{}, (*http.conn)(0xc00009d5e0):struct {}... xiaorui.cc goroutine 32 [running]: runtime.throw(0x12b35e3, 0x21) /usr/local/go/src/runtime/panic.go:608 +0x72 fp=0xc00018a858 sp=0xc00018a828 pc=0x102b892 runtime.mapaccess2(0x1255800, 0xc000080ea0, 0xc00018a978, 0x14bf328, 0xc0000ac868) /usr/local/go/src/runtime/map.go:453 +0x223 fp=0xc00018a8a0 sp=0xc00018a858 pc=0x100ed93 reflect.mapaccess(0x1255800, 0xc000080ea0, 0xc00018a978, 0x12afece) /usr/local/go/src/runtime/map.go:1249 +0x3f fp=0xc00018a8d8 sp=0xc00018a8a0 pc=0x1010adf reflect.Value.MapIndex(0x1255800, 0xc000083280, 0x1b5, 0x1288180, 0xc00009da40, 0x36, 0x1257ae0, 0x14bf328, 0xb9) /usr/local/go/src/reflect/value.go:1111 +0x11d fp=0xc00018a958 sp=0xc00018a8d8 pc=0x1099b7d fmt.(*pp).printValue(0xc000188180, 0x1255800, 0xc000083280, 0x1b5, 0x76, 0x2) /usr/local/go/src/fmt/print.go:757 +0xf43 fp=0xc00018ab38 sp=0xc00018a958 pc=0x10aa853 fmt.(*pp).printValue(0xc000188180, 0x12a0720, 0xc0000831e0, 0x199, 0xc000000076, 0x1) /usr/local/go/src/fmt/print.go:783 +0x1ce9 fp=0xc00018ad18 sp=0xc00018ab38 pc=0x10ab5f9 fmt.(*pp).printValue(0xc000188180, 0x129ed00, 0xc0000831e0, 0x16, 0x76, 0x0) /usr/local/go/src/fmt/print.go:853 +0x1b2c fp=0xc00018aef8 sp=0xc00018ad18 pc=0x10ab43c fmt.(*pp).printArg(0xc000188180, 0x129ed00, 0xc0000831e0, 0x76) /usr/local/go/src/fmt/print.go:689 +0x2b7 fp=0xc00018af90 sp=0xc00018aef8 pc=0x10a91a7 fmt.(*pp).doPrintf(0xc000188180, 0x12afaf0, 0x16, 0xc00018b108, 0x3, 0x3) /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b078 sp=0xc00018af90 pc=0x10acde6 fmt.Sprintf(0x12afaf0, 0x16, 0xc00018b108, 0x3, 0x3, 0x0, 0x0) /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b0d0 sp=0xc00018b078 pc=0x10a5b26 context.(*valueCtx).String(0xc000080e10, 0x12be400, 0xc0001880c0) /usr/local/go/src/context/context.go:486 +0xab fp=0xc00018b148 sp=0xc00018b0d0 pc=0x11121bb fmt.(*pp).handleMethods(0xc0001880c0, 0x76, 0x1) /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018b1d8 sp=0xc00018b148 pc=0x10a8cac fmt.(*pp).printArg(0xc0001880c0, 0x1274ce0, 0xc000080e10, 0x76) /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018b270 sp=0xc00018b1d8 pc=0x10a90f3 fmt.(*pp).doPrintf(0xc0001880c0, 0x12afaf0, 0x16, 0xc00018b3e8, 0x3, 0x3) ... fmt.(*pp).printArg(0xc000188000, 0x1274ce0, 0xc000114480, 0xc000000076) /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b638 sp=0xc00018b550 pc=0x10acde6 fmt.Sprintf(0x12ad1be, 0xd, 0xc0001106c8, 0x1, 0x1, 0xc00011e080, 0xc0001106f8) /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b690 sp=0xc00018b638 pc=0x10a5b26 context.(*cancelCtx).String(0xc000116640, 0x12be400, 0xc000188300) /usr/local/go/src/context/context.go:343 +0x7d fp=0xc00018b6e8 sp=0xc00018b690 pc=0x111158d fmt.(*pp).handleMethods(0xc000188300, 0xc000000076, 0x1034601) /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018b778 sp=0xc00018b6e8 pc=0x10a8cac fmt.(*pp).printArg(0xc000188300, 0x12785e0, 0xc000116640, 0xc000000076) /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018b810 sp=0xc00018b778 pc=0x10a90f3 fmt.(*pp).doPrintf(0xc000188300, 0x12ad1be, 0xd, 0xc00018b988, 0x1, 0x1) /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b8f8 sp=0xc00018b810 pc=0x10acde6 fmt.Sprintf(0x12ad1be, 0xd, 0xc000110988, 0x1, 0x1, 0xc00011e030, 0xc0001109b8) /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b950 sp=0xc00018b8f8 pc=0x10a5b26 context.(*cancelCtx).String(0xc000116740, 0x12be400, 0xc000188240) /usr/local/go/src/context/context.go:343 +0x7d fp=0xc00018b9a8 sp=0xc00018b950 pc=0x111158d fmt.(*pp).handleMethods(0xc000188240, 0x76, 0xc000080c01) /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018ba38 sp=0xc00018b9a8 pc=0x10a8cac fmt.(*pp).printArg(0xc000188240, 0x12785e0, 0xc000116740, 0x76) /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018bad0 sp=0xc00018ba38 pc=0x10a90f3 fmt.(*pp).doPrintf(0xc000188240, 0x12ab4df, 0x3, 0xc00018bcc0, 0x1, 0x1) ... fmt.Printf(0x12ab4df, 0x3, 0xc000110cc0, 0x1, 0x1, 0xc0000fa780, 0x3, 0xc000022a70) /usr/local/go/src/fmt/print.go:197 +0x72 fp=0xc00018bc80 sp=0xc00018bc20 pc=0x10a5a82 main.panic(0x12f10c0, 0xc0001821c0, 0xc000120600) /Users/ruifengyun/test/k.go:9 +0x89 fp=0xc00018bce0 sp=0xc00018bc80 pc=0x121bb79 net/http.HandlerFunc.ServeHTTP(0x12be4e0, 0x12f10c0, 0xc0001821c0, 0xc000120600) /usr/local/go/src/net/http/server.go:1964 +0x44 fp=0xc00018bd08 sp=0xc00018bce0 pc=0x11f1b14 net/http.(*ServeMux).ServeHTTP(0x14a17a0, 0x12f10c0, 0xc0001821c0, 0xc000120600) /usr/local/go/src/net/http/server.go:2361 +0x127 fp=0xc00018bd48 sp=0xc00018bd08 pc=0x11f37c7 net/http.serverHandler.ServeHTTP(0xc0000831e0, 0x12f10c0, 0xc0001821c0, 0xc000120600) /usr/local/go/src/net/http/server.go:2741 +0xab fp=0xc00018bd78 sp=0xc00018bd48 pc=0x11f427b net/http.(*conn).serve(0xc00009d180, 0x12f12c0, 0xc000116640) /usr/local/go/src/net/http/server.go:1847 +0x646 fp=0xc00018bfc8 sp=0xc00018bd78 pc=0x11f0d66 runtime.goexit() /usr/local/go/src/runtime/asm_amd64.s:1333 +0x1 fp=0xc00018bfd0 sp=0xc00018bfc8 pc=0x1057f81 created by net/http.(*Server).Serve /usr/local/go/src/net/http/server.go:2851 +0x2f5   é€šè¿‡panicå‡ºæ¥çš„åç¨‹è°ƒç”¨æ ˆä¿¡æ¯å¯ä»¥åˆ†æå‡ºï¼Œfmt printä¼šä¸æ–­çš„é€’å½’åå°„åŠéå†è§£æcontexté‡Œçš„æ•°æ®ã€‚ é€šè¿‡ä¸Šé¢çš„panicä¿¡æ¯æˆ‘ä»¬å¯ä»¥å¾—çŸ¥æ ¹æœ¬é—®é¢˜æ˜¯ç”±äºmapçš„å¹¶å‘è¯»å†™é€ æˆçš„ï¼Œè¿™ä¹Ÿå°±è¯´ context å†…éƒ¨æ˜¯æœ‰mapçš„ã€‚\næˆ‘ä»¬åœ¨æ­£å¸¸æƒ…å†µä¸‹æ‰“å°http.Request contextï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªmapï¼Œä¸€ä¸ªæ˜¯listenersï¼Œä¸€ä¸ªæ˜¯activeConnã€‚å¦å¤–åœ¨activeConnè¿™ä¸ªç»“æ„é‡Œè¿˜èƒ½çœ‹åˆ°å¾ˆå¤šçš„connã€‚è¯´æ˜è¿™ä¸ªcontextä¸å•å•æ˜¯å«æœ‰è¿™ä¸ªè¯·æ±‚æœ¬èº«éœ€è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯äº†ï¼Œè€Œä¸”è¿˜åŒ…å«äº†è¯¥serverå¯¹è±¡ã€‚\n1 2 3  // xiaorui.cc context.Background.WithValue(\u0026http.contextKey{name:\"http-server\"}, \u0026http.Server{Addr:\":9090\", Handler:http.Handler(nil), TLSConfig:(*tls.Config)(0xc000062780), ReadTimeout:0, ReadHeaderTimeout:0, WriteTimeout:0, IdleTimeout:0, MaxHeaderBytes:0, TLSNextProto:map[string]func(*http.Server, *tls.Conn, http.Handler){\"h2\":(func(*http.Server, *tls.Conn, http.Handler))(0x120b620)}, ConnState:(func(net.Conn, http.ConnState))(nil), ErrorLog:(*log.Logger)(nil), disableKeepAlives:0, inShutdown:0, nextProtoOnce:sync.Once{m:sync.Mutex{state:0, sema:0x0}, done:0x1}, nextProtoErr:error(nil), mu:sync.Mutex{state:0, sema:0x0}, listeners:map[*net.Listener]struct {}{(*net.Listener)(0xc00007ccb0):struct {}{}}, activeConn:map[*http.conn]struct {}{(*http.conn)(0xc00009cb40):struct {}{}, (*http.conn)(0xc00009d2c0):struct {}{}, (*http.conn)(0xc00009d540):struct {}{}, (*http.conn)(0xc00009dcc0):struct {}{}, (*http.conn)(0xc00009cd20):struct {}{}, (*http.conn)(0xc00009d5e0):struct {}{}, (*http.conn)(0xc00009d860):struct {}{}, (*http.conn)(0xc00009d9a0):struct {}{}, (*http.conn)(0xc0001940a0):struct {}{}, (*http.conn)(0xc00009cfa0):struct {}{}, (*http.conn)(0xc00009d400):struct {}{}, (*http.conn)(0xc00009dd60):struct {}{}, (*http.conn)(0xc000194140):struct {}{}, (*http.conn)(0xc0001941e0):struct {}{}, (*http.conn)(0xc00009caa0):struct {}{}, (*http.conn)(0xc00009d180):struct {}{}, (*http.conn)(0xc00009d220):struct {}{}, (*http.conn)(0xc00009d680):struct {}{}, (*http.conn)(0xc00009d900):struct {}{}, (*http.conn)(0xc00009cc80):struct {}{}, (*http.conn)(0xc00009ce60):struct {}{}, (*http.conn)(0xc00009d040):struct {}{}, (*http.conn)(0xc00009dc20):struct {}{}, (*http.conn)(0xc00009dea0):struct {}{}, (*http.conn)(0xc00009ca00):struct {}{}, (*http.conn)(0xc00009cdc0):struct {}{}, (*http.conn)(0xc00009d0e0):struct {}{}, (*http.conn)(0xc00009d360):struct {}{}, (*http.conn)(0xc00009da40):struct {}{}, (*http.conn)(0xc00009dae0):struct {}{}, (*http.conn)(0xc00009cbe0):struct {}{}, (*http.conn)(0xc00009d4a0):struct {}{}, (*http.conn)(0x   æˆ‘ä»¬å†æ¥åˆ†æä¸‹ net/httpçš„ä»£ç é‡Œå¯¹activeConn mapçš„ä¿®æ”¹é€»è¾‘ã€‚ä¸ç®¡æ˜¯åˆå§‹åŒ–ï¼Œæ–°å¢ï¼Œåˆ é™¤éƒ½æœ‰åŠ é”ã€‚ä½†æ˜¯ä»–çš„é”çš„èŒƒå›´åªæ˜¯ net/http serverçš„é”ã€‚fmt.Printfé‡Œå¯¹serverå¯¹è±¡çš„activeConn mapéå†æ‰“å°è‡ªç„¶ä¸å—å½±å“ã€‚\né‚£ä¹ˆï¼Œè‡ªç„¶å°±ä¼šæœ‰é€ æˆ map çš„panicã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // xiaorui.cc  // åˆ›å»ºå…ˆçš„æ´»åŠ¨è¿æ¥ func (s *Server) trackConn(c *conn, add bool) { s.mu.Lock() defer s.mu.Unlock() if s.activeConn == nil { s.activeConn = make(map[*conn]struct{}) } if add { s.activeConn[c] = struct{}{} } else { delete(s.activeConn, c) } } // å…³é—­ç©ºé—²è¿æ¥ func (s *Server) closeIdleConns() bool { s.mu.Lock() defer s.mu.Unlock() for c := range s.activeConn { st, unixSec := c.getState() ... delete(s.activeConn, c) } return quiescent }   è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªserveræ˜¯ä»å“ªé‡Œä¼ ç»™æ¯ä¸ªè¯·æ±‚çš„handlerçš„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  // xiaorui.cc  func (srv *Server) Serve(l net.Listener) error { baseCtx := context.Background() ... // æŠŠä»–è‡ªèº«é€šè¿‡withValueç”Ÿæˆä¸€ä¸ªctxï¼Œå¹¶ä¼ é€’ä¸‹å» \tctx := context.WithValue(baseCtx, ServerContextKey, srv) for { rw, e := l.Accept() ... go c.serve(ctx) } } // Serve a new connection. func (c *conn) serve(ctx context.Context) { c.remoteAddr = c.rwc.RemoteAddr().String() ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr()) ... for { w, err := c.readRequest(ctx) if c.r.remain != c.server.initialReadLimitSize() { // If we read any bytes off the wire, we're active. \tc.setState(c.rwc, StateActive) } ... req := w.req serverHandler{c.server}.ServeHTTP(w, w.req) } } }   å¦‚ä½•è§£å†³ï¼Ÿ æˆ–è€…è¯´å®‰å…¨æ‰“å°\nåˆ«ç›´æ¥æŠŠcontextéƒ½è¾“å‡ºæ‰“å°å°±å¯ä»¥äº†ã€‚ğŸ˜…\nWithTimeoutè¦†ç›–WithCancel context.WithCancel å†…éƒ¨å¯åŠ¨ goroutineï¼Œåœ¨ ctx è¢«è¦†ç›–åæ³„éœ²\næ€»ç»“ åˆ°è¿™é‡Œï¼Œæ•´ä¸ª context åŒ…çš„å†…å®¹å°±å…¨éƒ¨è®²å®Œäº†ã€‚æºç éå¸¸çŸ­ï¼Œå¾ˆé€‚åˆå­¦ä¹ ï¼Œä¸€å®šè¦å»è¯»ä¸€ä¸‹ã€‚\ncontext åŒ…æ˜¯ Go 1.7 å¼•å…¥çš„æ ‡å‡†åº“ï¼Œä¸»è¦ç”¨äºåœ¨ goroutine ä¹‹é—´ä¼ é€’å–æ¶ˆä¿¡å·ã€è¶…æ—¶æ—¶é—´ã€æˆªæ­¢æ—¶é—´ä»¥åŠä¸€äº›å…±äº«çš„å€¼ç­‰ã€‚å®ƒå¹¶ä¸æ˜¯å¤ªå®Œç¾ï¼Œä½†å‡ ä¹æˆäº†å¹¶å‘æ§åˆ¶å’Œè¶…æ—¶æ§åˆ¶çš„æ ‡å‡†åšæ³•ã€‚\nä½¿ç”¨ä¸Šï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæ ¹èŠ‚ç‚¹çš„ contextï¼Œä¹‹åæ ¹æ®åº“æä¾›çš„å››ä¸ªå‡½æ•°åˆ›å»ºç›¸åº”åŠŸèƒ½çš„å­èŠ‚ç‚¹ contextã€‚ç”±äºå®ƒæ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒåœ°ä¼ é€’ã€‚\nå½“ä½¿ç”¨ context ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œç›´æ¥æŠŠå®ƒæ”¾åœ¨ç¬¬ä¸€ä¸ªå‚æ•°çš„ä½ç½®ï¼Œå¹¶ä¸”å‘½åä¸º ctxã€‚å¦å¤–ï¼Œä¸è¦æŠŠ context åµŒå¥—åœ¨è‡ªå®šä¹‰çš„ç±»å‹é‡Œã€‚\næœ€åï¼Œå¤§å®¶ä¸‹æ¬¡åœ¨çœ‹åˆ°ä»£ç é‡Œæœ‰ç”¨åˆ° context çš„ï¼Œè§‚å¯Ÿä¸‹æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œè‚¯å®šé€ƒä¸å‡ºæˆ‘ä»¬è®²çš„å‡ ç§ç±»å‹ã€‚ç†Ÿæ‚‰ä¹‹åä¼šå‘ç°ï¼šcontext å¯èƒ½å¹¶ä¸å®Œç¾ï¼Œä½†å®ƒç¡®å®ç®€æ´é«˜æ•ˆåœ°è§£å†³äº†é—®é¢˜ã€‚\nå‚è€ƒ The Go Blog: å…³äº context çš„ä¸€ç‚¹æœ€ä½³å®è·µ\næ·±åº¦è§£å¯†Goè¯­è¨€ä¹‹context\ngolang net/httpè¾“å‡ºcontextå¼•èµ·çš„map panic\n",
  "wordCount" : "5932",
  "inLanguage": "zh-cn",
  "datePublished": "2021-05-19T17:47:08Z",
  "dateModified": "2021-05-19T17:47:08Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/context%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      contextä½¿ç”¨å®è·µ
    </h1>
    <div class="post-meta">May 19, 2021
</div>
  </header> 
  <div class="post-content"><h2 id="å¦‚ä½•ä½¿ç”¨-context">å¦‚ä½•ä½¿ç”¨ context<a hidden class="anchor" aria-hidden="true" href="#å¦‚ä½•ä½¿ç”¨-context">#</a></h2>
<p>context ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚æºç é‡Œå¯¹å¤–æä¾›äº†ä¸€ä¸ªåˆ›å»ºæ ¹èŠ‚ç‚¹ context çš„å‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Background</span><span class="p">()</span> <span class="nx">Context</span>
</code></pre></td></tr></table>
</div>
</div><p>background æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œ å®ƒä¸èƒ½è¢«å–æ¶ˆï¼Œæ²¡æœ‰å€¼ï¼Œä¹Ÿæ²¡æœ‰è¶…æ—¶æ—¶é—´ã€‚</p>
<p>æœ‰äº†æ ¹èŠ‚ç‚¹ contextï¼Œåˆæä¾›äº†å››ä¸ªå‡½æ•°åˆ›å»ºå­èŠ‚ç‚¹ contextï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WithCancel</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">ctx</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">cancel</span> <span class="nx">CancelFunc</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">WithDeadline</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">(</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">CancelFunc</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">CancelFunc</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">WithValue</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="kd">interface</span><span class="p">{})</span> <span class="nx">Context</span>
</code></pre></td></tr></table>
</div>
</div><p>context ä¼šåœ¨å‡½æ•°ä¼ é€’é—´ä¼ é€’ã€‚åªéœ€è¦åœ¨é€‚å½“çš„æ—¶é—´è°ƒç”¨ cancel å‡½æ•°å‘ goroutines å‘å‡ºå–æ¶ˆä¿¡å·æˆ–è€…è°ƒç”¨ Value å‡½æ•°å–å‡º context ä¸­çš„å€¼ã€‚</p>
<p>åœ¨ä½¿ç”¨ Context çš„æ—¶å€™,æœ‰ä¸€äº›çº¦å®šä¿—æˆçš„è§„åˆ™ã€‚</p>
<ol>
<li>ä¸€èˆ¬å‡½æ•°ä½¿ç”¨ Context çš„æ—¶å€™,ä¼šæŠŠè¿™ä¸ªå‚æ•°æ”¾åœ¨ç¬¬ä¸€ä¸ªå‚æ•°çš„ä½ç½®ã€‚</li>
<li>ä»æ¥ä¸æŠŠ nil å½“åš Context ç±»å‹çš„å‚æ•°å€¼,å¯ä»¥ä½¿ç”¨ context.Background() åˆ›å»ºä¸€ä¸ªç©ºçš„ä¸Šä¸‹æ–‡å¯¹è±¡,ä¹Ÿä¸è¦ä½¿ç”¨ nilã€‚</li>
<li>Context åªç”¨æ¥ä¸´æ—¶åšå‡½æ•°ä¹‹é—´çš„ä¸Šä¸‹æ–‡é€ä¼ ,ä¸èƒ½æŒä¹…åŒ– Context æˆ–è€…æŠŠ Context é•¿ä¹…ä¿å­˜ã€‚æŠŠ Context æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€æœ¬åœ°æ–‡ä»¶æˆ–è€…å…¨å±€å˜é‡ã€ç¼“å­˜ä¸­éƒ½æ˜¯é”™è¯¯çš„ç”¨æ³•ã€‚</li>
<li>key çš„ç±»å‹ä¸åº”è¯¥æ˜¯å­—ç¬¦ä¸²ç±»å‹æˆ–è€…å…¶å®ƒå†…å»ºç±»å‹,å¦åˆ™å®¹æ˜“åœ¨åŒ…ä¹‹é—´ä½¿ç”¨ Context æ—¶å€™äº§ç”Ÿå†²çªã€‚ä½¿ç”¨ WithValue æ—¶,key çš„ç±»å‹åº”è¯¥æ˜¯è‡ªå·±å®šä¹‰çš„ç±»å‹ã€‚</li>
<li>å¸¸å¸¸ä½¿ç”¨ struct{}ä½œä¸ºåº•å±‚ç±»å‹å®šä¹‰ key çš„ç±»å‹ã€‚å¯¹äº exported key çš„é™æ€ç±»å‹,å¸¸å¸¸æ˜¯æ¥å£æˆ–è€…æŒ‡é’ˆã€‚è¿™æ ·å¯ä»¥å°½é‡å‡å°‘å†…å­˜åˆ†é…ã€‚</li>
</ol>
<h2 id="ä¼ é€’å…±äº«çš„æ•°æ®">ä¼ é€’å…±äº«çš„æ•°æ®<a hidden class="anchor" aria-hidden="true" href="#ä¼ é€’å…±äº«çš„æ•°æ®">#</a></h2>
<p>å¯¹äº Web æœåŠ¡ç«¯å¼€å‘ï¼Œå¾€å¾€å¸Œæœ›å°†ä¸€ä¸ªè¯·æ±‚å¤„ç†çš„æ•´ä¸ªè¿‡ç¨‹ä¸²èµ·æ¥ï¼Œè¿™å°±éå¸¸ä¾èµ–äº Thread Localï¼ˆå¯¹äº Go å¯ç†è§£ä¸ºå•ä¸ªåç¨‹æ‰€ç‹¬æœ‰ï¼‰ çš„å˜é‡ï¼Œè€Œåœ¨ Go è¯­è¨€ä¸­å¹¶æ²¡æœ‰è¿™ä¸ªæ¦‚å¿µï¼Œå› æ­¤éœ€è¦åœ¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ä¼ é€’ contextã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
    <span class="nf">process</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

    <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;traceId&#34;</span><span class="p">,</span> <span class="s">&#34;qcrao-2019&#34;</span><span class="p">)</span>
    <span class="nf">process</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">process</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">traceId</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="s">&#34;traceId&#34;</span><span class="p">).(</span><span class="kt">string</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;process over. trace_id=%s\n&#34;</span><span class="p">,</span> <span class="nx">traceId</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;process over. no trace_id\n&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">process</span> <span class="n">over.</span> <span class="n">no</span> <span class="n">trace_id</span>
<span class="n">process</span> <span class="n">over.</span> <span class="n">trace_id</span><span class="o">=</span><span class="n">qcrao</span><span class="m">-2019</span>
</code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸€æ¬¡è°ƒç”¨ process å‡½æ•°æ—¶ï¼Œctx æ˜¯ä¸€ä¸ªç©ºçš„ contextï¼Œè‡ªç„¶å–ä¸å‡ºæ¥ traceIdã€‚ç¬¬äºŒæ¬¡ï¼Œé€šè¿‡ WithValue å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ª contextï¼Œå¹¶èµ‹ä¸Šäº† traceId è¿™ä¸ª keyï¼Œè‡ªç„¶å°±èƒ½å–å‡ºæ¥ä¼ å…¥çš„ value å€¼ã€‚</p>
<p>å½“ç„¶ï¼Œç°å®åœºæ™¯ä¸­å¯èƒ½æ˜¯ä»ä¸€ä¸ª HTTP è¯·æ±‚ä¸­è·å–åˆ°çš„ Request-IDã€‚æ‰€ä»¥ï¼Œä¸‹é¢è¿™ä¸ªæ ·ä¾‹å¯èƒ½æ›´é€‚åˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="nx">requestIDKey</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">0</span>

<span class="kd">func</span> <span class="nf">WithRequestID</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span>
        <span class="kd">func</span><span class="p">(</span><span class="nx">rw</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ä» header ä¸­æå– request-id
</span><span class="c1"></span>            <span class="nx">reqID</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;X-Request-ID&#34;</span><span class="p">)</span>
            <span class="c1">// åˆ›å»º valueCtxã€‚ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»å‹ï¼Œä¸å®¹æ˜“å†²çª
</span><span class="c1"></span>            <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span>
                <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">(),</span> <span class="nx">requestIDKey</span><span class="p">,</span> <span class="nx">reqID</span><span class="p">)</span>

            <span class="c1">// åˆ›å»ºæ–°çš„è¯·æ±‚
</span><span class="c1"></span>            <span class="nx">req</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

            <span class="c1">// è°ƒç”¨ HTTP å¤„ç†å‡½æ•°
</span><span class="c1"></span>            <span class="nx">next</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">rw</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="c1">// è·å– request-id
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GetRequestID</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="nx">requestIDKey</span><span class="p">).(</span><span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Handle</span><span class="p">(</span><span class="nx">rw</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ‹¿åˆ° reqIdï¼Œåé¢å¯ä»¥è®°å½•æ—¥å¿—ç­‰ç­‰
</span><span class="c1"></span>    <span class="nx">reqID</span> <span class="o">:=</span> <span class="nf">GetRequestID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">())</span>
    <span class="o">...</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">handler</span> <span class="o">:=</span> <span class="nf">WithRequestID</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Handle</span><span class="p">))</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="å–æ¶ˆ-goroutine">å–æ¶ˆ goroutine<a hidden class="anchor" aria-hidden="true" href="#å–æ¶ˆ-goroutine">#</a></h2>
<p>æˆ‘ä»¬å…ˆæ¥è®¾æƒ³ä¸€ä¸ªåœºæ™¯ï¼šæ‰“å¼€å¤–å–çš„è®¢å•é¡µï¼Œåœ°å›¾ä¸Šæ˜¾ç¤ºå¤–å–å°å“¥çš„ä½ç½®ï¼Œè€Œä¸”æ˜¯æ¯ç§’æ›´æ–° 1 æ¬¡ã€‚app ç«¯å‘åå°å‘èµ· websocket è¿æ¥ï¼ˆç°å®ä¸­å¯èƒ½æ˜¯è½®è¯¢ï¼‰è¯·æ±‚åï¼Œåå°å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œæ¯éš” 1 ç§’è®¡ç®— 1 æ¬¡å°å“¥çš„ä½ç½®ï¼Œå¹¶å‘é€ç»™ç«¯ã€‚å¦‚æœç”¨æˆ·é€€å‡ºæ­¤é¡µé¢ï¼Œåˆ™åå°éœ€è¦â€œå–æ¶ˆâ€æ­¤è¿‡ç¨‹ï¼Œé€€å‡º goroutineï¼Œç³»ç»Ÿå›æ”¶èµ„æºã€‚</p>
<p>åç«¯å¯èƒ½çš„å®ç°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Perform</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nf">calculatePos</span><span class="p">()</span>
        <span class="nf">sendResult</span><span class="p">()</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœéœ€è¦å®ç°â€œå–æ¶ˆâ€åŠŸèƒ½ï¼Œå¹¶ä¸”åœ¨ä¸äº†è§£ context åŠŸèƒ½çš„å‰æä¸‹ï¼Œå¯èƒ½ä¼šè¿™æ ·åšï¼šç»™å‡½æ•°å¢åŠ ä¸€ä¸ªæŒ‡é’ˆå‹çš„ bool å˜é‡ï¼Œåœ¨ for è¯­å¥çš„å¼€å§‹å¤„åˆ¤æ–­ bool å˜é‡æ˜¯å‘ç”± true å˜ä¸º falseï¼Œå¦‚æœæ”¹å˜ï¼Œåˆ™é€€å‡ºå¾ªç¯ã€‚</p>
<p>ä¸Šé¢ç»™å‡ºçš„ç®€å•åšæ³•ï¼Œå¯ä»¥å®ç°æƒ³è¦çš„æ•ˆæœï¼Œæ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¹¶ä¸ä¼˜é›…ï¼Œå¹¶ä¸”ä¸€æ—¦åç¨‹æ•°é‡å¤šäº†ä¹‹åï¼Œå¹¶ä¸”å„ç§åµŒå¥—ï¼Œå°±ä¼šå¾ˆéº»çƒ¦ã€‚ä¼˜é›…çš„åšæ³•ï¼Œè‡ªç„¶å°±è¦ç”¨åˆ° contextã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Perform</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nf">calculatePos</span><span class="p">()</span>
        <span class="nf">sendResult</span><span class="p">()</span>

        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
            <span class="c1">// è¢«å–æ¶ˆï¼Œç›´æ¥è¿”å›
</span><span class="c1"></span>            <span class="k">return</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
            <span class="c1">// block 1 ç§’é’Ÿ
</span><span class="c1"></span>        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸»æµç¨‹å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span>
<span class="k">go</span> <span class="nf">Perform</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

<span class="c1">// â€¦â€¦
</span><span class="c1">// app ç«¯è¿”å›é¡µé¢ï¼Œè°ƒç”¨cancel å‡½æ•°
</span><span class="c1"></span><span class="nf">cancel</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„ä¸€ä¸ªç»†èŠ‚ï¼ŒWithTimeOut å‡½æ•°è¿”å›çš„ context å’Œ cancelFun æ˜¯åˆ†å¼€çš„ã€‚context æœ¬èº«å¹¶æ²¡æœ‰å–æ¶ˆå‡½æ•°ï¼Œè¿™æ ·åšçš„åŸå› æ˜¯å–æ¶ˆå‡½æ•°åªèƒ½ç”±å¤–å±‚å‡½æ•°è°ƒç”¨ï¼Œé˜²æ­¢å­èŠ‚ç‚¹ context è°ƒç”¨å–æ¶ˆå‡½æ•°ï¼Œä»è€Œä¸¥æ ¼æ§åˆ¶ä¿¡æ¯çš„æµå‘ï¼šç”±çˆ¶èŠ‚ç‚¹ context æµå‘å­èŠ‚ç‚¹ contextã€‚</p>
<h2 id="é˜²æ­¢-goroutine-æ³„æ¼">é˜²æ­¢ goroutine æ³„æ¼<a hidden class="anchor" aria-hidden="true" href="#é˜²æ­¢-goroutine-æ³„æ¼">#</a></h2>
<p>å‰é¢é‚£ä¸ªä¾‹å­é‡Œï¼Œgoroutine è¿˜æ˜¯ä¼šè‡ªå·±æ‰§è¡Œå®Œï¼Œæœ€åè¿”å›ï¼Œåªä¸è¿‡ä¼šå¤šæµªè´¹ä¸€äº›ç³»ç»Ÿèµ„æºã€‚è¿™é‡Œæ”¹ç¼–ä¸€ä¸ªâ€œå¦‚æœä¸ç”¨ context å–æ¶ˆï¼Œgoroutine å°±ä¼šæ³„æ¼çš„ä¾‹å­â€ï¼Œæ¥è‡ªå‚è€ƒèµ„æ–™ï¼šã€é¿å…åç¨‹æ³„æ¼ã€‘ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">gen</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">n</span>
            <span class="nx">n</span><span class="o">++</span>
            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ˜¯ä¸€ä¸ªå¯ä»¥ç”Ÿæˆæ— é™æ•´æ•°çš„åç¨‹ï¼Œä½†å¦‚æœæˆ‘åªéœ€è¦å®ƒäº§ç”Ÿçš„å‰ 5 ä¸ªæ•°ï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿ goroutine æ³„æ¼ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nf">gen</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// â€¦â€¦
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å½“ n == 5 çš„æ—¶å€™ï¼Œç›´æ¥ break æ‰ã€‚é‚£ä¹ˆ gen å‡½æ•°çš„åç¨‹å°±ä¼šæ‰§è¡Œæ— é™å¾ªç¯ï¼Œæ°¸è¿œä¸ä¼šåœä¸‹æ¥ã€‚å‘ç”Ÿäº† goroutine æ³„æ¼ã€‚</p>
<p>ç”¨ context æ”¹è¿›è¿™ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">gen</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="k">case</span> <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">n</span><span class="p">:</span>
                <span class="nx">n</span><span class="o">++</span>
                <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
    <span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span> <span class="c1">// é¿å…å…¶ä»–åœ°æ–¹å¿˜è®° cancelï¼Œä¸”é‡å¤è°ƒç”¨ä¸å½±å“
</span><span class="c1"></span>
    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nf">gen</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">{</span>
            <span class="nf">cancel</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// â€¦â€¦
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¢åŠ ä¸€ä¸ª contextï¼Œåœ¨ break å‰è°ƒç”¨ cancel å‡½æ•°ï¼Œå–æ¶ˆ goroutineã€‚gen å‡½æ•°åœ¨æ¥æ”¶åˆ°å–æ¶ˆä¿¡å·åï¼Œç›´æ¥é€€å‡ºï¼Œç³»ç»Ÿå›æ”¶èµ„æºã€‚</p>
<h2 id="ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’">ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’<a hidden class="anchor" aria-hidden="true" href="#ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’">#</a></h2>
<p>åœ¨è®¸å¤š Go APIï¼Œå°¤å…¶æ˜¯ç°ä»£ API ä¸­ï¼Œå‡½æ•°å’Œæ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°é€šå¸¸æ˜¯ context.Contextã€‚context æä¾›äº†å¾ˆå¤šæ–¹æ³•ä¾‹å¦‚ WithCancelã€WithDeadlineã€WithValueã€ä»¥å®ç°è·¨ API çš„æµç¨‹æ§åˆ¶ã€‚å¾ˆå¤š lib åœ¨ä¸è¿œç¨‹æœåŠ¡å™¨(å¦‚æ•°æ®åº“ã€apiç­‰)äº¤äº’æ—¶ï¼Œç»å¸¸ä½¿ç”¨ context åšæ§åˆ¶ã€‚</p>
<p>context çš„æ–‡æ¡£ä¸­è®²åˆ°:</p>
<p>context ä¸åº”å­˜å‚¨åœ¨ struct å†…éƒ¨ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’</p>
<p>æœ¬æ–‡åœ¨æ­¤å»ºè®®çš„åŸºç¡€ä¸Šè®²è§£äº†åŸå› å’Œç¤ºä¾‹ï¼Œè¯´æ˜äº†ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å‡½æ•°ä¼ é€’ Context è€Œä¸æ˜¯å°†å…¶å­˜å‚¨åœ¨ struct ä¸­çš„é‡è¦æ€§ã€‚è¿˜ä»¥ net/http çš„ä»£ç ä¸ºä¾‹ï¼Œè§£é‡Šäº†åº”è¯¥åœ¨ä½•ç§æƒ…å†µä¸‹å¯ä»¥åœ¨ struct ä¸­ å­˜å‚¨ Context ã€‚</p>
<h3 id="æ¨è-context-ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’">æ¨è context ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’<a hidden class="anchor" aria-hidden="true" href="#æ¨è-context-ä½œä¸ºå‡½æ•°å‚æ•°ä¼ é€’">#</a></h3>
<p>è®©æˆ‘ä»¬å…ˆçœ‹ä¸‹åœ¨å‡½æ•°ä¸­ä¼ é€’ contextï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Worker</span> <span class="kd">struct</span> <span class="p">{</span> <span class="cm">/*â€¦*/</span> <span class="p">}</span>

<span class="kd">type</span> <span class="nx">Work</span> <span class="kd">struct</span> <span class="p">{</span> <span class="cm">/*â€¦*/</span> <span class="p">}</span>

<span class="kd">func</span> <span class="nf">New</span><span class="p">()</span> <span class="o">*</span><span class="nx">Worker</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Worker</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">Worker</span><span class="p">)</span> <span class="nf">Fetch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Work</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctx</span> <span class="c1">// A per-call ctx is used for cancellation, deadlines, and metadata.
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">Worker</span><span class="p">)</span> <span class="nf">Process</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">w</span><span class="o">*</span><span class="nx">Work</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctx</span> <span class="c1">// A per-call ctx is used for cancellation, deadlines, and metadata.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œ <code>(*Worker).Fetch</code> å’Œ <code>(*Worker).Process</code> éƒ½ç›´æ¥å°† context ä½œä¸ºå‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ã€‚è¿™æ ·ä» context çš„ç”Ÿæˆåˆ°ç»“æŸï¼Œè°ƒç”¨æ–¹å¯ä»¥å¾ˆæ¸…æ™°åœ°çŸ¥é“ context çš„ä¼ é€’è·¯çº¿ã€‚</p>
<h3 id="å°†-context-å­˜å‚¨åˆ°-strcut-æ‰€å¸¦æ¥çš„ä¸€äº›å›°æƒ‘">å°† context å­˜å‚¨åˆ° strcut æ‰€å¸¦æ¥çš„ä¸€äº›å›°æƒ‘<a hidden class="anchor" aria-hidden="true" href="#å°†-context-å­˜å‚¨åˆ°-strcut-æ‰€å¸¦æ¥çš„ä¸€äº›å›°æƒ‘">#</a></h3>
<p>åœ¨ç»“æ„ä½“ä¸­åµŒå¥— context æ¥å®ç°ä¸Šé¢çš„ Worker ç¤ºä¾‹ï¼Œè°ƒç”¨è€…å¯¹æ‰€ä½¿ç”¨çš„ context ç”Ÿå‘½å‘¨æœŸäº§ç”Ÿè¿·æƒ‘ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Worker</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="o">*</span><span class="nx">Worker</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Worker</span><span class="p">{</span><span class="nx">ctx</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">Worker</span><span class="p">)</span> <span class="nf">Fetch</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">Work</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">ctx</span> <span class="c1">// A shared w.ctx is used for cancellation, deadlines, and metadata.
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">Worker</span><span class="p">)</span> <span class="nf">Process</span><span class="p">(</span><span class="nx">w</span><span class="o">*</span><span class="nx">Work</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">ctx</span> <span class="c1">// A shared w.ctx is used for cancellation, deadlines, and metadata.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>(*Worker).Fetch</code> å’Œ <code>(*Worker).Process</code> æ–¹æ³•åŒæ—¶ä½¿ç”¨äº† Worker ç»“æ„ä½“ä¸­çš„ context ï¼Œè¿™ç§æƒ…å†µä¸‹ä½¿å¾—è°ƒç”¨æ–¹æ— æ³•å®šä¹‰ä¸åŒçš„ context ï¼Œæ¯”å¦‚æœ‰è°ƒç”¨æ–¹æƒ³ç”¨ WitchCancelï¼Œæœ‰çš„æƒ³ç”¨ WithDeadlineï¼Œä¹Ÿå¾ˆéš¾ç†è§£ä¸Šé¢ä¼ æ¥çš„ context çš„ä½œç”¨æ˜¯ cancelï¼Ÿè¿˜æ˜¯ deadline?è°ƒç”¨è€…æ‰€ä½¿ç”¨ context çš„ç”Ÿå‘½å‘¨æœŸè¢«ç»‘å®šåˆ°äº†ä¸€ä¸ªå…±äº«çš„ context ä¸Šé¢ã€‚</p>
<h3 id="ç‰¹æ®Šæƒ…å†µä¿ç•™å‘åå…¼å®¹æ€§">ç‰¹æ®Šæƒ…å†µï¼šä¿ç•™å‘åå…¼å®¹æ€§<a hidden class="anchor" aria-hidden="true" href="#ç‰¹æ®Šæƒ…å†µä¿ç•™å‘åå…¼å®¹æ€§">#</a></h3>
<p>å½“ go 1.7 ç‰ˆæœ¬å‘å¸ƒæ—¶ï¼Œå¤§é‡çš„çš„ API éœ€è¦ä»¥å‘åå…¼å®¹çš„æ–¹å¼æ”¯æŒ context.Contextï¼Œä¾‹å¦‚ï¼Œnet/http çš„ Client æ–¹æ³•ï¼ˆä¾‹å¦‚Getå’ŒDoï¼‰æ˜¯ä½¿ç”¨ context çš„å…¸èŒƒã€‚ä½¿ç”¨è¿™äº›æ–¹æ³•å‘é€çš„ http è¯·æ±‚éƒ½å°†å—ç›Šäº context.Context é™„å¸¦çš„ WithDeadlineï¼ŒWithCancel å’Œ WithValue ç­‰æ–¹æ³•æ”¯æŒã€‚</p>
<p>ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼èƒ½å¤Ÿåœ¨æ”¯æŒ context.Context çš„åŒæ—¶ä¿æŒä»£ç çš„å‘åå…¼å®¹ï¼š</p>
<ol>
<li>åœ¨ struct ä¸­æ·»åŠ  context (ç¨åæˆ‘ä»¬å°†çœ‹åˆ°)ï¼›</li>
<li>å¤åˆ¶åŸæœ‰å‡½æ•°ï¼Œåœ¨å‡½æ•°ç¬¬ä¸€ä¸ªå‚æ•°ä¸­ä½¿ç”¨ contextï¼Œä¸¾ä¸ªæ —å­ï¼Œdatabase/sql è¿™ä¸ª package çš„ Query æ–¹æ³•çš„ç­¾åä¸€ç›´æ˜¯:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Query</span><span class="p">(</span><span class="nx">query</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">Rows</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>å½“ context package å¼•å…¥çš„æ—¶å€™ï¼ŒGo team æ–°å¢äº†è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">QueryContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">query</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">Rows</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>å¹¶ä¸”åªä¿®æ”¹äº†ä¸€å¤„ä»£ç ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Query</span><span class="p">(</span><span class="nx">query</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">Rows</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nf">QueryContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒGo team èƒ½å¤Ÿåœ¨å¹³æ»‘åœ°å‡çº§ä¸€ä¸ª package çš„åŒæ—¶ä¸å¯¹ä»£ç çš„å¯è¯»æ€§ã€å…¼å®¹æ€§é€ æˆå½±å“ã€‚ç±»ä¼¼çš„ä»£ç åœ¨ golang æºç ä¸­éšå¤„å¯è§ã€‚æ›´å¤šçš„ä¿æŒä»£ç å…¼å®¹æ€§çš„è®¨è®ºå¯è§ [Go team å…³äºå¦‚ä½•ä¿æŒ Go Modules å…¼å®¹æ€§çš„ä¸€äº›å®è·µ]ã€‚</p>
<p>ç„¶è€Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ API å…¬å¼€äº†å¤§é‡ functionï¼Œé‡å†™æ‰€æœ‰å‡½æ•°æ˜¯ä¸åˆ‡å®é™…çš„ã€‚</p>
<p>package net/http é€‰æ‹©åœ¨ struct ä¸­æ·»åŠ  context.Contextï¼Œè¿™æ˜¯ä¸€ä¸ªç»“æ„ä½“åµŒå¥— context æ¯”è¾ƒæ°å½“çš„èŒƒä¾‹ã€‚å…ˆè®©æˆ‘ä»¬çœ‹ä¸‹ net/http çš„ Do å‡½æ•°ã€‚åœ¨å¼•å…¥ context ä¹‹å‰ï¼ŒDo çš„å®šä¹‰å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ 1.7 å¼•å…¥ context åï¼Œä¸ºäº†éµå¾ª net/http è¿™ç§æ ‡å‡†åº“çš„å‘åå…¼å®¹åŸåˆ™ï¼Œè€ƒè™‘åˆ°è¯¥æ ¸å¿ƒåº“æ‰€åŒ…å«çš„å‡½æ•°è¿‡äºå¤šï¼Œmaintainers é€‰æ‹©åœ¨ç»“æ„ä½“ http.Request ä¸­æ·»åŠ  context.Contextã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>

  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewRequestWithContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">url</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">body</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Simplified for brevity of this article.
</span><span class="c1"></span>  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Request</span><span class="p">{</span>
    <span class="nx">ctx</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">,</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>åœ¨ä¿®æ”¹å¤§é‡ API ä»¥æ”¯æŒ context æ—¶ï¼Œåœ¨ç»“æ„ä½“ä¸­æ·»åŠ  context.Context æ˜¯æœ‰æ„ä¹‰çš„ï¼Œ å¦‚ä¸Šæ‰€è¿°ã€‚ä½†æ˜¯ï¼Œè®°ä½é¦–å…ˆè¦è€ƒè™‘å¤åˆ¶å‡½æ•°å¯¹ context è¿›è¡Œæ”¯æŒï¼Œåœ¨ä¸ç‰ºç‰²å®ç”¨æ€§å’Œç†è§£æ€§çš„å‰æä¸‹å‘åå…¼å®¹ä¸Šä¸‹æ–‡:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Call</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">CallContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">CallContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="context-çœŸçš„è¿™ä¹ˆå¥½å—">context çœŸçš„è¿™ä¹ˆå¥½å—<a hidden class="anchor" aria-hidden="true" href="#context-çœŸçš„è¿™ä¹ˆå¥½å—">#</a></h2>
<p>è¯»å®Œå…¨æ–‡ï¼Œä½ ä¸€å®šæœ‰è¿™ç§æ„Ÿè§‰ï¼šcontext å°±æ˜¯ä¸º server è€Œè®¾è®¡çš„ã€‚è¯´ä»€ä¹ˆå¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œéœ€è¦å¯åŠ¨å¤šä¸ª goroutine å¹¶è¡Œåœ°å»å¤„ç†ï¼Œå¹¶ä¸”åœ¨è¿™äº› goroutine ä¹‹é—´è¿˜è¦ä¼ é€’ä¸€äº›å…±äº«çš„æ•°æ®ç­‰ç­‰ï¼Œè¿™äº›éƒ½æ˜¯å†™ä¸€ä¸ª server è¦åšçš„äº‹ã€‚</p>
<p>æ²¡é”™ï¼ŒGo å¾ˆé€‚åˆå†™ serverï¼Œä½†å®ƒç»ˆå½’æ˜¯ä¸€é—¨é€šç”¨çš„è¯­è¨€ã€‚ä½ åœ¨ç”¨ Go åš Leetcode ä¸Šé¢çš„é¢˜ç›®çš„æ—¶å€™ï¼Œè‚¯å®šä¸ä¼šè®¤ä¸ºå®ƒå’Œä¸€èˆ¬çš„è¯­è¨€æœ‰ä»€ä¹ˆå·®åˆ«ã€‚æ‰€ä»¥ï¼Œå¾ˆå¤šç‰¹æ€§å¥½ä¸å¥½ï¼Œåº”è¯¥ä» Go åªæ˜¯ä¸€é—¨æ™®é€šçš„è¯­è¨€ï¼Œå¾ˆæ“…é•¿å†™ server çš„è§’åº¦æ¥çœ‹ã€‚</p>
<p>ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼Œcontext å¹¶æ²¡æœ‰é‚£ä¹ˆç¾å¥½ã€‚Go å®˜æ–¹å»ºè®®æˆ‘ä»¬æŠŠ Context ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç”šè‡³è¿åå­—éƒ½å‡†å¤‡å¥½äº†ã€‚è¿™é€ æˆä¸€ä¸ªåæœï¼šå› ä¸ºæˆ‘ä»¬æƒ³æ§åˆ¶æ‰€æœ‰çš„åç¨‹çš„å–æ¶ˆåŠ¨ä½œï¼Œæ‰€ä»¥éœ€è¦åœ¨å‡ ä¹æ‰€æœ‰çš„å‡½æ•°é‡ŒåŠ ä¸Šä¸€ä¸ª Context å‚æ•°ã€‚å¾ˆå¿«ï¼Œæˆ‘ä»¬çš„ä»£ç é‡Œï¼Œcontext å°†åƒç—…æ¯’ä¸€æ ·æ‰©æ•£çš„åˆ°å¤„éƒ½æ˜¯ã€‚</p>
<p>åœ¨å‚è€ƒèµ„æ–™ã€Go2 åº”è¯¥å»æ‰ contextã€‘è¿™ç¯‡è‹±æ–‡åšå®¢é‡Œï¼Œä½œè€…ç”šè‡³è°ƒä¾ƒè¯´ï¼šå¦‚æœè¦æŠŠ Go æ ‡å‡†åº“çš„å¤§éƒ¨åˆ†å‡½æ•°éƒ½åŠ ä¸Š context å‚æ•°çš„è¯ï¼Œä¾‹å¦‚ä¸‹é¢è¿™æ ·ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">p</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>å°±ç»™æˆ‘æ¥ä¸€æªå§ï¼</p>
<p>åŸæ–‡æ˜¯è¿™æ ·è¯´çš„ï¼šput a bullet in my head, please.æˆ‘å½“æ—¶çœ‹åˆ°è¿™å¥è¯çš„æ—¶å€™ï¼Œä¼šå¿ƒä¸€ç¬‘ã€‚è¿™å¯èƒ½å°±æ˜¯é™¶æ¸Šæ˜è¯´çš„ï¼šæ¯æœ‰ä¼šæ„ï¼Œä¾¿æ¬£ç„¶å¿˜é£Ÿã€‚å½“ç„¶ï¼Œæˆ‘æ˜¯åœ¨æ™šé¥­ä¼šçœ‹åˆ°è¿™å¥è¯çš„ã€‚</p>
<p>ä¸ºäº†è¡¨è¾¾è‡ªå·±å¯¹ context å¹¶æ²¡æœ‰ä»€ä¹ˆå¥½æ„Ÿï¼Œä½œè€…æ¥ç€åˆè¯´äº†ä¸€å¥ï¼šIf you use ctx.Value in my (non-existent) company, youâ€™re fired. ç®€ç›´å¤ªå¹½é»˜äº†ï¼Œå“ˆå“ˆã€‚</p>
<p>å¦å¤–ï¼Œåƒ WithCancelã€WithDeadlineã€WithTimeoutã€WithValue è¿™äº›åˆ›å»ºå‡½æ•°ï¼Œå®é™…ä¸Šæ˜¯åˆ›å»ºäº†ä¸€ä¸ªä¸ªçš„é“¾è¡¨ç»“ç‚¹è€Œå·²ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå¯¹é“¾è¡¨çš„æ“ä½œï¼Œé€šå¸¸éƒ½æ˜¯ O(n) å¤æ‚åº¦çš„ï¼Œæ•ˆç‡ä¸é«˜ã€‚</p>
<p>é‚£ä¹ˆï¼Œcontext åŒ…åˆ°åº•è§£å†³äº†ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šcancelationã€‚ä»…ç®¡å®ƒå¹¶ä¸å®Œç¾ï¼Œä½†å®ƒç¡®å®å¾ˆç®€æ´åœ°è§£å†³äº†é—®é¢˜ã€‚</p>
<h2 id="æ‰“å°contextå¼•èµ·panic">æ‰“å°contextå¼•èµ·panic<a hidden class="anchor" aria-hidden="true" href="#æ‰“å°contextå¼•èµ·panic">#</a></h2>
<h3 id="åˆ†æé—®é¢˜">åˆ†æé—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#åˆ†æé—®é¢˜">#</a></h3>
<p>ä¸‹é¢æ˜¯å‡ºç°net/http context panicçš„é—®é¢˜ä»£ç ï¼Œä»£ç çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å®šä¹‰ä¸€ä¸ªapiï¼Œç„¶åæ‰“å°contextè€Œå·²ã€‚æŠŠæœåŠ¡è¿è¡Œèµ·æ¥åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ab, wrkæ¥è¿›è¡Œå‹æµ‹ï¼Œæ¥åˆ¶é€ data raceç«äº‰çš„åœºæ™¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// xiaorui.cc
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nb">panic</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Context</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">panic</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:9090&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢æ˜¯wrkå‹æµ‹æ—¶ï¼Œnet/httpæœåŠ¡çš„å¼‚å¸¸ä¿¡æ¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">//</span> <span class="n">xiaorui.cc</span>

<span class="n">fatal</span> <span class="n">error</span><span class="o">:</span> <span class="n">concurrent</span> <span class="n">map</span> <span class="n">read</span> <span class="n">and</span> <span class="n">map</span> <span class="n">write</span>

<span class="nf">context.Background.WithValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">http.contextKey</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="s">&#34;http-server&#34;</span><span class="p">},</span> <span class="o">&amp;</span><span class="n">http.Server</span><span class="p">{</span><span class="n">Addr</span><span class="o">:</span><span class="s">&#34;:9090&#34;</span><span class="p">,</span> <span class="n">Handler</span><span class="o">:</span><span class="nf">http.Handler</span><span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">TLSConfig</span><span class="o">:</span><span class="p">(</span><span class="o">*</span><span class="n">tls.Config</span><span class="p">)(</span><span class="mh">0xc000062780</span><span class="p">),</span> <span class="n">ReadTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">ReadHeaderTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">WriteTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">IdleTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">MaxHeaderBytes</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">TLSNextProto</span><span class="o">:</span><span class="n">map[string</span><span class="nf">]func</span><span class="p">(</span><span class="o">*</span><span class="n">http.Server</span><span class="p">,</span> <span class="o">*</span><span class="n">tls.Conn</span><span class="p">,</span> <span class="n">http.Handler</span><span class="p">){</span><span class="s">&#34;h2&#34;</span><span class="o">:</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">http.Server</span><span class="p">,</span> <span class="o">*</span><span class="n">tls.Conn</span><span class="p">,</span> <span class="n">http.Handler</span><span class="p">))(</span><span class="mh">0x120b620</span><span class="p">)},</span> <span class="n">ConnState</span><span class="o">:</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="n">net.Conn</span><span class="p">,</span> <span class="n">http.ConnState</span><span class="p">))(</span><span class="n">nil</span><span class="p">),</span> <span class="n">ErrorLog</span><span class="o">:</span><span class="p">(</span><span class="o">*</span><span class="n">log.Logger</span><span class="p">)(</span><span class="n">nil</span><span class="p">),</span> <span class="n">disableKeepAlives</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">inShutdown</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">nextProtoOnce</span><span class="o">:</span><span class="n">sync.Once</span><span class="p">{</span><span class="n">m</span><span class="o">:</span><span class="n">sync.Mutex</span><span class="p">{</span><span class="n">state</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">sema</span><span class="o">:</span><span class="mh">0x0</span><span class="p">},</span> <span class="n">done</span><span class="o">:</span><span class="mh">0x1</span><span class="p">},</span> <span class="n">nextProtoErr</span><span class="o">:</span><span class="nf">error</span><span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">mu</span><span class="o">:</span><span class="n">sync.Mutex</span><span class="p">{</span><span class="n">state</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">sema</span><span class="o">:</span><span class="mh">0x0</span><span class="p">},</span> <span class="n">listeners</span><span class="o">:</span><span class="n">map[</span><span class="o">*</span><span class="n">net.Listener]struct</span> <span class="p">{}{(</span><span class="o">*</span><span class="n">net.Listener</span><span class="p">)(</span><span class="mh">0xc00007ccb0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{}},</span> <span class="n">activeConn</span><span class="o">:</span><span class="n">map[</span><span class="o">*</span><span class="n">http.conn]struct</span> <span class="p">{}{(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cb40</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d2c0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d540</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dcc0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cd20</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d5e0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}</span><span class="kc">...</span>
<span class="n">xiaorui.cc</span>
<span class="n">goroutine</span> <span class="m">32</span> <span class="n">[running]</span><span class="o">:</span>
<span class="nf">runtime.throw</span><span class="p">(</span><span class="mh">0x12b35e3</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">panic.go</span><span class="o">:</span><span class="m">608</span> <span class="m">+0</span><span class="n">x72</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018a858</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a828</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x102b892</span>
<span class="nf">runtime.mapaccess2</span><span class="p">(</span><span class="mh">0x1255800</span><span class="p">,</span> <span class="mh">0xc000080ea0</span><span class="p">,</span> <span class="mh">0xc00018a978</span><span class="p">,</span> <span class="mh">0x14bf328</span><span class="p">,</span> <span class="mh">0xc0000ac868</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">map.go</span><span class="o">:</span><span class="m">453</span> <span class="m">+0</span><span class="n">x223</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018a8a0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a858</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x100ed93</span>
<span class="nf">reflect.mapaccess</span><span class="p">(</span><span class="mh">0x1255800</span><span class="p">,</span> <span class="mh">0xc000080ea0</span><span class="p">,</span> <span class="mh">0xc00018a978</span><span class="p">,</span> <span class="mh">0x12afece</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">map.go</span><span class="o">:</span><span class="m">1249</span> <span class="m">+0</span><span class="n">x3f</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018a8d8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a8a0</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x1010adf</span>
<span class="nf">reflect.Value.MapIndex</span><span class="p">(</span><span class="mh">0x1255800</span><span class="p">,</span> <span class="mh">0xc000083280</span><span class="p">,</span> <span class="mh">0x1b5</span><span class="p">,</span> <span class="mh">0x1288180</span><span class="p">,</span> <span class="mh">0xc00009da40</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x1257ae0</span><span class="p">,</span> <span class="mh">0x14bf328</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">reflect</span><span class="o">/</span><span class="n">value.go</span><span class="o">:</span><span class="m">1111</span> <span class="m">+0</span><span class="n">x11d</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018a958</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a8d8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x1099b7d</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printValue</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x1255800</span><span class="p">,</span> <span class="mh">0xc000083280</span><span class="p">,</span> <span class="mh">0x1b5</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">757</span> <span class="m">+0</span><span class="n">xf43</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018ab38</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a958</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10aa853</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printValue</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x12a0720</span><span class="p">,</span> <span class="mh">0xc0000831e0</span><span class="p">,</span> <span class="mh">0x199</span><span class="p">,</span> <span class="mh">0xc000000076</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">783</span> <span class="m">+0</span><span class="n">x1ce9</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018ad18</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018ab38</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10ab5f9</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printValue</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x129ed00</span><span class="p">,</span> <span class="mh">0xc0000831e0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">853</span> <span class="m">+0</span><span class="n">x1b2c</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018aef8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018ad18</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10ab43c</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x129ed00</span><span class="p">,</span> <span class="mh">0xc0000831e0</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">689</span> <span class="m">+0</span><span class="n">x2b7</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018af90</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018aef8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a91a7</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.doPrintf</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x12afaf0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc00018b108</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">1003</span> <span class="m">+0</span><span class="n">x166</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b078</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018af90</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10acde6</span>
<span class="nf">fmt.Sprintf</span><span class="p">(</span><span class="mh">0x12afaf0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc00018b108</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">203</span> <span class="m">+0</span><span class="n">x66</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b0d0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b078</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a5b26</span>
<span class="nf">context.</span><span class="p">(</span><span class="o">*</span><span class="n">valueCtx</span><span class="p">)</span><span class="nf">.String</span><span class="p">(</span><span class="mh">0xc000080e10</span><span class="p">,</span> <span class="mh">0x12be400</span><span class="p">,</span> <span class="mh">0xc0001880c0</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">context.go</span><span class="o">:</span><span class="m">486</span> <span class="m">+0</span><span class="n">xab</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b148</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b0d0</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11121bb</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.handleMethods</span><span class="p">(</span><span class="mh">0xc0001880c0</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">603</span> <span class="m">+0</span><span class="n">x27c</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b1d8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b148</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a8cac</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc0001880c0</span><span class="p">,</span> <span class="mh">0x1274ce0</span><span class="p">,</span> <span class="mh">0xc000080e10</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">686</span> <span class="m">+0</span><span class="n">x203</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b270</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b1d8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a90f3</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.doPrintf</span><span class="p">(</span><span class="mh">0xc0001880c0</span><span class="p">,</span> <span class="mh">0x12afaf0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc00018b3e8</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">)</span>
<span class="kc">...</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc000188000</span><span class="p">,</span> <span class="mh">0x1274ce0</span><span class="p">,</span> <span class="mh">0xc000114480</span><span class="p">,</span> <span class="mh">0xc000000076</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">1003</span> <span class="m">+0</span><span class="n">x166</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b638</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b550</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10acde6</span>
<span class="nf">fmt.Sprintf</span><span class="p">(</span><span class="mh">0x12ad1be</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xc0001106c8</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc00011e080</span><span class="p">,</span> <span class="mh">0xc0001106f8</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">203</span> <span class="m">+0</span><span class="n">x66</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b690</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b638</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a5b26</span>
<span class="nf">context.</span><span class="p">(</span><span class="o">*</span><span class="n">cancelCtx</span><span class="p">)</span><span class="nf">.String</span><span class="p">(</span><span class="mh">0xc000116640</span><span class="p">,</span> <span class="mh">0x12be400</span><span class="p">,</span> <span class="mh">0xc000188300</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">context.go</span><span class="o">:</span><span class="m">343</span> <span class="m">+0</span><span class="n">x7d</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b6e8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b690</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x111158d</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.handleMethods</span><span class="p">(</span><span class="mh">0xc000188300</span><span class="p">,</span> <span class="mh">0xc000000076</span><span class="p">,</span> <span class="mh">0x1034601</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">603</span> <span class="m">+0</span><span class="n">x27c</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b778</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b6e8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a8cac</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc000188300</span><span class="p">,</span> <span class="mh">0x12785e0</span><span class="p">,</span> <span class="mh">0xc000116640</span><span class="p">,</span> <span class="mh">0xc000000076</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">686</span> <span class="m">+0</span><span class="n">x203</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b810</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b778</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a90f3</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.doPrintf</span><span class="p">(</span><span class="mh">0xc000188300</span><span class="p">,</span> <span class="mh">0x12ad1be</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xc00018b988</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">1003</span> <span class="m">+0</span><span class="n">x166</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b8f8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b810</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10acde6</span>
<span class="nf">fmt.Sprintf</span><span class="p">(</span><span class="mh">0x12ad1be</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xc000110988</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc00011e030</span><span class="p">,</span> <span class="mh">0xc0001109b8</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">203</span> <span class="m">+0</span><span class="n">x66</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b950</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b8f8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a5b26</span>
<span class="nf">context.</span><span class="p">(</span><span class="o">*</span><span class="n">cancelCtx</span><span class="p">)</span><span class="nf">.String</span><span class="p">(</span><span class="mh">0xc000116740</span><span class="p">,</span> <span class="mh">0x12be400</span><span class="p">,</span> <span class="mh">0xc000188240</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">context.go</span><span class="o">:</span><span class="m">343</span> <span class="m">+0</span><span class="n">x7d</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b9a8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b950</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x111158d</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.handleMethods</span><span class="p">(</span><span class="mh">0xc000188240</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xc000080c01</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">603</span> <span class="m">+0</span><span class="n">x27c</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018ba38</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b9a8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a8cac</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc000188240</span><span class="p">,</span> <span class="mh">0x12785e0</span><span class="p">,</span> <span class="mh">0xc000116740</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">686</span> <span class="m">+0</span><span class="n">x203</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bad0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018ba38</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a90f3</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.doPrintf</span><span class="p">(</span><span class="mh">0xc000188240</span><span class="p">,</span> <span class="mh">0x12ab4df</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xc00018bcc0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
 <span class="kc">...</span>
<span class="nf">fmt.Printf</span><span class="p">(</span><span class="mh">0x12ab4df</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xc000110cc0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc0000fa780</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xc000022a70</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">197</span> <span class="m">+0</span><span class="n">x72</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bc80</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bc20</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a5a82</span>
<span class="nf">main.panic</span><span class="p">(</span><span class="mh">0x12f10c0</span><span class="p">,</span> <span class="mh">0xc0001821c0</span><span class="p">,</span> <span class="mh">0xc000120600</span><span class="p">)</span>
        <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">ruifengyun</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">k.go</span><span class="o">:</span><span class="m">9</span> <span class="m">+0</span><span class="n">x89</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bce0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bc80</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x121bb79</span>
<span class="n">net</span><span class="o">/</span><span class="nf">http.HandlerFunc.ServeHTTP</span><span class="p">(</span><span class="mh">0x12be4e0</span><span class="p">,</span> <span class="mh">0x12f10c0</span><span class="p">,</span> <span class="mh">0xc0001821c0</span><span class="p">,</span> <span class="mh">0xc000120600</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">1964</span> <span class="m">+0</span><span class="n">x44</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bd08</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bce0</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11f1b14</span>
<span class="n">net</span><span class="o">/</span><span class="nf">http.</span><span class="p">(</span><span class="o">*</span><span class="n">ServeMux</span><span class="p">)</span><span class="nf">.ServeHTTP</span><span class="p">(</span><span class="mh">0x14a17a0</span><span class="p">,</span> <span class="mh">0x12f10c0</span><span class="p">,</span> <span class="mh">0xc0001821c0</span><span class="p">,</span> <span class="mh">0xc000120600</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">2361</span> <span class="m">+0</span><span class="n">x127</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bd48</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bd08</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11f37c7</span>
<span class="n">net</span><span class="o">/</span><span class="nf">http.serverHandler.ServeHTTP</span><span class="p">(</span><span class="mh">0xc0000831e0</span><span class="p">,</span> <span class="mh">0x12f10c0</span><span class="p">,</span> <span class="mh">0xc0001821c0</span><span class="p">,</span> <span class="mh">0xc000120600</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">2741</span> <span class="m">+0</span><span class="n">xab</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bd78</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bd48</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11f427b</span>
<span class="n">net</span><span class="o">/</span><span class="nf">http.</span><span class="p">(</span><span class="o">*</span><span class="n">conn</span><span class="p">)</span><span class="nf">.serve</span><span class="p">(</span><span class="mh">0xc00009d180</span><span class="p">,</span> <span class="mh">0x12f12c0</span><span class="p">,</span> <span class="mh">0xc000116640</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">1847</span> <span class="m">+0</span><span class="n">x646</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bfc8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bd78</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11f0d66</span>
<span class="nf">runtime.goexit</span><span class="p">()</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">asm_amd64.s</span><span class="o">:</span><span class="m">1333</span> <span class="m">+0</span><span class="n">x1</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bfd0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bfc8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x1057f81</span>
<span class="n">created</span> <span class="n">by</span> <span class="n">net</span><span class="o">/</span><span class="nf">http.</span><span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span><span class="n">.Serve</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">2851</span> <span class="m">+0</span><span class="n">x2f5</span>
</code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡panicå‡ºæ¥çš„åç¨‹è°ƒç”¨æ ˆä¿¡æ¯å¯ä»¥åˆ†æå‡ºï¼Œfmt printä¼šä¸æ–­çš„é€’å½’åå°„åŠéå†è§£æcontexté‡Œçš„æ•°æ®ã€‚ é€šè¿‡ä¸Šé¢çš„panicä¿¡æ¯æˆ‘ä»¬å¯ä»¥å¾—çŸ¥æ ¹æœ¬é—®é¢˜æ˜¯ç”±äºmapçš„å¹¶å‘è¯»å†™é€ æˆçš„ï¼Œè¿™ä¹Ÿå°±è¯´ context å†…éƒ¨æ˜¯æœ‰mapçš„ã€‚</p>
<p>æˆ‘ä»¬åœ¨æ­£å¸¸æƒ…å†µä¸‹æ‰“å°http.Request contextï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªmapï¼Œä¸€ä¸ªæ˜¯listenersï¼Œä¸€ä¸ªæ˜¯activeConnã€‚å¦å¤–åœ¨activeConnè¿™ä¸ªç»“æ„é‡Œè¿˜èƒ½çœ‹åˆ°å¾ˆå¤šçš„connã€‚è¯´æ˜è¿™ä¸ªcontextä¸å•å•æ˜¯å«æœ‰è¿™ä¸ªè¯·æ±‚æœ¬èº«éœ€è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯äº†ï¼Œè€Œä¸”è¿˜åŒ…å«äº†è¯¥serverå¯¹è±¡ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">//</span> <span class="n">xiaorui.cc</span>

<span class="nf">context.Background.WithValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">http.contextKey</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="s">&#34;http-server&#34;</span><span class="p">},</span> <span class="o">&amp;</span><span class="n">http.Server</span><span class="p">{</span><span class="n">Addr</span><span class="o">:</span><span class="s">&#34;:9090&#34;</span><span class="p">,</span> <span class="n">Handler</span><span class="o">:</span><span class="nf">http.Handler</span><span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">TLSConfig</span><span class="o">:</span><span class="p">(</span><span class="o">*</span><span class="n">tls.Config</span><span class="p">)(</span><span class="mh">0xc000062780</span><span class="p">),</span> <span class="n">ReadTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">ReadHeaderTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">WriteTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">IdleTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">MaxHeaderBytes</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">TLSNextProto</span><span class="o">:</span><span class="n">map[string</span><span class="nf">]func</span><span class="p">(</span><span class="o">*</span><span class="n">http.Server</span><span class="p">,</span> <span class="o">*</span><span class="n">tls.Conn</span><span class="p">,</span> <span class="n">http.Handler</span><span class="p">){</span><span class="s">&#34;h2&#34;</span><span class="o">:</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">http.Server</span><span class="p">,</span> <span class="o">*</span><span class="n">tls.Conn</span><span class="p">,</span> <span class="n">http.Handler</span><span class="p">))(</span><span class="mh">0x120b620</span><span class="p">)},</span> <span class="n">ConnState</span><span class="o">:</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="n">net.Conn</span><span class="p">,</span> <span class="n">http.ConnState</span><span class="p">))(</span><span class="n">nil</span><span class="p">),</span> <span class="n">ErrorLog</span><span class="o">:</span><span class="p">(</span><span class="o">*</span><span class="n">log.Logger</span><span class="p">)(</span><span class="n">nil</span><span class="p">),</span> <span class="n">disableKeepAlives</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">inShutdown</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">nextProtoOnce</span><span class="o">:</span><span class="n">sync.Once</span><span class="p">{</span><span class="n">m</span><span class="o">:</span><span class="n">sync.Mutex</span><span class="p">{</span><span class="n">state</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">sema</span><span class="o">:</span><span class="mh">0x0</span><span class="p">},</span> <span class="n">done</span><span class="o">:</span><span class="mh">0x1</span><span class="p">},</span> <span class="n">nextProtoErr</span><span class="o">:</span><span class="nf">error</span><span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">mu</span><span class="o">:</span><span class="n">sync.Mutex</span><span class="p">{</span><span class="n">state</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">sema</span><span class="o">:</span><span class="mh">0x0</span><span class="p">},</span> <span class="n">listeners</span><span class="o">:</span><span class="n">map[</span><span class="o">*</span><span class="n">net.Listener]struct</span> <span class="p">{}{(</span><span class="o">*</span><span class="n">net.Listener</span><span class="p">)(</span><span class="mh">0xc00007ccb0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{}},</span> <span class="n">activeConn</span><span class="o">:</span><span class="n">map[</span><span class="o">*</span><span class="n">http.conn]struct</span> <span class="p">{}{(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cb40</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d2c0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d540</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dcc0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cd20</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d5e0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d860</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d9a0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc0001940a0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cfa0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d400</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dd60</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc000194140</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc0001941e0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009caa0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d180</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d220</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d680</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d900</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cc80</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009ce60</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d040</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dc20</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dea0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009ca00</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cdc0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d0e0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d360</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009da40</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dae0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cbe0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d4a0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="m">0</span><span class="n">x</span>
</code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å†æ¥åˆ†æä¸‹ net/httpçš„ä»£ç é‡Œå¯¹activeConn mapçš„ä¿®æ”¹é€»è¾‘ã€‚ä¸ç®¡æ˜¯åˆå§‹åŒ–ï¼Œæ–°å¢ï¼Œåˆ é™¤éƒ½æœ‰åŠ é”ã€‚ä½†æ˜¯ä»–çš„é”çš„èŒƒå›´åªæ˜¯ net/http serverçš„é”ã€‚fmt.Printfé‡Œå¯¹serverå¯¹è±¡çš„activeConn mapéå†æ‰“å°è‡ªç„¶ä¸å—å½±å“ã€‚</p>
<p>é‚£ä¹ˆï¼Œè‡ªç„¶å°±ä¼šæœ‰é€ æˆ map çš„panicã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// xiaorui.cc
</span><span class="c1"></span>
<span class="c1">// åˆ›å»ºå…ˆçš„æ´»åŠ¨è¿æ¥
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">trackConn</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">add</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">conn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{})</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">add</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{}{}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å…³é—­ç©ºé—²è¿æ¥
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">closeIdleConns</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span> <span class="p">{</span>
		<span class="nx">st</span><span class="p">,</span> <span class="nx">unixSec</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">getState</span><span class="p">()</span>
                <span class="o">...</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">quiescent</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªserveræ˜¯ä»å“ªé‡Œä¼ ç»™æ¯ä¸ªè¯·æ±‚çš„handlerçš„ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// xiaorui.cc
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">baseCtx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
        <span class="o">...</span>

        <span class="c1">// æŠŠä»–è‡ªèº«é€šè¿‡withValueç”Ÿæˆä¸€ä¸ªctxï¼Œå¹¶ä¼ é€’ä¸‹å»
</span><span class="c1"></span>	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">baseCtx</span><span class="p">,</span> <span class="nx">ServerContextKey</span><span class="p">,</span> <span class="nx">srv</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">rw</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
        <span class="o">...</span>
		<span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Serve a new connection.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">)</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">remoteAddr</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">.</span><span class="nf">RemoteAddr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">LocalAddrContextKey</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">.</span><span class="nf">LocalAddr</span><span class="p">())</span>
    <span class="o">...</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">readRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nx">remain</span> <span class="o">!=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nf">initialReadLimitSize</span><span class="p">()</span> <span class="p">{</span>
			<span class="c1">// If we read any bytes off the wire, we&#39;re active.
</span><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">,</span> <span class="nx">StateActive</span><span class="p">)</span>
		<span class="p">}</span>
        <span class="o">...</span>

		<span class="nx">req</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">req</span>
		<span class="nx">serverHandler</span><span class="p">{</span><span class="nx">c</span><span class="p">.</span><span class="nx">server</span><span class="p">}.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚ä½•è§£å†³ï¼Ÿ æˆ–è€…è¯´å®‰å…¨æ‰“å°</p>
<p>åˆ«ç›´æ¥æŠŠcontextéƒ½è¾“å‡ºæ‰“å°å°±å¯ä»¥äº†ã€‚ğŸ˜…</p>
<h2 id="withtimeoutè¦†ç›–withcancel">WithTimeoutè¦†ç›–WithCancel<a hidden class="anchor" aria-hidden="true" href="#withtimeoutè¦†ç›–withcancel">#</a></h2>
<p>context.WithCancel å†…éƒ¨å¯åŠ¨ goroutineï¼Œåœ¨ ctx è¢«è¦†ç›–åæ³„éœ²</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210819170858.png" alt=""  />
</p>
<h2 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h2>
<p>åˆ°è¿™é‡Œï¼Œæ•´ä¸ª context åŒ…çš„å†…å®¹å°±å…¨éƒ¨è®²å®Œäº†ã€‚æºç éå¸¸çŸ­ï¼Œå¾ˆé€‚åˆå­¦ä¹ ï¼Œä¸€å®šè¦å»è¯»ä¸€ä¸‹ã€‚</p>
<p>context åŒ…æ˜¯ Go 1.7 å¼•å…¥çš„æ ‡å‡†åº“ï¼Œä¸»è¦ç”¨äºåœ¨ goroutine ä¹‹é—´ä¼ é€’å–æ¶ˆä¿¡å·ã€è¶…æ—¶æ—¶é—´ã€æˆªæ­¢æ—¶é—´ä»¥åŠä¸€äº›å…±äº«çš„å€¼ç­‰ã€‚å®ƒå¹¶ä¸æ˜¯å¤ªå®Œç¾ï¼Œä½†å‡ ä¹æˆäº†å¹¶å‘æ§åˆ¶å’Œè¶…æ—¶æ§åˆ¶çš„æ ‡å‡†åšæ³•ã€‚</p>
<p>ä½¿ç”¨ä¸Šï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæ ¹èŠ‚ç‚¹çš„ contextï¼Œä¹‹åæ ¹æ®åº“æä¾›çš„å››ä¸ªå‡½æ•°åˆ›å»ºç›¸åº”åŠŸèƒ½çš„å­èŠ‚ç‚¹ contextã€‚ç”±äºå®ƒæ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œæ‰€ä»¥å¯ä»¥æ”¾å¿ƒåœ°ä¼ é€’ã€‚</p>
<p>å½“ä½¿ç”¨ context ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ï¼Œç›´æ¥æŠŠå®ƒæ”¾åœ¨ç¬¬ä¸€ä¸ªå‚æ•°çš„ä½ç½®ï¼Œå¹¶ä¸”å‘½åä¸º ctxã€‚å¦å¤–ï¼Œä¸è¦æŠŠ context åµŒå¥—åœ¨è‡ªå®šä¹‰çš„ç±»å‹é‡Œã€‚</p>
<p>æœ€åï¼Œå¤§å®¶ä¸‹æ¬¡åœ¨çœ‹åˆ°ä»£ç é‡Œæœ‰ç”¨åˆ° context çš„ï¼Œè§‚å¯Ÿä¸‹æ˜¯æ€ä¹ˆä½¿ç”¨çš„ï¼Œè‚¯å®šé€ƒä¸å‡ºæˆ‘ä»¬è®²çš„å‡ ç§ç±»å‹ã€‚ç†Ÿæ‚‰ä¹‹åä¼šå‘ç°ï¼šcontext å¯èƒ½å¹¶ä¸å®Œç¾ï¼Œä½†å®ƒç¡®å®ç®€æ´é«˜æ•ˆåœ°è§£å†³äº†é—®é¢˜ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h2>
<p><a href="https://mp.weixin.qq.com/s/ayySDQNTRlxjHuiAsaIwhw">The Go Blog: å…³äº context çš„ä¸€ç‚¹æœ€ä½³å®è·µ</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/68792989">æ·±åº¦è§£å¯†Goè¯­è¨€ä¹‹context</a></p>
<p><a href="http://xiaorui.cc/archives/5919">golang net/httpè¾“å‡ºcontextå¼•èµ·çš„map panic</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
