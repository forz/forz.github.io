<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>context使用实践 | Forz Blog</title>
<meta name="keywords" content="Go" />
<meta name="description" content="如何使用 context context 使用起来非常方便。源码里对外提供了一个创建根节点 context 的函数： 1 func Background() Context background 是一个空的 context， 它不能被取消，没有值，也没有超时时">
<meta name="author" content="">
<link rel="canonical" href="/post/context%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="context使用实践" />
<meta property="og:description" content="如何使用 context context 使用起来非常方便。源码里对外提供了一个创建根节点 context 的函数： 1 func Background() Context background 是一个空的 context， 它不能被取消，没有值，也没有超时时" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/context%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-19T17:47:08&#43;00:00" />
<meta property="article:modified_time" content="2021-05-19T17:47:08&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="context使用实践"/>
<meta name="twitter:description" content="如何使用 context context 使用起来非常方便。源码里对外提供了一个创建根节点 context 的函数： 1 func Background() Context background 是一个空的 context， 它不能被取消，没有值，也没有超时时"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "context使用实践",
      "item": "/post/context%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "context使用实践",
  "name": "context使用实践",
  "description": "如何使用 context context 使用起来非常方便。源码里对外提供了一个创建根节点 context 的函数： 1 func Background() Context background 是一个空的 context， 它不能被取消，没有值，也没有超时时",
  "keywords": [
    "Go"
  ],
  "articleBody": "如何使用 context context 使用起来非常方便。源码里对外提供了一个创建根节点 context 的函数：\n1  func Background() Context   background 是一个空的 context， 它不能被取消，没有值，也没有超时时间。\n有了根节点 context，又提供了四个函数创建子节点 context：\n1 2 3 4  func WithCancel(parent Context) (ctx Context, cancel CancelFunc) func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc) func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) func WithValue(parent Context, key, val interface{}) Context   context 会在函数传递间传递。只需要在适当的时间调用 cancel 函数向 goroutines 发出取消信号或者调用 Value 函数取出 context 中的值。\n在使用 Context 的时候,有一些约定俗成的规则。\n 一般函数使用 Context 的时候,会把这个参数放在第一个参数的位置。 从来不把 nil 当做 Context 类型的参数值,可以使用 context.Background() 创建一个空的上下文对象,也不要使用 nil。 Context 只用来临时做函数之间的上下文透传,不能持久化 Context 或者把 Context 长久保存。把 Context 持久化到数据库、本地文件或者全局变量、缓存中都是错误的用法。 key 的类型不应该是字符串类型或者其它内建类型,否则容易在包之间使用 Context 时候产生冲突。使用 WithValue 时,key 的类型应该是自己定义的类型。 常常使用 struct{}作为底层类型定义 key 的类型。对于 exported key 的静态类型,常常是接口或者指针。这样可以尽量减少内存分配。  传递共享的数据 对于 Web 服务端开发，往往希望将一个请求处理的整个过程串起来，这就非常依赖于 Thread Local（对于 Go 可理解为单个协程所独有） 的变量，而在 Go 语言中并没有这个概念，因此需要在函数调用的时候传递 context。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23  package main import ( \"context\" \"fmt\" ) func main() { ctx := context.Background() process(ctx) ctx = context.WithValue(ctx, \"traceId\", \"qcrao-2019\") process(ctx) } func process(ctx context.Context) { traceId, ok := ctx.Value(\"traceId\").(string) if ok { fmt.Printf(\"process over. trace_id=%s\\n\", traceId) } else { fmt.Printf(\"process over. no trace_id\\n\") } }   运行结果：\n1 2  process over. no trace_id process over. trace_id=qcrao-2019   第一次调用 process 函数时，ctx 是一个空的 context，自然取不出来 traceId。第二次，通过 WithValue 函数创建了一个 context，并赋上了 traceId 这个 key，自然就能取出来传入的 value 值。\n当然，现实场景中可能是从一个 HTTP 请求中获取到的 Request-ID。所以，下面这个样例可能更适合：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  const requestIDKey int = 0 func WithRequestID(next http.Handler) http.Handler { return http.HandlerFunc( func(rw http.ResponseWriter, req *http.Request) { // 从 header 中提取 request-id  reqID := req.Header.Get(\"X-Request-ID\") // 创建 valueCtx。使用自定义的类型，不容易冲突  ctx := context.WithValue( req.Context(), requestIDKey, reqID) // 创建新的请求  req = req.WithContext(ctx) // 调用 HTTP 处理函数  next.ServeHTTP(rw, req) } ) } // 获取 request-id func GetRequestID(ctx context.Context) string { ctx.Value(requestIDKey).(string) } func Handle(rw http.ResponseWriter, req *http.Request) { // 拿到 reqId，后面可以记录日志等等  reqID := GetRequestID(req.Context()) ... } func main() { handler := WithRequestID(http.HandlerFunc(Handle)) http.ListenAndServe(\"/\", handler) }   取消 goroutine 我们先来设想一个场景：打开外卖的订单页，地图上显示外卖小哥的位置，而且是每秒更新 1 次。app 端向后台发起 websocket 连接（现实中可能是轮询）请求后，后台启动一个协程，每隔 1 秒计算 1 次小哥的位置，并发送给端。如果用户退出此页面，则后台需要“取消”此过程，退出 goroutine，系统回收资源。\n后端可能的实现如下：\n1 2 3 4 5 6 7  func Perform() { for { calculatePos() sendResult() time.Sleep(time.Second) } }   如果需要实现“取消”功能，并且在不了解 context 功能的前提下，可能会这样做：给函数增加一个指针型的 bool 变量，在 for 语句的开始处判断 bool 变量是发由 true 变为 false，如果改变，则退出循环。\n上面给出的简单做法，可以实现想要的效果，没有问题，但是并不优雅，并且一旦协程数量多了之后，并且各种嵌套，就会很麻烦。优雅的做法，自然就要用到 context。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  func Perform(ctx context.Context) { for { calculatePos() sendResult() select { case ctx.Done(): // 被取消，直接返回  return case time.After(time.Second): // block 1 秒钟  } } }   主流程可能是这样的：\n1 2 3 4 5 6  ctx, cancel := context.WithTimeout(context.Background(), time.Hour) go Perform(ctx) // …… // app 端返回页面，调用cancel 函数 cancel()   注意一个细节，WithTimeOut 函数返回的 context 和 cancelFun 是分开的。context 本身并没有取消函数，这样做的原因是取消函数只能由外层函数调用，防止子节点 context 调用取消函数，从而严格控制信息的流向：由父节点 context 流向子节点 context。\n防止 goroutine 泄漏 前面那个例子里，goroutine 还是会自己执行完，最后返回，只不过会多浪费一些系统资源。这里改编一个“如果不用 context 取消，goroutine 就会泄漏的例子”，来自参考资料：【避免协程泄漏】。\n1 2 3 4 5 6 7 8 9 10 11 12  func gen() chan int { ch := make(chan int) go func() { var n int for { ch  n n++ time.Sleep(time.Second) } }() return ch }   这是一个可以生成无限整数的协程，但如果我只需要它产生的前 5 个数，那么就会发生 goroutine 泄漏：\n1 2 3 4 5 6 7 8 9  func main() { for n := range gen() { fmt.Println(n) if n == 5 { break } } // …… }   当 n == 5 的时候，直接 break 掉。那么 gen 函数的协程就会执行无限循环，永远不会停下来。发生了 goroutine 泄漏。\n用 context 改进这个例子：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  func gen(ctx context.Context) chan int { ch := make(chan int) go func() { var n int for { select { case ctx.Done(): return case ch  n: n++ time.Sleep(time.Second) } } }() return ch } func main() { ctx, cancel := context.WithCancel(context.Background()) defer cancel() // 避免其他地方忘记 cancel，且重复调用不影响  for n := range gen(ctx) { fmt.Println(n) if n == 5 { cancel() break } } // …… }   增加一个 context，在 break 前调用 cancel 函数，取消 goroutine。gen 函数在接收到取消信号后，直接退出，系统回收资源。\n作为函数参数传递 在许多 Go API，尤其是现代 API 中，函数和方法的第一个参数通常是 context.Context。context 提供了很多方法例如 WithCancel、WithDeadline、WithValue、以实现跨 API 的流程控制。很多 lib 在与远程服务器(如数据库、api等)交互时，经常使用 context 做控制。\ncontext 的文档中讲到:\ncontext 不应存储在 struct 内部，最好的方式是作为函数的第一个参数传递\n本文在此建议的基础上讲解了原因和示例，说明了为什么要使用函数传递 Context 而不是将其存储在 struct 中的重要性。还以 net/http 的代码为例，解释了应该在何种情况下可以在 struct 中 存储 Context 。\n推荐 context 作为函数参数传递 让我们先看下在函数中传递 context：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  type Worker struct { /*…*/ } type Work struct { /*…*/ } func New() *Worker { return \u0026Worker{} } func (w *Worker) Fetch(ctx context.Context) (*Work, error) { _ = ctx // A per-call ctx is used for cancellation, deadlines, and metadata. } func (w *Worker) Process(ctx context.Context, w*Work) error { _ = ctx // A per-call ctx is used for cancellation, deadlines, and metadata. }   这里 (*Worker).Fetch 和 (*Worker).Process 都直接将 context 作为函数第一个参数。这样从 context 的生成到结束，调用方可以很清晰地知道 context 的传递路线。\n将 context 存储到 strcut 所带来的一些困惑 在结构体中嵌套 context 来实现上面的 Worker 示例，调用者对所使用的 context 生命周期产生迷惑：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  type Worker struct { ctx context.Context } func New(ctx context.Context) *Worker { return \u0026Worker{ctx: ctx} } func (w *Worker) Fetch() (*Work, error) { _ = w.ctx // A shared w.ctx is used for cancellation, deadlines, and metadata. } func (w *Worker) Process(w*Work) error { _ = w.ctx // A shared w.ctx is used for cancellation, deadlines, and metadata. }   (*Worker).Fetch 和 (*Worker).Process 方法同时使用了 Worker 结构体中的 context ，这种情况下使得调用方无法定义不同的 context ，比如有调用方想用 WitchCancel，有的想用 WithDeadline，也很难理解上面传来的 context 的作用是 cancel？还是 deadline?调用者所使用 context 的生命周期被绑定到了一个共享的 context 上面。\n特殊情况：保留向后兼容性 当 go 1.7 版本发布时，大量的的 API 需要以向后兼容的方式支持 context.Context，例如，net/http 的 Client 方法（例如Get和Do）是使用 context 的典范。使用这些方法发送的 http 请求都将受益于 context.Context 附带的 WithDeadline，WithCancel 和 WithValue 等方法支持。\n一般有两种方式能够在支持 context.Context 的同时保持代码的向后兼容：\n 在 struct 中添加 context (稍后我们将看到)； 复制原有函数，在函数第一个参数中使用 context，举个栗子，database/sql 这个 package 的 Query 方法的签名一直是:  1  func (db *DB) Query(query string, args ...interface{}) (*Rows, error)   当 context package 引入的时候，Go team 新增了这样一个函数：\n1  func (db *DB) QueryContext(ctx context.Context, query string, args ...interface{}) (*Rows, error)   并且只修改了一处代码：\n1 2 3  func (db *DB) Query(query string, args ...interface{}) (*Rows, error) { return db.QueryContext(context.Background(), query, args...) }   通过这种方式，Go team 能够在平滑地升级一个 package 的同时不对代码的可读性、兼容性造成影响。类似的代码在 golang 源码中随处可见。更多的保持代码兼容性的讨论可见 [Go team 关于如何保持 Go Modules 兼容性的一些实践]。\n然而在某些情况下，比如 API 公开了大量 function，重写所有函数是不切实际的。\npackage net/http 选择在 struct 中添加 context.Context，这是一个结构体嵌套 context 比较恰当的范例。先让我们看下 net/http 的 Do 函数。在引入 context 之前，Do 的定义如下:\n1  func (c *Client) Do(req*Request) (*Response, error)   在 1.7 引入 context 后，为了遵循 net/http 这种标准库的向后兼容原则，考虑到该核心库所包含的函数过于多，maintainers 选择在结构体 http.Request 中添加 context.Context。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  type Request struct { ctx context.Context // ... } func NewRequestWithContext(ctx context.Context, method, url string, body io.Reader) (*Request, error) { // Simplified for brevity of this article.  return \u0026Request{ ctx: ctx, // ...  } } func (c *Client) Do(req*Request) (*Response, error)   在修改大量 API 以支持 context 时，在结构体中添加 context.Context 是有意义的， 如上所述。但是，记住首先要考虑复制函数对 context 进行支持，在不牺牲实用性和理解性的前提下向后兼容上下文:\n1 2 3 4 5 6 7  func (c *Client) Call() error { return c.CallContext(context.Background()) } func (c *Client) CallContext(ctx context.Context) error { // ... }   context 真的这么好吗 读完全文，你一定有这种感觉：context 就是为 server 而设计的。说什么处理一个请求，需要启动多个 goroutine 并行地去处理，并且在这些 goroutine 之间还要传递一些共享的数据等等，这些都是写一个 server 要做的事。\n没错，Go 很适合写 server，但它终归是一门通用的语言。你在用 Go 做 Leetcode 上面的题目的时候，肯定不会认为它和一般的语言有什么差别。所以，很多特性好不好，应该从 Go 只是一门普通的语言，很擅长写 server 的角度来看。\n从这个角度来看，context 并没有那么美好。Go 官方建议我们把 Context 作为函数的第一个参数，甚至连名字都准备好了。这造成一个后果：因为我们想控制所有的协程的取消动作，所以需要在几乎所有的函数里加上一个 Context 参数。很快，我们的代码里，context 将像病毒一样扩散的到处都是。\n在参考资料【Go2 应该去掉 context】这篇英文博客里，作者甚至调侃说：如果要把 Go 标准库的大部分函数都加上 context 参数的话，例如下面这样：\n1  n, err := r.Read(context.TODO(), p)   就给我来一枪吧！\n原文是这样说的：put a bullet in my head, please.我当时看到这句话的时候，会心一笑。这可能就是陶渊明说的：每有会意，便欣然忘食。当然，我是在晚饭会看到这句话的。\n为了表达自己对 context 并没有什么好感，作者接着又说了一句：If you use ctx.Value in my (non-existent) company, you’re fired. 简直太幽默了，哈哈。\n另外，像 WithCancel、WithDeadline、WithTimeout、WithValue 这些创建函数，实际上是创建了一个个的链表结点而已。我们知道，对链表的操作，通常都是 O(n) 复杂度的，效率不高。\n那么，context 包到底解决了什么问题呢？答案是：cancelation。仅管它并不完美，但它确实很简洁地解决了问题。\n打印context引起panic 分析问题 下面是出现net/http context panic的问题代码，代码的逻辑很简单，就是定义一个api，然后打印context而已。把服务运行起来后，我们可以用ab, wrk来进行压测，来制造data race竞争的场景。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  // xiaorui.cc  package main import ( \"fmt\" \"net/http\" ) func panic(w http.ResponseWriter, r *http.Request) { fmt.Printf(\"%+v\", r.Context()) } func main() { http.HandleFunc(\"/\", panic) err := http.ListenAndServe(\":9090\", nil) if err != nil { fmt.Println(err) } }   下面是wrk压测时，net/http服务的异常信息。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73  // xiaorui.cc fatal error: concurrent map read and map write context.Background.WithValue(\u0026http.contextKey{name:\"http-server\"}, \u0026http.Server{Addr:\":9090\", Handler:http.Handler(nil), TLSConfig:(*tls.Config)(0xc000062780), ReadTimeout:0, ReadHeaderTimeout:0, WriteTimeout:0, IdleTimeout:0, MaxHeaderBytes:0, TLSNextProto:map[string]func(*http.Server, *tls.Conn, http.Handler){\"h2\":(func(*http.Server, *tls.Conn, http.Handler))(0x120b620)}, ConnState:(func(net.Conn, http.ConnState))(nil), ErrorLog:(*log.Logger)(nil), disableKeepAlives:0, inShutdown:0, nextProtoOnce:sync.Once{m:sync.Mutex{state:0, sema:0x0}, done:0x1}, nextProtoErr:error(nil), mu:sync.Mutex{state:0, sema:0x0}, listeners:map[*net.Listener]struct {}{(*net.Listener)(0xc00007ccb0):struct {}{}}, activeConn:map[*http.conn]struct {}{(*http.conn)(0xc00009cb40):struct {}{}, (*http.conn)(0xc00009d2c0):struct {}{}, (*http.conn)(0xc00009d540):struct {}{}, (*http.conn)(0xc00009dcc0):struct {}{}, (*http.conn)(0xc00009cd20):struct {}{}, (*http.conn)(0xc00009d5e0):struct {}... xiaorui.cc goroutine 32 [running]: runtime.throw(0x12b35e3, 0x21) /usr/local/go/src/runtime/panic.go:608 +0x72 fp=0xc00018a858 sp=0xc00018a828 pc=0x102b892 runtime.mapaccess2(0x1255800, 0xc000080ea0, 0xc00018a978, 0x14bf328, 0xc0000ac868) /usr/local/go/src/runtime/map.go:453 +0x223 fp=0xc00018a8a0 sp=0xc00018a858 pc=0x100ed93 reflect.mapaccess(0x1255800, 0xc000080ea0, 0xc00018a978, 0x12afece) /usr/local/go/src/runtime/map.go:1249 +0x3f fp=0xc00018a8d8 sp=0xc00018a8a0 pc=0x1010adf reflect.Value.MapIndex(0x1255800, 0xc000083280, 0x1b5, 0x1288180, 0xc00009da40, 0x36, 0x1257ae0, 0x14bf328, 0xb9) /usr/local/go/src/reflect/value.go:1111 +0x11d fp=0xc00018a958 sp=0xc00018a8d8 pc=0x1099b7d fmt.(*pp).printValue(0xc000188180, 0x1255800, 0xc000083280, 0x1b5, 0x76, 0x2) /usr/local/go/src/fmt/print.go:757 +0xf43 fp=0xc00018ab38 sp=0xc00018a958 pc=0x10aa853 fmt.(*pp).printValue(0xc000188180, 0x12a0720, 0xc0000831e0, 0x199, 0xc000000076, 0x1) /usr/local/go/src/fmt/print.go:783 +0x1ce9 fp=0xc00018ad18 sp=0xc00018ab38 pc=0x10ab5f9 fmt.(*pp).printValue(0xc000188180, 0x129ed00, 0xc0000831e0, 0x16, 0x76, 0x0) /usr/local/go/src/fmt/print.go:853 +0x1b2c fp=0xc00018aef8 sp=0xc00018ad18 pc=0x10ab43c fmt.(*pp).printArg(0xc000188180, 0x129ed00, 0xc0000831e0, 0x76) /usr/local/go/src/fmt/print.go:689 +0x2b7 fp=0xc00018af90 sp=0xc00018aef8 pc=0x10a91a7 fmt.(*pp).doPrintf(0xc000188180, 0x12afaf0, 0x16, 0xc00018b108, 0x3, 0x3) /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b078 sp=0xc00018af90 pc=0x10acde6 fmt.Sprintf(0x12afaf0, 0x16, 0xc00018b108, 0x3, 0x3, 0x0, 0x0) /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b0d0 sp=0xc00018b078 pc=0x10a5b26 context.(*valueCtx).String(0xc000080e10, 0x12be400, 0xc0001880c0) /usr/local/go/src/context/context.go:486 +0xab fp=0xc00018b148 sp=0xc00018b0d0 pc=0x11121bb fmt.(*pp).handleMethods(0xc0001880c0, 0x76, 0x1) /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018b1d8 sp=0xc00018b148 pc=0x10a8cac fmt.(*pp).printArg(0xc0001880c0, 0x1274ce0, 0xc000080e10, 0x76) /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018b270 sp=0xc00018b1d8 pc=0x10a90f3 fmt.(*pp).doPrintf(0xc0001880c0, 0x12afaf0, 0x16, 0xc00018b3e8, 0x3, 0x3) ... fmt.(*pp).printArg(0xc000188000, 0x1274ce0, 0xc000114480, 0xc000000076) /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b638 sp=0xc00018b550 pc=0x10acde6 fmt.Sprintf(0x12ad1be, 0xd, 0xc0001106c8, 0x1, 0x1, 0xc00011e080, 0xc0001106f8) /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b690 sp=0xc00018b638 pc=0x10a5b26 context.(*cancelCtx).String(0xc000116640, 0x12be400, 0xc000188300) /usr/local/go/src/context/context.go:343 +0x7d fp=0xc00018b6e8 sp=0xc00018b690 pc=0x111158d fmt.(*pp).handleMethods(0xc000188300, 0xc000000076, 0x1034601) /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018b778 sp=0xc00018b6e8 pc=0x10a8cac fmt.(*pp).printArg(0xc000188300, 0x12785e0, 0xc000116640, 0xc000000076) /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018b810 sp=0xc00018b778 pc=0x10a90f3 fmt.(*pp).doPrintf(0xc000188300, 0x12ad1be, 0xd, 0xc00018b988, 0x1, 0x1) /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b8f8 sp=0xc00018b810 pc=0x10acde6 fmt.Sprintf(0x12ad1be, 0xd, 0xc000110988, 0x1, 0x1, 0xc00011e030, 0xc0001109b8) /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b950 sp=0xc00018b8f8 pc=0x10a5b26 context.(*cancelCtx).String(0xc000116740, 0x12be400, 0xc000188240) /usr/local/go/src/context/context.go:343 +0x7d fp=0xc00018b9a8 sp=0xc00018b950 pc=0x111158d fmt.(*pp).handleMethods(0xc000188240, 0x76, 0xc000080c01) /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018ba38 sp=0xc00018b9a8 pc=0x10a8cac fmt.(*pp).printArg(0xc000188240, 0x12785e0, 0xc000116740, 0x76) /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018bad0 sp=0xc00018ba38 pc=0x10a90f3 fmt.(*pp).doPrintf(0xc000188240, 0x12ab4df, 0x3, 0xc00018bcc0, 0x1, 0x1) ... fmt.Printf(0x12ab4df, 0x3, 0xc000110cc0, 0x1, 0x1, 0xc0000fa780, 0x3, 0xc000022a70) /usr/local/go/src/fmt/print.go:197 +0x72 fp=0xc00018bc80 sp=0xc00018bc20 pc=0x10a5a82 main.panic(0x12f10c0, 0xc0001821c0, 0xc000120600) /Users/ruifengyun/test/k.go:9 +0x89 fp=0xc00018bce0 sp=0xc00018bc80 pc=0x121bb79 net/http.HandlerFunc.ServeHTTP(0x12be4e0, 0x12f10c0, 0xc0001821c0, 0xc000120600) /usr/local/go/src/net/http/server.go:1964 +0x44 fp=0xc00018bd08 sp=0xc00018bce0 pc=0x11f1b14 net/http.(*ServeMux).ServeHTTP(0x14a17a0, 0x12f10c0, 0xc0001821c0, 0xc000120600) /usr/local/go/src/net/http/server.go:2361 +0x127 fp=0xc00018bd48 sp=0xc00018bd08 pc=0x11f37c7 net/http.serverHandler.ServeHTTP(0xc0000831e0, 0x12f10c0, 0xc0001821c0, 0xc000120600) /usr/local/go/src/net/http/server.go:2741 +0xab fp=0xc00018bd78 sp=0xc00018bd48 pc=0x11f427b net/http.(*conn).serve(0xc00009d180, 0x12f12c0, 0xc000116640) /usr/local/go/src/net/http/server.go:1847 +0x646 fp=0xc00018bfc8 sp=0xc00018bd78 pc=0x11f0d66 runtime.goexit() /usr/local/go/src/runtime/asm_amd64.s:1333 +0x1 fp=0xc00018bfd0 sp=0xc00018bfc8 pc=0x1057f81 created by net/http.(*Server).Serve /usr/local/go/src/net/http/server.go:2851 +0x2f5   通过panic出来的协程调用栈信息可以分析出，fmt print会不断的递归反射及遍历解析context里的数据。 通过上面的panic信息我们可以得知根本问题是由于map的并发读写造成的，这也就说 context 内部是有map的。\n我们在正常情况下打印http.Request context，可以看到两个map，一个是listeners，一个是activeConn。另外在activeConn这个结构里还能看到很多的conn。说明这个context不单单是含有这个请求本身需要的上下文信息了，而且还包含了该server对象。\n1 2 3  // xiaorui.cc context.Background.WithValue(\u0026http.contextKey{name:\"http-server\"}, \u0026http.Server{Addr:\":9090\", Handler:http.Handler(nil), TLSConfig:(*tls.Config)(0xc000062780), ReadTimeout:0, ReadHeaderTimeout:0, WriteTimeout:0, IdleTimeout:0, MaxHeaderBytes:0, TLSNextProto:map[string]func(*http.Server, *tls.Conn, http.Handler){\"h2\":(func(*http.Server, *tls.Conn, http.Handler))(0x120b620)}, ConnState:(func(net.Conn, http.ConnState))(nil), ErrorLog:(*log.Logger)(nil), disableKeepAlives:0, inShutdown:0, nextProtoOnce:sync.Once{m:sync.Mutex{state:0, sema:0x0}, done:0x1}, nextProtoErr:error(nil), mu:sync.Mutex{state:0, sema:0x0}, listeners:map[*net.Listener]struct {}{(*net.Listener)(0xc00007ccb0):struct {}{}}, activeConn:map[*http.conn]struct {}{(*http.conn)(0xc00009cb40):struct {}{}, (*http.conn)(0xc00009d2c0):struct {}{}, (*http.conn)(0xc00009d540):struct {}{}, (*http.conn)(0xc00009dcc0):struct {}{}, (*http.conn)(0xc00009cd20):struct {}{}, (*http.conn)(0xc00009d5e0):struct {}{}, (*http.conn)(0xc00009d860):struct {}{}, (*http.conn)(0xc00009d9a0):struct {}{}, (*http.conn)(0xc0001940a0):struct {}{}, (*http.conn)(0xc00009cfa0):struct {}{}, (*http.conn)(0xc00009d400):struct {}{}, (*http.conn)(0xc00009dd60):struct {}{}, (*http.conn)(0xc000194140):struct {}{}, (*http.conn)(0xc0001941e0):struct {}{}, (*http.conn)(0xc00009caa0):struct {}{}, (*http.conn)(0xc00009d180):struct {}{}, (*http.conn)(0xc00009d220):struct {}{}, (*http.conn)(0xc00009d680):struct {}{}, (*http.conn)(0xc00009d900):struct {}{}, (*http.conn)(0xc00009cc80):struct {}{}, (*http.conn)(0xc00009ce60):struct {}{}, (*http.conn)(0xc00009d040):struct {}{}, (*http.conn)(0xc00009dc20):struct {}{}, (*http.conn)(0xc00009dea0):struct {}{}, (*http.conn)(0xc00009ca00):struct {}{}, (*http.conn)(0xc00009cdc0):struct {}{}, (*http.conn)(0xc00009d0e0):struct {}{}, (*http.conn)(0xc00009d360):struct {}{}, (*http.conn)(0xc00009da40):struct {}{}, (*http.conn)(0xc00009dae0):struct {}{}, (*http.conn)(0xc00009cbe0):struct {}{}, (*http.conn)(0xc00009d4a0):struct {}{}, (*http.conn)(0x   我们再来分析下 net/http的代码里对activeConn map的修改逻辑。不管是初始化，新增，删除都有加锁。但是他的锁的范围只是 net/http server的锁。fmt.Printf里对server对象的activeConn map遍历打印自然不受影响。\n那么，自然就会有造成 map 的panic。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  // xiaorui.cc  // 创建先的活动连接 func (s *Server) trackConn(c *conn, add bool) { s.mu.Lock() defer s.mu.Unlock() if s.activeConn == nil { s.activeConn = make(map[*conn]struct{}) } if add { s.activeConn[c] = struct{}{} } else { delete(s.activeConn, c) } } // 关闭空闲连接 func (s *Server) closeIdleConns() bool { s.mu.Lock() defer s.mu.Unlock() for c := range s.activeConn { st, unixSec := c.getState() ... delete(s.activeConn, c) } return quiescent }   这里还有个问题，这个server是从哪里传给每个请求的handler的。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  // xiaorui.cc  func (srv *Server) Serve(l net.Listener) error { baseCtx := context.Background() ... // 把他自身通过withValue生成一个ctx，并传递下去 \tctx := context.WithValue(baseCtx, ServerContextKey, srv) for { rw, e := l.Accept() ... go c.serve(ctx) } } // Serve a new connection. func (c *conn) serve(ctx context.Context) { c.remoteAddr = c.rwc.RemoteAddr().String() ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr()) ... for { w, err := c.readRequest(ctx) if c.r.remain != c.server.initialReadLimitSize() { // If we read any bytes off the wire, we're active. \tc.setState(c.rwc, StateActive) } ... req := w.req serverHandler{c.server}.ServeHTTP(w, w.req) } } }   如何解决？ 或者说安全打印\n别直接把context都输出打印就可以了。😅\nWithTimeout覆盖WithCancel context.WithCancel 内部启动 goroutine，在 ctx 被覆盖后泄露\n总结 到这里，整个 context 包的内容就全部讲完了。源码非常短，很适合学习，一定要去读一下。\ncontext 包是 Go 1.7 引入的标准库，主要用于在 goroutine 之间传递取消信号、超时时间、截止时间以及一些共享的值等。它并不是太完美，但几乎成了并发控制和超时控制的标准做法。\n使用上，先创建一个根节点的 context，之后根据库提供的四个函数创建相应功能的子节点 context。由于它是并发安全的，所以可以放心地传递。\n当使用 context 作为函数参数时，直接把它放在第一个参数的位置，并且命名为 ctx。另外，不要把 context 嵌套在自定义的类型里。\n最后，大家下次在看到代码里有用到 context 的，观察下是怎么使用的，肯定逃不出我们讲的几种类型。熟悉之后会发现：context 可能并不完美，但它确实简洁高效地解决了问题。\n参考 The Go Blog: 关于 context 的一点最佳实践\n深度解密Go语言之context\ngolang net/http输出context引起的map panic\n",
  "wordCount" : "5932",
  "inLanguage": "zh-cn",
  "datePublished": "2021-05-19T17:47:08Z",
  "dateModified": "2021-05-19T17:47:08Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/context%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      context使用实践
    </h1>
    <div class="post-meta">May 19, 2021
</div>
  </header> 
  <div class="post-content"><h2 id="如何使用-context">如何使用 context<a hidden class="anchor" aria-hidden="true" href="#如何使用-context">#</a></h2>
<p>context 使用起来非常方便。源码里对外提供了一个创建根节点 context 的函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Background</span><span class="p">()</span> <span class="nx">Context</span>
</code></pre></td></tr></table>
</div>
</div><p>background 是一个空的 context， 它不能被取消，没有值，也没有超时时间。</p>
<p>有了根节点 context，又提供了四个函数创建子节点 context：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WithCancel</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">ctx</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">cancel</span> <span class="nx">CancelFunc</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">WithDeadline</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="p">(</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">CancelFunc</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">CancelFunc</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">WithValue</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="kd">interface</span><span class="p">{})</span> <span class="nx">Context</span>
</code></pre></td></tr></table>
</div>
</div><p>context 会在函数传递间传递。只需要在适当的时间调用 cancel 函数向 goroutines 发出取消信号或者调用 Value 函数取出 context 中的值。</p>
<p>在使用 Context 的时候,有一些约定俗成的规则。</p>
<ol>
<li>一般函数使用 Context 的时候,会把这个参数放在第一个参数的位置。</li>
<li>从来不把 nil 当做 Context 类型的参数值,可以使用 context.Background() 创建一个空的上下文对象,也不要使用 nil。</li>
<li>Context 只用来临时做函数之间的上下文透传,不能持久化 Context 或者把 Context 长久保存。把 Context 持久化到数据库、本地文件或者全局变量、缓存中都是错误的用法。</li>
<li>key 的类型不应该是字符串类型或者其它内建类型,否则容易在包之间使用 Context 时候产生冲突。使用 WithValue 时,key 的类型应该是自己定义的类型。</li>
<li>常常使用 struct{}作为底层类型定义 key 的类型。对于 exported key 的静态类型,常常是接口或者指针。这样可以尽量减少内存分配。</li>
</ol>
<h2 id="传递共享的数据">传递共享的数据<a hidden class="anchor" aria-hidden="true" href="#传递共享的数据">#</a></h2>
<p>对于 Web 服务端开发，往往希望将一个请求处理的整个过程串起来，这就非常依赖于 Thread Local（对于 Go 可理解为单个协程所独有） 的变量，而在 Go 语言中并没有这个概念，因此需要在函数调用的时候传递 context。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;context&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
    <span class="nf">process</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

    <span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="s">&#34;traceId&#34;</span><span class="p">,</span> <span class="s">&#34;qcrao-2019&#34;</span><span class="p">)</span>
    <span class="nf">process</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">process</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">traceId</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="s">&#34;traceId&#34;</span><span class="p">).(</span><span class="kt">string</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;process over. trace_id=%s\n&#34;</span><span class="p">,</span> <span class="nx">traceId</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;process over. no trace_id\n&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">process</span> <span class="n">over.</span> <span class="n">no</span> <span class="n">trace_id</span>
<span class="n">process</span> <span class="n">over.</span> <span class="n">trace_id</span><span class="o">=</span><span class="n">qcrao</span><span class="m">-2019</span>
</code></pre></td></tr></table>
</div>
</div><p>第一次调用 process 函数时，ctx 是一个空的 context，自然取不出来 traceId。第二次，通过 WithValue 函数创建了一个 context，并赋上了 traceId 这个 key，自然就能取出来传入的 value 值。</p>
<p>当然，现实场景中可能是从一个 HTTP 请求中获取到的 Request-ID。所以，下面这个样例可能更适合：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="nx">requestIDKey</span> <span class="kt">int</span> <span class="p">=</span> <span class="mi">0</span>

<span class="kd">func</span> <span class="nf">WithRequestID</span><span class="p">(</span><span class="nx">next</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span>
        <span class="kd">func</span><span class="p">(</span><span class="nx">rw</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 从 header 中提取 request-id
</span><span class="c1"></span>            <span class="nx">reqID</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Header</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;X-Request-ID&#34;</span><span class="p">)</span>
            <span class="c1">// 创建 valueCtx。使用自定义的类型，不容易冲突
</span><span class="c1"></span>            <span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span>
                <span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">(),</span> <span class="nx">requestIDKey</span><span class="p">,</span> <span class="nx">reqID</span><span class="p">)</span>

            <span class="c1">// 创建新的请求
</span><span class="c1"></span>            <span class="nx">req</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nf">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

            <span class="c1">// 调用 HTTP 处理函数
</span><span class="c1"></span>            <span class="nx">next</span><span class="p">.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">rw</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 获取 request-id
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GetRequestID</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nf">Value</span><span class="p">(</span><span class="nx">requestIDKey</span><span class="p">).(</span><span class="kt">string</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Handle</span><span class="p">(</span><span class="nx">rw</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 拿到 reqId，后面可以记录日志等等
</span><span class="c1"></span>    <span class="nx">reqID</span> <span class="o">:=</span> <span class="nf">GetRequestID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nf">Context</span><span class="p">())</span>
    <span class="o">...</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">handler</span> <span class="o">:=</span> <span class="nf">WithRequestID</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="nx">Handle</span><span class="p">))</span>
    <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="取消-goroutine">取消 goroutine<a hidden class="anchor" aria-hidden="true" href="#取消-goroutine">#</a></h2>
<p>我们先来设想一个场景：打开外卖的订单页，地图上显示外卖小哥的位置，而且是每秒更新 1 次。app 端向后台发起 websocket 连接（现实中可能是轮询）请求后，后台启动一个协程，每隔 1 秒计算 1 次小哥的位置，并发送给端。如果用户退出此页面，则后台需要“取消”此过程，退出 goroutine，系统回收资源。</p>
<p>后端可能的实现如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Perform</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nf">calculatePos</span><span class="p">()</span>
        <span class="nf">sendResult</span><span class="p">()</span>
        <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果需要实现“取消”功能，并且在不了解 context 功能的前提下，可能会这样做：给函数增加一个指针型的 bool 变量，在 for 语句的开始处判断 bool 变量是发由 true 变为 false，如果改变，则退出循环。</p>
<p>上面给出的简单做法，可以实现想要的效果，没有问题，但是并不优雅，并且一旦协程数量多了之后，并且各种嵌套，就会很麻烦。优雅的做法，自然就要用到 context。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">Perform</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nf">calculatePos</span><span class="p">()</span>
        <span class="nf">sendResult</span><span class="p">()</span>

        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
            <span class="c1">// 被取消，直接返回
</span><span class="c1"></span>            <span class="k">return</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
            <span class="c1">// block 1 秒钟
</span><span class="c1"></span>        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>主流程可能是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="p">)</span>
<span class="k">go</span> <span class="nf">Perform</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>

<span class="c1">// ……
</span><span class="c1">// app 端返回页面，调用cancel 函数
</span><span class="c1"></span><span class="nf">cancel</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>注意一个细节，WithTimeOut 函数返回的 context 和 cancelFun 是分开的。context 本身并没有取消函数，这样做的原因是取消函数只能由外层函数调用，防止子节点 context 调用取消函数，从而严格控制信息的流向：由父节点 context 流向子节点 context。</p>
<h2 id="防止-goroutine-泄漏">防止 goroutine 泄漏<a hidden class="anchor" aria-hidden="true" href="#防止-goroutine-泄漏">#</a></h2>
<p>前面那个例子里，goroutine 还是会自己执行完，最后返回，只不过会多浪费一些系统资源。这里改编一个“如果不用 context 取消，goroutine 就会泄漏的例子”，来自参考资料：【避免协程泄漏】。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">gen</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">n</span>
            <span class="nx">n</span><span class="o">++</span>
            <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这是一个可以生成无限整数的协程，但如果我只需要它产生的前 5 个数，那么就会发生 goroutine 泄漏：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nf">gen</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">{</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// ……
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>当 n == 5 的时候，直接 break 掉。那么 gen 函数的协程就会执行无限循环，永远不会停下来。发生了 goroutine 泄漏。</p>
<p>用 context 改进这个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">gen</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span> <span class="p">{</span>
    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="kt">int</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nf">Done</span><span class="p">():</span>
                <span class="k">return</span>
            <span class="k">case</span> <span class="nx">ch</span> <span class="o">&lt;-</span> <span class="nx">n</span><span class="p">:</span>
                <span class="nx">n</span><span class="o">++</span>
                <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="k">return</span> <span class="nx">ch</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
    <span class="k">defer</span> <span class="nf">cancel</span><span class="p">()</span> <span class="c1">// 避免其他地方忘记 cancel，且重复调用不影响
</span><span class="c1"></span>
    <span class="k">for</span> <span class="nx">n</span> <span class="o">:=</span> <span class="k">range</span> <span class="nf">gen</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">5</span> <span class="p">{</span>
            <span class="nf">cancel</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// ……
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>增加一个 context，在 break 前调用 cancel 函数，取消 goroutine。gen 函数在接收到取消信号后，直接退出，系统回收资源。</p>
<h2 id="作为函数参数传递">作为函数参数传递<a hidden class="anchor" aria-hidden="true" href="#作为函数参数传递">#</a></h2>
<p>在许多 Go API，尤其是现代 API 中，函数和方法的第一个参数通常是 context.Context。context 提供了很多方法例如 WithCancel、WithDeadline、WithValue、以实现跨 API 的流程控制。很多 lib 在与远程服务器(如数据库、api等)交互时，经常使用 context 做控制。</p>
<p>context 的文档中讲到:</p>
<p>context 不应存储在 struct 内部，最好的方式是作为函数的第一个参数传递</p>
<p>本文在此建议的基础上讲解了原因和示例，说明了为什么要使用函数传递 Context 而不是将其存储在 struct 中的重要性。还以 net/http 的代码为例，解释了应该在何种情况下可以在 struct 中 存储 Context 。</p>
<h3 id="推荐-context-作为函数参数传递">推荐 context 作为函数参数传递<a hidden class="anchor" aria-hidden="true" href="#推荐-context-作为函数参数传递">#</a></h3>
<p>让我们先看下在函数中传递 context：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Worker</span> <span class="kd">struct</span> <span class="p">{</span> <span class="cm">/*…*/</span> <span class="p">}</span>

<span class="kd">type</span> <span class="nx">Work</span> <span class="kd">struct</span> <span class="p">{</span> <span class="cm">/*…*/</span> <span class="p">}</span>

<span class="kd">func</span> <span class="nf">New</span><span class="p">()</span> <span class="o">*</span><span class="nx">Worker</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Worker</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">Worker</span><span class="p">)</span> <span class="nf">Fetch</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Work</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctx</span> <span class="c1">// A per-call ctx is used for cancellation, deadlines, and metadata.
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">Worker</span><span class="p">)</span> <span class="nf">Process</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">w</span><span class="o">*</span><span class="nx">Work</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">ctx</span> <span class="c1">// A per-call ctx is used for cancellation, deadlines, and metadata.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里 <code>(*Worker).Fetch</code> 和 <code>(*Worker).Process</code> 都直接将 context 作为函数第一个参数。这样从 context 的生成到结束，调用方可以很清晰地知道 context 的传递路线。</p>
<h3 id="将-context-存储到-strcut-所带来的一些困惑">将 context 存储到 strcut 所带来的一些困惑<a hidden class="anchor" aria-hidden="true" href="#将-context-存储到-strcut-所带来的一些困惑">#</a></h3>
<p>在结构体中嵌套 context 来实现上面的 Worker 示例，调用者对所使用的 context 生命周期产生迷惑：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Worker</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">New</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="o">*</span><span class="nx">Worker</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Worker</span><span class="p">{</span><span class="nx">ctx</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">Worker</span><span class="p">)</span> <span class="nf">Fetch</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">Work</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">ctx</span> <span class="c1">// A shared w.ctx is used for cancellation, deadlines, and metadata.
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">Worker</span><span class="p">)</span> <span class="nf">Process</span><span class="p">(</span><span class="nx">w</span><span class="o">*</span><span class="nx">Work</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">_</span> <span class="p">=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">ctx</span> <span class="c1">// A shared w.ctx is used for cancellation, deadlines, and metadata.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>(*Worker).Fetch</code> 和 <code>(*Worker).Process</code> 方法同时使用了 Worker 结构体中的 context ，这种情况下使得调用方无法定义不同的 context ，比如有调用方想用 WitchCancel，有的想用 WithDeadline，也很难理解上面传来的 context 的作用是 cancel？还是 deadline?调用者所使用 context 的生命周期被绑定到了一个共享的 context 上面。</p>
<h3 id="特殊情况保留向后兼容性">特殊情况：保留向后兼容性<a hidden class="anchor" aria-hidden="true" href="#特殊情况保留向后兼容性">#</a></h3>
<p>当 go 1.7 版本发布时，大量的的 API 需要以向后兼容的方式支持 context.Context，例如，net/http 的 Client 方法（例如Get和Do）是使用 context 的典范。使用这些方法发送的 http 请求都将受益于 context.Context 附带的 WithDeadline，WithCancel 和 WithValue 等方法支持。</p>
<p>一般有两种方式能够在支持 context.Context 的同时保持代码的向后兼容：</p>
<ol>
<li>在 struct 中添加 context (稍后我们将看到)；</li>
<li>复制原有函数，在函数第一个参数中使用 context，举个栗子，database/sql 这个 package 的 Query 方法的签名一直是:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Query</span><span class="p">(</span><span class="nx">query</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">Rows</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>当 context package 引入的时候，Go team 新增了这样一个函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">QueryContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">query</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">Rows</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>并且只修改了一处代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">DB</span><span class="p">)</span> <span class="nf">Query</span><span class="p">(</span><span class="nx">query</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">args</span> <span class="o">...</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">(</span><span class="o">*</span><span class="nx">Rows</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nf">QueryContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(),</span> <span class="nx">query</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>通过这种方式，Go team 能够在平滑地升级一个 package 的同时不对代码的可读性、兼容性造成影响。类似的代码在 golang 源码中随处可见。更多的保持代码兼容性的讨论可见 [Go team 关于如何保持 Go Modules 兼容性的一些实践]。</p>
<p>然而在某些情况下，比如 API 公开了大量 function，重写所有函数是不切实际的。</p>
<p>package net/http 选择在 struct 中添加 context.Context，这是一个结构体嵌套 context 比较恰当的范例。先让我们看下 net/http 的 Do 函数。在引入 context 之前，Do 的定义如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>在 1.7 引入 context 后，为了遵循 net/http 这种标准库的向后兼容原则，考虑到该核心库所包含的函数过于多，maintainers 选择在结构体 http.Request 中添加 context.Context。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Request</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>

  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">NewRequestWithContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">url</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">body</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Request</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Simplified for brevity of this article.
</span><span class="c1"></span>  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Request</span><span class="p">{</span>
    <span class="nx">ctx</span><span class="p">:</span> <span class="nx">ctx</span><span class="p">,</span>
    <span class="c1">// ...
</span><span class="c1"></span>  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Do</span><span class="p">(</span><span class="nx">req</span><span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>在修改大量 API 以支持 context 时，在结构体中添加 context.Context 是有意义的， 如上所述。但是，记住首先要考虑复制函数对 context 进行支持，在不牺牲实用性和理解性的前提下向后兼容上下文:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">Call</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">CallContext</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Client</span><span class="p">)</span> <span class="nf">CallContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="context-真的这么好吗">context 真的这么好吗<a hidden class="anchor" aria-hidden="true" href="#context-真的这么好吗">#</a></h2>
<p>读完全文，你一定有这种感觉：context 就是为 server 而设计的。说什么处理一个请求，需要启动多个 goroutine 并行地去处理，并且在这些 goroutine 之间还要传递一些共享的数据等等，这些都是写一个 server 要做的事。</p>
<p>没错，Go 很适合写 server，但它终归是一门通用的语言。你在用 Go 做 Leetcode 上面的题目的时候，肯定不会认为它和一般的语言有什么差别。所以，很多特性好不好，应该从 Go 只是一门普通的语言，很擅长写 server 的角度来看。</p>
<p>从这个角度来看，context 并没有那么美好。Go 官方建议我们把 Context 作为函数的第一个参数，甚至连名字都准备好了。这造成一个后果：因为我们想控制所有的协程的取消动作，所以需要在几乎所有的函数里加上一个 Context 参数。很快，我们的代码里，context 将像病毒一样扩散的到处都是。</p>
<p>在参考资料【Go2 应该去掉 context】这篇英文博客里，作者甚至调侃说：如果要把 Go 标准库的大部分函数都加上 context 参数的话，例如下面这样：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">TODO</span><span class="p">(),</span> <span class="nx">p</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>就给我来一枪吧！</p>
<p>原文是这样说的：put a bullet in my head, please.我当时看到这句话的时候，会心一笑。这可能就是陶渊明说的：每有会意，便欣然忘食。当然，我是在晚饭会看到这句话的。</p>
<p>为了表达自己对 context 并没有什么好感，作者接着又说了一句：If you use ctx.Value in my (non-existent) company, you’re fired. 简直太幽默了，哈哈。</p>
<p>另外，像 WithCancel、WithDeadline、WithTimeout、WithValue 这些创建函数，实际上是创建了一个个的链表结点而已。我们知道，对链表的操作，通常都是 O(n) 复杂度的，效率不高。</p>
<p>那么，context 包到底解决了什么问题呢？答案是：cancelation。仅管它并不完美，但它确实很简洁地解决了问题。</p>
<h2 id="打印context引起panic">打印context引起panic<a hidden class="anchor" aria-hidden="true" href="#打印context引起panic">#</a></h2>
<h3 id="分析问题">分析问题<a hidden class="anchor" aria-hidden="true" href="#分析问题">#</a></h3>
<p>下面是出现net/http context panic的问题代码，代码的逻辑很简单，就是定义一个api，然后打印context而已。把服务运行起来后，我们可以用ab, wrk来进行压测，来制造data race竞争的场景。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// xiaorui.cc
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;net/http&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nb">panic</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Context</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">panic</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="s">&#34;:9090&#34;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>下面是wrk压测时，net/http服务的异常信息。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">//</span> <span class="n">xiaorui.cc</span>

<span class="n">fatal</span> <span class="n">error</span><span class="o">:</span> <span class="n">concurrent</span> <span class="n">map</span> <span class="n">read</span> <span class="n">and</span> <span class="n">map</span> <span class="n">write</span>

<span class="nf">context.Background.WithValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">http.contextKey</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="s">&#34;http-server&#34;</span><span class="p">},</span> <span class="o">&amp;</span><span class="n">http.Server</span><span class="p">{</span><span class="n">Addr</span><span class="o">:</span><span class="s">&#34;:9090&#34;</span><span class="p">,</span> <span class="n">Handler</span><span class="o">:</span><span class="nf">http.Handler</span><span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">TLSConfig</span><span class="o">:</span><span class="p">(</span><span class="o">*</span><span class="n">tls.Config</span><span class="p">)(</span><span class="mh">0xc000062780</span><span class="p">),</span> <span class="n">ReadTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">ReadHeaderTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">WriteTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">IdleTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">MaxHeaderBytes</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">TLSNextProto</span><span class="o">:</span><span class="n">map[string</span><span class="nf">]func</span><span class="p">(</span><span class="o">*</span><span class="n">http.Server</span><span class="p">,</span> <span class="o">*</span><span class="n">tls.Conn</span><span class="p">,</span> <span class="n">http.Handler</span><span class="p">){</span><span class="s">&#34;h2&#34;</span><span class="o">:</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">http.Server</span><span class="p">,</span> <span class="o">*</span><span class="n">tls.Conn</span><span class="p">,</span> <span class="n">http.Handler</span><span class="p">))(</span><span class="mh">0x120b620</span><span class="p">)},</span> <span class="n">ConnState</span><span class="o">:</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="n">net.Conn</span><span class="p">,</span> <span class="n">http.ConnState</span><span class="p">))(</span><span class="n">nil</span><span class="p">),</span> <span class="n">ErrorLog</span><span class="o">:</span><span class="p">(</span><span class="o">*</span><span class="n">log.Logger</span><span class="p">)(</span><span class="n">nil</span><span class="p">),</span> <span class="n">disableKeepAlives</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">inShutdown</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">nextProtoOnce</span><span class="o">:</span><span class="n">sync.Once</span><span class="p">{</span><span class="n">m</span><span class="o">:</span><span class="n">sync.Mutex</span><span class="p">{</span><span class="n">state</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">sema</span><span class="o">:</span><span class="mh">0x0</span><span class="p">},</span> <span class="n">done</span><span class="o">:</span><span class="mh">0x1</span><span class="p">},</span> <span class="n">nextProtoErr</span><span class="o">:</span><span class="nf">error</span><span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">mu</span><span class="o">:</span><span class="n">sync.Mutex</span><span class="p">{</span><span class="n">state</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">sema</span><span class="o">:</span><span class="mh">0x0</span><span class="p">},</span> <span class="n">listeners</span><span class="o">:</span><span class="n">map[</span><span class="o">*</span><span class="n">net.Listener]struct</span> <span class="p">{}{(</span><span class="o">*</span><span class="n">net.Listener</span><span class="p">)(</span><span class="mh">0xc00007ccb0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{}},</span> <span class="n">activeConn</span><span class="o">:</span><span class="n">map[</span><span class="o">*</span><span class="n">http.conn]struct</span> <span class="p">{}{(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cb40</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d2c0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d540</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dcc0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cd20</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d5e0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}</span><span class="kc">...</span>
<span class="n">xiaorui.cc</span>
<span class="n">goroutine</span> <span class="m">32</span> <span class="n">[running]</span><span class="o">:</span>
<span class="nf">runtime.throw</span><span class="p">(</span><span class="mh">0x12b35e3</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">panic.go</span><span class="o">:</span><span class="m">608</span> <span class="m">+0</span><span class="n">x72</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018a858</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a828</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x102b892</span>
<span class="nf">runtime.mapaccess2</span><span class="p">(</span><span class="mh">0x1255800</span><span class="p">,</span> <span class="mh">0xc000080ea0</span><span class="p">,</span> <span class="mh">0xc00018a978</span><span class="p">,</span> <span class="mh">0x14bf328</span><span class="p">,</span> <span class="mh">0xc0000ac868</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">map.go</span><span class="o">:</span><span class="m">453</span> <span class="m">+0</span><span class="n">x223</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018a8a0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a858</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x100ed93</span>
<span class="nf">reflect.mapaccess</span><span class="p">(</span><span class="mh">0x1255800</span><span class="p">,</span> <span class="mh">0xc000080ea0</span><span class="p">,</span> <span class="mh">0xc00018a978</span><span class="p">,</span> <span class="mh">0x12afece</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">map.go</span><span class="o">:</span><span class="m">1249</span> <span class="m">+0</span><span class="n">x3f</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018a8d8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a8a0</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x1010adf</span>
<span class="nf">reflect.Value.MapIndex</span><span class="p">(</span><span class="mh">0x1255800</span><span class="p">,</span> <span class="mh">0xc000083280</span><span class="p">,</span> <span class="mh">0x1b5</span><span class="p">,</span> <span class="mh">0x1288180</span><span class="p">,</span> <span class="mh">0xc00009da40</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x1257ae0</span><span class="p">,</span> <span class="mh">0x14bf328</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">reflect</span><span class="o">/</span><span class="n">value.go</span><span class="o">:</span><span class="m">1111</span> <span class="m">+0</span><span class="n">x11d</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018a958</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a8d8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x1099b7d</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printValue</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x1255800</span><span class="p">,</span> <span class="mh">0xc000083280</span><span class="p">,</span> <span class="mh">0x1b5</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">757</span> <span class="m">+0</span><span class="n">xf43</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018ab38</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018a958</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10aa853</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printValue</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x12a0720</span><span class="p">,</span> <span class="mh">0xc0000831e0</span><span class="p">,</span> <span class="mh">0x199</span><span class="p">,</span> <span class="mh">0xc000000076</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">783</span> <span class="m">+0</span><span class="n">x1ce9</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018ad18</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018ab38</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10ab5f9</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printValue</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x129ed00</span><span class="p">,</span> <span class="mh">0xc0000831e0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">853</span> <span class="m">+0</span><span class="n">x1b2c</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018aef8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018ad18</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10ab43c</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x129ed00</span><span class="p">,</span> <span class="mh">0xc0000831e0</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">689</span> <span class="m">+0</span><span class="n">x2b7</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018af90</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018aef8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a91a7</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.doPrintf</span><span class="p">(</span><span class="mh">0xc000188180</span><span class="p">,</span> <span class="mh">0x12afaf0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc00018b108</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">1003</span> <span class="m">+0</span><span class="n">x166</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b078</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018af90</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10acde6</span>
<span class="nf">fmt.Sprintf</span><span class="p">(</span><span class="mh">0x12afaf0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc00018b108</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">203</span> <span class="m">+0</span><span class="n">x66</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b0d0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b078</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a5b26</span>
<span class="nf">context.</span><span class="p">(</span><span class="o">*</span><span class="n">valueCtx</span><span class="p">)</span><span class="nf">.String</span><span class="p">(</span><span class="mh">0xc000080e10</span><span class="p">,</span> <span class="mh">0x12be400</span><span class="p">,</span> <span class="mh">0xc0001880c0</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">context.go</span><span class="o">:</span><span class="m">486</span> <span class="m">+0</span><span class="n">xab</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b148</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b0d0</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11121bb</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.handleMethods</span><span class="p">(</span><span class="mh">0xc0001880c0</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">603</span> <span class="m">+0</span><span class="n">x27c</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b1d8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b148</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a8cac</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc0001880c0</span><span class="p">,</span> <span class="mh">0x1274ce0</span><span class="p">,</span> <span class="mh">0xc000080e10</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">686</span> <span class="m">+0</span><span class="n">x203</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b270</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b1d8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a90f3</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.doPrintf</span><span class="p">(</span><span class="mh">0xc0001880c0</span><span class="p">,</span> <span class="mh">0x12afaf0</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xc00018b3e8</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">)</span>
<span class="kc">...</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc000188000</span><span class="p">,</span> <span class="mh">0x1274ce0</span><span class="p">,</span> <span class="mh">0xc000114480</span><span class="p">,</span> <span class="mh">0xc000000076</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">1003</span> <span class="m">+0</span><span class="n">x166</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b638</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b550</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10acde6</span>
<span class="nf">fmt.Sprintf</span><span class="p">(</span><span class="mh">0x12ad1be</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xc0001106c8</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc00011e080</span><span class="p">,</span> <span class="mh">0xc0001106f8</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">203</span> <span class="m">+0</span><span class="n">x66</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b690</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b638</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a5b26</span>
<span class="nf">context.</span><span class="p">(</span><span class="o">*</span><span class="n">cancelCtx</span><span class="p">)</span><span class="nf">.String</span><span class="p">(</span><span class="mh">0xc000116640</span><span class="p">,</span> <span class="mh">0x12be400</span><span class="p">,</span> <span class="mh">0xc000188300</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">context.go</span><span class="o">:</span><span class="m">343</span> <span class="m">+0</span><span class="n">x7d</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b6e8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b690</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x111158d</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.handleMethods</span><span class="p">(</span><span class="mh">0xc000188300</span><span class="p">,</span> <span class="mh">0xc000000076</span><span class="p">,</span> <span class="mh">0x1034601</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">603</span> <span class="m">+0</span><span class="n">x27c</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b778</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b6e8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a8cac</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc000188300</span><span class="p">,</span> <span class="mh">0x12785e0</span><span class="p">,</span> <span class="mh">0xc000116640</span><span class="p">,</span> <span class="mh">0xc000000076</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">686</span> <span class="m">+0</span><span class="n">x203</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b810</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b778</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a90f3</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.doPrintf</span><span class="p">(</span><span class="mh">0xc000188300</span><span class="p">,</span> <span class="mh">0x12ad1be</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xc00018b988</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">1003</span> <span class="m">+0</span><span class="n">x166</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b8f8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b810</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10acde6</span>
<span class="nf">fmt.Sprintf</span><span class="p">(</span><span class="mh">0x12ad1be</span><span class="p">,</span> <span class="mh">0xd</span><span class="p">,</span> <span class="mh">0xc000110988</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc00011e030</span><span class="p">,</span> <span class="mh">0xc0001109b8</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">203</span> <span class="m">+0</span><span class="n">x66</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b950</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b8f8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a5b26</span>
<span class="nf">context.</span><span class="p">(</span><span class="o">*</span><span class="n">cancelCtx</span><span class="p">)</span><span class="nf">.String</span><span class="p">(</span><span class="mh">0xc000116740</span><span class="p">,</span> <span class="mh">0x12be400</span><span class="p">,</span> <span class="mh">0xc000188240</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="o">/</span><span class="n">context.go</span><span class="o">:</span><span class="m">343</span> <span class="m">+0</span><span class="n">x7d</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018b9a8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b950</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x111158d</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.handleMethods</span><span class="p">(</span><span class="mh">0xc000188240</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">,</span> <span class="mh">0xc000080c01</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">603</span> <span class="m">+0</span><span class="n">x27c</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018ba38</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018b9a8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a8cac</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.printArg</span><span class="p">(</span><span class="mh">0xc000188240</span><span class="p">,</span> <span class="mh">0x12785e0</span><span class="p">,</span> <span class="mh">0xc000116740</span><span class="p">,</span> <span class="mh">0x76</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">686</span> <span class="m">+0</span><span class="n">x203</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bad0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018ba38</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a90f3</span>
<span class="nf">fmt.</span><span class="p">(</span><span class="o">*</span><span class="n">pp</span><span class="p">)</span><span class="nf">.doPrintf</span><span class="p">(</span><span class="mh">0xc000188240</span><span class="p">,</span> <span class="mh">0x12ab4df</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xc00018bcc0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">)</span>
 <span class="kc">...</span>
<span class="nf">fmt.Printf</span><span class="p">(</span><span class="mh">0x12ab4df</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xc000110cc0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0xc0000fa780</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0xc000022a70</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">fmt</span><span class="o">/</span><span class="n">print.go</span><span class="o">:</span><span class="m">197</span> <span class="m">+0</span><span class="n">x72</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bc80</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bc20</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x10a5a82</span>
<span class="nf">main.panic</span><span class="p">(</span><span class="mh">0x12f10c0</span><span class="p">,</span> <span class="mh">0xc0001821c0</span><span class="p">,</span> <span class="mh">0xc000120600</span><span class="p">)</span>
        <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">ruifengyun</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">k.go</span><span class="o">:</span><span class="m">9</span> <span class="m">+0</span><span class="n">x89</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bce0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bc80</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x121bb79</span>
<span class="n">net</span><span class="o">/</span><span class="nf">http.HandlerFunc.ServeHTTP</span><span class="p">(</span><span class="mh">0x12be4e0</span><span class="p">,</span> <span class="mh">0x12f10c0</span><span class="p">,</span> <span class="mh">0xc0001821c0</span><span class="p">,</span> <span class="mh">0xc000120600</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">1964</span> <span class="m">+0</span><span class="n">x44</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bd08</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bce0</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11f1b14</span>
<span class="n">net</span><span class="o">/</span><span class="nf">http.</span><span class="p">(</span><span class="o">*</span><span class="n">ServeMux</span><span class="p">)</span><span class="nf">.ServeHTTP</span><span class="p">(</span><span class="mh">0x14a17a0</span><span class="p">,</span> <span class="mh">0x12f10c0</span><span class="p">,</span> <span class="mh">0xc0001821c0</span><span class="p">,</span> <span class="mh">0xc000120600</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">2361</span> <span class="m">+0</span><span class="n">x127</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bd48</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bd08</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11f37c7</span>
<span class="n">net</span><span class="o">/</span><span class="nf">http.serverHandler.ServeHTTP</span><span class="p">(</span><span class="mh">0xc0000831e0</span><span class="p">,</span> <span class="mh">0x12f10c0</span><span class="p">,</span> <span class="mh">0xc0001821c0</span><span class="p">,</span> <span class="mh">0xc000120600</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">2741</span> <span class="m">+0</span><span class="n">xab</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bd78</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bd48</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11f427b</span>
<span class="n">net</span><span class="o">/</span><span class="nf">http.</span><span class="p">(</span><span class="o">*</span><span class="n">conn</span><span class="p">)</span><span class="nf">.serve</span><span class="p">(</span><span class="mh">0xc00009d180</span><span class="p">,</span> <span class="mh">0x12f12c0</span><span class="p">,</span> <span class="mh">0xc000116640</span><span class="p">)</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">1847</span> <span class="m">+0</span><span class="n">x646</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bfc8</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bd78</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x11f0d66</span>
<span class="nf">runtime.goexit</span><span class="p">()</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">asm_amd64.s</span><span class="o">:</span><span class="m">1333</span> <span class="m">+0</span><span class="n">x1</span> <span class="n">fp</span><span class="o">=</span><span class="mh">0xc00018bfd0</span> <span class="n">sp</span><span class="o">=</span><span class="mh">0xc00018bfc8</span> <span class="n">pc</span><span class="o">=</span><span class="mh">0x1057f81</span>
<span class="n">created</span> <span class="n">by</span> <span class="n">net</span><span class="o">/</span><span class="nf">http.</span><span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span><span class="n">.Serve</span>
        <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">http</span><span class="o">/</span><span class="n">server.go</span><span class="o">:</span><span class="m">2851</span> <span class="m">+0</span><span class="n">x2f5</span>
</code></pre></td></tr></table>
</div>
</div><p>通过panic出来的协程调用栈信息可以分析出，fmt print会不断的递归反射及遍历解析context里的数据。 通过上面的panic信息我们可以得知根本问题是由于map的并发读写造成的，这也就说 context 内部是有map的。</p>
<p>我们在正常情况下打印http.Request context，可以看到两个map，一个是listeners，一个是activeConn。另外在activeConn这个结构里还能看到很多的conn。说明这个context不单单是含有这个请求本身需要的上下文信息了，而且还包含了该server对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">//</span> <span class="n">xiaorui.cc</span>

<span class="nf">context.Background.WithValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">http.contextKey</span><span class="p">{</span><span class="n">name</span><span class="o">:</span><span class="s">&#34;http-server&#34;</span><span class="p">},</span> <span class="o">&amp;</span><span class="n">http.Server</span><span class="p">{</span><span class="n">Addr</span><span class="o">:</span><span class="s">&#34;:9090&#34;</span><span class="p">,</span> <span class="n">Handler</span><span class="o">:</span><span class="nf">http.Handler</span><span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">TLSConfig</span><span class="o">:</span><span class="p">(</span><span class="o">*</span><span class="n">tls.Config</span><span class="p">)(</span><span class="mh">0xc000062780</span><span class="p">),</span> <span class="n">ReadTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">ReadHeaderTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">WriteTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">IdleTimeout</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">MaxHeaderBytes</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">TLSNextProto</span><span class="o">:</span><span class="n">map[string</span><span class="nf">]func</span><span class="p">(</span><span class="o">*</span><span class="n">http.Server</span><span class="p">,</span> <span class="o">*</span><span class="n">tls.Conn</span><span class="p">,</span> <span class="n">http.Handler</span><span class="p">){</span><span class="s">&#34;h2&#34;</span><span class="o">:</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="o">*</span><span class="n">http.Server</span><span class="p">,</span> <span class="o">*</span><span class="n">tls.Conn</span><span class="p">,</span> <span class="n">http.Handler</span><span class="p">))(</span><span class="mh">0x120b620</span><span class="p">)},</span> <span class="n">ConnState</span><span class="o">:</span><span class="p">(</span><span class="nf">func</span><span class="p">(</span><span class="n">net.Conn</span><span class="p">,</span> <span class="n">http.ConnState</span><span class="p">))(</span><span class="n">nil</span><span class="p">),</span> <span class="n">ErrorLog</span><span class="o">:</span><span class="p">(</span><span class="o">*</span><span class="n">log.Logger</span><span class="p">)(</span><span class="n">nil</span><span class="p">),</span> <span class="n">disableKeepAlives</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">inShutdown</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">nextProtoOnce</span><span class="o">:</span><span class="n">sync.Once</span><span class="p">{</span><span class="n">m</span><span class="o">:</span><span class="n">sync.Mutex</span><span class="p">{</span><span class="n">state</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">sema</span><span class="o">:</span><span class="mh">0x0</span><span class="p">},</span> <span class="n">done</span><span class="o">:</span><span class="mh">0x1</span><span class="p">},</span> <span class="n">nextProtoErr</span><span class="o">:</span><span class="nf">error</span><span class="p">(</span><span class="n">nil</span><span class="p">),</span> <span class="n">mu</span><span class="o">:</span><span class="n">sync.Mutex</span><span class="p">{</span><span class="n">state</span><span class="o">:</span><span class="m">0</span><span class="p">,</span> <span class="n">sema</span><span class="o">:</span><span class="mh">0x0</span><span class="p">},</span> <span class="n">listeners</span><span class="o">:</span><span class="n">map[</span><span class="o">*</span><span class="n">net.Listener]struct</span> <span class="p">{}{(</span><span class="o">*</span><span class="n">net.Listener</span><span class="p">)(</span><span class="mh">0xc00007ccb0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{}},</span> <span class="n">activeConn</span><span class="o">:</span><span class="n">map[</span><span class="o">*</span><span class="n">http.conn]struct</span> <span class="p">{}{(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cb40</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d2c0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d540</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dcc0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cd20</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d5e0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d860</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d9a0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc0001940a0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cfa0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d400</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dd60</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc000194140</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc0001941e0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009caa0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d180</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d220</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d680</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d900</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cc80</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009ce60</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d040</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dc20</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dea0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009ca00</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cdc0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d0e0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d360</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009da40</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009dae0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009cbe0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="mh">0xc00009d4a0</span><span class="p">)</span><span class="o">:</span><span class="n">struct</span> <span class="p">{}{},</span> <span class="p">(</span><span class="o">*</span><span class="n">http.conn</span><span class="p">)(</span><span class="m">0</span><span class="n">x</span>
</code></pre></td></tr></table>
</div>
</div><p>我们再来分析下 net/http的代码里对activeConn map的修改逻辑。不管是初始化，新增，删除都有加锁。但是他的锁的范围只是 net/http server的锁。fmt.Printf里对server对象的activeConn map遍历打印自然不受影响。</p>
<p>那么，自然就会有造成 map 的panic。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// xiaorui.cc
</span><span class="c1"></span>
<span class="c1">// 创建先的活动连接
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">trackConn</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">,</span> <span class="nx">add</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">conn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{})</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">add</span> <span class="p">{</span>
		<span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span><span class="p">[</span><span class="nx">c</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{}{}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 关闭空闲连接
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">closeIdleConns</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">c</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span> <span class="p">{</span>
		<span class="nx">st</span><span class="p">,</span> <span class="nx">unixSec</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">getState</span><span class="p">()</span>
                <span class="o">...</span>
		<span class="nb">delete</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">activeConn</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">quiescent</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>这里还有个问题，这个server是从哪里传给每个请求的handler的。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// xiaorui.cc
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">srv</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">baseCtx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">()</span>
        <span class="o">...</span>

        <span class="c1">// 把他自身通过withValue生成一个ctx，并传递下去
</span><span class="c1"></span>	<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">baseCtx</span><span class="p">,</span> <span class="nx">ServerContextKey</span><span class="p">,</span> <span class="nx">srv</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">rw</span><span class="p">,</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
        <span class="o">...</span>
		<span class="k">go</span> <span class="nx">c</span><span class="p">.</span><span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Serve a new connection.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">)</span> <span class="nf">serve</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">c</span><span class="p">.</span><span class="nx">remoteAddr</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">.</span><span class="nf">RemoteAddr</span><span class="p">().</span><span class="nf">String</span><span class="p">()</span>
	<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">LocalAddrContextKey</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">.</span><span class="nf">LocalAddr</span><span class="p">())</span>
    <span class="o">...</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">readRequest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nx">remain</span> <span class="o">!=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nf">initialReadLimitSize</span><span class="p">()</span> <span class="p">{</span>
			<span class="c1">// If we read any bytes off the wire, we&#39;re active.
</span><span class="c1"></span>			<span class="nx">c</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">rwc</span><span class="p">,</span> <span class="nx">StateActive</span><span class="p">)</span>
		<span class="p">}</span>
        <span class="o">...</span>

		<span class="nx">req</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nx">req</span>
		<span class="nx">serverHandler</span><span class="p">{</span><span class="nx">c</span><span class="p">.</span><span class="nx">server</span><span class="p">}.</span><span class="nf">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">req</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如何解决？ 或者说安全打印</p>
<p>别直接把context都输出打印就可以了。😅</p>
<h2 id="withtimeout覆盖withcancel">WithTimeout覆盖WithCancel<a hidden class="anchor" aria-hidden="true" href="#withtimeout覆盖withcancel">#</a></h2>
<p>context.WithCancel 内部启动 goroutine，在 ctx 被覆盖后泄露</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20210819170858.png" alt=""  />
</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>到这里，整个 context 包的内容就全部讲完了。源码非常短，很适合学习，一定要去读一下。</p>
<p>context 包是 Go 1.7 引入的标准库，主要用于在 goroutine 之间传递取消信号、超时时间、截止时间以及一些共享的值等。它并不是太完美，但几乎成了并发控制和超时控制的标准做法。</p>
<p>使用上，先创建一个根节点的 context，之后根据库提供的四个函数创建相应功能的子节点 context。由于它是并发安全的，所以可以放心地传递。</p>
<p>当使用 context 作为函数参数时，直接把它放在第一个参数的位置，并且命名为 ctx。另外，不要把 context 嵌套在自定义的类型里。</p>
<p>最后，大家下次在看到代码里有用到 context 的，观察下是怎么使用的，肯定逃不出我们讲的几种类型。熟悉之后会发现：context 可能并不完美，但它确实简洁高效地解决了问题。</p>
<h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<p><a href="https://mp.weixin.qq.com/s/ayySDQNTRlxjHuiAsaIwhw">The Go Blog: 关于 context 的一点最佳实践</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/68792989">深度解密Go语言之context</a></p>
<p><a href="http://xiaorui.cc/archives/5919">golang net/http输出context引起的map panic</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
