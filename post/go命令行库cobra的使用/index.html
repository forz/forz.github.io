<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Go命令行库Cobra的使用 | Forz Blog</title>
<meta name="keywords" content="Go, Cobra" />
<meta name="description" content="Cobra提供简单的接口来创建强大的现代化CLI接口，比如git与go工具。Cobra同时也是一个程序, 用于创建CLI程序 功能 简易的子命令行">
<meta name="author" content="">
<link rel="canonical" href="/post/go%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BA%93cobra%E7%9A%84%E4%BD%BF%E7%94%A8/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Go命令行库Cobra的使用" />
<meta property="og:description" content="Cobra提供简单的接口来创建强大的现代化CLI接口，比如git与go工具。Cobra同时也是一个程序, 用于创建CLI程序 功能 简易的子命令行" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/go%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BA%93cobra%E7%9A%84%E4%BD%BF%E7%94%A8/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-06-23T22:08:13&#43;00:00" />
<meta property="article:modified_time" content="2020-06-23T22:08:13&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go命令行库Cobra的使用"/>
<meta name="twitter:description" content="Cobra提供简单的接口来创建强大的现代化CLI接口，比如git与go工具。Cobra同时也是一个程序, 用于创建CLI程序 功能 简易的子命令行"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Go命令行库Cobra的使用",
      "item": "/post/go%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BA%93cobra%E7%9A%84%E4%BD%BF%E7%94%A8/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Go命令行库Cobra的使用",
  "name": "Go命令行库Cobra的使用",
  "description": "Cobra提供简单的接口来创建强大的现代化CLI接口，比如git与go工具。Cobra同时也是一个程序, 用于创建CLI程序 功能 简易的子命令行",
  "keywords": [
    "Go", "Cobra"
  ],
  "articleBody": "Cobra提供简单的接口来创建强大的现代化CLI接口，比如git与go工具。Cobra同时也是一个程序, 用于创建CLI程序\n功能  简易的子命令行模式，如 app server， app fetch等等 完全兼容posix命令行模式 嵌套子命令subcommand 支持全局，局部，串联flags 使用Cobra很容易的生成应用程序和命令，使用cobra create appname和cobra add cmdname 如果命令输入错误，将提供智能建议，如 app srver，将提示srver没有，是否是app server 自动生成commands和flags的帮助信息 自动生成详细的help信息，如app help 自动识别-h，–help帮助flag 自动生成应用程序在bash下命令自动完成功能 自动生成应用程序的man手册 命令行别名 零活定义help和usage信息 可选的紧密集成的viper apps  概念 Cobra是建立在结构的命令、参数和选项之上。\ncobra 中有个重要的概念，分别是 commands、arguments 和 flags。其中 commands 代表行为，arguments 就是命令行参数(或者称为位置参数)，flags 代表对行为的改变(也就是我们常说的命令行选项)。执行命令行程序时的一般格式为：\n1  APPNAME COMMAND ARG --FLAG   比如下面的例子：\n1 2 3 4 5  # server是 commands，port 是 flag hugo server --port=1313 # clone 是 commands，URL 是 arguments，brae 是 flag git clone URL --bare   如果是一个简单的程序(功能单一的程序)，使用 commands 的方式可能会很啰嗦，但是像 git、docker 等应用，把这些本就很复杂的功能划分为子命令的形式，会方便使用(对程序的设计者来说又何尝不是如此)。\n安装 使用Cobra很简单。首先，使用go get安装最新版本\n1  go get -u github.com/spf13/cobra   然后在你项目里引用Cobra\n1  import \"github.com/spf13/cobra\"   开始 通常基于Cobra的应用程序将遵循下面的组织结构，当然你也可以遵循自己的接口：\n1 2 3 4 5 6 7  ▾ appName/ ▾ cmd/ add.go your.go commands.go here.go main.go   在Cobra应用程序中，通常main.go文件非常空洞。它主要只干一件事：初始化Cobra。\n1 2 3 4 5 6 7 8 9 10 11 12  package main import ( \"fmt\" \"os\" \"{pathToYourApp}/cmd\" ) func main() { cmd.Execute() }   使用Cobra库 使用Cobra，需要创建一个空的main.go文件和一个rootCmd文件。你可以选择在合适的地方添加额外的命令。\n命令 在 cobra 中，命令和子命令都是用Command结构表示的。Command有非常多的字段，用来定制命令的行为。在实际中，最常用的就那么几个。\nUse指定使用信息，即命令怎么被调用，格式为name arg1 [arg2]。name为命令名，后面的arg1为必填参数，arg3为可选参数，参数可以多个。\nShort/Long都是指定命令的帮助信息，只是前者简短，后者详尽而已。\nRun是实际执行操作的函数。\n定义新的子命令很简单，就是创建一个cobra.Command变量，设置一些字段，然后添加到根命令中。例如我们要添加一个clone子命令：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  package cmd import ( \"fmt\" \"os\" \"github.com/spf13/cobra\" ) var cloneCmd = \u0026cobra.Command { Use: \"clone url [destination]\", Short: \"Clone a repository into a new directory\", Run: func(cmd *cobra.Command, args []string) { output, err := ExecuteCommand(\"git\", \"clone\", args...) if err != nil { Error(cmd, args, err) } fmt.Fprintf(os.Stdout, output) }, } func init() { rootCmd.AddCommand(cloneCmd) }   其中Use字段clone url [destination]表示子命令名为clone，参数url是必须的，目标路径destination可选。\n我们将程序编译为mygit可执行文件，可以直接调用mygit命令了：\n1 2 3 4  $ go build -o mygit $ mv mygit $GOPATH/bin $ mygit clone https://github.com/darjun/leetcode Cloning into 'leetcode'...   创建rootCmd Cobra不需要特殊的构造函数。简单的就可以创建你的命令。\n理想情况下你把这个放在在 app/cmd/root.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  var rootCmd = \u0026cobra.Command{ Use: \"hugo\", Short: \"Hugo is a very fast static site generator\", Long: `A Fast and Flexible Static Site Generator built with love by spf13 and friends in Go. Complete documentation is available at http://hugo.spf13.com`, Run: func(cmd *cobra.Command, args []string) { // Do Stuff Here  }, } func Execute() { if err := rootCmd.Execute(); err != nil { fmt.Println(err) os.Exit(1) } }   你会另外定义选项和处理配置init()函数。\n比如 cmd/root.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  import ( \"fmt\" \"os\" homedir \"github.com/mitchellh/go-homedir\" \"github.com/spf13/cobra\" \"github.com/spf13/viper\" ) func init() { cobra.OnInitialize(initConfig) rootCmd.PersistentFlags().StringVar(\u0026cfgFile, \"config\", \"\", \"config file (default is $HOME/.cobra.yaml)\") rootCmd.PersistentFlags().StringVarP(\u0026projectBase, \"projectbase\", \"b\", \"\", \"base project directory eg. github.com/spf13/\") rootCmd.PersistentFlags().StringP(\"author\", \"a\", \"YOUR NAME\", \"Author name for copyright attribution\") rootCmd.PersistentFlags().StringVarP(\u0026userLicense, \"license\", \"l\", \"\", \"Name of license for the project (can provide `licensetext` in config)\") rootCmd.PersistentFlags().Bool(\"viper\", true, \"Use Viper for configuration\") viper.BindPFlag(\"author\", rootCmd.PersistentFlags().Lookup(\"author\")) viper.BindPFlag(\"projectbase\", rootCmd.PersistentFlags().Lookup(\"projectbase\")) viper.BindPFlag(\"useViper\", rootCmd.PersistentFlags().Lookup(\"viper\")) viper.SetDefault(\"author\", \"NAME HERE \") viper.SetDefault(\"license\", \"apache\") } func initConfig() { // Don't forget to read config either from cfgFile or from home directory!  if cfgFile != \"\" { // Use config file from the flag.  viper.SetConfigFile(cfgFile) } else { // Find home directory.  home, err := homedir.Dir() if err != nil { fmt.Println(err) os.Exit(1) } // Search config in home directory with name \".cobra\" (without extension).  viper.AddConfigPath(home) viper.SetConfigName(\".cobra\") } if err := viper.ReadInConfig(); err != nil { fmt.Println(\"Can't read config:\", err) os.Exit(1) } }   创建 main.go 你需要在main函数里执行root命令。\n通常main.go文件非常空洞。它主要只干一件事：初始化Cobra。\n1 2 3 4 5 6 7 8 9 10 11 12 13  package main import ( \"fmt\" \"os\" \"{pathToYourApp}/cmd\" ) func main() { cmd.Execute() }   创建其它的命令 其它的命令通常定义在cmd/目录下的自己文件内\n如果你想创建一个version命令，你可以创建cmd/version.go文件，并在文件里这么写:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  package cmd import ( \"fmt\" \"github.com/spf13/cobra\" ) func init() { rootCmd.AddCommand(versionCmd) } var versionCmd = \u0026cobra.Command{ Use: \"version\", Short: \"Print the version number of Hugo\", Long: `All software has versions. This is Hugo's`, Run: func(cmd *cobra.Command, args []string) { fmt.Println(\"Hugo Static Site Generator v0.9 -- HEAD\") }, }   使用选项 选项提供修饰符以控制操作命令的操作方式。\n选项 cobra 中选项分为两种，一种是永久选项，定义它的命令和其子命令都可以使用。通过给根命令添加一个选项定义全局选项。另一种是本地选项，只能在定义它的命令中使用。\ncobra 使用pflag解析命令行选项。pflag使用上基本与flag相同.\n与flag一样，存储选项的变量也需要提前定义好：\n1 2  var Verbose bool var Source string   设置永久选项：\n1  rootCmd.PersistentFlags().BoolVarP(\u0026Verbose, \"verbose\", \"v\", false, \"verbose output\")   设置本地选项：\n1  localCmd.Flags().StringVarP(\u0026Source, \"source\", \"s\", \"\", \"Source directory to read from\")   两种参数都是相同的，长选项/短选项名、默认值和帮助信息。\n给命令分配一个选项 由于这些选项是在不同的位置定义和使用的，因此我们需要在外部定义一个具有正确作用域的变量以分配要使用的选项。\n1 2  var Verbose bool var Source string   持久选项 ‘持久’表示每个在那个命令下的命令都将能分配到这个选项。对于全局选项，‘持久’的选项绑定在root上。\n1  rootCmd.PersistentFlags().BoolVarP(\u0026Verbose, \"verbose\", \"v\", false, \"verbose output\")   局部选项 默认情况下，Cobra仅解析目标命令上的本地选项，而忽略父命令上的任何本地选项。通过启用Command.TraverseChildren，Cobra将在执行目标命令之前解析每个命令上的本地选项。\n1 2 3 4  command := cobra.Command{ Use: \"print [OPTIONS] [COMMANDS]\", TraverseChildren: true, }   举例 下面，我们通过一个案例来演示选项的使用。\n假设我们要做一个简单的计算器，支持加、减、乘、除操作。并且可以通过选项设置是否忽略非数字参数，设置除 0 是否报错。显然，前一个选项应该放在全局选项中，后一个应该放在除法命令中。程序结构如下：\n1 2 3 4 5 6 7 8  ▾ math/ ▾ cmd/ add.go divide.go minus.go multiply.go root.go main.go   这里展示divide.go和root.go，其它命令文件都类似。\ndivide.go：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  var ( dividedByZeroHanding int // 除 0 如何处理 ) var divideCmd = \u0026cobra.Command { Use: \"divide\", Short: \"Divide subcommand divide all passed args.\", Run: func(cmd *cobra.Command, args []string) { values := ConvertArgsToFloat64Slice(args, ErrorHandling(parseHandling)) result := calc(values, DIVIDE) fmt.Printf(\"%s = %.2f\\n\", strings.Join(args, \"/\"), result) }, } func init() { divideCmd.Flags().IntVarP(\u0026dividedByZeroHanding, \"divide_by_zero\", \"d\", int(PanicOnDividedByZero), \"do what when divided by zero\") rootCmd.AddCommand(divideCmd) }   root.go：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  var ( parseHandling int ) var rootCmd = \u0026cobra.Command { Use: \"math\", Short: \"Math calc the accumulative result.\", Run: func(cmd *cobra.Command, args []string) { Error(cmd, args, errors.New(\"unrecognized subcommand\")) }, } func init() { rootCmd.PersistentFlags().IntVarP(\u0026parseHandling, \"parse_error\", \"p\", int(ContinueOnParseError), \"do what when parse arg error\") } func Execute() { rootCmd.Execute() }   在divide.go中定义了如何处理除 0 错误的选项，在root.go中定义了如何处理解析错误的选项。选项枚举如下：\n1 2 3 4 5 6 7  const ( ContinueOnParseError ErrorHandling = 1 // 解析错误尝试继续处理  ExitOnParseError ErrorHandling = 2 // 解析错误程序停止  PanicOnParseError ErrorHandling = 3 // 解析错误 panic  ReturnOnDividedByZero ErrorHandling = 4 // 除0返回  PanicOnDividedByZero ErrorHandling = 5 // 除0 painc )   其实命令的执行逻辑并不复杂，就是将参数转为float64。然后执行相应的运算，输出结果。\n使用配置绑定选项 你同样可以通过viper绑定选项：\n1 2 3 4 5 6  var author string func init() { rootCmd.PersistentFlags().StringVar(\u0026author, \"author\", \"YOUR NAME\", \"Author name for copyright attribution\") viper.BindPFlag(\"author\", rootCmd.PersistentFlags().Lookup(\"author\")) }   在这个例子中，持久的标记 author 被viper绑定, 注意, 当用户没有给–author提供值， author不会被赋值。\n必须的标记 标记默认是可选的，如果你希望当一个标记没有设置时，命令行报错，你可以标记它为必须的\n1 2  rootCmd.Flags().StringVarP(\u0026Region, \"region\", \"r\", \"\", \"AWS region (required)\") rootCmd.MarkFlagRequired(\"region\")   位置和自定义参数 验证位置参数可以通过* Command的Args字段。\n内置下列验证方法\n NoArgs - 如果有任何参数，命令行将会报错。 ArbitraryArgs - 命令行将会接收任何参数. OnlyValidArgs - 如果有如何参数不属于Command的ValidArgs字段，命令行将会报错。 MinimumNArgs(int) - 如果参数个数少于N个，命令行将会报错。 MaximumNArgs(int) - 如果参数个数多余N个，命令行将会报错。 ExactArgs(int) - 如果参数个数不能等于N个，命令行将会报错。 RangeArgs(min, max) - 如果参数个数不在min和max之间, 命令行将会报错.  一个设置自定义验证的例子\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  var cmd = \u0026cobra.Command{ Short: \"hello\", Args: func(cmd *cobra.Command, args []string) error { if len(args)  1 { return errors.New(\"requires at least one arg\") } if myapp.IsValidColor(args[0]) { return nil } return fmt.Errorf(\"invalid color specified: %s\", args[0]) }, Run: func(cmd *cobra.Command, args []string) { fmt.Println(\"Hello, World!\") }, }   例子 在下面的例子，我们定义了3个命令。2个在顶级，一个（cmdTimes）是其中一个顶级命令的子命令。在这个例子里，由于没有给rootCmd提供Run，单独的root是不能运行的，必须要有子命令。\n我们仅为一个命令定义了标记。\n更多关于flags的文档可以在https://github.com/spf13/pflag 找到\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54  package main import ( \"fmt\" \"strings\" \"github.com/spf13/cobra\" ) func main() { var echoTimes int var cmdPrint = \u0026cobra.Command{ Use: \"print [string to print]\", Short: \"Print anything to the screen\", Long: `print is for printing anything back to the screen. For many years people have printed back to the screen.`, Args: cobra.MinimumNArgs(1), Run: func(cmd *cobra.Command, args []string) { fmt.Println(\"Print: \" + strings.Join(args, \" \")) }, } var cmdEcho = \u0026cobra.Command{ Use: \"echo [string to echo]\", Short: \"Echo anything to the screen\", Long: `echo is for echoing anything back. Echo works a lot like print, except it has a child command.`, Args: cobra.MinimumNArgs(1), Run: func(cmd *cobra.Command, args []string) { fmt.Println(\"Print: \" + strings.Join(args, \" \")) }, } var cmdTimes = \u0026cobra.Command{ Use: \"times [# times] [string to echo]\", Short: \"Echo anything to the screen more times\", Long: `echo things multiple times back to the user by providing a count and a string.`, Args: cobra.MinimumNArgs(1), Run: func(cmd *cobra.Command, args []string) { for i := 0; i  echoTimes; i++ { fmt.Println(\"Echo: \" + strings.Join(args, \" \")) } }, } cmdTimes.Flags().IntVarP(\u0026echoTimes, \"times\", \"t\", 1, \"times to echo the input\") var rootCmd = \u0026cobra.Command{Use: \"app\"} rootCmd.AddCommand(cmdPrint, cmdEcho) cmdEcho.AddCommand(cmdTimes) rootCmd.Execute() }   更完整大型程序的例子, 可以查看 Hugo.\nhelp命令 当你的程序有子命令时，Cobra 会自动给你程序添加help命令。当你运行‘app help’，会调用help命令。另外，help同样支持其它输入命令。例如，你有一个没有任何其它配置的命令叫‘create’，当你调用‘app help create’ Corbra 将会起作用。\n例子 下面的输入是 Cobra 自动生成的。除了命令和选项的定义，其它不再需要。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  $ cobra help Cobra is a CLI library for Go that empowers applications. This application is a tool to generate the needed files to quickly create a Cobra application. Usage: cobra [command] Available Commands: add Add a command to a Cobra Application help Help about any command init Initialize a Cobra Application Flags: -a, --author string author name for copyright attribution (default \"YOUR NAME\") --config string config file (default is $HOME/.cobra.yaml) -h, --help help for cobra -l, --license string name of license for the project --viper use Viper for configuration (default true) Use \"cobra [command] --help\" for more information about a command.   help就像其他命令一样。没有特殊的逻辑或行为。实际上，您可以根据需要提供自己的文件。\n定义自己的help 你能为默认的命令，提供你自己的help命令或模板。使用下面的方法:\n1 2 3  cmd.SetHelpCommand(cmd *Command) cmd.SetHelpFunc(f func(*Command, []string)) cmd.SetHelpTemplate(s string)   后2个也将适用于任何子命令\n使用信息 当用户提供无效的标记或命令，Cobra 将会返回用法。\n例子 你可能从上面的帮助意识到，默认的帮助将被嵌入到用法里然后作为输出。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  $ cobra --invalid Error: unknown flag: --invalid Usage: cobra [command] Available Commands: add Add a command to a Cobra Application help Help about any command init Initialize a Cobra Application Flags: -a, --author string author name for copyright attribution (default \"YOUR NAME\") --config string config file (default is $HOME/.cobra.yaml) -h, --help help for cobra -l, --license string name of license for the project --viper use Viper for configuration (default true) Use \"cobra [command] --help\" for more information about a command.   定义自己的用法 你能提供你自己的用法函数或模板给 Cobra 使用。 比如帮助，方法和模板都可以重写。\n1 2  cmd.SetUsageFunc(f func(*Command) error) cmd.SetUsageTemplate(s string)   版本标记 如果Version字段设置到了根命令，Cobra 会提供了一个顶层 ‘–version’标记。运行带上‘–version’标记的程序，将会按照模板版本信息。模板可以通过cmd.SetVersionTemplate(s string)方法修改\n运行前和运行后钩子 在命令运行前或运行后，再运行方法非常容易。PersistentPreRun和PreRun方法将会在Run之前执行。PersistentPostRun和PostRun方法将会在Run之后执行。Persistent*Run方法会被子命令继承，如果它们自己没有定义的话。这些方法将按照下面的属性执行：\n PersistentPreRun PreRun Run PostRun PersistentPostRun  下面的例子，2个命令都使用了上面的特性。当子命令执行的时候，它将执行根命令的PersistentPreRun，但不会执行根命令的PersistentPostRun：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55  package main import ( \"fmt\" \"github.com/spf13/cobra\" ) func main() { var rootCmd = \u0026cobra.Command{ Use: \"root [sub]\", Short: \"My root command\", PersistentPreRun: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside rootCmd PersistentPreRun with args: %v\\n\", args) }, PreRun: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside rootCmd PreRun with args: %v\\n\", args) }, Run: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside rootCmd Run with args: %v\\n\", args) }, PostRun: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside rootCmd PostRun with args: %v\\n\", args) }, PersistentPostRun: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside rootCmd PersistentPostRun with args: %v\\n\", args) }, } var subCmd = \u0026cobra.Command{ Use: \"sub [no options!]\", Short: \"My subcommand\", PreRun: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside subCmd PreRun with args: %v\\n\", args) }, Run: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside subCmd Run with args: %v\\n\", args) }, PostRun: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside subCmd PostRun with args: %v\\n\", args) }, PersistentPostRun: func(cmd *cobra.Command, args []string) { fmt.Printf(\"Inside subCmd PersistentPostRun with args: %v\\n\", args) }, } rootCmd.AddCommand(subCmd) rootCmd.SetArgs([]string{\"\"}) rootCmd.Execute() fmt.Println() rootCmd.SetArgs([]string{\"sub\", \"arg1\", \"arg2\"}) rootCmd.Execute() }   输出:\n1 2 3 4 5 6 7 8 9 10 11  Inside rootCmd PersistentPreRun with args: [] Inside rootCmd PreRun with args: [] Inside rootCmd Run with args: [] Inside rootCmd PostRun with args: [] Inside rootCmd PersistentPostRun with args: [] Inside rootCmd PersistentPreRun with args: [arg1 arg2] Inside subCmd PreRun with args: [arg1 arg2] Inside subCmd Run with args: [arg1 arg2] Inside subCmd PostRun with args: [arg1 arg2] Inside subCmd PersistentPostRun with args: [arg1 arg2]   处理“未知命令”的建议 Cobra 会自动输出建议，当遇到“unknown command”错误时。这使得当输入错误时， Cobra 的行为类似git命令。例如：\n1 2 3 4 5 6 7  $ hugo srever Error: unknown command \"srever\" for \"hugo\" Did you mean this? server Run 'hugo --help' for usage.   建议会基于注册的子命令自动生成。使用了Levenshtein distance的实现。每一个注册的命令会匹配2个距离（忽略大小写）来提供建议。\n如果你希望在你的命令里，禁用建议或虚弱字符串的距离，使用：\n1  command.DisableSuggestions = true   或\n1  command.SuggestionsMinimumDistance = 1   你可以通过SuggestFor来给命令提供明确的名词建议。这个特性允许当字符串不相近，但是意思与你的命令相近，别切你也不想给该命令设置别名。比如：\n1 2 3 4 5 6 7  $ kubectl remove Error: unknown command \"remove\" for \"kubectl\" Did you mean this? delete Run 'kubectl help' for usage.   生成命令的文档 Cobra 可以基于子命令，标记，等生成文档。以以下格式：\n1 2 3  Markdown ReStructured Text Man Page   生成bash-completion Cobra 可以生成一个bash-completion文件。如果你给命令添加更多信息，这些completions可以非常强大和灵活。更多介绍在Bash Completions。\nCobra生成器 Cobra提供自己的程序来创建你的程序并且添加你想要的命令。这是最简单的方式把Cobra添加到你的程序里。\n这里你能找到相关信息\n通过前面的介绍，我们也看到了其实 cobra 命令的框架还是比较固定的。这就有了工具的用武之地了，可极大地提高我们的开发效率。\n前面安装 cobra 库的时候也将脚手架程序安装好了。下面我们介绍如何使用这个生成器。\n使用cobra init命令创建一个 cobra 应用程序：\n1  cobra init scaffold --pkg-name github.com/darjun/go-daily-lib/cobra/scaffold   其中scaffold为应用程序名，后面通过pkg-name选项指定包路径。生成的程序目录结构如下：\n1 2 3 4 5  ▾ scaffold/ ▾ cmd/ root.go LICENSE main.go   这个项目结构与之前介绍的完全相同，也是 cobra 推荐使用的结构。同样地，main.go也仅仅是入口。\n在root.go中，工具额外帮我们生成了一些代码。\n在根命令中添加了配置文件选项，大部分应用程序都需要配置文件：\n1 2 3 4 5 6  func init() { cobra.OnInitialize(initConfig) rootCmd.PersistentFlags().StringVar(\u0026cfgFile, \"config\", \"\", \"config file (default is $HOME/.scaffold.yaml)\") rootCmd.Flags().BoolP(\"toggle\", \"t\", false, \"Help message for toggle\") }   在初始化完成的回调中，如果发现该选项为空，则默认使用主目录下的.scaffold.yaml文件：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  func initConfig() { if cfgFile != \"\" { viper.SetConfigFile(cfgFile) } else { home, err := homedir.Dir() if err != nil { fmt.Println(err) os.Exit(1) } viper.AddConfigPath(home) viper.SetConfigName(\".scaffold\") } viper.AutomaticEnv() if err := viper.ReadInConfig(); err == nil { fmt.Println(\"Using config file:\", viper.ConfigFileUsed()) } }   除了代码文件，cobra 还生成了一个 LICENSE 文件。\n现在这个程序还不能做任何事情，我们需要给它添加子命令，使用cobra add命令：\n1  cobra add date   该命令在cmd目录下新增了date.go文件。基本结构已经搭好了，剩下的就是修改一些描述，添加一些选项了。\n我们现在实现这样一个功能，根据传入的年、月，打印这个月的日历。如果没有传入选项，使用当前的年、月。\n选项定义：\n1 2 3 4 5 6  func init() { rootCmd.AddCommand(dateCmd) dateCmd.PersistentFlags().IntVarP(\u0026year, \"year\", \"y\", 0, \"year to show (should in [1000, 9999]\") dateCmd.PersistentFlags().IntVarP(\u0026month, \"month\", \"m\", 0, \"month to show (should in [1, 12]\") }   修改dateCmd的Run函数：\n1 2 3 4 5 6 7 8 9 10 11 12 13  Run: func(cmd *cobra.Command, args []string) { if year  1000 \u0026\u0026 year  9999 { fmt.Fprintln(os.Stderr, \"invalid year should in [1000, 9999], actual:%d\", year) os.Exit(1) } if month  1 \u0026\u0026 year  12 { fmt.Fprintln(os.Stderr, \"invalid month should in [1, 12], actual:%d\", month) os.Exit(1) } showCalendar() }   showCalendar函数就是利用time提供的方法实现的，这里就不赘述了。\n",
  "wordCount" : "6373",
  "inLanguage": "zh-cn",
  "datePublished": "2020-06-23T22:08:13Z",
  "dateModified": "2020-06-23T22:08:13Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/go%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BA%93cobra%E7%9A%84%E4%BD%BF%E7%94%A8/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Go命令行库Cobra的使用
    </h1>
    <div class="post-meta">June 23, 2020
</div>
  </header> 
  <div class="post-content"><p>Cobra提供简单的接口来创建强大的现代化CLI接口，比如git与go工具。Cobra同时也是一个程序, 用于创建CLI程序</p>
<h1 id="功能">功能<a hidden class="anchor" aria-hidden="true" href="#功能">#</a></h1>
<ul>
<li>简易的子命令行模式，如 app server， app fetch等等</li>
<li>完全兼容posix命令行模式</li>
<li>嵌套子命令subcommand</li>
<li>支持全局，局部，串联flags</li>
<li>使用Cobra很容易的生成应用程序和命令，使用cobra create appname和cobra add cmdname</li>
<li>如果命令输入错误，将提供智能建议，如 app srver，将提示srver没有，是否是app server</li>
<li>自动生成commands和flags的帮助信息</li>
<li>自动生成详细的help信息，如app help</li>
<li>自动识别-h，&ndash;help帮助flag</li>
<li>自动生成应用程序在bash下命令自动完成功能</li>
<li>自动生成应用程序的man手册</li>
<li>命令行别名</li>
<li>零活定义help和usage信息</li>
<li>可选的紧密集成的viper apps</li>
</ul>
<h1 id="概念">概念<a hidden class="anchor" aria-hidden="true" href="#概念">#</a></h1>
<p>Cobra是建立在结构的命令、参数和选项之上。</p>
<p>cobra 中有个重要的概念，分别是 commands、arguments 和 flags。其中 commands 代表行为，arguments 就是命令行参数(或者称为位置参数)，flags 代表对行为的改变(也就是我们常说的命令行选项)。执行命令行程序时的一般格式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">APPNAME COMMAND ARG --FLAG
</code></pre></td></tr></table>
</div>
</div><p>比如下面的例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="c1"># server是 commands，port 是 flag</span>
<span class="n">hugo</span> <span class="n">server</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="m">1313</span>

<span class="c1"># clone 是 commands，URL 是 arguments，brae 是 flag</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">URL</span> <span class="o">--</span><span class="n">bare</span>
</code></pre></td></tr></table>
</div>
</div><p>如果是一个简单的程序(功能单一的程序)，使用 commands 的方式可能会很啰嗦，但是像 git、docker 等应用，把这些本就很复杂的功能划分为子命令的形式，会方便使用(对程序的设计者来说又何尝不是如此)。</p>
<h1 id="安装">安装<a hidden class="anchor" aria-hidden="true" href="#安装">#</a></h1>
<p>使用Cobra很简单。首先，使用go get安装最新版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="k">go</span> <span class="nx">get</span> <span class="o">-</span><span class="nx">u</span> <span class="nx">github</span><span class="p">.</span><span class="nx">com</span><span class="o">/</span><span class="nx">spf13</span><span class="o">/</span><span class="nx">cobra</span>
</code></pre></td></tr></table>
</div>
</div><p>然后在你项目里引用Cobra</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="s">&#34;github.com/spf13/cobra&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="开始">开始<a hidden class="anchor" aria-hidden="true" href="#开始">#</a></h1>
<p>通常基于Cobra的应用程序将遵循下面的组织结构，当然你也可以遵循自己的接口：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">  ▾ appName/
    ▾ cmd/
        add.go
        your.go
        commands.go
        here.go
      main.go
</code></pre></td></tr></table>
</div>
</div><p>在Cobra应用程序中，通常main.go文件非常空洞。它主要只干一件事：初始化Cobra。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>
  <span class="s">&#34;os&#34;</span>

  <span class="s">&#34;{pathToYourApp}/cmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">cmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="使用cobra库">使用Cobra库<a hidden class="anchor" aria-hidden="true" href="#使用cobra库">#</a></h2>
<p>使用Cobra，需要创建一个空的main.go文件和一个rootCmd文件。你可以选择在合适的地方添加额外的命令。</p>
<h3 id="命令">命令<a hidden class="anchor" aria-hidden="true" href="#命令">#</a></h3>
<p>在 cobra 中，命令和子命令都是用Command结构表示的。Command有非常多的字段，用来定制命令的行为。在实际中，最常用的就那么几个。</p>
<p>Use指定使用信息，即命令怎么被调用，格式为<code>name arg1 [arg2]</code>。name为命令名，后面的arg1为必填参数，arg3为可选参数，参数可以多个。</p>
<p>Short/Long都是指定命令的帮助信息，只是前者简短，后者详尽而已。</p>
<p>Run是实际执行操作的函数。</p>
<p>定义新的子命令很简单，就是创建一个cobra.Command变量，设置一些字段，然后添加到根命令中。例如我们要添加一个clone子命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">cmd</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>
  <span class="s">&#34;os&#34;</span>

  <span class="s">&#34;github.com/spf13/cobra&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">cloneCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span> <span class="p">{</span>
  <span class="nx">Use</span><span class="p">:</span> <span class="s">&#34;clone url [destination]&#34;</span><span class="p">,</span>
  <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Clone a repository into a new directory&#34;</span><span class="p">,</span>
  <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">output</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">ExecuteCommand</span><span class="p">(</span><span class="s">&#34;git&#34;</span><span class="p">,</span> <span class="s">&#34;clone&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="o">...</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nf">Error</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdout</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span>
  <span class="p">},</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">AddCommand</span><span class="p">(</span><span class="nx">cloneCmd</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>其中Use字段<code>clone url [destination]</code>表示子命令名为clone，参数url是必须的，目标路径destination可选。</p>
<p>我们将程序编译为mygit可执行文件，可以直接调用mygit命令了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="o">$</span> <span class="n">go</span> <span class="n">build</span> <span class="o">-</span><span class="n">o</span> <span class="n">mygit</span>
<span class="o">$</span> <span class="n">mv</span> <span class="n">mygit</span> <span class="o">$</span><span class="n">GOPATH</span><span class="o">/</span><span class="n">bin</span>
<span class="o">$</span> <span class="n">mygit</span> <span class="n">clone</span> <span class="n">https</span><span class="o">://</span><span class="n">github.com</span><span class="o">/</span><span class="n">darjun</span><span class="o">/</span><span class="n">leetcode</span>
<span class="n">Cloning</span> <span class="n">into</span> <span class="s">&#39;leetcode&#39;</span><span class="kc">...</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="创建rootcmd">创建rootCmd<a hidden class="anchor" aria-hidden="true" href="#创建rootcmd">#</a></h3>
<p>Cobra不需要特殊的构造函数。简单的就可以创建你的命令。</p>
<p>理想情况下你把这个放在在 app/cmd/root.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">rootCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
  <span class="nx">Use</span><span class="p">:</span>   <span class="s">&#34;hugo&#34;</span><span class="p">,</span>
  <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Hugo is a very fast static site generator&#34;</span><span class="p">,</span>
  <span class="nx">Long</span><span class="p">:</span> <span class="s">`A Fast and Flexible Static Site Generator built with
</span><span class="s">                love by spf13 and friends in Go.
</span><span class="s">                Complete documentation is available at http://hugo.spf13.com`</span><span class="p">,</span>
  <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Do Stuff Here
</span><span class="c1"></span>  <span class="p">},</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Execute</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>你会另外定义选项和处理配置init()函数。</p>
<p>比如 cmd/root.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>
  <span class="s">&#34;os&#34;</span>

  <span class="nx">homedir</span> <span class="s">&#34;github.com/mitchellh/go-homedir&#34;</span>
  <span class="s">&#34;github.com/spf13/cobra&#34;</span>
  <span class="s">&#34;github.com/spf13/viper&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">cobra</span><span class="p">.</span><span class="nf">OnInitialize</span><span class="p">(</span><span class="nx">initConfig</span><span class="p">)</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfgFile</span><span class="p">,</span> <span class="s">&#34;config&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;config file (default is $HOME/.cobra.yaml)&#34;</span><span class="p">)</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">StringVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">projectBase</span><span class="p">,</span> <span class="s">&#34;projectbase&#34;</span><span class="p">,</span> <span class="s">&#34;b&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;base project directory eg. github.com/spf13/&#34;</span><span class="p">)</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">StringP</span><span class="p">(</span><span class="s">&#34;author&#34;</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="s">&#34;YOUR NAME&#34;</span><span class="p">,</span> <span class="s">&#34;Author name for copyright attribution&#34;</span><span class="p">)</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">StringVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">userLicense</span><span class="p">,</span> <span class="s">&#34;license&#34;</span><span class="p">,</span> <span class="s">&#34;l&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Name of license for the project (can provide `licensetext` in config)&#34;</span><span class="p">)</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">Bool</span><span class="p">(</span><span class="s">&#34;viper&#34;</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="s">&#34;Use Viper for configuration&#34;</span><span class="p">)</span>
  <span class="nx">viper</span><span class="p">.</span><span class="nf">BindPFlag</span><span class="p">(</span><span class="s">&#34;author&#34;</span><span class="p">,</span> <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;author&#34;</span><span class="p">))</span>
  <span class="nx">viper</span><span class="p">.</span><span class="nf">BindPFlag</span><span class="p">(</span><span class="s">&#34;projectbase&#34;</span><span class="p">,</span> <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;projectbase&#34;</span><span class="p">))</span>
  <span class="nx">viper</span><span class="p">.</span><span class="nf">BindPFlag</span><span class="p">(</span><span class="s">&#34;useViper&#34;</span><span class="p">,</span> <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;viper&#34;</span><span class="p">))</span>
  <span class="nx">viper</span><span class="p">.</span><span class="nf">SetDefault</span><span class="p">(</span><span class="s">&#34;author&#34;</span><span class="p">,</span> <span class="s">&#34;NAME HERE &lt;EMAIL ADDRESS&gt;&#34;</span><span class="p">)</span>
  <span class="nx">viper</span><span class="p">.</span><span class="nf">SetDefault</span><span class="p">(</span><span class="s">&#34;license&#34;</span><span class="p">,</span> <span class="s">&#34;apache&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">initConfig</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Don&#39;t forget to read config either from cfgFile or from home directory!
</span><span class="c1"></span>  <span class="k">if</span> <span class="nx">cfgFile</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="c1">// Use config file from the flag.
</span><span class="c1"></span>    <span class="nx">viper</span><span class="p">.</span><span class="nf">SetConfigFile</span><span class="p">(</span><span class="nx">cfgFile</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Find home directory.
</span><span class="c1"></span>    <span class="nx">home</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">homedir</span><span class="p">.</span><span class="nf">Dir</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Search config in home directory with name &#34;.cobra&#34; (without extension).
</span><span class="c1"></span>    <span class="nx">viper</span><span class="p">.</span><span class="nf">AddConfigPath</span><span class="p">(</span><span class="nx">home</span><span class="p">)</span>
    <span class="nx">viper</span><span class="p">.</span><span class="nf">SetConfigName</span><span class="p">(</span><span class="s">&#34;.cobra&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">viper</span><span class="p">.</span><span class="nf">ReadInConfig</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Can&#39;t read config:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="创建-maingo">创建 main.go<a hidden class="anchor" aria-hidden="true" href="#创建-maingo">#</a></h3>
<p>你需要在main函数里执行root命令。</p>
<p>通常main.go文件非常空洞。它主要只干一件事：初始化Cobra。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>


<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>
  <span class="s">&#34;os&#34;</span>

  <span class="s">&#34;{pathToYourApp}/cmd&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">cmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="创建其它的命令">创建其它的命令<a hidden class="anchor" aria-hidden="true" href="#创建其它的命令">#</a></h3>
<p>其它的命令通常定义在cmd/目录下的自己文件内</p>
<p>如果你想创建一个version命令，你可以创建cmd/version.go文件，并在文件里这么写:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">cmd</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>

  <span class="s">&#34;github.com/spf13/cobra&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">AddCommand</span><span class="p">(</span><span class="nx">versionCmd</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">versionCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
  <span class="nx">Use</span><span class="p">:</span>   <span class="s">&#34;version&#34;</span><span class="p">,</span>
  <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Print the version number of Hugo&#34;</span><span class="p">,</span>
  <span class="nx">Long</span><span class="p">:</span>  <span class="s">`All software has versions. This is Hugo&#39;s`</span><span class="p">,</span>
  <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hugo Static Site Generator v0.9 -- HEAD&#34;</span><span class="p">)</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="使用选项">使用选项<a hidden class="anchor" aria-hidden="true" href="#使用选项">#</a></h2>
<p>选项提供修饰符以控制操作命令的操作方式。</p>
<h3 id="选项">选项<a hidden class="anchor" aria-hidden="true" href="#选项">#</a></h3>
<p>cobra 中选项分为两种，一种是永久选项，定义它的命令和其子命令都可以使用。通过给根命令添加一个选项定义全局选项。另一种是本地选项，只能在定义它的命令中使用。</p>
<p>cobra 使用pflag解析命令行选项。pflag使用上基本与flag相同.</p>
<p>与flag一样，存储选项的变量也需要提前定义好：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">Verbose</span> <span class="kt">bool</span>
<span class="kd">var</span> <span class="nx">Source</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><p>设置永久选项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">BoolVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Verbose</span><span class="p">,</span> <span class="s">&#34;verbose&#34;</span><span class="p">,</span> <span class="s">&#34;v&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;verbose output&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>设置本地选项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">localCmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">StringVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Source</span><span class="p">,</span> <span class="s">&#34;source&#34;</span><span class="p">,</span> <span class="s">&#34;s&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Source directory to read from&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>两种参数都是相同的，长选项/短选项名、默认值和帮助信息。</p>
<h3 id="给命令分配一个选项">给命令分配一个选项<a hidden class="anchor" aria-hidden="true" href="#给命令分配一个选项">#</a></h3>
<p>由于这些选项是在不同的位置定义和使用的，因此我们需要在外部定义一个具有正确作用域的变量以分配要使用的选项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">Verbose</span> <span class="kt">bool</span>
<span class="kd">var</span> <span class="nx">Source</span> <span class="kt">string</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="持久选项">持久选项<a hidden class="anchor" aria-hidden="true" href="#持久选项">#</a></h3>
<p>&lsquo;持久&rsquo;表示每个在那个命令下的命令都将能分配到这个选项。对于全局选项，&lsquo;持久&rsquo;的选项绑定在root上。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">BoolVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Verbose</span><span class="p">,</span> <span class="s">&#34;verbose&#34;</span><span class="p">,</span> <span class="s">&#34;v&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;verbose output&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="局部选项">局部选项<a hidden class="anchor" aria-hidden="true" href="#局部选项">#</a></h3>
<p>默认情况下，Cobra仅解析目标命令上的本地选项，而忽略父命令上的任何本地选项。通过启用Command.TraverseChildren，Cobra将在执行目标命令之前解析每个命令上的本地选项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">command</span> <span class="o">:=</span> <span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
  <span class="nx">Use</span><span class="p">:</span> <span class="s">&#34;print [OPTIONS] [COMMANDS]&#34;</span><span class="p">,</span>
  <span class="nx">TraverseChildren</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="举例">举例<a hidden class="anchor" aria-hidden="true" href="#举例">#</a></h3>
<p>下面，我们通过一个案例来演示选项的使用。</p>
<p>假设我们要做一个简单的计算器，支持加、减、乘、除操作。并且可以通过选项设置是否忽略非数字参数，设置除 0 是否报错。显然，前一个选项应该放在全局选项中，后一个应该放在除法命令中。程序结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">▾ math/
    ▾ cmd/
        add.go
        divide.go
        minus.go
        multiply.go
        root.go
    main.go
</code></pre></td></tr></table>
</div>
</div><p>这里展示divide.go和root.go，其它命令文件都类似。</p>
<p>divide.go：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
  <span class="nx">dividedByZeroHanding</span> <span class="kt">int</span> <span class="c1">// 除 0 如何处理
</span><span class="c1"></span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">divideCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span> <span class="p">{</span>
  <span class="nx">Use</span><span class="p">:</span> <span class="s">&#34;divide&#34;</span><span class="p">,</span>
  <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Divide subcommand divide all passed args.&#34;</span><span class="p">,</span>
  <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">values</span> <span class="o">:=</span> <span class="nf">ConvertArgsToFloat64Slice</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nf">ErrorHandling</span><span class="p">(</span><span class="nx">parseHandling</span><span class="p">))</span>
    <span class="nx">result</span> <span class="o">:=</span> <span class="nf">calc</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">DIVIDE</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s = %.2f\n&#34;</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">),</span> <span class="nx">result</span><span class="p">)</span>
  <span class="p">},</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">divideCmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">IntVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">dividedByZeroHanding</span><span class="p">,</span> <span class="s">&#34;divide_by_zero&#34;</span><span class="p">,</span> <span class="s">&#34;d&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">PanicOnDividedByZero</span><span class="p">),</span> <span class="s">&#34;do what when divided by zero&#34;</span><span class="p">)</span>

  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">AddCommand</span><span class="p">(</span><span class="nx">divideCmd</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>root.go：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="p">(</span>
  <span class="nx">parseHandling</span> <span class="kt">int</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">rootCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span> <span class="p">{</span>
  <span class="nx">Use</span><span class="p">:</span> <span class="s">&#34;math&#34;</span><span class="p">,</span>
  <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Math calc the accumulative result.&#34;</span><span class="p">,</span>
  <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">Error</span><span class="p">(</span><span class="nx">cmd</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;unrecognized subcommand&#34;</span><span class="p">))</span>
  <span class="p">},</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">IntVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">parseHandling</span><span class="p">,</span> <span class="s">&#34;parse_error&#34;</span><span class="p">,</span> <span class="s">&#34;p&#34;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">ContinueOnParseError</span><span class="p">),</span> <span class="s">&#34;do what when parse arg error&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">Execute</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在divide.go中定义了如何处理除 0 错误的选项，在root.go中定义了如何处理解析错误的选项。选项枚举如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="p">(</span>
  <span class="nx">ContinueOnParseError</span>  <span class="nx">ErrorHandling</span> <span class="p">=</span> <span class="mi">1</span> <span class="c1">// 解析错误尝试继续处理
</span><span class="c1"></span>  <span class="nx">ExitOnParseError</span>      <span class="nx">ErrorHandling</span> <span class="p">=</span> <span class="mi">2</span> <span class="c1">// 解析错误程序停止
</span><span class="c1"></span>  <span class="nx">PanicOnParseError</span>     <span class="nx">ErrorHandling</span> <span class="p">=</span> <span class="mi">3</span> <span class="c1">// 解析错误 panic
</span><span class="c1"></span>  <span class="nx">ReturnOnDividedByZero</span> <span class="nx">ErrorHandling</span> <span class="p">=</span> <span class="mi">4</span> <span class="c1">// 除0返回
</span><span class="c1"></span>  <span class="nx">PanicOnDividedByZero</span>  <span class="nx">ErrorHandling</span> <span class="p">=</span> <span class="mi">5</span> <span class="c1">// 除0 painc
</span><span class="c1"></span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>其实命令的执行逻辑并不复杂，就是将参数转为float64。然后执行相应的运算，输出结果。</p>
<h2 id="使用配置绑定选项">使用配置绑定选项<a hidden class="anchor" aria-hidden="true" href="#使用配置绑定选项">#</a></h2>
<p>你同样可以通过viper绑定选项：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">author</span> <span class="kt">string</span>

<span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">author</span><span class="p">,</span> <span class="s">&#34;author&#34;</span><span class="p">,</span> <span class="s">&#34;YOUR NAME&#34;</span><span class="p">,</span> <span class="s">&#34;Author name for copyright attribution&#34;</span><span class="p">)</span>
  <span class="nx">viper</span><span class="p">.</span><span class="nf">BindPFlag</span><span class="p">(</span><span class="s">&#34;author&#34;</span><span class="p">,</span> <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">Lookup</span><span class="p">(</span><span class="s">&#34;author&#34;</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在这个例子中，持久的标记 author 被viper绑定, 注意, 当用户没有给&ndash;author提供值， author不会被赋值。</p>
<h2 id="必须的标记">必须的标记<a hidden class="anchor" aria-hidden="true" href="#必须的标记">#</a></h2>
<p>标记默认是可选的，如果你希望当一个标记没有设置时，命令行报错，你可以标记它为必须的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">rootCmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">StringVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Region</span><span class="p">,</span> <span class="s">&#34;region&#34;</span><span class="p">,</span> <span class="s">&#34;r&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;AWS region (required)&#34;</span><span class="p">)</span>
<span class="nx">rootCmd</span><span class="p">.</span><span class="nf">MarkFlagRequired</span><span class="p">(</span><span class="s">&#34;region&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="位置和自定义参数">位置和自定义参数<a hidden class="anchor" aria-hidden="true" href="#位置和自定义参数">#</a></h2>
<p>验证位置参数可以通过* Command的Args字段。</p>
<p>内置下列验证方法</p>
<ul>
<li>NoArgs - 如果有任何参数，命令行将会报错。</li>
<li>ArbitraryArgs - 命令行将会接收任何参数.</li>
<li>OnlyValidArgs - 如果有如何参数不属于Command的ValidArgs字段，命令行将会报错。</li>
<li>MinimumNArgs(int) - 如果参数个数少于N个，命令行将会报错。</li>
<li>MaximumNArgs(int) - 如果参数个数多余N个，命令行将会报错。</li>
<li>ExactArgs(int) - 如果参数个数不能等于N个，命令行将会报错。</li>
<li>RangeArgs(min, max) - 如果参数个数不在min和max之间, 命令行将会报错.</li>
</ul>
<p>一个设置自定义验证的例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">cmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
  <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;hello&#34;</span><span class="p">,</span>
  <span class="nx">Args</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;requires at least one arg&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">myapp</span><span class="p">.</span><span class="nf">IsValidColor</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid color specified: %s&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="p">},</span>
  <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Hello, World!&#34;</span><span class="p">)</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="例子">例子<a hidden class="anchor" aria-hidden="true" href="#例子">#</a></h2>
<p>在下面的例子，我们定义了3个命令。2个在顶级，一个（cmdTimes）是其中一个顶级命令的子命令。在这个例子里，由于没有给rootCmd提供Run，单独的root是不能运行的，必须要有子命令。</p>
<p>我们仅为一个命令定义了标记。</p>
<p>更多关于flags的文档可以在<code>https://github.com/spf13/pflag</code> 找到</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>
  <span class="s">&#34;strings&#34;</span>

  <span class="s">&#34;github.com/spf13/cobra&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">echoTimes</span> <span class="kt">int</span>

  <span class="kd">var</span> <span class="nx">cmdPrint</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
    <span class="nx">Use</span><span class="p">:</span>   <span class="s">&#34;print [string to print]&#34;</span><span class="p">,</span>
    <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Print anything to the screen&#34;</span><span class="p">,</span>
    <span class="nx">Long</span><span class="p">:</span> <span class="s">`print is for printing anything back to the screen.
</span><span class="s">For many years people have printed back to the screen.`</span><span class="p">,</span>
    <span class="nx">Args</span><span class="p">:</span> <span class="nx">cobra</span><span class="p">.</span><span class="nf">MinimumNArgs</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Print: &#34;</span> <span class="o">+</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">))</span>
    <span class="p">},</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">cmdEcho</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
    <span class="nx">Use</span><span class="p">:</span>   <span class="s">&#34;echo [string to echo]&#34;</span><span class="p">,</span>
    <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Echo anything to the screen&#34;</span><span class="p">,</span>
    <span class="nx">Long</span><span class="p">:</span> <span class="s">`echo is for echoing anything back.
</span><span class="s">Echo works a lot like print, except it has a child command.`</span><span class="p">,</span>
    <span class="nx">Args</span><span class="p">:</span> <span class="nx">cobra</span><span class="p">.</span><span class="nf">MinimumNArgs</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Print: &#34;</span> <span class="o">+</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">))</span>
    <span class="p">},</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">cmdTimes</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
    <span class="nx">Use</span><span class="p">:</span>   <span class="s">&#34;times [# times] [string to echo]&#34;</span><span class="p">,</span>
    <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;Echo anything to the screen more times&#34;</span><span class="p">,</span>
    <span class="nx">Long</span><span class="p">:</span> <span class="s">`echo things multiple times back to the user by providing
</span><span class="s">a count and a string.`</span><span class="p">,</span>
    <span class="nx">Args</span><span class="p">:</span> <span class="nx">cobra</span><span class="p">.</span><span class="nf">MinimumNArgs</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
    <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">echoTimes</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Echo: &#34;</span> <span class="o">+</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">))</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">}</span>

  <span class="nx">cmdTimes</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">IntVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">echoTimes</span><span class="p">,</span> <span class="s">&#34;times&#34;</span><span class="p">,</span> <span class="s">&#34;t&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#34;times to echo the input&#34;</span><span class="p">)</span>

  <span class="kd">var</span> <span class="nx">rootCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Use</span><span class="p">:</span> <span class="s">&#34;app&#34;</span><span class="p">}</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">AddCommand</span><span class="p">(</span><span class="nx">cmdPrint</span><span class="p">,</span> <span class="nx">cmdEcho</span><span class="p">)</span>
  <span class="nx">cmdEcho</span><span class="p">.</span><span class="nf">AddCommand</span><span class="p">(</span><span class="nx">cmdTimes</span><span class="p">)</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>更完整大型程序的例子, 可以查看 Hugo.</p>
<h2 id="help命令">help命令<a hidden class="anchor" aria-hidden="true" href="#help命令">#</a></h2>
<p>当你的程序有子命令时，Cobra 会自动给你程序添加help命令。当你运行‘app help’，会调用help命令。另外，help同样支持其它输入命令。例如，你有一个没有任何其它配置的命令叫‘create’，当你调用‘app help create’ Corbra 将会起作用。</p>
<h3 id="例子-1">例子<a hidden class="anchor" aria-hidden="true" href="#例子-1">#</a></h3>
<p>下面的输入是 Cobra 自动生成的。除了命令和选项的定义，其它不再需要。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">cobra</span> <span class="nx">help</span>

<span class="nx">Cobra</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">CLI</span> <span class="nx">library</span> <span class="k">for</span> <span class="nx">Go</span> <span class="nx">that</span> <span class="nx">empowers</span> <span class="nx">applications</span><span class="p">.</span>
<span class="nx">This</span> <span class="nx">application</span> <span class="nx">is</span> <span class="nx">a</span> <span class="nx">tool</span> <span class="nx">to</span> <span class="nx">generate</span> <span class="nx">the</span> <span class="nx">needed</span> <span class="nx">files</span>
<span class="nx">to</span> <span class="nx">quickly</span> <span class="nx">create</span> <span class="nx">a</span> <span class="nx">Cobra</span> <span class="nx">application</span><span class="p">.</span>

<span class="nx">Usage</span><span class="p">:</span>
  <span class="nx">cobra</span> <span class="p">[</span><span class="nx">command</span><span class="p">]</span>

<span class="nx">Available</span> <span class="nx">Commands</span><span class="p">:</span>
  <span class="nx">add</span>         <span class="nx">Add</span> <span class="nx">a</span> <span class="nx">command</span> <span class="nx">to</span> <span class="nx">a</span> <span class="nx">Cobra</span> <span class="nx">Application</span>
  <span class="nx">help</span>        <span class="nx">Help</span> <span class="nx">about</span> <span class="nx">any</span> <span class="nx">command</span>
  <span class="nx">init</span>        <span class="nx">Initialize</span> <span class="nx">a</span> <span class="nx">Cobra</span> <span class="nx">Application</span>

<span class="nx">Flags</span><span class="p">:</span>
  <span class="o">-</span><span class="nx">a</span><span class="p">,</span> <span class="o">--</span><span class="nx">author</span> <span class="kt">string</span>    <span class="nx">author</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">copyright</span> <span class="nf">attribution</span> <span class="p">(</span><span class="k">default</span> <span class="s">&#34;YOUR NAME&#34;</span><span class="p">)</span>
      <span class="o">--</span><span class="nx">config</span> <span class="kt">string</span>    <span class="nx">config</span> <span class="nf">file</span> <span class="p">(</span><span class="k">default</span> <span class="nx">is</span> <span class="err">$</span><span class="nx">HOME</span><span class="o">/</span><span class="p">.</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">yaml</span><span class="p">)</span>
  <span class="o">-</span><span class="nx">h</span><span class="p">,</span> <span class="o">--</span><span class="nx">help</span>             <span class="nx">help</span> <span class="k">for</span> <span class="nx">cobra</span>
  <span class="o">-</span><span class="nx">l</span><span class="p">,</span> <span class="o">--</span><span class="nx">license</span> <span class="kt">string</span>   <span class="nx">name</span> <span class="nx">of</span> <span class="nx">license</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">project</span>
      <span class="o">--</span><span class="nx">viper</span>            <span class="nx">use</span> <span class="nx">Viper</span> <span class="k">for</span> <span class="nf">configuration</span> <span class="p">(</span><span class="k">default</span> <span class="kc">true</span><span class="p">)</span>

<span class="nx">Use</span> <span class="s">&#34;cobra [command] --help&#34;</span> <span class="k">for</span> <span class="nx">more</span> <span class="nx">information</span> <span class="nx">about</span> <span class="nx">a</span> <span class="nx">command</span><span class="p">.</span>
</code></pre></td></tr></table>
</div>
</div><p>help就像其他命令一样。没有特殊的逻辑或行为。实际上，您可以根据需要提供自己的文件。</p>
<h3 id="定义自己的help">定义自己的help<a hidden class="anchor" aria-hidden="true" href="#定义自己的help">#</a></h3>
<p>你能为默认的命令，提供你自己的help命令或模板。使用下面的方法:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cmd</span><span class="p">.</span><span class="nf">SetHelpCommand</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">Command</span><span class="p">)</span>
<span class="nx">cmd</span><span class="p">.</span><span class="nf">SetHelpFunc</span><span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Command</span><span class="p">,</span> <span class="p">[]</span><span class="kt">string</span><span class="p">))</span>
<span class="nx">cmd</span><span class="p">.</span><span class="nf">SetHelpTemplate</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>后2个也将适用于任何子命令</p>
<h2 id="使用信息">使用信息<a hidden class="anchor" aria-hidden="true" href="#使用信息">#</a></h2>
<p>当用户提供无效的标记或命令，Cobra 将会返回用法。</p>
<h3 id="例子-2">例子<a hidden class="anchor" aria-hidden="true" href="#例子-2">#</a></h3>
<p>你可能从上面的帮助意识到，默认的帮助将被嵌入到用法里然后作为输出。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">cobra</span> <span class="o">--</span><span class="nx">invalid</span>
<span class="nx">Error</span><span class="p">:</span> <span class="nx">unknown</span> <span class="nx">flag</span><span class="p">:</span> <span class="o">--</span><span class="nx">invalid</span>
<span class="nx">Usage</span><span class="p">:</span>
  <span class="nx">cobra</span> <span class="p">[</span><span class="nx">command</span><span class="p">]</span>

<span class="nx">Available</span> <span class="nx">Commands</span><span class="p">:</span>
  <span class="nx">add</span>         <span class="nx">Add</span> <span class="nx">a</span> <span class="nx">command</span> <span class="nx">to</span> <span class="nx">a</span> <span class="nx">Cobra</span> <span class="nx">Application</span>
  <span class="nx">help</span>        <span class="nx">Help</span> <span class="nx">about</span> <span class="nx">any</span> <span class="nx">command</span>
  <span class="nx">init</span>        <span class="nx">Initialize</span> <span class="nx">a</span> <span class="nx">Cobra</span> <span class="nx">Application</span>

<span class="nx">Flags</span><span class="p">:</span>
  <span class="o">-</span><span class="nx">a</span><span class="p">,</span> <span class="o">--</span><span class="nx">author</span> <span class="kt">string</span>    <span class="nx">author</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">copyright</span> <span class="nf">attribution</span> <span class="p">(</span><span class="k">default</span> <span class="s">&#34;YOUR NAME&#34;</span><span class="p">)</span>
      <span class="o">--</span><span class="nx">config</span> <span class="kt">string</span>    <span class="nx">config</span> <span class="nf">file</span> <span class="p">(</span><span class="k">default</span> <span class="nx">is</span> <span class="err">$</span><span class="nx">HOME</span><span class="o">/</span><span class="p">.</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">yaml</span><span class="p">)</span>
  <span class="o">-</span><span class="nx">h</span><span class="p">,</span> <span class="o">--</span><span class="nx">help</span>             <span class="nx">help</span> <span class="k">for</span> <span class="nx">cobra</span>
  <span class="o">-</span><span class="nx">l</span><span class="p">,</span> <span class="o">--</span><span class="nx">license</span> <span class="kt">string</span>   <span class="nx">name</span> <span class="nx">of</span> <span class="nx">license</span> <span class="k">for</span> <span class="nx">the</span> <span class="nx">project</span>
      <span class="o">--</span><span class="nx">viper</span>            <span class="nx">use</span> <span class="nx">Viper</span> <span class="k">for</span> <span class="nf">configuration</span> <span class="p">(</span><span class="k">default</span> <span class="kc">true</span><span class="p">)</span>

<span class="nx">Use</span> <span class="s">&#34;cobra [command] --help&#34;</span> <span class="k">for</span> <span class="nx">more</span> <span class="nx">information</span> <span class="nx">about</span> <span class="nx">a</span> <span class="nx">command</span><span class="p">.</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="定义自己的用法">定义自己的用法<a hidden class="anchor" aria-hidden="true" href="#定义自己的用法">#</a></h3>
<p>你能提供你自己的用法函数或模板给 Cobra 使用。
比如帮助，方法和模板都可以重写。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cmd</span><span class="p">.</span><span class="nf">SetUsageFunc</span><span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">Command</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span>
<span class="nx">cmd</span><span class="p">.</span><span class="nf">SetUsageTemplate</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="版本标记">版本标记<a hidden class="anchor" aria-hidden="true" href="#版本标记">#</a></h2>
<p>如果Version字段设置到了根命令，Cobra 会提供了一个顶层 ‘&ndash;version’标记。运行带上‘&ndash;version’标记的程序，将会按照模板版本信息。模板可以通过cmd.SetVersionTemplate(s string)方法修改</p>
<h2 id="运行前和运行后钩子">运行前和运行后钩子<a hidden class="anchor" aria-hidden="true" href="#运行前和运行后钩子">#</a></h2>
<p>在命令运行前或运行后，再运行方法非常容易。PersistentPreRun和PreRun方法将会在Run之前执行。PersistentPostRun和PostRun方法将会在Run之后执行。Persistent*Run方法会被子命令继承，如果它们自己没有定义的话。这些方法将按照下面的属性执行：</p>
<ul>
<li>PersistentPreRun</li>
<li>PreRun</li>
<li>Run</li>
<li>PostRun</li>
<li>PersistentPostRun</li>
</ul>
<p>下面的例子，2个命令都使用了上面的特性。当子命令执行的时候，它将执行根命令的PersistentPreRun，但不会执行根命令的PersistentPostRun：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
  <span class="s">&#34;fmt&#34;</span>

  <span class="s">&#34;github.com/spf13/cobra&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">rootCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
    <span class="nx">Use</span><span class="p">:</span>   <span class="s">&#34;root [sub]&#34;</span><span class="p">,</span>
    <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;My root command&#34;</span><span class="p">,</span>
    <span class="nx">PersistentPreRun</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside rootCmd PersistentPreRun with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">PreRun</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside rootCmd PreRun with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside rootCmd Run with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">PostRun</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside rootCmd PostRun with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">PersistentPostRun</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside rootCmd PersistentPostRun with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">subCmd</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
    <span class="nx">Use</span><span class="p">:</span>   <span class="s">&#34;sub [no options!]&#34;</span><span class="p">,</span>
    <span class="nx">Short</span><span class="p">:</span> <span class="s">&#34;My subcommand&#34;</span><span class="p">,</span>
    <span class="nx">PreRun</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside subCmd PreRun with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside subCmd Run with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">PostRun</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside subCmd PostRun with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nx">PersistentPostRun</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;Inside subCmd PersistentPostRun with args: %v\n&#34;</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span>
    <span class="p">},</span>
  <span class="p">}</span>

  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">AddCommand</span><span class="p">(</span><span class="nx">subCmd</span><span class="p">)</span>

  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">SetArgs</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;&#34;</span><span class="p">})</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
  <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">()</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">SetArgs</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;sub&#34;</span><span class="p">,</span> <span class="s">&#34;arg1&#34;</span><span class="p">,</span> <span class="s">&#34;arg2&#34;</span><span class="p">})</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">Execute</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>输出:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Inside rootCmd PersistentPreRun with args: []
Inside rootCmd PreRun with args: []
Inside rootCmd Run with args: []
Inside rootCmd PostRun with args: []
Inside rootCmd PersistentPostRun with args: []

Inside rootCmd PersistentPreRun with args: [arg1 arg2]
Inside subCmd PreRun with args: [arg1 arg2]
Inside subCmd Run with args: [arg1 arg2]
Inside subCmd PostRun with args: [arg1 arg2]
Inside subCmd PersistentPostRun with args: [arg1 arg2]
</code></pre></td></tr></table>
</div>
</div><h2 id="处理未知命令的建议">处理“未知命令”的建议<a hidden class="anchor" aria-hidden="true" href="#处理未知命令的建议">#</a></h2>
<p>Cobra 会自动输出建议，当遇到“unknown command”错误时。这使得当输入错误时， Cobra 的行为类似git命令。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">hugo</span> <span class="nx">srever</span>
<span class="nx">Error</span><span class="p">:</span> <span class="nx">unknown</span> <span class="nx">command</span> <span class="s">&#34;srever&#34;</span> <span class="k">for</span> <span class="s">&#34;hugo&#34;</span>

<span class="nx">Did</span> <span class="nx">you</span> <span class="nx">mean</span> <span class="nx">this</span><span class="err">?</span>
        <span class="nx">server</span>

<span class="nx">Run</span> <span class="err">&#39;</span><span class="nx">hugo</span> <span class="o">--</span><span class="nx">help</span><span class="err">&#39;</span> <span class="k">for</span> <span class="nx">usage</span><span class="p">.</span>
</code></pre></td></tr></table>
</div>
</div><p>建议会基于注册的子命令自动生成。使用了Levenshtein distance的实现。每一个注册的命令会匹配2个距离（忽略大小写）来提供建议。</p>
<p>如果你希望在你的命令里，禁用建议或虚弱字符串的距离，使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">command</span><span class="p">.</span><span class="nx">DisableSuggestions</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></td></tr></table>
</div>
</div><p>或</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">command</span><span class="p">.</span><span class="nx">SuggestionsMinimumDistance</span> <span class="p">=</span> <span class="mi">1</span>
</code></pre></td></tr></table>
</div>
</div><p>你可以通过SuggestFor来给命令提供明确的名词建议。这个特性允许当字符串不相近，但是意思与你的命令相近，别切你也不想给该命令设置别名。比如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">$</span> <span class="nx">kubectl</span> <span class="nx">remove</span>
<span class="nx">Error</span><span class="p">:</span> <span class="nx">unknown</span> <span class="nx">command</span> <span class="s">&#34;remove&#34;</span> <span class="k">for</span> <span class="s">&#34;kubectl&#34;</span>

<span class="nx">Did</span> <span class="nx">you</span> <span class="nx">mean</span> <span class="nx">this</span><span class="err">?</span>
        <span class="nx">delete</span>

<span class="nx">Run</span> <span class="err">&#39;</span><span class="nx">kubectl</span> <span class="nx">help</span><span class="err">&#39;</span> <span class="k">for</span> <span class="nx">usage</span><span class="p">.</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="生成命令的文档">生成命令的文档<a hidden class="anchor" aria-hidden="true" href="#生成命令的文档">#</a></h2>
<p>Cobra 可以基于子命令，标记，等生成文档。以以下格式：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">Markdown</span>
<span class="nx">ReStructured</span> <span class="nx">Text</span>
<span class="nx">Man</span> <span class="nx">Page</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="生成bash-completion">生成bash-completion<a hidden class="anchor" aria-hidden="true" href="#生成bash-completion">#</a></h2>
<p>Cobra 可以生成一个bash-completion文件。如果你给命令添加更多信息，这些completions可以非常强大和灵活。更多介绍在Bash Completions。</p>
<h1 id="cobra生成器">Cobra生成器<a hidden class="anchor" aria-hidden="true" href="#cobra生成器">#</a></h1>
<p>Cobra提供自己的程序来创建你的程序并且添加你想要的命令。这是最简单的方式把Cobra添加到你的程序里。</p>
<p><a href="https://github.com/spf13/cobra/blob/master/cobra/README.md">这里</a>你能找到相关信息</p>
<p>通过前面的介绍，我们也看到了其实 cobra 命令的框架还是比较固定的。这就有了工具的用武之地了，可极大地提高我们的开发效率。</p>
<p>前面安装 cobra 库的时候也将脚手架程序安装好了。下面我们介绍如何使用这个生成器。</p>
<p>使用cobra init命令创建一个 cobra 应用程序：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-s" data-lang="s"><span class="n">cobra</span> <span class="n">init</span> <span class="n">scaffold</span> <span class="o">--</span><span class="n">pkg</span><span class="o">-</span><span class="n">name</span> <span class="n">github.com</span><span class="o">/</span><span class="n">darjun</span><span class="o">/</span><span class="n">go</span><span class="o">-</span><span class="n">daily</span><span class="o">-</span><span class="n">lib</span><span class="o">/</span><span class="n">cobra</span><span class="o">/</span><span class="n">scaffold</span>
</code></pre></td></tr></table>
</div>
</div><p>其中scaffold为应用程序名，后面通过pkg-name选项指定包路径。生成的程序目录结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="err">▾</span> <span class="nx">scaffold</span><span class="o">/</span>
    <span class="err">▾</span> <span class="nx">cmd</span><span class="o">/</span>
        <span class="nx">root</span><span class="p">.</span><span class="k">go</span>
    <span class="nx">LICENSE</span>
    <span class="nx">main</span><span class="p">.</span><span class="k">go</span>
</code></pre></td></tr></table>
</div>
</div><p>这个项目结构与之前介绍的完全相同，也是 cobra 推荐使用的结构。同样地，main.go也仅仅是入口。</p>
<p>在root.go中，工具额外帮我们生成了一些代码。</p>
<p>在根命令中添加了配置文件选项，大部分应用程序都需要配置文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">cobra</span><span class="p">.</span><span class="nf">OnInitialize</span><span class="p">(</span><span class="nx">initConfig</span><span class="p">)</span>

  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfgFile</span><span class="p">,</span> <span class="s">&#34;config&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;config file (default is $HOME/.scaffold.yaml)&#34;</span><span class="p">)</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">Flags</span><span class="p">().</span><span class="nf">BoolP</span><span class="p">(</span><span class="s">&#34;toggle&#34;</span><span class="p">,</span> <span class="s">&#34;t&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Help message for toggle&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在初始化完成的回调中，如果发现该选项为空，则默认使用主目录下的.scaffold.yaml文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">initConfig</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">cfgFile</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
    <span class="nx">viper</span><span class="p">.</span><span class="nf">SetConfigFile</span><span class="p">(</span><span class="nx">cfgFile</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">home</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">homedir</span><span class="p">.</span><span class="nf">Dir</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">viper</span><span class="p">.</span><span class="nf">AddConfigPath</span><span class="p">(</span><span class="nx">home</span><span class="p">)</span>
    <span class="nx">viper</span><span class="p">.</span><span class="nf">SetConfigName</span><span class="p">(</span><span class="s">&#34;.scaffold&#34;</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">viper</span><span class="p">.</span><span class="nf">AutomaticEnv</span><span class="p">()</span>

  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">viper</span><span class="p">.</span><span class="nf">ReadInConfig</span><span class="p">();</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Using config file:&#34;</span><span class="p">,</span> <span class="nx">viper</span><span class="p">.</span><span class="nf">ConfigFileUsed</span><span class="p">())</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>除了代码文件，cobra 还生成了一个 LICENSE 文件。</p>
<p>现在这个程序还不能做任何事情，我们需要给它添加子命令，使用cobra add命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">cobra</span> <span class="nx">add</span> <span class="nx">date</span>
</code></pre></td></tr></table>
</div>
</div><p>该命令在cmd目录下新增了date.go文件。基本结构已经搭好了，剩下的就是修改一些描述，添加一些选项了。</p>
<p>我们现在实现这样一个功能，根据传入的年、月，打印这个月的日历。如果没有传入选项，使用当前的年、月。</p>
<p>选项定义：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">rootCmd</span><span class="p">.</span><span class="nf">AddCommand</span><span class="p">(</span><span class="nx">dateCmd</span><span class="p">)</span>

  <span class="nx">dateCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">IntVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">year</span><span class="p">,</span> <span class="s">&#34;year&#34;</span><span class="p">,</span> <span class="s">&#34;y&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;year to show (should in [1000, 9999]&#34;</span><span class="p">)</span>
  <span class="nx">dateCmd</span><span class="p">.</span><span class="nf">PersistentFlags</span><span class="p">().</span><span class="nf">IntVarP</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">month</span><span class="p">,</span> <span class="s">&#34;month&#34;</span><span class="p">,</span> <span class="s">&#34;m&#34;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;month to show (should in [1, 12]&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>修改dateCmd的Run函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="nx">Run</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">cmd</span> <span class="o">*</span><span class="nx">cobra</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span> <span class="nx">args</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">year</span> <span class="p">&lt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="nx">year</span> <span class="p">&gt;</span> <span class="mi">9999</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;invalid year should in [1000, 9999], actual:%d&#34;</span><span class="p">,</span> <span class="nx">year</span><span class="p">)</span>
    <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nx">month</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">year</span> <span class="p">&gt;</span> <span class="mi">12</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintln</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stderr</span><span class="p">,</span> <span class="s">&#34;invalid month should in [1, 12], actual:%d&#34;</span><span class="p">,</span> <span class="nx">month</span><span class="p">)</span>
    <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">showCalendar</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>showCalendar函数就是利用time提供的方法实现的，这里就不赘述了。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/go/">Go</a></li>
      <li><a href="/tags/cobra/">Cobra</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
