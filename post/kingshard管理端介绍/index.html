<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kingshard管理端介绍 | Forz Blog</title>
<meta name="keywords" content="Kingshard" />
<meta name="description" content="管理端命令 kingshard的管理端口复用了工作端口，通过特定的关键字来标示，目前支持对后端DB常用的管理操作。kingshard支持了多用">
<meta name="author" content="">
<link rel="canonical" href="/post/kingshard%E7%AE%A1%E7%90%86%E7%AB%AF%E4%BB%8B%E7%BB%8D/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Kingshard管理端介绍" />
<meta property="og:description" content="管理端命令 kingshard的管理端口复用了工作端口，通过特定的关键字来标示，目前支持对后端DB常用的管理操作。kingshard支持了多用" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/kingshard%E7%AE%A1%E7%90%86%E7%AB%AF%E4%BB%8B%E7%BB%8D/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-03-26T10:12:53&#43;00:00" />
<meta property="article:modified_time" content="2020-03-26T10:12:53&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kingshard管理端介绍"/>
<meta name="twitter:description" content="管理端命令 kingshard的管理端口复用了工作端口，通过特定的关键字来标示，目前支持对后端DB常用的管理操作。kingshard支持了多用"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Kingshard管理端介绍",
      "item": "/post/kingshard%E7%AE%A1%E7%90%86%E7%AB%AF%E4%BB%8B%E7%BB%8D/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kingshard管理端介绍",
  "name": "Kingshard管理端介绍",
  "description": "管理端命令 kingshard的管理端口复用了工作端口，通过特定的关键字来标示，目前支持对后端DB常用的管理操作。kingshard支持了多用",
  "keywords": [
    "Kingshard"
  ],
  "articleBody": "管理端命令 kingshard的管理端口复用了工作端口，通过特定的关键字来标示，目前支持对后端DB常用的管理操作。kingshard支持了多用户，\n只有root用户才有权限操作admin相关命令。\n管理端的命令格式，可以分为两类：\n  admin server(opt,k,v) values(action,k1,v1)。这种命令是操作整个kingshard的，其中opt表示这个操作的动作；k表示操作的对象，v表示给对象的赋值。 admin node(opt,node,k,v) values(action,nodeName,k1,v1),这类命令表示操作node。其中opt表示这个操作的动作；node表示操作哪个node；k表示操作的对象，v表示给对象的赋值。  平滑上（下）线后端DB 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  #添加一个新的slave到node1adminnode(opt,node,k,v)values('add','node1','slave','127.0.0.1:3306')#删除node1上的一个slave。注意：只能删除slave，不能删除masteradminnode(opt,node,k,v)values('del','node1','slave','127.0.0.1:3306')#将一个slave设置为下线状态adminnode(opt,node,k,v)values('down','node1','slave','127.0.0.1:3306')#将一个slave设置为上线状态adminnode(opt,node,k,v)values('up','node1','slave','127.0.0.1:3306')#将master设置为下线状态adminnode(opt,node,k,v)values('down','node1','master','127.0.0.1:3306')#将master设置为上线状态adminnode(opt,node,k,v)values('up','node1','master','127.0.0.1:3306')  查看kingshard配置 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69  #查看kingshard全局配置mysqladminserver(opt,k,v)values('show','proxy','config');+--------------+----------------+ |Key|Value|+--------------+----------------+ |Addr|127.0.0.1:9696||User_List|root,kingshard||LogPath|./||LogLevel|debug||LogSql|on||SlowLogTime|10||Nodes_Count|2||Nodes_List|node1,node2||ClientConns|32||ClientQPS|15||ErrLogTotal|12||SlowLogTotal|26|+--------------+----------------+ 6rowsinset(0.00sec)ClientConns:客户端连接数ClientQPS:客户端的QPS大小ErrLogTotal:kingshard启动以来产生的错误日志个数SlowLogTotal:kingshard启动以来产生的慢日志个数#查看node状态mysqladminserver(opt,k,v)values('show','node','config');+-------+--------------------+--------+-------+-------------------------------+---------+----------+------------+---------------+--------------+ |Node|Address|Type|State|LastPing|MaxConn|IdleConn|CacheConns|PushConnCount|PopConnCount|+-------+--------------------+--------+-------+-------------------------------+---------+----------+------------+---------------+--------------+ |node1|127.0.0.1:3306|master|up|2015-08-0715:54:44+0800CST|512|509|2|6301447|6300936||node2|192.168.59.103:3307|master|up|2015-08-0715:54:44+0800CST|512|509|2|6301447|6300936|+-------+--------------------+--------+-------+-------------------------------+---------+----------+------------+---------------+--------------+ 2rowsinset(0.00sec)#查看schema配置mysqladminserver(opt,k,v)values('show','schema','config');+-----------+-----------+------------------+---------+------+--------------+-----------+---------------+ |User|DB|Table|Type|Key|Nodes_List|Locations|TableRowLimit|+-----------+-----------+------------------+---------+------+--------------+-----------+---------------+ |kingshard|kingshard||default||node1||0||kingshard|kingshard|test_shard_hash|hash|id|node1,node2|4,4|0||kingshard|kingshard|test_shard_range|range|id|node1,node2|4,4|10000||root|kingshard||default||node1||0|+-----------+-----------+------------------+---------+------+--------------+-----------+---------------+ 3rowsinset(0.00sec)#查看白名单ipmysqladminserver(opt,k,v)values('show','allow_ip','config');+--------------+ |AllowIP|+--------------+ |127.0.0.1||192.168.10.1|+--------------+ 2rowsinset(0.00sec)#查看黑名单sqlmysqladminserver(opt,k,v)values('show','black_sql','config');+-------------------------------+ |BlackListSql|+-------------------------------+ |select*fromsbtest1||select*fromsbtest1limit?|+-------------------------------+ 2rowsinset(0.00sec)  修改kingshard配置 为保证kingshard的安全性，管理端命令，只能通过root用户来操作，其他用户不能操作。也就是说用户列表中，需要配置一个root用户\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  #关闭sql日志打印adminserver(opt,k,v)values('change','log_sql','off')#开启sql日志打印adminserver(opt,k,v)values('change','log_sql','on')#修改慢sql日志时间,单位msadminserver(opt,k,v)values('change','slow_log_time','50');#添加白名单IP#支持IP或IP段adminserver(opt,k,v)values('add','allow_ip','192.168.14.0/24');adminserver(opt,k,v)values('add','allow_ip','192.168.15.1');#删除白名单IPadminserver(opt,k,v)values('del','allow_ip','127.0.0.1');#添加黑名单sql语句adminserver(opt,k,v)values('add','black_sql','select count(*) from sbtest1')#删除黑名单sql语句adminserver(opt,k,v)values('del','black_sql','select count(*) from sbtest1')#保存当前配置adminserver(opt,k,v)values('save','proxy','config')  上面是通过命令方式修改部分kingshard的配置，但更推荐通过修改配置文件，然后动态加载的方式来热加载配置文件，步骤如下：\n1.修改kingshard 正在使用的配置文件，不能是kingshard未使用的文件\n2.向kingshard发送USR1信号，kingshard就会加载新配置文件的全部内容\n1  kill -USR1 pid_of_kingshard   支持LVS/Keepalived 1 2 3 4 5  #查看kingshard运行状态adminserver(opt,k,v)values('show','proxy','status')#改变kingshard运行状态online:在线offline:下线adminserver(opt,k,v)values('change','proxy','online')  Web API 接口定义和参数说明  采用restful风格API设计。 假设kingshard的Web Server IP和端口是：127.0.0.1：9797，web用户名：admin，密码：admin  API接口导航  查看node的状态 添加slave 删除slave 设置slave状态 设置master状态 查看proxy状态 设置proxy状态 查看proxy的schema 查看proxy的客户端白名单 添加proxy的客户端白名单 删除proxy的客户端白名单 查看proxy的black_sql 增加proxy的black_sql 删除proxy的black_sql 设置proxy的slow sql开关 查看proxy的slow sql的时间 设置proxy的slow sql的时间 保存proxy的配置  1 2 3 4 5  Action:GET URL:http://127.0.0.1:9797/api/v1/nodes/status 参数：无 返回结果：node数组，node中包含Master和Slave信息， 字段意思参考配置文件说明   示例\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  curl -X GET \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ 127.0.0.1:9797/api/v1/nodes/status 返回结果： [ { \"node\": \"node1\", \"address\": \"127.0.0.1:3307\", \"type\": \"master\", \"status\": \"up\", \"laste_ping\": \"2016-09-24 17:17:52 +0800 CST\", \"max_conn\": 32, \"idle_conn\": 8, \"cache_conn\":12, \"push_conn_count\":32, \"pop_conn_count\":0 }, { \"node\": \"node2\", \"address\": \"127.0.0.1:3309\", \"type\": \"master\", \"status\": \"up\", \"laste_ping\": \"2016-09-24 17:17:52 +0800 CST\", \"max_conn\": 32, \"idle_conn\": 8, \"cache_conn\":12, \"push_conn_count\":32, \"pop_conn_count\":0 } ]   1 2 3 4 5 6  Action:POST URL:http://127.0.0.1:9797/api/v1/nodes/slaves 参数： - node：节点名字 - addr：slave的IP和端口 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6  curl -X POST \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"node\":\"node1\",\"addr\":\"127.0.0.1:3309\"}' \\ 127.0.0.1:9797/api/v1/nodes/slaves 返回结果：\"ok\"   1 2 3 4 5 6  Action:DELETE URL:http://127.0.0.1:9797/api/v1/nodes/slaves 参数： - node：节点名字 - addr：slave的IP和端口 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6  curl -X DELETE \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"node\":\"node1\",\"addr\":\"127.0.0.1:3309\"}' \\ 127.0.0.1:9797/api/v1/nodes/slaves 返回结果：\"ok\"   1 2 3 4 5 6 7  Action:PUT URL：http://127.0.0.1:9797/api/v1/nodes/slaves/status 参数： - opt：\"up\" or \"down\"，上线或下线slave - node：节点名字 - addr：slave的IP和端口 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6 7  curl -X PUT \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"opt\":\"up\",\"node\":\"node1\",\"addr\":\"127.0.0.1:3309\"}' \\ http://127.0.0.1:9797/api/v1/nodes/slaves/status 返回结果：\"ok\"   1 2 3 4 5 6 7  Action:PUT URL：http://127.0.0.1:9797/api/v1/nodes/masters/status 参数： - opt：\"up\" or \"down\"，上线或下线slave - node：节点名字 - addr：slave的IP和端口 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6  curl -X PUT \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"opt\":\"down\",\"node\":\"node2\",\"addr\":\"127.0.0.1:3309\"}' \\ http://127.0.0.1:9797/api/v1/nodes/masters/status 返回结果：\"ok\"   1 2 3 4 5  Action:GET URL:http://127.0.0.1:9797/api/v1/proxy/status 参数：无 返回结果：\"online\"或者\"offline\" 注意：该API主要用于配合LVS平滑下线   示例\n1 2 3 4 5  curl -X GET \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ http://127.0.0.1:9797/api/v1/proxy/status 返回结果:\"online\"   1 2 3 4 5 6  Action:PUT URL:http://127.0.0.1:9797/api/v1/proxy/status 参数：opt:\"online\"或者\"offline\" 返回结果：成功:\"ok\",失败：\"error message\" 注意：该API主要用于配合LVS平滑下线   示例\n1 2 3 4 5 6  curl -X PUT \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"opt\":\"offline\"}' \\ http://127.0.0.1:9797/api/v1/proxy/status 返回结果：\"ok\"   1 2 3 4  Action：GET http://127.0.0.1:9797/api/v1/proxy/schema 参数：无 返回结果:schema数组，但只有一项。字段意思参考配置文件   示例\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120  curl -X GET \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ 127.0.0.1:9797/api/v1/proxy/schema 返回结果： [ { \"user\": \"kingshard\", \"db\": \"kingshard\", \"Table\": \"\", \"Key\": \"\", \"Nodes\": [ \"node1\", \"node2\" ], \"Locations\": null, \"Type\": \"default\", \"TableRowLimit\": 0, \"DateRange\": null }, { \"user\": \"kingshard\", \"db\": \"kingshard\", \"Table\": \"test_shard_hash\", \"Key\": \"id\", \"Nodes\": [ \"node1\", \"node2\" ], \"Locations\": [ 4, 4 ], \"Type\": \"hash\", \"TableRowLimit\": 0, \"DateRange\": null }, { \"user\": \"kingshard\", \"db\": \"kingshard\", \"Table\": \"test_shard_range\", \"Key\": \"id\", \"Nodes\": [ \"node1\", \"node2\" ], \"Locations\": [ 4, 4 ], \"Type\": \"range\", \"TableRowLimit\": 10000, \"DateRange\": null }, { \"user\": \"kingshard\", \"db\": \"kingshard\", \"Table\": \"test_shard_time\", \"Key\": \"id\", \"Nodes\": [ \"node1\", \"node2\" ], \"Locations\": [ 2, 2 ], \"Type\": \"hash\", \"TableRowLimit\": 0, \"DateRange\": null }, { \"user\": \"kingshard\", \"db\": \"kingshard\", \"Table\": \"test_shard_month\", \"Key\": \"dtime\", \"Nodes\": [ \"node1\", \"node2\" ], \"Locations\": null, \"Type\": \"date_month\", \"TableRowLimit\": 0, \"DateRange\": [ \"201603-201605\", \"201609-201612\" ] }, { \"user\": \"kingshard\", \"db\": \"kingshard\", \"Table\": \"test_shard_day\", \"Key\": \"mtime\", \"Nodes\": [ \"node1\", \"node2\" ], \"Locations\": null, \"Type\": \"date_day\", \"TableRowLimit\": 0, \"DateRange\": [ \"20160306-20160307\", \"20160308-20160309\" ] }, { \"user\": \"root\", \"db\": \"kingshard\", \"Table\": \"\", \"Key\": \"\", \"Nodes\": [ \"node1\", \"node2\" ], \"Locations\": null, \"Type\": \"default\", \"TableRowLimit\": 0, \"DateRange\": null } ]   1 2 3 4  Action：GET URL：http://127.0.0.1:9797/api/v1/proxy/allow_ips 参数：allow_ips，ip列表数组 返回结果：IP列表   示例\n1 2 3 4 5 6  curl -X GET \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ localhost:9797/api/v1/proxy/allow_ips 返回结果：[\"127.0.0.1\",\"192.168.0.14\"]   1 2 3 4  Action：POST URL：http://127.0.0.1:9797/api/v1/proxy/allow_ips 参数：allow_ips，ip列表数组 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6 7  curl -X POST \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"allow_ips\":[\"127.0.0.1\",\"192.168.14.0/24\",\"192.168.0.223\"]}' \\ 127.0.0.1:9797/api/v1/proxy/allow_ips 返回结果：\"ok\"   1 2 3 4  Action：DELETE URL：http://127.0.0.1:9797/api/v1/proxy/allow_ips 参数：allow_ips，ip列表数组 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6 7  curl -X DELETE \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"allow_ips\":[\"192.168.0.14\",\"192.168.0.223\"]}' \\ 127.0.0.1:9797/api/v1/proxy/allow_ips 返回结果：\"ok\"   1 2 3 4  Action:GET http://127.0.0.1：9797/api/v1/proxy/black_sqls 参数：无 返回结果:sql列表   示例\n1 2 3 4 5  curl -X GET \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ 127.0.0.1:9797/api/v1/proxy/black_sqls 返回结果：[\"delete from test_shard_range\",\"delete from test_shard_hash\"]   1 2 3 4 5  Action:POST http://127.0.0.1:9797/api/v1/proxy/black_sqls 参数：sql（注意：一次只能添加一条SQL） 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6  curl -X POST \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"sql\":\"delete from test_shard_range\"}' \\ 127.0.0.1:9797/api/v1/proxy/black_sqls 返回结果：\"ok\"   1 2 3 4  Action:DELETE http:// 127.0.0.1:9797/api/v1/proxy/black_sqls 参数：sql（注意：一次只能删除一条SQL） 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6  curl -X DELETE \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"sql\":\"delete from test_shard_range\"}' \\ 127.0.0.1:9797/api/v1/proxy/black_sqls 返回结果：\"ok\"   1 2 3 4  Action:PUT URL:http://127.0.0.1:9797/api/v1/proxy/slow_sql/status 参数：opt(可选值：\"on\",\"off\") 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6  curl -X PUT \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"opt\":\"on\"}' \\ 127.0.0.1:9797/api/v1/proxy/slow_sql/status 返回结果：\"ok\"   1 2 3 4  Action:GET URL:http://127.0.0.1:9797/api/v1/proxy/slow_sql/time 参数：无 返回结果：slow_log 时间，单位ms   1 2 3 4 5  curl -X GET \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ 127.0.0.1:9797/api/v1/proxy/slow_sql/time 返回结果：500   1 2 3 4  Action:PUT URL:http://127.0.0.1:9797/api/v1/proxy/slow_sql/time 参数：slow_time(慢日志时间，单位ms。执行时间超过该值的SQL会输出到慢日志文件) 返回结果：成功:\"ok\",失败：\"error message\"   示例\n1 2 3 4 5 6  curl -X PUT \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ -d '{\"slow_time\":500}' \\ 127.0.0.1:9797/api/v1/proxy/slow_sql/time 返回结果：\"ok\"   1 2 3 4 5  Action:PUT URL:http://127.0.0.1:9797/api/v1/proxy/config/save 参数：无 返回结果：成功:\"ok\",失败：\"error message\" 说明：将kingshard的配置写入文件   示例\n1 2 3 4 5  curl -X PUT \\ -H 'Content-Type: application/json' \\ -u admin:admin \\ 127.0.0.1:9797/api/v1/proxy/config/save 返回结果：\"ok\"   转载:https://github.com/flike/kingshard/blob/master/README_ZH.md\n",
  "wordCount" : "6437",
  "inLanguage": "zh-cn",
  "datePublished": "2020-03-26T10:12:53Z",
  "dateModified": "2020-03-26T10:12:53Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/kingshard%E7%AE%A1%E7%90%86%E7%AB%AF%E4%BB%8B%E7%BB%8D/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Kingshard管理端介绍
    </h1>
    <div class="post-meta">March 26, 2020
</div>
  </header> 
  <div class="post-content"><h1 id="管理端命令">管理端命令<a hidden class="anchor" aria-hidden="true" href="#管理端命令">#</a></h1>
<p>kingshard的管理端口复用了工作端口，通过特定的关键字来标示，目前支持对后端DB常用的管理操作。kingshard支持了多用户，</p>
<p>只有root用户才有权限操作admin相关命令。</p>
<p>管理端的命令格式，可以分为两类：</p>
<ul>
<li><code> admin server(opt,k,v) values(action,k1,v1)</code>。这种命令是操作整个kingshard的，其中opt表示这个操作的动作；k表示操作的对象，v表示给对象的赋值。</li>
<li><code>admin node(opt,node,k,v) values(action,nodeName,k1,v1)</code>,这类命令表示操作node。其中opt表示这个操作的动作；node表示操作哪个node；k表示操作的对象，v表示给对象的赋值。</li>
</ul>
<h2 id="平滑上下线后端db">平滑上（下）线后端DB<a hidden class="anchor" aria-hidden="true" href="#平滑上下线后端db">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="err">添加一个新的</span><span class="n">slave到node1</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="s1">&#39;node1&#39;</span><span class="p">,</span><span class="s1">&#39;slave&#39;</span><span class="p">,</span><span class="s1">&#39;127.0.0.1:3306&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">删除</span><span class="n">node1上的一个slave</span><span class="err">。注意：只能删除</span><span class="n">slave</span><span class="err">，不能删除</span><span class="n">master</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span><span class="s1">&#39;node1&#39;</span><span class="p">,</span><span class="s1">&#39;slave&#39;</span><span class="p">,</span><span class="s1">&#39;127.0.0.1:3306&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">将一个</span><span class="n">slave设置为下线状态</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="s1">&#39;node1&#39;</span><span class="p">,</span><span class="s1">&#39;slave&#39;</span><span class="p">,</span><span class="s1">&#39;127.0.0.1:3306&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">将一个</span><span class="n">slave设置为上线状态</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">,</span><span class="s1">&#39;node1&#39;</span><span class="p">,</span><span class="s1">&#39;slave&#39;</span><span class="p">,</span><span class="s1">&#39;127.0.0.1:3306&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">将</span><span class="n">master设置为下线状态</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;down&#39;</span><span class="p">,</span><span class="s1">&#39;node1&#39;</span><span class="p">,</span><span class="s1">&#39;master&#39;</span><span class="p">,</span><span class="s1">&#39;127.0.0.1:3306&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">将</span><span class="n">master设置为上线状态</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">node</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">node</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;up&#39;</span><span class="p">,</span><span class="s1">&#39;node1&#39;</span><span class="p">,</span><span class="s1">&#39;master&#39;</span><span class="p">,</span><span class="s1">&#39;127.0.0.1:3306&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="查看kingshard配置">查看kingshard配置<a hidden class="anchor" aria-hidden="true" href="#查看kingshard配置">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="err">查看</span><span class="n">kingshard全局配置</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span><span class="s1">&#39;proxy&#39;</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------+----------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">Key</span><span class="w">          </span><span class="o">|</span><span class="w">   </span><span class="n">Value</span><span class="w">        </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------+----------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Addr</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">9696</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">User_List</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="p">,</span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">LogPath</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">LogLevel</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">debug</span><span class="w">          </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">LogSql</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">on</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">SlowLogTime</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">Nodes_Count</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w">              </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">Nodes_List</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">node1</span><span class="p">,</span><span class="n">node2</span><span class="w">    </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">ClientConns</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">32</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">ClientQPS</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">15</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">ErrLogTotal</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">12</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">SlowLogTotal</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">26</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------+----------------+
</span><span class="c1"></span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">ClientConns</span><span class="p">:</span><span class="err">客户端连接数</span><span class="w">
</span><span class="w"></span><span class="n">ClientQPS</span><span class="p">:</span><span class="err">客户端的</span><span class="n">QPS大小</span><span class="w">
</span><span class="w"></span><span class="n">ErrLogTotal</span><span class="p">:</span><span class="n">kingshard启动以来产生的错误日志个数</span><span class="w">
</span><span class="w"></span><span class="n">SlowLogTotal</span><span class="p">:</span><span class="n">kingshard启动以来产生的慢日志个数</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">查看</span><span class="n">node状态</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span><span class="s1">&#39;node&#39;</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------+--------------------+--------+-------+-------------------------------+---------+----------+------------+---------------+--------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Node</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Address</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">State</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LastPing</span><span class="w">                      </span><span class="o">|</span><span class="w"> </span><span class="n">MaxConn</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IdleConn</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CacheConns</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PushConnCount</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PopConnCount</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------+--------------------+--------+-------+-------------------------------+---------+----------+------------+---------------+--------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">node1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">up</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">07</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">44</span><span class="w"> </span><span class="o">+</span><span class="mi">0800</span><span class="w"> </span><span class="n">CST</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">512</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">509</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="mi">6301447</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">6300936</span><span class="w">      </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">node2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">up</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">07</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">44</span><span class="w"> </span><span class="o">+</span><span class="mi">0800</span><span class="w"> </span><span class="n">CST</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">512</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">509</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">2</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="mi">6301447</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">6300936</span><span class="w">      </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------+--------------------+--------+-------+-------------------------------+---------+----------+------------+---------------+--------------+
</span><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">查看</span><span class="n">schema配置</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span><span class="s1">&#39;schema&#39;</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------+-----------+------------------+---------+------+--------------+-----------+---------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">User</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">DB</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="k">Table</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">Key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Nodes_List</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Locations</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">TableRowLimit</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------+-----------+------------------+---------+------+--------------+-----------+---------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">node1</span><span class="w">        </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">hash</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">node1</span><span class="p">,</span><span class="w"> </span><span class="n">node2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_range</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">range</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">node1</span><span class="p">,</span><span class="w"> </span><span class="n">node2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">10000</span><span class="w">         </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">root</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">node1</span><span class="w">        </span><span class="o">|</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">             </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------+-----------+------------------+---------+------+--------------+-----------+---------------+
</span><span class="c1"></span><span class="w">
</span><span class="w"></span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">查看白名单</span><span class="n">ip</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span><span class="s1">&#39;allow_ip&#39;</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">AllowIP</span><span class="w">      </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="w">    </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------+
</span><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">查看黑名单</span><span class="k">sql</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span><span class="s1">&#39;black_sql&#39;</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">BlackListSql</span><span class="w">                  </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="w">         </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">sbtest1</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------------------------------+
</span><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="修改kingshard配置">修改kingshard配置<a hidden class="anchor" aria-hidden="true" href="#修改kingshard配置">#</a></h2>
<p>为保证kingshard的安全性，管理端命令，只能通过root用户来操作，其他用户不能操作。也就是说用户列表中，需要配置一个root用户</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="err">关闭</span><span class="n">sql日志打印</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span><span class="s1">&#39;log_sql&#39;</span><span class="p">,</span><span class="s1">&#39;off&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">开启</span><span class="n">sql日志打印</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span><span class="s1">&#39;log_sql&#39;</span><span class="p">,</span><span class="s1">&#39;on&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">修改慢</span><span class="n">sql日志时间</span><span class="p">,</span><span class="w"> </span><span class="err">单位</span><span class="n">ms</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span><span class="s1">&#39;slow_log_time&#39;</span><span class="p">,</span><span class="s1">&#39;50&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">添加白名单</span><span class="n">IP</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">支持</span><span class="n">IP或IP段</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="s1">&#39;allow_ip&#39;</span><span class="p">,</span><span class="s1">&#39;192.168.14.0/24&#39;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="s1">&#39;allow_ip&#39;</span><span class="p">,</span><span class="s1">&#39;192.168.15.1&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">删除白名单</span><span class="n">IP</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span><span class="s1">&#39;allow_ip&#39;</span><span class="p">,</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">添加黑名单</span><span class="n">sql语句</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span><span class="s1">&#39;black_sql&#39;</span><span class="p">,</span><span class="s1">&#39;select count(*) from sbtest1&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">删除黑名单</span><span class="n">sql语句</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span><span class="s1">&#39;black_sql&#39;</span><span class="p">,</span><span class="s1">&#39;select count(*) from sbtest1&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">保存当前配置</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">,</span><span class="s1">&#39;proxy&#39;</span><span class="p">,</span><span class="s1">&#39;config&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>上面是通过命令方式修改部分kingshard的配置，但更推荐通过修改配置文件，然后动态加载的方式来热加载配置文件，步骤如下：</p>
<p>1.修改kingshard <strong>正在使用的配置文件</strong>，不能是kingshard未使用的文件</p>
<p>2.向kingshard发送USR1信号，kingshard就会加载新配置文件的全部内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">kill</span> -USR1 pid_of_kingshard
</code></pre></td></tr></table>
</div>
</div><h2 id="支持lvskeepalived">支持LVS/Keepalived<a hidden class="anchor" aria-hidden="true" href="#支持lvskeepalived">#</a></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="err">查看</span><span class="n">kingshard运行状态</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;show&#39;</span><span class="p">,</span><span class="s1">&#39;proxy&#39;</span><span class="p">,</span><span class="s1">&#39;status&#39;</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="err">改变</span><span class="n">kingshard运行状态</span><span class="w"> </span><span class="n">online</span><span class="p">:</span><span class="w"> </span><span class="err">在线</span><span class="w"> </span><span class="n">offline</span><span class="p">:</span><span class="w"> </span><span class="err">下线</span><span class="w">
</span><span class="w"></span><span class="k">admin</span><span class="w"> </span><span class="n">server</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span><span class="s1">&#39;proxy&#39;</span><span class="p">,</span><span class="s1">&#39;online&#39;</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h1 id="web-api">Web API<a hidden class="anchor" aria-hidden="true" href="#web-api">#</a></h1>
<h2 id="接口定义和参数说明">接口定义和参数说明<a hidden class="anchor" aria-hidden="true" href="#接口定义和参数说明">#</a></h2>
<ul>
<li>采用restful风格API设计。</li>
<li>假设kingshard的Web Server IP和端口是：127.0.0.1：9797，web用户名：admin，密码：admin</li>
</ul>
<h2 id="api接口导航">API接口导航<a hidden class="anchor" aria-hidden="true" href="#api接口导航">#</a></h2>
<ul>
<li><a href="#nodes_status">查看node的状态</a></li>
<li><a href="#nodes_slaves">添加slave</a></li>
<li><a href="#delete_slaves">删除slave</a></li>
<li><a href="#slaves_status">设置slave状态</a></li>
<li><a href="#masters_status">设置master状态</a></li>
<li><a href="#proxy_status">查看proxy状态</a></li>
<li><a href="#set_proxy_status">设置proxy状态</a></li>
<li><a href="#proxy_schema">查看proxy的schema</a></li>
<li><a href="#proxy_allow_ips">查看proxy的客户端白名单</a></li>
<li><a href="#add_allow_ips">添加proxy的客户端白名单</a></li>
<li><a href="#delete_allow_ips">删除proxy的客户端白名单</a></li>
<li><a href="#proxy_black_sqls">查看proxy的black_sql</a></li>
<li><a href="#add_black_sqls">增加proxy的black_sql</a></li>
<li><a href="#delete_black_sqls">删除proxy的black_sql</a></li>
<li><a href="#slow_sql_status">设置proxy的slow sql开关</a></li>
<li><a href="#slow_sql_time">查看proxy的slow sql的时间</a></li>
<li><a href="#set_slow_sql_time">设置proxy的slow sql的时间</a></li>
<li><a href="#save_config">保存proxy的配置</a></li>
</ul>
<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:GET
URL:http://127.0.0.1:9797/api/v1/nodes/status
参数：无
返回结果：node数组，node中包含Master和Slave信息，
字段意思参考配置文件说明
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X GET \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  127.0.0.1:9797/api/v1/nodes/status
 返回结果：
 [
    {
        &#34;node&#34;: &#34;node1&#34;,
        &#34;address&#34;: &#34;127.0.0.1:3307&#34;,
        &#34;type&#34;: &#34;master&#34;,
        &#34;status&#34;: &#34;up&#34;,
        &#34;laste_ping&#34;: &#34;2016-09-24 17:17:52 +0800 CST&#34;,
        &#34;max_conn&#34;: 32,
        &#34;idle_conn&#34;: 8,
        &#34;cache_conn&#34;:12,
        &#34;push_conn_count&#34;:32,
        &#34;pop_conn_count&#34;:0
    },
    {
        &#34;node&#34;: &#34;node2&#34;,
        &#34;address&#34;: &#34;127.0.0.1:3309&#34;,
        &#34;type&#34;: &#34;master&#34;,
        &#34;status&#34;: &#34;up&#34;,
        &#34;laste_ping&#34;: &#34;2016-09-24 17:17:52 +0800 CST&#34;,
        &#34;max_conn&#34;: 32,
        &#34;idle_conn&#34;: 8,
        &#34;cache_conn&#34;:12,
        &#34;push_conn_count&#34;:32,
        &#34;pop_conn_count&#34;:0
    }
]
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:POST
URL:http://127.0.0.1:9797/api/v1/nodes/slaves
参数：
- node：节点名字
- addr：slave的IP和端口
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> curl -X POST \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;node&#34;:&#34;node1&#34;,&#34;addr&#34;:&#34;127.0.0.1:3309&#34;}&#39; \
  127.0.0.1:9797/api/v1/nodes/slaves
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:DELETE
URL:http://127.0.0.1:9797/api/v1/nodes/slaves
参数：
- node：节点名字
- addr：slave的IP和端口
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> curl -X DELETE \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;node&#34;:&#34;node1&#34;,&#34;addr&#34;:&#34;127.0.0.1:3309&#34;}&#39; \
  127.0.0.1:9797/api/v1/nodes/slaves
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:PUT
URL：http://127.0.0.1:9797/api/v1/nodes/slaves/status
参数：
- opt：&#34;up&#34; or &#34;down&#34;，上线或下线slave
- node：节点名字
- addr：slave的IP和端口
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> curl -X PUT \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;opt&#34;:&#34;up&#34;,&#34;node&#34;:&#34;node1&#34;,&#34;addr&#34;:&#34;127.0.0.1:3309&#34;}&#39; \
  http://127.0.0.1:9797/api/v1/nodes/slaves/status
  返回结果：&#34;ok&#34;

</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:PUT
URL：http://127.0.0.1:9797/api/v1/nodes/masters/status
参数：
- opt：&#34;up&#34; or &#34;down&#34;，上线或下线slave
- node：节点名字
- addr：slave的IP和端口
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"> curl -X PUT \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;opt&#34;:&#34;down&#34;,&#34;node&#34;:&#34;node2&#34;,&#34;addr&#34;:&#34;127.0.0.1:3309&#34;}&#39; \
  http://127.0.0.1:9797/api/v1/nodes/masters/status
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:GET
URL:http://127.0.0.1:9797/api/v1/proxy/status
参数：无
返回结果：&#34;online&#34;或者&#34;offline&#34;
注意：该API主要用于配合LVS平滑下线
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X GET \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  http://127.0.0.1:9797/api/v1/proxy/status
 返回结果:&#34;online&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:PUT
URL:http://127.0.0.1:9797/api/v1/proxy/status
参数：opt:&#34;online&#34;或者&#34;offline&#34;
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
注意：该API主要用于配合LVS平滑下线

</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X PUT \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
   -d &#39;{&#34;opt&#34;:&#34;offline&#34;}&#39; \
  http://127.0.0.1:9797/api/v1/proxy/status
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action：GET
http://127.0.0.1:9797/api/v1/proxy/schema
参数：无
返回结果:schema数组，但只有一项。字段意思参考配置文件
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X GET \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  127.0.0.1:9797/api/v1/proxy/schema
返回结果：
[
    {
        &#34;user&#34;: &#34;kingshard&#34;,
        &#34;db&#34;: &#34;kingshard&#34;,
        &#34;Table&#34;: &#34;&#34;,
        &#34;Key&#34;: &#34;&#34;,
        &#34;Nodes&#34;: [
            &#34;node1&#34;,
            &#34;node2&#34;
        ],
        &#34;Locations&#34;: null,
        &#34;Type&#34;: &#34;default&#34;,
        &#34;TableRowLimit&#34;: 0,
        &#34;DateRange&#34;: null
    },
    {
        &#34;user&#34;: &#34;kingshard&#34;,
        &#34;db&#34;: &#34;kingshard&#34;,
        &#34;Table&#34;: &#34;test_shard_hash&#34;,
        &#34;Key&#34;: &#34;id&#34;,
        &#34;Nodes&#34;: [
            &#34;node1&#34;,
            &#34;node2&#34;
        ],
        &#34;Locations&#34;: [
            4,
            4
        ],
        &#34;Type&#34;: &#34;hash&#34;,
        &#34;TableRowLimit&#34;: 0,
        &#34;DateRange&#34;: null
    },
    {
        &#34;user&#34;: &#34;kingshard&#34;,
        &#34;db&#34;: &#34;kingshard&#34;,
        &#34;Table&#34;: &#34;test_shard_range&#34;,
        &#34;Key&#34;: &#34;id&#34;,
        &#34;Nodes&#34;: [
            &#34;node1&#34;,
            &#34;node2&#34;
        ],
        &#34;Locations&#34;: [
            4,
            4
        ],
        &#34;Type&#34;: &#34;range&#34;,
        &#34;TableRowLimit&#34;: 10000,
        &#34;DateRange&#34;: null
    },
    {
        &#34;user&#34;: &#34;kingshard&#34;,
        &#34;db&#34;: &#34;kingshard&#34;,
        &#34;Table&#34;: &#34;test_shard_time&#34;,
        &#34;Key&#34;: &#34;id&#34;,
        &#34;Nodes&#34;: [
            &#34;node1&#34;,
            &#34;node2&#34;
        ],
        &#34;Locations&#34;: [
            2,
            2
        ],
        &#34;Type&#34;: &#34;hash&#34;,
        &#34;TableRowLimit&#34;: 0,
        &#34;DateRange&#34;: null
    },
    {
        &#34;user&#34;: &#34;kingshard&#34;,
        &#34;db&#34;: &#34;kingshard&#34;,
        &#34;Table&#34;: &#34;test_shard_month&#34;,
        &#34;Key&#34;: &#34;dtime&#34;,
        &#34;Nodes&#34;: [
            &#34;node1&#34;,
            &#34;node2&#34;
        ],
        &#34;Locations&#34;: null,
        &#34;Type&#34;: &#34;date_month&#34;,
        &#34;TableRowLimit&#34;: 0,
        &#34;DateRange&#34;: [
            &#34;201603-201605&#34;,
            &#34;201609-201612&#34;
        ]
    },
    {
        &#34;user&#34;: &#34;kingshard&#34;,
        &#34;db&#34;: &#34;kingshard&#34;,
        &#34;Table&#34;: &#34;test_shard_day&#34;,
        &#34;Key&#34;: &#34;mtime&#34;,
        &#34;Nodes&#34;: [
            &#34;node1&#34;,
            &#34;node2&#34;
        ],
        &#34;Locations&#34;: null,
        &#34;Type&#34;: &#34;date_day&#34;,
        &#34;TableRowLimit&#34;: 0,
        &#34;DateRange&#34;: [
            &#34;20160306-20160307&#34;,
            &#34;20160308-20160309&#34;
        ]
    },
    {
        &#34;user&#34;: &#34;root&#34;,
        &#34;db&#34;: &#34;kingshard&#34;,
        &#34;Table&#34;: &#34;&#34;,
        &#34;Key&#34;: &#34;&#34;,
        &#34;Nodes&#34;: [
            &#34;node1&#34;,
            &#34;node2&#34;
        ],
        &#34;Locations&#34;: null,
        &#34;Type&#34;: &#34;default&#34;,
        &#34;TableRowLimit&#34;: 0,
        &#34;DateRange&#34;: null
    }
]
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action：GET
URL：http://127.0.0.1:9797/api/v1/proxy/allow_ips
参数：allow_ips，ip列表数组
返回结果：IP列表
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X GET \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  localhost:9797/api/v1/proxy/allow_ips
 返回结果：[&#34;127.0.0.1&#34;,&#34;192.168.0.14&#34;]
 
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action：POST
URL：http://127.0.0.1:9797/api/v1/proxy/allow_ips
参数：allow_ips，ip列表数组
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X POST \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;allow_ips&#34;:[&#34;127.0.0.1&#34;,&#34;192.168.14.0/24&#34;,&#34;192.168.0.223&#34;]}&#39; \
  127.0.0.1:9797/api/v1/proxy/allow_ips
  返回结果：&#34;ok&#34;
 
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action：DELETE
URL：http://127.0.0.1:9797/api/v1/proxy/allow_ips
参数：allow_ips，ip列表数组
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X DELETE \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;allow_ips&#34;:[&#34;192.168.0.14&#34;,&#34;192.168.0.223&#34;]}&#39; \
  127.0.0.1:9797/api/v1/proxy/allow_ips
  返回结果：&#34;ok&#34;
 
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:GET
http://127.0.0.1：9797/api/v1/proxy/black_sqls
参数：无
返回结果:sql列表
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X GET \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  127.0.0.1:9797/api/v1/proxy/black_sqls
返回结果：[&#34;delete from test_shard_range&#34;,&#34;delete from test_shard_hash&#34;]
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:POST
http://127.0.0.1:9797/api/v1/proxy/black_sqls
参数：sql（注意：一次只能添加一条SQL）
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;

</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X POST \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;sql&#34;:&#34;delete from test_shard_range&#34;}&#39; \
  127.0.0.1:9797/api/v1/proxy/black_sqls
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:DELETE
http:// 127.0.0.1:9797/api/v1/proxy/black_sqls
参数：sql（注意：一次只能删除一条SQL）
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X DELETE \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;sql&#34;:&#34;delete from test_shard_range&#34;}&#39; \
  127.0.0.1:9797/api/v1/proxy/black_sqls
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:PUT
URL:http://127.0.0.1:9797/api/v1/proxy/slow_sql/status
参数：opt(可选值：&#34;on&#34;,&#34;off&#34;)
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X PUT \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;opt&#34;:&#34;on&#34;}&#39; \
  127.0.0.1:9797/api/v1/proxy/slow_sql/status
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:GET
URL:http://127.0.0.1:9797/api/v1/proxy/slow_sql/time
参数：无
返回结果：slow_log 时间，单位ms
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X GET \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  127.0.0.1:9797/api/v1/proxy/slow_sql/time
  返回结果：500
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:PUT
URL:http://127.0.0.1:9797/api/v1/proxy/slow_sql/time
参数：slow_time(慢日志时间，单位ms。执行时间超过该值的SQL会输出到慢日志文件)
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X PUT \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  -d &#39;{&#34;slow_time&#34;:500}&#39; \
  127.0.0.1:9797/api/v1/proxy/slow_sql/time
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Action:PUT
URL:http://127.0.0.1:9797/api/v1/proxy/config/save
参数：无
返回结果：成功:&#34;ok&#34;,失败：&#34;error message&#34;
说明：将kingshard的配置写入文件
</code></pre></td></tr></table>
</div>
</div><p><strong>示例</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">curl -X PUT \
  -H &#39;Content-Type: application/json&#39; \
  -u admin:admin \
  127.0.0.1:9797/api/v1/proxy/config/save
  返回结果：&#34;ok&#34;
</code></pre></td></tr></table>
</div>
</div><p>转载:<a href="https://github.com/flike/kingshard/blob/master/README_ZH.md">https://github.com/flike/kingshard/blob/master/README_ZH.md</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/kingshard/">Kingshard</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
