<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Go中的Json编解码总结 - Forz</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Forz" /><meta name="description" content="编码 数据结构map json源于javascript的对象结构，golang中直接对应其数据结构，可是golang的map也是key-valu" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.55.6 with theme even" />


<link rel="canonical" href="http://localhost:1313/forz/post/go%E4%B8%AD%E7%9A%84json%E7%BC%96%E8%A7%A3%E7%A0%81%E6%80%BB%E7%BB%93/" />
<link rel="apple-touch-icon" sizes="180x180" href="/forz/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/forz/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/forz/favicon-16x16.png">
<link rel="manifest" href="/forz/manifest.json">
<link rel="mask-icon" href="/forz/safari-pinned-tab.svg" color="#5bbad5">


<link href="/forz/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Go中的Json编解码总结" />
<meta property="og:description" content="编码 数据结构map json源于javascript的对象结构，golang中直接对应其数据结构，可是golang的map也是key-valu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/forz/post/go%E4%B8%AD%E7%9A%84json%E7%BC%96%E8%A7%A3%E7%A0%81%E6%80%BB%E7%BB%93/" />
<meta property="article:published_time" content="2018-11-15T18:25:06&#43;00:00"/>
<meta property="article:modified_time" content="2018-11-15T18:25:06&#43;00:00"/>

<meta itemprop="name" content="Go中的Json编解码总结">
<meta itemprop="description" content="编码 数据结构map json源于javascript的对象结构，golang中直接对应其数据结构，可是golang的map也是key-valu">


<meta itemprop="datePublished" content="2018-11-15T18:25:06&#43;00:00" />
<meta itemprop="dateModified" content="2018-11-15T18:25:06&#43;00:00" />
<meta itemprop="wordCount" content="10614">



<meta itemprop="keywords" content="Json," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go中的Json编解码总结"/>
<meta name="twitter:description" content="编码 数据结构map json源于javascript的对象结构，golang中直接对应其数据结构，可是golang的map也是key-valu"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/forz/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/forz/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/forz/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/forz/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/forz/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/forz/" class="logo">Forz Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/forz/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/forz/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/forz/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/forz/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Go中的Json编解码总结</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-11-15 </span>
        <div class="post-category">
            <a href="/forz/categories/go/"> Go </a>
            </div>
          <span class="more-meta"> 约 10614 字 </span>
          <span class="more-meta"> 预计阅读 22 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#编码">编码</a>
<ul>
<li><a href="#数据结构map">数据结构map</a></li>
<li><a href="#基本结构编码">基本结构编码</a></li>
<li><a href="#复合结构编码">复合结构编码</a></li>
<li><a href="#嵌套编码">嵌套编码</a></li>
<li><a href="#structtag-字段重名">StructTag 字段重名</a>
<ul>
<li><a href="#忽略字段">-忽略字段</a></li>
<li><a href="#omitempty可选字段">omitempty可选字段</a></li>
<li><a href="#string选项">string选项</a></li>
</ul></li>
</ul></li>
<li><a href="#解码">解码</a>
<ul>
<li><a href="#定义结构">定义结构</a></li>
<li><a href="#string-tag">string tag</a></li>
<li><a href="#tag">- tag</a></li>
<li><a href="#decode">Decode</a></li>
<li><a href="#unmarshal-vs-decode">Unmarshal vs Decode</a></li>
<li><a href="#动态解析">动态解析</a>
<ul>
<li><a href="#interface">interface{}</a></li>
<li><a href="#延迟解析">延迟解析</a></li>
</ul></li>
<li><a href="#不定字段解析">不定字段解析</a>
<ul>
<li><a href="#接口配合断言">接口配合断言</a></li>
<li><a href="#混合结构">混合结构</a></li>
<li><a href="#json-rawmessage">json.RawMessage</a></li>
</ul></li>
<li><a href="#数字的解析">数字的解析</a>
<ul>
<li><a href="#float64与int64">float64与int64</a></li>
<li><a href="#float64的科学计数法">float64的科学计数法</a></li>
<li><a href="#json-number">json.Number</a>
<ul>
<li><a href="#解析大数">解析大数</a></li>
<li><a href="#解析整型和字符串">解析整型和字符串</a></li>
<li><a href="#解析固定位数的浮点数">解析固定位数的浮点数</a></li>
<li><a href="#原理">原理</a></li>
</ul></li>
</ul></li>
<li><a href="#time-time的编解码">time.time的编解码</a></li>
<li><a href="#nil的编码解码">nil的编码解码</a></li>
<li><a href="#总结">总结</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      

<h1 id="编码">编码</h1>

<h2 id="数据结构map">数据结构map</h2>

<p>json源于javascript的对象结构，golang中直接对应其数据结构，可是golang的map也是key-value结构，同时struct结构体也可以描述json。当然，对于json的数据类型，go也会有对象的结构所匹配。大致对应关系如下：</p>

<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/WX20180812-103146@2x.png" alt="" /></p>

<h2 id="基本结构编码">基本结构编码</h2>

<p>golang提供了encoding/json的标准库用于编码json。大致需要两步：</p>

<ol>
<li>首先定义json结构体。</li>
<li>使用 Marshal方法序列化。</li>
</ol>

<p>定义结构体的时候，<strong>只有字段名是大写的，才会被编码到json当中。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email string
    password string
    Money float64
}

func main() {
    account := Account{
        Email: &#34;rsj217@gmail.com&#34;,
        password: &#34;123456&#34;,
        Money: 100.5,
    }

    rs, err := json.Marshal(account)
    if err != nil{
        log.Fatalln(err)
    }

    fmt.Println(rs)
    fmt.Println(string(rs))
}</pre></td></tr></table>
</div>
</div>
<p>可以看到输出如下，Marshal方法接受一个空接口的参数，返回一个[]byte结构。小写命名的password字段没有被编码到json当中，生成的json结构字段和Account结构一致。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">[123 34 69 109 97 105 108 34 58 34 114 115 106 50 49 55 64 103 109 97 105 108 46 99 111 109 34 44 34 77 111 110 101 121 34 58 49 48 48 46 53 125]
{&#34;Email&#34;:&#34;rsj217@gmail.com&#34;,&#34;Money&#34;:100.5}</pre></td></tr></table>
</div>
</div>
<h2 id="复合结构编码">复合结构编码</h2>

<p>相比字串，数字等基本数据结构，slice切片，map图则是复合结构。这些结构编码也类似。不过map的key必须是字串，而value必须是同一类型的数据。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Name</span>  <span class="kt">string</span>
	<span class="nx">Age</span>   <span class="kt">int</span>
	<span class="nx">Roles</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="nx">Skill</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">float64</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">skill</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">float64</span><span class="p">)</span>

	<span class="nx">skill</span><span class="p">[</span><span class="s">&#34;python&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mf">99.5</span>
	<span class="nx">skill</span><span class="p">[</span><span class="s">&#34;elixir&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mi">90</span>
	<span class="nx">skill</span><span class="p">[</span><span class="s">&#34;ruby&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="mf">80.0</span>

	<span class="nx">user</span> <span class="o">:=</span> <span class="nx">User</span><span class="p">{</span>
		<span class="nx">Name</span><span class="p">:</span>  <span class="s">&#34;rsj217&#34;</span><span class="p">,</span>
		<span class="nx">Age</span><span class="p">:</span>   <span class="mi">27</span><span class="p">,</span>
		<span class="nx">Roles</span><span class="p">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;Owner&#34;</span><span class="p">,</span> <span class="s">&#34;Master&#34;</span><span class="p">},</span>
		<span class="nx">Skill</span><span class="p">:</span> <span class="nx">skill</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">rs</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">user</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">rs</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;Name&#34;</span><span class="p">:</span><span class="s2">&#34;rsj217&#34;</span><span class="p">,</span>
    <span class="nt">&#34;Age&#34;</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span>
    <span class="nt">&#34;Roles&#34;</span><span class="p">:[</span>
        <span class="s2">&#34;Owner&#34;</span><span class="p">,</span>
        <span class="s2">&#34;Master&#34;</span>
    <span class="p">],</span>
    <span class="nt">&#34;Skill&#34;</span><span class="p">:{</span>
        <span class="nt">&#34;elixir&#34;</span><span class="p">:</span><span class="mi">90</span><span class="p">,</span>
        <span class="nt">&#34;python&#34;</span><span class="p">:</span><span class="mf">99.5</span><span class="p">,</span>
        <span class="nt">&#34;ruby&#34;</span><span class="p">:</span><span class="mi">80</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="嵌套编码">嵌套编码</h2>

<p>slice和map可以匹配json的数组和对象，当前提是对象的value是同类型的情况。更通用的做法，对象的key可以是string，但是其值可以是多种结构。golang可以通过定义结构体实现这种构造：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email string
    password string
    Money float64
}

type User struct {
    Name    string
    Age     int
    Roles   []string
    Skill   map[string]float64
    Account Account
}

func main(){

    ...

        user := User{
        Name:&#34;rsj217&#34;,
        Age: 27,
        Roles: []string{&#34;Owner&#34;, &#34;Master&#34;},
        Skill: skill,
        Account:account,
    }
    ...
}</pre></td></tr></table>
</div>
</div>
<p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></pre></td>
<td class="lntd">
<pre class="chroma">{
    &#34;Name&#34;:&#34;rsj217&#34;,
    &#34;Age&#34;:27,
    &#34;Roles&#34;:[
        &#34;Owner&#34;,
        &#34;Master&#34;
    ],
    &#34;Skill&#34;:{
        &#34;elixir&#34;:90,
        &#34;python&#34;:99.5,
        &#34;ruby&#34;:80
    },
    &#34;Account&#34;:{
        &#34;Email&#34;:&#34;rsj217@gmail.com&#34;,
        &#34;Money&#34;:100.5
    }
}</pre></td></tr></table>
</div>
</div>
<p>通过定义嵌套的结构体Account，实现了key与value不一样的结构。golang的数组或切片，其类型也是一样的，如果遇到不同数据类型的数组，则需要借助空结构来实现：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></pre></td>
<td class="lntd">
<pre class="chroma">type User struct {
    ...

    Extra []interface{}
}

extra := []interface{}{123, &#34;hello world&#34;}

user := User{
    ...

    Extra:   extra,
}</pre></td></tr></table>
</div>
</div>
<p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></pre></td>
<td class="lntd">
<pre class="chroma">{
    ...
    &#34;Extra&#34;:[
        123,
        &#34;hello world&#34;
    ]
}</pre></td></tr></table>
</div>
</div>
<p>使用空接口，也可以定义像结构体实现那种不同value类型的字典结构。当空接口没有初始化其值的时候，零值是 nil。编码成json就是 null</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></pre></td>
<td class="lntd">
<pre class="chroma">type User struct {
    Name    string
    Age     int
    Roles   []string
    Skill   map[string]float64
    Account Account

    Extra []interface{}

    Level map[string]interface{}
}


func main() {

    ...

    level := make(map[string]interface{})

    level[&#34;web&#34;] = &#34;Good&#34;
    level[&#34;server&#34;] = 90
    level[&#34;tool&#34;] = nil

    user := User{
        Name:    &#34;rsj217&#34;,
        Age:     27,
        Roles:   []string{&#34;Owner&#34;, &#34;Master&#34;},
        Skill:   skill,
        Account: account,
        Level:   level,
    }

    ...
}</pre></td></tr></table>
</div>
</div>
<p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></pre></td>
<td class="lntd">
<pre class="chroma">{
    ...
    &#34;Extra&#34;:null,
    &#34;Level&#34;:{
        &#34;server&#34;:90,
        &#34;tool&#34;:null,
        &#34;web&#34;:&#34;Good&#34;
    }
}</pre></td></tr></table>
</div>
</div>
<p>可以看到 Extra返回的并不是一个空的切片，而是null。同时Level字段实现了向字典的嵌套结构。</p>

<h2 id="structtag-字段重名">StructTag 字段重名</h2>

<p>通过上面的例子，我们看到了Level字段中的keyserver等是小写字母，其他的都是大写字母。因为我们在定义结构的时候，只有使用大写字母开头的字段才会被导出。而通常json世界中，更盛行小写字母的方式。看起来就成了一个矛盾。其实不然，golang提供了struct tag的方式可以重命名结构字段的输出形式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    Password string  `json:&#34;pass_word&#34;`
    Money    float64 `json:&#34;money&#34;`
}

func main() {
    account := Account{
        Email:    &#34;rsj217@gmail.com&#34;,
        Password: &#34;123456&#34;,
        Money:    100.5,
    }

    rs, err := json.Marshal(account)
    ...
}</pre></td></tr></table>
</div>
</div>
<p>我们使用struct tag，重新给Aaccount结构的字段进行了重命名。其中email小写了，并且password字段还使用了下划线，输出的结果如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">{&#34;email&#34;:&#34;rsj217@gmail.com&#34;,&#34;pass_word&#34;:&#34;123456&#34;,&#34;money&#34;:100.5}</pre></td></tr></table>
</div>
</div>
<h3 id="忽略字段">-忽略字段</h3>

<p>重命名这个利器还提供了更高级的选项。通常使用marshal的时候，会把结构体的所有除了私有字段都编码到json，而实际开发中，我们定义的结构可能更通用，我们需要某个字段可以导出，但是又不能编码到json中。</p>

<p>此时使用 struact tag的 -符号就能完美解决，我们已经知道_常用于忽略字段的占位，在tag中则使用短横线-。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    Password string  `json:&#34;-&#34;`
    Money    float64 `json:&#34;money&#34;`
}</pre></td></tr></table>
</div>
</div>
<p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">{&#34;email&#34;:&#34;rsj217@gmail.com&#34;,&#34;money&#34;:100.5}</pre></td></tr></table>
</div>
</div>
<p>可见即使Password不是私有字段，因为-忽略了它，因此没有被编码到json输出。</p>

<h3 id="omitempty可选字段">omitempty可选字段</h3>

<p>对于另外一种字段，当其有值的时候就输出，而没有值(零值)的时候就不输出，则可以使用另外一种选项omitempty。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    Password string  `json:&#34;password,omitempty&#34;`
    Money    float64 `json:&#34;money&#34;`
}
func main() {
    account := Account{
        Email:    &#34;rsj217@gmail.com&#34;,
        Password: &#34;&#34;,
        Money:    100.5,
    }
    ...
}</pre></td></tr></table>
</div>
</div>
<p>此时password不会被编码到json输出中。</p>

<h3 id="string选项">string选项</h3>

<p>golang是静态类型语言，对于类型定义的是不能动态修改。在json处理当中，struct tag的string可以起到部分动态类型的效果。有时候输出的json希望是数字的字符串，而定义的字段是数字类型，那么就可以使用string选项。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    Password string  `json:&#34;password,omitempty&#34;`
    Money    float64 `json:&#34;money,string&#34;`
}
func main() {
    account := Account{
        Email:    &#34;rsj217@gmail.com&#34;,
        Password: &#34;123&#34;,
        Money:    100.50,
    }

    ...
}</pre></td></tr></table>
</div>
</div>
<p>可以看到输出为 money: &ldquo;100.5&rdquo;， money字段的值是字串。</p>

<h1 id="解码">解码</h1>

<h2 id="定义结构">定义结构</h2>

<p>与编码json的Marshal类似，解析json也提供了Unmarshal方法。对于解析json，也大致分两步，首先定义结构，然后调用Unmarshal方法序列化。我们先从简单的例子开始吧</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    Password string  `json:&#34;password&#34;`
    Money    float64 `json:&#34;money&#34;`
}

var jsonString string = `{
    &#34;email&#34;:&#34;rsj217@gmail.com&#34;,
    &#34;password&#34;:&#34;123&#34;,
    &#34;money&#34;:100.5
}`

func main() {

    account := Account{}

    err := json.Unmarshal([]byte(jsonString), &amp;account)
    if err != nil{
        log.Fatalln(err)
    }
    fmt.Printf(&#34;%+v\n&#34;, account)
}</pre></td></tr></table>
</div>
</div>
<p>Unmarshal接受一个byte数组和空接口指针的参数。和sql中读取数据类似，先定义一个数据实例，然后传其指针地址。</p>

<p>与编码类似，golang会将json的数据结构和go的数据结构进行匹配。<strong>匹配的原则就是寻找tag的相同的字段，然后查找字段。</strong>查询的时候是大小写不敏感的:把 Password的tag去掉，再修改成PassWord，依然可以把json的password匹配到PassWord.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    PassWord string  
    Money    float64 `json:&#34;money&#34;`
}</pre></td></tr></table>
</div>
</div>
<p>输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">{Email:rsj217@gmail.com PassWord:123 Money:100.5}</pre></td></tr></table>
</div>
</div>
<p>但是如果结构的字段是私有的，即使tag符合，也不会被解析：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    password string  `json:&#34;password&#34;`
    Money    float64 `json:&#34;money&#34;`
}</pre></td></tr></table>
</div>
</div>
<p>输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">{Email:rsj217@gmail.com password: Money:100.5}</pre></td></tr></table>
</div>
</div>
<p>上面的password并不会被解析赋值json的password，大小写不敏感只是针对公有字段而言。再寻找tag或字段的时候匹配不成功，则会抛弃这个json字段的值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    Password string  `json:&#34;password&#34;`
}</pre></td></tr></table>
</div>
</div>
<p>输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">{Email:rsj217@gmail.com Password:&#34;123&#34;}</pre></td></tr></table>
</div>
</div>
<p>并不会有money字段被赋值。</p>

<h2 id="string-tag">string tag</h2>

<p>在编码的时候，我们使用tag string，可以把结构定义的数字类型以字串形式编码。同样在解码的时候，<strong>只有字串类型的数字，才能被正确解析，或者会报错</strong>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    Password string  `json:&#34;password&#34;`
    Money    float64 `json:&#34;money,string&#34;`
}

var jsonString string = `{
    &#34;email&#34;:&#34;rsj217@gmail.com&#34;,
    &#34;password&#34;:&#34;123&#34;,
    &#34;money&#34;:&#34;100.5&#34;
}`

func main() {

    account := Account{}

    err := json.Unmarshal([]byte(jsonString), &amp;account)
    if err != nil{
        log.Fatalln(err)
    }
    fmt.Printf(&#34;%+v\n&#34;, account)
}</pre></td></tr></table>
</div>
</div>
<p>输出</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">{Email:rsj217@gmail.com Password:123 Money:100.5}</pre></td></tr></table>
</div>
</div>
<p>Money是float64类型。</p>

<p>如果json的money是100.5， 会得到下面的错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">2016/12/23 18:12:32 json: invalid use of ,string struct tag, trying to unmarshal unquoted value into float64
exit status 1</pre></td></tr></table>
</div>
</div>
<h2 id="tag">- tag</h2>

<p>与编码一样，tag的-也不会被解析，但是会初始化其零值：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Account struct {
    Email    string  `json:&#34;email&#34;`
    Password string  `json:&#34;password&#34;`
    Money    float64 `json:&#34;-&#34;`
}</pre></td></tr></table>
</div>
</div>
<p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">{Email:rsj217@gmail.com Password:123 Money:0}</pre></td></tr></table>
</div>
</div>
<h2 id="decode">Decode</h2>

<p>前面我们使用了简单的方法Unmarshal直接解析json字串，下面我们使用更底层的方法NewDecode和Decode方法。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></pre></td>
<td class="lntd">
<pre class="chroma">type User struct {
    UserName string `json:&#34;username&#34;`
    Password string     `json:&#34;password&#34;`
}

var jsonString string = `{
    &#34;username&#34;:&#34;rsj217@gmail.com&#34;,
    &#34;password&#34;:&#34;123&#34;
}`

func Decode(r io.Reader)(u *User, err error)  {
    u = new(User)
    err = json.NewDecoder(r).Decode(u)
    if err != nil{
        return
    }
    return
}

func main() {
    user, err := Decode(strings.NewReader(jsonString))
    if err !=nil{
        log.Fatalln(err)
    }
    fmt.Printf(&#34;%#v\n&#34;,user)
}</pre></td></tr></table>
</div>
</div>
<p>我们定义了一个Decode函数，在这个函数进行json字串的解析:调用json的NewDecoder方法构造一个Decode对象，使用这个对象的Decode方法赋值给定义好的结构对象。</p>

<p>对于字串，可以使用strings.NewReader方法，让字串变成一个Stream对象。</p>

<h2 id="unmarshal-vs-decode">Unmarshal vs Decode</h2>

<p>选择哪个要视输入而定。</p>

<p>json.Unmarshal 操作对象是一个 []byte，也就意味着被处理的JSON要全部加载到内存。如果有一个加载完的JSON使用json.Unmarshal会快一些。</p>

<p>json.Decoder 操作的是一个stream，或者其他实现了io.Reader接口的类型。意味着可以在接收或传输的同时对其进行解析。当处理一组较大数据时无需重新copy整个JSON到内存中。</p>

<p>最好的选择办法如下：</p>

<ul>
<li>如果数据来自一个io.Reader或者需要从一个stream中读取数据，就选择json.Decoder</li>
<li>如果已经将整个JSON加载到内存中了就使用json.Unmarshal</li>
</ul>

<h2 id="动态解析">动态解析</h2>

<p>通常根据json的格式预先定义golang的结构进行解析是最理想的情况。可是实际开发中，理想的情况往往都存在理想的愿望之中，很多json非但格式不确定，有的还可能是动态数据类型。</p>

<p>例如通常登录的时候，往往既可以使用手机号做用户名，也可以使用邮件做用户名，客户端传的json可以是字串，也可以是数字。此时服务端解析就需要技巧了。</p>

<h3 id="interface">interface{}</h3>

<p>如果客户端传的username的值是一个数字类型的手机号，那么上面的解析方法将会失败。正如我们之前所介绍的动态类型行为一样，使用interface{}可以hold住这样的情景。</p>

<p>使用 Golang 解析 JSON  格式数据时，若以 interface{} 接收数据，则会按照下列规则进行解析：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kt">bool</span><span class="p">,</span> <span class="k">for</span> <span class="nx">JSON</span> <span class="nx">booleans</span>

<span class="kt">float64</span><span class="p">,</span> <span class="k">for</span> <span class="nx">JSON</span> <span class="nx">numbers</span>

<span class="kt">string</span><span class="p">,</span> <span class="k">for</span> <span class="nx">JSON</span> <span class="nx">strings</span>

<span class="p">[]</span><span class="kd">interface</span><span class="p">{},</span> <span class="k">for</span> <span class="nx">JSON</span> <span class="nx">arrays</span>

<span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{},</span> <span class="k">for</span> <span class="nx">JSON</span> <span class="nx">objects</span>

<span class="kc">nil</span> <span class="k">for</span> <span class="nx">JSON</span> <span class="nx">null</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">UserName</span> <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;username&#34;`</span>
    <span class="nx">Password</span> <span class="kt">string</span>      <span class="s">`json:&#34;password&#34;`</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>先统一解组到interface{} 然后判断关键字段再进行后续处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Data</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Type</span> <span class="kt">string</span>      <span class="s">`json:&#34;type&#34;`</span>
    <span class="nx">Id</span>   <span class="kd">interface</span><span class="p">{}</span> <span class="s">`json:&#34;id&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">decode</span><span class="p">(</span><span class="nx">t</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="nx">Data</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">x</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="s">&#34;a&#34;</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">Id</span><span class="p">.(</span><span class="kt">string</span><span class="p">))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">Id</span><span class="p">.(</span><span class="kt">float64</span><span class="p">))</span> <span class="c1">//json解析中number默认作为float64解析
</span><span class="c1"></span>    <span class="p">}</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">t1</span> <span class="o">:=</span> <span class="s">`{&#34;type&#34;:&#34;a&#34;, &#34;id&#34;:&#34;aaa&#34;}`</span>
    <span class="nx">t2</span> <span class="o">:=</span> <span class="s">`{&#34;type&#34;:&#34;b&#34;, &#34;id&#34;:22222}`</span>

    <span class="nf">decode</span><span class="p">(</span><span class="nx">t1</span><span class="p">)</span>
    <span class="nf">decode</span><span class="p">(</span><span class="nx">t2</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="延迟解析">延迟解析</h3>

<p>因为UserName字段，实际上是在使用的时候，才会用到他的具体类型，因此我们可以延迟解析。使用json.RawMessage方式，将json的字符串继续以byte数组方式存在。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">UserName</span> <span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span> <span class="s">`json:&#34;username&#34;`</span>
    <span class="nx">Password</span> <span class="kt">string</span>      <span class="s">`json:&#34;password&#34;`</span>
    <span class="nx">Email</span> <span class="kt">string</span>
    <span class="nx">Phone</span> <span class="kt">int64</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">jsonString</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`{
</span><span class="s">    &#34;username&#34;:&#34;18512341234@qq.com&#34;,
</span><span class="s">    &#34;password&#34;:&#34;123&#34;
</span><span class="s">}`</span>
<span class="kd">func</span> <span class="nf">Decode</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span><span class="nx">User</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">u</span> <span class="p">=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">User</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">r</span><span class="p">).</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">u</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
        <span class="k">return</span>	
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">email</span> <span class="kt">string</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">UserName</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">email</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">{</span>
        <span class="nx">u</span><span class="p">.</span><span class="nx">Email</span> <span class="p">=</span> <span class="nx">email</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">phone</span> <span class="kt">int64</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">UserName</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">phone</span><span class="p">);</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">{</span>
        <span class="nx">u</span><span class="p">.</span><span class="nx">Phone</span> <span class="p">=</span> <span class="nx">phone</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">user</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Decode</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nf">Fatalln</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%#v\n&#34;</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>总体而言，延迟解析和使用空接口的方式类似。需要再次调用Unmarshal方法，对json.RawMessage进行解析。原理和解析到接口的形式类似。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Resp</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Type</span> <span class="kt">string</span>          <span class="s">`json:&#34;type&#34;`</span>
    <span class="nx">Data</span> <span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span> <span class="s">`json:&#34;data&#34;`</span>
<span class="p">}</span>
<span class="kd">type</span> <span class="nx">Data</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Id</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Number</span> <span class="s">`json:&#34;id&#34;`</span> <span class="c1">//处理大数
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">t</span> <span class="o">:=</span> <span class="s">`{&#34;type&#34;: &#34;a&#34;, &#34;data&#34;:{&#34;id&#34;: 1234567890123456789012345}}`</span>

    <span class="kd">var</span> <span class="nx">x</span> <span class="nx">Resp</span>
    <span class="kd">var</span> <span class="nx">y</span> <span class="nx">Data</span>

    <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">x</span><span class="p">)</span>

    <span class="c1">//进一步解组
</span><span class="c1"></span>    <span class="k">if</span> <span class="s">&#34;a&#34;</span> <span class="o">==</span> <span class="nx">x</span><span class="p">.</span><span class="nx">Type</span> <span class="p">{</span>
        <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">y</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">Id</span><span class="p">)</span>

    <span class="nx">r</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">r</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="不定字段解析">不定字段解析</h2>

<p>对于未知json结构的解析，不同的数据类型可以映射到接口或者使用延迟解析。有时候，会遇到json的数据字段都不一样的情况。例如需要解析下面一个json字串：</p>

<h3 id="接口配合断言">接口配合断言</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">jsonString</span> <span class="kt">string</span> <span class="p">=</span> <span class="s">`{
</span><span class="s">        &#34;things&#34;: [
</span><span class="s">            {
</span><span class="s">                &#34;name&#34;: &#34;Alice&#34;,
</span><span class="s">                &#34;age&#34;: 37
</span><span class="s">            },
</span><span class="s">            {
</span><span class="s">                &#34;city&#34;: &#34;Ipoh&#34;,
</span><span class="s">                &#34;country&#34;: &#34;Malaysia&#34;
</span><span class="s">            },
</span><span class="s">            {
</span><span class="s">                &#34;name&#34;: &#34;Bob&#34;,
</span><span class="s">                &#34;age&#34;: 36
</span><span class="s">            },
</span><span class="s">            {
</span><span class="s">                &#34;city&#34;: &#34;Northampton&#34;,
</span><span class="s">                &#34;country&#34;: &#34;England&#34;
</span><span class="s">            }
</span><span class="s">        ]
</span><span class="s">    }`</span></code></pre></td></tr></table>
</div>
</div>
<p>json字串的是一个对象，其中一个key things的值是一个数组，这个数组的每一个item都未必一样，大致是两种数据结构，可以抽象为person和place。即，定义下面的结构体：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span> <span class="kt">string</span> <span class="s">`json:&#34;name&#34;`</span>
    <span class="nx">Age</span>  <span class="kt">int</span>    <span class="s">`json:&#34;age&#34;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Place</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">City</span>    <span class="kt">string</span> <span class="s">`json:&#34;city&#34;`</span>
    <span class="nx">Country</span> <span class="kt">string</span> <span class="s">`json:&#34;country&#34;`</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>接下来我们Unmarshal json字串到一个map结构，然后迭代item并使用type断言的方式解析数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">decode</span><span class="p">(</span><span class="nx">jsonStr</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">persons</span> <span class="p">[]</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">places</span> <span class="p">[]</span><span class="nx">Place</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span><span class="p">[</span><span class="s">&#34;things&#34;</span><span class="p">]</span> <span class="p">{</span>
        <span class="nx">item</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">[</span><span class="s">&#34;things&#34;</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">item</span><span class="p">[</span><span class="s">&#34;name&#34;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">persons</span> <span class="p">=</span> <span class="nf">addPerson</span><span class="p">(</span><span class="nx">persons</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">places</span> <span class="p">=</span> <span class="nf">addPlace</span><span class="p">(</span><span class="nx">places</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>迭代的时候会判断item是否是person还是place，然后调用对应的解析方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">addPerson</span><span class="p">(</span><span class="nx">persons</span> <span class="p">[]</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">item</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span> <span class="p">[]</span><span class="nx">Person</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">:=</span> <span class="nx">item</span><span class="p">[</span><span class="s">&#34;name&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
    <span class="nx">age</span> <span class="o">:=</span> <span class="nx">item</span><span class="p">[</span><span class="s">&#34;age&#34;</span><span class="p">].(</span><span class="kt">float64</span><span class="p">)</span>
    <span class="nx">person</span> <span class="o">:=</span> <span class="nx">Person</span><span class="p">{</span><span class="nx">name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">age</span><span class="p">)}</span>
    <span class="nx">persons</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">persons</span><span class="p">,</span> <span class="nx">person</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">persons</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">addPlace</span><span class="p">(</span><span class="nx">places</span> <span class="p">[]</span><span class="nx">Place</span><span class="p">,</span> <span class="nx">item</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})([]</span><span class="nx">Place</span><span class="p">){</span>
    <span class="nx">city</span> <span class="o">:=</span> <span class="nx">item</span><span class="p">[</span><span class="s">&#34;city&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
    <span class="nx">country</span> <span class="o">:=</span> <span class="nx">item</span><span class="p">[</span><span class="s">&#34;country&#34;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
    <span class="nx">place</span> <span class="o">:=</span> <span class="nx">Place</span><span class="p">{</span><span class="nx">City</span><span class="p">:</span><span class="nx">city</span><span class="p">,</span> <span class="nx">Country</span><span class="p">:</span><span class="nx">country</span><span class="p">}</span>
    <span class="nx">places</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">places</span><span class="p">,</span> <span class="nx">place</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">places</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>最后调用如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">personsA</span><span class="p">,</span> <span class="nx">placesA</span> <span class="o">:=</span> <span class="nf">decode</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jsonString</span><span class="p">))</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v\n&#34;</span><span class="p">,</span> <span class="nx">personsA</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v\n&#34;</span><span class="p">,</span> <span class="nx">placesA</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>输出如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">[{Name:Alice Age:37} {Name:Bob Age:36}]
[{City:Ipoh Country:Malaysia} {City:Northampton Country:England}]</pre></td></tr></table>
</div>
</div>
<h3 id="混合结构">混合结构</h3>

<p>混合结构很好理解，如同我们前面解析username为 email和phone两种情况，就在结构中定义好这两种结构即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></pre></td>
<td class="lntd">
<pre class="chroma">type Mixed struct {
    Name    string `json:&#34;name&#34;`
    Age     int    `json:&#34;age&#34;`
    city    string `json:&#34;city&#34;`
    Country string `json:&#34;country&#34;`
}</pre></td></tr></table>
</div>
</div>
<p>混合结构的思路很简单，借助golang会初始化没有匹配的json和抛弃没有匹配的json，给特定的字段赋值。比如每一个item都具有四个字段，只不过有的会匹配person的json数据，有的则是匹配place。没有匹配的字段则是零值。接下来在根据item的具体情况，分别赋值到对于的Person或Place结构。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">decode</span><span class="p">(</span><span class="nx">jsonStr</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">persons</span> <span class="p">[]</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">places</span> <span class="p">[]</span><span class="nx">Place</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="nx">Mixed</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v\n&#34;</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="s">&#34;things&#34;</span><span class="p">])</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span><span class="p">[</span><span class="s">&#34;things&#34;</span><span class="p">]</span> <span class="p">{</span>
        <span class="nx">item</span> <span class="o">:=</span> <span class="nx">data</span><span class="p">[</span><span class="s">&#34;things&#34;</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Name</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
            <span class="nx">persons</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">persons</span><span class="p">,</span> <span class="nx">Person</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span> <span class="nx">Age</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Age</span><span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">places</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">places</span><span class="p">,</span> <span class="nx">Place</span><span class="p">{</span><span class="nx">City</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">city</span><span class="p">,</span> <span class="nx">Country</span><span class="p">:</span> <span class="nx">item</span><span class="p">.</span><span class="nx">Country</span><span class="p">})</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>混合结构的解析方式也很不错。思路还是借助了解析json中抛弃不要的字段，借助零值处理。</p>

<h3 id="json-rawmessage">json.RawMessage</h3>

<p>json.RawMessage非常有用，延迟解析也可以使用这个样例。我们已经介绍过类似的技巧，下面就贴代码了：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">addPerson</span><span class="p">(</span><span class="nx">item</span> <span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">,</span> <span class="nx">persons</span> <span class="p">[]</span><span class="nx">Person</span><span class="p">)([]</span><span class="nx">Person</span><span class="p">){</span>
    <span class="nx">person</span> <span class="o">:=</span> <span class="nx">Person</span><span class="p">{}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">person</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">if</span> <span class="nx">person</span> <span class="o">!=</span> <span class="o">*</span><span class="nb">new</span><span class="p">(</span><span class="nx">Person</span><span class="p">){</span>
            <span class="nx">persons</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">persons</span><span class="p">,</span> <span class="nx">person</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">persons</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">addPlace</span><span class="p">(</span><span class="nx">item</span> <span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span><span class="p">,</span> <span class="nx">places</span> <span class="p">[]</span><span class="nx">Place</span><span class="p">)([]</span><span class="nx">Place</span><span class="p">){</span>
    <span class="nx">place</span> <span class="o">:=</span><span class="nx">Place</span><span class="p">{}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">place</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">if</span> <span class="nx">place</span> <span class="o">!=</span> <span class="o">*</span><span class="nb">new</span><span class="p">(</span><span class="nx">Place</span><span class="p">){</span>
            <span class="nx">places</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">places</span><span class="p">,</span> <span class="nx">place</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">places</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nf">decode</span><span class="p">(</span><span class="nx">jsonStr</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)(</span><span class="nx">persons</span> <span class="p">[]</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">places</span> <span class="p">[]</span><span class="nx">Place</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="nx">json</span><span class="p">.</span><span class="nx">RawMessage</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">item</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span><span class="p">[</span><span class="s">&#34;things&#34;</span><span class="p">]{</span>
        <span class="nx">persons</span> <span class="p">=</span> <span class="nf">addPerson</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">persons</span><span class="p">)</span>
        <span class="nx">places</span> <span class="p">=</span> <span class="nf">addPlace</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">places</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>把things的item数组解析成一个json.RawMessage，然后再定义其他结构逐步解析。上述这些例子其实在真实的开发环境下，应该尽量避免。像person或是place这样的数据，可以定义两个数组分别存储他们，这样就方便很多。不管怎么样，通过这个略傻的例子，我们也知道了如何解析json数据。</p>

<h2 id="数字的解析">数字的解析</h2>

<h3 id="float64与int64">float64与int64</h3>

<p>JSON的规范中，对于数字类型，并不区分是整型还是浮点型。</p>

<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20190827122916.png" alt="" /></p>

<p>对于如下JSON文本:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ethancai&#34;</span><span class="p">,</span>
    <span class="nt">&#34;fansCount&#34;</span><span class="p">:</span> <span class="mi">9223372036854775807</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如果反序列化的时候指定明确的结构体和变量类型</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;encoding/json&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span>      <span class="kt">string</span>
    <span class="nx">FansCount</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">jsonStream</span> <span class="p">=</span> <span class="s">`
</span><span class="s">        {&#34;name&#34;:&#34;ethancai&#34;, &#34;fansCount&#34;: 9223372036854775807}
</span><span class="s">    `</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="nx">User</span>  <span class="c1">// 类型为User
</span><span class="c1"></span>    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jsonStream</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v \n&#34;</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// Output:
</span><span class="c1"></span><span class="o">//</span>  <span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="nx">ethancai</span> <span class="nx">FansCount</span><span class="p">:</span><span class="mi">9223372036854775807</span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>如果反序列化不指定结构体类型或者变量类型，则JSON中的数字类型，默认被反序列化成float64类型：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;encoding/json&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;reflect&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">jsonStream</span> <span class="p">=</span> <span class="s">`
</span><span class="s">        {&#34;name&#34;:&#34;ethancai&#34;, &#34;fansCount&#34;: 9223372036854775807}
</span><span class="s">    `</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="kd">interface</span><span class="p">{}</span>  <span class="c1">// 不指定反序列化的类型
</span><span class="c1"></span>    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jsonStream</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">m</span> <span class="o">:=</span> <span class="nx">user</span><span class="p">.(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span>

    <span class="nx">fansCount</span> <span class="o">:=</span> <span class="nx">m</span><span class="p">[</span><span class="s">&#34;fansCount&#34;</span><span class="p">]</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v \n&#34;</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="nx">fansCount</span><span class="p">).</span><span class="nf">Name</span><span class="p">())</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v \n&#34;</span><span class="p">,</span> <span class="nx">fansCount</span><span class="p">.(</span><span class="kt">float64</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// Output:
</span><span class="c1">// 	float64
</span><span class="c1"></span><span class="o">//</span>  	<span class="mf">9.223372036854776e+18</span></code></pre></td></tr></table>
</div>
</div>
<p>我们看一下源码，encoding/json/decode.go</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// literalStore decodes a literal stored in item into v.
</span><span class="c1">//
</span><span class="c1">// fromQuoted indicates whether this literal came from unwrapping a
</span><span class="c1">// string from the &#34;,string&#34; struct tag option. this is used only to
</span><span class="c1">// produce more helpful error messages.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">decodeState</span><span class="p">)</span> <span class="nf">literalStore</span><span class="p">(</span><span class="nx">item</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">fromQuoted</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c1">// Check for unmarshaler.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">//Empty string given
</span><span class="c1"></span>		<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">()))</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="nx">isNull</span> <span class="o">:=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;n&#39;</span> <span class="c1">// null
</span><span class="c1"></span>	<span class="nx">u</span><span class="p">,</span> <span class="nx">ut</span><span class="p">,</span> <span class="nx">pv</span> <span class="o">:=</span> <span class="nf">indirect</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">isNull</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">u</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">u</span><span class="p">.</span><span class="nf">UnmarshalJSON</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">ut</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;&#34;&#39;</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">fromQuoted</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">()))</span>
				<span class="k">return</span> <span class="kc">nil</span>
			<span class="p">}</span>
			<span class="nx">val</span> <span class="o">:=</span> <span class="s">&#34;number&#34;</span>
			<span class="k">switch</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="p">:</span>
				<span class="nx">val</span> <span class="p">=</span> <span class="s">&#34;null&#34;</span>
			<span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">:</span>
				<span class="nx">val</span> <span class="p">=</span> <span class="s">&#34;bool&#34;</span>
			<span class="p">}</span>
			<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
			<span class="k">return</span> <span class="kc">nil</span>
		<span class="p">}</span>
		<span class="nx">s</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">unquoteBytes</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">fromQuoted</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">())</span>
			<span class="p">}</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">phasePanicMsg</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nx">ut</span><span class="p">.</span><span class="nf">UnmarshalText</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">v</span> <span class="p">=</span> <span class="nx">pv</span>

	<span class="k">switch</span> <span class="nx">c</span> <span class="o">:=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nx">c</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="p">:</span> <span class="c1">// null
</span><span class="c1"></span>		<span class="c1">// The main parser checks that only true and false can reach here,
</span><span class="c1"></span>		<span class="c1">// but if this was a quoted string input, it could be anything.
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">fromQuoted</span> <span class="o">&amp;&amp;</span> <span class="nb">string</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;null&#34;</span> <span class="p">{</span>
			<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">()))</span>
			<span class="k">break</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Ptr</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Map</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Slice</span><span class="p">:</span>
			<span class="nx">v</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">Zero</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">()))</span>
			<span class="c1">// otherwise, ignore null for primitives/string
</span><span class="c1"></span>		<span class="p">}</span>
	<span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">:</span> <span class="c1">// true, false
</span><span class="c1"></span>		<span class="nx">value</span> <span class="o">:=</span> <span class="nx">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;t&#39;</span>
		<span class="c1">// The main parser checks that only true and false can reach here,
</span><span class="c1"></span>		<span class="c1">// but if this was a quoted string input, it could be anything.
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">fromQuoted</span> <span class="o">&amp;&amp;</span> <span class="nb">string</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;true&#34;</span> <span class="o">&amp;&amp;</span> <span class="nb">string</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#34;false&#34;</span> <span class="p">{</span>
			<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">()))</span>
			<span class="k">break</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">fromQuoted</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">()))</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;bool&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Bool</span><span class="p">:</span>
			<span class="nx">v</span><span class="p">.</span><span class="nf">SetBool</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Interface</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">NumMethod</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="nx">v</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;bool&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="sc">&#39;&#34;&#39;</span><span class="p">:</span> <span class="c1">// string
</span><span class="c1"></span>		<span class="nx">s</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">unquoteBytes</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">fromQuoted</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">())</span>
			<span class="p">}</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">phasePanicMsg</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Slice</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">().</span><span class="nf">Elem</span><span class="p">().</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint8</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="nx">b</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">StdEncoding</span><span class="p">.</span><span class="nf">DecodedLen</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">)))</span>
			<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">base64</span><span class="p">.</span><span class="nx">StdEncoding</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="nx">v</span><span class="p">.</span><span class="nf">SetBytes</span><span class="p">(</span><span class="nx">b</span><span class="p">[:</span><span class="nx">n</span><span class="p">])</span>
		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">String</span><span class="p">:</span>
			<span class="nx">v</span><span class="p">.</span><span class="nf">SetString</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">s</span><span class="p">))</span>
		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Interface</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">NumMethod</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="nx">v</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">s</span><span class="p">)))</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;string&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="k">default</span><span class="p">:</span> <span class="c1">// number
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">c</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">c</span> <span class="p">&lt;</span> <span class="sc">&#39;0&#39;</span> <span class="o">||</span> <span class="nx">c</span> <span class="p">&gt;</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">fromQuoted</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">())</span>
			<span class="p">}</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">phasePanicMsg</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">s</span> <span class="o">:=</span> <span class="nb">string</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
		<span class="k">switch</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Kind</span><span class="p">()</span> <span class="o">==</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">String</span> <span class="o">&amp;&amp;</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">()</span> <span class="o">==</span> <span class="nx">numberType</span> <span class="p">{</span>
				<span class="nx">v</span><span class="p">.</span><span class="nf">SetString</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">!</span><span class="nf">isValidNumber</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid number literal, trying to unmarshal %q into Number&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">fromQuoted</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;json: invalid use of ,string struct tag, trying to unmarshal %q into %v&#34;</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">())</span>
			<span class="p">}</span>
			<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;number&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Interface</span><span class="p">:</span>
			<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">convertNumber</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nf">NumMethod</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;number&#34;</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="nx">v</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">ValueOf</span><span class="p">(</span><span class="nx">n</span><span class="p">))</span>

		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int8</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int16</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int32</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Int64</span><span class="p">:</span>
			<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">v</span><span class="p">.</span><span class="nf">OverflowInt</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;number &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="nx">v</span><span class="p">.</span><span class="nf">SetInt</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>

		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint8</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint16</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint32</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uint64</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Uintptr</span><span class="p">:</span>
			<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseUint</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">v</span><span class="p">.</span><span class="nf">OverflowUint</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;number &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="nx">v</span><span class="p">.</span><span class="nf">SetUint</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>

		<span class="k">case</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Float32</span><span class="p">,</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Float64</span><span class="p">:</span>
			<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseFloat</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">().</span><span class="nf">Bits</span><span class="p">())</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">v</span><span class="p">.</span><span class="nf">OverflowFloat</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">d</span><span class="p">.</span><span class="nf">saveError</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;number &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Type</span><span class="p">(),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">readIndex</span><span class="p">())})</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="nx">v</span><span class="p">.</span><span class="nf">SetFloat</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// convertNumber converts the number literal s to a float64 or a Number
</span><span class="c1">// depending on the setting of d.useNumber.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">d</span> <span class="o">*</span><span class="nx">decodeState</span><span class="p">)</span> <span class="nf">convertNumber</span><span class="p">(</span><span class="nx">s</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">useNumber</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nf">Number</span><span class="p">(</span><span class="nx">s</span><span class="p">),</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="nx">f</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseFloat</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">UnmarshalTypeError</span><span class="p">{</span><span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;number &#34;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">Type</span><span class="p">:</span> <span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="nx">Offset</span><span class="p">:</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">off</span><span class="p">)}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">f</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看出来，Json解析实现的时候通过反射来判断要生成的具体的类型。如果是interface{}类型，通过converNumber方法转成float64（里面是通过strconv.ParseFloat实现），如果类型是整形相关，通过strconv.ParseInt方法转换。无符号整形是通过strconv.ParseUint实现。</p>

<h3 id="float64的科学计数法">float64的科学计数法</h3>

<p>如果对一个 map[string]interface{} 赋值整数，转换为JSON再直接输出为string，超过6位就会使用科学记数法，而若在Struct中明确是一个整数int64类型，始终都是整数int64的输出格式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;encoding/json&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">T</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Int</span> <span class="kt">int64</span>
    <span class="nx">Map</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span> <span class="kt">int64</span> <span class="p">=</span> <span class="mi">123456</span><span class="p">,</span> <span class="mi">1234567</span>
    <span class="nf">test</span><span class="p">(</span><span class="nx">v1</span><span class="p">)</span>
    <span class="nf">test</span><span class="p">(</span><span class="nx">v2</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">(</span><span class="nx">val</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span><span class="p">,</span> <span class="nx">t2</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">{</span><span class="nx">Map</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})},</span> <span class="nx">T</span><span class="p">{</span><span class="nx">Map</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})}</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Int</span> <span class="p">=</span> <span class="nx">val</span>
    <span class="nx">t</span><span class="p">.</span><span class="nx">Map</span><span class="p">[</span><span class="s">&#34;val&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">val</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;before: %v&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">))</span>

    <span class="nx">jsonBytes</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
    <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">jsonBytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">t2</span><span class="p">)</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;after: %v&#34;</span><span class="p">,</span> <span class="nx">t2</span><span class="p">))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">before: {123456 map[val:123456]}
after: {123456 map[val:123456]}
before: {1234567 map[val:1234567]}
after: {1234567 map[val:1.234567e+06]}</pre></td></tr></table>
</div>
</div>
<p>只要在打印时指定打印格式，或者转换为整数打印,更好的方法是下面的json.Number</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">T</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Int</span> <span class="kt">int64</span>
	<span class="nx">Map</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span> <span class="kt">int64</span> <span class="p">=</span> <span class="mi">123456</span><span class="p">,</span> <span class="mi">1234567</span>
	<span class="nf">test</span><span class="p">(</span><span class="nx">v1</span><span class="p">)</span>
	<span class="nf">test</span><span class="p">(</span><span class="nx">v2</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">test</span><span class="p">(</span><span class="nx">val</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">t</span><span class="p">,</span> <span class="nx">t2</span> <span class="o">:=</span> <span class="nx">T</span><span class="p">{</span><span class="nx">Map</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})},</span> <span class="nx">T</span><span class="p">{</span><span class="nx">Map</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})}</span>
	<span class="nx">t</span><span class="p">.</span><span class="nx">Int</span> <span class="p">=</span> <span class="nx">val</span>
	<span class="nx">t</span><span class="p">.</span><span class="nx">Map</span><span class="p">[</span><span class="s">&#34;val&#34;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">val</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;before: %v&#34;</span><span class="p">,</span> <span class="nx">t</span><span class="p">))</span>

	<span class="nx">jsonBytes</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
	<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">jsonBytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">t2</span><span class="p">)</span>

	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;after: %v&#34;</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">t2</span><span class="p">.</span><span class="nx">Map</span><span class="p">[</span><span class="s">&#34;val&#34;</span><span class="p">].(</span><span class="kt">float64</span><span class="p">))))</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></pre></td>
<td class="lntd">
<pre class="chroma">before: {123456 map[val:123456]}
after: 123456
before: {1234567 map[val:1234567]}
after: 1234567</pre></td></tr></table>
</div>
</div>
<p>如前面所说，json的Unmarshal会把数字解析为float64格式，那么变成科学计数法的原因应该在于Marshal编码float64格式的数字上，进入golang的源码包，发现在encoding/json/encode.go是这样处理float类型的代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">floatEncoder</span> <span class="kt">int</span> <span class="c1">// number of bits
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">bits</span> <span class="nx">floatEncoder</span><span class="p">)</span> <span class="nf">encode</span><span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">encodeState</span><span class="p">,</span> <span class="nx">v</span> <span class="nx">reflect</span><span class="p">.</span><span class="nx">Value</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">encOpts</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">f</span> <span class="o">:=</span> <span class="nx">v</span><span class="p">.</span><span class="nf">Float</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">math</span><span class="p">.</span><span class="nf">IsInf</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="nx">math</span><span class="p">.</span><span class="nf">IsNaN</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nb">error</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">UnsupportedValueError</span><span class="p">{</span><span class="nx">v</span><span class="p">,</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">FormatFloat</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">bits</span><span class="p">))})</span>
	<span class="p">}</span>

	<span class="c1">// Convert as if by ES6 number to string conversion.
</span><span class="c1"></span>	<span class="c1">// This matches most other JSON generators.
</span><span class="c1"></span>	<span class="c1">// See golang.org/issue/6384 and golang.org/issue/14135.
</span><span class="c1"></span>	<span class="c1">// Like fmt %g, but the exponent cutoffs are different
</span><span class="c1"></span>	<span class="c1">// and exponents themselves are not padded to two digits.
</span><span class="c1"></span>	<span class="nx">b</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">scratch</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
	<span class="nx">abs</span> <span class="o">:=</span> <span class="nx">math</span><span class="p">.</span><span class="nf">Abs</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
	<span class="nx">fmt</span> <span class="o">:=</span> <span class="nb">byte</span><span class="p">(</span><span class="sc">&#39;f&#39;</span><span class="p">)</span>
	<span class="c1">// Note: Must use float32 comparisons for underlying float32 value to get precise cutoffs right.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">abs</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">bits</span> <span class="o">==</span> <span class="mi">64</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">abs</span> <span class="p">&lt;</span> <span class="mf">1e-6</span> <span class="o">||</span> <span class="nx">abs</span> <span class="o">&gt;=</span> <span class="mf">1e21</span><span class="p">)</span> <span class="o">||</span> <span class="nx">bits</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nb">float32</span><span class="p">(</span><span class="nx">abs</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mf">1e-6</span> <span class="o">||</span> <span class="nb">float32</span><span class="p">(</span><span class="nx">abs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">1e21</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">fmt</span> <span class="p">=</span> <span class="sc">&#39;e&#39;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">b</span> <span class="p">=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">AppendFloat</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nx">bits</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">fmt</span> <span class="o">==</span> <span class="sc">&#39;e&#39;</span> <span class="p">{</span>
		<span class="c1">// clean up e-09 to e-9
</span><span class="c1"></span>		<span class="nx">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;e&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span> <span class="p">{</span>
			<span class="nx">b</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
			<span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[:</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">quoted</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="sc">&#39;&#34;&#39;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">e</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">quoted</span> <span class="p">{</span>
		<span class="nx">e</span><span class="p">.</span><span class="nf">WriteByte</span><span class="p">(</span><span class="sc">&#39;&#34;&#39;</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>可以看到处理float的是这个函数<code>b = strconv.AppendFloat(b, f, fmt, -1, int(bits))</code>，这个函数在注释中，可以看到格式化参数的说明：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// FormatFloat converts the floating-point number f to a string,
</span><span class="c1">// according to the format fmt and precision prec. It rounds the
</span><span class="c1">// result assuming that the original was obtained from a floating-point
</span><span class="c1">// value of bitSize bits (32 for float32, 64 for float64).
</span><span class="c1">//
</span><span class="c1">// The format fmt is one of
</span><span class="c1">// &#39;b&#39; (-ddddp±ddd, a binary exponent),
</span><span class="c1">// &#39;e&#39; (-d.dddde±dd, a decimal exponent),
</span><span class="c1">// &#39;E&#39; (-d.ddddE±dd, a decimal exponent),
</span><span class="c1">// &#39;f&#39; (-ddd.dddd, no exponent),
</span><span class="c1">// &#39;g&#39; (&#39;e&#39; for large exponents, &#39;f&#39; otherwise), or
</span><span class="c1">// &#39;G&#39; (&#39;E&#39; for large exponents, &#39;f&#39; otherwise).
</span><span class="c1">//
</span><span class="c1">// The precision prec controls the number of digits (excluding the exponent)
</span><span class="c1">// printed by the &#39;e&#39;, &#39;E&#39;, &#39;f&#39;, &#39;g&#39;, and &#39;G&#39; formats.
</span><span class="c1">// For &#39;e&#39;, &#39;E&#39;, and &#39;f&#39; it is the number of digits after the decimal point.
</span><span class="c1">// For &#39;g&#39; and &#39;G&#39; it is the maximum number of significant digits (trailing
</span><span class="c1">// zeros are removed).
</span><span class="c1">// The special precision -1 uses the smallest number of digits
</span><span class="c1">// necessary such that ParseFloat will return f exactly.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">FormatFloat</span><span class="p">(</span><span class="nx">f</span> <span class="kt">float64</span><span class="p">,</span> <span class="nx">fmt</span> <span class="kt">byte</span><span class="p">,</span> <span class="nx">prec</span><span class="p">,</span> <span class="nx">bitSize</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nf">genericFtoa</span><span class="p">(</span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">max</span><span class="p">(</span><span class="nx">prec</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mi">24</span><span class="p">)),</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">,</span> <span class="nx">prec</span><span class="p">,</span> <span class="nx">bitSize</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// AppendFloat appends the string form of the floating-point number f,
</span><span class="c1">// as generated by FormatFloat, to dst and returns the extended buffer.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">AppendFloat</span><span class="p">(</span><span class="nx">dst</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">f</span> <span class="kt">float64</span><span class="p">,</span> <span class="nx">fmt</span> <span class="kt">byte</span><span class="p">,</span> <span class="nx">prec</span><span class="p">,</span> <span class="nx">bitSize</span> <span class="kt">int</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nf">genericFtoa</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">,</span> <span class="nx">prec</span><span class="p">,</span> <span class="nx">bitSize</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>g对于大的数使用e即科学计数法表示，其他使用的正常方式表示。</p>

<p>那么，为什么7位就变成科学计数了呢？原来在<code>b = strconv.AppendFloat(b, f, fmt, -1, int(bits))</code>中，有个控制精度的参数被赋值为-1，AppendFloat函数包装了genericFtoa函数，在genericFtoa函数中，如果精度参数为-1，表示的只要数据准确，就可以尽可能的短，进而在formatDigits函数中根据这个结果把位数设置为6。</p>

<h3 id="json-number">json.Number</h3>

<h4 id="解析大数">解析大数</h4>

<p>如果fansCount精度比较高，反序列化成float64类型的数值时存在丢失精度的问题。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;encoding/json&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">User</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Name</span>      <span class="kt">string</span>
    <span class="nx">FansCount</span> <span class="kd">interface</span><span class="p">{}</span>  <span class="c1">// 不指定FansCount变量的类型
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">jsonStream</span> <span class="p">=</span> <span class="s">`
</span><span class="s">        {&#34;name&#34;:&#34;ethancai&#34;, &#34;fansCount&#34;: 9223372036854775807}
</span><span class="s">    `</span>
    <span class="kd">var</span> <span class="nx">user</span> <span class="nx">User</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jsonStream</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;error:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%+v \n&#34;</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Output:
</span><span class="c1"></span><span class="o">//</span> 	<span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="nx">ethancai</span> <span class="nx">FansCount</span><span class="p">:</span><span class="mf">9.223372036854776e+18</span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>解决办法有以下两种形式:
1. 可以直接使用json.Number类型存放json中对应的高精度数值
2. 有时候我们想偷懒，并不想自己定义结构体，还是想使用map[string]interface{}来解析 JSON，可以使用UseNumber方法.func (*Decoder) UseNumber方法告诉反序列化JSON的数字类型的时候，不直接转换成float64，而是转换成json.Number类型.</p>

<p>Unmarshal</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">val</span> <span class="o">:=</span> <span class="s">`{&#34;id&#34;: 100010001000100010001000 }`</span> <span class="c1">//26位数字
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">y</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">json</span><span class="p">.</span><span class="nx">Number</span>
<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">val</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">y</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="c1">//map[id:100010001000100010001000]
</span><span class="c1"></span><span class="nx">z</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="kd">struct</span> <span class="p">{</span>
<span class="nx">Id</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Number</span> <span class="s">`json:&#34;id&#34;`</span>
<span class="p">}{</span><span class="nx">y</span><span class="p">[</span><span class="s">&#34;id&#34;</span><span class="p">]})</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">z</span><span class="p">))</span> <span class="o">//</span><span class="p">{</span><span class="s">&#34;id&#34;</span><span class="p">:</span><span class="mi">100010001000100010001000</span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>Decode</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">val</span> <span class="o">:=</span> <span class="s">`{&#34;id&#34;: 100010001000100010001000 }`</span> <span class="c1">//26位数字
</span><span class="c1"></span><span class="nx">val2</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span>             <span class="c1">//先转成io.Reader
</span><span class="c1"></span><span class="nx">d</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">val2</span><span class="p">)</span>
<span class="nx">d</span><span class="p">.</span><span class="nf">UseNumber</span><span class="p">()</span> <span class="c1">//标记使用josn.Number
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">x</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">x</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%#v\n&#34;</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="c1">//相应值的Go语法表示
</span><span class="c1"></span><span class="nx">newJson</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">newJson</span><span class="p">))</span> <span class="o">//</span><span class="nx">json</span><span class="p">.</span><span class="nx">Number编组结果</span></code></pre></td></tr></table>
</div>
</div>
<p>输出结果：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">map[string]interface {}{&#34;id&#34;:&#34;100010001000100010001000&#34;}
{&#34;id&#34;:100010001000100010001000}</pre></td></tr></table>
</div>
</div>
<h4 id="解析整型和字符串">解析整型和字符串</h4>

<p>定义了两个 JSON 串，一个是整型，一个是字符串。如何将这两个数据解析到同一种类型中呢？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;encoding/json&#34;</span>
	<span class="s">&#34;log&#34;</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">raw</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;a&#34;:1}`</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">raw_string</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;a&#34;:&#34;2&#34;}`</span><span class="p">)</span>
	<span class="kd">type</span> <span class="nx">S3</span> <span class="kd">struct</span> <span class="p">{</span>
		<span class="nx">A</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Number</span> <span class="s">`json:&#34;a&#34;`</span>
	<span class="p">}</span>

	<span class="nx">s3</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">S3</span><span class="p">)</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">s3</span><span class="p">)</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">s3</span><span class="p">.</span><span class="nx">A</span><span class="p">)</span>

	<span class="nx">s31</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">S3</span><span class="p">)</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">raw_string</span><span class="p">,</span> <span class="nx">s31</span><span class="p">)</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">s31</span><span class="p">.</span><span class="nx">A</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>将对象a的类型定义成json.Number就可以实现对两种数据类型的解析。</p>

<h4 id="解析固定位数的浮点数">解析固定位数的浮点数</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;encoding/json&#34;</span>
    <span class="s">&#34;fmt&#34;</span>
    <span class="s">&#34;strings&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Record</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">A</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Number</span> <span class="s">`json:&#34;a&#34;`</span>
    <span class="nx">B</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Number</span> <span class="s">`json:&#34;b&#34;`</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="p">(</span>
        <span class="nx">data</span>   <span class="p">=</span> <span class="s">`{ &#34;a&#34;: 0.000, &#34;b&#34;: 0.000 }`</span>
        <span class="nx">record</span> <span class="nx">Record</span>
    <span class="p">)</span>

    <span class="nx">dec</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
    <span class="nx">dec</span><span class="p">.</span><span class="nf">UseNumber</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dec</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">record</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;a(%s) b(%s)\n&#34;</span><span class="p">,</span> <span class="nx">record</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">record</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">A</span><span class="p">.</span><span class="nf">Float64</span><span class="p">()</span> <span class="c1">// assign
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>或者</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Record</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>

<span class="kd">var</span> <span class="nx">jsonstr</span> <span class="p">=</span> <span class="s">`
</span><span class="s">{
</span><span class="s">    &#34;a&#34;: 0.000,
</span><span class="s">    &#34;b&#34;: 0.000
</span><span class="s">}
</span><span class="s">`</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">record</span> <span class="nx">Record</span>
    <span class="nx">dec</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">jsonstr</span><span class="p">))</span>
    <span class="nx">dec</span><span class="p">.</span><span class="nf">UseNumber</span><span class="p">()</span>
    <span class="nx">dec</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">record</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">a(0.000) b(0.000)</pre></td></tr></table>
</div>
</div>
<h4 id="原理">原理</h4>

<p>我们知道，解析 JSON 的时候其实是对 JSON 串的遍历，其实所有遍历出来的值都是[]byte类型，然后根据识别目标解析对象字段类型，或者识别[]byte数据的内容转换格式。比如，如果数据被解析到int上，把[]byte转换为int；如果被解析到interface{}上，就只能通过[]byte的类型来转换了，数字会被统一处理能float64，这个有个问题，就是会丢精度。而通过Number解析时，值会被直接保存为字符串类型。</p>

<p>json.Number内部实现机制是什么，我们来看看源码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// A Number represents a JSON number literal.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Number</span> <span class="kt">string</span>

<span class="c1">// String returns the literal text of the number.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="nx">Number</span><span class="p">)</span> <span class="nf">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">string</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">// Float64 returns the number as a float64.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="nx">Number</span><span class="p">)</span> <span class="nf">Float64</span><span class="p">()</span> <span class="p">(</span><span class="kt">float64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseFloat</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="mi">64</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Int64 returns the number as an int64.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">n</span> <span class="nx">Number</span><span class="p">)</span> <span class="nf">Int64</span><span class="p">()</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseInt</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>json.Number本质是字符串，反序列化的时候将JSON的数值先转成json.Number，其实是一种延迟处理的手段，待后续逻辑需要时候，再把json.Number转成float64或者int64。</p>

<p>使用Int64还是float64就可以通过用户自己的情况选择了。</p>

<h2 id="time-time的编解码">time.time的编解码</h2>

<p>对于 json 格式，是没有时间类型的，日期和时间以 json 格式存储时，需要转换为字符串类型。这就带来了一个问题，日期时间的字符串表示有多种多样，go 的 json 包支持的是哪一种呢？</p>

<p>使用下面的代码来输出 json.Marshal 方法将 Time 类型转换为字符串后的格式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Name</span> <span class="kt">string</span>
	<span class="nx">Birth</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">person</span> <span class="o">:=</span> <span class="nx">Person</span><span class="p">{</span>
		<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Wang Wu&#34;</span><span class="p">,</span>
		<span class="nx">Birth</span><span class="p">:</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="nx">jsonBytes</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">person</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">jsonBytes</span><span class="p">))</span>  <span class="c1">// {&#34;Name&#34;:&#34;Wang Wu&#34;,&#34;Birth&#34;:&#34;2018-12-20T16:22:02.00287617+08:00&#34;}
</span><span class="c1"></span><span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>根据输出可以判断，go 的 json 包使用的是 RFC3339 标准中定义的格式。接下来测试一下 json.Unmarshal 方法所支持的日期时间格式。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">dateStr</span> <span class="o">:=</span> <span class="s">&#34;2018-10-12&#34;</span>

<span class="kd">var</span> <span class="nx">person</span> <span class="nx">Person</span>
<span class="nx">jsonStr</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;{\&#34;name\&#34;:\&#34;Wang Wu\&#34;, \&#34;Birth\&#34;: \&#34;%s\&#34;}&#34;</span><span class="p">,</span> <span class="nx">dateStr</span><span class="p">)</span>
<span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">jsonStr</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">person</span><span class="p">)</span>

<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">person</span><span class="p">.</span><span class="nx">Birth</span><span class="p">)</span>  <span class="o">//</span> <span class="mo">0001</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mo">01</span> <span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">+</span><span class="mo">0000</span> <span class="nx">UTC</span></code></pre></td></tr></table>
</div>
</div>
<p>对于形如 2018-10-12 的字符串，json 包并没有成功将其解析，接下来我们把 time 包中支持的所有格式都试一下。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="p">(</span>
	<span class="nx">ANSIC</span>       <span class="p">=</span> <span class="s">&#34;Mon Jan _2 15:04:05 2006&#34;</span>
	<span class="nx">UnixDate</span>    <span class="p">=</span> <span class="s">&#34;Mon Jan _2 15:04:05 MST 2006&#34;</span>
	<span class="nx">RubyDate</span>    <span class="p">=</span> <span class="s">&#34;Mon Jan 02 15:04:05 -0700 2006&#34;</span>
	<span class="nx">RFC822</span>      <span class="p">=</span> <span class="s">&#34;02 Jan 06 15:04 MST&#34;</span>
	<span class="nx">RFC822Z</span>     <span class="p">=</span> <span class="s">&#34;02 Jan 06 15:04 -0700&#34;</span> <span class="c1">// RFC822 with numeric zone
</span><span class="c1"></span>	<span class="nx">RFC850</span>      <span class="p">=</span> <span class="s">&#34;Monday, 02-Jan-06 15:04:05 MST&#34;</span>
	<span class="nx">RFC1123</span>     <span class="p">=</span> <span class="s">&#34;Mon, 02 Jan 2006 15:04:05 MST&#34;</span>
	<span class="nx">RFC1123Z</span>    <span class="p">=</span> <span class="s">&#34;Mon, 02 Jan 2006 15:04:05 -0700&#34;</span> <span class="c1">// RFC1123 with numeric zone
</span><span class="c1"></span>	<span class="nx">RFC3339</span>     <span class="p">=</span> <span class="s">&#34;2006-01-02T15:04:05Z07:00&#34;</span>
	<span class="nx">RFC3339Nano</span> <span class="p">=</span> <span class="s">&#34;2006-01-02T15:04:05.999999999Z07:00&#34;</span>
	<span class="nx">Kitchen</span>     <span class="p">=</span> <span class="s">&#34;3:04PM&#34;</span>
	<span class="c1">// Handy time stamps.
</span><span class="c1"></span>	<span class="nx">Stamp</span>      <span class="p">=</span> <span class="s">&#34;Jan _2 15:04:05&#34;</span>
	<span class="nx">StampMilli</span> <span class="p">=</span> <span class="s">&#34;Jan _2 15:04:05.000&#34;</span>
	<span class="nx">StampMicro</span> <span class="p">=</span> <span class="s">&#34;Jan _2 15:04:05.000000&#34;</span>
	<span class="nx">StampNano</span>  <span class="p">=</span> <span class="s">&#34;Jan _2 15:04:05.000000000&#34;</span>
<span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>经过试验，发现 json.Unmarshal 方法只支持 RFC3339 和 RFC3339Nano 两种格式的转换。还有一个需要注意的地方，使用 time.Now() 生成的时间是带有一个 Monotonic Time 的，经过 json.Marshal 转换时候，由于 RFC3339 规范里没有存放 Monotonic Time 的位置，会丢掉这一部分。</p>

<h2 id="nil的编码解码">nil的编码解码</h2>

<p>官方文档:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">a</span> <span class="kc">nil</span> <span class="nx">slice</span> <span class="nx">encodes</span> <span class="nx">as</span> <span class="nx">the</span> <span class="nx">null</span> <span class="nx">JSON</span> <span class="nx">value</span><span class="p">.</span>
<span class="nx">A</span> <span class="kc">nil</span> <span class="nx">pointer</span> <span class="nx">encodes</span> <span class="nx">as</span> <span class="nx">the</span> <span class="nx">null</span> <span class="nx">JSON</span> <span class="nx">value</span><span class="p">.</span>
<span class="nx">A</span> <span class="kc">nil</span> <span class="kd">interface</span> <span class="nx">value</span> <span class="nx">encodes</span> <span class="nx">as</span> <span class="nx">the</span> <span class="nx">null</span> <span class="nx">JSON</span> <span class="nx">value</span><span class="p">.</span></code></pre></td></tr></table>
</div>
</div>
<p>举个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;encoding/json&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// map
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">sm</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{}</span>
	<span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">sm</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s, %v, err: %v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="c1">// slice
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">ss</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">ss</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s, %v, err: %v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">sbs</span> <span class="p">[]</span><span class="kt">byte</span>
	<span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">sbs</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s, %v, err: %v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="c1">// pointer
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">sp</span> <span class="o">*</span><span class="kt">string</span>
	<span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">sp</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s, %v, err: %v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="c1">// interface
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">si</span> <span class="kd">interface</span><span class="p">{}</span>
	<span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">si</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s, %v, err: %v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="kc">null</span><span class="err">,</span> <span class="p">[</span><span class="mi">110</span> <span class="mi">117</span> <span class="mi">108</span> <span class="mi">108</span><span class="p">]</span><span class="err">,</span> <span class="err">err:</span> <span class="err">&lt;nil&gt;</span>
<span class="kc">null</span><span class="err">,</span> <span class="p">[</span><span class="mi">110</span> <span class="mi">117</span> <span class="mi">108</span> <span class="mi">108</span><span class="p">]</span><span class="err">,</span> <span class="err">err:</span> <span class="err">&lt;nil&gt;</span>
<span class="kc">null</span><span class="err">,</span> <span class="p">[</span><span class="mi">110</span> <span class="mi">117</span> <span class="mi">108</span> <span class="mi">108</span><span class="p">]</span><span class="err">,</span> <span class="err">err:</span> <span class="err">&lt;nil&gt;</span>
<span class="kc">null</span><span class="err">,</span> <span class="p">[</span><span class="mi">110</span> <span class="mi">117</span> <span class="mi">108</span> <span class="mi">108</span><span class="p">]</span><span class="err">,</span> <span class="err">err:</span> <span class="err">&lt;nil&gt;</span>
<span class="kc">null</span><span class="err">,</span> <span class="p">[</span><span class="mi">110</span> <span class="mi">117</span> <span class="mi">108</span> <span class="mi">108</span><span class="p">]</span><span class="err">,</span> <span class="err">err:</span> <span class="err">&lt;nil&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>注意哦，这里序列化得到的结果并不是大小为0的byte切片，而是字符串null！！！当然，如果不想输出字符串null，那么可以修改为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;fmt&#34;</span>
	<span class="s">&#34;encoding/json&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="c1">// map
</span><span class="c1"></span>	<span class="nx">sm</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{},</span> <span class="mi">0</span><span class="p">)</span>
	<span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">sm</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s, %v, err: %v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="c1">// slice
</span><span class="c1"></span>	<span class="nx">ss</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">ss</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s, %v, err: %v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="c1">// bytes
</span><span class="c1"></span>	<span class="nx">sbs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Marshal</span><span class="p">(</span><span class="nx">sbs</span><span class="p">)</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;%s, %v, err: %v\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>
<p>输出：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{}</span><span class="err">,</span> <span class="p">[</span><span class="mi">123</span> <span class="mi">125</span><span class="p">]</span><span class="err">,</span> <span class="err">err:</span> <span class="err">&lt;nil&gt;</span>
<span class="p">[]</span><span class="err">,</span> <span class="p">[</span><span class="mi">91</span> <span class="mi">93</span><span class="p">]</span><span class="err">,</span> <span class="err">err:</span> <span class="err">&lt;nil&gt;</span>
<span class="s2">&#34;&#34;</span><span class="err">,</span> <span class="p">[</span><span class="mi">34</span> <span class="mi">34</span><span class="p">]</span><span class="err">,</span> <span class="err">err:</span> <span class="err">&lt;nil&gt;</span></code></pre></td></tr></table>
</div>
</div>
<p>此时，输出分别是对应类型的零值的字符串表示。例如，空 Map 的序列化值为字符串{}</p>

<p>所以，如果你只是希望在空的情况下，序列化得出空的结果，那么最好在序列化之前进行一次判空。</p>

<h2 id="总结">总结</h2>

<p>关于golang解析json的介绍基本就这么多。想要解析越简单，就需要定义越明确的map结构。面对无法确定的数据结构或类型，在动态解析方面可以借助接口与断言的方式解析，也可以使用json.RawMessage延迟解析。具体使用情况，还得考虑实际的需求和应用场景。</p>

<p>参考:</p>

<p><a href="https://www.jianshu.com/p/40d5556842f1">https://www.jianshu.com/p/40d5556842f1</a>
<a href="https://www.jianshu.com/p/31757e530144">https://www.jianshu.com/p/31757e530144</a>
<a href="https://ethancai.github.io/2016/06/23/bad-parts-about-json-serialization-in-Golang/">https://ethancai.github.io/2016/06/23/bad-parts-about-json-serialization-in-Golang/</a>
<a href="https://blog.csdn.net/hatlonely/article/details/79187676">https://blog.csdn.net/hatlonely/article/details/79187676</a>
<a href="https://blog.cyeam.com/golang/2016/05/02/jsonnumber">https://blog.cyeam.com/golang/2016/05/02/jsonnumber</a>
<a href="https://hackcv.com/index.php/archives/97/">https://hackcv.com/index.php/archives/97/</a>
<a href="https://www.simpleapples.com/2018/12/24/practice-in-json-with-go/">https://www.simpleapples.com/2018/12/24/practice-in-json-with-go/</a>
<a href="https://ictar.xyz/2017/11/29/golang%E7%9A%84%E8%B8%A9%E5%9D%91%E4%B8%8D%E5%AE%8C%E5%85%A8%E8%AE%B0%E5%BD%95%E4%B9%8Bjson/">https://ictar.xyz/2017/11/29/golang%E7%9A%84%E8%B8%A9%E5%9D%91%E4%B8%8D%E5%AE%8C%E5%85%A8%E8%AE%B0%E5%BD%95%E4%B9%8Bjson/</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2018-11-15
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/forz/tags/json/">Json</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/forz/post/go%E4%B8%AD%E7%9A%84http%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go中的HTTP通信方式</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/forz/post/gin%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-gin/">
            <span class="next-text nav-default">Gin源码剖析:gin</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="forzfuyao@email.com" class="iconfont icon-email" title="email"></a>
  <a href="http://localhost:1313/forz/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Forz</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/forz/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
