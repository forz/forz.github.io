<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Kingshard架构设计和功能实现 - Forz Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Forz" /><meta name="description" content="kingshard简介 kingshard是一个由Go开发高性能MySQL Proxy项目，kingshard在满足基本的读写分离的功能上，致力" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.96.0 with theme even" />


<link rel="canonical" href="/post/kingshard%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.98f8e47918247c097fa26317cbb567fe9f05503485bf08d8547f5579543303b1.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Kingshard架构设计和功能实现" />
<meta property="og:description" content="kingshard简介 kingshard是一个由Go开发高性能MySQL Proxy项目，kingshard在满足基本的读写分离的功能上，致力" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/kingshard%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%92%8C%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-03-24T17:13:47+00:00" />
<meta property="article:modified_time" content="2020-03-24T17:13:47+00:00" />

<meta itemprop="name" content="Kingshard架构设计和功能实现">
<meta itemprop="description" content="kingshard简介 kingshard是一个由Go开发高性能MySQL Proxy项目，kingshard在满足基本的读写分离的功能上，致力"><meta itemprop="datePublished" content="2020-03-24T17:13:47+00:00" />
<meta itemprop="dateModified" content="2020-03-24T17:13:47+00:00" />
<meta itemprop="wordCount" content="9446">
<meta itemprop="keywords" content="Kingshard," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kingshard架构设计和功能实现"/>
<meta name="twitter:description" content="kingshard简介 kingshard是一个由Go开发高性能MySQL Proxy项目，kingshard在满足基本的读写分离的功能上，致力"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Forz Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Forz Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
      <a class="menu-item-link" href="/">Home</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/post/">Archives</a>
    </li><li class="menu-item">
      <a class="menu-item-link" href="/categories/">Categories</a>
    </li>
  </ul>
</nav><div class="docsearch-input__container">
  <input type="search" class="docsearch-input" placeholder="Search" />
</div>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Kingshard架构设计和功能实现</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-03-24 </span>
        <div class="post-category">
            <a href="/categories/kingshard/"> Kingshard </a>
            </div>
          <span class="more-meta"> 约 9446 字 </span>
          <span class="more-meta"> 预计阅读 19 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#主要功能">主要功能：</a>
      <ul>
        <li><a href="#1-基础功能">1. 基础功能</a></li>
        <li><a href="#2-sharding功能">2. sharding功能</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#1-整体架构">1. 整体架构</a></li>
    <li><a href="#2-词法和语义分析">2. 词法和语义分析</a></li>
    <li><a href="#3-负载均衡">3. 负载均衡</a></li>
    <li><a href="#4sharding实现">4.sharding实现</a></li>
    <li><a href="#5-事务的实现">5. 事务的实现</a></li>
    <li><a href="#6-后端db存活检测">6. 后端DB存活检测</a></li>
    <li><a href="#7-客户端白名单机制">7. 客户端白名单机制</a></li>
    <li><a href="#8-管理端设计和实现">8. 管理端设计和实现</a></li>
  </ul>

  <ul>
    <li><a href="#1-发现kingshard的性能瓶颈">1. 发现kingshard的性能瓶颈</a>
      <ul>
        <li><a href="#11-环境搭建">1.1 环境搭建</a></li>
        <li><a href="#12-性能测试步骤">1.2 性能测试步骤</a></li>
      </ul>
    </li>
    <li><a href="#2-性能测试报告分析">2. 性能测试报告分析</a></li>
    <li><a href="#21-代码修改和性能测试">2.1 代码修改和性能测试</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>

  <ul>
    <li><a href="#1测试环境">1.测试环境</a>
      <ul>
        <li><a href="#11服务器配置">1.1服务器配置</a></li>
      </ul>
    </li>
    <li><a href="#2性能需求">2.性能需求</a></li>
    <li><a href="#3测试准备工作">3.测试准备工作</a>
      <ul>
        <li><a href="#31-kingshard性能测试环境搭建">3.1 kingshard性能测试环境搭建</a></li>
      </ul>
    </li>
    <li><a href="#4测试过程">4.测试过程</a>
      <ul>
        <li><a href="#41-kingshard与直连db性能比较">4.1 kingshard与直连DB性能比较</a></li>
        <li><a href="#42-max_conns_limit参数对kingshard性能影响">4.2 max_conns_limit参数对kingshard性能影响</a></li>
      </ul>
    </li>
    <li><a href="#5测试结论">5.测试结论</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="kingshard简介">kingshard简介</h1>
<p>kingshard是一个由Go开发高性能MySQL Proxy项目，kingshard在满足基本的读写分离的功能上，致力于简化MySQL分库分表操作；能够让DBA通过kingshard轻松平滑地实现MySQL数据库扩容。 <strong>kingshard的性能是直连MySQL性能的80%以上</strong>。</p>
<h2 id="主要功能">主要功能：</h2>
<h3 id="1-基础功能">1. 基础功能</h3>
<ul>
<li>支持SQL读写分离。</li>
<li>支持透明的MySQL连接池，不必每次新建连接。</li>
<li>支持平滑上线DB或下线DB，前端应用无感知。</li>
<li>支持多个slave，slave之间通过权值进行负载均衡。</li>
<li>支持强制读主库。</li>
<li>支持主流语言（java,php,python,C/C++,Go)SDK的mysql的prepare特性。</li>
<li>支持到后端DB的最大连接数限制。</li>
<li>支持SQL日志及慢日志输出。</li>
<li>支持SQL黑名单机制。</li>
<li>支持客户端IP访问白名单机制，只有白名单中的IP才能访问kingshard（支持IP 段）。</li>
<li>支持字符集设置。</li>
<li>支持last_insert_id功能。</li>
<li>支持热加载配置文件，动态修改kingshard配置项（具体参考管理端命令）。</li>
<li>支持以Web API调用的方式管理kingshard。</li>
<li>支持多用户模式，不同用户之间的表是权限隔离的，互不感知。</li>
</ul>
<h3 id="2-sharding功能">2. sharding功能</h3>
<ul>
<li>支持按整数的hash和range分表方式。</li>
<li>支持按年、月、日维度的时间分表方式。</li>
<li>支持跨节点分表，子表可以分布在不同的节点。</li>
<li>支持跨节点的count,sum,max和min等聚合函数。</li>
<li>支持单个分表的join操作，即支持分表和另一张不分表的join操作。</li>
<li>支持跨节点的order by,group by,limit等操作。</li>
<li>支持将sql发送到特定的节点执行。</li>
<li>支持在单个节点上执行事务，不支持跨多节点的分布式事务。</li>
<li>支持非事务方式更新（insert,delete,update,replace）多个node上的子表。</li>
</ul>
<h1 id="kingshard架构设计和功能实现">kingshard架构设计和功能实现</h1>
<h2 id="1-整体架构">1. 整体架构</h2>
<p>kingshard采用Go开发，充分地利用了Go语言的并发特性。Go语言在并发方面，做了很好的封装，这大大简化了kingshard的开发工作。kingshard的整体工作流程如下所述：</p>
<ol>
<li>读取配置文件并启动，在配置文件中设置的监听端口监听客户端请求。</li>
<li>收到客户端连接请求后，启动一个goroutine单独处理该请求。</li>
<li>首选进行登录验证，验证过程完全兼容MySQL认证协议，由于用户名和密码在配置文件中已经设置好，所以可以利用该信息验证连接请求是否合法。当用户名和密码都正确时，转入下面的步骤，否则返回出错信息给客户端。</li>
<li>认证通过后，客户端发送SQL语句。</li>
<li>kingshard对客户端发送过来的SQL语句，进行词法和语义分析，识别出SQL的类型和生成SQL的路由计划。如果有必要还会改写SQL，然后转发到相应的DB。也有可能不做词法和语义分析直接转发到相应的后端DB。如果转发SQL是分表且跨多个DB，则每个DB对应启动一个goroutine发送SQL和接收该DB返回的结果。</li>
<li>接收并合并结果，然后转发给客户端。</li>
</ol>
<p>kingshard工作整体流程可参考下面这幅图。</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324173047.png" alt=""></p>
<p>kingshard整体架构图如下所示</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324173107.png" alt=""></p>
<h2 id="2-词法和语义分析">2. 词法和语义分析</h2>
<p>要将kingshard的功能做的足够强大，就不得不进行SQL的词法和语义分析。SQL语句的词法分析指的是将SQL语句切分成一个一个的关键字。例如对SQL语句：<code>select name from stu where id &lt; 13</code>进行词法分析，得到的结果是：<code>{&quot;select&quot;,&quot;name&quot;,&quot;from&quot;,&quot;stu&quot;,&quot;where&quot;,&quot;id&quot;,&quot;&lt;&quot;,&quot;13&quot;}</code>。这样做的目的主要为了生成一棵抽象语法树，也就是大家常说的AST(abstract syntax tree),语义分析就是基于这棵语法树来操作的。语义分析的目的主要有以下几个方面：</p>
<ol>
<li>读写分离，只有识别出SQL语句的类型，才能进行正确的读写分离操作。</li>
<li>数据分片，解析出表名和查询条件，将SQL路由到正确的DB。</li>
<li>SQL黑名单，通过词法和语义分析，也可以快速识别出需要屏蔽的SQL语句。例如，检测到delete语句不带where操作，就可以直接阻断该SQL的转发。</li>
</ol>
<p>kingshard并没有考虑完全兼容MySQL所有语法，因为完全兼容MySQL语法会使得词法和语义分析模块变得异常复杂，而且低效。对于DDL语句其实没必要解析，只要能正确转发到后端相应的DB上就可以。</p>
<p>kingshard只对部分DML语句<code>（select,update,insert,delete,replace)</code>进行了解析，这样可以满足绝大部分的分表操作。对于其他语句，kingshard会将其发送到一个默认的DB，或者通过kingshard特有的方式将其发送到指定的DB上，例如：<code>/*node2*/insert into stu（id,name) values(12,'xiaoming')</code>,对于这种带有注释的的sql语句，kingshard能够识别出，然后将这条sql语句发送到node2节点的Master DB上。</p>
<h2 id="3-负载均衡">3. 负载均衡</h2>
<p>用户使用Mysql Proxy目的很大一部分就是为了降低单台DB的负载，将读压力分担到多台DB上。kingshard支持多个slave，不同的slave可以配置不同的读权重，权重越大分担的读请求越多。kingshard读请求负载均衡采用的是权重轮询调度算法。</p>
<p>大部分系统采用该算法时，都是转发SQL语句时，动态地计算出本次选取DB的序号。然后将读请求的SQL语句发送到该DB。仔细分析一下，这样做其实是没有必要的。因为DB的权重是相对固定的，不会经常变动，所以完全可以计算出一个固定的轮询序列，然后将这个序列保存在一个数组中。这样不需要动态计算，每次读取数组就可以。举个例子来说，在kingshard的node配置项中配置slave选项：</p>
<p><code>slave:192.168.0.12@2,192.168.0.13@3</code></p>
<p>kingshard在读取配置信息初始化系统的时候，就生成了一个轮询数组:[0,0,1,1,1]。在kingshard中会将这个数组打乱顺序，变成：[0,1,1,0,1]。这样就避免了动态计算DB下标的问题，对性能提升有一定帮助。</p>
<h2 id="4sharding实现">4.sharding实现</h2>
<p>首选需要介绍两个概念：</p>
<ol>
<li>
<p><strong>子表</strong>，在kingshard中一张逻辑上的大表由若干张小的子表组成。例如：将stu表分成stu_0000,stu_0001,stu_0002,stu_0003。
在数据库中stu表是不存在的，它只是一张逻辑上的表。数据库中只存在四张子表（stu_0000,stu_0001,stu_0002,stu_0003）。
发送SQL语句时，kingshard会识别出需要分表的SQL语句，并改写该SQL。例如，客户端发送过来的SQL语句是<code>：select name from stu where id =10;</code>
kingshard收到该SQL语句后，从配置信息中识别出该表是一个Hash类型的分表。根据分表规则，将该SQL改写成：<code>select name from stu_2 where id =10;</code>
然后发送给对应的DB。</p>
</li>
<li>
<p><strong>Node</strong>，子表分布在各个node上，每个node包含一个maser server和若干个slave server（slave个数可以为0）。写请求会发往该node中master server，读请求会发往该node中的slave server。</p>
</li>
</ol>
<p>kingshard的sharding采用了两级映射的思想，首选根据SQL语句的分表条件计算出这条SQL语句落在哪个子表上，然后再根据配置信息找到该子表落在哪个node上。采用两级映射的思想，对于MySQL的扩容和缩容都能很方便地支持。目前kingshard sharding支持insert, delete, select, update和replace语句, 所有这五类操作都支持跨子表。但写操作仅支持单node上的跨子表，select操作则可以跨node，跨子表。</p>
<p>对于有些表没有分表，操作该表的SQL语句会发往default node。或者用户可以选择在SQL语句前面加上注释，指定该SQL要发往的node，kingshard接收到语句后，识别出注释中指定的node，然后将该SQL发往对应node中合适的DB。例如用户发送<code>/*node1*/select * from member where id=100</code>,kingshard接收到该SQL后会将其发送到node1的salve上。这样kingshard就能很好地兼容分表和不分表的各种应用场景了。</p>
<h2 id="5-事务的实现">5. 事务的实现</h2>
<p>所有proxy支持shard后都会面临一个问题：支不支持分布式事务？出于性能和可用性考虑，
kingshard只支持单台DB上的事务，不允许跨DB的事务。kingshard处理单DB上的事务流程如下：</p>
<ol>
<li>用户发送begin语句。</li>
<li>kingshard接收到SQL语句后，将该连接的状态设置为事务。</li>
<li>用户发送DML语句，kingshard识别出语句需要发送到的DB，然后kingshard新建一个与后端DB的连接，利用该连接发送语句。</li>
<li>收取SQL语句的结果后，将连接放回。</li>
<li>kingshard收到下一条SQL语句，判断该SQL是不是发往同一个DB，如果不是则报错。如果是发往同一个DB，则利用该连接发送语句。</li>
<li>收到用户发送的commit语句，将该连接的状态设置为非事务，事务结束。</li>
</ol>
<h2 id="6-后端db存活检测">6. 后端DB存活检测</h2>
<p>kingshard每个node启动了一个goroutine用于检测后端master和slave的状态。当goroutine持续一段时间（由配置文件中down_after_noalive参数设置）ping不通后端的DB后，会将该DB的状态设置为down，后续kingshard就不会将sql语句发往该DB了。</p>
<h2 id="7-客户端白名单机制">7. 客户端白名单机制</h2>
<p>有时候用户为了安全考虑，希望只只允许某几台server连接kingshard。在kingshard的配置文件中有一个参数：allow_ips，用于实现客户端白名单机制。当管理员设置了该参数，则意味着只有allow_ips指定的IP能够连接kingshard，其他IP都会被kingshard拒绝连接。如果不设置该参数，则连接kingshard的客户端不受限制。</p>
<h2 id="8-管理端设计和实现">8. 管理端设计和实现</h2>
<p>kingshard的管理端口复用了工作端口，通过特定的关键字(admin)来标示。kingshard是通过对管理端特定的SQL进行词法和语义分析，将SQL语句解析为一条kingshard可以识别的命令。目前支持平滑上下线master和slave，和查看kingshard配置和后端DB状态。后续打算将web页面集成到管理端，这样用户就可以不用输入命令行操作，而是在网页上操作。大大降低用户使用kingshard的门槛。</p>
<h1 id="kingshard性能优化网络篇">kingshard性能优化网络篇</h1>
<h2 id="1-发现kingshard的性能瓶颈">1. 发现kingshard的性能瓶颈</h2>
<p>首选，对kingshard进行性能优化，我们必须要找到kingshard的性能瓶颈在哪里。Go语言在性能优化支持方面做的非常好，借助于go语言的pprof工具，我们可以通过简单的几个步骤，就能得到kingshard在转发SQL请求时的各个函数耗时情况。</p>
<h3 id="11-环境搭建">1.1 环境搭建</h3>
<p>根据kingshard使用指南搭建一个kingshard代理环境。我是用macbook搭建的环境，硬件参数如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">CPU： 2.2GHZ * 4
</span></span><span class="line"><span class="cl">内存：16GB
</span></span><span class="line"><span class="cl">硬盘: 256GB
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="12-性能测试步骤">1.2 性能测试步骤</h3>
<p>具体步骤如下所述：</p>
<p>1.获取一个性能分析的封装库</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">go get github.com/pkg/profile
</span></span></code></pre></td></tr></table>
</div>
</div><p>2.在工程内import这个组件</p>
<p>3.在kingshard/cmd/kingshard/main.go的main函数开始部分添加CPU监控的启动和停止入口</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">func main() {
</span></span><span class="line"><span class="cl">	defer profile.Start(profile.CPUProfile).Stop()
</span></span><span class="line"><span class="cl">	fmt.Print(banner)
</span></span><span class="line"><span class="cl">	runtime.GOMAXPROCS(runtime.NumCPU())
</span></span><span class="line"><span class="cl">	flag.Parse()
</span></span><span class="line"><span class="cl">	....
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>4.重新编译工程, 运行kingshard</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./bin/kingshard -config=etc/ks.yaml
</span></span></code></pre></td></tr></table>
</div>
</div><p>5.kingshard启动后会在终端输出下面一段提示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">2015/10/31 10:28:06 profile: cpu profiling enabled, /var/folders/4q/zzb55sfj377b6vdyz2brt6sc0000gn/T/profile205276958/cpu.pprof
</span></span></code></pre></td></tr></table>
</div>
</div><p>后面的路径就是pprof性能分析文件的位置，Ctrl+C中断服务器</p>
<p>6.这时候用sysbench对kingshard进行压力测试，得到QPS（有关sysbench的安装和使用，请自行Google解决）。具体的代码如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">sysbench --test=oltp --num-threads=16 --max-requests=160000 --oltp-test-mode=nontrx --db-driver=mysql --mysql-db=kingshard --mysql-host=127.0.0.1 --mysql-port=9696 --mysql-table-engine=innodb --oltp-table-size=10000 --mysql-user=kingshard --mysql-password=kingshard --oltp-nontrx-mode=select --db-ps-mode=disable run
</span></span></code></pre></td></tr></table>
</div>
</div><p>得到如下结果:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">OLTP test statistics:
</span></span><span class="line"><span class="cl">    queries performed:
</span></span><span class="line"><span class="cl">        read:                            160071
</span></span><span class="line"><span class="cl">        write:                           0
</span></span><span class="line"><span class="cl">        other:                           0
</span></span><span class="line"><span class="cl">        total:                           160071
</span></span><span class="line"><span class="cl">    transactions:                        160071 (16552.58 per sec.)
</span></span><span class="line"><span class="cl">    deadlocks:                           0      (0.00 per sec.)
</span></span><span class="line"><span class="cl">    read/write requests:                 160071 (16552.58 per sec.)
</span></span><span class="line"><span class="cl">    other operations:                    0      (0.00 per sec.)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Test execution summary:
</span></span><span class="line"><span class="cl">    total time:                          9.6705s
</span></span><span class="line"><span class="cl">    total number of events:              160071
</span></span><span class="line"><span class="cl">    total time taken by event execution: 154.4474
</span></span><span class="line"><span class="cl">    per-request statistics:
</span></span><span class="line"><span class="cl">         min:                                  0.29ms
</span></span><span class="line"><span class="cl">         avg:                                  0.96ms
</span></span><span class="line"><span class="cl">         max:                                 14.17ms
</span></span><span class="line"><span class="cl">         approx.  95 percentile:               1.37ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Threads fairness:
</span></span><span class="line"><span class="cl">    events (avg/stddev):           10004.4375/24.95
</span></span><span class="line"><span class="cl">    execution time (avg/stddev):   9.6530/0.00
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>按照上述步骤测试三次（16552.58,16769.72,16550.16）取平均值，得到优化前kingshard的QPS是：16624.15</p>
</li>
<li>
<p>按照上述步骤，直连MySQL。测试直连MySQL的QPS，同样测试三次QPS（27730.90，28499.05，27119.20），得到直连MySQL的QPS是：27783.05。</p>
</li>
<li>
<p>从上述数据可以计算出kingshard转发SQL的性能是直连MySQL的59%左右。</p>
</li>
</ul>
<p>7.将cpu.prof拷贝到bin/kingshard所在位置</p>
<p>8.调用go tool工具制作CPU耗时的PDF文档</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">go tool pprof -pdf ./kingshard cpu.pprof &gt; report.pdf
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324232658.png" alt=""></p>
<h2 id="2-性能测试报告分析">2. 性能测试报告分析</h2>
<p>通过上述命令，可以生成压测期间主要函数耗时情况。从report来看，主要的耗时在TCP层数据包的收发上面。那我们应该主要考虑如何优化TCP层数据的收发方面。优化TCP传输效率，我首先想到了减少系统调用，每个数据包传输尽量多的数据。</p>
<p>在通过 TCP socket 进行通信时，数据都拆分成了数据块，这样它们就可以封装到给定连接的 TCP payload（指 TCP 数据包中的有效负荷）中了。TCP payload 的大小取决于几个因素（例如最大报文长度和路径），但是这些因素在连接发起时都是已知的。为了达到最好的性能，我们的目标是使用尽可能多的可用数据来填充每个报文。当没有足够的数据来填充 payload 时（也称为最大报文段长度（maximum segment size） 或 MSS），TCP 就会采用 Nagle 算法自动将一些小的缓冲区连接到一个报文段中。这样可以通过最小化所发送的报文的数量来提高应用程序的效率，并减轻整体的网络拥塞问题。</p>
<p>由于这种算法对数据进行合并，试图构成一个完整的 TCP 报文段，因此它会引入一些延时。但是这种算法可以最小化在线路上发送的报文的数量，因此可以最小化网络拥塞的问题。但是在需要最小化传输延时的情况中，GO语言中Sockets API 可以提供一种解决方案。就是通过：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">TCPConn</span><span class="p">)</span> <span class="nf">SetNoDelay</span><span class="p">(</span><span class="nx">noDelay</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">error</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个函数在Go中默认情况下，是设置为true，也就是未开启延迟选项。我们需要将其设置为false选项，来达到每个数据包传输尽量多的数据，减少系统调用的目的。</p>
<h2 id="21-代码修改和性能测试">2.1 代码修改和性能测试</h2>
<p>发现了性能瓶颈以后，修改proxy/server/server.go文件中的newClientConn函数和backend/backend_conn.go中的ReConnect函数，分别设置client与kingshard之间的连接和kingshard到MySQL之间的连接为最小化传输延时。具体的代码修改可以查看这个</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324233404.png" alt=""></p>
<p>修改后我们利用sysbench重新测试，测试命令和上述测试一致。得到的结果如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">OLTP test statistics:
</span></span><span class="line"><span class="cl">    queries performed:
</span></span><span class="line"><span class="cl">        read:                            160174
</span></span><span class="line"><span class="cl">        write:                           0
</span></span><span class="line"><span class="cl">        other:                           0
</span></span><span class="line"><span class="cl">        total:                           160174
</span></span><span class="line"><span class="cl">    transactions:                        160174 (21291.68 per sec.)
</span></span><span class="line"><span class="cl">    deadlocks:                           0      (0.00 per sec.)
</span></span><span class="line"><span class="cl">    read/write requests:                 160174 (21291.68 per sec.)
</span></span><span class="line"><span class="cl">    other operations:                    0      (0.00 per sec.)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Test execution summary:
</span></span><span class="line"><span class="cl">    total time:                          7.5228s
</span></span><span class="line"><span class="cl">    total number of events:              160174
</span></span><span class="line"><span class="cl">    total time taken by event execution: 119.9655
</span></span><span class="line"><span class="cl">    per-request statistics:
</span></span><span class="line"><span class="cl">         min:                                  0.26ms
</span></span><span class="line"><span class="cl">         avg:                                  0.75ms
</span></span><span class="line"><span class="cl">         max:                                 10.78ms
</span></span><span class="line"><span class="cl">         approx.  95 percentile:               1.13ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Threads fairness:
</span></span><span class="line"><span class="cl">    events (avg/stddev):           10010.8750/38.65
</span></span><span class="line"><span class="cl">    execution time (avg/stddev):   7.4978/0.00
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试三次得到的QPS为：21291.68,21670.85,21463.44。 <strong>相当于直连MySQL性能的77%左右，通过这个优化性能提升了18%左右</strong>。</p>
<h2 id="总结">总结</h2>
<p>通过这篇文章，介绍了通过Go语言提供的pprof对kingshard进行性能分析的详细步骤。对于其他Go语言项目也可以通过类似步骤生成性能报告文档。性能优化的关键是发现性能瓶颈，再去找优化方案。有时候简单的优化，就可以达到预想不到的效果，希望本文能给Go开发者在性能优化方面提供一个思路。</p>
<h1 id="kingshard的性能测试报告">kingshard的性能测试报告</h1>
<h2 id="1测试环境">1.测试环境</h2>
<h3 id="11服务器配置">1.1服务器配置</h3>
<table>
<thead>
<tr>
<th>类别</th>
<th>名称</th>
</tr>
</thead>
<tbody>
<tr>
<td>OS</td>
<td>云主机 Ubuntu 14.04 LTS</td>
</tr>
<tr>
<td>CPU</td>
<td>Common KVM CPU @ 2.40GHz *4</td>
</tr>
<tr>
<td>RAM</td>
<td>8GB</td>
</tr>
<tr>
<td>DISK</td>
<td>500GB</td>
</tr>
<tr>
<td>kingshard</td>
<td>master分支</td>
</tr>
<tr>
<td>Mysql</td>
<td>v5.6.25</td>
</tr>
<tr>
<td>Sysbench</td>
<td>v0.5</td>
</tr>
</tbody>
</table>
<h2 id="2性能需求">2.性能需求</h2>
<ol>
<li>测试通过kingshard转发SQL请求与直连DB发送SQL请求这两种情形下的性能差距。</li>
<li>测试配置文件中max_conns_limit参数对kingshard的影响，并找出最优值。</li>
</ol>
<h2 id="3测试准备工作">3.测试准备工作</h2>
<h3 id="31-kingshard性能测试环境搭建">3.1 kingshard性能测试环境搭建</h3>
<p>利用上述配置的4台服务器搭建了一个kingshard性能测试环境：</p>
<ul>
<li>服务器A运行着sysbench</li>
<li>服务器B运行着kingshard系统</li>
<li>服务器C运行着主库</li>
<li>服务器D运行着从库</li>
</ul>
<p>四台服务器处在同一个网段中。具体的拓扑图如下所示：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324233803.png" alt=""></p>
<p>有关kingshard系统安装与配置，请参考文档安装kingshard
有关sysbench v0.5的安装与命令选项，请参考sysbench</p>
<h2 id="4测试过程">4.测试过程</h2>
<p>执行下面的命令准备测试数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">time</span> sysbench --test<span class="o">=</span>/data/home/test_user/software/sysbench/sysbench/tests/db/oltp.lua <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-host<span class="o">=</span>host <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-port<span class="o">=</span><span class="m">9696</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-user<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-password<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-db<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --oltp-tables-count<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --oltp-table-size<span class="o">=</span><span class="m">1000000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --num-threads<span class="o">=</span><span class="m">50</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --max-requests<span class="o">=</span><span class="m">1000000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --report-interval<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              prepare
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述命令会创建表sbtest1，数据量为100w，建表语句如下:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">sbtest1</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">k</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;0&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">pad</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">xid</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">k_1</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">k</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">1000001</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w"> </span><span class="n">MAX_ROWS</span><span class="o">=</span><span class="mi">1000000</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="41-kingshard与直连db性能比较">4.1 kingshard与直连DB性能比较</h3>
<p>利用sysbench测试通过kingshard转发SQL请求和直连DB发送SQL请求这两种情况下，kingshard和Mysql系统的两项数据指标：<strong>QPS</strong>和每条<strong>SQL请求平均处理时间</strong>。</p>
<p>通过sysbench发送四类SQL请求：select、update、insert和delete，场景分别为只读、读写4比1和只写。</p>
<h4 id="411-kingshard与直连db只读比较">4.1.1 kingshard与直连DB只读比较</h4>
<p>通过修改host、port执行下面的命令分别测试kingshard转发SQL或直连DB：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">time</span> sysbench --test<span class="o">=</span>/data/home/test_user/software/sysbench/sysbench/tests/db/select.lua <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-host<span class="o">=</span>host <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-port<span class="o">=</span><span class="m">9696</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-user<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-password<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-db<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --oltp-tables-count<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --oltp-table-size<span class="o">=</span><span class="m">1000000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --num-threads<span class="o">=</span><span class="m">16</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --max-requests<span class="o">=</span><span class="m">1000000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --report-interval<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --max-time<span class="o">=</span><span class="m">20</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              run
</span></span></code></pre></td></tr></table>
</div>
</div><p>利用sysbench测试了并发线程个数不同的情况下，分别执行最大请求次数为100w的 select操作,通过修改&ndash;num-threads可以获得不同并发线程数。</p>
<p>测试连接 kingshard 和直连 DB 这两种情况下的 QPS（<strong>QPS越大，系统性能越好</strong>），
测试连接 kingshard 和直连 DB 这两种情况下的 执行sql平均时延（<strong>时延越小，系统性能越好</strong>），
每组数据重复测试三次后取平均值，具体数据对比如下表所示：</p>
<p><img src="./kingshard_performance_test_resources/%E5%8F%AA%E8%AF%BB-table.png" alt="数据对比"></p>
<p>上表对应的QPS折线图如下所示：</p>
<p><img src="./kingshard_performance_test_resources/qps-%E5%8F%AA%E8%AF%BB.png" alt="QPS折线图"></p>
<p>上表对应的时延折线图如下所示：</p>
<p><img src="./kingshard_performance_test_resources/%E6%97%B6%E5%BB%B6-%E5%8F%AA%E8%AF%BB.png" alt="时延折线图"></p>
<h4 id="412-kingshard与直连db读写41比较">4.1.2 kingshard与直连DB读写4:1比较</h4>
<p>通过修改host、port执行下面的命令分别测试kingshard转发SQL或直连DB：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ysbench --test<span class="o">=</span>/data/home/test_user/software/sysbench/sysbench/tests/db/oltp.lua <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-host<span class="o">=</span>host <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-port<span class="o">=</span><span class="m">3306</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-user<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-password<span class="o">=</span>ks <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-db<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --oltp-tables-count<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --oltp-table-size<span class="o">=</span><span class="m">1000000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --num-threads<span class="o">=</span><span class="m">16</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --max-requests<span class="o">=</span><span class="m">1000000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --report-interval<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --max-time<span class="o">=</span><span class="m">20</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              run
</span></span></code></pre></td></tr></table>
</div>
</div><p>利用sysbench测试了并发线程个数不同的情况下，分别执行最大请求次数为100w的 select、update、insert、delete等混合操作,通过修改&ndash;num-threads可以获得不同并发线程数。<br>
测试连接 kingshard 和直连 DB 这两种情况下的 QPS（<strong>QPS越大，系统性能越好</strong>），
测试连接 kingshard 和直连 DB 这两种情况下的 执行sql平均时延（<strong>时延越小，系统性能越好</strong>），
每组数据重复测试三次后取平均值，具体数据对比如下表所示：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324234215.png" alt=""></p>
<p>上表对应的QPS折线图如下所示：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324234238.png" alt=""></p>
<p>上表对应的时延折线图如下所示：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324234249.png" alt=""></p>
<h4 id="413-kingshard与直连db只写比较">4.1.3 kingshard与直连DB只写比较</h4>
<p>通过修改host、port执行下面的命令分别测试kingshard转发SQL或直连DB：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">time</span> sysbench --test<span class="o">=</span>/data/home/test_user/software/sysbench/sysbench/tests/db/insert.lua <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-host<span class="o">=</span>host <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-port<span class="o">=</span><span class="m">3306</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-user<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-password<span class="o">=</span>ks <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --mysql-db<span class="o">=</span>kingshard <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --oltp-tables-count<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --oltp-table-size<span class="o">=</span><span class="m">1000000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --num-threads<span class="o">=</span><span class="m">16</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --max-requests<span class="o">=</span><span class="m">1000000</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --report-interval<span class="o">=</span><span class="m">1</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              --max-time<span class="o">=</span><span class="m">20</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>              run
</span></span></code></pre></td></tr></table>
</div>
</div><p>利用sysbench测试了并发线程个数不同的情况下，分别执行最大请求次数为100w的insert操作,通过修改&ndash;num-threads可以获得不同并发线程数。<br>
测试连接 kingshard 和直连 DB 这两种情况下的 QPS（<strong>QPS越大，系统性能越好</strong>），
测试连接 kingshard 和直连 DB 这两种情况下的 执行sql平均时延（<strong>时延越小，系统性能越好</strong>），
每组数据重复测试三次后取平均值，具体数据对比如下表所示：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324234320.png" alt=""></p>
<p>上表对应的QPS折线图如下所示：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324234329.png" alt=""></p>
<p>上表对应的时延折线图如下所示：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200324234335.png" alt=""></p>
<p><strong>从QPS折线图可以看出，当sysbench的并发测试线程较少时，连接kingshard和直连DB的QPS差距较大。
这主要是因为当sysbench并发线程少时，kingshard的性能没有得到充分的发挥，
sysbench只有很少的线程向kingshard发送请求，此时网络延迟对QPS的影响是最主要的。</strong></p>
<p><strong>当sysbench的并发测试线程较大时，此时kingshard的性能就得到了充分的发挥，
QPS的对比是连接kingshard与直连DB性能对比的真实的反应，网络延迟对QPS的影响作用就显得很小了。</strong></p>
<p><strong>从以上几个表个的比例数据来看，通过kingshard转发select请求时的QPS是直连DB时80%左右，
而update和insert请求对应的QPS则更高一些，相当于直连DB时的85%左右,甚至在并发更高的情况下直连mysql的性能低于通过kingshards转发的性能。
由此看来利用kingshard转发SQL请求带来的性能下降虽有下降，但完全可以接受，甚至高并发场景下kingshard的性能优于直连DB的性能。这也是得益于kingshard在高并发的时候，充分利用了连接池的作用，降低了高并发带来的竞争消耗。</strong></p>
<p><strong>sysbench并发线程高于512的数据并没有给出，因为直连DB已经不能正常完成测试，但是kingshard可以完成。</strong></p>
<h3 id="42-max_conns_limit参数对kingshard性能影响">4.2 max_conns_limit参数对kingshard性能影响</h3>
<p>max_conns_limit 是 kingshard 初始化时创建的与后端mysql长连接个数，这个值设置的不同对 kingshard 性能也有比较明显的影响。</p>
<p>我们猜测max_conns_limit除了与<strong>kingshard所在主机CPU核心数</strong>有关外还与<strong>后端mysql能接纳的连接数</strong>有关。
我们分别测试将 max_conns_limit 设置为16、32、64、128、256、512时，kingshard转发select，update和insert三类操作请求时的 QPS，
SQL的混合情况为读写4比1，且sysbench的不同sql分别处于不同的事务中，具体对比结果如下所述：</p>
<p>上数测试对应的QPS折线图如下所示：</p>
<p><img src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200325000122.png" alt=""></p>
<p><strong>从kingshard处理三类SQL操作的QPS对比来看，将max_conns_limit参数设置为128左右较为合理, 高于128后通过提高max_conns_limit值并没有显著效果。</strong></p>
<p><strong>max_conns_limit参数值与kingshard所在主机核心数并没有必然的联系，与后端mysql主机可承受连接数关系密切。</strong></p>
<h2 id="5测试结论">5.测试结论</h2>
<p>本文主要测试了通过kingshard转发SQL请求与直连DB发送SQL请求这两种情形下的性能差距，和max_conns_limit值对kingshard的性能影响。<br>
ks的读写性能平均可以达到原生mysql性能的80%，一定条件下可以达到90%，随着并发数的增加甚至能超越mysql本身。<br>
ks可以对mysql形成保护，增加了ks后，db层对外表现出可以接收更高的并发数，且执行时间长短不同的sql使用各自的资源，形成了资源隔离，mysql不会出现性能毛刺。<br>
综合以上测试结果来看，kingshard性能表现较为优秀，并没有明显的性能下降。<strong>同时在测试中发现kingshard系统属于CPU密集型任务，相对于磁盘IO和内存占用率而言，kingshard对CPU消耗显得最为明显，所以建议在部署kingshard的时候需要优先考虑服务器的CPU性能。</strong></p>
<p>转载:<a href="https://github.com/flike/kingshard/blob/master/README_ZH.md">https://github.com/flike/kingshard/blob/master/README_ZH.md</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Forz</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2020-03-24
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/kingshard/">Kingshard</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/kingshard%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Kingshard使用指南</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/go%E7%94%9F%E6%88%90%E5%92%8C%E8%AF%86%E5%88%AB%E4%BA%8C%E7%BB%B4%E7%A0%81%E4%B8%8E%E6%9D%A1%E5%BD%A2%E7%A0%81/">
            <span class="next-text nav-default">Go生成和识别二维码</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="forz/forzblog.talk"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>Forz</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.64437849d125a2d603b3e71d6de5225d641a32d17168a58106e0b61852079683.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>






<script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
<script>
docsearch({
    apiKey: "b4b9da2eba53aa6dabe4b8ac9e8676e1",
    indexName: "forz.forzvina.com",
    appId: "IAR2EF5L65",
    inputSelector: '.docsearch-input',
    debug: false,
});
</script>
</body>
</html>
