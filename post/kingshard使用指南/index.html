<!DOCTYPE html>
<html lang="zh-cn" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Kingshard使用指南 | Forz Blog</title>
<meta name="keywords" content="Kingshard" />
<meta name="description" content="应用场景 现在很多互联网公司还是在大量使用MySQL来存储各种类型的关系型数据。随着访问量和数据量的增长，开发者不得不考虑一些MySQL相关的">
<meta name="author" content="">
<link rel="canonical" href="/post/kingshard%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.00d5d4fc479b1575183ee8d86b4fb372ba9d9b1904e96fa8e4c40ff7debe2b94.css" integrity="sha256-ANXU/EebFXUYPujYa0&#43;zcrqdmxkE6W&#43;o5MQP996&#43;K5Q=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.87.0" />
<meta property="og:title" content="Kingshard使用指南" />
<meta property="og:description" content="应用场景 现在很多互联网公司还是在大量使用MySQL来存储各种类型的关系型数据。随着访问量和数据量的增长，开发者不得不考虑一些MySQL相关的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/kingshard%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-03-25T00:10:16&#43;00:00" />
<meta property="article:modified_time" content="2020-03-25T00:10:16&#43;00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kingshard使用指南"/>
<meta name="twitter:description" content="应用场景 现在很多互联网公司还是在大量使用MySQL来存储各种类型的关系型数据。随着访问量和数据量的增长，开发者不得不考虑一些MySQL相关的"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "/post/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Kingshard使用指南",
      "item": "/post/kingshard%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Kingshard使用指南",
  "name": "Kingshard使用指南",
  "description": "应用场景 现在很多互联网公司还是在大量使用MySQL来存储各种类型的关系型数据。随着访问量和数据量的增长，开发者不得不考虑一些MySQL相关的",
  "keywords": [
    "Kingshard"
  ],
  "articleBody": "应用场景 现在很多互联网公司还是在大量使用MySQL来存储各种类型的关系型数据。随着访问量和数据量的增长，开发者不得不考虑一些MySQL相关的新问题：\n 读写分离问题。由于前端应用访问量增加，单台MySQL不足以支撑整个系统的写入和查询操作。这时候，我们不得不将一些耗时的查询操作分散到多个slave上。 单表容量问题。如果在系统设计之初，没有考虑到分表问题。随着数据量的增长，单表容量越来越大。作者见过单表容量5亿条记录，然后一个简单的delete操作都会引起系统慢日志，而且有可能导致MySQL IO瞬发性的飙升。很多同学可能会想到，在查询的字段上加上索引，但当数据量增长到这么大的时候，即使加上索引效果也不明显了。归根结底，就是单表数据量太大，导致MySQL即使通过索引定位数据，仍然需要扫描很多记录。 数据库的运维问题。如果在代码中配置主库和从库host，系统运行当然也是没问题的。但这样大大增加了运维工作的压力，比如：MySQL数据库IO压力由于访问量的增加居高不下，DBA需要添加一台slave，这时候就不得不修改代码，然后打包并上线。还有很多非常实际的例子，在这就不一一列举。 连接池。前端应用频繁连接MySQL，由此给MySQL带来的额外性能消耗也是不容忽视的。如果通过增加一个连接池，每个DB缓存一定数量的MySQL连接，当有应用需要连接后端的MySQL，直接从连接池里取出一个已建好的连接来发送SQL请求，这样会大大加快数据查询速度。而且可以降低MySQL的性能消耗。 SQL日志。在程序出现问题时，我们希望得到一些SQL日志，比如，什么时刻哪条SQL发送到哪一台DB上了。通过查看这种日志能够帮助我们快速定位问题。  面对这些问题，我们可以在客户端代码中逐一实现。但这样也会使得客户端越来越重，不那么灵活。kingshard对上述5类问题都有比较合适的解决方案。下面对kingshard的主要功能，逐个介绍并演示一下。\n入门指南 架构图 配置文件 下面给出一个配置文件范例，用户可以自行按照自己的需求逐项配置：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103  # kingshard的地址和端口addr :0.0.0.0:9696# 连接kingshard的用户名和密码的用户列表-user_list:-user :kingshardpassword :kingshard#kingshard的web API 端口web_addr :0.0.0.0:9797#调用API的用户名和密码web_user :adminweb_password :admin# log级别，[debug|info|warn|error],默认是errorlog_level :debug# 打开SQL日志，设置为on;关闭SQL日志，设置为offlog_sql :on#如果设置了该项，则只输出SQL执行时间超过slow_log_time(ms)的SQL日志，不设置则输出全部SQL日志slow_log_time :100#日志文件路径，如果不配置则会输出到终端。log_path :/Users/flike/log# sql黑名单文件路径# 所有在该文件中的sql都会被kingshard拒绝转发#blacklist_sql_file: /Users/flike/blacklist# 只允许下面的IP列表连接kingshard，如果不配置则对连接kingshard的IP不做限制。allow_ips:127.0.0.1# kingshard使用的字符集，如果不设置该选项，则kingshard使用utf8作为默认字符集#proxy_charset: utf8mb4# 一个node节点表示mysql集群的一个数据分片，包括一主多从（可以不配置从库）nodes :-#node节点名字name :node1# 连接池中最大的空闲连接数，也就是kingshard最多与后端DB建立max_conns_limit个连接max_conns_limit :16# kingshard连接该node中mysql的用户名和密码，master和slave的用户名和密码必须一致user :kingshardpassword :kingshard# master的地址和端口master :127.0.0.1:3306# slave的地址和端口，可不配置#slave : 192.168.0.12@2,192.168.0.13@3#kingshard在300秒内都连接不上mysql，kingshard则会下线该mysqldown_after_noalive :300-name :node2max_conns_limit :16user :kingshardpassword :kingshardmaster :192.168.59.103:3307slave :down_after_noalive:100# 各用户的分表规则schema_list :-#schema的所属用户名user:kingshard#分表分布的node名字nodes:[node1,node2]#所有未分表的SQL，都会发往默认node。default:node1shard:-#分表使用的dbdb :kingshard#分表名字table:test_shard_hash#分表字段key:id#分表分布的nodenodes:[node1, node2]#分表类型type:hash#子表个数分布，表示node1有4个子表，#node2有4个子表。locations:[4,4]-#分表使用的dbdb :kingshard#分表名字table:test_shard_range#分表字段key:id#分表类型type:range#分表分布的nodenodes:[node1, node2]#子表个数分布，表示node1有4个子表，#node2有4个子表。locations:[4,4]#表示每个子表包含的最大记录数，也就是说每#个子表最多包好10000条记录。即子表1对应的id为[0,10000),子表2[10000,20000)....table_row_limit:10000  这里着重说一下分表的配置规则：\n kingshard支持两种类型的分表规则：hash和range。 kingshard分表涉及到的子表，需要用户在各个db手动创建好，并且格式是：table_name_%4d,也就是说子表下标由4位数组成。例如:table_name_0000,table_name_0102。 所有操作未分表的SQL语句都将发送到默认节点。  有关sharding设置是通过schema设置,一个kingshard实例只能有一个schemas，从上面的配置可以看出，schema可以分为三个部分：\n  db，表示这个schemas使用的数据库。\n  nodes，表示子表分布的节点名字。\n  rules，sharding规则。其中rules又可以分为两个部分：\n default，默认分表规则。所有操作不在shard（default规则下面的则）中的表的SQL语句都会发向该node。 hash，hash分表方式。 range，range分表方式    安装和启动  安装Go语言环境（请使用最新版），具体步骤请Google。 git clone https://github.com/flike/kingshard.git src/github.com/flike/kingshard cd src/github.com/flike/kingshard source ./dev.sh make 设置配置文件 运行kingshard。./bin/kingshard -config=etc/ks.yaml  注意：\n1. kingshard会响应SIGINT,SIGTERM,SIGQUIT这三个信号，平滑退出。在部署kingshard机器上应避免产生这三个信号，以免造成kingshard非正常退出！后台运行kingshard建议使用supervisor工具\n2. kingshard采用的是yaml方式解析配置文件，需要注意的是yaml配置文件不允许出现tab键，且冒号后面需要跟一个空格。配置文件编写完成后，可以在yaml lint网站验证是否有格式错误。\n3. 可以通过./bin/kingshard -v来查看kingshard的commit hash和编译时间，从而维持kingshard的版本。\n4. etc目录下有两个配置文件(ks.yaml,unshard.yaml),如果需要分表功能，请基于ks.yaml修改配置。如果不需要分表，基于unshard.yaml修改配置。\n跨节点分表 由于作者的只有两台MySQL，所以搭建了两个节点，这两个节点都只有一台Master 角色的MySQL数据库，具体的拓扑图如下所示：\n分表操作演示 分表操作有hash和range两种类型，在这里只演示hash类型的分表操作，range类型的分表类似，就不再赘述了。\n手动创建子表 在node1和node2上各创建4张子表，下面只给出在node1上test_shard_hash_0000的建表SQL语句，其他子表的建表SQL语句类似。node1包含：test_shard_hash_0000, test_shard_hash_0001, test_shard_hash_0002, test_shard_hash_0003。node2包含：test_shard_hash_0004, test_shard_hash_0005, test_shard_hash_0006, test_shard_hash_0007。\n1 2 3 4 5 6 7 8 9  CREATETABLE`test_shard_hash_0000`(`id`bigint(64)unsignedNOTNULL,`str`varchar(256)DEFAULTNULL,`f`doubleDEFAULTNULL,`e`enum('test1','test2')DEFAULTNULL,`u`tinyint(3)unsignedDEFAULTNULL,`i`tinyint(4)DEFAULTNULL,PRIMARYKEY(`id`))ENGINE=InnoDBDEFAULTCHARSET=utf8  分表的插入和查询 执行下面SQL语句，根据查询的结果可以看出SQL语句根据分表规则落到不同的子表。查询操作（select）可以跨多个node，当更新操作涉及到多个node时，kingshard会以非事务的方式执行跨node的更新。为了保证数据一致性，请根据实际需求使用非事务方式的跨node更新操作。\n1 2 3 4 5 6 7 8 9 10 11  mysqlinsertintotest_shard_hash(id,str,f,e,u,i)values(15,\"flike\",3.14,'test2',2,3);QueryOK,1rowaffected(0.01sec)mysqlmysqlinsertintotest_shard_hash(id,str,f,e,u,i)values(7,\"chen\",2.1,'test1',32,3);QueryOK,1rowaffected(0.01sec)mysqlinsertintotest_shard_hash(id,str,f,e,u,i)values(17,\"github\",2.5,'test1',32,3);QueryOK,1rowaffected(0.00sec)mysqlinsertintotest_shard_hash(id,str,f,e,u,i)values(18,\"kingshard\",7.3,'test1',32,3);QueryOK,1rowaffected(0.01sec)  对应的SQL日志如下所示：\n1 2 3 4  2015/09/0218:48:24-INFO-127.0.0.1:55003-192.168.59.103:3307:insertintotest_shard_hash_0007(id,str,f,e,u,i)values(15,'flike',3.14,'test2',2,3)2015/09/0218:49:05-INFO-127.0.0.1:55003-192.168.59.103:3307:insertintotest_shard_hash_0007(id,str,f,e,u,i)values(7,'chen',2.1,'test1',32,3)2015/09/0218:49:51-INFO-127.0.0.1:55003-127.0.0.1:3306:insertintotest_shard_hash_0001(id,str,f,e,u,i)values(17,'github',2.5,'test1',32,3)2015/09/0218:50:21-INFO-127.0.0.1:55003-127.0.0.1:3306:insertintotest_shard_hash_0002(id,str,f,e,u,i)values(18,'kingshard',7.3,'test1',32,3)  可以看到前两条SQL发送到了node2的master上了，后两条SQL发送到node1上的master了。\n然后我们可以用select语句查看数据，且select支持跨node查询。\n1 2 3 4 5 6 7 8 9  mysqlselect*fromtest_shard_hashwhereid18;+----+--------+------+-------+------+------+ |id|str|f|e|u|i|+----+--------+------+-------+------+------+ |17|github|2.5|test1|32|3||7|chen|2.1|test1|32|3||15|flike|3.14|test2|2|3|+----+--------+------+-------+------+------+ 3rowsinset(0.02sec)  因为是hash类型的分表，所以对于select范围类型的查询，必须查询每一个子表。对应的SQL日志如下所示：\n1 2 3 4 5 6 7 8  2015/09/0218:55:01-INFO-127.0.0.1:55003-127.0.0.1:3306:select*fromtest_shard_hash_0000whereid182015/09/0218:55:01-INFO-127.0.0.1:55003-127.0.0.1:3306:select*fromtest_shard_hash_0001whereid182015/09/0218:55:01-INFO-127.0.0.1:55003-127.0.0.1:3306:select*fromtest_shard_hash_0002whereid182015/09/0218:55:01-INFO-127.0.0.1:55003-127.0.0.1:3306:select*fromtest_shard_hash_0003whereid182015/09/0218:55:01-INFO-127.0.0.1:55003-192.168.59.103:3307:select*fromtest_shard_hash_0004whereid182015/09/0218:55:01-INFO-127.0.0.1:55003-192.168.59.103:3307:select*fromtest_shard_hash_0005whereid182015/09/0218:55:01-INFO-127.0.0.1:55003-192.168.59.103:3307:select*fromtest_shard_hash_0006whereid182015/09/0218:55:01-INFO-127.0.0.1:55003-192.168.59.103:3307:select*fromtest_shard_hash_0007whereid18  对应等值的select查询，kingshard会计算出具体命中的子表，然后只会在相应的子表中查询。对应的SQL如下所示：\n1 2 3 4 5 6 7  mysqlselect*fromtest_shard_hashwhereid=18;+----+-----------+------+-------+------+------+ |id|str|f|e|u|i|+----+-----------+------+-------+------+------+ |18|kingshard|7.3|test1|32|3|+----+-----------+------+-------+------+------+ 1rowinset(0.00sec)  对应的SQL日志如下所示：\n1  2015/09/02 18:59:37 - INFO - 127.0.0.1:55003-127.0.0.1:3306:select * from test_shard_hash_0002 where id = 18   分表的更新 当更新的记录落在同一个子表时，kingshard支持这类操作。在上面插入的记录中，id为7和15的记录都落在test_shard_hash_0007中，所以可以成功地执行下面的SQL：\n1 2  mysqlupdatetest_shard_hashsetu=123whereid=15orid=7;QueryOK,2rowsaffected(0.01sec)  对应的SQL日志是：\n1  2015/09/0219:17:27-INFO-127.0.0.1:55003-192.168.59.103:3307:updatetest_shard_hash_0007setu=123whereid=15orid=7  当更新的记录落在不同的子表，kingshard会以非事务的方式将更新操作发送到多个node上。例如执行如下SQL：\n1 2  mysqlupdatetest_shard_hashsetstr=\"myworld_test4\"whereidin(128,1,231);QueryOK,3rowsaffected(0.02sec)  对应的SQL日志是：\n1 2 3  2016/03/1515:18:27-OK-1.2ms-127.0.0.1:60730-127.0.0.1:3306:updatetest_shard_hash_0000setstr='myworld_test4'whereidin(128,1,231)2016/03/1515:18:27-OK-0.5ms-127.0.0.1:60730-127.0.0.1:3306:updatetest_shard_hash_0001setstr='myworld_test4'whereidin(128,1,231)2016/03/1515:18:27-OK-6.8ms-127.0.0.1:60730-192.168.59.103:3307:updatetest_shard_hash_0007setstr='myworld_test4'whereidin(128,1,231)  指定发送的node 有时候我们需要操作的表，不在default node中。在kingshard中允许用户将特定的sql路由到指定的node上。只需要在sql语句前面加上包含node名称的注释(连接MySQL时需要加上-c选项，避免客户端过滤掉注释)。例如：\n1  mysql-h127.0.0.1-ukingshard-pkingshard-P9696-c;  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42  mysql/*node2*/showtables;+-----------------------+ |Tables_in_kingshard|+-----------------------+ |kingshard_test_conn||test_shard_hash_0004||test_shard_hash_0005||test_shard_hash_0006||test_shard_hash_0007||test_shard_range_0004||test_shard_range_0005||test_shard_range_0006||test_shard_range_0007|+-----------------------+ 9rowsinset(0.03sec)mysql/*node2*/select*fromkingshard_test_conn;Emptyset(0.01sec)mysql/*node2*/desckingshard_test_conn;+-------+-----------------------+------+-----+---------+-------+ |Field|Type|Null|Key|Default|Extra|+-------+-----------------------+------+-----+---------+-------+ |id|bigint(20)unsigned|NO|PRI|NULL|||str|varchar(256)|YES||NULL|||f|double|YES||NULL|||e|enum('test1','test2')|YES||NULL|||u|tinyint(3)unsigned|YES||NULL|||i|tinyint(4)|YES||NULL||+-------+-----------------------+------+-----+---------+-------+ 6rowsinset(0.00sec)mysql/*node2*/insertintokingshard_test_connvalues(10,\"hello\",10.2,'test1',1,1);QueryOK,1rowaffected(0.00sec)mysql/*node2*/select*fromkingshard_test_conn;+----+-------+------+-------+------+------+ |id|str|f|e|u|i|+----+-------+------+-------+------+------+ |10|hello|10.2|test1|1|1|+----+-------+------+-------+------+------+ 1rowinset(0.00sec)  强制读主库 有时候在主库中插入数据后，希望立即从主库读出来。在kingshard中由于读写分离的原因，select默认会发送到相应node的从库上。但是只需要在select语句中加入相应的注释项（/*master*/)，就可以将select语句发送到主库。\n1 2 3 4 5 6 7 8 9  mysqlselect/*master*/*fromkingshard_test_conn;+----+----------+------+-------+------+------+ |id|str|f|e|u|i|+----+----------+------+-------+------+------+ |1|a|3.14|test1|NULL|NULL||5|\"\"''\\abc|NULL|NULL|NULL|NULL||6|中国|NULL|NULL|NULL|NULL|+----+----------+------+-------+------+------+ 3rowsinset(0.01sec)  跨node的sum和count函数 在kingshard中，支持sum和count函数，kingshard会将相应的SQL发送到正确的DB，并将结果合并起来再返回给客户的。例如：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  mysqlselectcount(id)fromtest_shard_hashwhereid1;+-----------+ |count(id)|+-----------+ |4|+-----------+ 1rowinset(0.02sec)mysqlselectsum(id)fromtest_shard_hashwhereid1;+---------+ |sum(id)|+---------+ |57|+---------+ 1rowinset(0.02sec)  相应的SQL日志如下所示：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  2015/09/0314:49:01-INFO-127.0.0.1:55768-127.0.0.1:3306:selectcount(id)fromtest_shard_hash_0000whereid12015/09/0314:49:01-INFO-127.0.0.1:55768-127.0.0.1:3306:selectcount(id)fromtest_shard_hash_0001whereid12015/09/0314:49:01-INFO-127.0.0.1:55768-127.0.0.1:3306:selectcount(id)fromtest_shard_hash_0002whereid12015/09/0314:49:01-INFO-127.0.0.1:55768-127.0.0.1:3306:selectcount(id)fromtest_shard_hash_0003whereid12015/09/0314:49:01-INFO-127.0.0.1:55768-192.168.59.103:3307:selectcount(id)fromtest_shard_hash_0004whereid12015/09/0314:49:01-INFO-127.0.0.1:55768-192.168.59.103:3307:selectcount(id)fromtest_shard_hash_0005whereid12015/09/0314:49:01-INFO-127.0.0.1:55768-192.168.59.103:3307:selectcount(id)fromtest_shard_hash_0006whereid12015/09/0314:49:01-INFO-127.0.0.1:55768-192.168.59.103:3307:selectcount(id)fromtest_shard_hash_0007whereid12015/09/0314:49:14-INFO-127.0.0.1:55768-127.0.0.1:3306:selectsum(id)fromtest_shard_hash_0000whereid12015/09/0314:49:14-INFO-127.0.0.1:55768-127.0.0.1:3306:selectsum(id)fromtest_shard_hash_0001whereid12015/09/0314:49:14-INFO-127.0.0.1:55768-127.0.0.1:3306:selectsum(id)fromtest_shard_hash_0002whereid12015/09/0314:49:14-INFO-127.0.0.1:55768-127.0.0.1:3306:selectsum(id)fromtest_shard_hash_0003whereid12015/09/0314:49:14-INFO-127.0.0.1:55768-192.168.59.103:3307:selectsum(id)fromtest_shard_hash_0004whereid12015/09/0314:49:14-INFO-127.0.0.1:55768-192.168.59.103:3307:selectsum(id)fromtest_shard_hash_0005whereid12015/09/0314:49:14-INFO-127.0.0.1:55768-192.168.59.103:3307:selectsum(id)fromtest_shard_hash_0006whereid12015/09/0314:49:14-INFO-127.0.0.1:55768-192.168.59.103:3307:selectsum(id)fromtest_shard_hash_0007whereid1  跨node的order by kingshard支持跨node的select操作使用order by，kingshard先将合适的SQL发生到对应的node，然后将结果集在内存中排序，从而实现select的order by操作。示例如下所示：\n1 2 3 4 5 6 7 8 9 10  mysqlselect*fromtest_shard_hashwhereid1orderbyid;+----+-----------+------+-------+------+------+ |id|str|f|e|u|i|+----+-----------+------+-------+------+------+ |7|chen|2.1|test1|123|3||15|flike|3.14|test2|123|3||17|github|2.5|test1|32|23||18|kingshard|7.3|test1|32|23|+----+-----------+------+-------+------+------+ 4rowsinset(0.02sec)  对应的SQL日志为：\n1 2 3 4 5 6 7 8  2015/09/0314:54:11-INFO-127.0.0.1:55768-127.0.0.1:3306:select*fromtest_shard_hash_0000whereid1orderbyidasc2015/09/0314:54:11-INFO-127.0.0.1:55768-127.0.0.1:3306:select*fromtest_shard_hash_0001whereid1orderbyidasc2015/09/0314:54:11-INFO-127.0.0.1:55768-127.0.0.1:3306:select*fromtest_shard_hash_0002whereid1orderbyidasc2015/09/0314:54:11-INFO-127.0.0.1:55768-127.0.0.1:3306:select*fromtest_shard_hash_0003whereid1orderbyidasc2015/09/0314:54:11-INFO-127.0.0.1:55768-192.168.59.103:3307:select*fromtest_shard_hash_0004whereid1orderbyidasc2015/09/0314:54:11-INFO-127.0.0.1:55768-192.168.59.103:3307:select*fromtest_shard_hash_0005whereid1orderbyidasc2015/09/0314:54:11-INFO-127.0.0.1:55768-192.168.59.103:3307:select*fromtest_shard_hash_0006whereid1orderbyidasc2015/09/0314:54:11-INFO-127.0.0.1:55768-192.168.59.103:3307:select*fromtest_shard_hash_0007whereid1orderbyidasc  单node的事务 kingshard支持在单个node上执行事务，也就是说同一个事务不能跨多个node，当出现跨node的情况时，kingshard会返回错误给客户端。可以跨同node上的不同子表。示例如下所示：\n1 2 3 4 5 6 7 8  mysqlbegin;QueryOK,0rowsaffected(0.00sec)mysqlinsertintotest_shard_hash(id,str,f,e,u,i)values(23,'proxy',9.2,'test1',12,3);QueryOK,1rowaffected(0.00sec)mysqlcommit;QueryOK,0rowsaffected(0.01sec)  当在一个事务中，出现跨node的SQL语句时，kingshard会返回错误：\n1 2 3 4 5 6  #SQL语句在node2中执行mysqlinsertintotest_shard_hash(id,str,f,e,u,i)values(31,'proxy',9.2,'test1',12,3);QueryOK,1rowaffected(0.01sec)#SQL语句在需要在node1执行，跨node了。mysqlinsertintotest_shard_hash(id,str,f,e,u,i)values(40,'proxy',9.2,'test1',12,3);ERROR1105(HY000):transactioninmultinode  sharding 现在开源的MySQL Proxy已经有几款了，并且有的已经在生产环境上广泛应用。但这些proxy在sharding方面，都是不能分子表的。也就是说一个node节点只能分一张表。但我们的线上需求通常是这样的：\n我有一张非常大的表，行数超过十亿，需要进行拆分处理。假设拆分因子是512。 如果采用单node单数据库的分表方式，那其实这512个子表还是存在一个物理节点上，意义不大。 如果采用他们的sharding功能，就需要512个物理节点，也不现实。 面对这种需求，现有的proxy就不能很好地满足要求了。通常我们希望将512张子表均分在几个MySQL节点上，从而达到系统的横向扩展。\n然而kingshard较好地实现了这种典型的需求。简单来说，kingshard的分表方案采用两级映射的方式：\n kingshard将该表分成512张子表，例如：test_0000,test_0001,…test_0511。 将shardKey通过hash或range方式定位到其要操作的记录在哪张子表上。 子表落在哪个node上通过配置文件设置。  支持操作 目前kingshard sharding支持insert, delete, select, update和replace语句, 所有这五类操作都支持跨子表。但写操作的原子性仅支持单node上的跨子表，select操作则可以跨node，跨子表。\nsharding方式 range方式 基于整数范围划分来得到子表下标。该方式的优点：基于范围的查询或更新速度快，因为查询（或更新）的范围有可能落在同一张子表中。这样可以避免全部子表的查询（更新）。缺点：数据热点问题。因为在一段时间内整个集群的写压力都会落在一张子表上。此时整个mysql集群的写能力受限于单台mysql server的性能。并且，当正在集中写的mysql 节点如果宕机的话，整个mysql集群处于不可写状态。基于range方式的分表字段类型受限。\nhash方式 kingshard采用（shardKey%子表个数）的方式得到子表下标。优点：数据分布均匀，写压力会比较平均地落在后端的每个MySQL节点上，整个集群的写性能不会受限于单个MySQL节点。并且当某个分片节点宕机，只会影响到写入该节点的请求，其他节点的写入请求不受影响。分表字段类型不受限。因为任何一个类型的分表字段，都可以通过一个hash函数计算得到一个整数。缺点：基于范围的查询或更新，都需要将请求发送到全部子表，对性能有一定影响。但如果不是基于范围的查询或更新，则性能不会受到影响。\n时间维度分表 按时间维度分表的场景非常普遍，下面介绍一下kingshard的时间分表功能\n支持的时间类型 kingshard中的分表字段支持MySQL中三种类型的时间格式\n date类型，格式：YYYY-MM-DD，例如:2016-03-04,注意：2016-3-04，2016-03-4，2016-3-4等格式kingshard都是不支持的。 datetime类型，格式：YYYY-MM-DD HH:MM:SS，例如:2016-03-04 13:23:43,注意：2016-3-04 13:23:43，2016-03-4 13:23:43，2016-3-4 13:23:43等格式kingshard都是不支持的，必须严格按照规定的格式，kingshard才支持。 timestamp类型，整数类型，例如：1457165568，对应的是：2016-3-5 16:12:48。  支持的时间分表类型 kingshard支持MySQL中三种格式的时间类型\n date类型，格式：YYYY-MM-DD，例如:2016-03-04,注意：2016-3-04，2016-03-4，2016-3-4等格式kingshard都是不支持的。 datetime，格式：YYYY-MM-DD HH:MM:SS，例如:2016-03-04 13:23:43,注意：2016-3-04 13:23:43，2016-03-4 13:23:43，2016-3-4 13:23:43等格式kingshard都是不支持的，必须严格按照规定的格式，kingshard才支持。 timestamp，整数类型。  功能演示 kingshard的配置文件如下所示：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  schema_list :-user:kingshardnodes:[node1,node2]default:node1shard:-db :kingshardtable:test_shard_yearkey:ctimetype:date_yearnodes:[node1,node2]date_range:[2015-2016,2017-2018]  按年分表 配置说明 按年分表的配置项设置如下：\n1 2 3 4 5  table:test_shard_yearkey:ctimetype:date_yearnodes:[node1,node2]date_range:[2015-2016,2017-2018]  该配置表示：\n sharding key是ctime。 按年的分表类型是:date_year。 test_shard_year_2015, test_shard_year_2016两个子表落在node1上，test_shard_year_2017，test_shard_year_2018两个子表落在node2上。 如果你一个node上只包含一张子表，你可以这样配置date_range[2015,2017-2018]。  注意：子表的命名格式必须是:shard_table_YYYY,shard_table是分表名，后面接具体的年。传入范围必须是有序递增的,不能是[2016,2013-2014]\n功能演示 在node1上创建两张子表test_shard_year_2015, test_shard_year_2016，在node2上创建两种子表test_shard_year_2017，test_shard_year_2018。建表SQL如下\n1 2 3 4 5 6  CREATETABLE`test_shard_year_2016`(`id`int(10)NOTNULL,`name`varchar(40)DEFAULTNULL,`ctime`datetimeDEFAULTNULL,PRIMARYKEY(`id`))ENGINE=InnoDBDEFAULTCHARSET=utf8;  插入数据：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  mysqlinsertintotest_shard_year(id,name,ctime)values(12,\"hello\",\"2015-02-22 13:23:45\");QueryOK,1rowaffected(0.01sec)mysqlinsertintotest_shard_year(id,name,ctime)values(13,\"world\",\"2016-03-22\");QueryOK,1rowaffected(0.00sec)mysqlselect*fromtest_shard_yearwherectime\"2016-03-23\";+----+-------+---------------------+ |id|name|ctime|+----+-------+---------------------+ |12|hello|2015-02-2213:23:45||13|world|2016-03-2200:00:00|+----+-------+---------------------+ 2rowsinset(0.00sec)  对应的SQL log信息是：\n1 2 3 4  2016/03/0512:06:32-OK-1.2ms-127.0.0.1:56597-127.0.0.1:3306:insertintotest_shard_year_2015(id,name,ctime)values(12,'hello','2015-02-22 13:23:45')2016/03/0512:06:59-OK-2.0ms-127.0.0.1:56597-127.0.0.1:3306:insertintotest_shard_year_2016(id,name,ctime)values(13,'world','2016-03-22')2016/03/0512:08:30-OK-1.6ms-127.0.0.1:56597-127.0.0.1:3306:select*fromtest_shard_year_2015wherectime'2016-03-23'2016/03/0512:08:30-OK-0.3ms-127.0.0.1:56597-127.0.0.1:3306:select*fromtest_shard_year_2016wherectime'2016-03-23'  当然如果你把id作为一个unix时间戳，来分表的话，kingshard也是支持的。具体配置就是这样的：\n1 2 3 4 5 6  table:test_shard_yearkey:idtype:date_yearnodes:[node1,node2]date_range:[2015-2016,2017-2018]  插入数据:\n1 2 3 4 5 6 7 8 9 10 11  mysqlinsertintotest_shard_year(id,name,ctime)values(1457410310,\"world\",\"2018-03-22\");QueryOK,1rowaffected(0.01sec)mysqlselect*fromtest_shard_yearwhereid=1457410310;+------------+-------+---------------------+ |id|name|ctime|+------------+-------+---------------------+ |1457410310|world|2018-03-2200:00:00|+------------+-------+---------------------+ 1rowinset(0.00sec)  1457410310 这个unix时间戳对应的日期是：2016-3-8 12:11:50。kingshard准确地将这条记录路由到了test_shard_year_2016这张子表中了。 对应的SQL log是：\n1 2 3  2016/03/0812:12:49-OK-1.0ms-127.0.0.1:56669-127.0.0.1:3306:insertintotest_shard_year_2016(id,name,ctime)values(1457410310,'world','2018-03-22')2016/03/0812:13:23-OK-0.4ms-127.0.0.1:56669-127.0.0.1:3306:select*fromtest_shard_year_2016whereid=1457410310  按月分表 配置说明 按月分表的配置项设置如下：\n1 2 3 4 5  table:test_shard_monthkey:ctimetype:date_monthnodes:[node1,node2]date_range:[201512-201602,201609-2016010]  该配置表示：\n sharding key是ctime。 按月的分表类型是:date_month。 test_shard_month_201512, test_shard_month_201601, test_shard_month_201602两个子表落在node1上，test_shard_month_201609，test_shard_month_201610两个子表落在node2上。 如果你一个node上只包含一张子表，你可以这样配置date_range[201501,201609-201610]。  注意：子表的命名格式必须是:shard_table_YYYYMM,shard_table是分表名，后面接具体的年和月。传入范围必须是有序递增的,不能是[201609-201610,201501]\n功能演示参考按年分表的操作。\n按天分表 配置说明 按天分表的配置项设置如下：\n1 2 3 4 5  table:test_shard_daykey:ctimetype:date_daynodes:[node1,node2]date_range:[20151222-20151224,20160901-20160902]  该配置表示：\n sharding key是ctime。 按天的分表类型是:date_day。 test_shard_day_20151222, test_shard_day_20151223, test_shard_day_20151224两个子表落在node1上，test_shard_day_20160901，test_shard_day_20160902两个子表落在node2上。 如果你一个node上只包含一张子表，你可以这样配置date_range[20150101,20160901-20161010]。  注意：子表的命名格式必须是:shard_table_YYYYMMDD,shard_table是分表名，后面接具体的年,月和日。传入范围必须是有序递增的,不能是[20160901-20161010,20150101]\n功能演示参考按年分表的操作。\n子表迁移方案 通过kingshard可以非常方便地动态迁移子表，从而保证MySQL节点的不至于负载压力太大。大致步骤如下所述：\n 通过自动数据迁移工具开始数据迁移。 数据差异小于某一临界值，阻塞老子表写操作（read-only） 等待新子表数据同步完毕 更改kingshard配置文件中的对应子表的路由规则。 删除老节点上的子表。  Kingshard支持SQL的范围 简要说明 kingshard在非分表的情况下支持绝大部分MySQL语法和协议，包括类似SHOW DATABASES, SHOW TABLES, 以及各种DML语句和DDL语句。在分表的情况下，目前只支持有限的DML语句，主要包含：SELECT,UPDATE,INSERT,REPLACE, DELETE这五种SQL操作。并且不支持自动建子表功能。以及有限的kingshard自定义管理端命令。在分表和非分表的情况下，都不支持以下情形：\n 暂不支持用户自定义数据类型、自定义函数。 暂不支持视图、存储过程、触发器、游标。 暂不支持类似 BEGIN…END，LOOP…END LOOP，REPEAT…UNTIL…END REPEAT，WHILE…DO…END WHILE 等的复合语句。 暂不支类似 IF,WHILE 等流程控制类语句。 下面分两部分介绍kingshard支持SQL的情况：非分表情况下SQL支持范围和分表情况下SQL支持范围。  非分表情况下SQL的支持范围 以下说明都是基于非分表的情况下，SQL的支持情况。\n数据库DDL语法  CREATE TABLE Syntax CREATE INDEX Syntax DROP TABLE Syntax DROP INDEX Syntax ALTER TABLE Syntax TRUNCATE TABLE Syntax  数据库DML语法  INSERT Syntax INSERT DELAYED Syntax 暂不支持 REPLACE Syntax UPDATE Syntax DELETE Syntax Subquery Syntax Scalar Subquery Comparisons Subquery Subqueries with ANY, IN, or SOME Subqueries with ALL Row Subqueries Subqueries with EXISTS or NOT EXISTS Subqueries in the FROM Clause SELECT Syntax SELECT INTO OUTFILE/INTO DUMPFILE/INTO var_name 暂不支持 Last_insert_id特性  事务的支持  START TRANSACTION, COMMIT, and ROLLBACK Syntax 暂不支持transaction_characteristic定义 暂不支持savepoint嵌套事务的相关语法 暂不支持XA事务的相关语法 支持set autocommit=0/1方式设置事务. 支持begin/commit方式设置事务 支持start transaction方式设置事务 SET TRANSACTION Syntax 暂不支持对global的事务隔离级别进行调整  预处理的支持  Prepared Statements  支持主流语言（java,php,python,C/C++,Go)SDK的MySQL的Prepare语法。\n数据库管理语法的支持  SET Syntax 只支持字符集和set autocommit相关语法，其他set语法未测试过。 Show Syntax 默认show操作会转发到默认DB，需要查看其他DB的内容，通过在SQL中加注释的方式。 KILL Syntax 目前不支持KILL QUERY processlist_id  数据库管理语法的支持  DESCRIBE Syntax EXPLAIN Syntax USE Syntax  数据库系统函数的支持 默认都支持（未测试）\n分表的情况下SQL的支持范围 数据库DDL语法  CREATE TABLE Syntax CREATE INDEX Syntax DROP TABLE Syntax DROP INDEX Syntax ALTER TABLE Syntax TRUNCATE TABLE Syntax  分表的情况下支持这些语法，但需要在SQL中加注释，例如： /*node1*/create table stu_0000(id int, name char(20)); 这样kingshard就会将该SQL转发到node1节点的Master上。\n注： truncate如果不指定节点注释则会将所有分表都清空，例如：truncate stu\n数据库DML语法  INSERT Syntax INSERT DELAYED Syntax 不支持 INSERT INTO SELECT 不支持 REPLACE Syntax UPDATE Syntax //分表使用的字段无论何种分表类型都不能作为被更新的字段。 UPDATE SET xx=REPLACE(xx,‘a’,‘b’) Syntax 不支持 DELETE Syntax Subquery Syntax SELECT Syntax  对于UPDATE，DELETE和SELECT三种SQL中WHERE后面的条件不能包含子查询，函数等。只能是字段名。\n数据库管理语法的支持  DESCRIBE Syntax 通过SQL语句hint方式支持，例如: /*node2*/describe table_name EXPLAIN Syntax 通过SQL语句hint方式支持，例如: /*node2*/explain select * from xxxx USE Syntax  分表聚合函数的支持 支持以下聚合函数：\n sum函数 max函数 count函数 min函数 不支持distinct后聚合，例如: select count(distinct id) from xxxx  分表group by,order by,limit支持 支持分表情况下的group by, order by, limit\n其他情形说明  不支持分布式事务，支持以非事务的方式更新多node上的数据。 不支持预处理。 不支持数据库管理语法。  转载:https://github.com/flike/kingshard/blob/master/README_ZH.md\n",
  "wordCount" : "10083",
  "inLanguage": "zh-cn",
  "datePublished": "2020-03-25T00:10:16Z",
  "dateModified": "2020-03-25T00:10:16Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/post/kingshard%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Forz Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: #1d1e20;
                --entry: #2e2e33;
                --primary: rgba(255, 255, 255, 0.84);
                --secondary: rgba(255, 255, 255, 0.56);
                --tertiary: rgba(255, 255, 255, 0.16);
                --content: rgba(255, 255, 255, 0.74);
                --hljs-bg: #2e2e33;
                --code-bg: #37383e;
                --border: #333;
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Forz Blog (Alt + H)">Forz Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="/post/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Kingshard使用指南
    </h1>
    <div class="post-meta">March 25, 2020
</div>
  </header> 
  <div class="post-content"><h1 id="应用场景">应用场景<a hidden class="anchor" aria-hidden="true" href="#应用场景">#</a></h1>
<p>现在很多互联网公司还是在大量使用MySQL来存储各种类型的关系型数据。随着访问量和数据量的增长，开发者不得不考虑一些MySQL相关的新问题：</p>
<ol>
<li>读写分离问题。由于前端应用访问量增加，单台MySQL不足以支撑整个系统的写入和查询操作。这时候，我们不得不将一些耗时的查询操作分散到多个slave上。</li>
<li>单表容量问题。如果在系统设计之初，没有考虑到分表问题。随着数据量的增长，单表容量越来越大。作者见过单表容量5亿条记录，然后一个简单的delete操作都会引起系统慢日志，而且有可能导致MySQL IO瞬发性的飙升。很多同学可能会想到，在查询的字段上加上索引，但当数据量增长到这么大的时候，即使加上索引效果也不明显了。归根结底，就是单表数据量太大，导致MySQL即使通过索引定位数据，仍然需要扫描很多记录。</li>
<li>数据库的运维问题。如果在代码中配置主库和从库host，系统运行当然也是没问题的。但这样大大增加了运维工作的压力，比如：MySQL数据库IO压力由于访问量的增加居高不下，DBA需要添加一台slave，这时候就不得不修改代码，然后打包并上线。还有很多非常实际的例子，在这就不一一列举。</li>
<li>连接池。前端应用频繁连接MySQL，由此给MySQL带来的额外性能消耗也是不容忽视的。如果通过增加一个连接池，每个DB缓存一定数量的MySQL连接，当有应用需要连接后端的MySQL，直接从连接池里取出一个已建好的连接来发送SQL请求，这样会大大加快数据查询速度。而且可以降低MySQL的性能消耗。</li>
<li>SQL日志。在程序出现问题时，我们希望得到一些SQL日志，比如，什么时刻哪条SQL发送到哪一台DB上了。通过查看这种日志能够帮助我们快速定位问题。</li>
</ol>
<p>面对这些问题，我们可以在客户端代码中逐一实现。但这样也会使得客户端越来越重，不那么灵活。kingshard对上述5类问题都有比较合适的解决方案。下面对kingshard的主要功能，逐个介绍并演示一下。</p>
<h1 id="入门指南">入门指南<a hidden class="anchor" aria-hidden="true" href="#入门指南">#</a></h1>
<h2 id="架构图">架构图<a hidden class="anchor" aria-hidden="true" href="#架构图">#</a></h2>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200325112609.png" alt=""  />
</p>
<h2 id="配置文件">配置文件<a hidden class="anchor" aria-hidden="true" href="#配置文件">#</a></h2>
<p>下面给出一个配置文件范例，用户可以自行按照自己的需求逐项配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># kingshard的地址和端口</span><span class="w">
</span><span class="w"></span><span class="nt">addr </span><span class="p">:</span><span class="w"> </span><span class="m">0.0.0.0</span><span class="p">:</span><span class="m">9696</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 连接kingshard的用户名和密码的用户列表</span><span class="w">
</span><span class="w"></span><span class="nt">-user_list</span><span class="p">:</span><span class="w">
</span><span class="w"></span>-<span class="w">
</span><span class="w">    </span><span class="nt">user </span><span class="p">:</span><span class="w">  </span><span class="l">kingshard</span><span class="w">
</span><span class="w">    </span><span class="nt">password </span><span class="p">:</span><span class="w"> </span><span class="l">kingshard</span><span class="w">
</span><span class="w"></span><span class="c">#kingshard的web API 端口</span><span class="w">
</span><span class="w"></span><span class="nt">web_addr </span><span class="p">:</span><span class="w"> </span><span class="m">0.0.0.0</span><span class="p">:</span><span class="m">9797</span><span class="w">
</span><span class="w"></span><span class="c">#调用API的用户名和密码</span><span class="w">
</span><span class="w"></span><span class="nt">web_user </span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span><span class="w"></span><span class="nt">web_password </span><span class="p">:</span><span class="w"> </span><span class="l">admin</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># log级别，[debug|info|warn|error],默认是error</span><span class="w">
</span><span class="w"></span><span class="nt">log_level </span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span><span class="w"></span><span class="c"># 打开SQL日志，设置为on;关闭SQL日志，设置为off</span><span class="w">
</span><span class="w"></span><span class="nt">log_sql </span><span class="p">:</span><span class="w"> </span><span class="kc">on</span><span class="w">
</span><span class="w"></span><span class="c">#如果设置了该项，则只输出SQL执行时间超过slow_log_time(ms)的SQL日志，不设置则输出全部SQL日志</span><span class="w">
</span><span class="w"></span><span class="nt">slow_log_time </span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w"></span><span class="c">#日志文件路径，如果不配置则会输出到终端。</span><span class="w">
</span><span class="w"></span><span class="nt">log_path </span><span class="p">:</span><span class="w"> </span><span class="l">/Users/flike/log</span><span class="w">
</span><span class="w"></span><span class="c"># sql黑名单文件路径</span><span class="w">
</span><span class="w"></span><span class="c"># 所有在该文件中的sql都会被kingshard拒绝转发</span><span class="w">
</span><span class="w"></span><span class="c">#blacklist_sql_file: /Users/flike/blacklist</span><span class="w">
</span><span class="w"></span><span class="c"># 只允许下面的IP列表连接kingshard，如果不配置则对连接kingshard的IP不做限制。</span><span class="w">
</span><span class="w"></span><span class="nt">allow_ips</span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="w">
</span><span class="w"></span><span class="c"># kingshard使用的字符集，如果不设置该选项，则kingshard使用utf8作为默认字符集</span><span class="w">
</span><span class="w"></span><span class="c">#proxy_charset: utf8mb4</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 一个node节点表示mysql集群的一个数据分片，包括一主多从（可以不配置从库）</span><span class="w">
</span><span class="w"></span><span class="nt">nodes </span><span class="p">:</span><span class="w">
</span><span class="w"></span>-<span class="w">
</span><span class="w">    </span><span class="c">#node节点名字</span><span class="w">
</span><span class="w">    </span><span class="nt">name </span><span class="p">:</span><span class="w"> </span><span class="l">node1</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># 连接池中最大的空闲连接数，也就是kingshard最多与后端DB建立max_conns_limit个连接</span><span class="w">
</span><span class="w">    </span><span class="nt">max_conns_limit </span><span class="p">:</span><span class="w"> </span><span class="m">16</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># kingshard连接该node中mysql的用户名和密码，master和slave的用户名和密码必须一致</span><span class="w">
</span><span class="w">    </span><span class="nt">user </span><span class="p">:</span><span class="w">  </span><span class="l">kingshard</span><span class="w">
</span><span class="w">    </span><span class="nt">password </span><span class="p">:</span><span class="w"> </span><span class="l">kingshard</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># master的地址和端口</span><span class="w">
</span><span class="w">    </span><span class="nt">master </span><span class="p">:</span><span class="w"> </span><span class="m">127.0.0.1</span><span class="p">:</span><span class="m">3306</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># slave的地址和端口，可不配置</span><span class="w">
</span><span class="w">    </span><span class="c">#slave : 192.168.0.12@2,192.168.0.13@3</span><span class="w">
</span><span class="w">    </span><span class="c">#kingshard在300秒内都连接不上mysql，kingshard则会下线该mysql</span><span class="w">
</span><span class="w">    </span><span class="nt">down_after_noalive </span><span class="p">:</span><span class="w"> </span><span class="m">300</span><span class="w">
</span><span class="w"></span>-<span class="w">
</span><span class="w">    </span><span class="nt">name </span><span class="p">:</span><span class="w"> </span><span class="l">node2</span><span class="w">
</span><span class="w">    </span><span class="nt">max_conns_limit </span><span class="p">:</span><span class="w"> </span><span class="m">16</span><span class="w">
</span><span class="w">    </span><span class="nt">user </span><span class="p">:</span><span class="w">  </span><span class="l">kingshard</span><span class="w">
</span><span class="w">    </span><span class="nt">password </span><span class="p">:</span><span class="w"> </span><span class="l">kingshard</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="nt">master </span><span class="p">:</span><span class="w"> </span><span class="m">192.168.59.103</span><span class="p">:</span><span class="m">3307</span><span class="w">
</span><span class="w">    </span><span class="nt">slave </span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">down_after_noalive</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># 各用户的分表规则</span><span class="w">
</span><span class="w"></span><span class="nt">schema_list </span><span class="p">:</span><span class="w">
</span><span class="w"></span>-<span class="w">
</span><span class="w">    </span><span class="c">#schema的所属用户名</span><span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">kingshard</span><span class="w">
</span><span class="w">    </span><span class="c">#分表分布的node名字</span><span class="w">
</span><span class="w">    </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1,node2]</span><span class="w">
</span><span class="w">	</span><span class="c">#所有未分表的SQL，都会发往默认node。</span><span class="w">
</span><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l">node1</span><span class="w">
</span><span class="w">    </span><span class="nt">shard</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w">
</span><span class="w">        </span><span class="c">#分表使用的db</span><span class="w">
</span><span class="w">        </span><span class="nt">db </span><span class="p">:</span><span class="w"> </span><span class="l">kingshard</span><span class="w">
</span><span class="w">		</span><span class="c">#分表名字</span><span class="w">
</span><span class="w">        </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l">test_shard_hash</span><span class="w">
</span><span class="w">        </span><span class="c">#分表字段</span><span class="w">
</span><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">id</span><span class="w">
</span><span class="w">        </span><span class="c">#分表分布的node</span><span class="w">
</span><span class="w">        </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1, node2]</span><span class="w">
</span><span class="w">        </span><span class="c">#分表类型</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">hash</span><span class="w">
</span><span class="w">        </span><span class="c">#子表个数分布，表示node1有4个子表，</span><span class="w">
</span><span class="w">        </span><span class="c">#node2有4个子表。</span><span class="w">
</span><span class="w">        </span><span class="nt">locations</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">4</span><span class="p">,</span><span class="m">4</span><span class="p">]</span><span class="w">
</span><span class="w">
</span><span class="w">    </span>-<span class="w">
</span><span class="w">		</span><span class="c">#分表使用的db</span><span class="w">
</span><span class="w">        </span><span class="nt">db </span><span class="p">:</span><span class="w"> </span><span class="l">kingshard</span><span class="w">
</span><span class="w">        </span><span class="c">#分表名字</span><span class="w">
</span><span class="w">        </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l">test_shard_range</span><span class="w">
</span><span class="w">	    </span><span class="c">#分表字段</span><span class="w">
</span><span class="w">        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">id</span><span class="w">
</span><span class="w">		</span><span class="c">#分表类型</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">range</span><span class="w">
</span><span class="w">	    </span><span class="c">#分表分布的node</span><span class="w">
</span><span class="w">        </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1, node2]</span><span class="w">
</span><span class="w">		</span><span class="c">#子表个数分布，表示node1有4个子表，</span><span class="w">
</span><span class="w">		</span><span class="c">#node2有4个子表。</span><span class="w">
</span><span class="w">        </span><span class="nt">locations</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">4</span><span class="p">,</span><span class="m">4</span><span class="p">]</span><span class="w">
</span><span class="w">        </span><span class="c">#表示每个子表包含的最大记录数，也就是说每</span><span class="w">
</span><span class="w">	    </span><span class="c">#个子表最多包好10000条记录。即子表1对应的id为[0,10000),子表2[10000,20000)....</span><span class="w">
</span><span class="w">        </span><span class="nt">table_row_limit</span><span class="p">:</span><span class="w"> </span><span class="m">10000</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>这里着重说一下分表的配置规则：</p>
<ul>
<li>kingshard支持两种类型的分表规则：hash和range。</li>
<li>kingshard分表涉及到的子表，需要用户在各个db手动创建好，并且格式是：<code>table_name_%4d</code>,也就是说子表下标由4位数组成。例如:<code>table_name_0000,table_name_0102</code>。</li>
<li>所有操作未分表的SQL语句都将发送到默认节点。</li>
</ul>
<p>有关sharding设置是通过schema设置,一个kingshard实例只能有一个schemas，从上面的配置可以看出，schema可以分为三个部分：</p>
<ol>
<li>
<p>db，表示这个schemas使用的数据库。</p>
</li>
<li>
<p>nodes，表示子表分布的节点名字。</p>
</li>
<li>
<p>rules，sharding规则。其中rules又可以分为两个部分：</p>
<ul>
<li>default，默认分表规则。所有操作不在shard（default规则下面的则）中的表的SQL语句都会发向该node。</li>
<li>hash，hash分表方式。</li>
<li>range，range分表方式</li>
</ul>
</li>
</ol>
<h2 id="安装和启动">安装和启动<a hidden class="anchor" aria-hidden="true" href="#安装和启动">#</a></h2>
<ol>
<li>安装Go语言环境（请使用最新版），具体步骤请Google。</li>
<li>git clone <a href="https://github.com/flike/kingshard.git">https://github.com/flike/kingshard.git</a> src/github.com/flike/kingshard</li>
<li>cd src/github.com/flike/kingshard</li>
<li>source ./dev.sh</li>
<li>make</li>
<li>设置配置文件</li>
<li>运行kingshard。./bin/kingshard -config=etc/ks.yaml</li>
</ol>
<p><strong>注意：</strong></p>
<p><strong>1. kingshard会响应SIGINT,SIGTERM,SIGQUIT这三个信号，平滑退出。在部署kingshard机器上应避免产生这三个信号，以免造成kingshard非正常退出！后台运行kingshard建议使用supervisor工具</strong></p>
<p><strong>2. kingshard采用的是yaml方式解析配置文件，需要注意的是yaml配置文件不允许出现tab键，且冒号后面需要跟一个空格。配置文件编写完成后，可以在<a href="http://www.yamllint.com/">yaml lint</a>网站验证是否有格式错误。</strong></p>
<p><strong>3. 可以通过<code>./bin/kingshard -v</code>来查看kingshard的commit hash和编译时间，从而维持kingshard的版本。</strong></p>
<p><strong>4. etc目录下有两个配置文件(ks.yaml,unshard.yaml),如果需要分表功能，请基于ks.yaml修改配置。如果不需要分表，基于unshard.yaml修改配置。</strong></p>
<h2 id="跨节点分表">跨节点分表<a hidden class="anchor" aria-hidden="true" href="#跨节点分表">#</a></h2>
<p>由于作者的只有两台MySQL，所以搭建了两个节点，这两个节点都只有一台Master 角色的MySQL数据库，具体的拓扑图如下所示：</p>
<p><img loading="lazy" src="https://blog-1257321977.cos.ap-beijing.myqcloud.com/20200325113325.png" alt=""  />
</p>
<h3 id="分表操作演示">分表操作演示<a hidden class="anchor" aria-hidden="true" href="#分表操作演示">#</a></h3>
<p>分表操作有hash和range两种类型，在这里只演示hash类型的分表操作，range类型的分表类似，就不再赘述了。</p>
<h4 id="手动创建子表">手动创建子表<a hidden class="anchor" aria-hidden="true" href="#手动创建子表">#</a></h4>
<p>在node1和node2上各创建4张子表，下面只给出在node1上<code>test_shard_hash_0000</code>的建表SQL语句，其他子表的建表SQL语句类似。node1包含：<code>test_shard_hash_0000, test_shard_hash_0001, test_shard_hash_0002, test_shard_hash_0003</code>。node2包含：<code>test_shard_hash_0004, test_shard_hash_0005, test_shard_hash_0006, test_shard_hash_0007</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">test_shard_hash_0000</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">str</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">f</span><span class="o">`</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">e</span><span class="o">`</span><span class="w"> </span><span class="n">enum</span><span class="p">(</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="s1">&#39;test2&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">u</span><span class="o">`</span><span class="w"> </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">i</span><span class="o">`</span><span class="w"> </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="分表的插入和查询">分表的插入和查询<a hidden class="anchor" aria-hidden="true" href="#分表的插入和查询">#</a></h4>
<p>执行下面SQL语句，根据查询的结果可以看出SQL语句根据分表规则落到不同的子表。查询操作（select）可以跨多个node，当更新操作涉及到多个node时，kingshard会以非事务的方式执行跨node的更新。为了保证数据一致性，请根据实际需求使用非事务方式的跨node更新操作。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="s2">&#34;flike&#34;</span><span class="p">,</span><span class="mi">3</span><span class="p">.</span><span class="mi">14</span><span class="p">,</span><span class="s1">&#39;test2&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s2">&#34;chen&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="s2">&#34;github&#34;</span><span class="p">,</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="s2">&#34;kingshard&#34;</span><span class="p">,</span><span class="mi">7</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>对应的SQL日志如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">24</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;flike&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test2&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">05</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;chen&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">51</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash_0001</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;github&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash_0002</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;kingshard&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>可以看到前两条SQL发送到了node2的master上了，后两条SQL发送到node1上的master了。</p>
<p>然后我们可以用select语句查看数据，且select支持跨node查询。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+--------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">str</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">u</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">    </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+--------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">github</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">chen</span><span class="w">   </span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">flike</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="mi">14</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test2</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+--------+------+-------+------+------+
</span><span class="c1"></span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>因为是hash类型的分表，所以对于select范围类型的查询，必须查询每一个子表。对应的SQL日志如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0000</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0002</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0003</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0004</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0005</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0006</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">18</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>对应等值的select查询，kingshard会计算出具体命中的子表，然后只会在相应的子表中查询。对应的SQL如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">str</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">u</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">    </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">7</span><span class="p">.</span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+------+-------+------+------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>对应的SQL日志如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">2015/09/02 18:59:37 - INFO - 127.0.0.1:55003-&gt;127.0.0.1:3306:select * from test_shard_hash_0002 where id = 18
</code></pre></td></tr></table>
</div>
</div><h4 id="分表的更新">分表的更新<a hidden class="anchor" aria-hidden="true" href="#分表的更新">#</a></h4>
<p>当更新的记录落在同一个子表时，kingshard支持这类操作。在上面插入的记录中，id为7和15的记录都落在<code>test_shard_hash_0007</code>中，所以可以成功地执行下面的SQL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">u</span><span class="o">=</span><span class="mi">123</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>对应的SQL日志是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">02</span><span class="w"> </span><span class="mi">19</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55003</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">update</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">123</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当更新的记录落在不同的子表，kingshard会以非事务的方式将更新操作发送到多个node上。例如执行如下SQL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">str</span><span class="o">=</span><span class="s2">&#34;myworld_test4&#34;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">231</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>对应的SQL日志是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">15</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">2</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">60730</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">update</span><span class="w"> </span><span class="n">test_shard_hash_0000</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;myworld_test4&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">231</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">15</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">60730</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">update</span><span class="w"> </span><span class="n">test_shard_hash_0001</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;myworld_test4&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">231</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">15</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">6</span><span class="p">.</span><span class="mi">8</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">60730</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">update</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;myworld_test4&#39;</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="mi">128</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">231</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="指定发送的node">指定发送的node<a hidden class="anchor" aria-hidden="true" href="#指定发送的node">#</a></h2>
<p>有时候我们需要操作的表，不在default node中。在kingshard中允许用户将特定的sql路由到指定的node上。只需要在sql语句前面加上包含node名称的注释(连接MySQL时需要加上-c选项，避免客户端过滤掉注释)。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="w"> </span><span class="o">-</span><span class="n">h127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="n">ukingshard</span><span class="w"> </span><span class="o">-</span><span class="n">pkingshard</span><span class="w"> </span><span class="o">-</span><span class="n">P9696</span><span class="w"> </span><span class="o">-</span><span class="k">c</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="cm">/*node2*/</span><span class="k">show</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Tables_in_kingshard</span><span class="w">   </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">kingshard_test_conn</span><span class="w">   </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_hash_0004</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_hash_0005</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_hash_0006</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="w">  </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_range_0004</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_range_0005</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_range_0006</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">test_shard_range_0007</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------------------+
</span><span class="c1"></span><span class="mi">9</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="cm">/*node2*/</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">kingshard_test_conn</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">Empty</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="cm">/*node2*/</span><span class="k">desc</span><span class="w"> </span><span class="n">kingshard_test_conn</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------+-----------------------+------+-----+---------+-------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Field</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Type</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="k">Null</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Key</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Default</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------+-----------------------+------+-----+---------+-------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">PRI</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">str</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">double</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">enum</span><span class="p">(</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="s1">&#39;test2&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">u</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">unsigned</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">tinyint</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">YES</span><span class="w">  </span><span class="o">|</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-------+-----------------------+------+-----+---------+-------+
</span><span class="c1"></span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="cm">/*node2*/</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">kingshard_test_conn</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="s2">&#34;hello&#34;</span><span class="p">,</span><span class="mi">10</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="cm">/*node2*/</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">kingshard_test_conn</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">str</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">u</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">    </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-------+------+-------+------+------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="强制读主库">强制读主库<a hidden class="anchor" aria-hidden="true" href="#强制读主库">#</a></h2>
<p>有时候在主库中插入数据后，希望立即从主库读出来。在kingshard中由于读写分离的原因，select默认会发送到相应node的从库上。但是只需要在select语句中加入相应的注释项（<code>/*master*/</code>)，就可以将select语句发送到主库。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="cm">/*master*/</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">kingshard_test_conn</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+----------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">str</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">u</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">    </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+----------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">a</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="mi">14</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="s1">&#39;&#39;</span><span class="err">\</span><span class="n">abc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">中国</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+----------+------+-------+------+------+
</span><span class="c1"></span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="跨node的sum和count函数">跨node的sum和count函数<a hidden class="anchor" aria-hidden="true" href="#跨node的sum和count函数">#</a></h2>
<p>在kingshard中，支持sum和count函数，kingshard会将相应的SQL发送到正确的DB，并将结果合并起来再返回给客户的。例如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------+
</span><span class="c1"></span><span class="o">|</span><span class="w">         </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">-----------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">---------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">---------+
</span><span class="c1"></span><span class="o">|</span><span class="w">      </span><span class="mi">57</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">---------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>相应的SQL日志如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0000</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0002</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0003</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0004</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0005</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0006</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0000</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0002</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0003</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0004</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0005</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0006</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">14</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="跨node的order-by">跨node的order by<a hidden class="anchor" aria-hidden="true" href="#跨node的order-by">#</a></h2>
<p>kingshard支持跨node的select操作使用order by，kingshard先将合适的SQL发生到对应的node，然后将结果集在内存中排序，从而实现select的order by操作。示例如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">str</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">u</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w">    </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+------+-------+------+------+
</span><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">chen</span><span class="w">      </span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">123</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">flike</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="mi">14</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test2</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">123</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">github</span><span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">23</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">kingshard</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">7</span><span class="p">.</span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">test1</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">23</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+------+-------+------+------+
</span><span class="c1"></span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>对应的SQL日志为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0000</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">asc</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">asc</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0002</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">asc</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0003</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">asc</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0004</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">asc</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0005</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">asc</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0006</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">asc</span><span class="w">
</span><span class="w"></span><span class="mi">2015</span><span class="o">/</span><span class="mi">09</span><span class="o">/</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="mi">54</span><span class="p">:</span><span class="mi">11</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">55768</span><span class="o">-&gt;</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">59</span><span class="p">.</span><span class="mi">103</span><span class="p">:</span><span class="mi">3307</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_hash_0007</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">asc</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="单node的事务">单node的事务<a hidden class="anchor" aria-hidden="true" href="#单node的事务">#</a></h2>
<p>kingshard支持在单个node上执行事务，也就是说同一个事务不能跨多个node，当出现跨node的情况时，kingshard会返回错误给客户端。可以跨同node上的不同子表。示例如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">begin</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span><span class="s1">&#39;proxy&#39;</span><span class="p">,</span><span class="mi">9</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">commit</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当在一个事务中，出现跨node的SQL语句时，kingshard会返回错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="o">#</span><span class="n">SQL语句在node2中执行</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">31</span><span class="p">,</span><span class="s1">&#39;proxy&#39;</span><span class="p">,</span><span class="mi">9</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="o">#</span><span class="n">SQL语句在需要在node1执行</span><span class="err">，跨</span><span class="n">node了</span><span class="err">。</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_hash</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">str</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="s1">&#39;proxy&#39;</span><span class="p">,</span><span class="mi">9</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">ERROR</span><span class="w"> </span><span class="mi">1105</span><span class="w"> </span><span class="p">(</span><span class="n">HY000</span><span class="p">):</span><span class="w"> </span><span class="k">transaction</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">multi</span><span class="w"> </span><span class="n">node</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h1 id="sharding">sharding<a hidden class="anchor" aria-hidden="true" href="#sharding">#</a></h1>
<p>现在开源的MySQL Proxy已经有几款了，并且有的已经在生产环境上广泛应用。但这些proxy在sharding方面，都是不能分子表的。也就是说一个node节点只能分一张表。但我们的线上需求通常是这样的：</p>
<p><strong>我有一张非常大的表，行数超过十亿，需要进行拆分处理。假设拆分因子是512。
如果采用单node单数据库的分表方式，那其实这512个子表还是存在一个物理节点上，意义不大。
如果采用他们的sharding功能，就需要512个物理节点，也不现实。
面对这种需求，现有的proxy就不能很好地满足要求了。通常我们希望将512张子表均分在几个MySQL节点上，从而达到系统的横向扩展。</strong></p>
<p>然而kingshard较好地实现了这种典型的需求。简单来说，kingshard的分表方案采用两级映射的方式：</p>
<ol>
<li>kingshard将该表分成512张子表，例如：test_0000,test_0001,&hellip;test_0511。</li>
<li>将shardKey通过hash或range方式定位到其要操作的记录在哪张子表上。</li>
<li>子表落在哪个node上通过配置文件设置。</li>
</ol>
<h2 id="支持操作">支持操作<a hidden class="anchor" aria-hidden="true" href="#支持操作">#</a></h2>
<p>目前kingshard sharding支持insert, delete, select, update和replace语句, 所有这五类操作都支持跨子表。但写操作的原子性仅支持单node上的跨子表，select操作则可以跨node，跨子表。</p>
<h2 id="sharding方式">sharding方式<a hidden class="anchor" aria-hidden="true" href="#sharding方式">#</a></h2>
<h3 id="range方式">range方式<a hidden class="anchor" aria-hidden="true" href="#range方式">#</a></h3>
<p>基于整数范围划分来得到子表下标。该方式的优点：基于范围的查询或更新速度快，因为查询（或更新）的范围有可能落在同一张子表中。这样可以避免全部子表的查询（更新）。缺点：数据热点问题。因为在一段时间内整个集群的写压力都会落在一张子表上。此时整个mysql集群的写能力受限于单台mysql server的性能。并且，当正在集中写的mysql 节点如果宕机的话，整个mysql集群处于不可写状态。基于range方式的分表字段类型受限。</p>
<h3 id="hash方式">hash方式<a hidden class="anchor" aria-hidden="true" href="#hash方式">#</a></h3>
<p>kingshard采用（shardKey%子表个数）的方式得到子表下标。优点：数据分布均匀，写压力会比较平均地落在后端的每个MySQL节点上，整个集群的写性能不会受限于单个MySQL节点。并且当某个分片节点宕机，只会影响到写入该节点的请求，其他节点的写入请求不受影响。分表字段类型不受限。因为任何一个类型的分表字段，都可以通过一个hash函数计算得到一个整数。缺点：基于范围的查询或更新，都需要将请求发送到全部子表，对性能有一定影响。但如果不是基于范围的查询或更新，则性能不会受到影响。</p>
<h2 id="时间维度分表">时间维度分表<a hidden class="anchor" aria-hidden="true" href="#时间维度分表">#</a></h2>
<p>按时间维度分表的场景非常普遍，下面介绍一下kingshard的时间分表功能</p>
<h3 id="支持的时间类型">支持的时间类型<a hidden class="anchor" aria-hidden="true" href="#支持的时间类型">#</a></h3>
<p>kingshard中的分表字段支持MySQL中三种类型的时间格式</p>
<ul>
<li>date类型，格式：YYYY-MM-DD，例如:2016-03-04,注意：2016-3-04，2016-03-4，2016-3-4等格式kingshard都是不支持的。</li>
<li>datetime类型，格式：YYYY-MM-DD HH:MM:SS，例如:2016-03-04 13:23:43,注意：2016-3-04 13:23:43，2016-03-4  13:23:43，2016-3-4  13:23:43等格式kingshard都是不支持的，必须严格按照规定的格式，kingshard才支持。</li>
<li>timestamp类型，整数类型，例如：1457165568，对应的是：2016-3-5 16:12:48。</li>
</ul>
<h3 id="支持的时间分表类型">支持的时间分表类型<a hidden class="anchor" aria-hidden="true" href="#支持的时间分表类型">#</a></h3>
<p>kingshard支持MySQL中三种格式的时间类型</p>
<ul>
<li>date类型，格式：YYYY-MM-DD，例如:2016-03-04,注意：2016-3-04，2016-03-4，2016-3-4等格式kingshard都是不支持的。</li>
<li>datetime，格式：YYYY-MM-DD HH:MM:SS，例如:2016-03-04 13:23:43,注意：2016-3-04 13:23:43，2016-03-4  13:23:43，2016-3-4  13:23:43等格式kingshard都是不支持的，必须严格按照规定的格式，kingshard才支持。</li>
<li>timestamp，整数类型。</li>
</ul>
<h3 id="功能演示">功能演示<a hidden class="anchor" aria-hidden="true" href="#功能演示">#</a></h3>
<p>kingshard的配置文件如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">schema_list </span><span class="p">:</span><span class="w">
</span><span class="w"></span>-<span class="w">
</span><span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l">kingshard</span><span class="w">
</span><span class="w">    </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1,node2]</span><span class="w">
</span><span class="w">    </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l">node1</span><span class="w">
</span><span class="w">    </span><span class="nt">shard</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w">
</span><span class="w">       </span><span class="nt">db </span><span class="p">:</span><span class="w"> </span><span class="l">kingshard</span><span class="w">
</span><span class="w">       </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l">test_shard_year</span><span class="w">
</span><span class="w">       </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">ctime</span><span class="w">
</span><span class="w">       </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date_year</span><span class="w">
</span><span class="w">       </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1,node2]</span><span class="w">
</span><span class="w">       </span><span class="nt">date_range</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">2015-2016</span><span class="p">,</span><span class="m">2017-2018</span><span class="p">]</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="按年分表">按年分表<a hidden class="anchor" aria-hidden="true" href="#按年分表">#</a></h4>
<h5 id="配置说明">配置说明<a hidden class="anchor" aria-hidden="true" href="#配置说明">#</a></h5>
<p>按年分表的配置项设置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">       </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l">test_shard_year</span><span class="w">
</span><span class="w">       </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">ctime</span><span class="w">
</span><span class="w">       </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date_year</span><span class="w">
</span><span class="w">       </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1,node2]</span><span class="w">
</span><span class="w">       </span><span class="nt">date_range</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">2015-2016</span><span class="p">,</span><span class="m">2017-2018</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>该配置表示：</p>
<ul>
<li>sharding key是ctime。</li>
<li>按年的分表类型是:<code>date_year</code>。</li>
<li><code>test_shard_year_2015, test_shard_year_2016</code>两个子表落在node1上，<code>test_shard_year_2017，test_shard_year_2018</code>两个子表落在node2上。</li>
<li>如果你一个node上只包含一张子表，你可以这样配置<code>date_range[2015,2017-2018]</code>。</li>
</ul>
<p>注意：子表的命名格式必须是:shard_table_YYYY,shard_table是分表名，后面接具体的年。<strong>传入范围必须是有序递增的,不能是[2016,2013-2014]</strong></p>
<h5 id="功能演示-1">功能演示<a hidden class="anchor" aria-hidden="true" href="#功能演示-1">#</a></h5>
<p>在node1上创建两张子表<code>test_shard_year_2015, test_shard_year_2016</code>，在node2上创建两种子表<code>test_shard_year_2017，test_shard_year_2018</code>。建表SQL如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">test_shard_year_2016</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">ctime</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>插入数据：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_year</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">ctime</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="s2">&#34;hello&#34;</span><span class="p">,</span><span class="s2">&#34;2015-02-22 13:23:45&#34;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_year</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">ctime</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="s2">&#34;world&#34;</span><span class="p">,</span><span class="s2">&#34;2016-03-22&#34;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_year</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ctime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s2">&#34;2016-03-23&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-------+---------------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">ctime</span><span class="w">               </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-------+---------------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2015</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">22</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">45</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2016</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">22</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----+-------+---------------------+
</span><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>对应的SQL log信息是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">05</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">32</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">2</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">56597</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_year_2015</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ctime</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;hello&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2015-02-22 13:23:45&#39;</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">05</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">59</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">56597</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_year_2016</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ctime</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;world&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2016-03-22&#39;</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">05</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">6</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">56597</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_year_2015</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ctime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s1">&#39;2016-03-23&#39;</span><span class="w">
</span><span class="w"></span><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">05</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">56597</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_year_2016</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">ctime</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="s1">&#39;2016-03-23&#39;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>当然如果你把id作为一个unix时间戳，来分表的话，kingshard也是支持的。具体配置就是这样的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">       </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l">test_shard_year</span><span class="w">
</span><span class="w">       </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">id</span><span class="w">
</span><span class="w">       </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date_year</span><span class="w">
</span><span class="w">       </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1,node2]</span><span class="w">
</span><span class="w">       </span><span class="nt">date_range</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">2015-2016</span><span class="p">,</span><span class="m">2017-2018</span><span class="p">]</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>插入数据:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_year</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">ctime</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1457410310</span><span class="p">,</span><span class="s2">&#34;world&#34;</span><span class="p">,</span><span class="s2">&#34;2018-03-22&#34;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_year</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1457410310</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------------+-------+---------------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">ctime</span><span class="w">               </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------------+-------+---------------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">1457410310</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2018</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">22</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------------+-------+---------------------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>1457410310 这个unix时间戳对应的日期是：2016-3-8 12:11:50。kingshard准确地将这条记录路由到了<code>test_shard_year_2016</code>这张子表中了。
对应的SQL log是：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">08</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span><span class="mi">49</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">56669</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">test_shard_year_2016</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ctime</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="mi">1457410310</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;world&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2018-03-22&#39;</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="mi">2016</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">08</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">23</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">OK</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span><span class="n">ms</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">56669</span><span class="o">-&gt;</span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">3306</span><span class="p">:</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_shard_year_2016</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1457410310</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="按月分表">按月分表<a hidden class="anchor" aria-hidden="true" href="#按月分表">#</a></h4>
<h5 id="配置说明-1">配置说明<a hidden class="anchor" aria-hidden="true" href="#配置说明-1">#</a></h5>
<p>按月分表的配置项设置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">       </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l">test_shard_month</span><span class="w">
</span><span class="w">       </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">ctime</span><span class="w">
</span><span class="w">       </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date_month</span><span class="w">
</span><span class="w">       </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1,node2]</span><span class="w">
</span><span class="w">       </span><span class="nt">date_range</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">201512-201602</span><span class="p">,</span><span class="m">201609-2016010</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>该配置表示：</p>
<ul>
<li>sharding key是ctime。</li>
<li>按月的分表类型是:<code>date_month</code>。</li>
<li><code>test_shard_month_201512, test_shard_month_201601, test_shard_month_201602</code>两个子表落在node1上，<code>test_shard_month_201609，test_shard_month_201610</code>两个子表落在node2上。</li>
<li>如果你一个node上只包含一张子表，你可以这样配置<code>date_range[201501,201609-201610]</code>。</li>
</ul>
<p>注意：子表的命名格式必须是:<code>shard_table_YYYYMM,shard_table</code>是分表名，后面接具体的年和月。<strong>传入范围必须是有序递增的,不能是[201609-201610,201501]</strong></p>
<p>功能演示参考按年分表的操作。</p>
<h4 id="按天分表">按天分表<a hidden class="anchor" aria-hidden="true" href="#按天分表">#</a></h4>
<h5 id="配置说明-2">配置说明<a hidden class="anchor" aria-hidden="true" href="#配置说明-2">#</a></h5>
<p>按天分表的配置项设置如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">       </span><span class="nt">table</span><span class="p">:</span><span class="w"> </span><span class="l">test_shard_day</span><span class="w">
</span><span class="w">       </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">ctime</span><span class="w">
</span><span class="w">       </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">date_day</span><span class="w">
</span><span class="w">       </span><span class="nt">nodes</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">node1,node2]</span><span class="w">
</span><span class="w">       </span><span class="nt">date_range</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="m">20151222-20151224</span><span class="p">,</span><span class="m">20160901-20160902</span><span class="p">]</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>该配置表示：</p>
<ul>
<li>sharding key是ctime。</li>
<li>按天的分表类型是:<code>date_day</code>。</li>
<li><code>test_shard_day_20151222, test_shard_day_20151223, test_shard_day_20151224</code>两个子表落在node1上，<code>test_shard_day_20160901，test_shard_day_20160902</code>两个子表落在node2上。</li>
<li>如果你一个node上只包含一张子表，你可以这样配置<code>date_range[20150101,20160901-20161010]</code>。</li>
</ul>
<p>注意：子表的命名格式必须是:<code>shard_table_YYYYMMDD,shard_table</code>是分表名，后面接具体的年,月和日。<strong>传入范围必须是有序递增的,不能是[20160901-20161010,20150101]</strong></p>
<p>功能演示参考按年分表的操作。</p>
<h2 id="子表迁移方案">子表迁移方案<a hidden class="anchor" aria-hidden="true" href="#子表迁移方案">#</a></h2>
<p>通过kingshard可以非常方便地动态迁移子表，从而保证MySQL节点的不至于负载压力太大。大致步骤如下所述：</p>
<ol>
<li>通过自动数据迁移工具开始数据迁移。</li>
<li>数据差异小于某一临界值，阻塞老子表写操作（read-only）</li>
<li>等待新子表数据同步完毕</li>
<li>更改kingshard配置文件中的对应子表的路由规则。</li>
<li>删除老节点上的子表。</li>
</ol>
<h1 id="kingshard支持sql的范围">Kingshard支持SQL的范围<a hidden class="anchor" aria-hidden="true" href="#kingshard支持sql的范围">#</a></h1>
<h2 id="简要说明">简要说明<a hidden class="anchor" aria-hidden="true" href="#简要说明">#</a></h2>
<p>kingshard在非分表的情况下支持绝大部分MySQL语法和协议，包括类似SHOW DATABASES, SHOW TABLES, 以及各种DML语句和DDL语句。在分表的情况下，目前只支持有限的DML语句，主要包含：SELECT,UPDATE,INSERT,REPLACE, DELETE这五种SQL操作。并且不支持自动建子表功能。以及有限的kingshard自定义管理端命令。在分表和非分表的情况下，都不支持以下情形：</p>
<ul>
<li>暂不支持用户自定义数据类型、自定义函数。</li>
<li>暂不支持视图、存储过程、触发器、游标。</li>
<li>暂不支持类似 BEGIN…END，LOOP&hellip;END LOOP，REPEAT&hellip;UNTIL&hellip;END REPEAT，WHILE&hellip;DO&hellip;END WHILE 等的复合语句。</li>
<li>暂不支类似 IF,WHILE 等流程控制类语句。
下面分两部分介绍kingshard支持SQL的情况：非分表情况下SQL支持范围和分表情况下SQL支持范围。</li>
</ul>
<h2 id="非分表情况下sql的支持范围">非分表情况下SQL的支持范围<a hidden class="anchor" aria-hidden="true" href="#非分表情况下sql的支持范围">#</a></h2>
<p>以下说明都是基于非分表的情况下，SQL的支持情况。</p>
<h3 id="数据库ddl语法">数据库DDL语法<a hidden class="anchor" aria-hidden="true" href="#数据库ddl语法">#</a></h3>
<ul>
<li>CREATE TABLE Syntax</li>
<li>CREATE INDEX Syntax</li>
<li>DROP TABLE Syntax</li>
<li>DROP INDEX Syntax</li>
<li>ALTER TABLE Syntax</li>
<li>TRUNCATE TABLE Syntax</li>
</ul>
<h3 id="数据库dml语法">数据库DML语法<a hidden class="anchor" aria-hidden="true" href="#数据库dml语法">#</a></h3>
<ul>
<li>INSERT Syntax</li>
<li>INSERT DELAYED Syntax 暂不支持</li>
<li>REPLACE Syntax</li>
<li>UPDATE Syntax</li>
<li>DELETE Syntax</li>
<li>Subquery Syntax</li>
<li>Scalar Subquery</li>
<li>Comparisons Subquery</li>
<li>Subqueries with ANY, IN, or SOME</li>
<li>Subqueries with ALL</li>
<li>Row Subqueries</li>
<li>Subqueries with EXISTS or NOT EXISTS</li>
<li>Subqueries in the FROM Clause</li>
<li>SELECT Syntax</li>
<li>SELECT INTO OUTFILE/INTO DUMPFILE/INTO var_name 暂不支持</li>
<li>Last_insert_id特性</li>
</ul>
<h3 id="事务的支持">事务的支持<a hidden class="anchor" aria-hidden="true" href="#事务的支持">#</a></h3>
<ul>
<li>START TRANSACTION, COMMIT, and ROLLBACK Syntax</li>
<li>暂不支持transaction_characteristic定义</li>
<li>暂不支持savepoint嵌套事务的相关语法</li>
<li>暂不支持XA事务的相关语法</li>
<li>支持set autocommit=0/1方式设置事务.</li>
<li>支持begin/commit方式设置事务</li>
<li>支持start transaction方式设置事务</li>
<li>SET TRANSACTION Syntax</li>
<li>暂不支持对global的事务隔离级别进行调整</li>
</ul>
<h3 id="预处理的支持">预处理的支持<a hidden class="anchor" aria-hidden="true" href="#预处理的支持">#</a></h3>
<ul>
<li>Prepared Statements</li>
</ul>
<p>支持主流语言（java,php,python,C/C++,Go)SDK的MySQL的Prepare语法。</p>
<h3 id="数据库管理语法的支持">数据库管理语法的支持<a hidden class="anchor" aria-hidden="true" href="#数据库管理语法的支持">#</a></h3>
<ul>
<li>SET Syntax
只支持字符集和set autocommit相关语法，其他set语法未测试过。</li>
<li>Show Syntax
默认show操作会转发到默认DB，需要查看其他DB的内容，通过在SQL中加注释的方式。</li>
<li>KILL Syntax
目前不支持KILL QUERY processlist_id</li>
</ul>
<h3 id="数据库管理语法的支持-1">数据库管理语法的支持<a hidden class="anchor" aria-hidden="true" href="#数据库管理语法的支持-1">#</a></h3>
<ul>
<li>DESCRIBE Syntax</li>
<li>EXPLAIN Syntax</li>
<li>USE Syntax</li>
</ul>
<h3 id="数据库系统函数的支持">数据库系统函数的支持<a hidden class="anchor" aria-hidden="true" href="#数据库系统函数的支持">#</a></h3>
<p>默认都支持（未测试）</p>
<h2 id="分表的情况下sql的支持范围">分表的情况下SQL的支持范围<a hidden class="anchor" aria-hidden="true" href="#分表的情况下sql的支持范围">#</a></h2>
<h3 id="数据库ddl语法-1">数据库DDL语法<a hidden class="anchor" aria-hidden="true" href="#数据库ddl语法-1">#</a></h3>
<ul>
<li>CREATE TABLE Syntax</li>
<li>CREATE INDEX Syntax</li>
<li>DROP TABLE Syntax</li>
<li>DROP INDEX Syntax</li>
<li>ALTER TABLE Syntax</li>
<li>TRUNCATE TABLE Syntax</li>
</ul>
<p>分表的情况下支持这些语法，但需要在SQL中加注释，例如：
<code>/*node1*/create table stu_0000(id int, name char(20));</code>
这样kingshard就会将该SQL转发到node1节点的Master上。</p>
<p><strong>注：</strong>
<code>truncate</code>如果不指定节点注释则会将所有分表都清空，例如：<code>truncate stu</code></p>
<h3 id="数据库dml语法-1">数据库DML语法<a hidden class="anchor" aria-hidden="true" href="#数据库dml语法-1">#</a></h3>
<ul>
<li>INSERT Syntax</li>
<li>INSERT DELAYED Syntax 不支持</li>
<li>INSERT INTO SELECT 不支持</li>
<li>REPLACE Syntax</li>
<li>UPDATE Syntax
//分表使用的字段无论何种分表类型都不能作为被更新的字段。</li>
<li>UPDATE SET xx=REPLACE(xx,&lsquo;a&rsquo;,&lsquo;b&rsquo;) Syntax 不支持</li>
<li>DELETE Syntax</li>
<li>Subquery Syntax</li>
<li>SELECT Syntax</li>
</ul>
<p>对于UPDATE，DELETE和SELECT三种SQL中WHERE后面的条件不能包含子查询，函数等。只能是字段名。</p>
<h3 id="数据库管理语法的支持-2">数据库管理语法的支持<a hidden class="anchor" aria-hidden="true" href="#数据库管理语法的支持-2">#</a></h3>
<ul>
<li>DESCRIBE Syntax
通过SQL语句hint方式支持，例如:<code> /*node2*/describe table_name</code></li>
<li>EXPLAIN Syntax
通过SQL语句hint方式支持，例如:<code> /*node2*/explain select * from xxxx</code></li>
<li>USE Syntax</li>
</ul>
<h3 id="分表聚合函数的支持">分表聚合函数的支持<a hidden class="anchor" aria-hidden="true" href="#分表聚合函数的支持">#</a></h3>
<p>支持以下聚合函数：</p>
<ul>
<li>sum函数</li>
<li>max函数</li>
<li>count函数</li>
<li>min函数
不支持distinct后聚合，例如:<code> select count(distinct id) from xxxx</code></li>
</ul>
<h3 id="分表group-byorder-bylimit支持">分表group by,order by,limit支持<a hidden class="anchor" aria-hidden="true" href="#分表group-byorder-bylimit支持">#</a></h3>
<p>支持分表情况下的group by, order by, limit</p>
<h3 id="其他情形说明">其他情形说明<a hidden class="anchor" aria-hidden="true" href="#其他情形说明">#</a></h3>
<ul>
<li>不支持分布式事务，支持以非事务的方式更新多node上的数据。</li>
<li>不支持预处理。</li>
<li>不支持数据库管理语法。</li>
</ul>
<p>转载:<a href="https://github.com/flike/kingshard/blob/master/README_ZH.md">https://github.com/flike/kingshard/blob/master/README_ZH.md</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/kingshard/">Kingshard</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="/">Forz Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
